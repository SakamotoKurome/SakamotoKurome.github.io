<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Fedora | Sakamoto Kurome</title>
<meta name=keywords content="Unix,Linux,Fedora,CentOS,Linux Deploy">
<meta name=description content="[fəˈdɔrə] 费多拉 Fedora Linux 版本 Fedora 官方版本 Fedora 工作站是可以安装在笔记本电脑和台式电脑上的 Linux。 此版本附带 GNOME 作为默认桌面环境和各种标准应用">
<meta name=author content="Sakamoto Kurome">
<link rel=canonical href=https://sakamotokurome.github.io/posts/fedora/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.06402d745029223a9231706eea1dd82e107754f4ad625acbe7fd336a5e59566c.css integrity="sha256-BkAtdFApIjqSMXBu6h3YLhB3VPStYlrL5/0zal5ZVmw=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://sakamotokurome.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://sakamotokurome.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://sakamotokurome.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://sakamotokurome.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://sakamotokurome.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.90.0">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript>
<link rel=stylesheet href=https://sakamotokurome.github.io/custom.css>
<meta name=google-site-verification content="i2r403EffR8m-KBf7EHi6AYg7tfnMshaXTAynoYPnpE">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-K2Y212LPQ2"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-K2Y212LPQ2',{anonymize_ip:!1})}</script>
<meta property="og:title" content="Fedora">
<meta property="og:description" content="[fəˈdɔrə] 费多拉 Fedora Linux 版本 Fedora 官方版本 Fedora 工作站是可以安装在笔记本电脑和台式电脑上的 Linux。 此版本附带 GNOME 作为默认桌面环境和各种标准应用">
<meta property="og:type" content="article">
<meta property="og:url" content="https://sakamotokurome.github.io/posts/fedora/">
<meta property="og:image" content="https://sakamotokurome.github.io/Covers/146152-Fedora%20girl%20-%20logo%20on%20bottom.jpg.webp"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-03-09T11:39:38+08:00">
<meta property="article:modified_time" content="2022-03-09T11:39:38+08:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://sakamotokurome.github.io/Covers/146152-Fedora%20girl%20-%20logo%20on%20bottom.jpg.webp">
<meta name=twitter:title content="Fedora">
<meta name=twitter:description content="[fəˈdɔrə] 费多拉 Fedora Linux 版本 Fedora 官方版本 Fedora 工作站是可以安装在笔记本电脑和台式电脑上的 Linux。 此版本附带 GNOME 作为默认桌面环境和各种标准应用">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://sakamotokurome.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Fedora","item":"https://sakamotokurome.github.io/posts/fedora/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Fedora","name":"Fedora","description":"[fəˈdɔrə] 费多拉 Fedora Linux 版本 Fedora 官方版本 Fedora 工作站是可以安装在笔记本电脑和台式电脑上的 Linux。 此版本附带 GNOME 作为默认桌面环境和各种标准应用","keywords":["Unix","Linux","Fedora","CentOS","Linux Deploy"],"articleBody":"[fəˈdɔrə] 费多拉\nFedora Linux 版本 Fedora 官方版本  Fedora 工作站是可以安装在笔记本电脑和台式电脑上的 Linux。 此版本附带 GNOME 作为默认桌面环境和各种标准应用程序，以便 Fedora Linux 已准备好用于日常使用。 Fedora 服务器专门用于服务器计算机用途，提供邮件服务器、DNS 等的安装。 Fedora 物联网，用于物联网和设备边缘生态系统。 Fedora CoreOS 是一种自动更新的操作系统，旨在安全、大规模地运行容器化工作负载。 Fedora Silverblue 是一个不可变的桌面操作系统，旨在支持以容器为中心的工作流。  Fedora Spins Fedora 的默认桌面环境是 GNOME，但是如果您喜欢其他的桌面环境，比如 KDE Plasma Desktop 或 Xfce，您可以下载一个您喜欢的桌面环境的 spin，然后用它来安装 Fedora，为您选择的桌面环境进行预配置。\nFedora Labs Fedora 实验室是一个由 Fedora 社区成员策划和维护的目的明确的软件和内容的精选捆绑包。这些软件可以作为独立的Fedora完整版安装，也可以作为现有的Fedora安装的附加组件安装。\nFedora Alternative Downloads 这些Fedora下载要么是特殊用途的——用于测试，用于特定的架构；要么是其他格式的Fedora标准版本，如网络安装程序格式或用于torrent下载的格式。\n本页旨在作为查找Fedora替代版本的单一中央资源。\nFedora Usage Mirrors Of Fedora SJTU Mirror 托管于华东教育网骨干节点上海交通大学。\n$ sudo sed -e 's/^metalink=/#metalink=/g' -e 's|^#baseurl=http://download.example/pub/|baseurl=https://mirror.sjtu.edu.cn/|g' -i.bak /etc/yum.repos.d/{fedora,fedora-updates,fedora-modular,fedora-updates-modular}.repo $ sudo dnf makecache #生成缓存 RPMFusion 第一步下载基础包(开源和闭源)， 这里我们使用bfsu来下载，以避免网络问题，终端输入:\n$ sudo dnf install --nogpgcheck https://mirror.sjtu.edu.cn/rpmfusion/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://mirror.sjtu.edu.cn/rpmfusion/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm -y 第二步，使用SJTU Mirror\nsudo sed -e 's|^metalink=|#metalink=|g' -e 's|^#baseurl=http://download1.rpmfusion.org/|baseurl=https://mirror.sjtu.edu.cn/rpmfusion/|g' -i.bak /etc/yum.repos.d/rpmfusion-* FlatHub Mirror 改为使用 sjtu 镜像：\n$ sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo $ sudo flatpak remote-modify --enable flathub $ sudo flatpak remote-modify flathub --url=https://mirror.sjtu.edu.cn/flathub $ sudo flatpak remotes --show-details $ cat /var/lib/flatpak/repo/config Copr 类似 Ubuntu 的 PPA\n  You need to have dnf-plugins-core installed for dnf, and you need to have yum-plugin-copr installed for yum\n$ sudo dnf install dnf-plugins-core $ sudo yum install yum-plugin-copr   If you’re using a version of Linux with dnf, or if you have older distribution:\n$ sudo dnf copr enable user/project $ sudo yum copr enable user/project   例如Fedora自带的Copr repo for PyCharm\n$ cat /etc/yum.repos.d/_copr_phracek-PyCharm.repo [phracek-PyCharm] name=Copr repo for PyCharm owned by phracek baseurl=https://copr-be.cloud.fedoraproject.org/results/phracek/PyCharm/fedora-$releasever-$basearch/ skip_if_unavailable=True gpgcheck=1 gpgkey=https://copr-be.cloud.fedoraproject.org/results/phracek/PyCharm/pubkey.gpg enabled=0 Speed Up DNF 尝试更改参数：\n$ sudo vi /etc/dnf/dnf.conf fastestmirror=true #如果启用国内镜像，就不需要设置这个了。 max_parallel_downloads=5 metadata_expire=2d  fastermirror 选择最快的镜像 max_parallel_downloads 一次下载多个包  Gnome $ sudo dnf install gnome-tweaks gnome-extensions-app  gnome-tweaks 里面可以管理 startup apps。 gnome-extensions-app 管理 extensions。 gnome-shell-extension-appindicator gnome-shell-extension-gsconnect  Multiple Git Accounts $ ssh-keygen -t rsa -C \"your-email\" $ nano ~/.ssh/config Host github-proj1 HostName github.com User git IdentityFile ~/.ssh/id_rsa_github_proj1 Host github-proj2 HostName github.com User git IdentityFile ~/.ssh/id_rsa_github_proj2 Host aws-codecommit-proj3 Hostname git-codecommit.us-east-2.amazonaws.com User TECADMIN0123456789 IdentityFile ~/.ssh/id_rsa_aws_codecommit_proj3 AddKeysToAgent yes $ git clone ssh://github-proj1/user1/repo.git $ git clone ssh://github-proj2/user2/repo.git $ git clone ssh://aws-codecommit-proj3/v1/repos/myrepo 设置 config 后，可能需要重启才能起作用。\nFcitx5 安装\n$ sudo dnf install fcitx5 fcitx5-chinese-addons fcitx5-gtk fcitx5-qt fcitx5-configtool fcitx5-autostart fcitx5-rime $ rpm -ql fcitx5-autostart /etc/profile.d/fcitx5.sh /etc/xdg/autostart/org.fcitx.Fcitx5.desktop $ cat /etc/profile.d/fcitx5.sh if [ ! \"$XDG_SESSION_TYPE\" = \"tty\" ] # if this is a gui session (not tty) then # let's use fcitx instead of fcitx5 to make flatpak happy # this may break behavior for users who have installed both # fcitx and fcitx5, let then change the file on their own export INPUT_METHOD=fcitx export GTK_IM_MODULE=fcitx export QT_IM_MODULE=fcitx export XMODIFIERS=@im=fcitx fi $ cat /etc/xdg/autostart/org.fcitx.Fcitx5.desktop [Desktop Entry] Name[ca]=Fcitx 5 Name[da]=Fcitx 5 Name[de]=Fcitx 5 Name[ja]=Fcitx 5 Name[ko]=Fcitx 5 Name[zh_CN]=Fcitx 5 Name[zh_TW]=Fcitx 5 Name=Fcitx 5 GenericName[ca]=Mètode d'entrada GenericName[da]=Inputmetode GenericName[de]=Eingabemethode GenericName[ja]=入力メソッド GenericName[ko]=입력기 GenericName[ru]=Метод ввода GenericName[zh_CN]=输入法 GenericName[zh_TW]=輸入法 GenericName=Input Method Comment[ca]=Mètode d'entrada estàndard Comment[da]=Start inputmetode Comment[de]=Eingabemethode starten Comment[ja]=入力メソッドを開始 Comment[ko]=입력기 시작 Comment[zh_CN]=启动输入法 Comment=Start Input Method Exec=/usr/bin/fcitx5 Icon=fcitx Terminal=false Type=Application Categories=System;Utility; StartupNotify=false X-GNOME-AutoRestart=false X-GNOME-Autostart-Notify=false X-KDE-autostart-after=panel X-KDE-StartupNotify=false X-KDE-Wayland-VirtualKeyboard=true 在 fcitx5 Configure 中，Input Method 只保留 rime，按组合键 Ctrl+` 选择 ”朙月拼音-简化字“，对应定制文件为 luna_pinyin_simp.custom.yaml。\n扩展：Input Method Panel\nNvidia   Update from the existing repositories\n$ sudo dnf update   Add the RPMFusion repository for NVIDIA drivers\n$ sudo dnf install fedora-workstation-repositories   Update from the newly added repositories\n$ sudo dnf update --refresh   Install the driver and its dependencies\n$ sudo dnf install gcc kernel-headers kernel-devel akmod-nvidia xorg-x11-drv-nvidia xorg-x11-drv-nvidia-libs xorg-x11-drv-nvidia-libs.i686   Wait for the kernel modules to load up\n  Read from the updated kernel modules\n$ sudo akmods --force $ sudo dracut --force   Reboot your system.\n在这里，确定在登录界面选择的是 Gnome on Xorg。\n  Edit the X11 configuration\n$ sudo cp -p /usr/share/X11/xorg.conf.d/nvidia.conf /etc/X11/xorg.conf.d/nvidia.conf $ sudo nano /etc/X11/xorg.conf.d/nvidia.conf Section \"OutputClass\" Identifier \"nvidia\" MatchDriver \"nvidia-drm\" Driver \"nvidia\" Option \"AllowEmptyInitialConfiguration\" Option \"SLI\" \"Auto\" Option \"BaseMosaic\" \"on\" Option \"PrimaryGPU\" \"yes\" EndSection Section \"ServerLayout\" Identifier \"layout\" Option \"AllowNVIDIAGPUScreens\" EndSection   Reboot your system\n  Verify the configuration\n$ glxinfo | egrep \"OpenGL vendor|OpenGL renderer\"   Movies and music In order to install OpenH264, you first need to enable it:\n$ cat /etc/yum.repos.d/fedora-cisco-openh264.repo [fedora-cisco-openh264] name=Fedora $releasever openh264 (From Cisco) - $basearch metalink=https://mirrors.fedoraproject.org/metalink?repo=fedora-cisco-openh264-$releasever\u0026arch=$basearch type=rpm enabled=0 metadata_expire=14d repo_gpgcheck=0 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch skip_if_unavailable=True [fedora-cisco-openh264-debuginfo] name=Fedora $releasever openh264 (From Cisco) - $basearch - Debug metalink=https://mirrors.fedoraproject.org/metalink?repo=fedora-cisco-openh264-debug-$releasever\u0026arch=$basearch type=rpm enabled=0 metadata_expire=14d repo_gpgcheck=0 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch skip_if_unavailable=True $ sudo dnf config-manager --set-enabled fedora-cisco-openh264 Use the dnf utility to install packages that provide multimedia libraries:\n$ sudo proxychains dnf install gstreamer1-plugins-{bad-\\*,good-\\*,base} gstreamer1-plugin-openh264 gstreamer1-libav --exclude=gstreamer1-plugins-bad-free-devel -y $ sudo proxychains dnf install lame\\* --exclude=lame-devel -y $ sudo proxychains dnf group upgrade --with-optional Multimedia -y $ sudo dnf config-manager --set-disabled fedora-cisco-openh264 and then install the plugins (for firefox, if needed):\n$ sudo dnf install mozilla-openh264 Afterwards you need open Firefox, go to menu → Add-ons → Plugins and enable OpenH264 plugin.\nRhythmbox 无法订阅喜马拉雅的feed，报错为：\nUnable to load the feed. Check your network connection 其实试一下荔枝FM，会发现是可以订阅的。比较一下就会发现，荔枝FM的Feed都是mp3链接，而喜马拉雅的Feed都是m4a链接，下载必须解码器后（ The .m4a files are alac which would be decoded by gstreamer1.0-libav. ），Rhythmbox 确实能播放m4a文件了，但依然无法订阅，因此应该是Prodcast解析feed链接的问题，有兴趣有能力有时间看：Rhythmbox Development Reference Manual（PS：Ubuntu 22.04.1 上并无此问题）\nPodman kali linux\n开代理的话会报错：\nCould not connect to 127.0.0.1:7890 (127.0.0.1). - connect (111: Connection refused) 查看 man podman-run，添加 --http-proxy=false 解决：\n$ podman run --http-proxy=false -it docker.io/kalilinux/kali-rolling:latest /bin/bash 更换 ustc 源\n$ echo 'deb http://mirrors.ustc.edu.cn/kali kali-rolling main non-free con trib'  sources.list metapackage\n$ apt update \u0026\u0026 apt -y install kali-linux-headless ZFS on Fedora zfs-fuse is a daemon which provides support for the ZFS filesystem, via fuse. Ordinarily this daemon will be invoked from system boot scripts.\n$ sudo dnf install zfs-fuse $ sudo zfs-fuse $ sudo zpool import dpool cannot import 'dpool': pool is formatted using a newer ZFS version OpenZFS on Fedora\n$ sudo rpm -e --nodeps zfs-fuse $ sudo proxychains dnf install -y https://zfsonlinux.org/fedora/zfs-release$(rpm -E %dist).noarch.rpm $ cat /etc/yum.repos.d/zfs.repo [zfs] name=ZFS on Linux for Fedora $releasever baseurl=http://download.zfsonlinux.org/fedora/$releasever/$basearch/ enabled=0 metadata_expire=7d gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-zfsonlinux [zfs-source] name=ZFS on Linux for Fedora $releasever - Source baseurl=http://download.zfsonlinux.org/fedora/$releasever/SRPMS/ enabled=0 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-zfsonlinux [zfs-testing] name=ZFS on Linux for Fedora $releasever - Testing baseurl=http://download.zfsonlinux.org/fedora-testing/$releasever/$basearch/ enabled=0 metadata_expire=7d gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-zfsonlinux [zfs-testing-source] name=ZFS on Linux for Fedora $releasever - Testing Source baseurl=http://download.zfsonlinux.org/fedora-testing/$releasever/SRPMS/ enabled=0 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-zfsonlinux $ sudo proxychains dnf install -y kernel-devel $ sudo proxychains dnf install -y zfs $ sudo modprobe zfs $ echo zfs | sudo tee /etc/modules-load.d/zfs.conf # 可选 $ sudo dnf config-manager --set-disabled zfs virt-manager $ sudo dnf install @virtualization $ sudo vi /etc/libvirt/libvirtd.conf unix_sock_group = \"libvirt\" unix_sock_rw_perms = \"0770\" $ sudo systemctl restart libvirtd $ sudo usermod -a -G libvirt $(whoami) Now you must log out and log in to apply the changes.\nVSCode Visual Studio Code on Linux\n$ sudo tee -a /etc/yum.repos.d/vscode.repo [code] name=Visual Studio Code baseurl=https://packages.microsoft.com/yumrepos/vscode enabled=1 gpgcheck=1 gpgkey=https://packages.microsoft.com/keys/microsoft.asc EOF $ sudo dnf install code VSCodium\nBinary releases of VS Code without MS branding/telemetry/licensing.\nvscodium-deb-rpm-repo:\n$ sudo tee -a /etc/yum.repos.d/vscodium.repo [gitlab.com_paulcarroty_vscodium_repo] name=gitlab.com_paulcarroty_vscodium_repo baseurl=https://paulcarroty.gitlab.io/vscodium-deb-rpm-repo/rpms/ enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://gitlab.com/paulcarroty/vscodium-deb-rpm-repo/raw/master/pub.gpg metadata_expire=1h EOF $ dnf install codium Fedora System Package Manager Managing DNF Repository DNF repositories commonly provide their own .repo file. To add such a repository to your system and enable it, run the following command as root:\ndnf config-manager --add-repo repository_url To enable a particular repository or repositories, type the following at a shell prompt as root:\ndnf config-manager --set-enabled repository… To disable a DNF repository, run the following command as root:\ndnf config-manager --set-disabled repository… For example, Google Chrome Repository：\n$ cat /etc/yum.repos.d/google-chrome.repo [google-chrome] name=google-chrome baseurl=https://dl.google.com/linux/chrome/rpm/stable/x86_64 enabled=1 gpgcheck=1 gpgkey=https://dl.google.com/linux/linux_signing_key.pub $ sudo dnf config-manager --set-enabled google-chrome $ sudo dnf install google-chrome-stable DNF System Upgrade $ sudo dnf upgrade --refresh $ sudo reboot $ sudo dnf install dnf-plugin-system-upgrade $ sudo dnf system-upgrade download --releasever=35 $ sudo dnf system-upgrade reboot  Change the --releasever= number if you want to upgrade to a different release. If some of your packages have unsatisfied dependencies, the upgrade will refuse to continue until you run it again with an extra --allowerasing option. This often happens with packages installed from third-party repositories for which an updated repositories hasn’t been yet published. Study the output very carefully and examine which packages are going to be removed. None of them should be essential for system functionality, but some of them might be important for your productivity.  In case of unsatisfied dependencies, you can sometimes see more details if you add --best option to the command line. If you want to remove/install some packages manually before running dnf system-upgrade download again, it is advisable to perform those operations with --setopt=keepcache=1 dnf command line option. Otherwise the whole package cache will be removed after your operation, and you will need to download all the packages once again.   There are other important optional operations here, please read the official documentation.  DNF local plugin An internet search yields two common solutions that eliminate or reduce repeat downloads of the same RPM set – create a private Fedora Linux mirror or set up a caching proxy.\nFedora provides guidance on setting up a [private mirror](https://fedoraproject.org/wiki/ Infrastructure/Mirroring#How_can_someone_make_a_private_mirror). A mirror requires a lot of bandwidth and disk space and significant work to maintain. A full private mirror would be too expensive and it would be overkill for my purposes.\nThe most common solution I found online was to implement a caching proxy using Squid. I had two concerns with this type of solution. First, I would need to edit repository definitions stored in /etc/yum.repo.d on each virtual and physical machine or container to use the same mirror. Second, I would need to use http and not https connections which would introduce a security risk.\nAfter reading Glenn’s 2018 post on the DNF local plugin, I searched for additional information but could not find much of anything besides the sparse documentation for the plugin on the DNF documentation web site. This article is intended to raise awareness of this plugin.\nUse DNS over TLS dnf updateinfo First, check the updates available:\n$ dnf check-update OK, so run your first dnf updateinfo command:\n$ dnf updateinfo Look at the list of updates and which types they belong to:\n$ dnf updateinfo list The next command will list the actual changelog.\n$ dnf updateinfo info install only security and bugfixes updates\n$ dnf check-update --security --bugfix $ sudo dnf update --security --bugfix Install only specific updates\n$ sudo dnf update --advisories=FEDORA-2021-74ebf2f06f,FEDORA-2021-83fdddca0f XFS 檔案系統簡介 CentOS 7 開始，預設的檔案系統已經由原本的 EXT4 變成了 XFS 檔案系統了！為啥 CentOS 要捨棄對 Linux 支援度最完整的 EXT 家族而改用 XFS 呢？ 這是有一些原因存在的。\nEXT 家族當前較傷腦筋的地方：支援度最廣，但格式化超慢！\nExt 檔案系統家族對於檔案格式化的處理方面，採用的是預先規劃出所有的 inode/block/meta data 等資料，未來系統可以直接取用， 不需要再進行動態配置的作法。這個作法在早期磁碟容量還不大的時候還算 OK 沒啥問題，但時至今日，磁碟容量越來越大，連傳統的 MBR 都已經被 GPT 所取代，連我們這些老人家以前聽到的超大 TB 容量也已經不夠看了！現在都已經說到 PB 或 EB 以上容量了呢！那妳可以想像得到，當你的 TB 以上等級的傳統 ext 家族檔案系統在格式化的時候，光是系統要預先分配 inode 與 block 就消耗你好多好多的人類時間了…\nTips：之前格式化過一個 70 TB 以上的磁碟陣列成為 ext4 檔案系統，按下格式化，去喝了咖啡、吃了便當才回來看做完了沒有… 所以，後來立刻改成 xfs 檔案系統了。\n另外，由於虛擬化的應用越來越廣泛，而作為虛擬化磁碟來源的巨型檔案 (單一檔案好幾個 GB 以上！) 也就越來越常見了。 這種巨型檔案在處理上需要考慮到效能問題，否則虛擬磁碟的效率就會不太好看。因此，從 CentOS 7.x 開始， 檔案系統已經由預設的 Ext4 變成了 xfs 這一個較適合高容量磁碟與巨型檔案效能較佳的檔案系統了。\nTips：其實鳥哥有幾組虛擬電腦教室伺服器系統，裡面跑的確實是 EXT4 檔案系統，老實說，並不覺得比 xfs 慢！所以，對鳥哥來說， 效能並不是主要改變檔案系統的考量！對於檔案系統的復原速度、建置速度，可能才是鳥哥改換成 xfs 的思考點。\nXFS 檔案系統的配置\n基本上 xfs 就是一個日誌式檔案系統，而 CentOS 7.x 拿它當預設的檔案系統，自然就是因為最早之前，這個 xfs 就是被開發來用於高容量磁碟以及高效能檔案系統之用， 因此，相當適合現在的系統環境。此外，幾乎所有 Ext4 檔案系統有的功能， xfs 都可以具備！也因此在本小節前幾部份談到檔案系統時， 其實大部份的操作依舊是在 xfs 檔案系統環境下介紹給各位的哩！\nxfs 檔案系統在資料的分佈上，主要規劃為三個部份，一個資料區 (data section)、一個檔案系統活動登錄區 (log section)以及一個即時運作區 (realtime section)。 這三個區域的資料內容如下：\n 資料區 (data section)  基本上，資料區就跟我們之前談到的 ext 家族一樣，包括 inode/data block/superblock 等資料，都放置在這個區塊。 這個資料區與 ext 家族的 block group 類似，也是分為多個儲存區群組 (allocation groups) 來分別放置檔案系統所需要的資料。 每個儲存區群組都包含了 (1)整個檔案系統的 superblock、 (2)剩餘空間的管理機制、 (3)inode的分配與追蹤。此外，inode與 block 都是系統需要用到時， 這才動態配置產生，所以格式化動作超級快！\n另外，與 ext 家族不同的是， xfs 的 block 與 inode 有多種不同的容量可供設定，block 容量可由 512bytes ~ 64K 調配，不過，Linux 的環境下， 由於記憶體控制的關係 (分頁檔 pagesize 的容量之故)，因此最高可以使用的 block 大小為 4K 而已！(鳥哥嘗試格式化 block 成為 16K 是沒問題的，不過，Linux 核心不給掛載！ 所以格式化完成後也無法使用啦！) 至於 inode 容量可由 256bytes 到 2M 這麼大！不過，大概還是保留 256bytes 的預設值就很夠用了！\nTips：總之， xfs 的這個資料區的儲存區群組 (allocation groups, AG)，你就將它想成是 ext 家族的 block 群組 (block groups) 就對了！本小節之前講的都可以在這個區塊內使用。 只是 inode 與 block 是動態產生，並非一開始於格式化就完成配置的。\n 檔案系統活動登錄區 (log section)  在登錄區這個區域主要被用來紀錄檔案系統的變化，其實有點像是日誌區啦！檔案的變化會在這裡紀錄下來，直到該變化完整的寫入到資料區後， 該筆紀錄才會被終結。如果檔案系統因為某些緣故 (例如最常見的停電) 而損毀時，系統會拿這個登錄區塊來進行檢驗，看看系統掛掉之前， 檔案系統正在運作些啥動作，藉以快速的修復檔案系統。\n因為系統所有動作的時候都會在這個區塊做個紀錄，因此這個區塊的磁碟活動是相當頻繁的！xfs 設計有點有趣，在這個區域中， 妳可以指定外部的磁碟來作為 xfs 檔案系統的日誌區塊喔！例如，妳可以將 SSD 磁碟作為 xfs 的登錄區，這樣當系統需要進行任何活動時， 就可以更快速的進行工作！相當有趣！\n 即時運作區 (realtime section)  當有檔案要被建立時，xfs 會在這個區段裡面找一個到數個的 extent 區塊，將檔案放置在這個區塊內，等到分配完畢後，再寫入到 data section 的 inode 與 block 去！ 這個 extent 區塊的大小得要在格式化的時候就先指定，最小值是 4K 最大可到 1G。一般非磁碟陣列的磁碟預設為 64K 容量，而具有類似磁碟陣列的 stripe 情況下，則建議 extent 設定為與 stripe 一樣大較佳。這個 extent 最好不要亂動，因為可能會影響到實體磁碟的效能喔。\nXFS 檔案系統的描述資料觀察\n剛剛講了這麼多，完全無法理會耶～有沒有像 EXT 家族的 dumpe2fs 去觀察 superblock 內容的相關指令可以查閱呢？有啦！可以使用 xfs_info 去觀察的！ 詳細的指令作法可以參考如下：\n[root@study ~]# xfs_info 掛載點|裝置檔名 範例一：找出系統 /boot 這個掛載點底下的檔案系統的 superblock 紀錄 [root@study ~]# df -T /boot Filesystem Type 1K-blocks Used Available Use% Mounted on /dev/vda2 xfs 1038336 133704 904632 13% /boot # 沒錯！可以看得出來是 xfs 檔案系統的！來觀察一下內容吧！ [root@study ~]# xfs_info /dev/vda2 1 meta-data=/dev/vda2 isize=256 agcount=4, agsize=65536 blks 2 = sectsz=512 attr=2, projid32bit=1 3 = crc=0 finobt=0 4 data = bsize=4096 blocks=262144, imaxpct=25 5 = sunit=0 swidth=0 blks 6 naming =version 2 bsize=4096 ascii-ci=0 ftype=0 7 log =internal bsize=4096 blocks=2560, version=2 8 = sectsz=512 sunit=0 blks, lazy-count=1 9 realtime =none extsz=4096 blocks=0, rtextents=0 上面的輸出訊息可以這樣解釋：\n 第 1 行裡面的 isize 指的是 inode 的容量，每個有 256bytes 這麼大。至於 agcount 則是前面談到的儲存區群組 (allocation group) 的個數，共有 4 個， agsize 則是指每個儲存區群組具有 65536 個 block 。配合第 4 行的 block 設定為 4K，因此整個檔案系統的容量應該就是 4655364K 這麼大！ 第 2 行裡面 sectsz 指的是邏輯磁區 (sector) 的容量設定為 512bytes 這麼大的意思。 第 4 行裡面的 bsize 指的是 block 的容量，每個 block 為 4K 的意思，共有 262144 個 block 在這個檔案系統內。 第 5 行裡面的 sunit 與 swidth 與磁碟陣列的 stripe 相關性較高。這部份我們底下格式化的時候會舉一個例子來說明。 第 7 行裡面的 internal 指的是這個登錄區的位置在檔案系統內，而不是外部設備的意思。且佔用了 4K * 2560 個 block，總共約 10M 的容量。 第 9 行裡面的 realtime 區域，裡面的 extent 容量為 4K。不過目前沒有使用。  由於我們並沒有使用磁碟陣列，因此上頭這個裝置裡頭的 sunit 與 extent 就沒有額外的指定特別的值。根據 xfs(5) 的說明，這兩個值會影響到你的檔案系統性能， 所以格式化的時候要特別留意喔！上面的說明大致上看看即可，比較重要的部份已經用特殊字體圈起來，你可以瞧一瞧先！\nRosetta 由于我主要使用 ubuntu，为学习而使用 fedora，只是短时期使用过其他发行版，因此截取部分如下。\nBasic operations    Action Red Hat/Fedora Debian/Ubuntu     Search for package(s) by searching the expression in name, description, short description. What exact fields are being searched by default varies in each tool. Mostly options bring tools on par. dnf search apt search   Install a package(s) by name dnf install apt install   Upgrade Packages - Install packages which have an older version already installed dnf upgrade apt update and then apt upgrade   Upgrade Packages - Another form of the update command, which can perform more complex updates – like distribution upgrades. When the usual update command will omit package updates, which include changes in dependencies, this command can perform those updates. dnf distro-sync apt update and then apt dist-upgrade   Remove a package(s) and all dependencies by name dnf remove apt autoremove   Remove a package(s) and its configuration files ? apt purge   Remove a package(s) and all dependencies and configuration files ? apt autoremove --purge   Remove dependencies that are no longer needed (orphans), because e.g. the package which needed the dependencies was removed. dnf autoremove apt autoremove   Remove packages no longer included in any repositories. dnf repoquery --extras aptitude purge '~o'   Mark a package previously installed as a dependency as explicitly required. dnf mark install apt-mark manual   Install package(s) as dependency / without marking as explicitly required. dnf install and then dnf mark remove apt-mark auto   Only downloads the given package(s) without unpacking or installing them dnf download apt install --download-only (into the package cache) or apt download (bypass the package cache)   Clean up all local caches. Options might limit what is actually cleaned. dnf clean all apt autoclean removes only unneeded, obsolete information or apt clean   Start a shell to enter multiple commands in one session dnf shell    Show a log of actions taken by the software management. dnf history read /var/log/dpkg.log   Get a dump of the whole system information - Prints, Saves or similar the current state of the package management system. Preferred output is text or XML. (Note: Why either-or here? No tool offers the option to choose the output format.) see /var/lib/rpm/Packages apt-cache stats   e-mail delivery of package changes  apt install apt-listchanges    Querying specific packages    Action Red Hat/Fedora Debian/Ubuntu     Show all or most information about a package. The tools' verbosity for the default command vary. But with options, the tools are on par with each other. dnf list or dnf info apt show or apt-cache policy   Display local package information: Name, version, description, etc. rpm -qi / dnf info installed dpkg -s or aptitude show   Display remote package information: Name, version, description, etc. dnf info apt-cache show or aptitude show   Display files provided by local package rpm -ql dpkg -L   Display files provided by a remote package dnf repoquery -l or repoquery -l (from package yum-utils) apt-file list   Query the package which provides FILE rpm -qf (installed only) or dnf provides (everything) or repoquery -f (from package yum-utils) dpkg -S or dlocate   List the files that the package holds. Again, this functionality can be mimicked by other more complex commands. dnf repoquery -l dpkg-query -L   Displays packages which provide the given exp. aka reverse provides. Mainly a shortcut to search a specific field. Other tools might offer this functionality through the search command. dnf provides apt-file search   Search all packages to find the one which holds the specified file. dnf provides apt-file search or auto-apt is using this functionality.   Show the changelog of a package dnf changelog apt-get changelog    Querying package lists    Action Red Hat/Fedora Debian/Ubuntu     Search for package(s) by searching the expression in name, description, short description. What exact fields are being searched by default varies in each tool. Mostly options bring tools on par. dnf search apt search   Lists packages which have an update available. Note: Some provide special commands to limit the output to certain installation sources, others use options. dnf list updates or dnf check-update apt list --upgradable   Display a list of all packages in all installation sources that are handled by the packages management. Some tools provide options or additional commands to limit the output to a specific installation source. dnf list available apt-cache dumpavail or apt-cache dump (Cache only) or apt-cache pkgnames   Generates a list of installed packages dnf list installed `dpkg –list   List packages that are installed but are not available in any installation source (anymore). dnf list extras `apt –installed list   List packages that were recently added to one of the installation sources, i.e. which are new to it. dnf list recent aptitude search '~N' or aptitude forget-new   List installed local packages along with version rpm -qa dpkg -l or apt list --installed   Search locally installed package for names or descriptions rpm -qa '**' `aptitude search ‘~i(~n $name   List packages not required by any other package dnf leaves or package-cleanup --leaves --all deborphan -anp1   List packages installed explicitly (not as dependencies) dnf history userinstalled apt-mark showmanual   List packages installed automatically (as dependencies) grep -E ‘^i[^+]’ (workaround) apt-mark showauto    Querying package dependencies    Action Red Hat/Fedora Debian/Ubuntu     Display packages which require X to be installed, aka show reverse dependencies. dnf repoquery --alldeps --whatrequires or repoquery --whatrequires apt-cache rdepends or aptitude search ~D$pattern   Display packages which conflict with given expression (often package). Search can be used as well to mimic this function. dnf repoquery --conflicts aptitude search '~C$pattern'   List all packages which are required for the given package, aka show dependencies. dnf repoquery --requires or repoquery -R apt-cache depends or apt-cache show   List what the current package provides dnf repoquery --provides dpkg -s or aptitude show   List all packages that require a particular package dnf repoquery --installed --alldeps --whatrequires aptitude search ~D{depends,recommends,suggests}:$pattern or aptitude why   Display all packages that the specified packages obsoletes. dnf list obsoletes apt-cache show   Generates an output suitable for processing with dotty for the given package(s).  apt-cache dotty    Installation sources management    Action Red Hat/Fedora Debian/Ubuntu     Installation sources management edit /etc/yum.repos.d/${REPO}.repo edit /etc/apt/sources.list   Add an installation source to the system. Some tools provide additional commands for certain sources, others allow all types of source URI for the add command. Again others, like apt and dnf force editing a sources list. apt-cdrom is a special command, which offers special options design for CDs/DVDs as source. /etc/yum.repos.d/*.repo apt-cdrom add   Refresh the information about the specified installation source(s) or all installation sources. dnf clean expire-cache and then dnf check-update apt-get update   Prints a list of all installation sources including important information like URI, alias etc. cat /etc/yum.repos.d/* apt-cache policy   List all packages from a certain repo     Disable an installation source for an operation dnf --disablerepo=    Download packages from a different version of the distribution than the one installed. dnf --releasever= apt-get install -t release package or apt-get install package/release (dependencies not covered)    Overrides    Action Red Hat/Fedora Debian/Ubuntu     Add a package lock rule to keep its current state from being changed edit dnf.conf adding/amending the exclude option apt-mark hold pkg   Delete a package lock rule  apt-mark unhold pkg   Show a listing of all lock rules  /etc/apt/preferences   Set the priority of the given package to avoid upgrade, force downgrade or to overwrite any default behavior. Can also be used to prefer a package version from a certain installation source.  /etc/apt/preferences, apt-cache policy   Remove a previously set priority  /etc/apt/preferences   Show a list of set priorities  apt-cache policy or /etc/apt/preferences   Ignore problems that priorities may trigger.      Verification and repair    Action Red Hat/Fedora Debian/Ubuntu     Verify single package rpm -V debsums   Verify all packages rpm -Va debsums   Reinstall given package; this will reinstall the given package without dependency hassle dnf reinstall apt install --reinstall   Verify dependencies of the complete system; used if installation process was forcefully killed dnf repoquery --requires apt-get check   Use some magic to fix broken dependencies in a system dnf repoquery --unsatisfied apt-get --fix-broken and then aptitude install   Add a checkpoint to the package system for later rollback (unnecessary, it is done on every transaction)    Remove a checkpoint from the system n/a    Provide a list of all system checkpoints dnf history list    Rolls entire packages back to a certain date or checkpoint dnf history rollback    Undo a single specified transaction dnf history undo     Using package files and building packages    Action Red Hat/Fedora Debian/Ubuntu     Query a package supplied on the command line rather than an entry in the package management database rpm -qp dpkg -I   List the contents of a package file rpmls rpm -qpl dpkg -c   Install local package file, e.g. app.rpm and uses the installation sources to resolve dependencies dnf install apt install   Updates package(s) with local packages and uses the installation sources to resolve dependencies dnf upgrade debi   Add a local package to the local package cache mostly for debugging purposes.  apt-cache add *package-filename*   Extract a package `rpm2cpio cpio -vid`   Install/Remove packages to satisfy build-dependencies. Uses information in the source package dnf builddep apt-get build-dep   Display the source package to the given package name(s) dnf repoquery -s apt-cache showsrc   Download the corresponding source package(s) to the given package name(s) dnf download --source apt-get source or debcheckout   Build a package rpmbuild -ba (normal) or mock (in chroot) debuild   Check for possible packaging issues rpmlint lintian    Fedora Tips kill kill 是向进程发送信号的命令。\n   代号 名称 内容     1 SIGHUP 启动被终止的程序，可让该进程重新读取自己的配置文件，类似重新启动。   2 SIGINT 相当于用键盘输入 [ctrl]-c 来中断一个程序的进行。   9 SIGKILL 代表强制中断一个程序的进行，如果该程序进行到一半，那么尚未完成的部分可能会有“半产品”产生，类似 vim会有 .filename.swp 保留下来。   15 SIGTERM 以正常的方式来终止该程序。由于是正常的终止，所以后续的动作会将他完成。不过，如果该程序已经发生问题，就是无法使用正常的方法终止时，输入这个 signal 也是没有用的。   19 SIGSTOP 相当于用键盘输入 [ctrl]-z 来暂停一个程序的进行。    Shell freezes In the event of a shell freeze (which might be caused by certain appearance tweaks, malfunctioning extensions or perhaps a lack of available memory), restarting the shell by pressing Alt+F2 and then entering r may not be possible.\nIn this case, try switching to another TTY (Ctrl+Alt+F2) and entering the following command: pkill -HUP gnome-shell. It may take a few seconds before the shell successfully restarts. On X11, restarting the shell in this fashion should not log the user out, but it is a good idea to try and ensure that all work is saved anyway; on Wayland (currently the default), restarting the shell kills the whole session, so everything will be lost.\nIf this fails, the Xorg server will need to be restarted either by pkill X for console logins or by restarting gdm.service for GDM logins. Bear in mind that restarting the Xorg server will log the user out, so try to ensure that all work is saved before attempting this.\nfix a frozen Gnome desktop session 在较旧的 Gnome（即 Gnome 3.28 之前）中，您可以使用此命令重新启动 GNome shell。\n$ glxinfo | grep display name of display: :1 display: :1 screen: 0 $ touch gnome-restart $ echo '#!/bin/bash'  gnome-restart $ echo 'DISPLAY=:1 gnome-shell --replace \u0026'  gnome-restart $ sudo chmod +x gnome-restart $ ./gnome-restart 重启 Gnome Shell 可以使用 busctl --user call org.gnome.Shell /org/gnome/Shell org.gnome.Shell Eval s 'Meta.restart(\"Restarting…\")' 命令行执行 ALT + F2 r 相同的操作。\n亦可：\n$ sudo systemctl restart systemd-logind Gaming on Fedora  Nvidia Drivers Steam(ProtonDB)/Lutris/Q4Wine Discord OBS GOverlay  Fedora 33 百度网盘Linux版 那个 rpm 包压根不是对标最新的Fedora的，而是给那些基于RHEL的同样使用rpm包管理的古董国产操作系统使用的。\n下载 baidunetdisk_3.5.0_amd64.deb，并解压出实际的程序。\n首先我们跑一下，看看bt 吧：\nThread 1 \"baidunetdisk\" received signal SIGSEGV, Segmentation fault. 0x00007ffff5096179 in EVP_MD_CTX_clear_flags () from /lib64/libcrypto.so.1.1 (gdb) bt 目测翻车在libcrypto.so.1.1, 而且是跟sqlite加密有关.\n我们把baidunetdisk动态链接到相关的加密库都找出来:\n$ ldd baidunetdisk | grep -i -E 'ssl|crypt' libgcrypt.so.20 = /lib64/libgcrypt.so.20 (0x00007fa18d693000) libk5crypto.so.3 = /lib64/libk5crypto.so.3 (0x00007fa18d3cd000) libcrypto.so.1.1 = /lib64/libcrypto.so.1.1 (0x00007fa18d0c0000) 经验告诉我，这个baidunetdisk挂的原因是， Fedora 33上面的包都比较新，尤其是 openssl 库. 因此，解决办法是，去下载老版本的 Ubuntu 18.04 的包，然后把so文件取出来，强制baidunetdisk使用这些旧版本的库即可.\nldd 一下很容易找出依赖关系: libkrb5.so.3 - libk5crypto.so.3 - libcrypto.so.1.1\n下载以下包:\nhttps://ubuntu.pkgs.org/18.04/ubuntu-main-amd64/libkrb5support0_1.16-2build1_amd64.deb.html https://ubuntu.pkgs.org/18.04/ubuntu-main-amd64/libk5crypto3_1.16-2build1_amd64.deb.html https://ubuntu.pkgs.org/18.04/ubuntu-main-amd64/libkrb5-3_1.16-2build1_amd64.deb.html https://ubuntu.pkgs.org/18.04/ubuntu-main-amd64/libgssapi-krb5-2_1.16-2build1_amd64.deb.html http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.0g-2ubuntu4_amd64.deb 编辑 /usr/share/applications/baidunetdisk.desktop, 将Exec=/opt/baidunetdisk/baidunetdisk --no-sandbox %U 修改成：\nExec=/bin/env LD_LIBRARY_PATH=/home/ttys3/Apps/baidunetdisk /home/ttys3/Apps/baidunetdisk/baidunetdisk --no-sandbox %U ldd 查看程序依赖库 作用：用来查看程式运行所需的共享库,常用来解决程式因缺少某个库文件而不能运行的一些问题。\n示例：查看test程序运行所依赖的库:\n/opt/app/todeav1/test$ ldd test libstdc++.so.6 = /usr/lib64/libstdc++.so.6 (0x00000039a7e00000) libm.so.6 = /lib64/libm.so.6 (0x0000003996400000) libgcc_s.so.1 = /lib64/libgcc_s.so.1 (0x00000039a5600000) libc.so.6 = /lib64/libc.so.6 (0x0000003995800000) /lib64/ld-linux-x86-64.so.2 (0x0000003995400000) /opt/app/todeav1/test$ ldd libc.so.6 ...  第一列：程序需要依赖什么库 第二列: 系统提供的与程序需要的库所对应的库 第三列：库加载的开始地址  通过上面的信息，我们可以得到以下几个信息：\n 通过对比第一列和第二列，我们可以分析程序需要依赖的库和系统实际提供的，是否相匹配 通过观察第三列，我们可以知道在当前的库中的符号在对应的进程的地址空间中的开始位置  如果依赖的某个库找不到，通过这个命令可以迅速定位问题所在。\n原理： ldd不是个可执行程式，而只是个shell脚本； ldd显示可执行模块的dependency的工作原理，其实质是通过ld-linux.so（elf动态库的装载器）来实现的。ld-linux.so模块会先于executable模块程式工作，并获得控制权，因此当上述的那些环境变量被设置时，ld-linux.so选择了显示可执行模块的dependency。\nadb and fastboot $ sudo dnf install android-tools OneDrive 加速 OneDrive 的下载速度，明白的都明白，不懂得也就算了 。\nPC 端（手机端应该也可以）有一个可能有效的提速方法是：\n 前往：https://tools.ipip.net/traceroute.php 左侧 ipv6 或 ipv4 选择离自己最近的运营商，右侧 ICMP 填入sharepoint.com 搜索之后将延时最短的非局域网 ip 填入在hosts文件中 保存，使之生效，可以在控制台ping sharepoint.com查看是否成功解析到新的 ip  Recover a root password   Boot the Live installation media and choose Try Fedora.\n  From the desktop, open a terminal and switch to root using su (the system will not ask for a password).\n  To view your hard drive device nodes, enter df -H into the terminal. For this example we will use /dev/sda1 for the /boot partition and /dev/sda2 for the root / partition.\nIf you are using LVM partitions, type: sudo lvscan and note the /dev path of your root partition. For this example we will use /dev/fedora/root.\n  Create a directory for the mount point (use the -p option to create subdirectories):\nmkdir -p /mnt/sysimage/boot   Mount the / (root) partition (be sure to use the actual device node or LVM path of your root / partition):\nTo mount root on a standard partition scheme enter:\nmount /dev/sda2 /mnt/sysimage To mount root on an LVM partition scheme enter:\nmount /dev/fedora/root /mnt/sysimage   Continue the process by mounting /boot, proc, /dev, and /run with:\nmount /dev/sda1 /mnt/sysimage/boot mount -t proc none /mnt/sysimage/proc mount -o bind /dev /mnt/sysimage/dev mount -o bind /run /mnt/sysimage/run   chroot to the mounted root partition with:\nchroot /mnt/sysimage /bin/bash   Change the root password:\npasswd   Exit out of chroot with:\nexit and exit out of the terminal.\n  Reboot your system and boot from the hard drive.\n  Congratulations, your root password has been successfully changed.\nSamba Server Install and Configure Samba\nTo get started with samba, you need to install the samba core packages and samba-client package as shown:\n# dnf install samba samba-common samba-client  After all the samba is installed, you need to configure the samba share directory with proper permissions and ownership, so that it is going to be shared with all client machines in the same local network.\n# mkdir -p /srv/tecmint/data # chmod -R 755 /srv/tecmint/data # chown -R nobody:nobody /srv/tecmint/data # chcon -t samba_share_t /srv/tecmint/data Next, we are going to configure the Samba share directory in the smb.conf file, which is the main configuration file for Samba.\n# mv /etc/samba/smb.conf /etc/samba/smb.conf.bak # vim /etc/samba/smb.conf Add the following configuration lines, which define the policies on who can access the samba share on the network.\n[global] workgroup = WORKGROUP server string = Samba Server %v netbios name = rocky-8 security = user map to guest = bad user dns proxy = no ntlm auth = true [Public] path = /srv/tecmint/data browsable =yes writable = yes guest ok = yes read only = no Save and exit the configuration file.\nNext, verify the samba configuration for errors.\n# testparm If everything looks okay, make sure to start, enable and verify the status of the Samba daemons.\n# systemctl start smb # systemctl enable smb # systemctl start nmb # systemctl enable nmb # systemctl status smb # systemctl status nmb Accessing Samba Share from Windows\nTo access Samba share from the Windows machine, press the Windows logo key + R to launch the Run dialog and enter the IP address of the samba server\nSecure Samba Share Directory\nTo secure our Samba share, we need to create a new samba user.\n# useradd smbuser # smbpasswd -a smbuser Next, create a new group and add the new samba user to this group.\n# sudo groupadd smb_group # sudo usermod -g smb_group smbuser Thereafter, create another secure samba share directory for accessing files securely by samba users.\n# mkdir -p /srv/tecmint/private # chmod -R 770 /srv/tecmint/private # chcon -t samba_share_t /srv/tecmint/private # chown -R root:smb_group /srv/tecmint/private Once again, access the Samba configuration file.\n# vi /etc/samba/smb.conf Add these lines to define to secure samba share.\n[Private] path = /srv/tecmint/private valid users = @smb_group guest ok = no writable = no browsable = yes Save the changes and exit.\nFinally, restart all the samba daemons as shown.\n$ sudo systemctl restart smb $ sudo systemctl restart nmb Now try to access the Samba share, this time you will see an additional ‘Private‘ directory. To access this directory, you will be required to authenticate with the Samba user’s credentials\n[MIT/GNU Scheme](MIT/GNU Scheme) 9.2 是最后支持 windows 的版本，之前的版本我在fedora上编译失败了。\n$ wget https://ftp.gnu.org/gnu/mit-scheme/stable.pkg/9.2/mit-scheme-9.2-x86-64.tar.gz $ sudo dnf install gcc make m4 ncurses-devel libX11-devel $ tar xzf mit-scheme-VERSION-i386.tar.gz $ cd mit-scheme-VERSION/src $ sudo ./configure --prefix=/opt/mit-scheme $ sudo make $ sudo make install WAV、FLAC、APE 区别 同一个音乐文件而言，WAV、FLAC、APE三种音乐格式的音质是完全一样的。\n意思是说，从CD碟上抓轨出来后，得到的WAV和APE、FLAC音质完全相同，实际上是不同形式的同一个文件。但与CD碟是否完全一样，除了抓轨操作问题，基本上都是电脑设备技术所限。（你不能要求电脑器材技术同灌制唱片的专业器材一致，电脑只是个均衡性技术器材组合体。）\n所以，从收藏角度来说，三种格式可以，一样。但播放效果上，上万元的专业设备和神经质般的金耳朵是能听出些许差别来的，这主要是因为不同格式间因编码不同导致解码速度不同所致；如果转换为同一种格式，正常听是没有区别的。\n那么，APE、FLAC、WAV三种格式区别在哪里呢？（这些区别并不是说音乐文件本身品质有优劣）\n  编码不同，导致解码速度WAV  FLAC  APE，直接影响到播放听感流畅性上：WAV  FLAC  APE\nWAV波形文件是音响设备和很多软件可以直接读取的波形文件，基本上不存在编解码问题。flac和ape都对WAV进行了编码，故能换取较小的体积，但同时造成解码播放时，因播放器材解析力很敏感（或者说技术所限），会因出现一定的jitter抖动（解析复杂编码所致）而导致播放效果不够饱满和流畅。这点你可以通过统一转换为WAV格式来试听解决。\n  编码不同，导致所占空间大小 APE 由于flac和ape都对WAV进行了更高技术的编码，所以换取了较小的体积，这也是这两种格式之所以出现的根本原因。由于二者都是无损压缩，如果你是为了收藏，同时你的空间比较吃紧，无疑收藏较小体积的APE是最佳选择。至于以后会不会出现更小体积的无损压缩格式，但目前来说，APE 是最优选择。\n  编码不同，解码速度不一，导致占用CPU和耗电量不同。\n编码越复杂，解码越麻烦，自然占用内存率越高，耗电量自然越大。那些伤不起的播放机们感触最深，同样的电量，三种格式播放时长依次为由长到短：WAV  FLAC  APE，所以，如果你的P5播放机比较脆弱，自然选择WAV可以享受更长时间的音乐。\n  开源性不同，导致纠错效果不同。\n这一点各取所需吧！很多flac粉们对APE的防纠错和容错性大为诟病，指责其一报错就无法继续播放，等于整轨作废，同时嫌技术不开放（难道你自己要编程？搞不懂这个意见也这么大）。而flac用静音处理方式他们就认为很好。\n个人认为，如果播放的话，因为一个错误就整轨不能播放，等于白下载，的确很烦人，而flac静音处理得以继续播放下面的曲目，的确人性；但从收藏的角度而言，静音处理错误是不是有点瞒天过海、自欺欺人？发烧者和收藏癖们对人耳觉察不到的细微差别都耿耿于怀，怎么会放过这么大的差错？反正，如果有错误音轨，我是肯定不要收藏的，而APE，正好给我了检验好坏质量的途径。\n  开源性不同，导致支持软件多寡不均。\n编码软件的支持上，大家都说支持flac的软件比ape多。这点没问题。但并不等于支持Ape格式的播放软件就少。实际上，现在已经有很多软件支持ape了。而且，支持flac的软件虽然多，也有很多不支持flac的，但wav就不一样了，还没有不支持WAV格式的播放器呢！这样说来，是不是也要把flac淘汰掉？！其实，听的时候就那么几首歌，转一下格式能够让你的播放器支持不就好啦。\n  从收藏角度讲，APE、FLAC、WAV三种格式一样，文件音质相同；从播放来讲，格式不同，专业设备下，效果可能会有人耳察觉不同的区别（楼主没感觉出来）。\n扩展知识 无损音乐音质也分“三六九等”\n同一个文件的各个无损格式是一样的音质，如果不是同一个文件，即使是同一首歌，音质也分三六九等。举个例子，彭丽媛的曲目《在希望的田野上》 ，收录于《非同凡响》、《沂蒙山小调》、《演唱中国民歌》、《珠穆朗玛》等多个音乐专辑，这些专辑分别由不同的唱片公司于不同的时间出版，音质就会参差不齐。同时，由于时代不同，技术上受历史局限。也会导致音质有别。\n为什么无损音乐和CD比较，听觉上会有细微差别？\n无损音乐与CD碟片数据信息完全一样，那为什么音效不一样呢？嗯，这里我用的“音效”这个词非常好。CD碟和原声一样吗？肯定不一样。主要是技术上根本做不到完全还原原声。而且，为了音乐效果，一般还会加进各种特效。CD播放机和电脑，更是两个功用完全不同的设备。音效当然不可能一致。\n其实，就算CD播放机，也不可能找到两台播放效果完全一样的。有句话，大意是世界上不可能找到两把相同的二胡，也是这个意思。\n假无损是怎么回事？\n到这里，我就给大家提炼出一个观点：【“无损音乐”不等于“无损音质”】\n除了碟片录制设备技术问题（早期碟片音质都不好；不同唱片公司录制技术层次不同；国内碟相对国外顶级技术也不好），也有假无损，即不是由正版CD碟片抓轨得到，而是通过盗版碟片抓轨、磁带（卡带）翻录甚至是有损音乐（MP3等）转换而得到。这些APE、FLAC、WAV等格式的所谓的“无损音乐”，其音质就很差很差。\n除了第一个原因我们无奈选择外，其他的发烧友都应该剔除。对于磁带翻录，如果是稀有资源，建议大家保留，因为如果找不到无损，有总比无好。\n我的音乐听起来音质不好，是无损吗？\n前面说了，【“无损音乐”不等于“无损音质”】，无损音乐严格来说，是指wav波形文件从音乐CD碟片的无损数字记录和APE、FLAC、WavPack、WMALossless等则是对WAV波形文件进行无损压缩。wav是无损音乐文件，APE、FLAC等则是无损压缩音乐文件。绝对意义上讲，他们都不能完全替代CD碟。WAV波形文件在媒体播放器里直接播放，而APE等其他压缩格式则需要经过解压（解码）还原成WAV再进行播放。\n如果你的无损音乐听感比较差，这你就要注意了\n⒈ 是真无损，多见于早期碟片。由于上世纪CD碟片刚起步，技术水平有限，故灌制效果相对今天的碟片来说欠佳。此外，即使今天，不同唱片公司出品的碟片，音质也有差别。在没有替代品的情况下，建议保留。\n⒉ 是真无损，音质不好可能由抓轨操作失误造成“爆音”等数据信息残缺，建议更换。\n⒊ 显示真无损，音质极差。这多由磁带/卡带转录而来。早期歌手只有磁带作品留世，虽然音质不好，但是唯一的纪念品。将其转录为数据，是为了更好地保存。在没有替代品的情况下，建议保留。\n⒋ 假无损。即由有损格式MP3、WMA、OGG等格式转换而来，有些凭耳听，甚至难与真无损辨别，只有软件能检测出。有损转无损，丢失的信息不会转回来。虽然体积增大了，音质还是有损的音质。\n如何鉴别无损音乐？\n如何鉴别？主要是一靠听、二靠看、三靠软件检测。\n注意软件检测也会出错，只是作为参考。毕竟，音乐最主要的用途是欣赏，而不是科学精密研究。建议大家首先听。比如磁带转录的，一般一听就听出来。但软件检测未必检测出。这是因为软件作用只是检测哪些是由有损低劣的音乐转换成的伪劣假冒无损。\n  【一听】\n听第一感觉，如果音质不好，甚至有爆音，即使是真无损，也是音质较差的低劣无损。\n  【二看】看占用空间大小和播放码率\n看占用空间大小，一定要在相同格式的前提下，否则用APE和FLAC比较，是无意义的。一般，两个时长、内容一致的同名文件，占用空间越大者原则上包含信息越丰富、音质越好；看播放码率。\n  【三检测】用无损检验软件检测，和看频谱。\n  篇外篇 长期来，很多人对MP3印象不好，更多人认为WMA的最佳音质要好过MP3，这种说法是不正确的，在中高码率下，编码得当的MP3要比WMA优秀很多，可以非常接近CD音质，在不太好的硬件设备支持下，没有多少人可以区分两者的差异，这不是神话故事，尽管你以前盲听就可以很轻松区分MP3和CD，但现在你难保证你可以分辨正确。因为MP3也是优秀的编码，以前被埋没了。\n大家都谈说音质好，一种是指还原度好，就是说和录制的时候差别越小越好；一种是指悦耳，就是好听。就mp3来说，mp3是一种压缩格式，码率越高，通常来说就代表压缩小，损失的细节比较少，也就是说，码率越高听起来越接近原声。但是音质还和你的输出设备有关，比如说一部好的mp3，一对好耳机，这都对你的听音音质有帮助！因此，如果想改善音质，不妨从以上几个角度出发，不要过分强调其中哪一方面。\n视频编码码率控制 背景知识：\n视频编码过程中，有一个重要步骤：量化，量化属于有损压缩过程。量化基本决定了视频的码率，视频的码率又从一定程度上决定了视频的质量。量化值QP越大则量化的粒度越高，压缩率越大，码率更小，视频质量越低，呈现出来就是马赛克比较大，画面不细腻，画面比较模糊。反之，压缩率低，码率大，质量高，画面细腻，细节丰富。\n所以选择一个适合场景的视频码控方案很重要，调整视频输出码率其实就是在视频编码速度、网络带宽以及视频质量之间做一个平衡。有时网络带宽很受限，就要优先考虑码率大小优先的码控方案，有些对视频质量要求很高，要高清视频，那就要选择质量优先的模型。\n整体来说选择视频编码码率控制方案，可以通过下面五个因素权衡得出：\n  视觉质量稳定性，利于视觉主观质量，比如清晰度，流畅度，细节等，这点和人眼的视觉原理有关，选择人眼主动质量感受最高的模型；\n  即时输出码率，相当于每帧编码输出比特数，要考虑网络带宽因素，随着移动互联网发展，也需要考虑wifi和无线网这块的影响；\n  输出视频文件大小可控，利于传输，存储，要看系统的空间大小；\n  编码速度，不同的码控模型也影响了编码速度，对于低延时、实时场景要考虑，因为不同的码控方案，计算的复杂度不同，带来的编码延时也有影响；\n  对于移动设备还需要不同编码方式耗电量要求，因为不同模型会影响编码和解码复杂度，进而在移动设备编码和播放需要的耗电量不同；\n  CBR 恒定码率（Constant Bit Rate），一定时间范围内比特率基本保持的恒定，属于码率优先模型。\n**适用场景：**一般也不建议使用这种方式，虽然输出的码率总是处于一个稳定值，但是质量不稳定，不能充分有效利用网络带宽，因为这种模型不考虑视频内容的复杂性，把所有视频帧的内容统一对待。但是有些编码软件只支持固定质量或者固定码率方式，有时不得不用。用的时候在允许的带宽范围内尽可能把带宽设置大点，以防止复杂运动场景下视频质量很低，如果设置的不合理，在运动场景下直接就糊的看不成了。\n特点：\n 码率稳定，但是质量不稳定，带宽有效利用率不高，特别当该值设置不合理，在复杂运动场景下，画面非常模糊，非常影响观看体验； 但是输出视频码率基本稳定，便于计算视频体积大小；  VBR 可变码率（Variable Bit Rate），简单场景分配比较大的QP，压缩率小，质量高。复杂场景分配较小QP。得到基本稳定的视觉质量，因为人眼人眼本来就对复杂场景不敏感，缺点在于输出码率大小不可控。\n有两种调控模式：质量优先模式和2PASS二次编码模式。\n质量优先模式：\n不考虑输出视频文件的大小，完全按照视频的内容复杂程度来分配码率，这样视频的播放效果质量最好。\n二次编码方式2PASS：\n第一次编码检测视频内容的简单和复杂部分，同时确定简单和复杂的比例。第二遍编码会让视频的平均码率不变，复杂的地方分配多bit,简单地方分配少bit。这种编码虽然很好，但是速度会跟不上。\n**适用场景：**VBR适用于那些对带宽和编码速度不太限制，但是对质量有很高要求的场景。特别是在运动的复杂场景下也可以保持比较高的清晰度且输出质量比较稳定，适合对延时不敏感的点播，录播或者存储系统。\n特点：\n 码率不稳定，质量基本稳定且非常高； 编码速度一般比较慢，点播、下载和存储系统可以优先使用，不适合低延时、直播系统； 这种模型完全不考虑输出的视频带宽，为了质量，需要多少码率就占用多少，也不太考虑编码速度；  ABR 恒定平均目标码率(Average Bit Rate），简单场景分配较低bit,复杂场景分配足够bit，使得有限的bit数能够在不同场景下合理分配，这类似VBR。同时一定时间内，平均码率又接近设置的目标码率，这样可以控制输出文件的大小，这又类似CBR。可以认为是CBR和VBR的折中方案，这是大多人的选择。特别在对质量和视频带宽都有要求的情况下，可以优先选择该模式，一般速度是VBR的两倍到三倍，相同体积的视频文件质量却比CBR好很多。\n**适用场景：**ABR在直播和低延时系统用的比较多，因为只编码了一次，所以速度快，同时兼顾了视频质量和带宽,对于转码速度有要求的情况下也可以选择该模式。B站的大部分视频就选择了该模式。\n特点：\n 视频质量整体可控，同时兼顾了视频码率和速度，是一个折中方案，实际用的比较多； 使用过程一般要让调用方设置，最低码率、最高码率和平均码率，这些值要尽可能设置合理点；  总结 不懂的話沒關係，反正普遍情況是這樣的：\n  音質：CBR  VBR  ABR\n192 kbps以下的CBR，與後兩者無明顯差異，但檔案容量差很多，建議有心要壓CBR就直接衝高流量！\n  檔案大小：CBR  VBR \u0026 ABR\n後兩者隨參數設定而有差別，大致上差不了多少\n  DFF、DSF、DST  DSD是SACD采用的信号调制方式，相当于CDDA（普通CD）采用的PCM调制方式。 DSF、DFF是SACD碟片中数据的未压缩编码格式，DSF用于Sony，DFF用于Philips，相当于CDDA碟片中的WAV文件。 DST是一种对SACD中DSF、DFF数据进行无损压缩的编码格式，相当于FLAC、APE是对CDDA中WAV数据的无损压缩。  RPM 搜索与下载网站  pkgs.org：最好的 rpm.pbone.net：比较全面但是下载速度有点慢 rpmfind.net：速度还可以就是没有上面的全 crpm.cn  误删了 /usr/share/icons 目录   从他们的官方网站下载您的操作系统的完整 ISO 并将其加载到驱动器中，然后将 /usr/share/applications 从 ISO 复制到您的系统。\n  reinstall\n$ sudo dnf reinstall \"$(rpm -qa)\"   Flatpak 的亚洲字体问题 如果你遇到了游戏中无法显示亚洲字体的问题，这是因为 org.freedesktop.Platform 并没有包含合适的字体文件进去。首先尝试挂载你的本地字体：\n$ flatpak run --filesystem=~/.local/share/fonts --filesystem=~/.config/fontconfig com.valvesoftware.Steam 如果上述命令不起作用，考虑动手 hack 一下：直接将字体文件复制进 org.freedesktop.Platform 的目录下以启用字体，例如\n# replace ? with your version and hash /var/lib/flatpak/runtime/org.freedesktop.Platform/x86_64/?/?/files/etc/fonts/conf.avail /var/lib/flatpak/runtime/org.freedesktop.Platform/x86_64/?/?/files/etc/fonts/conf.d /var/lib/flatpak/runtime/org.freedesktop.Platform/x86_64/?/?/files/share/fonts SELinux policy for a systemd service Check that the script is properly labeled as bin_t\n$ sudo chcon -v -t bin_t /home/kurome/.opt/clash/clash_premium FILTER RULES ~/.opt/rsync/backup-home:\n+ /.config/ + /.config/autostart/*** + /.config/fontconfig/*** + /.config/google-chrome/*** + /.config/ibus/*** + /.config/obsidian/*** + /.config/Typora/*** + /Documents/*** + /.goldendict/*** + /.local/ + /.local/bin/*** + /.local/share + /.local/share/applications/*** + /.local/share/icons/*** + /.local/share/TelegramDesktop/*** + /Music/*** + /.opt/*** + /.ssh/*** + /Templates/*** - /**   Using Rsync filter to include/exclude files\nthis won’t work:\n+ /some/path/this-file-will-not-be-found + /file-is-included - * this set of rules works fine:\n+ /some/ + /some/path/ + /some/path/this-file-is-found + /file-also-included - *   exclude all directories except a few\n$ cat filter.txt + /include_this_dir/ + /include_this_dir/** + /include_that_dir/ + /include_that_dir/** - /** $ rsync -av --dry-run --filter=\"merge filter.txt\" source_dir/ dest_dir/ You can reduce it further with three “*”, like + /include_this_dir/***, which means + /include_this_dir/ + /include_this_dir/**\n  ~/.local/bin/backup-home:\n#!/bin/bash  set -o errexit set -o nounset set -o pipefail readonly SOURCE_DIR=/home/kurome/ readonly BACKUP_DIR=\"$(findmnt -nr -o target -S /dev/mapper/luks-5277e33d-604f-4c1e-bc8c-40c14544614e)/Backup/HomeData\" readonly DATETIME=\"$(date '+%Y-%m-%d_%H:%M:%S')\" readonly BACKUP_PATH=\"${BACKUP_DIR}/${DATETIME}\" readonly LATEST_LINK=\"${BACKUP_DIR}/latest\" rsync -av \\ \t--delete \"${SOURCE_DIR}/\" \\ \t--link-dest \"${LATEST_LINK}\" \\ \t--filter=\"merge /home/kurome/.opt/rsync/backup-home\" \\ \t\"${BACKUP_PATH}\" rm -rf \"${LATEST_LINK}\" ln -s \"${BACKUP_PATH}\" \"${LATEST_LINK}\" Fedora Questions Cannot open acess to console, the root account is locked… 先是添加一个 LV 到 /etc/fstab，结果开机报错，原因是写错了：\nTime out ...Dependency failed for ... 结束后就 Cannot open acess to console, the root account is locked，什么也干不了，只能强制关机。\n解决方案是重启进入 Fedora Live CD，挂载 root，修改 /etc/fstab。但是无法挂载，挂载的是 Fedora Live CD 的 root，我 TM 佛了，原因应该是这两个名一模一样，Live CD 覆盖了 root。最后是用 Ubntu Live CD 解决。\n这告诉我们，不要只有一个 Live CD。这还告诉我们，先找自己的原因才能有耐心去解决问题。\ndmesg-x86/cpu: SGX disabled by BIOS SGX技术的分析和研究\nsnd_hda_codec_hdmi hdaudioC0D2: Monitor plugged-in, Failed to power up codec ret=[-13] set Kernel parameters，要使改变在重启后仍生效，您可以手动编辑 /boot/grub/grub.cfg。对于初学者，建议编辑 /etc/default/grub 并将您的内核选项添加至 GRUB_CMDLINE_LINUX_DEFAULT 行：\nGRUB_CMDLINE_LINUX_DEFAULT=\"snd_hda_codec_hdmi.enable_silent_stream=0\" 然后重新生成 grub.cfg 文件：\n# grub2grub-mkconfig2 -o /boot/grub2/grub.cfg 为什么 Linus Torvalds 用 Fedora  2008：linus对发行版的要求是\"易安装，比较贴近上游\"即可（滚动+少折腾”）。 2010年的时候，他指出了Fedora 14的一个bug。 2011年Fedora 15换Gnome3作为默认DE了，Linus直言\"unholy mess\" ，然后转投XFCE。 2011年末，Linus提出并修补了openSUSE中Xorg的一个严重bug。 2013年5月：Linus尝试将自己手头的MacBook Air装上Linux，把几个大的发行版全部都试了一遍。发现只有Fedora能正常工作。 之后的所有消息就是各种fedora了  代理后为什么 ping 不通 问题：\n设置了http_proxy和https_proxy在.bashrc文件里，firefox可以上网了。ping外网能够解析域名，但ping不通\n解答：\n首先提一个问题，为什么我们要用代理服务器上网？\n那是因为如果不用代理服务器，我们访问的website 被blocked，最简单的方式就是在一个大型防火墙上执行： deny website IP。\n而使用代理服务器，无非是用代理服务器的IP作为目的IP，把用户的HTTP、HTTPS封装在TCP上，这样途径防火墙时，由于目的IP不在blocked IP 之列，所以被放行，这样我们就可以浏览一些被blocked 的网页。\n但是一般代理服务器并不为UDP/ICMP服务，最多为TCP服务，所以你ping website 时，代理服务器并没有介入，因为Ping是ICMP报文，那就意味着你的ping包的目的IP就是被blocked IP地址，很显然无法正常通过，全被丢了。\nFedora安装Chrome后显示“您的浏览器由所属组织管理” I finally got a chance to look into this today, and I don’t think it’s as alarming as this BZ makes it sound. Yes, Chrome (over-)states that it is “Managed by your organization”. Clicking on that links to https://support.google.com/chrome/answer/9281740 which lists the things a managed system can do. However, if you read just a few sentences further, it tells you how to view exactly which settings your administrator has enabled, which in turn has links to the descriptions of what those features are. As clearly linked there, the only settings we’ve enabled is “This browser can negotiate authentication with *.fedoraproject.org”.\nSo, I’m inclined to say that while the initial reading page might lead a user to be slightly concerned, I don’t feel that the situation is particularly dire. They can always just read content in the links.\nIn the worst case, if someone really doesn’t want to have that message appear, they can just dnf remove fedora-chromium-config.\nfedora-chromium-config\nThis package is used to install customizations for Chromium/Chrome that are recommended by Fedora, including a user-agent string identifying the system as Fedora.\nIt includes a GSSAPI configuration that enables access to many Fedora Project services. To add support for other domains, replace the symlink /etc/chromium/policies/managed/00_gssapi.json with your own content. (upstream)\ndifference between docker attach and docker exec There was a commit PR which added to the doc:\n Note: This command (attach) is not for running a new process in a container. See: docker exec.\n The answer to “Docker. How to get bash\\ssh inside runned container (run -d)?” illustrates the difference:\n (docker = 1.3) If we use docker attach, we can use only one instance of shell. So if we want to open new terminal with new instance of container’s shell, we just need to run docker exec\nif the docker container was started using /bin/bash command, you can access it using attach, if not then you need to execute the command to create a bash instance inside the container using exec.\n As mentioned in this issue:\n  Attach isn’t for running an extra thing in a container, it’s for attaching to the running process. “docker exec” is specifically for running new things in a already started container, be it a shell or some other process.   The same issue adds:\n While attach is not well named, particularly because of the LXC command lxc-attach (which is more akin docker exec  /bin/sh, but LXC specific), it does have a specific purpose of literally attaching you to the process Docker started. Depending on what the process is the behavior may be different, for instance attaching to /bin/bash will give you a shell, but attaching to redis-server will be like you’d just started redis directly without daemonizing.\n Error syncing passwords  Error: MergeDataAndStartSyncing@../../components/password_manager/core/browser/sync/password_syncable_service.cc:190, datatype error was encountered: Failed to get passwords from store.\n The problem was solved by deleting ‘Login Data’ and ‘Login Data-journal’ in the profile.\n$ rm -rf ~/.config/google-chrome/Default/Login\\ Data* The  part can be found in the Profile Path on the chrome://version page.\nGnome Boxes with ssh GNOME Boxes does not expose guests to SSH into. You are expected to have SPICE guest additions installed on the guest to be able:\n to copy and paste text with a shared clipboard between the host and the guest and to drag and drop files into the guest.  This approach is supposed to be intuitively comprehensible for unsophisticated users.\nWhere do packages installed with DNF get stored? With APT (Ubuntu), downloaded packages are stored at: /var/cache/apt/archives\nDNF stores downloaded packages and metadata in /var/cache/dnf, in various per-repository subdirectories.\nHow do I scan for viruses with ClamAV? RHEL RHEL Developer Subscription Need to log in to download RHEL.\n下载的时候会断，有时候甚至下载到 99% 都会断，所以最好是用专门的、支持断点续传的软件（如 aria2）下载。同时最好不要关闭浏览器，特别是保留redhat官网登录状态，如果关闭了就需要重新登录，根本没有保存登录状态选项。\n怎样使用 Red Hat Subscription Manager (RHSM) 将系统注册到红帽客户门户网站？\n# subscription-manager register --username  --password  --auto-attach 注意！是用户名而不是邮箱！\n配置 Red Hat Enterprise Linux 8 中基本系统设置的指南\nEPEL \u0026 RPMFusion EPEL的全称叫 Extra Packages for Enterprise Linux 。EPEL是由 Fedora 社区打造，为 RHEL 及衍生发行版如 CentOS、Scientific Linux 等提供高质量软件包的项目。装上了 EPEL之后，就相当于添加了一个第三方源。\n# subscription-manager repos --enable codeready-builder-for-rhel-9-$(arch)-rpms # dnf install https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm 如果你知道rpmfusion.org的话，拿 rpmfusion 做比较还是很恰当的，rpmfusion 主要为桌面发行版提供大量rpm包（只有开源驱动才能进官方源，想要闭源驱动装rpmfusion），而EPEL则为服务器版本提供大量的rpm包，而且大多数rpm包在官方 repository 中是找不到的。\n继上面安装 epel 后安装 RPMFusion：\n# dnf install --nogpgcheck https://mirrors.rpmfusion.org/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm https://mirrors.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-$(rpm -E %rhel).noarch.rpm 使用 BFSU MIRROR\n$ sudo dnf install --nogpgcheck https://mirrors.bfsu.edu.cn/rpmfusion/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm https://mirrors.bfsu.edu.cn/rpmfusion/nonfree/el/rpmfusion-nonfree-release-$(rpm -E %rhel).noarch.rpm -y 注意：RHEL、CentOS 及替代（Rocky、AlmaLinux、OracleLinux）等服务器版本，很多常见桌面应用是没有在源里面提供的（不论时官方源还是额外的第三方源），因此需要手动管理了。\nRemi’s RPM repository 这个存储库的目标是什么？\n 向Fedora和Enterprise Linux（RHEL、CentOS、Oracle、Scientific Linux，…）用户提供 最新版本的**PHP**堆栈、全功能和一些其他软件。它主要包含：\n 我也在 Fedora 中维护的包 Fedora 开发版中可用的软件包的反向移植 一些与 Fedora 政策不兼容的软件包 在提交到 Fedora 存储库之前正在处理的一些包 （几乎）香草版本  这与 Enterprise Linux的向后移植修复策略相去甚远。\n GetPageSpeed RHEL Packages Repository We have by far the largest RPM repository with dynamic stable NGINX modules and VMODs for Varnish 4.1 and 6.0 LTS. If you want to install nginx, Varnish and lots of useful modules for them, this is your one stop repository to get all performance related software.\nELRepo Project The ELRepo Project focuses on hardware related packages to enhance your experience with Enterprise Linux. This includes filesystem drivers, graphics drivers, network drivers, sound drivers, webcam and video drivers.\nHTML5/MP4 videos Install EPEL and RPMFusion.\nThen yum install ffmpeg and you should be all set. The way Firefox works with this is it links to the avcodec/avformat (one of those two) libraries at launch, and those are provided by the ffmpeg project. ffmpeg in turn will grab the necessary codecs’ libraries it was compiled with (x264, vp9, x265, etc) and install them on your system.\nKdump Kdump是一种基于kexec的Linux内核崩溃捕获机制，简单来说系统启动时会预留一块内存，当系统崩溃调用命令kexec(kdump kernel)在预留的内存中启动kdump内核，该内核会将此时内存中的所有运行状态和数据信息收集到一个coredump文件中以便后续分析调试。\nQemu on rhel The main QEMU executable is now /usr/libexec/qemu-kvm\nVNC applications Some Free/Libre software supporting VNC/RFB protocol or Remote Desktop Protocol (RDP):\n noVNC (GitHub) is a browser-based app supporting many VNC features but no RDP. rdesktop (GitHub) FreeRDP (GitHub) Fork of rdesktop to clean the code, support Seamless Windows (RDP6)… Remmina (GitHub) Based on FreeRDP replaced tsclient as Ubuntu’s default RD client (2011) Vinagre Default GNOME VNC client supporting RDP since 2012 Ulteo Open Virtual Desktop (guide to get source code)  VirtualBox has a built-in vRDP protocol that can be used to access GNU/Linux remote desktops (Linux distro usually lacks a RDP server). The vRDP protocol is compatible with all RDP clients. However, the proprietary VirtualBox Extension Pack is required.\nSee also this good comparison of remote desktop software (Wikipedia).\nTechRadar has also published an interesting article on this purpose:\n Best Linux remote desktop clients: Top 5 RDC in 2018 By Mayank Sharma, January 2018 We cover all the ins-and-outs of remote viewing\nRemote control features\n TigerVNC 3/5 RealVNC 4/5 Top Remmina 4/5 Top Vinagre 3/5 TightVNC 3/5  Multimedia performance\n TigerVNC 4/5 Top RealVNC 4/5 Top Remmina 3/5 Vinagre 4/5 Top TightVNC 2/5  Interface and usability\n TigerVNC 3/5 RealVNC 3/5 Remmina 3/5 Vinagre 3/5 TightVNC 3/5  Documentation and support\n TigerVNC 2/5 RealVNC 5/5 Top Remmina 3/5 Vinagre 2/5 TightVNC 2/5  Server and protocol support\n TigerVNC 2/5 RealVNC 4/5 Top Remmina 3/5 Vinagre 3/5 TightVNC 1/5  Configurable parameters\n TigerVNC 2/5 RealVNC 4/5 Top Remmina 3/5 Vinagre 2/5 TightVNC 2/5  Connection flexibility\n TigerVNC 4/5 Top RealVNC 3/5 Remmina 4/5 Top Vinagre 2/5 TightVNC 4/5 Top  Final verdict\n TigerVNC 5/5 Open source credentials and performance RealVNC 4/5 Remote desktop access on the Raspberry Pi Remmina 3/5 Multi-protocol remote desktop client Vinagre 3/5 Lacks the control offered by its peers TightVNC 2/5 Focus on Windows platforms   Rocky NJU Mirror $ sed -e 's|^mirrorlist=|#mirrorlist=|g' \\  -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.nju.edu.cn/rocky|g' \\  -i.bak \\  /etc/yum.repos.d/Rocky-*.repo $ dnf makecache EPEL 首先从CentOS Extras这个源（本镜像站也有镜像）里安装epel-release：\nyum install epel-release 修改/etc/yum.repos.d/epel.repo，将mirrorlist和metalink开头的行注释掉。\n接下来，取消注释这个文件里baseurl开头的行，并将其中的http://download.fedoraproject.org/pub替换成https://mirrors.bfsu.edu.cn。\n可以用如下命令自动替换：（来自 https://github.com/tuna/issues/issues/687）\n$ sed -e 's!^metalink=!#metalink=!g' \\  -e 's!^#baseurl=!baseurl=!g' \\  -e 's!//download\\.fedoraproject\\.org/pub!//mirrors.bfsu.edu.cn!g' \\  -e 's!//download\\.example/pub!//mirrors.bfsu.edu.cn!g' \\  -e 's!http://mirrors!https://mirrors!g' \\  -i /etc/yum.repos.d/epel*.repo CentOS 关于多线程 概述 每个正在系统上运行的程序都是一个进程。每个进程包含一到N个线程。进程也可能是整个程序或者是部分程序的动态执行。线程是一组指令的集合，或者是程序的特殊段，它可以在程序里独立执行。也可以把它理解为代码运行的上下文。所以线程基本上是轻量级的进程，它负责在单个程序里执行多任务。通常由操作系统负责多个线程的调度和执行。线程是程序中一个单一的顺序控制流程。在单个程序中同时运行多个线程完成不同的工作,称为多线程。\n线程和进程的区别在于,子进程和父进程有不同的代码和数据空间,而多个线程则共享数据空间,每个线程有自己的执行堆栈和程序计数器为其执行上下文.多线程主要是为了节约CPU时间,发挥利用,根据具体情况而定. 线程的运行中需要使用计算机的内存资源和CPU。\n同步多线程（SMT）是一种在一个CPU 的时钟周期内能够执行来自多个线程的指令的硬件多线程技术。本质上，同步多线程是一种将线程级并行处理（多CPU）转化为指令级并行处理（同一CPU）的方法。 同步多线程是单个物理处理器从多个硬件线程上下文同时分派指令的能力。同步多线程用于在商用环境中及为周期/指令（CPI）计数较高的工作负载创造性能优势。 处理器采用超标量结构，最适于以并行方式读取及运行指令。同步多线程使您可在同一处理器上同时调度两个应用程序，从而利用处理器的超标量结构性质。\n超线程（HT, Hyper-Threading）是英特尔研发的一种技术，于2002年发布。通过此技术，英特尔实现在一个实体CPU中，提供两个逻辑线程。\n其实可以将SMT和HT理解为一个技术。\n Hyper-threading (officially called Hyper- ThreadingTechnology or HT Technology, and abbreviated as HTT orHT) is Intel’s proprietary simultaneous multithreading (SMT) implementation used to improve parallelization ofcomputations (doing multiple tasks at once) performed onx86 microprocessors.\n来自 https://cn.bing.com/search?q=intel+ht\u0026go=%E6%8F%90%E4%BA%A4\u0026qs=ds\u0026form=QBLHCN\n 与多进程的区别  “进程——资源分配的最小单位，线程——程序执行的最小单位”\n 实际应用中基本上都是“进程+线程”的结合方式，千万不要真的陷入一种非此即彼的误区。\n   对比维度 多进程 多线程 总结     数据共享、同步 数据共享复杂，需要用IPC；数据是分开的，同步简单 因为共享进程数据，数据共享简单，但也是因为这个原因导致同步复杂 各有优势   内存、CPU 占用内存多，切换复杂，CPU利用率低 占用内存少，切换简单，CPU利用率高 线程占优   创建销毁、切换 创建销毁、切换复杂，速度慢 创建销毁、切换简单，速度很快 线程占优   编程、调试 编程简单，调试简单 编程复杂，调试复杂 进程占优   可靠性 进程间不会互相影响 一个线程挂掉将导致整个进程挂掉 进程占优   分布式 适应于多核、多机分布式；如果一台机器不够，扩展到多台机器比较简单 适应于多核分布式 进程占优     需要注意：   1）需要频繁创建销毁的优先用线程\n2）需要进行大量计算的优先使用线程\n3）强相关的处理用线程，弱相关的处理用进程\n一般的Server需要完成如下任务：消息收发、消息处理。“消息收发”和“消息处理”就是弱相关的任务，而“消息处理”里面可能又分为“消息解码”、“业务处理”，这两个任务相对来说相关性就要强多了。因此“消息收发”和“消息处理”可以分进程设计，“消息解码”、“业务处理”可以分线程设计。当然这种划分方式不是一成不变的，也可以根据实际情况进行调整。\n4）可能要扩展到多机分布的用进程，多核分布的用线程\n5）都满足需求的情况下，用你最熟悉、最拿手的方式\n来自 https://blog.csdn.net/lishenglong666/article/details/8557215\n 如何使用？ 需要CPU、BIOS、操作系统、应用软件都支持多线程技术才可以。\n支持多线程的CPU Power CPU 支持的SMT技术：\n Simultaneous multithreading (SMT) is a processor technology that allows multiple instruction streams (threads) to run concurrently on the same physical processor, improving overall throughput. To the operating system, each hardware thread is treated as an independent logical processor. Single-threaded (ST) execution mode is also supported.\n来自 https://www.ibm.com/support/knowledgecenter/SSFHY8_6.2/reference/am5gr_f0106.html?view=embed\n Intel CPU 支持的HT技术：\n Intel® Hyper-Threading Technology (Intel® HT Technology) uses processor resources more efficiently, enabling multiple threads to run on each core. As a performance feature, it also increases processor throughput, improving overall performance on threaded software. Intel® HT Technology is available on the latest Intel® Core™ vPro™ processors, the Intel® Core™ processor family, the Intel® Core™ M processor family, and the Intel® Xeon® processor family. By combining one of these Intel® processors and chipsets with an operating system and BIOS supporting Intel® HT Technology.\n来自 https://www.intel.com/content/www/us/en/architecture-and-technology/hyper-threading/hyper-threading-technology.html\n SMT/HT支持情况  Intel CPU : 2 Thread/Core Power9 CPU： 8 Thread /Core Sparc: 8 Thread /Core  RHEL7/CentOS7 \u0026 Intel CPU BIOS 中修改SMT/HT 的设置，使用这种方式Enable或者Disable后，将永久生效，需要重启。\nHyper-Threading Technology BIOS Setup Options For Intel® Desktop/Server Boards setup option location is the main menu of the BIOS setup program. • Located on the same menu screen that already had Processor Type, Processor Speed, System Bus Speed, and other related processor fields. • Setup Option Text ○ The field is called Hyper-Threading Technology. • Setup Option Values ○ The setup option values are Enabled and Disabled. • Setup Option Help Text 来自  RHEL/CentOS操作系统中查看多线程情况：（更多信息：https://access.redhat.com/solutions/rhel-smt）\n# lscpu | grep -e Socket -e Core -e Thread Thread(s) per core: 2 # 线程数 Core(s) per socket: 6 # core 数量 Socket(s): 2 或者\n# grep -H . /sys/devices/system/cpu/cpu*/topology/thread_siblings_list | sort -n -t ':' -k 2 -u # 显示 /sys/devices/system/cpu/cpu0/topology/thread_siblings_list:0 # 表示HT关闭 # 显示 /sys/devices/system/cpu/cpu0/topology/thread_siblings_list:0-1 # 表示 HT 启用 操作系统层关闭多线程有几种办法：\n 方法一：使用nosmt启动参数，需要新的x86 CPU，需要重启  # grubby --args=nosmt --update-kernel=DEFAULT # grub2-mkconfig -o /boot/grub/grub.conf # 创建新的grub.conf # reboot #重启  方法二：临时关闭，重启后失效  # echo off  /sys/devices/system/cpu/smt/control /sys/devices/system/cpu/smt/control: This file allows to read out the SMT control state and provides the ability to disable or (re)enable SMT. The possible states are: ============== =================================================== on SMT is supported by the CPU and enabled. All logical CPUs can be onlined and offlined without restrictions. off SMT is supported by the CPU and disabled. Only the so called primary SMT threads can be onlined and offlined without restrictions. An attempt to online a non-primary sibling is rejected forceoff Same as 'off' but the state cannot be controlled. Attempts to write to the control file are rejected. notsupported The processor does not support SMT. It's therefore not affected by the SMT implications of L1TF. Attempts to write to the control file are rejected. ============== =================================================== The possible states which can be written into this file to control SMT state are: - on - off - forceoff /sys/devices/system/cpu/smt/active: This file reports whether SMT is enabled and active, i.e. if on any physical core two or more sibling threads are online. AIX \u0026 Power Power9 CPU默认支持8线程，使用smtctl命令可以查看和修改 smt级别。更多内容查看https://www.ibm.com/support/knowledgecenter/ssw_aix_72/com.ibm.aix.cmds5/smtctl.htm\n 查看 SMT level  smtctl  临时修改 SMT level, # 可以是 1, 2, 4 or 8，重启后将恢复原来的smt level  smtctl -t 2 -w now  修改 SMT level永久生效，# 可以是 1, 2, 4 or 8，完成后需要使用bosboot创建启动设备   smtctl -t 4 -w boot bosboot -a # Creates complete boot image and device. RHEL7 \u0026 Power OpenPower CPU 默认支持4线程，安装RHEL后可以使用开源的工具 ppc64_cpu进行查看和修改多线程（更多查看 https://github.com/ibm-power-utilities/powerpc-utils）。\nppc64_cpu --------- This allows users to set the smt state, smt-snooze-delay and other settings on ppc64 processors. It also allows users to control the number of processor cores which are online (not in the sleep state). 来自  1，查看 SMT level\nppc64_cpu --smt 2，修改 SMT 级别， # is 1, 2, 4 or on\nppc64_cpu --smt=# 3， 关闭 smt支持\nppc64_cpu --smt=off 其他 oracle数据库 Oracle Database 在12c之前windows平台下支持多线程，Unix和Linux只支持多进程模式。在Oracle Database 12c中，Oracle引入了多线程模式，允许在Windows平台之外的Unix、Linux系统使用多线程模式，结合多进程与多线程模式，Oracle可以改进进程管理与性能。\n通过设置初始化参数threaded_execution，可以启用或关闭多线程模式，该参数缺省值为False，设置为TRUE启用12c的这个新特性：\nSQL show parameter threaded_exec NAME TYPE VALUE --- threaded_execution boolean FALSE SQL alter system set threaded_execution=true scope=spfile; System altered. 该参数重新启动数据库后生效，但是注意，多线程模式，不支持操作系统认证，不能直接启动数据库，需要提供SYS的密码认证后方能启动数据库：\nSQL shutdown immediate; SQL startup ORA-01017: invalid username/password; logon denied # 需要通过用户名和密码登录数据库。 用ps -ef 检查一下进程/线程：\n[oracle@enmocoredb dbs]$ ps -ef|grep ora_ oracle 27404 1 0 17:00 ? 00:00:00 ora_pmon_core oracle 27406 1 0 17:00 ? 00:00:00 ora_psp0_core oracle 27408 1 3 17:00 ? 00:00:05 ora_vktm_core oracle 27412 1 0 17:00 ? 00:00:00 ora_u004_core oracle 27418 1 0 17:00 ? 00:00:00 ora_u005_core oracle 27424 1 0 17:00 ? 00:00:00 ora_dbw0_core 其中U进程是共享线程的\"容器进程\"，每个进程可以容纳100个线程。 来自 https://www.eygle.com/archives/2013/07/oracle_database_12c_multithreaded_model.html 连接热点   打开WIFI\nifconfig interface up   查看所有可用的无线网络信号\niw wlp2s0 scan | grep SSID   连接无线网\nwpa_supplicant -B -i wlp2s0 -c (wpa_passphrase \"SSID\" \"passwd\")   分配IP地址\ndhclient interface   查看无线网卡地址信息，有ip地址表示网络连接成功\nifconfig interface   PPPOE （ADSL）拨号上网   安装拨号软件\ndnf install rp-pppoe* ppp*   设定\npppoe-setup   拨号上网\npppoe-stoppppoe-start   安装中文输入法   安装 fcitx\ndnf install fcitx-im fcitx-configtool fcitx-googlepinyin   配置\n$ nano ~/.xprofile # or ~/.bashrc export GTK_MODULE=fcitx export QT_IM_MODULE=fcitx export XMODIFIERS=\"@im=fcitx\"   fcitx 没图标：重装fcitx，在fcitx配置里关掉Kimpanel\n  关闭触摸板 $ dnf install xorg-x11-apps synclient TouchpadOff=1 # 关闭 synclient TouchpadOff=0 # 开启 用 MTP 挂载手机   安装jmtpfs\ndnf install jmtpfs   查看手机 “busnum”和“devnum”\njmptfs -l   建立挂载点\nmkdir /media/dir   挂载手机\njmtpfs -device=busnum,devnum /media/dir/   查找依赖 $ yum whatprovide package $ dnf provides package 默认字体 CentOS 默认字体目录 /lib/kbd/consolefonts\n纯命令行是不能使用系统之外的字体的。\nCentOS Minimal + Xfce base 源与 epel 源，使用用阿里镜像: https://developer.aliyun.com/mirror/\n  安装Xfce4，先安装 Xfce 可以保证不安装多余的包\ndnf group listdnf groupinstall Xfce   安装 X Window system\ndnf groupinstall \"X Window system\"   验证\nsystemctl isolate graphical.target   设置\n# 设置成命令模式systemctl set-default multi-user.target # 设置成图形模式systemctl set-default graphical.target    安装中文字体和中文输入法楷体字体\ndnf install cjkuni-ukai-fonts   输入法需要安装如下包：\n ibus， 这个包里有ibus-daemon这个平台服务器程序和ibus这个配置助手。 ibus-libpinyin， 这个是ibus平台下具体的拼音输入法。 im-chooser,这个是输入法平台选择助手程序。 执行im-chooser，选择输入法平台和输入法。重新登录系统。    xfce 主题\n 网站：xfce-look.org 主题目录： /usr/share/themes 或 ~/.themes 图标鼠标目录： /usr/share/icons 或 ~/.icons 壁纸： /usr/share/background , /usr/share/wallpapers Plank    SELinux SELinux 初探 從進入了 CentOS 5.x 之後的 CentOS 版本中 (當然包括 CentOS 7)，SELinux 已經是個非常完備的核心模組了！尤其 CentOS 提供了很多管理 SELinux 的指令與機制， 因此在整體架構上面是單純且容易操作管理的！所以，在沒有自行開發網路服務軟體以及使用其他第三方協力軟體的情況下， 也就是全部使用 CentOS 官方提供的軟體來使用我們伺服器的情況下，建議大家不要關閉 SELinux 了喔！ 讓我們來仔細的玩玩這傢伙吧！\n什麼是 SELinux 什麼是 SELinux 呢？其實他是『 Security Enhanced Linux 』的縮寫，字面上的意義就是安全強化的 Linux 之意！那麼所謂的『安全強化』是強化哪個部分？ 是網路資安還是權限管理？底下就讓我們來談談吧！\n當初設計的目標：避免資源的誤用 SELinux 是由美國國家安全局 (NSA) 開發的，當初開發這玩意兒的目的是因為很多企業界發現， 通常系統出現問題的原因大部分都在於『內部員工的資源誤用』所導致的，實際由外部發動的攻擊反而沒有這麼嚴重。 那麼什麼是『員工資源誤用』呢？舉例來說，如果有個不是很懂系統的系統管理員為了自己設定的方便，將網頁所在目錄 /var/www/html/ 的權限設定為 drwxrwxrwx 時，你覺得會有什麼事情發生？\n現在我們知道所有的系統資源都是透過程序來進行存取的，那麼 /var/www/html/ 如果設定為 777 ， 代表所有程序均可對該目錄存取，萬一你真的有啟動 WWW 伺服器軟體，那麼該軟體所觸發的程序將可以寫入該目錄， 而該程序卻是對整個 Internet 提供服務的！只要有心人接觸到這支程序，而且該程序剛好又有提供使用者進行寫入的功能， 那麼外部的人很可能就會對你的系統寫入些莫名其妙的東西！那可真是不得了！一個小小的 777 問題可是大大的！\n為了控管這方面的權限與程序的問題，所以美國國家安全局就著手處理作業系統這方面的控管。 由於 Linux 是自由軟體，程式碼都是公開的，因此她們便使用 Linux 來作為研究的目標， 最後更將研究的結果整合到 Linux 核心裡面去，那就是 SELinux 啦！所以說， SELinux 是整合到核心的一個模組喔！ 更多的 SELinux 相關說明可以參考：http://www.nsa.gov/research/selinux/\n這也就是說：其實 SELinux 是在進行程序、檔案等細部權限設定依據的一個核心模組！ 由於啟動網路服務的也是程序，因此剛好也能夠控制網路服務能否存取系統資源的一道關卡！ 所以，在講到 SELinux 對系統的存取控制之前，我們得先來回顧一下之前談到的系統檔案權限與使用者之間的關係。 因為先談完這個你才會知道為何需要 SELinux 的啦！\n傳統的檔案權限與帳號關係：自主式存取控制, DAC 我們通过Linux 帳號管理與 ACL 權限設定的內容，知道系統的帳號主要分為系統管理員 (root) 與一般用戶，而這兩種身份能否使用系統上面的檔案資源則與 rwx 的權限設定有關。 不過你要注意的是，各種權限設定對 root 是無效的。因此，當某個程序想要對檔案進行存取時， 系統就會根據該程序的擁有者/群組，並比對檔案的權限，若通過權限檢查，就可以存取該檔案了。\n這種存取檔案系統的方式被稱為『自主式存取控制 (Discretionary Access Control, DAC)』，基本上，就是依據程序的擁有者與檔案資源的 rwx 權限來決定有無存取的能力。 不過這種 DAC 的存取控制有幾個困擾，那就是：\n root 具有最高的權限：如果不小心某支程序被有心人士取得， 且該程序屬於 root 的權限，那麼這支程序就可以在系統上進行任何資源的存取！真是要命！ 使用者可以取得程序來變更檔案資源的存取權限：如果你不小心將某個目錄的權限設定為 777 ，由於對任何人的權限會變成 rwx ，因此該目錄就會被任何人所任意存取！  這些問題是非常嚴重的！尤其是當你的系統是被某些漫不經心的系統管理員所掌控時！他們甚至覺得目錄權限調為 777 也沒有什麼了不起的危險哩…\n以政策規則訂定特定程序讀取特定檔案：委任式存取控制, MAC 現在我們知道 DAC 的困擾就是當使用者取得程序後，他可以藉由這支程序與自己預設的權限來處理他自己的檔案資源。 萬一這個使用者對 Linux 系統不熟，那就很可能會有資源誤用的問題產生。為了避免 DAC 容易發生的問題，因此 SELinux 導入了委任式存取控制 (Mandatory Access Control, MAC) 的方法！\n委任式存取控制 (MAC) 有趣啦！他可以針對特定的程序與特定的檔案資源來進行權限的控管！ 也就是說，即使你是 root ，那麼在使用不同的程序時，你所能取得的權限並不一定是 root ， 而得要看當時該程序的設定而定。如此一來，我們針對控制的『主體』變成了『程序』而不是使用者喔！ 此外，這個主體程序也不能任意使用系統檔案資源，因為每個檔案資源也有針對該主體程序設定可取用的權限！ 如此一來，控制項目就細的多了！但整個系統程序那麼多、檔案那麼多，一項一項控制可就沒完沒了！ 所以 SELinux 也提供一些預設的政策 (Policy) ，並在該政策內提供多個規則 (rule) ，讓你可以選擇是否啟用該控制規則！\n在委任式存取控制的設定下，我們的程序能夠活動的空間就變小了！舉例來說， WWW 伺服器軟體的達成程序為 httpd 這支程式， 而預設情況下， httpd 僅能在 /var/www/ 這個目錄底下存取檔案，如果 httpd 這個程序想要到其他目錄去存取資料時， 除了規則設定要開放外，目標目錄也得要設定成 httpd 可讀取的模式 (type) 才行喔！限制非常多！ 所以，即使不小心 httpd 被 cracker 取得了控制權，他也無權瀏覽 /etc/shadow 等重要的設定檔喔！\n簡單的來說，針對 Apache 這個 WWW 網路服務使用 DAC 或 MAC 的結果來說，兩者間的關係可以使用下圖來說明。 底下這個圖示取自 Red Hat 訓練教材，真的是很不錯～所以被鳥哥借用來說明一下！\n左圖是沒有 SELinux 的 DAC 存取結果，apache 這隻 root 所主導的程序，可以在這三個目錄內作任何檔案的新建與修改～ 相當麻煩～右邊則是加上 SELinux 的 MAC 管理的結果，SELinux 僅會針對 Apache 這個『 process 』放行部份的目錄， 其他的非正規目錄就不會放行給 Apache 使用！因此不管你是誰，就是不能穿透 MAC 的框框！這樣有比較了解乎？\nSELinux 的運作模式 再次的重複說明一下，SELinux 是透過 MAC 的方式來控管程序，他控制的主體是程序， 而目標則是該程序能否讀取的『檔案資源』！所以先來說明一下這些咚咚的相關性啦！\n  主體 (Subject)： SELinux 主要想要管理的就是程序，因此你可以將『主體』跟本章談到的 process 劃上等號；\n  目標 (Object)： 主體程序能否存取的『目標資源』一般就是檔案系統。因此這個目標項目可以等檔案系統劃上等號；\n  政策 (Policy)：\n由於程序與檔案數量龐大，因此 SELinux 會依據某些服務來制訂基本的存取安全性政策。這些政策內還會有詳細的規則 (rule) 來指定不同的服務開放某些資源的存取與否。在目前的 CentOS 7.x 裡面僅有提供三個主要的政策，分別是：\n targeted：針對網路服務限制較多，針對本機限制較少，是預設的政策； minimum：由 target 修訂而來，僅針對選擇的程序來保護！ mls：完整的 SELinux 限制，限制方面較為嚴格。  建議使用預設的 targeted 政策即可。\n  安全性本文 (security context)： 我們剛剛談到了主體、目標與政策面，但是主體能不能存取目標除了政策指定之外，主體與目標的安全性本文必須一致才能夠順利存取。 這個安全性本文 (security context) 有點類似檔案系統的 rwx 啦！安全性本文的內容與設定是非常重要的！ 如果設定錯誤，你的某些服務(主體程序)就無法存取檔案系統(目標資源)，當然就會一直出現『權限不符』的錯誤訊息了！\n  由於 SELinux 重點在保護程序讀取檔案系統的權限，因此我們將上述的幾個說明搭配起來，繪製成底下的流程圖，比較好理解：\n上圖的重點在『主體』如何取得『目標』的資源存取權限！ 由上圖我們可以發現，(1)主體程序必須要通過 SELinux 政策內的規則放行後，就可以與目標資源進行安全性本文的比對， (2)若比對失敗則無法存取目標，若比對成功則可以開始存取目標。問題是，最終能否存取目標還是與檔案系統的 rwx 權限設定有關喔！如此一來，加入了 SELinux 之後，出現權限不符的情況時，你就得要一步一步的分析可能的問題了！\n安全性本文 (Security Context) CentOS 7.x 的 target 政策已經幫我們制訂好非常多的規則了，因此你只要知道如何開啟/關閉某項規則的放行與否即可。 那個安全性本文比較麻煩！因為你可能需要自行設定檔案的安全性本文呢！為何需要自行設定啊？ 舉例來說，你不也常常進行檔案的 rwx 的重新設定嗎？這個安全性本文你就將他想成 SELinux 內必備的 rwx 就是了！這樣比較好理解啦。\n安全性本文存在於主體程序中與目標檔案資源中。程序在記憶體內，所以安全性本文可以存入是沒問題。 那檔案的安全性本文是記錄在哪裡呢？事實上，安全性本文是放置到檔案的 inode 內的，因此主體程序想要讀取目標檔案資源時，同樣需要讀取 inode ， 在 inode 內就可以比對安全性本文以及 rwx 等權限值是否正確，而給予適當的讀取權限依據。\n那麼安全性本文到底是什麼樣的存在呢？我們先來看看 /root 底下的檔案的安全性本文好了。 觀察安全性本文可使用『 ls -Z 』去觀察如下：(注意：你必須已經啟動了 SELinux 才行！若尚未啟動，這部份請稍微看過一遍即可。底下會介紹如何啟動 SELinux 喔！)\n# 先來觀察一下 root 家目錄底下的『檔案的 SELinux 相關資訊』 [root@study ~]# ls -Z -rw-------. root root system_u:object_r:admin_home_t:s0 anaconda-ks.cfg -rw-r--r--. root root system_u:object_r:admin_home_t:s0 initial-setup-ks.cfg -rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 regular_express.txt # 上述特殊字體的部分，就是安全性本文的內容！鳥哥僅列出數個預設的檔案而已， # 本書學習過程中所寫下的檔案則沒有列在上頭喔！ 如上所示，安全性本文主要用冒號分為三個欄位，這三個欄位的意義為：\nIdentify:role:type 身份識別:角色:類型 這三個欄位的意義仔細的說明一下吧：\n  身份識別 (Identify)：\n相當於帳號方面的身份識別！主要的身份識別常見有底下幾種常見的類型：\n  unconfined_u：不受限的用戶，也就是說，該檔案來自於不受限的程序所產生的！一般來說，我們使用可登入帳號來取得 bash 之後， 預設的 bash 環境是不受 SELinux 管制的～因為 bash 並不是什麼特別的網路服務！因此，在這個不受 SELinux 所限制的 bash 程序所產生的檔案， 其身份識別大多就是 unconfined_u 這個『不受限』用戶囉！\n  system_u：系統用戶，大部分就是系統自己產生的檔案囉！\n  基本上，如果是系統或軟體本身所提供的檔案，大多就是 system_u 這個身份名稱，而如果是我們用戶透過 bash 自己建立的檔案，大多則是不受限的 unconfined_u 身份～如果是網路服務所產生的檔案，或者是系統服務運作過程產生的檔案，則大部分的識別就會是 system_u 囉！\n因為鳥哥這邊教大家使用文字界面來產生許多的資料，因此你看上面的三個檔案中，系統安裝主動產生的 anaconda-ks.cfs 及 initial-setup-ks.cfg 就會是 system_u，而我們自己從網路上面抓下來的 regular_express.txt 就會是 unconfined_u 這個識別啊！\n  角色 (Role)：\n透過角色欄位，我們可以知道這個資料是屬於程序、檔案資源還是代表使用者。一般的角色有：\n  object_r：代表的是檔案或目錄等檔案資源，這應該是最常見的囉；\n  system_r：代表的就是程序啦！不過，一般使用者也會被指定成為 system_r 喔！\n  你也會發現角色的欄位最後面使用『 _r 』來結尾！因為是 role 的意思嘛！\n  類型 (Type) (最重要！)：\n在預設的 targeted 政策中， Identify 與 Role 欄位基本上是不重要的！重要的在於這個類型 (type) 欄位！ 基本上，一個主體程序能不能讀取到這個檔案資源，與類型欄位有關！而類型欄位在檔案與程序的定義不太相同，分別是：\n  type：在檔案資源 (Object) 上面稱為類型 (Type)；\n  domain：在主體程序 (Subject) 則稱為領域 (domain) 了！\n  domain 需要與 type 搭配，則該程序才能夠順利的讀取檔案資源啦！\n  程序與檔案 SELinux type 欄位的相關性 那麼這三個欄位如何利用呢？首先我們來瞧瞧主體程序在這三個欄位的意義為何！透過身份識別與角色欄位的定義， 我們可以約略知道某個程序所代表的意義喔！先來動手瞧一瞧目前系統中的程序在 SELinux 底下的安全本文為何？\n# 再來觀察一下系統『程序的 SELinux 相關資訊』 [root@study ~]# ps -eZ LABEL PID TTY TIME CMD system_u:system_r:init_t:s0 1 ? 00:00:03 systemd system_u:system_r:kernel_t:s0 2 ? 00:00:00 kthreadd system_u:system_r:kernel_t:s0 3 ? 00:00:00 ksoftirqd/0 .....(中間省略)..... unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 31513 ? 00:00:00 sshd unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 31535 pts/0 00:00:00 bash # 基本上程序主要就分為兩大類，一種是系統有受限的 system_u:system_r，另一種則可能是用戶自己的， # 比較不受限的程序 (通常是本機用戶自己執行的程式)，亦即是 unconfined_u:unconfined_r 這兩種！ 基本上，這些對應資料在 targeted 政策下的對應如下：\n   身份識別 角色 該對應在 targeted 的意義     unconfined_u unconfined_r 一般可登入使用者的程序囉！比較沒有受限的程序之意！大多數都是用戶已經順利登入系統 (不論是網路還是本機登入來取得可用的 shell) 後， 所用來操作系統的程序！如 bash, X window 相關軟體等。   system_u system_r 由於為系統帳號，因此是非交談式的系統運作程序，大多數的系統程序均是這種類型！    但就如上所述，在預設的 target 政策下，其實最重要的欄位是類型欄位 (type)， 主體與目標之間是否具有可以讀寫的權限，與程序的 domain 及檔案的 type 有關！這兩者的關係我們可以使用 crond 以及他的設定檔來說明！ 亦即是 /usr/sbin/crond, /etc/crontab, /etc/cron.d 等檔案來說明。 首先，看看這幾個咚咚的安全性本文內容先：\n# 1. 先看看 crond 這個『程序』的安全本文內容： [root@study ~]# ps -eZ | grep cron system_u:system_r:crond_t:s0-s0:c0.c1023 1338 ? 00:00:01 crond system_u:system_r:crond_t:s0-s0:c0.c1023 1340 ? 00:00:00 atd # 這個安全本文的類型名稱為 crond_t 格式！ # 2. 再來瞧瞧執行檔、設定檔等等的安全本文內容為何！ [root@study ~]# ll -Zd /usr/sbin/crond /etc/crontab /etc/cron.d drwxr-xr-x. root root system_u:object_r:system_cron_spool_t:s0 /etc/cron.d -rw-r--r--. root root system_u:object_r:system_cron_spool_t:s0 /etc/crontab -rwxr-xr-x. root root system_u:object_r:crond_exec_t:s0 /usr/sbin/crond 當我們執行 /usr/sbin/crond 之後，這個程式變成的程序的 domain 類型會是 crond_t 這一個～而這個 crond_t 能夠讀取的設定檔則為 system_cron_spool_t 這種的類型。因此不論 /etc/crontab, /etc/cron.d 以及 /var/spool/cron 都會是相關的 SELinux 類型 (/var/spool/cron 為 user_cron_spool_t)。 文字看起來不太容易了解，我們使用圖示來說明這幾個東西的關係！\n上圖的意義我們可以這樣看的：\n 首先，我們觸發一個可執行的目標檔案，那就是具有 crond_exec_t 這個類型的 /usr/sbin/crond 檔案； 該檔案的類型會讓這個檔案所造成的主體程序 (Subject) 具有 crond 這個領域 (domain)， 我們的政策針對這個領域已經制定了許多規則，其中包括這個領域可以讀取的目標資源類型； 由於 crond domain 被設定為可以讀取 system_cron_spool_t 這個類型的目標檔案 (Object)， 因此你的設定檔放到 /etc/cron.d/ 目錄下，就能夠被 crond 那支程序所讀取了； 但最終能不能讀到正確的資料，還得要看 rwx 是否符合 Linux 權限的規範！  上述的流程告訴我們幾個重點，第一個是政策內需要制訂詳細的 domain/type 相關性；第二個是若檔案的 type 設定錯誤， 那麼即使權限設定為 rwx 全開的 777 ，該主體程序也無法讀取目標檔案資源的啦！不過如此一來， 也就可以避免使用者將他的家目錄設定為 777 時所造成的權限困擾。\n真的是這樣嗎？沒關係～讓我們來做個測試練習吧！就是，萬一你的 crond 設定檔的 SELinux 並不是 system_cron_spool_t 時， 該設定檔真的可以順利的被讀取運作嗎？來看看底下的範例！\n# 1. 先假設你因為不熟的緣故，因此是在『root 家目錄』建立一個如下的 cron 設定： [root@study ~]# vim checktime 10 * * * * root sleep 60s # 2. 檢查後才發現檔案放錯目錄了，又不想要保留副本，因此使用 mv 移動到正確目錄： [root@study ~]# mv checktime /etc/cron.d [root@study ~]# ll /etc/cron.d/checktime -rw-r--r--. 1 root root 27 Aug 7 18:41 /etc/cron.d/checktime # 仔細看喔，權限是 644 ，確定沒有問題！任何程序都能夠讀取喔！ # 3. 強制重新啟動 crond ，然後偷看一下登錄檔，看看有沒有問題發生！ [root@study ~]# systemctl restart crond [root@study ~]# tail /var/log/cron Aug 7 18:46:01 study crond[28174]: ((null)) Unauthorized SELinux context=system_u:system_r: system_cronjob_t:s0-s0:c0.c1023 file_context=unconfined_u:object_r:admin_home_t:s0 (/etc/cron.d/checktime) Aug 7 18:46:01 study crond[28174]: (root) FAILED (loading cron table) # 上面的意思是，有錯誤！因為原本的安全本文與檔案的實際安全本文無法搭配的緣故！ 您瞧瞧～從上面的測試案例來看，我們的設定檔確實沒有辦法被 crond 這個服務所讀取喔！而原因在登錄檔內就有說明， 主要就是來自 SELinux 安全本文 (context) type 的不同所致喔！沒辦法讀就沒辦法讀，先放著～後面再來學怎麼處理這問題吧！\nSELinux 三種模式的啟動、關閉與觀察 並非所有的 Linux distributions 都支援 SELinux 的，所以你必須要先觀察一下你的系統版本為何！ 鳥哥這裡介紹的 CentOS 7.x 本身就有支援 SELinux 啦！所以你不需要自行編譯 SELinux 到你的 Linux 核心中！ 目前 SELinux 依據啟動與否，共有三種模式，分別如下：\n enforcing：強制模式，代表 SELinux 運作中，且已經正確的開始限制 domain/type 了； permissive：寬容模式：代表 SELinux 運作中，不過僅會有警告訊息並不會實際限制 domain/type 的存取。這種模式可以運來作為 SELinux 的 debug 之用； disabled：關閉，SELinux 並沒有實際運作。  我們前面不是談過主體程序需要經過政策規則、安全本文比對之後，加上 rwx 的權限規範， 若一切合理才會讓程序順利的讀取檔案嗎？那麼這個 SELinux 的三種模式與上面談到的政策規則、安全本文的關係為何呢？我們還是使用圖示加上流程來讓大家理解一下：\n就如上圖所示，首先，你得要知道，並不是所有的程序都會被 SELinux 所管制，因此最左邊會出現一個所謂的『有受限的程序主體』！那如何觀察有沒有受限 (confined )呢？ 很簡單啊！就透過 ps -eZ 去擷取！舉例來說，我們來找一找 crond 與 bash 這兩隻程序是否有被限制吧？\n[root@study ~]# ps -eZ | grep -E 'cron|bash' system_u:system_r:crond_t:s0-s0:c0.c1023 1340 ? 00:00:00 atd unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 13888 tty2 00:00:00 bash unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 28054 pts/0 00:00:00 bash unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 28094 pts/0 00:00:00 bash system_u:system_r:crond_t:s0-s0:c0.c1023 28174 ? 00:00:00 crond 如前所述，因為在目前 target 這個政策底下，只有第三個類型 (type) 欄位會有影響，因此我們上表僅列出第三個欄位的資料而已。 我們可以看到， crond 確實是有受限的主體程序，而 bash 因為是本機程序，因此就是不受限 (unconfined_t) 的類型！也就是說， bash 是不需要經過上圖的流程，而是直接去判斷 rwx 而已～。\n了解了受限的主體程序的意義之後，再來了解一下，三種模式的運作吧！首先，如果是 Disabled 的模式，那麼 SELinux 將不會運作，當然受限的程序也不會經過 SELinux ， 也是直接去判斷 rwx 而已。那如果是寬容 (permissive) 模式呢？這種模式也是不會將主體程序抵擋 (所以箭頭是可以直接穿透的喔！)，不過萬一沒有通過政策規則，或者是安全本文的比對時， 那麼該讀寫動作將會被紀錄起來 (log)，可作為未來檢查問題的判斷依據。\n至於最終那個 Enforcing 模式，就是實際將受限主體進入規則比對、安全本文比對的流程，若失敗，就直接抵擋主體程序的讀寫行為，並且將他記錄下來。 如果通通沒問題，這才進入到 rwx 權限的判斷喔！這樣可以理解三種模式的行為了嗎？\n那你怎麼知道目前的 SELinux 模式呢？就透過 getenforce 吧！\n[root@study ~]# getenforce Enforcing ==諾！就顯示出目前的模式為 Enforcing 囉！ 另外，我們又如何知道 SELinux 的政策 (Policy) 為何呢？這時可以使用 sestatus 來觀察：\n[root@study ~]# sestatus [-vb] 選項與參數： -v ：檢查列於 /etc/sestatus.conf 內的檔案與程序的安全性本文內容； -b ：將目前政策的規則布林值列出，亦即某些規則 (rule) 是否要啟動 (0/1) 之意； 範例一：列出目前的 SELinux 使用哪個政策 (Policy)？ [root@study ~]# sestatus SELinux status: enabled ==是否啟動 SELinux SELinuxfs mount: /sys/fs/selinux ==SELinux 的相關檔案資料掛載點 SELinux root directory: /etc/selinux ==SELinux 的根目錄所在 Loaded policy name: targeted ==目前的政策為何？ Current mode: enforcing ==目前的模式 Mode from config file: enforcing ==目前設定檔內規範的 SELinux 模式 Policy MLS status: enabled ==是否含有 MLS 的模式機制 Policy deny_unknown status: allowed ==是否預設抵擋未知的主體程序 Max kernel policy version: 28 如上所示，目前是啟動的，而且是 Enforcing 模式，而由設定檔查詢得知亦為 Enforcing 模式。 此外，目前的預設政策為 targeted 這一個。你應該要有疑問的是， SELinux 的設定檔是哪個檔案啊？ 其實就是 /etc/selinux/config 這個檔案喔！我們來看看內容：\n[root@study ~]# vim /etc/selinux/config SELINUX=enforcing ==調整 enforcing|disabled|permissive SELINUXTYPE=targeted ==目前僅有 targeted, mls, minimum 三種政策 若有需要修改預設政策的話，就直接改 SELINUX=enforcing 那一行即可喔！\nSELinux 的啟動與關閉 上面是預設的政策與啟動的模式！你要注意的是，如果改變了政策則需要重新開機；如果由 enforcing 或 permissive 改成 disabled ，或由 disabled 改成其他兩個，那也必須要重新開機。這是因為 SELinux 是整合到核心裡面去的， 你只可以在 SELinux 運作下切換成為強制 (enforcing) 或寬容 (permissive) 模式，不能夠直接關閉 SELinux 的！ 如果剛剛你發現 getenforce 出現 disabled 時，請到上述檔案修改成為 enforcing 然後重新開機吧！\n不過你要注意的是，如果從 disable 轉到啟動 SELinux 的模式時， 由於系統必須要針對檔案寫入安全性本文的資訊，因此開機過程會花費不少時間在等待重新寫入 SELinux 安全性本文 (有時也稱為 SELinux Label) ，而且在寫完之後還得要再次的重新開機一次喔！你必須要等待粉長一段時間！ 等到下次開機成功後，再使用 getenforce 或 sestatus 來觀察看看有否成功的啟動到 Enforcing 的模式囉！\n如果你已經在 Enforcing 的模式，但是可能由於一些設定的問題導致 SELinux 讓某些服務無法正常的運作， 此時你可以將 Enforcing 的模式改為寬容 (permissive) 的模式，讓 SELinux 只會警告無法順利連線的訊息， 而不是直接抵擋主體程序的讀取權限。讓 SELinux 模式在 enforcing 與 permissive 之間切換的方法為：\n[root@study ~]# setenforce [0|1] 選項與參數： 0 ：轉成 permissive 寬容模式； 1 ：轉成 Enforcing 強制模式 範例一：將 SELinux 在 Enforcing 與 permissive 之間切換與觀察 [root@study ~]# setenforce 0 [root@study ~]# getenforce Permissive [root@study ~]# setenforce 1 [root@study ~]# getenforce Enforcing 不過請注意， setenforce 無法在 Disabled 的模式底下進行模式的切換喔！\nTips：在某些特殊的情況底下，你從 Disabled 切換成 Enforcing 之後，竟然有一堆服務無法順利啟動，都會跟你說在 /lib/xxx 裡面的資料沒有權限讀取，所以啟動失敗。這大多是由於在重新寫入 SELinux type (Relabel) 出錯之故，使用 Permissive 就沒有這個錯誤。那如何處理呢？最簡單的方法就是在 Permissive 的狀態下，使用『 restorecon -Rv / 』重新還原所有 SELinux 的類型，就能夠處理這個錯誤！\nSELinux 政策內的規則管理 我們知道 SELinux 的三種模式是會影響到主體程序的放行與否。 如果是進入 Enforcing 模式，那麼接著下來會影響到主體程序的，當然就是第二關：『 target 政策內的各項規則 (rules) 』了！ 好了，那麼我們怎麼知道目前這個政策裡面到底有多少會影響到主體程序的規則呢？很簡單，就透過 getsebool 來瞧一瞧即可。\n SELinux 各個規則的布林值查詢 getsebool  如果想要查詢系統上面全部規則的啟動與否 (on/off，亦即布林值)，很簡單的透過 sestatus -b 或 getsebool -a 均可！\n[root@study ~]# getsebool [-a] [規則的名稱] 選項與參數： -a ：列出目前系統上面的所有 SELinux 規則的布林值為開啟或關閉值 範例一：查詢本系統內所有的布林值設定狀況 [root@study ~]# getsebool -a abrt_anon_write -- off abrt_handle_event -- off ....(中間省略).... cron_can_relabel -- off # 這個跟 cornd 比較有關！ cron_userdomain_transition -- on ....(中間省略).... httpd_enable_homedirs -- off # 這當然就是跟網頁，亦即 http 有關的囉！ ....(底下省略).... # 這麼多的 SELinux 規則喔！每個規則後面都列出現在是允許放行還是不許放行的布林值喔！  SELinux 各個規則規範的主體程序能夠讀取的檔案 SELinux type 查詢 seinfo, sesearch  我們現在知道有這麼多的 SELinux 規則，但是每個規則內到底是在限制什麼東西？如果你想要知道的話，那就得要使用 seinfo 等工具！ 這些工具並沒有在我們安裝時就安裝了，因此請拿出原版光碟，放到光碟機，鳥哥假設你將原版光碟掛載到 /mnt 底下，那麼接下來這麼作， 先安裝好我們所需要的軟體才行！\n[root@study ~]# yum install /mnt/Packages/setools-console-* 很快的安裝完畢之後，我們就可以來使用 seinfo, sesearch 等指令了！\n[root@study ~]# seinfo [-trub] 選項與參數： --all ：列出 SELinux 的狀態、規則布林值、身份識別、角色、類別等所有資訊 -u ：列出 SELinux 的所有身份識別 (user) 種類 -r ：列出 SELinux 的所有角色 (role) 種類 -t ：列出 SELinux 的所有類別 (type) 種類 -b ：列出所有規則的種類 (布林值) 範例一：列出 SELinux 在此政策下的統計狀態 [root@study ~]# seinfo Statistics for policy file: /sys/fs/selinux/policy Policy Version \u0026 Type: v.28 (binary, mls) Classes: 83 Permissions: 255 Sensitivities: 1 Categories: 1024 Types: 4620 Attributes: 357 Users: 8 Roles: 14 Booleans: 295 Cond. Expr.: 346 Allow: 102249 Neverallow: 0 Auditallow: 160 Dontaudit: 8413 Type_trans: 16863 Type_change: 74 Type_member: 35 Role allow: 30 Role_trans: 412 Range_trans: 5439 ....(底下省略).... # 從上面我們可以看到這個政策是 targeted ，此政策的安全本文類別有 4620 個； # 而各種 SELinux 的規則 (Booleans) 共制訂了 295 條！ 我們前面簡單的談到了幾個身份識別 (user) 以及角色 (role) 而已，如果你想要查詢目前所有的身份識別與角色，就使用『 seinfo -u 』及『 seinfo -r 』就可以知道了！至於簡單的統計資料，就直接輸入 seinfo 即可！但是上面還是沒有談到規則相關的東西耶～ 沒關係～一個一個來～我們在 16.5.1 的最後面談到 /etc/cron.d/checktime 的 SELinux type 類型不太對～那我們也知道 crond 這個程序的 type 是 crond_t ， 能不能找一下 crond_t 能夠讀取的檔案 SELinux type 有哪些呢？\n[root@study ~]# sesearch [-A] [-s 主體類別] [-t 目標類別] [-b 布林值] 選項與參數： -A ：列出後面資料中，允許『讀取或放行』的相關資料 -t ：後面還要接類別，例如 -t httpd_t -b ：後面還要接SELinux的規則，例如 -b httpd_enable_ftp_server 範例一：找出 crond_t 這個主體程序能夠讀取的檔案 SELinux type [root@study ~]# sesearch -A -s crond_t | grep spool allow crond_t system_cron_spool_t : file { ioctl read write create getattr .. allow crond_t system_cron_spool_t : dir { ioctl read getattr lock search op.. allow crond_t user_cron_spool_t : file { ioctl read write create getattr se.. allow crond_t user_cron_spool_t : dir { ioctl read write getattr lock add_n.. allow crond_t user_cron_spool_t : lnk_file { read getattr } ; # allow 後面接主體程序以及檔案的 SELinux type，上面的資料是擷取出來的， # 意思是說，crond_t 可以讀取 system_cron_spool_t 的檔案/目錄類型～等等！ 範例二：找出 crond_t 是否能夠讀取 /etc/cron.d/checktime 這個我們自訂的設定檔？ [root@study ~]# ll -Z /etc/cron.d/checktime -rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 /etc/cron.d/checktime # 兩個重點，一個是 SELinux type 為 admin_home_t，一個是檔案 (file) [root@study ~]# sesearch -A -s crond_t | grep admin_home_t allow domain admin_home_t : dir { getattr search open } ; allow domain admin_home_t : lnk_file { read getattr } ; allow crond_t admin_home_t : dir { ioctl read getattr lock search open } ; allow crond_t admin_home_t : lnk_file { read getattr } ; # 仔細看！看仔細～雖然有 crond_t admin_home_t 存在，但是這是總體的資訊， # 並沒有針對某些規則的尋找～所以還是不確定 checktime 能否被讀取。但是，基本上就是 SELinux # type 出問題～因此才會無法讀取的！ 所以，現在我們知道 /etc/cron.d/checktime 這個我們自己複製過去的檔案會沒有辦法被讀取的原因，就是因為 SELinux type 錯誤啦！ 根本就無法被讀取～好～那現在我們來查一查，那 getsebool -a 裡面看到的 httpd_enable_homedirs 到底是什麼？又是規範了哪些主體程序能夠讀取的 SELinux type 呢？\n[root@study ~]# semanage boolean -l | grep httpd_enable_homedirs SELinux boolean State Default Description httpd_enable_homedirs (off , off) Allow httpd to enable homedirs # httpd_enable_homedirs 的功能是允許 httpd 程序去讀取使用者家目錄的意思～ [root@study ~]# sesearch -A -b httpd_enable_homedirs 範例三：列出 httpd_enable_homedirs 這個規則當中，主體程序能夠讀取的檔案 SELinux type Found 43 semantic av rules: allow httpd_t home_root_t : dir { ioctl read getattr lock search open } ; allow httpd_t home_root_t : lnk_file { read getattr } ; allow httpd_t user_home_type : dir { getattr search open } ; allow httpd_t user_home_type : lnk_file { read getattr } ; ....(後面省略).... # 從上面的資料才可以理解，在這個規則中，主要是放行 httpd_t 能否讀取使用者家目錄的檔案！ # 所以，如果這個規則沒有啟動，基本上， httpd_t 這種程序就無法讀取使用者家目錄下的檔案！  修改 SELinux 規則的布林值 setsebool  那麼如果查詢到某個 SELinux rule，並且以 sesearch 知道該規則的用途後，想要關閉或啟動他，又該如何處置？\n[root@study ~]# setsebool [-P] 『規則名稱』 [0|1] 選項與參數： -P ：直接將設定值寫入設定檔，該設定資料未來會生效的！ 範例一：查詢 httpd_enable_homedirs 這個規則的狀態，並且修改這個規則成為不同的布林值 [root@study ~]# getsebool httpd_enable_homedirs httpd_enable_homedirs -- off ==結果是 off ，依題意給他啟動看看！ [root@study ~]# setsebool -P httpd_enable_homedirs 1 # 會跑很久很久！請耐心等待！ [root@study ~]# getsebool httpd_enable_homedirs httpd_enable_homedirs -- on 這個 setsebool 最好記得一定要加上 -P 的選項！因為這樣才能將此設定寫入設定檔！ 這是非常棒的工具組！你一定要知道如何使用 getsebool 與 setsebool 才行！\nSELinux 安全本文的修改 現在我們知道 SELinux 對受限的主體程序有沒有影響，第一關考慮 SELinux 的三種類型，第二關考慮 SELinux 的政策規則是否放行，第三關則是開始比對 SELinux type 啦！從剛剛我們也知道可以透過 sesearch 來找到主體程序與檔案的 SELinux type 關係！ 好，現在總算要來修改檔案的 SELinux type，以讓主體程序能夠讀到正確的檔案啊！這時就得要幾個重要的小東西了～來瞧瞧～\n使用 chcon 手動修改檔案的 SELinux type [root@study ~]# chcon [-R] [-t type] [-u user] [-r role] 檔案 [root@study ~]# chcon [-R] --reference=範例檔 檔案 選項與參數： -R ：連同該目錄下的次目錄也同時修改； -t ：後面接安全性本文的類型欄位！例如 httpd_sys_content_t ； -u ：後面接身份識別，例如 system_u； (不重要) -r ：後面接角色，例如 system_r； (不重要) -v ：若有變化成功，請將變動的結果列出來 --reference=範例檔：拿某個檔案當範例來修改後續接的檔案的類型！ 範例一：查詢一下 /etc/hosts 的 SELinux type，並將該類型套用到 /etc/cron.d/checktime 上 [root@study ~]# ll -Z /etc/hosts -rw-r--r--. root root system_u:object_r:net_conf_t:s0 /etc/hosts [root@study ~]# chcon -v -t net_conf_t /etc/cron.d/checktime changing security context of ‘/etc/cron.d/checktime’ [root@study ~]# ll -Z /etc/cron.d/checktime -rw-r--r--. root root unconfined_u:object_r:net_conf_t:s0 /etc/cron.d/checktime 範例二：直接以 /etc/shadow SELinux type 套用到 /etc/cron.d/checktime 上！ [root@study ~]# chcon -v --reference=/etc/shadow /etc/cron.d/checktime [root@study ~]# ll -Z /etc/shadow /etc/cron.d/checktime -rw-r--r--. root root system_u:object_r:shadow_t:s0 /etc/cron.d/checktime ----------. root root system_u:object_r:shadow_t:s0 /etc/shadow 上面的練習『都沒有正確的解答！』因為正確的 SELinux type 應該就是要以 /etc/cron.d/ 底下的檔案為標準來處理才對啊～ 好了～既然如此～能不能讓 SELinux 自己解決預設目錄下的 SELinux type 呢？可以！就用 restorecon 吧！\n使用 restorecon 讓檔案恢復正確的 SELinux type [root@study ~]# restorecon [-Rv] 檔案或目錄 選項與參數： -R ：連同次目錄一起修改； -v ：將過程顯示到螢幕上 範例三：將 /etc/cron.d/ 底下的檔案通通恢復成預設的 SELinux type！ [root@study ~]# restorecon -Rv /etc/cron.d restorecon reset /etc/cron.d/checktime context system_u:object_r:shadow_t:s0- system_u:object_r:system_cron_spool_t:s0 # 上面這兩行其實是同一行喔！表示將 checktime 由 shadow_t 改為 system_cron_spool_t 範例四：重新啟動 crond 看看有沒有正確啟動 checktime 囉！？ [root@study ~]# systemctl restart crond [root@study ~]# tail /var/log/cron # 再去瞧瞧這個 /var/log/cron 的內容，應該就沒有錯誤訊息了 其實，鳥哥幾乎已經忘了 chcon 這個指令了！因為 restorecon 主動的回復預設的 SELinux type 要簡單很多！而且可以一口氣恢復整個目錄下的檔案！ 所以，鳥哥建議你幾乎只要記得 restorecon 搭配 -Rv 同時加上某個目錄這樣的指令串即可～修改 SELinux 的 type 就變得非常的輕鬆囉！\nsemanage 預設目錄的安全性本文查詢與修改 你應該要覺得奇怪，為什麼 restorecon 可以『恢復』原本的 SELinux type 呢？那肯定就是有個地方在紀錄每個檔案/目錄的 SELinux 預設類型囉？ 沒錯！是這樣～那要如何 (1)查詢預設的 SELinux type 以及 (2)如何增加/修改/刪除預設的 SELinux type 呢？很簡單～透過 semanage 即可！他是這樣使用的：\n[root@study ~]# semanage {login|user|port|interface|fcontext|translation} -l [root@study ~]# semanage fcontext -{a|d|m} [-frst] file_spec 選項與參數： fcontext ：主要用在安全性本文方面的用途， -l 為查詢的意思； -a ：增加的意思，你可以增加一些目錄的預設安全性本文類型設定； -m ：修改的意思； -d ：刪除的意思。 範例一：查詢一下 /etc /etc/cron.d 的預設 SELinux type 為何？ [root@study ~]# semanage fcontext -l | grep -E '^/etc |^/etc/cron' SELinux fcontext type Context /etc all files system_u:object_r:etc_t:s0 /etc/cron\\.d(/.*)? all files system_u:object_r:system_cron_spool_t:s0 看到上面輸出的最後一行，那也是為啥我們直接使用 vim 去 /etc/cron.d 底下建立新檔案時，預設的 SELinux type 就是正確的！ 同時，我們也會知道使用 restorecon 回復正確的 SELinux type 時，系統會去判斷預設的類型為何的依據。現在讓我們來想一想， 如果 (當然是假的！不可能這麼幹) 我們要建立一個 /srv/mycron 的目錄，這個目錄預設也是需要變成 system_cron_spool_t 時， 我們應該要如何處理呢？基本上可以這樣作：\n# 1. 先建立 /srv/mycron 同時在內部放入設定檔，同時觀察 SELinux type [root@study ~]# mkdir /srv/mycron [root@study ~]# cp /etc/cron.d/checktime /srv/mycron [root@study ~]# ll -dZ /srv/mycron /srv/mycron/checktime drwxr-xr-x. root root unconfined_u:object_r:var_t:s0 /srv/mycron -rw-r--r--. root root unconfined_u:object_r:var_t:s0 /srv/mycron/checktime # 2. 觀察一下上層 /srv 的 SELinux type [root@study ~]# semanage fcontext -l | grep '^/srv' SELinux fcontext type Context /srv all files system_u:object_r:var_t:s0 # 怪不得 mycron 會是 var_t 囉！ # 3. 將 mycron 預設值改為 system_cron_spool_t 囉！ [root@study ~]# semanage fcontext -a -t system_cron_spool_t \"/srv/mycron(/.*)?\" [root@study ~]# semanage fcontext -l | grep '^/srv/mycron' SELinux fcontext type Context /srv/mycron(/.*)? all files system_u:object_r:system_cron_spool_t:s0 # 4. 恢復 /srv/mycron 以及子目錄相關的 SELinux type 喔！ [root@study ~]# restorecon -Rv /srv/mycron [root@study ~]# ll -dZ /srv/mycron /srv/mycron/* drwxr-xr-x. root root unconfined_u:object_r:system_cron_spool_t:s0 /srv/mycron -rw-r--r--. root root unconfined_u:object_r:system_cron_spool_t:s0 /srv/mycron/checktime # 有了預設值，未來就不會不小心被亂改了！這樣比較妥當些～ semanage 的功能很多，不過鳥哥主要用到的僅有 fcontext 這個項目的動作而已。如上所示， 你可以使用 semanage 來查詢所有的目錄預設值，也能夠使用他來增加預設值的設定！如果您學會這些基礎的工具， 那麼 SELinux 對你來說，也不是什麼太難的咚咚囉！\n一個網路服務案例及登錄檔協助 本章在 SELinux 小節當中談到的各個指令中，尤其是 setsebool, chcon, restorecon 等，都是為了當你的某些網路服務無法正常提供相關功能時， 才需要進行修改的一些指令動作。但是，我們怎麼知道哪個時候才需要進行這些指令的修改啊？我們怎麼知道系統因為 SELinux 的問題導致網路服務不對勁啊？如果都要靠用戶端連線失敗才來哭訴，那也太沒有效率了！所以，我們的 CentOS 7.x 有提供幾支偵測的服務在登錄 SELinux 產生的錯誤喔！那就是 auditd 與 setroubleshootd。\n setroubleshoot – 錯誤訊息寫入 /var/log/messages  幾乎所有 SELinux 相關的程式都會以 se 為開頭，這個服務也是以 se 為開頭！而 troubleshoot 大家都知道是錯誤克服，因此這個 setroubleshoot 自然就得要啟動他啦！這個服務會將關於 SELinux 的錯誤訊息與克服方法記錄到 /var/log/messages 與 /var/log/setroubleshoot/* 裡頭，所以你一定得要啟動這個服務才好。啟動這個服務之前當然就是得要安裝它啦！ 這玩意兒總共需要兩個軟體，分別是 setroublshoot 與 setroubleshoot-server，如果你沒有安裝，請自行使用 yum 安裝吧！\n此外，原本的 SELinux 資訊本來是以兩個服務來記錄的，分別是 auditd 與 setroubleshootd。既然是同樣的資訊，因此 CentOS 6.x (含 7.x) 以後將兩者整合在 auditd 當中啦！所以，並沒有 setroubleshootd 的服務存在了喔！因此，當你安裝好了 setroubleshoot-server 之後，請記得要重新啟動 auditd，否則 setroubleshootd 的功能不會被啟動的。\nTips：事實上，CentOS 7.x 對 setroubleshootd 的運作方式是： (1)先由 auditd 去呼叫 audispd 服務， (2)然後 audispd 服務去啟動 sedispatch 程式， (3)sedispatch 再將原本的 auditd 訊息轉成 setroubleshootd 的訊息，進一步儲存下來的！\n[root@study ~]# rpm -qa | grep setroubleshoot setroubleshoot-plugins-3.0.59-1.el7.noarch setroubleshoot-3.2.17-3.el7.x86_64 setroubleshoot-server-3.2.17-3.el7.x86_64 在預設的情況下，這個 setroubleshoot 應該都是會安裝的！是否正確安裝可以使用上述的表格指令去查詢。萬一沒有安裝，請使用 yum install 去安裝吧！ 再說一遍，安裝完畢最好重新啟動 auditd 這個服務喔！不過，剛剛裝好且順利啟動後， setroubleshoot 還是不會有作用，為啥？ 因為我們並沒有任何受限的網路服務主體程序在運作啊！所以，底下我們將使用一個簡單的 FTP 伺服器軟體為例，讓你了解到我們上頭講到的許多重點的應用！\n 實例狀況說明：透過 vsftpd 這個 FTP 伺服器來存取系統上的檔案  現在的年輕小伙子們傳資料都用 line, FB, dropbox, google 雲端磁碟等等，不過在網路早期傳送大容量的檔案，還是以 FTP 這個協定為主！ 現在為了速度，經常有 p2p 的軟體提供大容量檔案的傳輸，但以鳥哥這個老人家來說，可能 FTP 傳送資料還是比較有保障… 在 CentOS 7.x 的環境下，達成 FTP 的預設伺服器軟體主要是 vsftpd 這一支喔！\n詳細的 FTP 協定我們在伺服器篇再來談，這裡只是簡單的利用 vsftpd 這個軟體與 FTP 的協定來講解 SELinux 的問題與錯誤克服而已。 不過既然要使用到 FTP 協定，一些簡單的知識還是得要存在才好！否則等一下我們沒有辦法了解為啥要這麼做！ 首先，你得要知道，用戶端需要使用『FTP 帳號登入 FTP 伺服器』才行！而有一個稱為『匿名 (anonymous) 』的帳號可以登入系統！ 但是這個匿名的帳號登入後，只能存取某一個特定的目錄，而無法脫離該目錄～！\n在 vsftpd 中，一般用戶與匿名者的家目錄說明如下：\n 匿名者：如果使用瀏覽器來連線到 FTP 伺服器的話，那預設就是使用匿名者登入系統。而匿名者的家目錄預設是在 /var/ftp 當中！ 同時，匿名者在家目錄下只能下載資料，不能上傳資料到 FTP 伺服器。同時，匿名者無法離開 FTP 伺服器的 /var/ftp 目錄喔！ 一般 FTP 帳號：在預設的情況下，所有 UID 大於 1000 的帳號，都可以使用 FTP 來登入系統！ 而登入系統之後，所有的帳號都能夠取得自己家目錄底下的檔案資料！當然預設是可以上傳、下載檔案的！  為了避免跟之前章節的用戶產生誤解的情況，這裡我們先建立一個名為 ftptest 的帳號，且帳號密碼為 myftp123， 先來建立一下吧！\n[root@study ~]# useradd -s /sbin/nologin ftptest [root@study ~]# echo \"myftp123\" | passwd --stdin ftptest 接下來當然就是安裝 vsftpd 這隻伺服器軟體，同時啟動這隻服務，另外，我們也希望未來開機都能夠啟動這隻服務！ 因此需要這樣做 (鳥哥假設你的 CentOS 7.x 的原版光碟已經掛載於 /mnt 了喔！)：\n[root@study ~]# yum install /mnt/Packages/vsftpd-3* [root@study ~]# systemctl start vsftpd [root@study ~]# systemctl enable vsftpd [root@study ~]# netstat -tlnp Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 1326/sshd tcp 0 0 127.0.0.1:25 0.0.0.0:* LISTEN 2349/master tcp6 0 0 :::21 :::* LISTEN 6256/vsftpd tcp6 0 0 :::22 :::* LISTEN 1326/sshd tcp6 0 0 ::1:25 :::* LISTEN 2349/master # 要注意看，上面的特殊字體那行有出現，才代表 vsftpd 這隻服務有啟動喔！！  匿名者無法下載的問題  現在讓我們來模擬一些 FTP 的常用狀態！假設你想要將 /etc/securetty 以及主要的 /etc/sysctl.conf 放置給所有人下載， 那麼你可能會這樣做！\n[root@study ~]# cp -a /etc/securetty /etc/sysctl.conf /var/ftp/pub [root@study ~]# ll /var/ftp/pub -rw-------. 1 root root 221 Oct 29 2014 securetty # 先假設你沒有看到這個問題！ -rw-r--r--. 1 root root 225 Mar 6 11:05 sysctl.conf 一般來說，預設要給用戶下載的 FTP 檔案會放置到上面表格當中的 /var/ftp/pub 目錄喔！現在讓我們使用簡單的終端機瀏覽器 curl 來觀察看看！ 看你能不能查詢到上述兩個檔案的內容呢？\n# 1. 先看看 FTP 根目錄底下有什麼檔案存在？ [root@study ~]# curl ftp://localhost drwxr-xr-x 2 0 0 40 Aug 08 00:51 pub # 確實有存在一個名為 pub 的檔案喔！那就是在 /var/ftp 底下的 pub 囉！ # 2. 再往下看看，能不能看到 pub 內的檔案呢？ [root@study ~]# curl ftp://localhost/pub/ # 因為是目錄，要加上 / 才好！ -rw------- 1 0 0 221 Oct 29 2014 securetty -rw-r--r-- 1 0 0 225 Mar 06 03:05 sysctl.conf # 3. 承上，繼續看一下 sysctl.conf 的內容好了！ [root@study ~]# curl ftp://localhost/pub/sysctl.conf # System default settings live in /usr/lib/sysctl.d/00-system.conf. # To override those settings, enter new settings here, or in an /etc/sysctl.d/.conf file # # For more information, see sysctl.conf(5) and sysctl.d(5). # 真的有看到這個檔案的內容喔！所以確定是可以讓 vsftpd 讀取到這檔案的！ # 4. 再來瞧瞧 securetty 好了！ [root@study ~]# curl ftp://localhost/pub/securetty curl: (78) RETR response: 550 # 看不到耶！但是，基本的原因應該是權限問題喔！因為 vsftpd 預設放在 /var/ftp/pub 內的資料， # 不論什麼 SELinux type 幾乎都可以被讀取的才對喔！所以要這樣處理！ # 5. 修訂權限之後再一次觀察 securetty 看看！ [root@study ~]# chmod a+r /var/ftp/pub/securetty [root@study ~]# curl ftp://localhost/pub/securetty # 此時你就可以看到實際的檔案內容囉！ # 6. 修訂 SELinux type 的內容 (非必備) [root@study ~]# restorecon -Rv /var/ftp 上面這個例子在告訴你，要先從權限的角度來瞧一瞧，如果無法被讀取，可能就是因為沒有 r 或沒有 rx 囉！並不一定是由 SELinux 引起的！ 了解乎？好～再來瞧瞧如果是一般帳號呢？如何登入？\n 無法從家目錄下載檔案的問題分析與解決  我們前面建立了 ftptest 帳號，那如何使用文字界面來登入呢？就使用如下的方式來處理。同時請注意，因為文字型的 FTP 用戶端軟體， 預設會將用戶丟到根目錄而不是家目錄，因此，你的 URL 可能需要修訂一下如下！\n# 0. 為了讓 curl 這個文字瀏覽器可以傳輸資料，我們先建立一些資料在 ftptest 家目錄 [root@study ~]# echo \"testing\"  ~ftptest/test.txt [root@study ~]# cp -a /etc/hosts /etc/sysctl.conf ~ftptest/ [root@study ~]# ll ~ftptest/ -rw-r--r--. 1 root root 158 Jun 7 2013 hosts -rw-r--r--. 1 root root 225 Mar 6 11:05 sysctl.conf -rw-r--r--. 1 root root 8 Aug 9 01:05 test.txt # 1. 一般帳號直接登入 FTP 伺服器，同時變換目錄到家目錄去！ [root@study ~]# curl ftp://ftptest:myftp123@localhost/~/ -rw-r--r-- 1 0 0 158 Jun 07 2013 hosts -rw-r--r-- 1 0 0 225 Mar 06 03:05 sysctl.conf -rw-r--r-- 1 0 0 8 Aug 08 17:05 test.txt # 真的有資料～看檔案最左邊的權限也是沒問題，所以，來讀一下 test.txt 的內容看看 # 2. 開始下載 test.txt, sysctl.conf 等有權限可以閱讀的檔案看看！ [root@study ~]# curl ftp://ftptest:myftp123@localhost/~/test.txt curl: (78) RETR response: 550 # 竟然說沒有權限！明明我們的 rwx 是正常沒問題！那是否有可能是 SELinux 造成的？ # 3. 先將 SELinux 從 Enforce 轉成 Permissive 看看情況！同時觀察登錄檔 [root@study ~]# setenforce 0 [root@study ~]# curl ftp://ftptest:myftp123@localhost/~/test.txt testing [root@study ~]# setenforce 1 # 確定問題後，一定要轉成 Enforcing 啊！ # 確定有資料內容！所以，確定就是 SELinux 造成無法讀取的問題～那怎辦？要改規則？還是改 type？ # 因為都不知道，所以，就檢查一下登錄檔看看有沒有相關的資訊可以提供給我們處理！ [root@study ~]# vim /var/log/messages Aug 9 02:55:58 station3-39 setroubleshoot: SELinux is preventing /usr/sbin/vsftpd from lock access on the file /home/ftptest/test.txt. For complete SELinux messages. run sealert -l 3a57aad3-a128-461b-966a-5bb2b0ffa0f9 Aug 9 02:55:58 station3-39 python: SELinux is preventing /usr/sbin/vsftpd from lock access on the file /home/ftptest/test.txt. ***** Plugin catchall_boolean (47.5 confidence) suggests ****************** If you want to allow ftp to home dir Then you must tell SELinux about this by enabling the 'ftp_home_dir' boolean. You can read 'None' man page for more details. Do setsebool -P ftp_home_dir 1 ***** Plugin catchall_boolean (47.5 confidence) suggests ****************** If you want to allow ftpd to full access Then you must tell SELinux about this by enabling the 'ftpd_full_access' boolean. You can read 'None' man page for more details. Do setsebool -P ftpd_full_access 1 ***** Plugin catchall (6.38 confidence) suggests ************************** .....(底下省略)..... # 基本上，你會看到有個特殊字體的部份，就是 sealert 那一行。雖然底下已經列出可能的解決方案了， # 就是一堆底線那些東西。至少就有三個解決方案 (最後一個沒列出來)，哪種才是正確的？ # 為了了解正確的解決方案，我們還是還執行一下 sealert 那行吧！看看情況再說！ # 4. 透過 sealert 的解決方案來處理問題 [root@study ~]# sealert -l 3a57aad3-a128-461b-966a-5bb2b0ffa0f9 SELinux is preventing /usr/sbin/vsftpd from lock access on the file /home/ftptest/test.txt. # 底下說有 47.5% 的機率是由於這個原因所發生，並且可以使用 setsebool 去解決的意思！ ***** Plugin catchall_boolean (47.5 confidence) suggests ****************** If you want to allow ftp to home dir Then you must tell SELinux about this by enabling the 'ftp_home_dir' boolean. You can read 'None' man page for more details. Do setsebool -P ftp_home_dir 1 # 底下說也是有 47.5% 的機率是由此產生的！ ***** Plugin catchall_boolean (47.5 confidence) suggests ****************** If you want to allow ftpd to full access Then you must tell SELinux about this by enabling the 'ftpd_full_access' boolean. You can read 'None' man page for more details. Do setsebool -P ftpd_full_access 1 # 底下說，僅有 6.38% 的可信度是由這個情況產生的！ ***** Plugin catchall (6.38 confidence) suggests ************************** If you believe that vsftpd should be allowed lock access on the test.txt file by default. Then you should report this as a bug. You can generate a local policy module to allow this access. Do allow this access for now by executing: # grep vsftpd /var/log/audit/audit.log | audit2allow -M mypol # semodule -i mypol.pp # 底下就重要了！是整個問題發生的主因～最好還是稍微瞧一瞧！ Additional Information: Source Context system_u:system_r:ftpd_t:s0-s0:c0.c1023 Target Context unconfined_u:object_r:user_home_t:s0 Target Objects /home/ftptest/test.txt [ file ] Source vsftpd Source Path /usr/sbin/vsftpd Port  Host station3-39.gocloud.vm Source RPM Packages vsftpd-3.0.2-9.el7.x86_64 Target RPM Packages Policy RPM selinux-policy-3.13.1-23.el7.noarch Selinux Enabled True Policy Type targeted Enforcing Mode Permissive Host Name station3-39.gocloud.vm Platform Linux station3-39.gocloud.vm 3.10.0-229.el7.x86_64 #1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64 Alert Count 3 First Seen 2015-08-09 01:00:12 CST Last Seen 2015-08-09 02:55:57 CST Local ID 3a57aad3-a128-461b-966a-5bb2b0ffa0f9 Raw Audit Messages type=AVC msg=audit(1439060157.358:635): avc: denied { lock } for pid=5029 comm=\"vsftpd\" path=\"/home/ftptest/test.txt\" dev=\"dm-2\" ino=141 scontext=system_u:system_r:ftpd_t:s0-s0: c0.c1023 tcontext=unconfined_u:object_r:user_home_t:s0 tclass=file type=SYSCALL msg=audit(1439060157.358:635): arch=x86_64 syscall=fcntl success=yes exit=0 a0=4 a1=7 a2=7fffceb8cbb0 a3=0 items=0 ppid=5024 pid=5029 auid=4294967295 uid=1001 gid=1001 euid=1001 suid=1001 fsuid=1001 egid=1001 sgid=1001 fsgid=1001 tty=(none) ses=4294967295 comm=vsftpd exe=/usr/sbin/vsftpd subj=system_u:system_r:ftpd_t:s0-s0:c0.c1023 key=(null) Hash: vsftpd,ftpd_t,user_home_t,file,lock 經過上面的測試，現在我們知道主要的問題發生在 SELinux 的 type 不是 vsftpd_t 所能讀取的原因～ 經過仔細觀察 test.txt 檔案的類型，我們知道他原本就是家目錄，因此是 user_home_t 也沒啥了不起的啊！是正確的～ 因此，分析兩個比較可信 (47.5%) 的解決方案後，可能是與 ftp_home_dir 比較有關啊！所以，我們應該不需要修改 SELinux type， 修改的應該是 SELinux rules 才對！所以，這樣做看看：\n# 1. 先確認一下 SELinux 的模式，然後再瞧一瞧能否下載 test.txt，最終使用處理方式來解決～ [root@study ~]# getenforce Enforcing [root@study ~]# curl ftp://ftptest:myftp123@localhost/~/test.txt curl: (78) RETR response: 550 # 確定還是無法讀取的喔！ [root@study ~]# setsebool -P ftp_home_dir 1 [root@study ~]# curl ftp://ftptest:myftp123@localhost/~/test.txt testing # OK！太讚了！處理完畢！現在使用者可以在自己的家目錄上傳/下載檔案了！ # 2. 開始下載其他檔案試看看囉！ [root@study ~]# curl ftp://ftptest:myftp123@localhost/~/sysctl.conf # System default settings live in /usr/lib/sysctl.d/00-system.conf. # To override those settings, enter new settings here, or in an /etc/sysctl.d/.conf file # # For more information, see sysctl.conf(5) and sysctl.d(5). 沒問題喔！透過修改 SELinux rule 的布林值，現在我們就可以使用一般帳號在 FTP 服務來上傳/下載資料囉！非常愉快吧！ 那萬一我們還有其他的目錄也想要透過 FTP 來提供這個 ftptest 用戶上傳與下載呢？往下瞧瞧～\n 一般帳號用戶從非正規目錄上傳/下載檔案  假設我們還想要提供 /srv/gogogo 這個目錄給 ftptest 用戶使用，那又該如何處理呢？假設我們都沒有考慮 SELinux ， 那就是這樣的情況：\n# 1. 先處理好所需要的目錄資料 [root@study ~]# mkdir /srv/gogogo [root@study ~]# chgrp ftptest /srv/gogogo [root@study ~]# echo \"test\"  /srv/gogogo/test.txt # 2. 開始直接使用 ftp 觀察一下資料！ [root@study ~]# curl ftp://ftptest:myftp123@localhost//srv/gogogo/test.txt curl: (78) RETR response: 550 # 有問題喔！來瞧瞧登錄檔怎麼說！ [root@study ~]# grep sealert /var/log/messages | tail Aug 9 04:23:12 station3-39 setroubleshoot: SELinux is preventing /usr/sbin/vsftpd from read access on the file test.txt. For complete SELinux messages. run sealert -l 08d3c0a2-5160-49ab-b199-47a51a5fc8dd [root@study ~]# sealert -l 08d3c0a2-5160-49ab-b199-47a51a5fc8dd SELinux is preventing /usr/sbin/vsftpd from read access on the file test.txt. # 雖然這個可信度比較高～不過，因為會全部放行 FTP ，所以不太考慮！ ***** Plugin catchall_boolean (57.6 confidence) suggests ****************** If you want to allow ftpd to full access Then you must tell SELinux about this by enabling the 'ftpd_full_access' boolean. You can read 'None' man page for more details. Do setsebool -P ftpd_full_access 1 # 因為是非正規目錄的使用，所以這邊加上預設 SELinux type 恐怕會是比較正確的選擇！ ***** Plugin catchall_labels (36.2 confidence) suggests ******************* If you want to allow vsftpd to have read access on the test.txt file Then you need to change the label on test.txt Do # semanage fcontext -a -t FILE_TYPE 'test.txt' where FILE_TYPE is one of the following: NetworkManager_tmp_t, abrt_helper_exec_t, abrt_tmp_t, abrt_upload_watch_tmp_t, abrt_var_cache_t, abrt_var_run_t, admin_crontab_tmp_t, afs_cache_t, alsa_home_t, alsa_tmp_t, amanda_tmp_t, antivirus_home_t, antivirus_tmp_t, apcupsd_tmp_t, ... Then execute: restorecon -v 'test.txt' ***** Plugin catchall (7.64 confidence) suggests ************************** If you believe that vsftpd should be allowed read access on the test.txt file by default. Then you should report this as a bug. You can generate a local policy module to allow this access. Do allow this access for now by executing: # grep vsftpd /var/log/audit/audit.log | audit2allow -M mypol # semodule -i mypol.pp Additional Information: Source Context system_u:system_r:ftpd_t:s0-s0:c0.c1023 Target Context unconfined_u:object_r:var_t:s0 Target Objects test.txt [ file ] Source vsftpd .....(底下省略)..... 因為是非正規目錄啊，所以感覺上似乎與 semanage 那一行的解決方案比較相關～接下來就是要找到 FTP 的 SELinux type 來解決囉！ 所以，讓我們查一下 FTP 相關的資料囉！\n# 3. 先查看一下 /var/ftp 這個地方的 SELinux type 吧！ [root@study ~]# ll -Zd /var/ftp drwxr-xr-x. root root system_u:object_r:public_content_t:s0 /var/ftp # 4. 以 sealert 建議的方法來處理好 SELinux type 囉！ [root@study ~]# semanage fcontext -a -t public_content_t \"/srv/gogogo(/.*)?\" [root@study ~]# restorecon -Rv /srv/gogogo [root@study ~]# curl ftp://ftptest:myftp123@localhost//srv/gogogo/test.txt test # 喔耶！終於再次搞定喔！ 在這個範例中，我們是修改了 SELinux type 喔！與前一個修改 SELinux rule 不太一樣！要理解理解喔！\n 無法變更 FTP 連線埠口問題分析與解決  在某些情況下，可能你的伺服器軟體需要開放在非正規的埠口，舉例來說，如果因為某些政策問題，導致 FTP 啟動的正常的 21 號埠口無法使用， 因此你想要啟用在 555 號埠口時，該如何處理呢？基本上，既然 SELinux 的主體程序大多是被受限的網路服務，沒道理不限制放行的埠口啊！ 所以，很可能會出問題～那就得要想想辦法才行！\n# 1. 先處理 vsftpd 的設定檔，加入換 port 的參數才行！ [root@study ~]# vim /etc/vsftpd/vsftpd.conf # 請按下大寫的 G 跑到最後一行，然後新增加底下這行設定！前面不可以留白！ listen_port=555 # 2. 重新啟動 vsftpd 並且觀察登錄檔的變化！ [root@study ~]# systemctl restart vsftpd [root@study ~]# grep sealert /var/log/messages Aug 9 06:34:46 station3-39 setroubleshoot: SELinux is preventing /usr/sbin/vsftpd from name_bind access on the tcp_socket port 555. For complete SELinux messages. run sealert -l 288118e7-c386-4086-9fed-2fe78865c704 [root@study ~]# sealert -l 288118e7-c386-4086-9fed-2fe78865c704 SELinux is preventing /usr/sbin/vsftpd from name_bind access on the tcp_socket port 555. ***** Plugin bind_ports (92.2 confidence) suggests ************************ If you want to allow /usr/sbin/vsftpd to bind to network port 555 Then you need to modify the port type. Do # semanage port -a -t PORT_TYPE -p tcp 555 where PORT_TYPE is one of the following: certmaster_port_t, cluster_port_t, ephemeral_port_t, ftp_data_port_t, ftp_port_t, hadoop_datanode_port_t, hplip_port_t, port_t, postgrey_port_t, unreserved_port_t. .....(後面省略)..... # 看一下信任度，高達 92.2% 耶！幾乎就是這傢伙～因此不必再看～就是他了！比較重要的是， # 解決方案裡面，那個 PORT_TYPE 有很多選擇～但我們是要開啟 FTP 埠口嘛！所以， # 就由後續資料找到 ftp_port_t 那個項目囉！帶入實驗看看！ # 3. 實際帶入 SELinux 埠口修訂後，在重新啟動 vsftpd 看看 [root@study ~]# semanage port -a -t ftp_port_t -p tcp 555 [root@study ~]# systemctl restart vsftpd [root@study ~]# netstat -tlnp Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 1167/sshd tcp 0 0 127.0.0.1:25 0.0.0.0:* LISTEN 1598/master tcp6 0 0 :::555 :::* LISTEN 8436/vsftpd tcp6 0 0 :::22 :::* LISTEN 1167/sshd tcp6 0 0 ::1:25 :::* LISTEN 1598/master # 4. 實驗看看這個 port 能不能用？ [root@study ~]# curl ftp://localhost:555/pub/ -rw-r--r-- 1 0 0 221 Oct 29 2014 securetty -rw-r--r-- 1 0 0 225 Mar 06 03:05 sysctl.conf 透過上面的幾個小練習，你會知道在正規或非正規的環境下，如何處理你的 SELinux 問題哩！仔細研究看看囉！\nSwap 【譯】替 swap 辯護：常見的誤解 這篇翻譯自 Chris Down 的博文 In defence of swap: common misconceptions 。\n翻譯這篇文章是因爲經常看到朋友們（包括有經驗的程序員和 Linux 管理員）對 swap 和 swappiness 有諸多誤解，而這篇文章正好澄清了這些誤解，也講清楚了 Linux 中這兩者的本質。值得一提的是本文討論的 swap 針對 Linux 內核，在別的系統包括 macOS/WinNT 或者 Unix 系統中的交換文件可能有不同一樣的行爲， 需要不同的調優方式。比如在 FreeBSD handbook 中明確建議了 swap 分區通常應該是兩倍物理內存大小，這一點建議對 FreeBSD 系內核的內存管理可能非常合理， 而不一定適合 Linux 內核，FreeBSD 和 Linux 有不同的內存管理方式尤其是 swap 和 page cache 和 buffer cache 的處理方式有諸多不同。\n經常有朋友看到系統卡頓之後看系統內存使用狀況觀察到大量 swap 佔用，於是覺得卡頓是來源於 swap 。就像文中所述，相關不蘊含因果，產生內存顛簸之後的確會造成大量 swap 佔用，也會造成系統卡頓， 但是 swap 不是導致卡頓的原因，關掉 swap 或者調低 swappiness 並不能阻止卡頓，只會將 swap 造成的 I/O 轉化爲加載文件緩存造成的 I/O 。\n以下是原文翻譯：\n 太長不看：\n 對維持系統的正常功能而言，有 swap 是相對挺重要的一部分。沒有它的話會更難做到合理的內存管理。 swap 的目的通常並不是用作緊急內存，它的目的在於讓內存回收能更平等和高效。 事實上把它當作「緊急內存」來用的想法通常是有害的。 禁用 swap 在內存壓力下並不能避免磁盤I/O造成的性能問題，這麼做只是讓磁盤I/O顛簸的範圍從 匿名頁面轉化到文件頁面。這不僅更低效，因爲系統能回收的頁面的選擇範圍更有限了， 而且這種做法還可能是加重了內存壓力的原因之一。 內核 4.0 版本之前的交換進程（swapper）有一些問題，導致很多人對 swap 有負面印象， 因爲它太急於（overeagerness）把頁面交換出去。在 4.0 之後的內核上這種情況已經改善了很多。 在 SSD 上，交換出匿名頁面的開銷和回收文件頁面的開銷基本上在性能/延遲方面沒有區別。 在老式的磁盤上，讀取交換文件因爲屬於隨機訪問讀取所以會更慢，於是設置較低的 vm.swappiness 可能比較合理（繼續讀下面關於 vm.swappiness 的描述）。 禁用 swap 並不能避免在接近 OOM 狀態下最終表現出的症狀，儘管的確有 swap 的情況下這種症狀持續的時間可能會延長。在系統調用 OOM 殺手的時候無論有沒有啓用 swap ，或者更早/更晚開始調用 OOM 殺手，結果都是一樣的：整個系統留在了一種不可預知的狀態下。 有 swap 也不能避免這一點。 可以用 cgroup v2 的 memory.low 相關機制來改善內存壓力下 swap 的行爲並且 避免發生顛簸。  我的工作的一部分是改善內核中內存管理和 cgroup v2 相關，所以我和很多工程師討論過看待內存管理的態度， 尤其是在壓力下應用程序的行爲和操作系統在底層內存管理中用的基於經驗的啓發式決策邏輯。\n在這種討論中經常重複的話題是交換區（swap）。交換區的話題是非常有爭議而且很少被理解的話題，甚至包括那些在 Linux 上工作過多年的人也是如此。很多人覺得它沒什麼用甚至是有害的：它是歷史遺蹟，從內存緊缺而 磁盤讀寫是必要之惡的時代遺留到現在，爲計算機提供在當年很必要的頁面交換功能作爲內存空間。 最近幾年我還經常能以一定頻度看到這種論調，然後我和很多同事、朋友、業界同行們討論過很多次， 幫他們理解爲什麼在現代計算機系統中交換區仍是有用的概念，即便現在的電腦中物理內存已經遠多於過去。\n圍繞交換區的目的還有很多誤解——很多人覺得它只是某種爲了應對緊急情況的「慢速額外內存」， 但是沒能理解在整個操作系統健康運作的時候它也能改善普通負載的性能。\n我們很多人也聽說過描述內存時所用的常見說法： 「 Linux 用了太多內存 」，「 swap 應該設爲物理內存的兩倍大小 」，或者類似的說法。 雖然這些誤解要麼很容易化解，或者關於他們的討論在最近幾年已經逐漸變得瑣碎，但是關於「無用」交換區 的傳言有更深的經驗傳承的根基，而不是一兩個類比就能解釋清楚的，並且要探討這個先得對內存管理有 一些基礎認知。\n本文主要目標是針對那些管理 Linux 系統並且有興趣理解「讓系統運行於低/無交換區狀態」或者「把 vm.swappiness 設爲 0 」這些做法的反論。\n背景 如果沒有基本理解 Linux 內存管理的底層機制是如何運作的，就很難討論爲什麼需要交換區以及交換出頁面 對正常運行的系統爲什麼是件好事，所以我們先確保大家有討論的基礎。\n內存的類型 Linux 中內存分爲好幾種類型，每種都有各自的屬性。想理解爲什麼交換區很重要的關鍵一點在於理解這些的細微區別。\n比如說，有種 頁面（「整塊」的內存，通常 4K） 是用來存放電腦裏每個程序運行時各自的代碼的。 也有頁面用來保存這些程序所需要讀取的文件數據和元數據的緩存，以便加速隨後的文件讀寫。 這些內存頁面構成 頁面緩存（page cache），後文中我稱他們爲文件內存。\n還有一些頁面是在代碼執行過程中做的內存分配得到的，比如說，當代碼調用 malloc 能分配到新內存區，或者使用 mmap 的 MAP_ANONYMOUS 標誌分配的內存。 這些是「匿名(anonymous)」頁面——之所以這麼稱呼它們是因爲他們沒有任何東西作後備—— 後文中我稱他們爲匿名內存。\n還有其它類型的內存——共享內存、slab內存、內核棧內存、文件緩衝區（buffers），這種的—— 但是匿名內存和文件內存是最知名也最好理解的，所以後面的例子裏我會用這兩個說明， 雖然後面的說明也同樣適用於別的這些內存類型。\n可回收/不可回收內存 考慮某種內存的類型時，一個非常基礎的問題是這種內存是否能被回收。 「回收（Reclaim）」在這裏是指系統可以，在不丟失數據的前提下，從物理內存中釋放這種內存的頁面。\n對一些內存類型而言，是否可回收通常可以直接判斷。比如對於那些乾淨（未修改）的頁面緩存內存， 我們只是爲了性能在用它們緩存一些磁盤上現有的數據，所以我們可以直接扔掉這些頁面， 不需要做什麼特殊的操作。\n對有些內存類型而言，回收是可能的，但是不是那麼直接。比如對髒（修改過）的頁面緩存內存， 我們不能直接扔掉這些頁面，因爲磁盤上還沒有寫入我們所做的修改。這種情況下，我們可以選擇拒絕回收， 或者選擇先等待我們的變更寫入磁盤之後才能扔掉這些內存。\n對還有些內存類型而言，是不能回收的。比如前面提到的匿名頁面，它們只存在於內存中，沒有任何後備存儲， 所以它們必須留在內存裏。\n說到交換區的本質 如果你去搜 Linux 上交換區的目的的描述，肯定會找到很多人說交換區只是在緊急時用來擴展物理內存的機制。 比如下面這段是我在 google 中輸入「什麼是 swap」 從前排結果中隨機找到的一篇：\n 交換區本質上是緊急內存；是爲了應對你的系統臨時所需內存多餘你現有物理內存時，專門分出一塊額外空間。 大家覺得交換區「不好」是因爲它又慢又低效，並且如果你的系統一直需要使用交換區那說明它明顯沒有足夠的內存。 ［……］如果你有足夠內存覆蓋所有你需要的情況，而且你覺得肯定不會用滿內存，那麼完全可以不用交換區 安全地運行系統。\n 事先說明，我不想因爲這些文章的內容責怪這些文章的作者——這些內容被很多 Linux 系統管理員認爲是「常識」， 並且很可能你問他們什麼是交換區的時候他們會給你這樣的回答。但是也很不幸的是， 這種認識是使用交換區的目的的一種普遍誤解，尤其在現代系統上。\n前文中我說過回收匿名頁面的內存是「不可能的」，因爲匿名內存的特點，把它們從內存中清除掉之後， 沒有別的存儲區域能作爲他們的備份——因此，要回收它們會造成數據丟失。但是，如果我們爲這種內存頁面創建 一種後備存儲呢？\n嗯，這正是交換區存在的意義。交換區是一塊存儲空間，用來讓這些看起來「不可回收」的內存頁面在需要的時候 可以交換到存儲設備上。這意味着有了交換區之後，這些匿名頁面也和別的那些可回收內存一樣， 可以作爲內存回收的候選，就像乾淨文件頁面，從而允許更有效地使用物理內存。\n交換區主要是爲了平等的回收機制，而不是爲了緊急情況的「額外內存」。使用交換區不會讓你的程序變慢—— 進入內存競爭的狀態才是讓程序變慢的元兇。\n那麼在這種「平等的可回收機遇」的情況下，讓我們選擇回收匿名頁面的行爲在何種場景中更合理呢？ 抽象地說，比如在下述不算罕見的場景中：\n 程序初始化的時候，那些長期運行的程序可能要分配和使用很多頁面。這些頁面可能在最後的關閉/清理的 時候還需要使用，但是在程序「啓動」之後（以具體的程序相關的方式）持續運行的時候不需要訪問。 對後臺服務程序來說，很多後臺程序要初始化不少依賴庫，這種情況很常見。 在程序的正常運行過程中，我們可能分配一些很少使用的內存。對整體系統性能而言可能比起讓這些內存頁 一直留在內存中，只有在用到的時候才按需把它們用 缺頁異常（major fault） 換入內存， 可以空出更多內存留給更重要的東西。  考察有無交換區時會發生什麼 我們來看一些在常見場景中，有無交換區時分別會如何運行。 在我的 關於 cgroup v2 的演講 中探討過「內存競爭」的指標。\n在無/低內存競爭的狀態下  有交换区: 我們可以選擇換出那些只有在進程生存期內很小一部分時間會訪問的匿名內存， 這允許我們空出更多內存空間用來提升緩存命中率，或者做別的優化。 無交換區: 我們不能換出那些很少使用的匿名內存，因爲它們被鎖在了內存中。雖然這通常不會直接表現出問題， 但是在一些工作條件下這可能造成卡頓導致不平凡的性能下降，因爲匿名內存佔着空間不能給 更重要的需求使用。   譯註：關於 內存熱度 和 內存顛簸（thrash）\n討論內核中內存管理的時候經常會說到內存頁的 冷熱 程度。這裏冷熱是指歷史上內存頁被訪問到的頻度， 內存管理的經驗在說，歷史上在近期頻繁訪問的 熱 內存，在未來也可能被頻繁訪問， 從而應該留在物理內存裏；反之歷史上不那麼頻繁訪問的 冷 內存，在未來也可能很少被用到， 從而可以考慮交換到磁盤或者丟棄文件緩存。\n顛簸（thrash） 這個詞在文中出現多次但是似乎沒有詳細介紹，實際計算機科學專業的課程中應該有講過。 一段時間內，讓程序繼續運行所需的熱內存總量被稱作程序的工作集（workset），估算工作集大小， 換句話說判斷進程分配的內存頁中哪些屬於 熱 內存哪些屬於 冷 內存，是內核中 內存管理的最重要的工作。當分配給程序的內存大於工作集的時候，程序可以不需要等待I/O全速運行； 而當分配給程序的內存不足以放下整個工作集的時候，意味着程序每執行一小段就需要等待換頁或者等待 磁盤緩存讀入所需內存頁，產生這種情況的時候，從用戶角度來看可以觀察到程序肉眼可見的「卡頓」。 當系統中所有程序都內存不足的時候，整個系統都處於顛簸的狀態下，響應速度直接降至磁盤I/O的帶寬。 如本文所說，禁用交換區並不能防止顛簸，只是從等待換頁變成了等待文件緩存， 給程序分配超過工作集大小的內存才能防止顛簸。\n 在中/高內存競爭的狀態下  有交换区: 所有內存類型都有平等的被回收的可能性。這意味着我們回收頁面有更高的成功率—— 成功回收的意思是說被回收的那些頁面不會在近期內被缺頁異常換回內存中（顛簸）。 無交換區: 匿名內存因爲無處可去所以被鎖在內存中。長期內存回收的成功率變低了，因爲我們成體上 能回收的頁面總量少了。發生缺頁顛簸的危險性更高了。缺乏經驗的讀者可能覺得這某時也是好事， 因爲這能避免進行磁盤I/O，但是實際上不是如此——我們只是把交換頁面造成的磁盤I/O變成了扔掉熱緩存頁 和扔掉代碼段，這些頁面很可能馬上又要從文件中讀回來。  在臨時內存佔用高峰時  有交换区: 我們對內存使用激增的情況更有抵抗力，但是在嚴重的內存不足的情況下， 從開始發生內存顛簸到 OOM 殺手開始工作的時間會被延長。內存壓力造成的問題更容易觀察到， 從而可能更有效地應對，或者更有機會可控地干預。 無交換區: 因爲匿名內存被鎖在內存中了不能被回收，所以 OOM 殺手會被更早觸發。 發生內存顛簸的可能性更大，但是發生顛簸之後到 OOM 解決問題的時間間隔被縮短了。 基於你的程序，這可能更好或是更糟。比如說，基於隊列的程序可能更希望這種從顛簸到殺進程的轉換更快發生。 即便如此，發生 OOM 的時機通常還是太遲於是沒什麼幫助——只有在系統極度內存緊缺的情況下才會請出 OOM 殺手，如果想依賴這種行爲模式，不如換成更早殺進程的方案，因爲在這之前已經發生內存競爭了。  好吧，所以我需要系統交換區，但是我該怎麼爲每個程序微調它的行爲？ 你肯定想到了我寫這篇文章一定會在哪兒插點 cgroup v2 的安利吧？ ;-)\n顯然，要設計一種對所有情況都有效的啓發算法會非常難，所以給內核提一些指引就很重要。 歷史上我們只能在整個系統層面做這方面微調，通過 vm.swappiness 。這有兩方面問題： vm.swappiness 的行爲很難準確控制，因爲它只是傳遞給一個更大的啓發式算法中的一個小參數； 並且它是一個系統級別的設置，沒法針對一小部分進程微調。\n你可以用 mlock 把頁面鎖在內存裏，但是這要麼必須改程序代碼，或者折騰 LD_PRELOAD ，或者在運行期用調試器做一些魔法操作。對基於虛擬機的語言來說這種方案也不能 很好工作，因爲通常你沒法控制內存分配，最後得用上 mlockall ，而這個沒有辦法精確指定你實際上想鎖住的頁面。\ncgroup v2 提供了一套可以每個 cgroup 微調的 memory.low ，允許我們告訴內核說當使用的內存低於一定閾值之後優先回收別的程序的內存。這可以讓我們不強硬禁止內核 換出程序的一部分內存，但是當發生內存競爭的時候讓內核優先回收別的程序的內存。在正常條件下， 內核的交換邏輯通常還是不錯的，允許它有條件地換出一部分頁面通常可以改善系統性能。在內存競爭的時候 發生交換顛簸雖然不理想，但是這更多地是單純因爲整體內存不夠了，而不是因爲交換進程（swapper）導致的問題。 在這種場景下，你通常希望在內存壓力開始積攢的時候通過自殺一些非關鍵的進程的方式來快速退出（fail fast）。\n你不能依賴 OOM 殺手達成這個。 OOM 殺手只有在非常急迫的情況下纔會出動，那時系統已經處於極度不健康的 狀態了，而且很可能在這種狀態下保持了一陣子了。需要在開始考慮 OOM 殺手之前，積極地自己處理這種情況。\n不過，用傳統的 Linux 內存統計數據還是挺難判斷內存壓力的。我們有一些看起來相關的系統指標，但是都 只是支離破碎的——內存用量、頁面掃描，這些——單純從這些指標很難判斷系統是處於高效的內存利用率還是 在滑向內存競爭狀態。我們在 Facebook 有個團隊，由 Johannes 牽頭，努力開發一些能評價內存壓力的新指標，希望能在今後改善目前的現狀。 如果你對這方面感興趣， 在我的 cgroup v2 的演講中介紹到一個被提議的指標 。\n調優 那麼，我需要多少交換空間？ 通常而言，最優內存管理所需的最小交換空間取決於程序固定在內存中而又很少訪問到的匿名頁面的數量， 以及回收這些匿名頁面換來的價值。後者大體上來說是問哪些頁面不再會因爲要保留這些很少訪問的匿名頁面而 被回收掉騰出空間。\n如果你有足夠大的磁盤空間和比較新的內核版本（4.0+），越大的交換空間基本上總是越好的。 更老的內核上 kswapd ， 內核中負責管理交換區的內核線程，在歷史上傾向於有越多交換空間就 急於交換越多內存出去。在最近一段時間，可用交換空間很大的時候的交換行爲已經改善了很多。 如果在運行 4.0+ 以後的內核，即便有很大的交換區在現代內核上也不會很激進地做交換。因此， 如果你有足夠的容量，現代內核上有個幾個 GB 的交換空間大小能讓你有更多選擇。\n如果你的磁盤空間有限，那麼答案更多取決於你願意做的取捨，以及運行的環境。理想上應該有足夠的交換空間 能高效應對正常負載和高峰（內存）負載。我建議先用 2-3GB 或者更多的交換空間搭個測試環境， 然後監視在不同（內存）負載條件下持續一週左右的情況。只要在那一週裏沒有發生過嚴重的內存不足—— 發生了的話說明測試結果沒什麼用——在測試結束的時候大概會留有多少 MB 交換區佔用。 作爲結果說明你至少應該有那麼多可用的交換空間，再多加一些以應對負載變化。用日誌模式跑 atop 可以在 SWAPSZ 欄顯示程序的頁面被交換出去的情況，所以如果你還沒用它記錄服務器歷史日誌的話 ，這次測試中可以試試在測試機上用它記錄日誌。這也會告訴你什麼時候你的程序開始換出頁面，你可以用這個 對照事件日誌或者別的關鍵數據。\n另一點值得考慮的是交換空間所在存儲設備的媒介。讀取交換區傾向於很隨機，因爲我們不能可靠預測什麼時候 什麼頁面會被再次訪問。在 SSD 上這不是什麼問題，但是在傳統磁盤上，隨機 I/O 操作會很昂貴， 因爲需要物理動作尋道。另一方面，重新加載文件緩存可能不那麼隨機，因爲單一程序在運行期的文件讀操作 一般不會太碎片化。這可能意味着在傳統磁盤上你想更多地回收文件頁面而不是換出匿名頁面，但仍舊， 你需要做測試評估在你的工作負載下如何取得平衡。\n 譯註：關於休眠到磁盤時的交換空間大小\n原文這裏建議交換空間至少是物理內存大小，我覺得實際上不需要。休眠到磁盤的時候內核會寫回並丟棄 所有有文件作後備的可回收頁面，交換區只需要能放下那些沒有文件後備的頁面就可以了。 如果去掉文件緩存頁面之後剩下的已用物理內存總量能完整放入交換區中，就可以正常休眠。 對於桌面瀏覽器這種內存大戶，通常有很多緩存頁可以在休眠的時候丟棄。\n 對筆記本/桌面用戶如果想要休眠到交換區，這也需要考慮——這種情況下你的交換文件應該至少是物理內存大小。\n我的 swappiness 應該如何設置？ 首先很重要的一點是，要理解 vm.swappiness 是做什麼的。 vm.swappiness 是一個 sysctl 用來控制在內存回收的時候，是優先回收匿名頁面， 還是優先回收文件頁面。內存回收的時候用兩個屬性： file_prio （回收文件頁面的傾向） 和 anon_prio （回收匿名頁面的傾向）。 vm.swappiness 控制這兩個值， 因爲它是 anon_prio 的默認值，然後也是默認 200 減去它之後 file_prio 的默認值。 意味着如果我們設置 vm.swappiness = 50 那麼結果是 anon_prio 是 50， file_prio 是 150 （這裏數值本身不是很重要，重要的是兩者之間的權重比）。\n 譯註：關於 SSD 上的 swappiness\n原文這裏說 SSD 上 swap 和 drop page cache 差不多開銷所以 vm.swappiness = 100 。我覺得實際上要考慮 swap out 的時候會產生寫入操作，而 drop page cache 可能不需要寫入（ 要看頁面是否是髒頁）。如果負載本身對I/O帶寬比較敏感，稍微調低 swappiness 可能對性能更好， 內核的默認值 60 是個不錯的默認值。以及桌面用戶可能對性能不那麼關心，反而更關心 SSD 的寫入壽命，雖然說 SSD 寫入壽命一般也足夠桌面用戶，不過調低 swappiness 可能也能減少一部分不必要的寫入（因爲寫回髒頁是必然會發生的，而寫 swap 可以避免）。 當然太低的 swappiness 會對性能有負面影響（因爲太多匿名頁面留在物理內存裏而降低了緩存命中率） ，這裏的權衡也需要根據具體負載做測試。\n另外澄清一點誤解， swap 分區還是 swap 文件對系統運行時的性能而言沒有差別。或許有人會覺得 swap 文件要經過文件系統所以會有性能損失，在譯文之前譯者說過 Linux 的內存管理子系統基本上獨立於文件系統。 實際上 Linux 上的 swapon 在設置 swap 文件作爲交換空間的時候會讀取一次文件系統元數據， 確定 swap 文件在磁盤上的地址範圍，隨後運行的過程中做交換就和文件系統無關了。關於 swap 空間是否連續的影響，因爲 swap 讀寫基本是頁面單位的隨機讀寫，所以即便連續的 swap 空間（swap 分區）也並不能改善 swap 的性能。希疏文件的地址範圍本身不連續，寫入希疏文件的空洞需要 文件系統分配磁盤空間，所以在 Linux 上交換文件不能是希疏文件。只要不是希疏文件， 連續的文件內地址範圍在磁盤上是否連續（是否有文件碎片）基本不影響能否 swapon 或者使用 swap 時的性能。\n 這意味着，通常來說 vm.swappiness 只是一個比例，用來衡量在你的硬件和工作負載下， 回收和換回匿名內存還是文件內存哪種更昂貴 。設定的值越低，你就是在告訴內核說換出那些不常訪問的 匿名頁面在你的硬件上開銷越昂貴；設定的值越高，你就是在告訴內核說在你的硬件上交換匿名頁和 文件緩存的開銷越接近。內存管理子系統仍然還是會根據實際想要回收的內存的訪問熱度嘗試自己決定具體是 交換出文件還是匿名頁面，只不過 swappiness 會在兩種回收方式皆可的時候，在計算開銷權重的過程中左右 是該更多地做交換還是丟棄緩存。在 SSD 上這兩種方式基本上是同等開銷，所以設成 vm.swappiness = 100 （同等比重）可能工作得不錯。在傳統磁盤上，交換頁面可能會更昂貴， 因爲通常需要隨機讀取，所以你可能想要設低一些。\n現實是大部分人對他們的硬件需求沒有什麼感受，所以根據直覺調整這個值可能挺困難的 —— 你需要用不同的值做測試。你也可以花時間評估一下你的系統的內存分配情況和核心應用在大量回收內存的時候的行爲表現。\n討論 vm.swappiness 的時候，一個極爲重要需要考慮的修改是（相對）近期在 2012 年左右 Satoru Moriya 對 vmscan 行爲的修改 ，它顯著改變了代碼對 vm.swappiness = 0 這個值的處理方式。\n基本上來說這個補丁讓我們在 vm.swappiness = 0 的時候會極度避免掃描（進而回收）匿名頁面， 除非我們已經在經歷嚴重的內存搶佔。就如本文前面所屬，這種行爲基本上不會是你想要的， 因爲這種行爲會導致在發生內存搶佔之前無法保證內存回收的公平性，這甚至可能是最初導致發生內存搶佔的原因。 想要避免這個補丁中對掃描匿名頁面的特殊行爲的話， vm.swappiness = 1 是你能設置的最低值。\n內核在這裏設置的默認值是 vm.swappiness = 60 。這個值對大部分工作負載來說都不會太壞， 但是很難有一個默認值能符合所有種類的工作負載。因此，對上面「 那麼，我需要多少交換空間？ 」那段討論的一點重要擴展可以說，在測試系統中可以嘗試使用不同的 vm.swappiness ，然後監視你的程序和系統在重（內存）負載下的性能指標。在未來某天，如果我們在內核中有了合理的 缺頁檢測 ，你也將能通過 cgroup v2 的頁面缺頁 指標來以負載無關的方式決定這個。\nSREcon19 Asia/Pacific - Linux Memory Management at Scale: Under the Hood\n2019年07月更新：內核 4.20+ 中的內存壓力指標 前文中提到的開發中的內存缺頁檢測指標已經進入 4.20+ 以上版本的內核，可以通過 CONFIG_PSI=y 開啓。詳情參見我在 SREcon 大約 25:05 左右的討論。\n結論  交換區是允許公平地回收內存的有用工具，但是它的目的經常被人誤解，導致它在業內這種負面聲譽。如果 你是按照原本的目的使用交換區的話——作爲增加內存回收公平性的方式——你會發現它是很有效的工具而不是阻礙。 禁用交換區並不能在內存競爭的時候防止磁盤I/O的問題，它只不過把匿名頁面的磁盤I/O變成了文件頁面的 磁盤I/O。這不僅更低效，因爲我們回收內存的時候能選擇的頁面範圍更小了，而且它可能是導致高度內存競爭 狀態的元兇。 有交換區會導致系統更慢地使用 OOM 殺手，因爲在缺少內存的情況下它提供了另一種更慢的內存， 會持續地內存顛簸——內核調用 OOM 殺手只是最後手段，會晚於所有事情已經被搞得一團糟之後。 解決方案取決於你的系統：  你可以預先更具每個 cgroup 的或者系統全局的內存壓力改變系統負載。這能防止我們最初進入內存競爭 的狀態，但是 Unix 的歷史中一直缺乏可靠的內存壓力檢測方式。希望不久之後在有了 缺頁檢測 這樣的性能指標之後能改善這一點。 你可以使用 memory.low 讓內核不傾向於回收（進而交換）特定一些 cgroup 中的進程， 允許你在不禁用交換區的前提下保護關鍵後臺服務。    關於 swap 的一些補充f ","wordCount":"47069","inLanguage":"en","image":"https://sakamotokurome.github.io/Covers/146152-Fedora%20girl%20-%20logo%20on%20bottom.jpg.webp","datePublished":"2022-03-09T11:39:38+08:00","dateModified":"2022-03-09T11:39:38+08:00","author":{"@type":"Person","name":"Sakamoto Kurome"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sakamotokurome.github.io/posts/fedora/"},"publisher":{"@type":"Organization","name":"Sakamoto Kurome","logo":{"@type":"ImageObject","url":"https://sakamotokurome.github.io/favicon.ico"}}}</script>
</head>
<body class=dark id=top>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://sakamotokurome.github.io/ accesskey=h title="Sakamoto Kurome (Alt + H)">Sakamoto Kurome</a>
<span class=logo-switches>
</span>
</div>
<ul id=menu>
<li>
<a href=https://sakamotokurome.github.io/archives/ title=Archives>
<span>Archives</span>
</a>
</li>
<li>
<a href=https://sakamotokurome.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://sakamotokurome.github.io/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Fedora
</h1>
<div class=post-meta><span title="2022-03-09 11:39:38 +0800 +0800">March 9, 2022</span>&nbsp;·&nbsp;94 min&nbsp;·&nbsp;Sakamoto Kurome
</div>
</header>
<figure class=entry-cover><img loading=lazy src=https://sakamotokurome.github.io/Covers/146152-Fedora%20girl%20-%20logo%20on%20bottom.jpg.webp alt="Fedora Logo">
<p>Fedora</p>
</figure><div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#fedora-linux-%e7%89%88%e6%9c%achttpsadatiyacompost71854html aria-label="Fedora Linux 版本"><a href=https://adatiya.com/post/71854.html>Fedora Linux 版本</a></a><ul>
<li>
<a href=#fedora-%e5%ae%98%e6%96%b9%e7%89%88%e6%9c%achttpsgetfedoraorg aria-label="Fedora 官方版本"><a href=https://getfedora.org/>Fedora 官方版本</a></a></li>
<li>
<a href=#fedora-spinshttpsspinsfedoraprojectorg aria-label="Fedora Spins"><a href=https://spins.fedoraproject.org/>Fedora Spins</a></a></li>
<li>
<a href=#fedora-labshttpslabsfedoraprojectorg aria-label="Fedora Labs"><a href=https://labs.fedoraproject.org/>Fedora Labs</a></a></li>
<li>
<a href=#fedora-alternative-downloadshttpsaltfedoraprojectorg aria-label="Fedora Alternative Downloads"><a href=https://alt.fedoraproject.org/>Fedora Alternative Downloads</a></a></li></ul>
</li>
<li>
<a href=#fedora-usage aria-label="Fedora Usage">Fedora Usage</a><ul>
<li>
<a href=#mirrors-of-fedora aria-label="Mirrors Of Fedora">Mirrors Of Fedora</a><ul>
<li>
<a href=#sjtu-mirrorhttpsmirrorsjtueducndocsfedoralinux aria-label="SJTU Mirror"><a href=https://mirror.sjtu.edu.cn/docs/fedora/linux>SJTU Mirror</a></a></li>
<li>
<a href=#rpmfusion aria-label=RPMFusion>RPMFusion</a></li>
<li>
<a href=#flathub-mirror aria-label="FlatHub Mirror">FlatHub Mirror</a></li>
<li>
<a href=#coprhttpscoprfedorainfracloudorg aria-label=Copr><a href=https://copr.fedorainfracloud.org/>Copr</a></a></li></ul>
</li>
<li>
<a href=#speed-up-dnfhttpsostechnixcomhow-to-speed-up-dnf-package-manager-in-fedora aria-label="Speed Up DNF"><a href=https://ostechnix.com/how-to-speed-up-dnf-package-manager-in-fedora/>Speed Up DNF</a></a></li>
<li>
<a href=#gnome aria-label=Gnome>Gnome</a></li>
<li>
<a href=#multiple-git-accountshttpstecadminnetsetup-multiple-github-accounts-on-linux aria-label="Multiple Git Accounts"><a href=https://tecadmin.net/setup-multiple-github-accounts-on-linux/>Multiple Git Accounts</a></a></li>
<li>
<a href=#fcitx5httpsfedoraprojectorgwikii18nfcitx5zh-cn aria-label=Fcitx5><a href=https://fedoraproject.org/wiki/I18N/Fcitx5/zh-cn>Fcitx5</a></a></li>
<li>
<a href=#nvidiahttpsdocsfedoraprojectorgen-usquick-docshow-to-set-nvidia-as-primary-gpu-on-optimus-based-laptops aria-label=Nvidia><a href=https://docs.fedoraproject.org/en-US/quick-docs/how-to-set-nvidia-as-primary-gpu-on-optimus-based-laptops/>Nvidia</a></a></li>
<li>
<a href=#movies-and-musichttpsdocsfedoraprojectorgen-usquick-docsassembly_installing-plugins-for-playing-movies-and-music aria-label="Movies and music"><a href=https://docs.fedoraproject.org/en-US/quick-docs/assembly_installing-plugins-for-playing-movies-and-music/>Movies and music</a></a></li>
<li>
<a href=#rhythmbox aria-label=Rhythmbox>Rhythmbox</a></li>
<li>
<a href=#podman aria-label=Podman>Podman</a></li>
<li>
<a href=#zfs-on-fedora aria-label="ZFS on Fedora">ZFS on Fedora</a></li>
<li>
<a href=#virt-managerhttpsfedoramagazineorgfull-virtualization-system-on-fedora-workstation-30 aria-label=virt-manager><a href=https://fedoramagazine.org/full-virtualization-system-on-fedora-workstation-30/>virt-manager</a></a></li>
<li>
<a href=#vscode aria-label=VSCode>VSCode</a></li></ul>
</li>
<li>
<a href=#fedora-system aria-label="Fedora System">Fedora System</a><ul>
<li>
<a href=#package-manager aria-label="Package Manager">Package Manager</a><ul>
<li>
<a href=#managing-dnf-repositoryhttpsdocsfedoraprojectorgen-usfedora23htmlsystem_administrators_guidesec-managing_dnf_repositorieshtml aria-label="Managing DNF Repository"><a href=https://docs.fedoraproject.org/en-US/Fedora/23/html/System_Administrators_Guide/sec-Managing_DNF_Repositories.html>Managing DNF Repository</a></a></li>
<li>
<a href=#dnf-system-upgradehttpsdocsfedoraprojectorgen-usquick-docsdnf-system-upgrade aria-label="DNF System Upgrade"><a href=https://docs.fedoraproject.org/en-US/quick-docs/dnf-system-upgrade/>DNF System Upgrade</a></a></li>
<li>
<a href=#dnf-local-pluginhttpsfedoramagazineorguse-the-dnf-local-plugin-to-speed-up-your-home-lab aria-label="DNF local plugin"><a href=https://fedoramagazine.org/use-the-dnf-local-plugin-to-speed-up-your-home-lab/>DNF local plugin</a></a></li>
<li>
<a href=#use-dns-over-tlshttpsfedoramagazineorguse-dns-over-tls aria-label="Use DNS over TLS"><a href=https://fedoramagazine.org/use-dns-over-tls/>Use DNS over TLS</a></a></li>
<li>
<a href=#dnf-updateinfohttpsfedoramagazineorguse-dnf-updateinfo-to-read-update-changelogs aria-label="dnf updateinfo"><a href=https://fedoramagazine.org/use-dnf-updateinfo-to-read-update-changelogs/>dnf updateinfo</a></a></li></ul>
</li>
<li>
<a href=#xfs-%e6%aa%94%e6%a1%88%e7%b3%bb%e7%b5%b1%e7%b0%a1%e4%bb%8bhttpslinuxvbirdorglinux_basiccentos70230filesystemphpharddisk-xfs aria-label="XFS 檔案系統簡介"><a href=https://linux.vbird.org/linux_basic/centos7/0230filesystem.php#harddisk-xfs>XFS 檔案系統簡介</a></a></li>
<li>
<a href=#rosettahttpswikiarchlinuxorgtitlepacmanrosetta aria-label=Rosetta><a href=https://wiki.archlinux.org/title/Pacman/Rosetta>Rosetta</a></a><ul>
<li>
<a href=#basic-operations aria-label="Basic operations">Basic operations</a></li>
<li>
<a href=#querying-specific-packages aria-label="Querying specific packages">Querying specific packages</a></li>
<li>
<a href=#querying-package-lists aria-label="Querying package lists">Querying package lists</a></li>
<li>
<a href=#querying-package-dependencies aria-label="Querying package dependencies">Querying package dependencies</a></li>
<li>
<a href=#installation-sources-management aria-label="Installation sources management">Installation sources management</a></li>
<li>
<a href=#overrides aria-label=Overrides>Overrides</a></li>
<li>
<a href=#verification-and-repair aria-label="Verification and repair">Verification and repair</a></li>
<li>
<a href=#using-package-files-and-building-packages aria-label="Using package files and building packages">Using package files and building packages</a></li></ul>
</li></ul>
</li>
<li>
<a href=#fedora-tips aria-label="Fedora Tips">Fedora Tips</a><ul>
<li>
<a href=#killhttpswwwcnblogscomsparkdevp6659629html aria-label=kill><a href=https://www.cnblogs.com/sparkdev/p/6659629.html>kill</a></a></li>
<li>
<a href=#shell-freezeshttpswikiarchlinuxorgtitlegnometroubleshootingshell_freezes aria-label="Shell freezes"><a href=https://wiki.archlinux.org/title/GNOME/Troubleshooting#Shell_freezes>Shell freezes</a></a><ul>
<li>
<a href=#fix-a-frozen-gnome-desktop-sessionhttpswwwaddictivetipscomubuntu-linux-tipsfix-frozen-gnome-desktop-session aria-label="fix a frozen Gnome desktop session"><a href=https://www.addictivetips.com/ubuntu-linux-tips/fix-frozen-gnome-desktop-session/#>fix a frozen Gnome desktop session</a></a></li>
<li>
<a href=#%e9%87%8d%e5%90%af-gnome-shellhttpsbynsscomlinux705736htmlamp aria-label="重启 Gnome Shell"><a href=https://bynss.com/linux/705736.html/amp/>重启 Gnome Shell</a></a></li></ul>
</li>
<li>
<a href=#gaming-on-fedorahttpsfedoramagazineorggaming-on-fedora aria-label="Gaming on Fedora"><a href=https://fedoramagazine.org/gaming-on-fedora/>Gaming on Fedora</a></a></li>
<li>
<a href=#fedora-33-%e7%99%be%e5%ba%a6%e7%bd%91%e7%9b%98linux%e7%89%88httpsttys3devpostrun-baidunetdisk-on-fedora-is-hard aria-label="Fedora 33 百度网盘Linux版"><a href=https://ttys3.dev/post/run-baidunetdisk-on-fedora-is-hard/>Fedora 33 百度网盘Linux版</a></a></li>
<li>
<a href=#ldd-%e6%9f%a5%e7%9c%8b%e7%a8%8b%e5%ba%8f%e4%be%9d%e8%b5%96%e5%ba%93httplinuxtools-rstreadthedocsiozh_cnlatesttoollddhtml aria-label="ldd 查看程序依赖库"><a href=http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/ldd.html>ldd 查看程序依赖库</a></a></li>
<li>
<a href=#adb-and-fastboot aria-label="adb and fastboot">adb and fastboot</a></li>
<li>
<a href=#onedrive-%e5%8a%a0%e9%80%9f aria-label="OneDrive 加速">OneDrive 加速</a></li>
<li>
<a href=#recover-a-root-passwordhttpsdocsfedoraprojectorgen-usquick-docsreset-root-passwordsect-reset-password-using-the-fedora-live-media aria-label="Recover a root password"><a href=https://docs.fedoraproject.org/en-US/quick-docs/reset-root-password/#sect-reset-password-using-the-fedora-live-media>Recover a root password</a></a></li>
<li>
<a href=#samba-serverhttpswwwtecmintcominstall-samba-rhel-centos-fedora aria-label="Samba Server"><a href=https://www.tecmint.com/install-samba-rhel-centos-fedora/>Samba Server</a></a></li>
<li>
<a href=#mitgnu-schememitgnu-scheme aria-label="[MIT/GNU Scheme](MIT/GNU Scheme)">[MIT/GNU Scheme](MIT/GNU Scheme)</a></li>
<li>
<a href=#wavflacapehttpsshoplovehificomthread-498288-1-1html aria-label=WAV、FLAC、APE><a href=https://shop.lovehifi.com/thread-498288-1-1.html>WAV、FLAC、APE</a></a><ul>
<li>
<a href=#%e5%8c%ba%e5%88%ab aria-label=区别>区别</a></li>
<li>
<a href=#%e6%89%a9%e5%b1%95%e7%9f%a5%e8%af%86 aria-label=扩展知识>扩展知识</a></li>
<li>
<a href=#%e7%af%87%e5%a4%96%e7%af%87 aria-label=篇外篇>篇外篇</a></li></ul>
</li>
<li>
<a href=#%e8%a7%86%e9%a2%91%e7%bc%96%e7%a0%81%e7%a0%81%e7%8e%87%e6%8e%a7%e5%88%b6httpscloudtencentcomdeveloperarticle1698219 aria-label=视频编码码率控制><a href=https://cloud.tencent.com/developer/article/1698219>视频编码码率控制</a></a><ul>
<li>
<a href=#cbr aria-label=CBR>CBR</a></li>
<li>
<a href=#vbr aria-label=VBR>VBR</a></li>
<li>
<a href=#abr aria-label=ABR>ABR</a></li>
<li>
<a href=#%e6%80%bb%e7%bb%93httpsblogxuitenetkkaima2twblog117443956-cbre38081vbre38081abre5b7aee795b0e680a7 aria-label=总结><a href=https://blog.xuite.net/kkaima2/twblog/117443956-CBR%E3%80%81+VBR%E3%80%81ABR+%E5%B7%AE%E7%95%B0%E6%80%A7>总结</a></a></li></ul>
</li>
<li>
<a href=#dffdsfdst aria-label=DFF、DSF、DST>DFF、DSF、DST</a></li>
<li>
<a href=#rpm-%e6%90%9c%e7%b4%a2%e4%b8%8e%e4%b8%8b%e8%bd%bd%e7%bd%91%e7%ab%99 aria-label="RPM 搜索与下载网站">RPM 搜索与下载网站</a></li>
<li>
<a href=#%e8%af%af%e5%88%a0%e4%ba%86-usrshareicons-%e7%9b%ae%e5%bd%95httpsadatiyacompost76557html aria-label="误删了 /usr/share/icons 目录"><a href=https://adatiya.com/post/76557.html>误删了 <code>/usr/share/icons</code> 目录</a></a></li>
<li>
<a href=#flatpak-%e7%9a%84%e4%ba%9a%e6%b4%b2%e5%ad%97%e4%bd%93%e9%97%ae%e9%a2%98httpswikiarchlinuxorgtitlesteam_e7ae80e4bd93e4b8ade69687flatpak_e79a84e4ba9ae6b4b2e5ad97e4bd93e997aee9a298 aria-label="Flatpak 的亚洲字体问题"><a href=https://wiki.archlinux.org/title/Steam_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#Flatpak_%E7%9A%84%E4%BA%9A%E6%B4%B2%E5%AD%97%E4%BD%93%E9%97%AE%E9%A2%98><strong>Flatpak 的亚洲字体问题</strong></a></a></li>
<li>
<a href=#selinux-policy-for-a-systemd-servicehttpsunixstackexchangecoma447133 aria-label="SELinux policy for a systemd service"><a href=https://unix.stackexchange.com/a/447133>SELinux policy for a systemd service</a></a></li>
<li>
<a href=#filter-ruleshttpsman7orglinuxman-pagesman1rsync1htmlfilter_rules aria-label="FILTER RULES"><a href=https://man7.org/linux/man-pages/man1/rsync.1.html#FILTER_RULES>FILTER RULES</a></a></li></ul>
</li>
<li>
<a href=#fedora-questions aria-label="Fedora Questions">Fedora Questions</a><ul>
<li>
<a href=#cannot-open-acess-to-console-the-root-account-is-locked aria-label="Cannot open acess to console, the root account is locked&amp;hellip;">Cannot open acess to console, the root account is locked&mldr;</a></li>
<li>
<a href=#dmesg-x86cpu-sgx-disabled-by-bios aria-label="dmesg-x86/cpu: SGX disabled by BIOS">dmesg-x86/cpu: SGX disabled by BIOS</a></li>
<li>
<a href=#snd_hda_codec_hdmi-hdaudioc0d2-monitor-plugged-in-failed-to-power-up-codec-ret-13httpsbbsarchlinuxorgviewtopicphpid261225 aria-label="snd_hda_codec_hdmi hdaudioC0D2: Monitor plugged-in, Failed to power up codec ret=[-13]"><a href="https://bbs.archlinux.org/viewtopic.php?id=261225">snd_hda_codec_hdmi hdaudioC0D2: Monitor plugged-in, Failed to power up codec ret=[-13]</a></a></li>
<li>
<a href=#%e4%b8%ba%e4%bb%80%e4%b9%88-linus-torvalds-%e7%94%a8-fedorahttpswwwzhihucomquestion36863290 aria-label="为什么 Linus Torvalds 用 Fedora"><a href=https://www.zhihu.com/question/36863290>为什么 Linus Torvalds 用 Fedora</a></a></li>
<li>
<a href=#%e4%bb%a3%e7%90%86%e5%90%8e%e4%b8%ba%e4%bb%80%e4%b9%88-ping-%e4%b8%8d%e9%80%9ahttpswwwzhihucomquestion20053991 aria-label="代理后为什么 ping 不通"><a href=https://www.zhihu.com/question/20053991>代理后为什么 ping 不通</a></a></li>
<li>
<a href=#fedora%e5%ae%89%e8%a3%85chrome%e5%90%8e%e6%98%be%e7%a4%ba%e6%82%a8%e7%9a%84%e6%b5%8f%e8%a7%88%e5%99%a8%e7%94%b1%e6%89%80%e5%b1%9e%e7%bb%84%e7%bb%87%e7%ae%a1%e7%90%86httpsbugzillaredhatcomshow_bugcgiid1680129 aria-label=Fedora安装Chrome后显示“您的浏览器由所属组织管理”><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1680129">Fedora安装Chrome后显示“您的浏览器由所属组织管理”</a></a></li>
<li>
<a href=#difference-between-docker-attach-and-docker-exechttpsstackoverflowcoma30962120 aria-label="difference between docker attach and docker exec"><a href=https://stackoverflow.com/a/30962120>difference between docker attach and docker exec</a></a></li>
<li>
<a href=#error-syncing-passwordshttpssupportgooglecomchromethread9947763error-syncing-passwordshlen aria-label="Error syncing passwords"><a href="https://support.google.com/chrome/thread/9947763/error-syncing-passwords?hl=en">Error syncing passwords</a></a></li>
<li>
<a href=#gnome-boxes-with-sshhttpsunixstackexchangecoma649326 aria-label="Gnome Boxes with ssh"><a href=https://unix.stackexchange.com/a/649326>Gnome Boxes with ssh</a></a></li>
<li>
<a href=#where-do-packages-installed-with-dnf-get-storedhttpssuperusercomquestions1277412where-do-packages-installed-with-dnf-get-stored aria-label="Where do packages installed with DNF get stored?"><a href=https://superuser.com/questions/1277412/where-do-packages-installed-with-dnf-get-stored>Where do packages installed with DNF get stored?</a></a></li>
<li>
<a href=#how-do-i-scan-for-viruses-with-clamavhttpsaskubuntucomquestions250290how-do-i-scan-for-viruses-with-clamav aria-label="How do I scan for viruses with ClamAV?"><a href=https://askubuntu.com/questions/250290/how-do-i-scan-for-viruses-with-clamav>How do I scan for viruses with ClamAV?</a></a></li></ul>
</li>
<li>
<a href=#rhel aria-label=RHEL>RHEL</a><ul>
<li>
<a href=#rhel-developer-subscriptionhttpsdevelopersredhatcomproductsrheldownload aria-label="RHEL Developer Subscription"><a href=https://developers.redhat.com/products/rhel/download>RHEL Developer Subscription</a></a></li>
<li>
<a href=#epelhttpsdocsfedoraprojectorgen-usepel--rpmfusionhttpsrpmfusionorgconfiguration aria-label="EPEL &amp;amp; RPMFusion"><a href=https://docs.fedoraproject.org/en-US/epel/>EPEL</a> & <a href=https://rpmfusion.org/Configuration/>RPMFusion</a></a></li>
<li>
<a href=#remis-rpm-repositoryhttpsblogremireponet aria-label="Remi&amp;rsquo;s RPM repository"><a href=https://blog.remirepo.net/>Remi&rsquo;s RPM repository</a></a></li>
<li>
<a href=#getpagespeed-rhel-packages-repositoryhttpswwwgetpagespeedcomredhat aria-label="GetPageSpeed RHEL Packages Repository"><a href=https://www.getpagespeed.com/redhat>GetPageSpeed RHEL Packages Repository</a></a></li>
<li>
<a href=#elrepo-projecthttpelrepoorgtikihomepage aria-label="ELRepo Project"><a href=http://elrepo.org/tiki/HomePage>ELRepo Project</a></a></li>
<li>
<a href=#html5mp4-videoshttpswwwredditcomrredhatcommentsdy415fcannot_play_html5mp4_videos_within_firefox_on aria-label="HTML5/MP4 videos"><a href=https://www.reddit.com/r/redhat/comments/dy415f/cannot_play_html5mp4_videos_within_firefox_on/>HTML5/MP4 videos</a></a></li>
<li>
<a href=#kdumphttpswwwcnblogscomaugusitep10613794html aria-label=Kdump><a href=https://www.cnblogs.com/augusite/p/10613794.html>Kdump</a></a></li>
<li>
<a href=#qemu-on-rhelhttpsunixstackexchangecomquestions585610qemu-and-centos-8-where-is-usr-bin-qemu-system-x86-64-and-the-qemu-system-x86 aria-label="Qemu on rhel"><a href=https://unix.stackexchange.com/questions/585610/qemu-and-centos-8-where-is-usr-bin-qemu-system-x86-64-and-the-qemu-system-x86>Qemu on rhel</a></a></li>
<li>
<a href=#vnc-applicationshttpsaskubuntucomquestions438002vnc-or-remote-desktop-application-to-view-windows-desktop-from-ubuntu aria-label="VNC applications"><a href=https://askubuntu.com/questions/438002/vnc-or-remote-desktop-application-to-view-windows-desktop-from-ubuntu>VNC applications</a></a></li></ul>
</li>
<li>
<a href=#rocky aria-label=Rocky>Rocky</a><ul>
<li>
<a href=#nju-mirrorhttpsmirrorsnjueducnhelprocky aria-label="NJU Mirror"><a href=https://mirrors.nju.edu.cn/help/rocky>NJU Mirror</a></a></li>
<li>
<a href=#epelhttpsmirrorsbfsueducnhelpepel aria-label=EPEL><a href=https://mirrors.bfsu.edu.cn/help/epel/>EPEL</a></a></li></ul>
</li>
<li>
<a href=#centos aria-label=CentOS>CentOS</a><ul>
<li>
<a href=#%e5%85%b3%e4%ba%8e%e5%a4%9a%e7%ba%bf%e7%a8%8bhttpsyangfeiffeigithubiopublic20190706multitheading-concepthtml aria-label=关于多线程><a href=https://yangfeiffei.github.io/public/2019/07/06/multitheading-concept.html>关于多线程</a></a><ul>
<li>
<a href=#%e6%a6%82%e8%bf%b0 aria-label=概述>概述</a></li>
<li>
<a href=#%e4%b8%8e%e5%a4%9a%e8%bf%9b%e7%a8%8b%e7%9a%84%e5%8c%ba%e5%88%ab aria-label=与多进程的区别>与多进程的区别</a></li>
<li>
<a href=#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8 aria-label=如何使用？>如何使用？</a></li>
<li>
<a href=#%e6%94%af%e6%8c%81%e5%a4%9a%e7%ba%bf%e7%a8%8b%e7%9a%84cpu aria-label=支持多线程的CPU>支持多线程的<code>CPU</code></a></li>
<li>
<a href=#smtht%e6%94%af%e6%8c%81%e6%83%85%e5%86%b5 aria-label=SMT/HT支持情况><code>SMT/HT</code>支持情况</a><ul>
<li>
<a href=#rhel7centos7--intel-cpu aria-label="RHEL7/CentOS7 &amp;amp; Intel CPU"><code>RHEL7/CentOS7 & Intel CPU</code></a></li>
<li>
<a href=#aix--power aria-label="AIX &amp;amp; Power">AIX & Power</a></li>
<li>
<a href=#rhel7--power aria-label="RHEL7 &amp;amp; Power">RHEL7 & Power</a></li></ul>
</li>
<li>
<a href=#%e5%85%b6%e4%bb%96 aria-label=其他>其他</a><ul>
<li>
<a href=#oracle%e6%95%b0%e6%8d%ae%e5%ba%93 aria-label=oracle数据库><code>oracle</code>数据库</a></li></ul>
</li></ul>
</li>
<li>
<a href=#%e8%bf%9e%e6%8e%a5%e7%83%ad%e7%82%b9 aria-label=连接热点>连接热点</a></li>
<li>
<a href=#pppoe-adsl%e6%8b%a8%e5%8f%b7%e4%b8%8a%e7%bd%91 aria-label="PPPOE （ADSL）拨号上网">PPPOE （ADSL）拨号上网</a></li>
<li>
<a href=#%e5%ae%89%e8%a3%85%e4%b8%ad%e6%96%87%e8%be%93%e5%85%a5%e6%b3%95 aria-label=安装中文输入法>安装中文输入法</a></li>
<li>
<a href=#%e5%85%b3%e9%97%ad%e8%a7%a6%e6%91%b8%e6%9d%bf aria-label=关闭触摸板>关闭触摸板</a></li>
<li>
<a href=#%e7%94%a8-mtp-%e6%8c%82%e8%bd%bd%e6%89%8b%e6%9c%ba aria-label="用 MTP 挂载手机">用 MTP 挂载手机</a></li>
<li>
<a href=#%e6%9f%a5%e6%89%be%e4%be%9d%e8%b5%96 aria-label=查找依赖>查找依赖</a></li>
<li>
<a href=#%e9%bb%98%e8%ae%a4%e5%ad%97%e4%bd%93 aria-label=默认字体>默认字体</a></li>
<li>
<a href=#centos-minimal--xfce aria-label="CentOS Minimal + Xfce">CentOS Minimal + Xfce</a></li></ul>
</li>
<li>
<a href=#selinux aria-label=SELinux>SELinux</a><ul>
<li>
<a href=#selinux-%e5%88%9d%e6%8e%a2 aria-label="SELinux 初探">SELinux 初探</a><ul>
<li>
<a href=#%e4%bb%80%e9%ba%bc%e6%98%af-selinux aria-label="什麼是 SELinux">什麼是 SELinux</a><ul>
<li>
<a href=#%e7%95%b6%e5%88%9d%e8%a8%ad%e8%a8%88%e7%9a%84%e7%9b%ae%e6%a8%99%e9%81%bf%e5%85%8d%e8%b3%87%e6%ba%90%e7%9a%84%e8%aa%a4%e7%94%a8 aria-label=當初設計的目標：避免資源的誤用>當初設計的目標：避免資源的誤用</a></li>
<li>
<a href=#%e5%82%b3%e7%b5%b1%e7%9a%84%e6%aa%94%e6%a1%88%e6%ac%8a%e9%99%90%e8%88%87%e5%b8%b3%e8%99%9f%e9%97%9c%e4%bf%82%e8%87%aa%e4%b8%bb%e5%bc%8f%e5%ad%98%e5%8f%96%e6%8e%a7%e5%88%b6-dac aria-label="傳統的檔案權限與帳號關係：自主式存取控制, DAC">傳統的檔案權限與帳號關係：自主式存取控制, DAC</a></li>
<li>
<a href=#%e4%bb%a5%e6%94%bf%e7%ad%96%e8%a6%8f%e5%89%87%e8%a8%82%e5%ae%9a%e7%89%b9%e5%ae%9a%e7%a8%8b%e5%ba%8f%e8%ae%80%e5%8f%96%e7%89%b9%e5%ae%9a%e6%aa%94%e6%a1%88%e5%a7%94%e4%bb%bb%e5%bc%8f%e5%ad%98%e5%8f%96%e6%8e%a7%e5%88%b6-mac aria-label="以政策規則訂定特定程序讀取特定檔案：委任式存取控制, MAC">以政策規則訂定特定程序讀取特定檔案：委任式存取控制, MAC</a></li></ul>
</li>
<li>
<a href=#selinux-%e7%9a%84%e9%81%8b%e4%bd%9c%e6%a8%a1%e5%bc%8f aria-label="SELinux 的運作模式">SELinux 的運作模式</a><ul>
<li>
<a href=#%e5%ae%89%e5%85%a8%e6%80%a7%e6%9c%ac%e6%96%87-security-context aria-label="安全性本文 (Security Context)">安全性本文 (Security Context)</a></li>
<li>
<a href=#%e7%a8%8b%e5%ba%8f%e8%88%87%e6%aa%94%e6%a1%88-selinux-type-%e6%ac%84%e4%bd%8d%e7%9a%84%e7%9b%b8%e9%97%9c%e6%80%a7 aria-label="程序與檔案 SELinux type 欄位的相關性">程序與檔案 SELinux type 欄位的相關性</a></li></ul>
</li>
<li>
<a href=#selinux-%e4%b8%89%e7%a8%ae%e6%a8%a1%e5%bc%8f%e7%9a%84%e5%95%9f%e5%8b%95%e9%97%9c%e9%96%89%e8%88%87%e8%a7%80%e5%af%9f aria-label="SELinux 三種模式的啟動、關閉與觀察">SELinux 三種模式的啟動、關閉與觀察</a><ul>
<li>
<a href=#selinux-%e7%9a%84%e5%95%9f%e5%8b%95%e8%88%87%e9%97%9c%e9%96%89 aria-label="SELinux 的啟動與關閉">SELinux 的啟動與關閉</a></li></ul>
</li>
<li>
<a href=#selinux-%e6%94%bf%e7%ad%96%e5%85%a7%e7%9a%84%e8%a6%8f%e5%89%87%e7%ae%a1%e7%90%86 aria-label="SELinux 政策內的規則管理">SELinux 政策內的規則管理</a></li>
<li>
<a href=#selinux-%e5%ae%89%e5%85%a8%e6%9c%ac%e6%96%87%e7%9a%84%e4%bf%ae%e6%94%b9 aria-label="SELinux 安全本文的修改">SELinux 安全本文的修改</a><ul>
<li>
<a href=#%e4%bd%bf%e7%94%a8-chcon-%e6%89%8b%e5%8b%95%e4%bf%ae%e6%94%b9%e6%aa%94%e6%a1%88%e7%9a%84-selinux-type aria-label="使用 chcon 手動修改檔案的 SELinux type">使用 chcon 手動修改檔案的 SELinux type</a></li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-restorecon-%e8%ae%93%e6%aa%94%e6%a1%88%e6%81%a2%e5%be%a9%e6%ad%a3%e7%a2%ba%e7%9a%84-selinux-type aria-label="使用 restorecon 讓檔案恢復正確的 SELinux type">使用 restorecon 讓檔案恢復正確的 SELinux type</a></li>
<li>
<a href=#semanage-%e9%a0%90%e8%a8%ad%e7%9b%ae%e9%8c%84%e7%9a%84%e5%ae%89%e5%85%a8%e6%80%a7%e6%9c%ac%e6%96%87%e6%9f%a5%e8%a9%a2%e8%88%87%e4%bf%ae%e6%94%b9 aria-label="semanage 預設目錄的安全性本文查詢與修改">semanage 預設目錄的安全性本文查詢與修改</a></li></ul>
</li>
<li>
<a href=#%e4%b8%80%e5%80%8b%e7%b6%b2%e8%b7%af%e6%9c%8d%e5%8b%99%e6%a1%88%e4%be%8b%e5%8f%8a%e7%99%bb%e9%8c%84%e6%aa%94%e5%8d%94%e5%8a%a9 aria-label=一個網路服務案例及登錄檔協助>一個網路服務案例及登錄檔協助</a></li></ul>
</li></ul>
</li>
<li>
<a href=#swap aria-label=Swap>Swap</a><ul>
<li>
<a href=#%e8%ad%af%e6%9b%bf-swap-%e8%be%af%e8%ad%b7%e5%b8%b8%e8%a6%8b%e7%9a%84%e8%aa%a4%e8%a7%a3httpsfarseerfcmein-defence-of-swaphtml aria-label="【譯】替 swap 辯護：常見的誤解"><a href=https://farseerfc.me/in-defence-of-swap.html>【譯】替 swap 辯護：常見的誤解</a></a><ul>
<li>
<a href=#%e8%83%8c%e6%99%af aria-label=背景>背景</a><ul>
<li>
<a href=#%e5%85%a7%e5%ad%98%e7%9a%84%e9%a1%9e%e5%9e%8b aria-label=內存的類型>內存的類型</a></li>
<li>
<a href=#%e5%8f%af%e5%9b%9e%e6%94%b6%e4%b8%8d%e5%8f%af%e5%9b%9e%e6%94%b6%e5%85%a7%e5%ad%98 aria-label=可回收/不可回收內存>可回收/不可回收內存</a></li></ul>
</li>
<li>
<a href=#%e8%aa%aa%e5%88%b0%e4%ba%a4%e6%8f%9b%e5%8d%80%e7%9a%84%e6%9c%ac%e8%b3%aa aria-label=說到交換區的本質>說到交換區的本質</a></li>
<li>
<a href=#%e8%80%83%e5%af%9f%e6%9c%89%e7%84%a1%e4%ba%a4%e6%8f%9b%e5%8d%80%e6%99%82%e6%9c%83%e7%99%bc%e7%94%9f%e4%bb%80%e9%ba%bc aria-label=考察有無交換區時會發生什麼>考察有無交換區時會發生什麼</a><ul>
<li>
<a href=#%e5%9c%a8%e7%84%a1%e4%bd%8e%e5%85%a7%e5%ad%98%e7%ab%b6%e7%88%ad%e7%9a%84%e7%8b%80%e6%85%8b%e4%b8%8b aria-label=在無/低內存競爭的狀態下>在無/低內存競爭的狀態下</a></li>
<li>
<a href=#%e5%9c%a8%e4%b8%ad%e9%ab%98%e5%85%a7%e5%ad%98%e7%ab%b6%e7%88%ad%e7%9a%84%e7%8b%80%e6%85%8b%e4%b8%8b aria-label=在中/高內存競爭的狀態下>在中/高內存競爭的狀態下</a></li>
<li>
<a href=#%e5%9c%a8%e8%87%a8%e6%99%82%e5%85%a7%e5%ad%98%e4%bd%94%e7%94%a8%e9%ab%98%e5%b3%b0%e6%99%82 aria-label=在臨時內存佔用高峰時>在臨時內存佔用高峰時</a></li>
<li>
<a href=#%e5%a5%bd%e5%90%a7%e6%89%80%e4%bb%a5%e6%88%91%e9%9c%80%e8%a6%81%e7%b3%bb%e7%b5%b1%e4%ba%a4%e6%8f%9b%e5%8d%80%e4%bd%86%e6%98%af%e6%88%91%e8%a9%b2%e6%80%8e%e9%ba%bc%e7%88%b2%e6%af%8f%e5%80%8b%e7%a8%8b%e5%ba%8f%e5%be%ae%e8%aa%bf%e5%ae%83%e7%9a%84%e8%a1%8c%e7%88%b2 aria-label=好吧，所以我需要系統交換區，但是我該怎麼爲每個程序微調它的行爲？>好吧，所以我需要系統交換區，但是我該怎麼爲每個程序微調它的行爲？</a></li></ul>
</li>
<li>
<a href=#%e8%aa%bf%e5%84%aa aria-label=調優>調優</a><ul>
<li>
<a href=#%e9%82%a3%e9%ba%bc%e6%88%91%e9%9c%80%e8%a6%81%e5%a4%9a%e5%b0%91%e4%ba%a4%e6%8f%9b%e7%a9%ba%e9%96%93 aria-label=那麼，我需要多少交換空間？>那麼，我需要多少交換空間？</a></li>
<li>
<a href=#%e6%88%91%e7%9a%84-swappiness-%e6%87%89%e8%a9%b2%e5%a6%82%e4%bd%95%e8%a8%ad%e7%bd%ae aria-label="我的 swappiness 應該如何設置？">我的 swappiness 應該如何設置？</a></li>
<li>
<a href=#2019%e5%b9%b407%e6%9c%88%e6%9b%b4%e6%96%b0%e5%85%a7%e6%a0%b8-420-%e4%b8%ad%e7%9a%84%e5%85%a7%e5%ad%98%e5%a3%93%e5%8a%9b%e6%8c%87%e6%a8%99 aria-label="2019年07月更新：內核 4.20+ 中的內存壓力指標">2019年07月更新：內核 4.20+ 中的內存壓力指標</a></li></ul>
</li>
<li>
<a href=#%e7%b5%90%e8%ab%96 aria-label=結論>結論</a></li></ul>
</li>
<li>
<a href=#%e9%97%9c%e6%96%bc-swap-%e7%9a%84%e4%b8%80%e4%ba%9b%e8%a3%9c%e5%85%85httpsfarseerfcmefollowup-about-swaphtmlf aria-label="關於 swap 的一些補充f"><a href=https://farseerfc.me/followup-about-swap.html>關於 swap 的一些補充</a>f</a>
</li>
</ul>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p><code>[fəˈdɔrə]</code> <code>费多拉</code></p>
<h2 id=fedora-linux-版本httpsadatiyacompost71854html><a href=https://adatiya.com/post/71854.html>Fedora Linux 版本</a><a hidden class=anchor aria-hidden=true href=#fedora-linux-版本httpsadatiyacompost71854html>#</a></h2>
<h3 id=fedora-官方版本httpsgetfedoraorg><a href=https://getfedora.org/>Fedora 官方版本</a><a hidden class=anchor aria-hidden=true href=#fedora-官方版本httpsgetfedoraorg>#</a></h3>
<ul>
<li>Fedora 工作站是可以安装在笔记本电脑和台式电脑上的 Linux。 此版本附带 GNOME 作为默认桌面环境和各种标准应用程序，以便 Fedora Linux 已准备好用于日常使用。</li>
<li>Fedora 服务器专门用于服务器计算机用途，提供邮件服务器、DNS 等的安装。</li>
<li>Fedora 物联网，用于物联网和设备边缘生态系统。</li>
<li>Fedora CoreOS 是一种自动更新的操作系统，旨在安全、大规模地运行容器化工作负载。</li>
<li>Fedora Silverblue 是一个不可变的桌面操作系统，旨在支持以容器为中心的工作流。</li>
</ul>
<h3 id=fedora-spinshttpsspinsfedoraprojectorg><a href=https://spins.fedoraproject.org/>Fedora Spins</a><a hidden class=anchor aria-hidden=true href=#fedora-spinshttpsspinsfedoraprojectorg>#</a></h3>
<p>Fedora 的默认桌面环境是 GNOME，但是如果您喜欢其他的桌面环境，比如 KDE Plasma Desktop 或 Xfce，您可以下载一个您喜欢的桌面环境的 spin，然后用它来安装 Fedora，为您选择的桌面环境进行预配置。</p>
<h3 id=fedora-labshttpslabsfedoraprojectorg><a href=https://labs.fedoraproject.org/>Fedora Labs</a><a hidden class=anchor aria-hidden=true href=#fedora-labshttpslabsfedoraprojectorg>#</a></h3>
<p>Fedora 实验室是一个由 Fedora 社区成员策划和维护的目的明确的软件和内容的精选捆绑包。这些软件可以作为独立的Fedora完整版安装，也可以作为现有的Fedora安装的附加组件安装。</p>
<h3 id=fedora-alternative-downloadshttpsaltfedoraprojectorg><a href=https://alt.fedoraproject.org/>Fedora Alternative Downloads</a><a hidden class=anchor aria-hidden=true href=#fedora-alternative-downloadshttpsaltfedoraprojectorg>#</a></h3>
<p>这些Fedora下载要么是特殊用途的——用于测试，用于特定的架构；要么是其他格式的Fedora标准版本，如网络安装程序格式或用于torrent下载的格式。</p>
<p>本页旨在作为查找Fedora替代版本的单一中央资源。</p>
<h2 id=fedora-usage>Fedora Usage<a hidden class=anchor aria-hidden=true href=#fedora-usage>#</a></h2>
<h3 id=mirrors-of-fedora>Mirrors Of Fedora<a hidden class=anchor aria-hidden=true href=#mirrors-of-fedora>#</a></h3>
<h4 id=sjtu-mirrorhttpsmirrorsjtueducndocsfedoralinux><a href=https://mirror.sjtu.edu.cn/docs/fedora/linux>SJTU Mirror</a><a hidden class=anchor aria-hidden=true href=#sjtu-mirrorhttpsmirrorsjtueducndocsfedoralinux>#</a></h4>
<p>托管于华东教育网骨干节点上海交通大学。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo sed -e <span style=color:#e6db74>&#39;s/^metalink=/#metalink=/g&#39;</span> -e <span style=color:#e6db74>&#39;s|^#baseurl=http://download.example/pub/|baseurl=https://mirror.sjtu.edu.cn/|g&#39;</span> -i.bak /etc/yum.repos.d/<span style=color:#f92672>{</span>fedora,fedora-updates,fedora-modular,fedora-updates-modular<span style=color:#f92672>}</span>.repo
$ sudo dnf makecache <span style=color:#75715e>#生成缓存</span>
</code></pre></div><h4 id=rpmfusion>RPMFusion<a hidden class=anchor aria-hidden=true href=#rpmfusion>#</a></h4>
<p>第一步下载基础包(开源和闭源)， 这里我们使用bfsu来下载，以避免网络问题，终端输入:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf install --nogpgcheck https://mirror.sjtu.edu.cn/rpmfusion/free/fedora/rpmfusion-free-release-<span style=color:#66d9ef>$(</span>rpm -E %fedora<span style=color:#66d9ef>)</span>.noarch.rpm https://mirror.sjtu.edu.cn/rpmfusion/nonfree/fedora/rpmfusion-nonfree-release-<span style=color:#66d9ef>$(</span>rpm -E %fedora<span style=color:#66d9ef>)</span>.noarch.rpm -y
</code></pre></div><p>第二步，使用SJTU Mirror</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo sed -e <span style=color:#e6db74>&#39;s|^metalink=|#metalink=|g&#39;</span> -e <span style=color:#e6db74>&#39;s|^#baseurl=http://download1.rpmfusion.org/|baseurl=https://mirror.sjtu.edu.cn/rpmfusion/|g&#39;</span> -i.bak /etc/yum.repos.d/rpmfusion-*
</code></pre></div><h4 id=flathub-mirror>FlatHub Mirror<a hidden class=anchor aria-hidden=true href=#flathub-mirror>#</a></h4>
<p>改为使用 sjtu 镜像：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
$ sudo flatpak remote-modify --enable flathub
$ sudo flatpak remote-modify flathub --url<span style=color:#f92672>=</span>https://mirror.sjtu.edu.cn/flathub
$ sudo flatpak remotes --show-details
$ cat /var/lib/flatpak/repo/config
</code></pre></div><h4 id=coprhttpscoprfedorainfracloudorg><a href=https://copr.fedorainfracloud.org/>Copr</a><a hidden class=anchor aria-hidden=true href=#coprhttpscoprfedorainfracloudorg>#</a></h4>
<p>类似 Ubuntu 的 PPA</p>
<ul>
<li>
<p>You need to have <code>dnf-plugins-core</code> installed for dnf, and you need to have <code>yum-plugin-copr</code> installed for yum</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf install dnf-plugins-core
$ sudo yum install yum-plugin-copr
</code></pre></div></li>
<li>
<p>If you’re using a version of Linux with dnf, or if you have older distribution:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf copr enable user/project
$ sudo yum copr enable user/project
</code></pre></div></li>
</ul>
<p>例如Fedora自带的Copr repo for PyCharm</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cat /etc/yum.repos.d/_copr_phracek-PyCharm.repo 
<span style=color:#f92672>[</span>phracek-PyCharm<span style=color:#f92672>]</span>
name<span style=color:#f92672>=</span>Copr repo <span style=color:#66d9ef>for</span> PyCharm owned by phracek
baseurl<span style=color:#f92672>=</span>https://copr-be.cloud.fedoraproject.org/results/phracek/PyCharm/fedora-$releasever-$basearch/
skip_if_unavailable<span style=color:#f92672>=</span>True
gpgcheck<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
gpgkey<span style=color:#f92672>=</span>https://copr-be.cloud.fedoraproject.org/results/phracek/PyCharm/pubkey.gpg
enabled<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</code></pre></div><h3 id=speed-up-dnfhttpsostechnixcomhow-to-speed-up-dnf-package-manager-in-fedora><a href=https://ostechnix.com/how-to-speed-up-dnf-package-manager-in-fedora/>Speed Up DNF</a><a hidden class=anchor aria-hidden=true href=#speed-up-dnfhttpsostechnixcomhow-to-speed-up-dnf-package-manager-in-fedora>#</a></h3>
<p>尝试更改参数：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo vi /etc/dnf/dnf.conf
fastestmirror<span style=color:#f92672>=</span>true <span style=color:#75715e>#如果启用国内镜像，就不需要设置这个了。</span>
max_parallel_downloads<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>
metadata_expire<span style=color:#f92672>=</span>2d
</code></pre></div><ul>
<li>fastermirror 选择最快的镜像</li>
<li>max_parallel_downloads 一次下载多个包</li>
</ul>
<h3 id=gnome>Gnome<a hidden class=anchor aria-hidden=true href=#gnome>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf install gnome-tweaks gnome-extensions-app 
</code></pre></div><ul>
<li>gnome-tweaks 里面可以管理 startup apps。</li>
<li>gnome-extensions-app 管理 extensions。</li>
<li>gnome-shell-extension-appindicator</li>
<li>gnome-shell-extension-gsconnect</li>
</ul>
<h3 id=multiple-git-accountshttpstecadminnetsetup-multiple-github-accounts-on-linux><a href=https://tecadmin.net/setup-multiple-github-accounts-on-linux/>Multiple Git Accounts</a><a hidden class=anchor aria-hidden=true href=#multiple-git-accountshttpstecadminnetsetup-multiple-github-accounts-on-linux>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ssh-keygen -t rsa -C <span style=color:#e6db74>&#34;your-email&#34;</span> 
$ nano ~/.ssh/config 
Host github-proj1
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_rsa_github_proj1
 
Host github-proj2
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_rsa_github_proj2
 
Host aws-codecommit-proj3
  Hostname git-codecommit.us-east-2.amazonaws.com
  User TECADMIN0123456789
  IdentityFile ~/.ssh/id_rsa_aws_codecommit_proj3
  AddKeysToAgent yes
$ git clone ssh://github-proj1/user1/repo.git 
$ git clone ssh://github-proj2/user2/repo.git 
$ git clone ssh://aws-codecommit-proj3/v1/repos/myrepo 
</code></pre></div><p>设置 config 后，可能需要重启才能起作用。</p>
<h3 id=fcitx5httpsfedoraprojectorgwikii18nfcitx5zh-cn><a href=https://fedoraproject.org/wiki/I18N/Fcitx5/zh-cn>Fcitx5</a><a hidden class=anchor aria-hidden=true href=#fcitx5httpsfedoraprojectorgwikii18nfcitx5zh-cn>#</a></h3>
<p><a href=https://yanqiyu.info/2020/11/06/fcitx5-fedora-updated/><strong>安装</strong></a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf install fcitx5 fcitx5-chinese-addons fcitx5-gtk fcitx5-qt fcitx5-configtool fcitx5-autostart fcitx5-rime
$ rpm -ql fcitx5-autostart
/etc/profile.d/fcitx5.sh
/etc/xdg/autostart/org.fcitx.Fcitx5.desktop
$ cat /etc/profile.d/fcitx5.sh 
<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! <span style=color:#e6db74>&#34;</span>$XDG_SESSION_TYPE<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tty&#34;</span> <span style=color:#f92672>]</span>   <span style=color:#75715e># if this is a gui session (not tty)</span>
<span style=color:#66d9ef>then</span>
    <span style=color:#75715e># let&#39;s use fcitx instead of fcitx5 to make flatpak happy</span>
    <span style=color:#75715e># this may break behavior for users who have installed both</span>
    <span style=color:#75715e># fcitx and fcitx5, let then change the file on their own</span>
    export INPUT_METHOD<span style=color:#f92672>=</span>fcitx
    export GTK_IM_MODULE<span style=color:#f92672>=</span>fcitx
    export QT_IM_MODULE<span style=color:#f92672>=</span>fcitx
    export XMODIFIERS<span style=color:#f92672>=</span>@im<span style=color:#f92672>=</span>fcitx
<span style=color:#66d9ef>fi</span>
$ cat /etc/xdg/autostart/org.fcitx.Fcitx5.desktop
<span style=color:#f92672>[</span>Desktop Entry<span style=color:#f92672>]</span>
Name<span style=color:#f92672>[</span>ca<span style=color:#f92672>]=</span>Fcitx <span style=color:#ae81ff>5</span>
Name<span style=color:#f92672>[</span>da<span style=color:#f92672>]=</span>Fcitx <span style=color:#ae81ff>5</span>
Name<span style=color:#f92672>[</span>de<span style=color:#f92672>]=</span>Fcitx <span style=color:#ae81ff>5</span>
Name<span style=color:#f92672>[</span>ja<span style=color:#f92672>]=</span>Fcitx <span style=color:#ae81ff>5</span>
Name<span style=color:#f92672>[</span>ko<span style=color:#f92672>]=</span>Fcitx <span style=color:#ae81ff>5</span>
Name<span style=color:#f92672>[</span>zh_CN<span style=color:#f92672>]=</span>Fcitx <span style=color:#ae81ff>5</span>
Name<span style=color:#f92672>[</span>zh_TW<span style=color:#f92672>]=</span>Fcitx <span style=color:#ae81ff>5</span>
Name<span style=color:#f92672>=</span>Fcitx <span style=color:#ae81ff>5</span>
GenericName<span style=color:#f92672>[</span>ca<span style=color:#f92672>]=</span>Mètode d<span style=color:#e6db74>&#39;entrada
</span><span style=color:#e6db74>GenericName[da]=Inputmetode
</span><span style=color:#e6db74>GenericName[de]=Eingabemethode
</span><span style=color:#e6db74>GenericName[ja]=入力メソッド
</span><span style=color:#e6db74>GenericName[ko]=입력기
</span><span style=color:#e6db74>GenericName[ru]=Метод ввода
</span><span style=color:#e6db74>GenericName[zh_CN]=输入法
</span><span style=color:#e6db74>GenericName[zh_TW]=輸入法
</span><span style=color:#e6db74>GenericName=Input Method
</span><span style=color:#e6db74>Comment[ca]=Mètode d&#39;</span>entrada estàndard
Comment<span style=color:#f92672>[</span>da<span style=color:#f92672>]=</span>Start inputmetode
Comment<span style=color:#f92672>[</span>de<span style=color:#f92672>]=</span>Eingabemethode starten
Comment<span style=color:#f92672>[</span>ja<span style=color:#f92672>]=</span>入力メソッドを開始
Comment<span style=color:#f92672>[</span>ko<span style=color:#f92672>]=</span>입력기 시작
Comment<span style=color:#f92672>[</span>zh_CN<span style=color:#f92672>]=</span>启动输入法
Comment<span style=color:#f92672>=</span>Start Input Method
Exec<span style=color:#f92672>=</span>/usr/bin/fcitx5
Icon<span style=color:#f92672>=</span>fcitx
Terminal<span style=color:#f92672>=</span>false
Type<span style=color:#f92672>=</span>Application
Categories<span style=color:#f92672>=</span>System;Utility;
StartupNotify<span style=color:#f92672>=</span>false
X-GNOME-AutoRestart<span style=color:#f92672>=</span>false
X-GNOME-Autostart-Notify<span style=color:#f92672>=</span>false
X-KDE-autostart-after<span style=color:#f92672>=</span>panel
X-KDE-StartupNotify<span style=color:#f92672>=</span>false
X-KDE-Wayland-VirtualKeyboard<span style=color:#f92672>=</span>true
</code></pre></div><p>在 fcitx5 Configure 中，Input Method 只保留 rime，按组合键 <strong>Ctrl+`</strong> 选择 ”朙月拼音-简化字“，对应定制文件为 <code>luna_pinyin_simp.custom.yaml</code>。</p>
<p>扩展：<a href=https://extensions.gnome.org/extension/261/kimpanel/>Input Method Panel</a></p>
<h3 id=nvidiahttpsdocsfedoraprojectorgen-usquick-docshow-to-set-nvidia-as-primary-gpu-on-optimus-based-laptops><a href=https://docs.fedoraproject.org/en-US/quick-docs/how-to-set-nvidia-as-primary-gpu-on-optimus-based-laptops/>Nvidia</a><a hidden class=anchor aria-hidden=true href=#nvidiahttpsdocsfedoraprojectorgen-usquick-docshow-to-set-nvidia-as-primary-gpu-on-optimus-based-laptops>#</a></h3>
<ul>
<li>
<p>Update from the existing repositories</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf update
</code></pre></div></li>
<li>
<p><a href=https://itsfoss.com/fedora-third-party-repos/>Add the RPMFusion repository</a> for NVIDIA drivers</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf install fedora-workstation-repositories
</code></pre></div></li>
<li>
<p>Update from the newly added repositories</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf update --refresh
</code></pre></div></li>
<li>
<p>Install the driver and its dependencies</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf install gcc kernel-headers kernel-devel akmod-nvidia xorg-x11-drv-nvidia xorg-x11-drv-nvidia-libs xorg-x11-drv-nvidia-libs.i686
</code></pre></div></li>
<li>
<p>Wait for the kernel modules to load up</p>
</li>
<li>
<p>Read from the updated kernel modules</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo akmods --force
$ sudo dracut --force
</code></pre></div></li>
<li>
<p>Reboot your system.</p>
<p>在这里，确定在登录界面选择的是 Gnome on Xorg。</p>
</li>
<li>
<p>Edit the X11 configuration</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo cp -p /usr/share/X11/xorg.conf.d/nvidia.conf /etc/X11/xorg.conf.d/nvidia.conf
$ sudo nano /etc/X11/xorg.conf.d/nvidia.conf
Section <span style=color:#e6db74>&#34;OutputClass&#34;</span>
	Identifier <span style=color:#e6db74>&#34;nvidia&#34;</span>
	MatchDriver <span style=color:#e6db74>&#34;nvidia-drm&#34;</span>
	Driver <span style=color:#e6db74>&#34;nvidia&#34;</span>
	Option <span style=color:#e6db74>&#34;AllowEmptyInitialConfiguration&#34;</span>
	Option <span style=color:#e6db74>&#34;SLI&#34;</span> <span style=color:#e6db74>&#34;Auto&#34;</span>
	Option <span style=color:#e6db74>&#34;BaseMosaic&#34;</span> <span style=color:#e6db74>&#34;on&#34;</span>
	Option <span style=color:#e6db74>&#34;PrimaryGPU&#34;</span> <span style=color:#e6db74>&#34;yes&#34;</span>
EndSection

Section <span style=color:#e6db74>&#34;ServerLayout&#34;</span>
	Identifier <span style=color:#e6db74>&#34;layout&#34;</span>
	Option <span style=color:#e6db74>&#34;AllowNVIDIAGPUScreens&#34;</span>
EndSection
</code></pre></div></li>
<li>
<p>Reboot your system</p>
</li>
<li>
<p>Verify the configuration</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ glxinfo | egrep <span style=color:#e6db74>&#34;OpenGL vendor|OpenGL renderer&#34;</span>
</code></pre></div></li>
</ul>
<h3 id=movies-and-musichttpsdocsfedoraprojectorgen-usquick-docsassembly_installing-plugins-for-playing-movies-and-music><a href=https://docs.fedoraproject.org/en-US/quick-docs/assembly_installing-plugins-for-playing-movies-and-music/>Movies and music</a><a hidden class=anchor aria-hidden=true href=#movies-and-musichttpsdocsfedoraprojectorgen-usquick-docsassembly_installing-plugins-for-playing-movies-and-music>#</a></h3>
<p>In order to install OpenH264, you first need to enable it:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cat /etc/yum.repos.d/fedora-cisco-openh264.repo 
<span style=color:#f92672>[</span>fedora-cisco-openh264<span style=color:#f92672>]</span>
name<span style=color:#f92672>=</span>Fedora $releasever openh264 <span style=color:#f92672>(</span>From Cisco<span style=color:#f92672>)</span> - $basearch
metalink<span style=color:#f92672>=</span>https://mirrors.fedoraproject.org/metalink?repo<span style=color:#f92672>=</span>fedora-cisco-openh264-$releasever&amp;arch<span style=color:#f92672>=</span>$basearch
type<span style=color:#f92672>=</span>rpm
enabled<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
metadata_expire<span style=color:#f92672>=</span>14d
repo_gpgcheck<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
gpgcheck<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
gpgkey<span style=color:#f92672>=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch
skip_if_unavailable<span style=color:#f92672>=</span>True

<span style=color:#f92672>[</span>fedora-cisco-openh264-debuginfo<span style=color:#f92672>]</span>
name<span style=color:#f92672>=</span>Fedora $releasever openh264 <span style=color:#f92672>(</span>From Cisco<span style=color:#f92672>)</span> - $basearch - Debug
metalink<span style=color:#f92672>=</span>https://mirrors.fedoraproject.org/metalink?repo<span style=color:#f92672>=</span>fedora-cisco-openh264-debug-$releasever&amp;arch<span style=color:#f92672>=</span>$basearch
type<span style=color:#f92672>=</span>rpm
enabled<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
metadata_expire<span style=color:#f92672>=</span>14d
repo_gpgcheck<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
gpgcheck<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
gpgkey<span style=color:#f92672>=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch
skip_if_unavailable<span style=color:#f92672>=</span>True

$ sudo dnf config-manager --set-enabled fedora-cisco-openh264
</code></pre></div><p>Use the <code>dnf</code> utility to install packages that provide multimedia libraries:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo proxychains dnf install gstreamer1-plugins-<span style=color:#f92672>{</span>bad-<span style=color:#ae81ff>\*</span>,good-<span style=color:#ae81ff>\*</span>,base<span style=color:#f92672>}</span> gstreamer1-plugin-openh264 gstreamer1-libav --exclude<span style=color:#f92672>=</span>gstreamer1-plugins-bad-free-devel -y
$ sudo proxychains dnf install lame<span style=color:#ae81ff>\*</span> --exclude<span style=color:#f92672>=</span>lame-devel -y 
$ sudo proxychains dnf group upgrade --with-optional Multimedia -y
$ sudo dnf config-manager --set-disabled fedora-cisco-openh264
</code></pre></div><p>and then install the plugins (for firefox, if needed):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf install mozilla-openh264
</code></pre></div><p>Afterwards you need open Firefox, go to menu → Add-ons → Plugins and enable OpenH264 plugin.</p>
<h3 id=rhythmbox>Rhythmbox<a hidden class=anchor aria-hidden=true href=#rhythmbox>#</a></h3>
<p>无法订阅喜马拉雅的feed，报错为：</p>
<pre tabindex=0><code>Unable to load the feed. Check your network connection
</code></pre><p>其实试一下荔枝FM，会发现是可以订阅的。比较一下就会发现，荔枝FM的Feed都是mp3链接，而喜马拉雅的Feed都是m4a链接，下载必须解码器后（ <a href=https://askubuntu.com/questions/883499/all-kinds-of-music-players-cannot-play-m4a-files-throwing-your-gstreamer-insta>The .m4a files are alac which would be decoded by gstreamer1.0-libav. </a>），Rhythmbox 确实能播放m4a文件了，但依然无法订阅，因此应该是Prodcast解析feed链接的问题，有兴趣有能力有时间看：<a href=https://developer-old.gnome.org/rhythmbox/unstable/>Rhythmbox Development Reference Manual</a>（PS：Ubuntu 22.04.1 上并无此问题）</p>
<h3 id=podman>Podman<a hidden class=anchor aria-hidden=true href=#podman>#</a></h3>
<p><strong>kali linux</strong></p>
<p>开代理的话会报错：</p>
<pre tabindex=0><code>Could not connect to 127.0.0.1:7890 (127.0.0.1). - connect (111: Connection refused)
</code></pre><p>查看 <a href=https://docs.podman.io/en/latest/markdown/podman-run.1.html#http-proxy><code>man podman-run</code></a>，添加 <code>--http-proxy=false</code> 解决：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ podman run --http-proxy<span style=color:#f92672>=</span>false -it docker.io/kalilinux/kali-rolling:latest /bin/bash
</code></pre></div><p>更换 <a href=https://mirrors.ustc.edu.cn/help/kali.html>ustc 源</a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ echo <span style=color:#e6db74>&#39;deb http://mirrors.ustc.edu.cn/kali kali-rolling main non-free con
</span><span style=color:#e6db74>trib&#39;</span> &gt; sources.list
</code></pre></div><p><a href=https://www.kali.org/docs/containers/official-kalilinux-docker-images/>metapackage</a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ apt update <span style=color:#f92672>&amp;&amp;</span> apt -y install kali-linux-headless
</code></pre></div><h3 id=zfs-on-fedora>ZFS on Fedora<a hidden class=anchor aria-hidden=true href=#zfs-on-fedora>#</a></h3>
<p>zfs-fuse is a daemon which provides support for the ZFS filesystem, via fuse. Ordinarily this daemon will be invoked from system boot scripts.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf install zfs-fuse
$ sudo zfs-fuse
$ sudo zpool import dpool
cannot import <span style=color:#e6db74>&#39;dpool&#39;</span>: pool is formatted using a newer ZFS version
</code></pre></div><p><a href=https://openzfs.github.io/openzfs-docs/Getting%20Started/Fedora/index.html><strong>OpenZFS on Fedora</strong></a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo rpm -e --nodeps zfs-fuse
$ sudo proxychains dnf install -y https://zfsonlinux.org/fedora/zfs-release<span style=color:#66d9ef>$(</span>rpm -E %dist<span style=color:#66d9ef>)</span>.noarch.rpm
$ cat /etc/yum.repos.d/zfs.repo 
<span style=color:#f92672>[</span>zfs<span style=color:#f92672>]</span>
name<span style=color:#f92672>=</span>ZFS on Linux <span style=color:#66d9ef>for</span> Fedora $releasever
baseurl<span style=color:#f92672>=</span>http://download.zfsonlinux.org/fedora/$releasever/$basearch/
enabled<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
metadata_expire<span style=color:#f92672>=</span>7d
gpgcheck<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
gpgkey<span style=color:#f92672>=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-zfsonlinux

<span style=color:#f92672>[</span>zfs-source<span style=color:#f92672>]</span>
name<span style=color:#f92672>=</span>ZFS on Linux <span style=color:#66d9ef>for</span> Fedora $releasever - Source
baseurl<span style=color:#f92672>=</span>http://download.zfsonlinux.org/fedora/$releasever/SRPMS/
enabled<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
gpgcheck<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
gpgkey<span style=color:#f92672>=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-zfsonlinux

<span style=color:#f92672>[</span>zfs-testing<span style=color:#f92672>]</span>
name<span style=color:#f92672>=</span>ZFS on Linux <span style=color:#66d9ef>for</span> Fedora $releasever - Testing
baseurl<span style=color:#f92672>=</span>http://download.zfsonlinux.org/fedora-testing/$releasever/$basearch/
enabled<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
metadata_expire<span style=color:#f92672>=</span>7d
gpgcheck<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
gpgkey<span style=color:#f92672>=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-zfsonlinux

<span style=color:#f92672>[</span>zfs-testing-source<span style=color:#f92672>]</span>
name<span style=color:#f92672>=</span>ZFS on Linux <span style=color:#66d9ef>for</span> Fedora $releasever - Testing Source
baseurl<span style=color:#f92672>=</span>http://download.zfsonlinux.org/fedora-testing/$releasever/SRPMS/
enabled<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
gpgcheck<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
gpgkey<span style=color:#f92672>=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-zfsonlinux

$ sudo proxychains dnf install -y kernel-devel
$ sudo proxychains dnf install -y zfs
$ sudo modprobe zfs
$ echo zfs | sudo tee /etc/modules-load.d/zfs.conf <span style=color:#75715e># 可选</span>
$ sudo dnf config-manager --set-disabled zfs
</code></pre></div><h3 id=virt-managerhttpsfedoramagazineorgfull-virtualization-system-on-fedora-workstation-30><a href=https://fedoramagazine.org/full-virtualization-system-on-fedora-workstation-30/>virt-manager</a><a hidden class=anchor aria-hidden=true href=#virt-managerhttpsfedoramagazineorgfull-virtualization-system-on-fedora-workstation-30>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf install @virtualization
$ sudo vi /etc/libvirt/libvirtd.conf
unix_sock_group <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;libvirt&#34;</span>
unix_sock_rw_perms <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0770&#34;</span>
$ sudo systemctl restart libvirtd
$ sudo usermod -a -G libvirt <span style=color:#66d9ef>$(</span>whoami<span style=color:#66d9ef>)</span>
</code></pre></div><p>Now you must log out and log in to apply the changes.</p>
<h3 id=vscode>VSCode<a hidden class=anchor aria-hidden=true href=#vscode>#</a></h3>
<p><a href=https://code.visualstudio.com/docs/setup/linux#_rhel-fedora-and-centos-based-distributions><strong>Visual Studio Code on Linux</strong></a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo tee -a /etc/yum.repos.d/vscode.repo <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span><span style=color:#e6db74>[code]
</span><span style=color:#e6db74>name=Visual Studio Code
</span><span style=color:#e6db74>baseurl=https://packages.microsoft.com/yumrepos/vscode
</span><span style=color:#e6db74>enabled=1
</span><span style=color:#e6db74>gpgcheck=1
</span><span style=color:#e6db74>gpgkey=https://packages.microsoft.com/keys/microsoft.asc
</span><span style=color:#e6db74>EOF</span>
$ sudo dnf install code
</code></pre></div><p><a href=https://github.com/VSCodium/vscodium><strong>VSCodium</strong></a></p>
<p>Binary releases of VS Code without MS branding/telemetry/licensing.</p>
<p><a href=https://gitlab.com/paulcarroty/vscodium-deb-rpm-repo>vscodium-deb-rpm-repo</a>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo tee -a /etc/yum.repos.d/vscodium.repo <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span><span style=color:#e6db74>[gitlab.com_paulcarroty_vscodium_repo]
</span><span style=color:#e6db74>name=gitlab.com_paulcarroty_vscodium_repo
</span><span style=color:#e6db74>baseurl=https://paulcarroty.gitlab.io/vscodium-deb-rpm-repo/rpms/
</span><span style=color:#e6db74>enabled=1
</span><span style=color:#e6db74>gpgcheck=1
</span><span style=color:#e6db74>repo_gpgcheck=1
</span><span style=color:#e6db74>gpgkey=https://gitlab.com/paulcarroty/vscodium-deb-rpm-repo/raw/master/pub.gpg
</span><span style=color:#e6db74>metadata_expire=1h
</span><span style=color:#e6db74>EOF</span>
$ dnf install codium
</code></pre></div><h2 id=fedora-system>Fedora System<a hidden class=anchor aria-hidden=true href=#fedora-system>#</a></h2>
<h3 id=package-manager>Package Manager<a hidden class=anchor aria-hidden=true href=#package-manager>#</a></h3>
<h4 id=managing-dnf-repositoryhttpsdocsfedoraprojectorgen-usfedora23htmlsystem_administrators_guidesec-managing_dnf_repositorieshtml><a href=https://docs.fedoraproject.org/en-US/Fedora/23/html/System_Administrators_Guide/sec-Managing_DNF_Repositories.html>Managing DNF Repository</a><a hidden class=anchor aria-hidden=true href=#managing-dnf-repositoryhttpsdocsfedoraprojectorgen-usfedora23htmlsystem_administrators_guidesec-managing_dnf_repositorieshtml>#</a></h4>
<p>DNF repositories commonly provide their own <code>.repo</code> file. To add such a repository to your system and enable it, run the following command as <code>root</code>:</p>
<pre tabindex=0><code>dnf config-manager --add-repo repository_url
</code></pre><p>To enable a particular repository or repositories, type the following at a shell prompt as <code>root</code>:</p>
<pre tabindex=0><code>dnf config-manager --set-enabled repository…
</code></pre><p>To disable a DNF repository, run the following command as <code>root</code>:</p>
<pre tabindex=0><code>dnf config-manager --set-disabled repository…
</code></pre><p>For example, Google Chrome Repository：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cat /etc/yum.repos.d/google-chrome.repo 
<span style=color:#f92672>[</span>google-chrome<span style=color:#f92672>]</span>
name<span style=color:#f92672>=</span>google-chrome
baseurl<span style=color:#f92672>=</span>https://dl.google.com/linux/chrome/rpm/stable/x86_64
enabled<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
gpgcheck<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
gpgkey<span style=color:#f92672>=</span>https://dl.google.com/linux/linux_signing_key.pub

$ sudo dnf config-manager --set-enabled google-chrome
$ sudo dnf install google-chrome-stable
</code></pre></div><h4 id=dnf-system-upgradehttpsdocsfedoraprojectorgen-usquick-docsdnf-system-upgrade><a href=https://docs.fedoraproject.org/en-US/quick-docs/dnf-system-upgrade/>DNF System Upgrade</a><a hidden class=anchor aria-hidden=true href=#dnf-system-upgradehttpsdocsfedoraprojectorgen-usquick-docsdnf-system-upgrade>#</a></h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf upgrade --refresh
$ sudo reboot
$ sudo dnf install dnf-plugin-system-upgrade
$ sudo dnf system-upgrade download --releasever<span style=color:#f92672>=</span><span style=color:#ae81ff>35</span>
$ sudo dnf system-upgrade reboot
</code></pre></div><ul>
<li>Change the <code>--releasever=</code> number if you want to upgrade to a different release.</li>
<li>If some of your packages have unsatisfied dependencies, the upgrade will refuse to continue until you run it again with an extra <code>--allowerasing</code> option. This often happens with packages installed from third-party repositories for which an updated repositories hasn’t been yet published. Study the output very carefully and examine which packages are going to be removed. None of them should be essential for system functionality, but some of them might be important for your productivity.
<ul>
<li>In case of unsatisfied dependencies, you can sometimes see more details if you add <code>--best</code> option to the command line.</li>
<li>If you want to remove/install some packages manually before running <code>dnf system-upgrade download</code> again, it is advisable to perform those operations with <code>--setopt=keepcache=1</code> dnf command line option. Otherwise the whole package cache will be removed after your operation, and you will need to download all the packages once again.</li>
</ul>
</li>
<li>There are other <strong>important optional operations</strong> here, please read the official documentation.</li>
</ul>
<h4 id=dnf-local-pluginhttpsfedoramagazineorguse-the-dnf-local-plugin-to-speed-up-your-home-lab><a href=https://fedoramagazine.org/use-the-dnf-local-plugin-to-speed-up-your-home-lab/>DNF local plugin</a><a hidden class=anchor aria-hidden=true href=#dnf-local-pluginhttpsfedoramagazineorguse-the-dnf-local-plugin-to-speed-up-your-home-lab>#</a></h4>
<p>An internet search yields two common solutions that eliminate or reduce repeat downloads of the same RPM set – create a private Fedora Linux mirror or set up a caching proxy.</p>
<p>Fedora provides guidance on setting up a [private mirror](<a href=https://fedoraproject.org/wiki/>https://fedoraproject.org/wiki/</a> Infrastructure/Mirroring#How_can_someone_make_a_private_mirror). A mirror requires a lot of bandwidth and disk space and significant work to maintain. A full private mirror would be too expensive and it would be overkill for my purposes.</p>
<p>The most common solution I found online was to implement a caching proxy using Squid. I had two concerns with this type of solution. First, I would need to edit repository definitions stored in <em>/etc/yum.repo.d</em> on each virtual and physical machine or container to use the same mirror. Second, I would need to use <em>http</em> and not <em>https</em> connections which would introduce a security risk.</p>
<p>After reading Glenn’s 2018 post on the DNF local plugin, I searched for additional information but could not find much of anything besides the sparse documentation for the plugin on the DNF documentation web site. This article is intended to raise awareness of this plugin.</p>
<h4 id=use-dns-over-tlshttpsfedoramagazineorguse-dns-over-tls><a href=https://fedoramagazine.org/use-dns-over-tls/>Use DNS over TLS</a><a hidden class=anchor aria-hidden=true href=#use-dns-over-tlshttpsfedoramagazineorguse-dns-over-tls>#</a></h4>
<h4 id=dnf-updateinfohttpsfedoramagazineorguse-dnf-updateinfo-to-read-update-changelogs><a href=https://fedoramagazine.org/use-dnf-updateinfo-to-read-update-changelogs/>dnf updateinfo</a><a hidden class=anchor aria-hidden=true href=#dnf-updateinfohttpsfedoramagazineorguse-dnf-updateinfo-to-read-update-changelogs>#</a></h4>
<p>First, check the updates available:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dnf check-update
</code></pre></div><p>OK, so run your first <em>dnf updateinfo</em> command:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dnf updateinfo
</code></pre></div><p>Look at the list of updates and which types they belong to:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dnf updateinfo list
</code></pre></div><p>The next command will list the actual changelog.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dnf updateinfo info
</code></pre></div><p><a href=https://fedoramagazine.org/how-to-install-only-security-and-bugfixes-updates-with-dnf/>install only security and bugfixes updates</a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dnf check-update --security --bugfix
$ sudo dnf update --security --bugfix
</code></pre></div><p>Install only specific updates</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf update --advisories<span style=color:#f92672>=</span>FEDORA-2021-74ebf2f06f,FEDORA-2021-83fdddca0f
</code></pre></div><h3 id=xfs-檔案系統簡介httpslinuxvbirdorglinux_basiccentos70230filesystemphpharddisk-xfs><a href=https://linux.vbird.org/linux_basic/centos7/0230filesystem.php#harddisk-xfs>XFS 檔案系統簡介</a><a hidden class=anchor aria-hidden=true href=#xfs-檔案系統簡介httpslinuxvbirdorglinux_basiccentos70230filesystemphpharddisk-xfs>#</a></h3>
<p>CentOS 7 開始，預設的檔案系統已經由原本的 EXT4 變成了 XFS 檔案系統了！為啥 CentOS 要捨棄對 Linux 支援度最完整的 EXT 家族而改用 XFS 呢？ 這是有一些原因存在的。</p>
<p><strong>EXT 家族當前較傷腦筋的地方：支援度最廣，但格式化超慢！</strong></p>
<p>Ext 檔案系統家族對於檔案格式化的處理方面，採用的是預先規劃出所有的 inode/block/meta data 等資料，未來系統可以直接取用， 不需要再進行動態配置的作法。這個作法在早期磁碟容量還不大的時候還算 OK 沒啥問題，但時至今日，磁碟容量越來越大，連傳統的 MBR 都已經被 GPT 所取代，連我們這些老人家以前聽到的超大 TB 容量也已經不夠看了！現在都已經說到 PB 或 EB 以上容量了呢！那妳可以想像得到，當你的 TB 以上等級的傳統 ext 家族檔案系統在格式化的時候，光是系統要預先分配 inode 與 block 就消耗你好多好多的人類時間了&mldr;</p>
<p>Tips：之前格式化過一個 70 TB 以上的磁碟陣列成為 ext4 檔案系統，按下格式化，去喝了咖啡、吃了便當才回來看做完了沒有&mldr; 所以，後來立刻改成 xfs 檔案系統了。</p>
<p>另外，由於虛擬化的應用越來越廣泛，而作為虛擬化磁碟來源的巨型檔案 (單一檔案好幾個 GB 以上！) 也就越來越常見了。 這種巨型檔案在處理上需要考慮到效能問題，否則虛擬磁碟的效率就會不太好看。因此，從 CentOS 7.x 開始， 檔案系統已經由預設的 Ext4 變成了 xfs 這一個較適合高容量磁碟與巨型檔案效能較佳的檔案系統了。</p>
<p>Tips：其實鳥哥有幾組虛擬電腦教室伺服器系統，裡面跑的確實是 EXT4 檔案系統，老實說，並不覺得比 xfs 慢！所以，對鳥哥來說， 效能並不是主要改變檔案系統的考量！對於檔案系統的復原速度、建置速度，可能才是鳥哥改換成 xfs 的思考點。</p>
<p><strong>XFS 檔案系統的配置</strong></p>
<p>基本上 xfs 就是一個日誌式檔案系統，而 CentOS 7.x 拿它當預設的檔案系統，自然就是因為最早之前，這個 xfs 就是被開發來用於高容量磁碟以及高效能檔案系統之用， 因此，相當適合現在的系統環境。此外，幾乎所有 Ext4 檔案系統有的功能， xfs 都可以具備！也因此在本小節前幾部份談到檔案系統時， 其實大部份的操作依舊是在 xfs 檔案系統環境下介紹給各位的哩！</p>
<p>xfs 檔案系統在資料的分佈上，主要規劃為三個部份，一個資料區 (data section)、一個檔案系統活動登錄區 (log section)以及一個即時運作區 (realtime section)。 這三個區域的資料內容如下：</p>
<ul>
<li>資料區 (data section)</li>
</ul>
<p>基本上，資料區就跟我們之前談到的 ext 家族一樣，包括 inode/data block/superblock 等資料，都放置在這個區塊。 這個資料區與 ext 家族的 block group 類似，也是分為多個儲存區群組 (allocation groups) 來分別放置檔案系統所需要的資料。 每個儲存區群組都包含了 (1)整個檔案系統的 superblock、 (2)剩餘空間的管理機制、 (3)inode的分配與追蹤。此外，inode與 block 都是系統需要用到時， 這才動態配置產生，所以格式化動作超級快！</p>
<p>另外，與 ext 家族不同的是， xfs 的 block 與 inode 有多種不同的容量可供設定，block 容量可由 512bytes ~ 64K 調配，不過，Linux 的環境下， 由於記憶體控制的關係 (分頁檔 pagesize 的容量之故)，因此最高可以使用的 block 大小為 4K 而已！(鳥哥嘗試格式化 block 成為 16K 是沒問題的，不過，Linux 核心不給掛載！ 所以格式化完成後也無法使用啦！) 至於 inode 容量可由 256bytes 到 2M 這麼大！不過，大概還是保留 256bytes 的預設值就很夠用了！</p>
<p>Tips：總之， xfs 的這個資料區的儲存區群組 (allocation groups, AG)，你就將它想成是 ext 家族的 block 群組 (block groups) 就對了！本小節之前講的都可以在這個區塊內使用。 只是 inode 與 block 是動態產生，並非一開始於格式化就完成配置的。</p>
<ul>
<li>檔案系統活動登錄區 (log section)</li>
</ul>
<p>在登錄區這個區域主要被用來紀錄檔案系統的變化，其實有點像是日誌區啦！檔案的變化會在這裡紀錄下來，直到該變化完整的寫入到資料區後， 該筆紀錄才會被終結。如果檔案系統因為某些緣故 (例如最常見的停電) 而損毀時，系統會拿這個登錄區塊來進行檢驗，看看系統掛掉之前， 檔案系統正在運作些啥動作，藉以快速的修復檔案系統。</p>
<p>因為系統所有動作的時候都會在這個區塊做個紀錄，因此這個區塊的磁碟活動是相當頻繁的！xfs 設計有點有趣，在這個區域中， 妳可以指定外部的磁碟來作為 xfs 檔案系統的日誌區塊喔！例如，妳可以將 SSD 磁碟作為 xfs 的登錄區，這樣當系統需要進行任何活動時， 就可以更快速的進行工作！相當有趣！</p>
<ul>
<li>即時運作區 (realtime section)</li>
</ul>
<p>當有檔案要被建立時，xfs 會在這個區段裡面找一個到數個的 extent 區塊，將檔案放置在這個區塊內，等到分配完畢後，再寫入到 data section 的 inode 與 block 去！ 這個 extent 區塊的大小得要在格式化的時候就先指定，最小值是 4K 最大可到 1G。一般非磁碟陣列的磁碟預設為 64K 容量，而具有類似磁碟陣列的 stripe 情況下，則建議 extent 設定為與 stripe 一樣大較佳。這個 extent 最好不要亂動，因為可能會影響到實體磁碟的效能喔。</p>
<p><strong>XFS 檔案系統的描述資料觀察</strong></p>
<p>剛剛講了這麼多，完全無法理會耶～有沒有像 EXT 家族的 dumpe2fs 去觀察 superblock 內容的相關指令可以查閱呢？有啦！可以使用 xfs_info 去觀察的！ 詳細的指令作法可以參考如下：</p>
<pre tabindex=0><code>[root@study ~]# xfs_info 掛載點|裝置檔名

範例一：找出系統 /boot 這個掛載點底下的檔案系統的 superblock 紀錄
[root@study ~]# df -T /boot
Filesystem     Type 1K-blocks   Used Available Use% Mounted on
/dev/vda2      xfs    1038336 133704    904632  13% /boot
# 沒錯！可以看得出來是 xfs 檔案系統的！來觀察一下內容吧！

[root@study ~]# xfs_info /dev/vda2
1  meta-data=/dev/vda2         isize=256    agcount=4, agsize=65536 blks
2           =                  sectsz=512   attr=2, projid32bit=1
3           =                  crc=0        finobt=0
4  data     =                  bsize=4096   blocks=262144, imaxpct=25
5           =                  sunit=0      swidth=0 blks
6  naming   =version 2         bsize=4096   ascii-ci=0 ftype=0
7  log      =internal          bsize=4096   blocks=2560, version=2
8           =                  sectsz=512   sunit=0 blks, lazy-count=1
9  realtime =none              extsz=4096   blocks=0, rtextents=0
</code></pre><p>上面的輸出訊息可以這樣解釋：</p>
<ul>
<li>第 1 行裡面的 isize 指的是 inode 的容量，每個有 256bytes 這麼大。至於 agcount 則是前面談到的儲存區群組 (allocation group) 的個數，共有 4 個， agsize 則是指每個儲存區群組具有 65536 個 block 。配合第 4 行的 block 設定為 4K，因此整個檔案系統的容量應該就是 4<em>65536</em>4K 這麼大！</li>
<li>第 2 行裡面 sectsz 指的是邏輯磁區 (sector) 的容量設定為 512bytes 這麼大的意思。</li>
<li>第 4 行裡面的 bsize 指的是 block 的容量，每個 block 為 4K 的意思，共有 262144 個 block 在這個檔案系統內。</li>
<li>第 5 行裡面的 sunit 與 swidth 與磁碟陣列的 stripe 相關性較高。這部份我們底下格式化的時候會舉一個例子來說明。</li>
<li>第 7 行裡面的 internal 指的是這個登錄區的位置在檔案系統內，而不是外部設備的意思。且佔用了 4K * 2560 個 block，總共約 10M 的容量。</li>
<li>第 9 行裡面的 realtime 區域，裡面的 extent 容量為 4K。不過目前沒有使用。</li>
</ul>
<p>由於我們並沒有使用磁碟陣列，因此上頭這個裝置裡頭的 sunit 與 extent 就沒有額外的指定特別的值。根據 xfs(5) 的說明，這兩個值會影響到你的檔案系統性能， 所以格式化的時候要特別留意喔！上面的說明大致上看看即可，比較重要的部份已經用特殊字體圈起來，你可以瞧一瞧先！</p>
<h3 id=rosettahttpswikiarchlinuxorgtitlepacmanrosetta><a href=https://wiki.archlinux.org/title/Pacman/Rosetta>Rosetta</a><a hidden class=anchor aria-hidden=true href=#rosettahttpswikiarchlinuxorgtitlepacmanrosetta>#</a></h3>
<p>由于我主要使用 ubuntu，为学习而使用 fedora，只是短时期使用过其他发行版，因此截取部分如下。</p>
<h4 id=basic-operations>Basic operations<a hidden class=anchor aria-hidden=true href=#basic-operations>#</a></h4>
<table>
<thead>
<tr>
<th style=text-align:center>Action</th>
<th style=text-align:center>Red Hat/Fedora</th>
<th style=text-align:center>Debian/Ubuntu</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>Search for package(s) by searching the expression in name, description, short description. What exact fields are being searched by default varies in each tool. Mostly options bring tools on par.</td>
<td style=text-align:center><code>dnf search</code></td>
<td style=text-align:center><code>apt search</code></td>
</tr>
<tr>
<td style=text-align:center>Install a package(s) by name</td>
<td style=text-align:center><code>dnf install</code></td>
<td style=text-align:center><code>apt install</code></td>
</tr>
<tr>
<td style=text-align:center>Upgrade Packages - Install packages which have an older version already installed</td>
<td style=text-align:center><code>dnf upgrade</code></td>
<td style=text-align:center><code>apt update</code> and then <code>apt upgrade</code></td>
</tr>
<tr>
<td style=text-align:center>Upgrade Packages - Another form of the update command, which can perform more complex updates &ndash; like distribution upgrades. When the usual update command will omit package updates, which include changes in dependencies, this command can perform those updates.</td>
<td style=text-align:center><code>dnf distro-sync</code></td>
<td style=text-align:center><code>apt update</code> and then <code>apt dist-upgrade</code></td>
</tr>
<tr>
<td style=text-align:center>Remove a package(s) and all dependencies by name</td>
<td style=text-align:center><code>dnf remove</code></td>
<td style=text-align:center><code>apt autoremove</code></td>
</tr>
<tr>
<td style=text-align:center>Remove a package(s) and its configuration files</td>
<td style=text-align:center>?</td>
<td style=text-align:center><code>apt purge</code></td>
</tr>
<tr>
<td style=text-align:center>Remove a package(s) and all dependencies and configuration files</td>
<td style=text-align:center>?</td>
<td style=text-align:center><code>apt autoremove --purge</code></td>
</tr>
<tr>
<td style=text-align:center>Remove dependencies that are no longer needed (orphans), because e.g. the package which needed the dependencies was removed.</td>
<td style=text-align:center><code>dnf autoremove</code></td>
<td style=text-align:center><code>apt autoremove</code></td>
</tr>
<tr>
<td style=text-align:center>Remove packages no longer included in any repositories.</td>
<td style=text-align:center><code>dnf repoquery --extras</code></td>
<td style=text-align:center><code>aptitude purge '~o'</code></td>
</tr>
<tr>
<td style=text-align:center>Mark a package previously installed as a dependency as explicitly required.</td>
<td style=text-align:center><code>dnf mark install</code></td>
<td style=text-align:center><code>apt-mark manual</code></td>
</tr>
<tr>
<td style=text-align:center>Install package(s) as dependency / without marking as explicitly required.</td>
<td style=text-align:center><code>dnf install</code> and then <code>dnf mark remove</code></td>
<td style=text-align:center><code>apt-mark auto</code></td>
</tr>
<tr>
<td style=text-align:center>Only downloads the given package(s) without unpacking or installing them</td>
<td style=text-align:center><code>dnf download</code></td>
<td style=text-align:center><code>apt install --download-only</code> (into the package cache) or <code>apt download</code> (bypass the package cache)</td>
</tr>
<tr>
<td style=text-align:center>Clean up all local caches. Options might limit what is actually cleaned.</td>
<td style=text-align:center><code>dnf clean all</code></td>
<td style=text-align:center><code>apt autoclean</code> removes only unneeded, obsolete information or <code>apt clean</code></td>
</tr>
<tr>
<td style=text-align:center>Start a shell to enter multiple commands in one session</td>
<td style=text-align:center><code>dnf shell</code></td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center>Show a log of actions taken by the software management.</td>
<td style=text-align:center><code>dnf history</code></td>
<td style=text-align:center>read <code>/var/log/dpkg.log</code></td>
</tr>
<tr>
<td style=text-align:center>Get a dump of the whole system information - Prints, Saves or similar the current state of the package management system. Preferred output is text or XML. (Note: Why either-or here? No tool offers the option to choose the output format.)</td>
<td style=text-align:center>see <code>/var/lib/rpm/Packages</code></td>
<td style=text-align:center><code>apt-cache stats</code></td>
</tr>
<tr>
<td style=text-align:center>e-mail delivery of package changes</td>
<td style=text-align:center></td>
<td style=text-align:center><code>apt install apt-listchanges</code></td>
</tr>
</tbody>
</table>
<h4 id=querying-specific-packages>Querying specific packages<a hidden class=anchor aria-hidden=true href=#querying-specific-packages>#</a></h4>
<table>
<thead>
<tr>
<th style=text-align:center>Action</th>
<th style=text-align:center>Red Hat/Fedora</th>
<th style=text-align:center>Debian/Ubuntu</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>Show all or most information about a package. The tools' verbosity for the default command vary. But with options, the tools are on par with each other.</td>
<td style=text-align:center><code>dnf list</code> or <code>dnf info</code></td>
<td style=text-align:center><code>apt show</code> or <code>apt-cache policy</code></td>
</tr>
<tr>
<td style=text-align:center>Display local package information: Name, version, description, etc.</td>
<td style=text-align:center><code>rpm -qi</code> / <code>dnf info installed</code></td>
<td style=text-align:center><code>dpkg -s</code> or <code>aptitude show</code></td>
</tr>
<tr>
<td style=text-align:center>Display remote package information: Name, version, description, etc.</td>
<td style=text-align:center><code>dnf info</code></td>
<td style=text-align:center><code>apt-cache show</code> or <code>aptitude show</code></td>
</tr>
<tr>
<td style=text-align:center>Display files provided by local package</td>
<td style=text-align:center><code>rpm -ql</code></td>
<td style=text-align:center><code>dpkg -L</code></td>
</tr>
<tr>
<td style=text-align:center>Display files provided by a remote package</td>
<td style=text-align:center><code>dnf repoquery -l</code> or <code>repoquery -l</code> (from package yum-utils)</td>
<td style=text-align:center><code>apt-file list</code></td>
</tr>
<tr>
<td style=text-align:center>Query the package which provides FILE</td>
<td style=text-align:center><code>rpm -qf</code> (installed only) or <code>dnf provides</code> (everything) or <code>repoquery -f</code> (from package yum-utils)</td>
<td style=text-align:center><code>dpkg -S</code> or <code>dlocate</code></td>
</tr>
<tr>
<td style=text-align:center>List the files that the package holds. Again, this functionality can be mimicked by other more complex commands.</td>
<td style=text-align:center><code>dnf repoquery -l</code></td>
<td style=text-align:center><code>dpkg-query -L</code></td>
</tr>
<tr>
<td style=text-align:center>Displays packages which provide the given exp. aka reverse provides. Mainly a shortcut to search a specific field. Other tools might offer this functionality through the search command.</td>
<td style=text-align:center><code>dnf provides</code></td>
<td style=text-align:center><code>apt-file search</code></td>
</tr>
<tr>
<td style=text-align:center>Search all packages to find the one which holds the specified file.</td>
<td style=text-align:center><code>dnf provides</code></td>
<td style=text-align:center><code>apt-file search</code> or <code>auto-apt</code> is using this functionality.</td>
</tr>
<tr>
<td style=text-align:center>Show the changelog of a package</td>
<td style=text-align:center><code>dnf changelog</code></td>
<td style=text-align:center><code>apt-get changelog</code></td>
</tr>
</tbody>
</table>
<h4 id=querying-package-lists>Querying package lists<a hidden class=anchor aria-hidden=true href=#querying-package-lists>#</a></h4>
<table>
<thead>
<tr>
<th style=text-align:center>Action</th>
<th style=text-align:center>Red Hat/Fedora</th>
<th style=text-align:center>Debian/Ubuntu</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>Search for package(s) by searching the expression in name, description, short description. What exact fields are being searched by default varies in each tool. Mostly options bring tools on par.</td>
<td style=text-align:center><code>dnf search</code></td>
<td style=text-align:center><code>apt search</code></td>
</tr>
<tr>
<td style=text-align:center>Lists packages which have an update available. Note: Some provide special commands to limit the output to certain installation sources, others use options.</td>
<td style=text-align:center><code>dnf list updates</code> or <code>dnf check-update</code></td>
<td style=text-align:center><code>apt list --upgradable</code></td>
</tr>
<tr>
<td style=text-align:center>Display a list of all packages in all installation sources that are handled by the packages management. Some tools provide options or additional commands to limit the output to a specific installation source.</td>
<td style=text-align:center><code>dnf list available</code></td>
<td style=text-align:center><code>apt-cache dumpavail</code> or <code>apt-cache dump</code> (Cache only) or <code>apt-cache pkgnames</code></td>
</tr>
<tr>
<td style=text-align:center>Generates a list of installed packages</td>
<td style=text-align:center><code>dnf list installed</code></td>
<td style=text-align:center>`dpkg &ndash;list</td>
</tr>
<tr>
<td style=text-align:center>List packages that are installed but are not available in any installation source (anymore).</td>
<td style=text-align:center><code>dnf list extras</code></td>
<td style=text-align:center>`apt &ndash;installed list</td>
</tr>
<tr>
<td style=text-align:center>List packages that were recently added to one of the installation sources, i.e. which are new to it.</td>
<td style=text-align:center><code>dnf list recent</code></td>
<td style=text-align:center><code>aptitude search '~N'</code> or <code>aptitude forget-new</code></td>
</tr>
<tr>
<td style=text-align:center>List installed local packages along with version</td>
<td style=text-align:center><code>rpm -qa</code></td>
<td style=text-align:center><code>dpkg -l</code> or <code>apt list --installed</code></td>
</tr>
<tr>
<td style=text-align:center>Search locally installed package for names or descriptions</td>
<td style=text-align:center><code>rpm -qa '*&lt;str>*'</code></td>
<td style=text-align:center>`aptitude search &lsquo;~i(~n $name</td>
</tr>
<tr>
<td style=text-align:center>List packages not required by any other package</td>
<td style=text-align:center><code>dnf leaves</code> or <code>package-cleanup --leaves --all</code></td>
<td style=text-align:center><code>deborphan -anp1</code></td>
</tr>
<tr>
<td style=text-align:center>List packages installed explicitly (not as dependencies)</td>
<td style=text-align:center><code>dnf history userinstalled</code></td>
<td style=text-align:center><code>apt-mark showmanual</code></td>
</tr>
<tr>
<td style=text-align:center>List packages installed automatically (as dependencies)</td>
<td style=text-align:center>grep -E &lsquo;^i[^+]&rsquo; (workaround)</td>
<td style=text-align:center><code>apt-mark showauto</code></td>
</tr>
</tbody>
</table>
<h4 id=querying-package-dependencies>Querying package dependencies<a hidden class=anchor aria-hidden=true href=#querying-package-dependencies>#</a></h4>
<table>
<thead>
<tr>
<th style=text-align:center>Action</th>
<th style=text-align:center>Red Hat/Fedora</th>
<th style=text-align:center>Debian/Ubuntu</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>Display packages which require X to be installed, aka show reverse dependencies.</td>
<td style=text-align:center><code>dnf repoquery --alldeps --whatrequires</code> or <code>repoquery --whatrequires</code></td>
<td style=text-align:center><code>apt-cache rdepends</code> or <code>aptitude search ~D$pattern</code></td>
</tr>
<tr>
<td style=text-align:center>Display packages which conflict with given expression (often package). Search can be used as well to mimic this function.</td>
<td style=text-align:center><code>dnf repoquery --conflicts</code></td>
<td style=text-align:center><code>aptitude search '~C$pattern'</code></td>
</tr>
<tr>
<td style=text-align:center>List all packages which are required for the given package, aka show dependencies.</td>
<td style=text-align:center><code>dnf repoquery --requires</code> or <code>repoquery -R</code></td>
<td style=text-align:center><code>apt-cache depends</code> or <code>apt-cache show</code></td>
</tr>
<tr>
<td style=text-align:center>List what the current package provides</td>
<td style=text-align:center><code>dnf repoquery --provides</code></td>
<td style=text-align:center><code>dpkg -s</code> or <code>aptitude show</code></td>
</tr>
<tr>
<td style=text-align:center>List all packages that require a particular package</td>
<td style=text-align:center><code>dnf repoquery --installed --alldeps --whatrequires</code></td>
<td style=text-align:center><code>aptitude search ~D{depends,recommends,suggests}:$pattern</code> or <code>aptitude why</code></td>
</tr>
<tr>
<td style=text-align:center>Display all packages that the specified packages obsoletes.</td>
<td style=text-align:center><code>dnf list obsoletes</code></td>
<td style=text-align:center><code>apt-cache show</code></td>
</tr>
<tr>
<td style=text-align:center>Generates an output suitable for processing with dotty for the given package(s).</td>
<td style=text-align:center></td>
<td style=text-align:center><code>apt-cache dotty</code></td>
</tr>
</tbody>
</table>
<h4 id=installation-sources-management>Installation sources management<a hidden class=anchor aria-hidden=true href=#installation-sources-management>#</a></h4>
<table>
<thead>
<tr>
<th style=text-align:center>Action</th>
<th style=text-align:center>Red Hat/Fedora</th>
<th style=text-align:center>Debian/Ubuntu</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>Installation sources management</td>
<td style=text-align:center>edit <code>/etc/yum.repos.d/${REPO}.repo</code></td>
<td style=text-align:center>edit <code>/etc/apt/sources.list</code></td>
</tr>
<tr>
<td style=text-align:center>Add an installation source to the system. Some tools provide additional commands for certain sources, others allow all types of source URI for the add command. Again others, like apt and dnf force editing a sources list. apt-cdrom is a special command, which offers special options design for CDs/DVDs as source.</td>
<td style=text-align:center><code>/etc/yum.repos.d/*.repo</code></td>
<td style=text-align:center><code>apt-cdrom add</code></td>
</tr>
<tr>
<td style=text-align:center>Refresh the information about the specified installation source(s) or all installation sources.</td>
<td style=text-align:center><code>dnf clean expire-cache</code> and then <code>dnf check-update</code></td>
<td style=text-align:center><code>apt-get update</code></td>
</tr>
<tr>
<td style=text-align:center>Prints a list of all installation sources including important information like URI, alias etc.</td>
<td style=text-align:center><code>cat /etc/yum.repos.d/*</code></td>
<td style=text-align:center><code>apt-cache policy</code></td>
</tr>
<tr>
<td style=text-align:center>List all packages from a certain repo</td>
<td style=text-align:center></td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center>Disable an installation source for an operation</td>
<td style=text-align:center><code>dnf --disablerepo=</code></td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center>Download packages from a different version of the distribution than the one installed.</td>
<td style=text-align:center><code>dnf --releasever=</code></td>
<td style=text-align:center><code>apt-get install -t release package</code> or <code>apt-get install package/release</code> (dependencies not covered)</td>
</tr>
</tbody>
</table>
<h4 id=overrides>Overrides<a hidden class=anchor aria-hidden=true href=#overrides>#</a></h4>
<table>
<thead>
<tr>
<th style=text-align:center>Action</th>
<th style=text-align:center>Red Hat/Fedora</th>
<th style=text-align:center>Debian/Ubuntu</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>Add a package lock rule to keep its current state from being changed</td>
<td style=text-align:center>edit <code>dnf.conf</code> adding/amending the <code>exclude</code> option</td>
<td style=text-align:center><code>apt-mark hold pkg</code></td>
</tr>
<tr>
<td style=text-align:center>Delete a package lock rule</td>
<td style=text-align:center></td>
<td style=text-align:center><code>apt-mark unhold pkg</code></td>
</tr>
<tr>
<td style=text-align:center>Show a listing of all lock rules</td>
<td style=text-align:center></td>
<td style=text-align:center><code>/etc/apt/preferences</code></td>
</tr>
<tr>
<td style=text-align:center>Set the priority of the given package to avoid upgrade, force downgrade or to overwrite any default behavior. Can also be used to prefer a package version from a certain installation source.</td>
<td style=text-align:center></td>
<td style=text-align:center><code>/etc/apt/preferences</code>, <code>apt-cache policy</code></td>
</tr>
<tr>
<td style=text-align:center>Remove a previously set priority</td>
<td style=text-align:center></td>
<td style=text-align:center><code>/etc/apt/preferences</code></td>
</tr>
<tr>
<td style=text-align:center>Show a list of set priorities</td>
<td style=text-align:center></td>
<td style=text-align:center><code>apt-cache policy</code> or <code>/etc/apt/preferences</code></td>
</tr>
<tr>
<td style=text-align:center>Ignore problems that priorities may trigger.</td>
<td style=text-align:center></td>
<td style=text-align:center></td>
</tr>
</tbody>
</table>
<h4 id=verification-and-repair>Verification and repair<a hidden class=anchor aria-hidden=true href=#verification-and-repair>#</a></h4>
<table>
<thead>
<tr>
<th style=text-align:center>Action</th>
<th style=text-align:center>Red Hat/Fedora</th>
<th style=text-align:center>Debian/Ubuntu</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>Verify single package</td>
<td style=text-align:center><code>rpm -V</code></td>
<td style=text-align:center><code>debsums</code></td>
</tr>
<tr>
<td style=text-align:center>Verify all packages</td>
<td style=text-align:center><code>rpm -Va</code></td>
<td style=text-align:center><code>debsums</code></td>
</tr>
<tr>
<td style=text-align:center>Reinstall given package; this will reinstall the given package without dependency hassle</td>
<td style=text-align:center><code>dnf reinstall</code></td>
<td style=text-align:center><code>apt install --reinstall</code></td>
</tr>
<tr>
<td style=text-align:center>Verify dependencies of the complete system; used if installation process was forcefully killed</td>
<td style=text-align:center><code>dnf repoquery --requires</code></td>
<td style=text-align:center><code>apt-get check</code></td>
</tr>
<tr>
<td style=text-align:center>Use some magic to fix broken dependencies in a system</td>
<td style=text-align:center><code>dnf repoquery --unsatisfied</code></td>
<td style=text-align:center><code>apt-get --fix-broken</code> and then <code>aptitude install</code></td>
</tr>
<tr>
<td style=text-align:center>Add a checkpoint to the package system for later rollback</td>
<td style=text-align:center>(unnecessary, it is done on every transaction)</td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center>Remove a checkpoint from the system</td>
<td style=text-align:center>n/a</td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center>Provide a list of all system checkpoints</td>
<td style=text-align:center><code>dnf history list</code></td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center>Rolls entire packages back to a certain date or checkpoint</td>
<td style=text-align:center><code>dnf history rollback</code></td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center>Undo a single specified transaction</td>
<td style=text-align:center><code>dnf history undo</code></td>
<td style=text-align:center></td>
</tr>
</tbody>
</table>
<h4 id=using-package-files-and-building-packages>Using package files and building packages<a hidden class=anchor aria-hidden=true href=#using-package-files-and-building-packages>#</a></h4>
<table>
<thead>
<tr>
<th style=text-align:center>Action</th>
<th style=text-align:center>Red Hat/Fedora</th>
<th style=text-align:center>Debian/Ubuntu</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>Query a package supplied on the command line rather than an entry in the package management database</td>
<td style=text-align:center><code>rpm -qp</code></td>
<td style=text-align:center><code>dpkg -I</code></td>
</tr>
<tr>
<td style=text-align:center>List the contents of a package file</td>
<td style=text-align:center><code>rpmls rpm -qpl</code></td>
<td style=text-align:center><code>dpkg -c</code></td>
</tr>
<tr>
<td style=text-align:center>Install local package file, e.g. app.rpm and uses the installation sources to resolve dependencies</td>
<td style=text-align:center><code>dnf install</code></td>
<td style=text-align:center><code>apt install</code></td>
</tr>
<tr>
<td style=text-align:center>Updates package(s) with local packages and uses the installation sources to resolve dependencies</td>
<td style=text-align:center><code>dnf upgrade</code></td>
<td style=text-align:center><code>debi</code></td>
</tr>
<tr>
<td style=text-align:center>Add a local package to the local package cache mostly for debugging purposes.</td>
<td style=text-align:center></td>
<td style=text-align:center><code>apt-cache add *package-filename*</code></td>
</tr>
<tr>
<td style=text-align:center>Extract a package</td>
<td style=text-align:center>`rpm2cpio</td>
<td style=text-align:center>cpio -vid`</td>
</tr>
<tr>
<td style=text-align:center>Install/Remove packages to satisfy build-dependencies. Uses information in the source package</td>
<td style=text-align:center><code>dnf builddep</code></td>
<td style=text-align:center><code>apt-get build-dep</code></td>
</tr>
<tr>
<td style=text-align:center>Display the source package to the given package name(s)</td>
<td style=text-align:center><code>dnf repoquery -s</code></td>
<td style=text-align:center><code>apt-cache showsrc</code></td>
</tr>
<tr>
<td style=text-align:center>Download the corresponding source package(s) to the given package name(s)</td>
<td style=text-align:center><code>dnf download --source</code></td>
<td style=text-align:center><code>apt-get source</code> or <code>debcheckout</code></td>
</tr>
<tr>
<td style=text-align:center>Build a package</td>
<td style=text-align:center><code>rpmbuild -ba</code> (normal) or <em>mock</em> (in chroot)</td>
<td style=text-align:center><code>debuild</code></td>
</tr>
<tr>
<td style=text-align:center>Check for possible packaging issues</td>
<td style=text-align:center><em>rpmlint</em></td>
<td style=text-align:center><em>lintian</em></td>
</tr>
</tbody>
</table>
<h2 id=fedora-tips>Fedora Tips<a hidden class=anchor aria-hidden=true href=#fedora-tips>#</a></h2>
<h3 id=killhttpswwwcnblogscomsparkdevp6659629html><a href=https://www.cnblogs.com/sparkdev/p/6659629.html>kill</a><a hidden class=anchor aria-hidden=true href=#killhttpswwwcnblogscomsparkdevp6659629html>#</a></h3>
<p>kill 是向进程发送信号的命令。</p>
<table>
<thead>
<tr>
<th>代号</th>
<th>名称</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>SIGHUP</td>
<td>启动被终止的程序，可让该进程重新读取自己的配置文件，类似重新启动。</td>
</tr>
<tr>
<td>2</td>
<td>SIGINT</td>
<td>相当于用键盘输入 [ctrl]-c 来中断一个程序的进行。</td>
</tr>
<tr>
<td>9</td>
<td>SIGKILL</td>
<td>代表强制中断一个程序的进行，如果该程序进行到一半，那么尚未完成的部分可能会有“半产品”产生，类似 vim会有 .filename.swp 保留下来。</td>
</tr>
<tr>
<td>15</td>
<td>SIGTERM</td>
<td>以正常的方式来终止该程序。由于是正常的终止，所以后续的动作会将他完成。不过，如果该程序已经发生问题，就是无法使用正常的方法终止时，输入这个 signal 也是没有用的。</td>
</tr>
<tr>
<td>19</td>
<td>SIGSTOP</td>
<td>相当于用键盘输入 [ctrl]-z 来暂停一个程序的进行。</td>
</tr>
</tbody>
</table>
<h3 id=shell-freezeshttpswikiarchlinuxorgtitlegnometroubleshootingshell_freezes><a href=https://wiki.archlinux.org/title/GNOME/Troubleshooting#Shell_freezes>Shell freezes</a><a hidden class=anchor aria-hidden=true href=#shell-freezeshttpswikiarchlinuxorgtitlegnometroubleshootingshell_freezes>#</a></h3>
<p>In the event of a shell freeze (which might be caused by certain appearance tweaks, malfunctioning extensions or perhaps a lack of available memory), restarting the shell by pressing <code>Alt+F2</code> and then entering <code>r</code> may not be possible.</p>
<p>In this case, try switching to another TTY (<code>Ctrl+Alt+F2</code>) and entering the following command: <code>pkill -HUP gnome-shell</code>. It may take a few seconds before the shell successfully restarts. On X11, restarting the shell in this fashion should not log the user out, but it is a good idea to try and ensure that all work is saved anyway; on Wayland (currently the default), restarting the shell kills the whole session, so everything will be lost.</p>
<p>If this fails, the Xorg server will need to be restarted either by <code>pkill X</code> for console logins or by restarting <code>gdm.service</code> for GDM logins. Bear in mind that restarting the Xorg server will log the user out, so try to ensure that all work is saved before attempting this.</p>
<h4 id=fix-a-frozen-gnome-desktop-sessionhttpswwwaddictivetipscomubuntu-linux-tipsfix-frozen-gnome-desktop-session><a href=https://www.addictivetips.com/ubuntu-linux-tips/fix-frozen-gnome-desktop-session/#>fix a frozen Gnome desktop session</a><a hidden class=anchor aria-hidden=true href=#fix-a-frozen-gnome-desktop-sessionhttpswwwaddictivetipscomubuntu-linux-tipsfix-frozen-gnome-desktop-session>#</a></h4>
<p>在较旧的 Gnome（即 Gnome 3.28 之前）中，您可以使用此命令重新启动 GNome shell。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ glxinfo | grep display
name of display: :1
display: :1  screen: <span style=color:#ae81ff>0</span>
$ touch gnome-restart
$ echo <span style=color:#e6db74>&#39;#!/bin/bash&#39;</span> &gt; gnome-restart
$ echo <span style=color:#e6db74>&#39;DISPLAY=:1 gnome-shell --replace &amp;&#39;</span> &gt;&gt; gnome-restart
$ sudo chmod +x gnome-restart
$ ./gnome-restart
</code></pre></div><h4 id=重启-gnome-shellhttpsbynsscomlinux705736htmlamp><a href=https://bynss.com/linux/705736.html/amp/>重启 Gnome Shell</a><a hidden class=anchor aria-hidden=true href=#重启-gnome-shellhttpsbynsscomlinux705736htmlamp>#</a></h4>
<p>可以使用 <code>busctl --user call org.gnome.Shell /org/gnome/Shell org.gnome.Shell Eval s 'Meta.restart("Restarting…")'</code> 命令行执行 <code>ALT + F2 r</code> 相同的操作。</p>
<p>亦可：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo systemctl restart systemd-logind
</code></pre></div><h3 id=gaming-on-fedorahttpsfedoramagazineorggaming-on-fedora><a href=https://fedoramagazine.org/gaming-on-fedora/>Gaming on Fedora</a><a hidden class=anchor aria-hidden=true href=#gaming-on-fedorahttpsfedoramagazineorggaming-on-fedora>#</a></h3>
<ul>
<li>Nvidia Drivers</li>
<li>Steam(<a href=https://www.protondb.com/>ProtonDB</a>)/<a href=https://lutris.net/>Lutris</a>/<a href=https://q4wine.brezblock.org.ua/>Q4Wine</a></li>
<li>Discord</li>
<li>OBS</li>
<li>GOverlay</li>
</ul>
<h3 id=fedora-33-百度网盘linux版httpsttys3devpostrun-baidunetdisk-on-fedora-is-hard><a href=https://ttys3.dev/post/run-baidunetdisk-on-fedora-is-hard/>Fedora 33 百度网盘Linux版</a><a hidden class=anchor aria-hidden=true href=#fedora-33-百度网盘linux版httpsttys3devpostrun-baidunetdisk-on-fedora-is-hard>#</a></h3>
<p>那个 rpm 包压根不是对标最新的Fedora的，而是给那些基于RHEL的同样使用rpm包管理的古董国产操作系统使用的。</p>
<p>下载 baidunetdisk_3.5.0_amd64.deb，并解压出实际的程序。</p>
<p>首先我们跑一下，看看bt 吧：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Thread <span style=color:#ae81ff>1</span> <span style=color:#e6db74>&#34;baidunetdisk&#34;</span> received signal SIGSEGV, Segmentation fault.
0x00007ffff5096179 in EVP_MD_CTX_clear_flags <span style=color:#f92672>()</span> from /lib64/libcrypto.so.1.1

<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> bt
</code></pre></div><p>目测翻车在<code>libcrypto.so.1.1</code>, 而且是跟sqlite加密有关.</p>
<p>我们把baidunetdisk动态链接到相关的加密库都找出来:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ldd baidunetdisk | grep -i -E <span style=color:#e6db74>&#39;ssl|crypt&#39;</span>
	libgcrypt.so.20 <span style=color:#f92672>=</span>&gt; /lib64/libgcrypt.so.20 <span style=color:#f92672>(</span>0x00007fa18d693000<span style=color:#f92672>)</span>
	libk5crypto.so.3 <span style=color:#f92672>=</span>&gt; /lib64/libk5crypto.so.3 <span style=color:#f92672>(</span>0x00007fa18d3cd000<span style=color:#f92672>)</span>
	libcrypto.so.1.1 <span style=color:#f92672>=</span>&gt; /lib64/libcrypto.so.1.1 <span style=color:#f92672>(</span>0x00007fa18d0c0000<span style=color:#f92672>)</span>
</code></pre></div><p>经验告诉我，这个baidunetdisk挂的原因是， Fedora 33上面的包都比较新，尤其是 openssl 库. 因此，解决办法是，去下载老版本的 Ubuntu 18.04 的包，然后把so文件取出来，强制baidunetdisk使用这些旧版本的库即可.</p>
<p><code>ldd</code> 一下很容易找出依赖关系: <code>libkrb5.so.3</code> -> <code>libk5crypto.so.3</code> -> <code>libcrypto.so.1.1</code></p>
<p>下载以下包:</p>
<pre tabindex=0><code>https://ubuntu.pkgs.org/18.04/ubuntu-main-amd64/libkrb5support0_1.16-2build1_amd64.deb.html
https://ubuntu.pkgs.org/18.04/ubuntu-main-amd64/libk5crypto3_1.16-2build1_amd64.deb.html
https://ubuntu.pkgs.org/18.04/ubuntu-main-amd64/libkrb5-3_1.16-2build1_amd64.deb.html
https://ubuntu.pkgs.org/18.04/ubuntu-main-amd64/libgssapi-krb5-2_1.16-2build1_amd64.deb.html
http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.0g-2ubuntu4_amd64.deb
</code></pre><p>编辑 <code>/usr/share/applications/baidunetdisk.desktop</code>, 将<code>Exec=/opt/baidunetdisk/baidunetdisk --no-sandbox %U</code> 修改成：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Exec<span style=color:#f92672>=</span>/bin/env LD_LIBRARY_PATH<span style=color:#f92672>=</span>/home/ttys3/Apps/baidunetdisk /home/ttys3/Apps/baidunetdisk/baidunetdisk --no-sandbox %U
</code></pre></div><h3 id=ldd-查看程序依赖库httplinuxtools-rstreadthedocsiozh_cnlatesttoollddhtml><a href=http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/ldd.html>ldd 查看程序依赖库</a><a hidden class=anchor aria-hidden=true href=#ldd-查看程序依赖库httplinuxtools-rstreadthedocsiozh_cnlatesttoollddhtml>#</a></h3>
<p>作用：用来查看程式运行所需的共享库,常用来解决程式因缺少某个库文件而不能运行的一些问题。</p>
<p>示例：查看test程序运行所依赖的库:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>/opt/app/todeav1/test$ ldd test
libstdc++.so.6 <span style=color:#f92672>=</span>&gt; /usr/lib64/libstdc++.so.6 <span style=color:#f92672>(</span>0x00000039a7e00000<span style=color:#f92672>)</span>
libm.so.6 <span style=color:#f92672>=</span>&gt; /lib64/libm.so.6 <span style=color:#f92672>(</span>0x0000003996400000<span style=color:#f92672>)</span>
libgcc_s.so.1 <span style=color:#f92672>=</span>&gt; /lib64/libgcc_s.so.1 <span style=color:#f92672>(</span>0x00000039a5600000<span style=color:#f92672>)</span>
libc.so.6 <span style=color:#f92672>=</span>&gt; /lib64/libc.so.6 <span style=color:#f92672>(</span>0x0000003995800000<span style=color:#f92672>)</span>
/lib64/ld-linux-x86-64.so.2 <span style=color:#f92672>(</span>0x0000003995400000<span style=color:#f92672>)</span>
/opt/app/todeav1/test$ ldd libc.so.6
...
</code></pre></div><ul>
<li>第一列：程序需要依赖什么库</li>
<li>第二列: 系统提供的与程序需要的库所对应的库</li>
<li>第三列：库加载的开始地址</li>
</ul>
<p>通过上面的信息，我们可以得到以下几个信息：</p>
<ol>
<li>通过对比第一列和第二列，我们可以分析程序需要依赖的库和系统实际提供的，是否相匹配</li>
<li>通过观察第三列，我们可以知道在当前的库中的符号在对应的进程的地址空间中的开始位置</li>
</ol>
<p>如果依赖的某个库找不到，通过这个命令可以迅速定位问题所在。</p>
<p>原理： ldd不是个可执行程式，而只是个shell脚本； ldd显示可执行模块的dependency的工作原理，其实质是通过ld-linux.so（elf动态库的装载器）来实现的。ld-linux.so模块会先于executable模块程式工作，并获得控制权，因此当上述的那些环境变量被设置时，ld-linux.so选择了显示可执行模块的dependency。</p>
<h3 id=adb-and-fastboot>adb and fastboot<a hidden class=anchor aria-hidden=true href=#adb-and-fastboot>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf install android-tools
</code></pre></div><h3 id=onedrive-加速>OneDrive 加速<a hidden class=anchor aria-hidden=true href=#onedrive-加速>#</a></h3>
<p>OneDrive 的下载速度，明白的都明白，不懂得也就算了 。</p>
<p>PC 端（手机端应该也可以）有一个可能有效的提速方法是：</p>
<ol>
<li>前往：https://tools.ipip.net/traceroute.php</li>
<li>左侧 ipv6 或 ipv4 选择离自己最近的运营商，右侧 ICMP 填入<code>sharepoint.com</code></li>
<li>搜索之后将延时最短的非局域网 ip 填入在<code>hosts</code>文件中</li>
<li>保存，使之生效，可以在控制台<code>ping sharepoint.com</code>查看是否成功解析到新的 ip</li>
</ol>
<h3 id=recover-a-root-passwordhttpsdocsfedoraprojectorgen-usquick-docsreset-root-passwordsect-reset-password-using-the-fedora-live-media><a href=https://docs.fedoraproject.org/en-US/quick-docs/reset-root-password/#sect-reset-password-using-the-fedora-live-media>Recover a root password</a><a hidden class=anchor aria-hidden=true href=#recover-a-root-passwordhttpsdocsfedoraprojectorgen-usquick-docsreset-root-passwordsect-reset-password-using-the-fedora-live-media>#</a></h3>
<ol>
<li>
<p>Boot the Live installation media and choose <code>Try Fedora</code>.</p>
</li>
<li>
<p>From the desktop, open a terminal and switch to root using <code>su</code> (the system will not ask for a password).</p>
</li>
<li>
<p>To view your hard drive device nodes, enter <code>df -H</code> into the terminal. For this example we will use <code>/dev/sda1</code> for the <code>/boot</code> partition and <code>/dev/sda2</code> for the root <code>/</code> partition.</p>
<p>If you are using LVM partitions, type: <code>sudo lvscan</code> and note the <code>/dev</code> path of your root partition. For this example we will use <code>/dev/fedora/root</code>.</p>
</li>
<li>
<p>Create a directory for the mount point (use the <code>-p</code> option to create subdirectories):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir -p /mnt/sysimage/boot
</code></pre></div></li>
<li>
<p>Mount the <code>/</code> (root) partition (be sure to use the actual device node or LVM path of your root <code>/</code> partition):</p>
<p>To mount root on a <strong>standard partition</strong> scheme enter:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mount /dev/sda2 /mnt/sysimage
</code></pre></div><p>To mount root on an <strong>LVM partition</strong> scheme enter:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mount /dev/fedora/root /mnt/sysimage
</code></pre></div></li>
<li>
<p>Continue the process by mounting <code>/boot</code>, <code>proc</code>, <code>/dev</code>, and <code>/run</code> with:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mount /dev/sda1 /mnt/sysimage/boot

mount -t proc none /mnt/sysimage/proc

mount -o bind /dev /mnt/sysimage/dev

mount -o bind /run /mnt/sysimage/run
</code></pre></div></li>
<li>
<p><code>chroot</code> to the mounted root partition with:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>chroot /mnt/sysimage /bin/bash
</code></pre></div></li>
<li>
<p>Change the root password:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>passwd
</code></pre></div></li>
<li>
<p>Exit out of chroot with:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>exit
</code></pre></div><p>and exit out of the terminal.</p>
</li>
<li>
<p>Reboot your system and boot from the hard drive.</p>
</li>
</ol>
<p>Congratulations, your root password has been successfully changed.</p>
<h3 id=samba-serverhttpswwwtecmintcominstall-samba-rhel-centos-fedora><a href=https://www.tecmint.com/install-samba-rhel-centos-fedora/>Samba Server</a><a hidden class=anchor aria-hidden=true href=#samba-serverhttpswwwtecmintcominstall-samba-rhel-centos-fedora>#</a></h3>
<p><strong>Install and Configure Samba</strong></p>
<p>To get started with samba, you need to install the samba core packages and <strong>samba-client</strong> package as shown:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># dnf install samba samba-common samba-client </span>
</code></pre></div><p>After all the samba is installed, you need to configure the samba share directory with proper permissions and ownership, so that it is going to be shared with all client machines in the same local network.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># mkdir -p /srv/tecmint/data</span>
<span style=color:#75715e># chmod -R 755 /srv/tecmint/data</span>
<span style=color:#75715e># chown -R  nobody:nobody /srv/tecmint/data</span>
<span style=color:#75715e># chcon -t samba_share_t /srv/tecmint/data</span>
</code></pre></div><p>Next, we are going to configure the <strong>Samba</strong> share directory in the <code>smb.conf</code> file, which is the main configuration file for Samba.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># mv /etc/samba/smb.conf /etc/samba/smb.conf.bak</span>
<span style=color:#75715e># vim /etc/samba/smb.conf</span>
</code></pre></div><p>Add the following configuration lines, which define the policies on who can access the samba share on the network.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>global<span style=color:#f92672>]</span>
workgroup <span style=color:#f92672>=</span> WORKGROUP
server string <span style=color:#f92672>=</span> Samba Server %v
netbios name <span style=color:#f92672>=</span> rocky-8
security <span style=color:#f92672>=</span> user
map to guest <span style=color:#f92672>=</span> bad user
dns proxy <span style=color:#f92672>=</span> no
ntlm auth <span style=color:#f92672>=</span> true


<span style=color:#f92672>[</span>Public<span style=color:#f92672>]</span>
path <span style=color:#f92672>=</span>  /srv/tecmint/data
browsable <span style=color:#f92672>=</span>yes
writable <span style=color:#f92672>=</span> yes
guest ok <span style=color:#f92672>=</span> yes
read only <span style=color:#f92672>=</span> no
</code></pre></div><p>Save and exit the configuration file.</p>
<p>Next, verify the samba configuration for errors.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># testparm</span>
</code></pre></div><p>If everything looks okay, make sure to start, enable and verify the status of the Samba daemons.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># systemctl start smb</span>
<span style=color:#75715e># systemctl enable smb</span>
<span style=color:#75715e># systemctl start nmb</span>
<span style=color:#75715e># systemctl enable nmb</span>
<span style=color:#75715e># systemctl status smb</span>
<span style=color:#75715e># systemctl status nmb</span>
</code></pre></div><p><strong>Accessing Samba Share from Windows</strong></p>
<p>To access Samba share from the Windows machine, press the <strong>Windows</strong> logo key + <strong>R</strong> to launch the <strong>Run</strong> dialog and enter the IP address of the samba server</p>
<p><strong>Secure Samba Share Directory</strong></p>
<p>To secure our Samba share, we need to create a new samba user.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># useradd smbuser</span>
<span style=color:#75715e># smbpasswd -a smbuser</span>
</code></pre></div><p>Next, create a new group and add the new samba user to this group.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># sudo groupadd smb_group</span>
<span style=color:#75715e># sudo usermod -g smb_group smbuser</span>
</code></pre></div><p>Thereafter, create another secure samba share directory for accessing files securely by samba users.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># mkdir -p /srv/tecmint/private</span>
<span style=color:#75715e># chmod -R 770 /srv/tecmint/private</span>
<span style=color:#75715e># chcon -t samba_share_t /srv/tecmint/private</span>
<span style=color:#75715e># chown -R root:smb_group /srv/tecmint/private</span>
</code></pre></div><p>Once again, access the Samba configuration file.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># vi /etc/samba/smb.conf</span>
</code></pre></div><p>Add these lines to define to secure samba share.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>Private<span style=color:#f92672>]</span>
path <span style=color:#f92672>=</span> /srv/tecmint/private
valid users <span style=color:#f92672>=</span> @smb_group
guest ok <span style=color:#f92672>=</span> no
writable <span style=color:#f92672>=</span> no
browsable <span style=color:#f92672>=</span> yes
</code></pre></div><p>Save the changes and exit.</p>
<p>Finally, restart all the samba daemons as shown.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo systemctl restart smb
$ sudo systemctl restart nmb
</code></pre></div><p>Now try to access the Samba share, this time you will see an additional ‘Private‘ directory. To access this directory, you will be required to authenticate with the Samba user’s credentials</p>
<h3 id=mitgnu-schememitgnu-scheme>[MIT/GNU Scheme](MIT/GNU Scheme)<a hidden class=anchor aria-hidden=true href=#mitgnu-schememitgnu-scheme>#</a></h3>
<p>9.2 是最后支持 windows 的版本，之前的版本我在fedora上编译失败了。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ wget https://ftp.gnu.org/gnu/mit-scheme/stable.pkg/9.2/mit-scheme-9.2-x86-64.tar.gz
$ sudo dnf install gcc make m4 ncurses-devel libX11-devel
$ tar xzf mit-scheme-VERSION-i386.tar.gz
$ cd mit-scheme-VERSION/src
$ sudo ./configure --prefix<span style=color:#f92672>=</span>/opt/mit-scheme
$ sudo make
$ sudo make install
</code></pre></div><h3 id=wavflacapehttpsshoplovehificomthread-498288-1-1html><a href=https://shop.lovehifi.com/thread-498288-1-1.html>WAV、FLAC、APE</a><a hidden class=anchor aria-hidden=true href=#wavflacapehttpsshoplovehificomthread-498288-1-1html>#</a></h3>
<h4 id=区别>区别<a hidden class=anchor aria-hidden=true href=#区别>#</a></h4>
<p>同一个音乐文件而言，WAV、FLAC、APE三种音乐格式的音质是完全一样的。</p>
<p>意思是说，从CD碟上抓轨出来后，得到的WAV和APE、FLAC音质完全相同，实际上是不同形式的同一个文件。但与CD碟是否完全一样，除了抓轨操作问题，基本上都是电脑设备技术所限。（你不能要求电脑器材技术同灌制唱片的专业器材一致，电脑只是个均衡性技术器材组合体。）</p>
<p>所以，从收藏角度来说，三种格式可以，一样。但播放效果上，上万元的专业设备和神经质般的金耳朵是能听出些许差别来的，这主要是因为不同格式间因编码不同导致解码速度不同所致；如果转换为同一种格式，正常听是没有区别的。</p>
<p>那么，APE、FLAC、WAV三种格式区别在哪里呢？（这些区别并不是说音乐文件本身品质有优劣）</p>
<ol>
<li>
<p>编码不同，导致解码速度WAV > FLAC > APE，直接影响到播放听感流畅性上：WAV > FLAC > APE</p>
<p>WAV波形文件是音响设备和很多软件可以直接读取的波形文件，基本上不存在编解码问题。flac和ape都对WAV进行了编码，故能换取较小的体积，但同时造成解码播放时，因播放器材解析力很敏感（或者说技术所限），会因出现一定的jitter抖动（解析复杂编码所致）而导致播放效果不够饱满和流畅。这点你可以通过统一转换为WAV格式来试听解决。</p>
</li>
<li>
<p>编码不同，导致所占空间大小 APE &lt; FLAC &lt; WAV。</p>
<p>由于flac和ape都对WAV进行了更高技术的编码，所以换取了较小的体积，这也是这两种格式之所以出现的根本原因。由于二者都是无损压缩，如果你是为了收藏，同时你的空间比较吃紧，无疑收藏较小体积的APE是最佳选择。至于以后会不会出现更小体积的无损压缩格式，但目前来说，APE 是最优选择。</p>
</li>
<li>
<p>编码不同，解码速度不一，导致占用CPU和耗电量不同。</p>
<p>编码越复杂，解码越麻烦，自然占用内存率越高，耗电量自然越大。那些伤不起的播放机们感触最深，同样的电量，三种格式播放时长依次为由长到短：WAV > FLAC > APE，所以，如果你的P5播放机比较脆弱，自然选择WAV可以享受更长时间的音乐。</p>
</li>
<li>
<p>开源性不同，导致纠错效果不同。</p>
<p>这一点各取所需吧！很多flac粉们对APE的防纠错和容错性大为诟病，指责其一报错就无法继续播放，等于整轨作废，同时嫌技术不开放（难道你自己要编程？搞不懂这个意见也这么大）。而flac用静音处理方式他们就认为很好。</p>
<p>个人认为，如果播放的话，因为一个错误就整轨不能播放，等于白下载，的确很烦人，而flac静音处理得以继续播放下面的曲目，的确人性；但从收藏的角度而言，静音处理错误是不是有点瞒天过海、自欺欺人？发烧者和收藏癖们对人耳觉察不到的细微差别都耿耿于怀，怎么会放过这么大的差错？反正，如果有错误音轨，我是肯定不要收藏的，而APE，正好给我了检验好坏质量的途径。</p>
</li>
<li>
<p>开源性不同，导致支持软件多寡不均。</p>
<p>编码软件的支持上，大家都说支持flac的软件比ape多。这点没问题。但并不等于支持Ape格式的播放软件就少。实际上，现在已经有很多软件支持ape了。而且，支持flac的软件虽然多，也有很多不支持flac的，但wav就不一样了，还没有不支持WAV格式的播放器呢！这样说来，是不是也要把flac淘汰掉？！其实，听的时候就那么几首歌，转一下格式能够让你的播放器支持不就好啦。</p>
</li>
</ol>
<p>从收藏角度讲，APE、FLAC、WAV三种格式一样，文件音质相同；从播放来讲，格式不同，专业设备下，效果可能会有人耳察觉不同的区别（楼主没感觉出来）。</p>
<h4 id=扩展知识>扩展知识<a hidden class=anchor aria-hidden=true href=#扩展知识>#</a></h4>
<p><strong>无损音乐音质也分“三六九等”</strong></p>
<p>同一个文件的各个无损格式是一样的音质，如果不是同一个文件，即使是同一首歌，音质也分三六九等。举个例子，彭丽媛的曲目《在希望的田野上》 ，收录于《非同凡响》、《沂蒙山小调》、《演唱中国民歌》、《珠穆朗玛》等多个音乐专辑，这些专辑分别由不同的唱片公司于不同的时间出版，音质就会参差不齐。同时，由于时代不同，技术上受历史局限。也会导致音质有别。</p>
<p><strong>为什么无损音乐和CD比较，听觉上会有细微差别？</strong></p>
<p>无损音乐与CD碟片数据信息完全一样，那为什么音效不一样呢？嗯，这里我用的“音效”这个词非常好。CD碟和原声一样吗？肯定不一样。主要是技术上根本做不到完全还原原声。而且，为了音乐效果，一般还会加进各种特效。CD播放机和电脑，更是两个功用完全不同的设备。音效当然不可能一致。</p>
<p>其实，就算CD播放机，也不可能找到两台播放效果完全一样的。有句话，大意是世界上不可能找到两把相同的二胡，也是这个意思。</p>
<p><strong>假无损是怎么回事？</strong></p>
<p>到这里，我就给大家提炼出一个观点：【“无损音乐”不等于“无损音质”】</p>
<p>除了碟片录制设备技术问题（早期碟片音质都不好；不同唱片公司录制技术层次不同；国内碟相对国外顶级技术也不好），也有假无损，即不是由正版CD碟片抓轨得到，而是通过盗版碟片抓轨、磁带（卡带）翻录甚至是有损音乐（MP3等）转换而得到。这些APE、FLAC、WAV等格式的所谓的“无损音乐”，其音质就很差很差。</p>
<p>除了第一个原因我们无奈选择外，其他的发烧友都应该剔除。对于磁带翻录，如果是稀有资源，建议大家保留，因为如果找不到无损，有总比无好。</p>
<p><strong>我的音乐听起来音质不好，是无损吗？</strong></p>
<p>前面说了，【“无损音乐”不等于“无损音质”】，无损音乐严格来说，是指wav波形文件从音乐CD碟片的无损数字记录和APE、FLAC、WavPack、WMALossless等则是对WAV波形文件进行无损压缩。wav是无损音乐文件，APE、FLAC等则是无损压缩音乐文件。绝对意义上讲，他们都不能完全替代CD碟。WAV波形文件在媒体播放器里直接播放，而APE等其他压缩格式则需要经过解压（解码）还原成WAV再进行播放。</p>
<p><strong>如果你的无损音乐听感比较差，这你就要注意了</strong></p>
<p>⒈ 是真无损，多见于早期碟片。由于上世纪CD碟片刚起步，技术水平有限，故灌制效果相对今天的碟片来说欠佳。此外，即使今天，不同唱片公司出品的碟片，音质也有差别。在没有替代品的情况下，建议保留。</p>
<p>⒉ 是真无损，音质不好可能由抓轨操作失误造成“爆音”等数据信息残缺，建议更换。</p>
<p>⒊ 显示真无损，音质极差。这多由磁带/卡带转录而来。早期歌手只有磁带作品留世，虽然音质不好，但是唯一的纪念品。将其转录为数据，是为了更好地保存。在没有替代品的情况下，建议保留。</p>
<p>⒋ 假无损。即由有损格式MP3、WMA、OGG等格式转换而来，有些凭耳听，甚至难与真无损辨别，只有软件能检测出。有损转无损，丢失的信息不会转回来。虽然体积增大了，音质还是有损的音质。</p>
<p><strong>如何鉴别无损音乐？</strong></p>
<p>如何鉴别？主要是一靠听、二靠看、三靠软件检测。</p>
<p>注意软件检测也会出错，只是作为参考。毕竟，音乐最主要的用途是欣赏，而不是科学精密研究。建议大家首先听。比如磁带转录的，一般一听就听出来。但软件检测未必检测出。这是因为软件作用只是检测哪些是由有损低劣的音乐转换成的伪劣假冒无损。</p>
<ul>
<li>
<p>【一听】</p>
<p>听第一感觉，如果音质不好，甚至有爆音，即使是真无损，也是音质较差的低劣无损。</p>
</li>
<li>
<p>【二看】看占用空间大小和播放码率</p>
<p>看占用空间大小，一定要在相同格式的前提下，否则用APE和FLAC比较，是无意义的。一般，两个时长、内容一致的同名文件，占用空间越大者原则上包含信息越丰富、音质越好；看播放码率。</p>
</li>
<li>
<p>【三检测】用无损检验软件检测，和看频谱。</p>
</li>
</ul>
<h4 id=篇外篇>篇外篇<a hidden class=anchor aria-hidden=true href=#篇外篇>#</a></h4>
<p>长期来，很多人对MP3印象不好，更多人认为WMA的最佳音质要好过MP3，这种说法是不正确的，在中高码率下，编码得当的MP3要比WMA优秀很多，可以非常接近CD音质，在不太好的硬件设备支持下，没有多少人可以区分两者的差异，这不是神话故事，尽管你以前盲听就可以很轻松区分MP3和CD，但现在你难保证你可以分辨正确。因为MP3也是优秀的编码，以前被埋没了。</p>
<p>大家都谈说音质好，一种是指还原度好，就是说和录制的时候差别越小越好；一种是指悦耳，就是好听。就mp3来说，mp3是一种压缩格式，码率越高，通常来说就代表压缩小，损失的细节比较少，也就是说，码率越高听起来越接近原声。但是音质还和你的输出设备有关，比如说一部好的mp3，一对好耳机，这都对你的听音音质有帮助！因此，如果想改善音质，不妨从以上几个角度出发，不要过分强调其中哪一方面。</p>
<h3 id=视频编码码率控制httpscloudtencentcomdeveloperarticle1698219><a href=https://cloud.tencent.com/developer/article/1698219>视频编码码率控制</a><a hidden class=anchor aria-hidden=true href=#视频编码码率控制httpscloudtencentcomdeveloperarticle1698219>#</a></h3>
<p><strong>背景知识：</strong></p>
<p>视频编码过程中，有一个重要步骤：量化，量化属于有损压缩过程。量化基本决定了视频的码率，视频的码率又从一定程度上决定了视频的质量。量化值QP越大则量化的粒度越高，压缩率越大，码率更小，视频质量越低，呈现出来就是马赛克比较大，画面不细腻，画面比较模糊。反之，压缩率低，码率大，质量高，画面细腻，细节丰富。</p>
<p>所以选择一个适合场景的视频码控方案很重要，调整视频输出码率其实就是在视频编码速度、网络带宽以及视频质量之间做一个平衡。有时网络带宽很受限，就要优先考虑码率大小优先的码控方案，有些对视频质量要求很高，要高清视频，那就要选择质量优先的模型。</p>
<p><strong>整体来说选择视频编码码率控制方案，可以通过下面五个因素权衡得出：</strong></p>
<ol>
<li>
<p>视觉质量稳定性，利于视觉主观质量，比如清晰度，流畅度，细节等，这点和人眼的视觉原理有关，选择人眼主动质量感受最高的模型；</p>
</li>
<li>
<p>即时输出码率，相当于每帧编码输出比特数，要考虑网络带宽因素，随着移动互联网发展，也需要考虑wifi和无线网这块的影响；</p>
</li>
<li>
<p>输出视频文件大小可控，利于传输，存储，要看系统的空间大小；</p>
</li>
<li>
<p>编码速度，不同的码控模型也影响了编码速度，对于低延时、实时场景要考虑，因为不同的码控方案，计算的复杂度不同，带来的编码延时也有影响；</p>
</li>
<li>
<p>对于移动设备还需要不同编码方式耗电量要求，因为不同模型会影响编码和解码复杂度，进而在移动设备编码和播放需要的耗电量不同；</p>
</li>
</ol>
<h4 id=cbr>CBR<a hidden class=anchor aria-hidden=true href=#cbr>#</a></h4>
<p><strong>恒定码率（Constant Bit Rate）</strong>，一定时间范围内比特率基本保持的恒定，属于码率优先模型。</p>
<p>**适用场景：**一般也不建议使用这种方式，虽然输出的码率总是处于一个稳定值，但是质量不稳定，不能充分有效利用网络带宽，因为这种模型不考虑视频内容的复杂性，把所有视频帧的内容统一对待。但是有些编码软件只支持固定质量或者固定码率方式，有时不得不用。用的时候在允许的带宽范围内尽可能把带宽设置大点，以防止复杂运动场景下视频质量很低，如果设置的不合理，在运动场景下直接就糊的看不成了。</p>
<p><strong>特点：</strong></p>
<ul>
<li>码率稳定，但是质量不稳定，带宽有效利用率不高，特别当该值设置不合理，在复杂运动场景下，画面非常模糊，非常影响观看体验；</li>
<li>但是输出视频码率基本稳定，便于计算视频体积大小；</li>
</ul>
<h4 id=vbr>VBR<a hidden class=anchor aria-hidden=true href=#vbr>#</a></h4>
<p><strong>可变码率（Variable Bit Rate）</strong>，简单场景分配比较大的QP，压缩率小，质量高。复杂场景分配较小QP。得到基本稳定的视觉质量，因为人眼人眼本来就对复杂场景不敏感，缺点在于输出码率大小不可控。</p>
<p>有两种调控模式：质量优先模式和2PASS二次编码模式。</p>
<p><strong>质量优先模式：</strong></p>
<p>不考虑输出视频文件的大小，完全按照视频的内容复杂程度来分配码率，这样视频的播放效果质量最好。</p>
<p><strong>二次编码方式2PASS：</strong></p>
<p>第一次编码检测视频内容的简单和复杂部分，同时确定简单和复杂的比例。第二遍编码会让视频的平均码率不变，复杂的地方分配多bit,简单地方分配少bit。这种编码虽然很好，但是速度会跟不上。</p>
<p>**适用场景：**VBR适用于那些对带宽和编码速度不太限制，但是对质量有很高要求的场景。特别是在运动的复杂场景下也可以保持比较高的清晰度且输出质量比较稳定，适合对延时不敏感的点播，录播或者存储系统。</p>
<p><strong>特点：</strong></p>
<ul>
<li>码率不稳定，质量基本稳定且非常高；</li>
<li>编码速度一般比较慢，点播、下载和存储系统可以优先使用，不适合低延时、直播系统；</li>
<li>这种模型完全不考虑输出的视频带宽，为了质量，需要多少码率就占用多少，也不太考虑编码速度；</li>
</ul>
<h4 id=abr>ABR<a hidden class=anchor aria-hidden=true href=#abr>#</a></h4>
<p><strong>恒定平均目标码率(Average Bit Rate）</strong>，简单场景分配较低bit,复杂场景分配足够bit，使得<strong>有限的bit数</strong>能够在不同场景下合理分配，这类似VBR。同时一定时间内，平均码率<strong>又接近设置的目标码率</strong>，这样可以控制输出文件的大小，这又类似CBR。可以认为是CBR和VBR的折中方案，这是大多人的选择。特别在对质量和视频带宽都有要求的情况下，可以优先选择该模式，一般速度是VBR的两倍到三倍，相同体积的视频文件质量却比CBR好很多。</p>
<p>**适用场景：**ABR在直播和低延时系统用的比较多，因为只编码了一次，所以速度快，同时兼顾了视频质量和带宽,对于转码速度有要求的情况下也可以选择该模式。B站的大部分视频就选择了该模式。</p>
<p><strong>特点：</strong></p>
<ul>
<li>视频质量整体可控，同时兼顾了视频码率和速度，是一个折中方案，实际用的比较多；</li>
<li>使用过程一般要让调用方设置，最低码率、最高码率和平均码率，这些值要尽可能设置合理点；</li>
</ul>
<h4 id=总结httpsblogxuitenetkkaima2twblog117443956-cbre38081vbre38081abre5b7aee795b0e680a7><a href=https://blog.xuite.net/kkaima2/twblog/117443956-CBR%E3%80%81+VBR%E3%80%81ABR+%E5%B7%AE%E7%95%B0%E6%80%A7>总结</a><a hidden class=anchor aria-hidden=true href=#总结httpsblogxuitenetkkaima2twblog117443956-cbre38081vbre38081abre5b7aee795b0e680a7>#</a></h4>
<p>不懂的話沒關係，反正普遍情況是這樣的：</p>
<ul>
<li>
<p>音質：CBR > VBR > ABR</p>
<p>192 kbps以下的CBR，與後兩者無明顯差異，但檔案容量差很多，建議有心要壓CBR就直接衝高流量！</p>
</li>
<li>
<p>檔案大小：CBR > VBR & ABR</p>
<p>後兩者隨參數設定而有差別，大致上差不了多少</p>
</li>
</ul>
<h3 id=dffdsfdst>DFF、DSF、DST<a hidden class=anchor aria-hidden=true href=#dffdsfdst>#</a></h3>
<ul>
<li>DSD是SACD采用的信号调制方式，相当于CDDA（普通CD）采用的PCM调制方式。</li>
<li>DSF、DFF是SACD碟片中数据的未压缩编码格式，DSF用于Sony，DFF用于Philips，相当于CDDA碟片中的WAV文件。</li>
<li>DST是一种对SACD中DSF、DFF数据进行无损压缩的编码格式，相当于FLAC、APE是对CDDA中WAV数据的无损压缩。</li>
</ul>
<h3 id=rpm-搜索与下载网站>RPM 搜索与下载网站<a hidden class=anchor aria-hidden=true href=#rpm-搜索与下载网站>#</a></h3>
<ul>
<li><a href=http://pkgs.org/>pkgs.org</a>：最好的</li>
<li><a href=http://rpm.pbone.net/>rpm.pbone.net</a>：比较全面但是下载速度有点慢</li>
<li><a href=https://rpmfind.net/linux/RPM/index.html>rpmfind.net</a>：速度还可以就是没有上面的全</li>
<li><a href=https://crpm.cn/>crpm.cn</a></li>
</ul>
<h3 id=误删了-usrshareicons-目录httpsadatiyacompost76557html><a href=https://adatiya.com/post/76557.html>误删了 <code>/usr/share/icons</code> 目录</a><a hidden class=anchor aria-hidden=true href=#误删了-usrshareicons-目录httpsadatiyacompost76557html>#</a></h3>
<ul>
<li>
<p>从他们的官方网站下载您的操作系统的完整 ISO 并将其加载到驱动器中，然后将 /usr/share/applications 从 ISO 复制到您的系统。</p>
</li>
<li>
<p>reinstall</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf reinstall <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>rpm -qa<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</code></pre></div></li>
</ul>
<h3 id=flatpak-的亚洲字体问题httpswikiarchlinuxorgtitlesteam_e7ae80e4bd93e4b8ade69687flatpak_e79a84e4ba9ae6b4b2e5ad97e4bd93e997aee9a298><a href=https://wiki.archlinux.org/title/Steam_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#Flatpak_%E7%9A%84%E4%BA%9A%E6%B4%B2%E5%AD%97%E4%BD%93%E9%97%AE%E9%A2%98><strong>Flatpak 的亚洲字体问题</strong></a><a hidden class=anchor aria-hidden=true href=#flatpak-的亚洲字体问题httpswikiarchlinuxorgtitlesteam_e7ae80e4bd93e4b8ade69687flatpak_e79a84e4ba9ae6b4b2e5ad97e4bd93e997aee9a298>#</a></h3>
<p>如果你遇到了游戏中无法显示亚洲字体的问题，这是因为 org.freedesktop.Platform 并没有包含合适的字体文件进去。首先尝试挂载你的本地字体：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ flatpak run --filesystem<span style=color:#f92672>=</span>~/.local/share/fonts --filesystem<span style=color:#f92672>=</span>~/.config/fontconfig  com.valvesoftware.Steam
</code></pre></div><p>如果上述命令不起作用，考虑动手 hack 一下：直接将字体文件复制进 org.freedesktop.Platform 的目录下以启用字体，例如</p>
<pre tabindex=0><code># replace ? with your version and hash
/var/lib/flatpak/runtime/org.freedesktop.Platform/x86_64/?/?/files/etc/fonts/conf.avail
/var/lib/flatpak/runtime/org.freedesktop.Platform/x86_64/?/?/files/etc/fonts/conf.d 
/var/lib/flatpak/runtime/org.freedesktop.Platform/x86_64/?/?/files/share/fonts
</code></pre><h3 id=selinux-policy-for-a-systemd-servicehttpsunixstackexchangecoma447133><a href=https://unix.stackexchange.com/a/447133>SELinux policy for a systemd service</a><a hidden class=anchor aria-hidden=true href=#selinux-policy-for-a-systemd-servicehttpsunixstackexchangecoma447133>#</a></h3>
<p>Check that the script is properly labeled as <code>bin_t</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo chcon -v -t bin_t /home/kurome/.opt/clash/clash_premium
</code></pre></div><h3 id=filter-ruleshttpsman7orglinuxman-pagesman1rsync1htmlfilter_rules><a href=https://man7.org/linux/man-pages/man1/rsync.1.html#FILTER_RULES>FILTER RULES</a><a hidden class=anchor aria-hidden=true href=#filter-ruleshttpsman7orglinuxman-pagesman1rsync1htmlfilter_rules>#</a></h3>
<p><code>~/.opt/rsync/backup-home</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>+ /.config/
+ /.config/autostart/***
+ /.config/fontconfig/***
+ /.config/google-chrome/***
+ /.config/ibus/***
+ /.config/obsidian/***
+ /.config/Typora/***
+ /Documents/***
+ /.goldendict/***
+ /.local/
+ /.local/bin/***
+ /.local/share
+ /.local/share/applications/***
+ /.local/share/icons/***
+ /.local/share/TelegramDesktop/***
+ /Music/***
+ /.opt/***
+ /.ssh/***
+ /Templates/***
- /**
</code></pre></div><ul>
<li>
<p><a href=https://stackoverflow.com/questions/35364075/using-rsync-filter-to-include-exclude-files>Using Rsync filter to include/exclude files</a></p>
<p>this won&rsquo;t work:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>+ /some/path/this-file-will-not-be-found
+ /file-is-included
- *
</code></pre></div><p>this set of rules works fine:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>+ /some/
+ /some/path/
+ /some/path/this-file-is-found
+ /file-also-included
- *
</code></pre></div></li>
<li>
<p><a href=https://serverfault.com/questions/770728/rsync-exclude-all-directories-except-a-few>exclude all directories except a few</a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cat filter.txt
+ /include_this_dir/
+ /include_this_dir/**
+ /include_that_dir/
+ /include_that_dir/**
- /**
$ rsync -av --dry-run --filter<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;merge filter.txt&#34;</span> source_dir/ dest_dir/
</code></pre></div><p>You can reduce it further with three &ldquo;*&rdquo;, like <code>+ /include_this_dir/***</code>, which means <code>+ /include_this_dir/</code> + <code>/include_this_dir/**</code></p>
</li>
</ul>
<p><code>~/.local/bin/backup-home</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>
set -o errexit
set -o nounset
set -o pipefail

readonly SOURCE_DIR<span style=color:#f92672>=</span>/home/kurome/
readonly BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>findmnt -nr -o target -S /dev/mapper/luks-5277e33d-604f-4c1e-bc8c-40c14544614e<span style=color:#66d9ef>)</span><span style=color:#e6db74>/Backup/HomeData&#34;</span>
readonly DATETIME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d_%H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
readonly BACKUP_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>DATETIME<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
readonly LATEST_LINK<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/latest&#34;</span>

rsync -av <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	--delete <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>SOURCE_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	--link-dest <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>LATEST_LINK<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	--filter<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;merge /home/kurome/.opt/rsync/backup-home&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_PATH<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>

rm -rf <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>LATEST_LINK<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
ln -s <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_PATH<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>LATEST_LINK<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><h2 id=fedora-questions>Fedora Questions<a hidden class=anchor aria-hidden=true href=#fedora-questions>#</a></h2>
<h3 id=cannot-open-acess-to-console-the-root-account-is-locked>Cannot open acess to console, the root account is locked&mldr;<a hidden class=anchor aria-hidden=true href=#cannot-open-acess-to-console-the-root-account-is-locked>#</a></h3>
<p>先是添加一个 LV 到 /etc/fstab，结果开机报错，原因是写错了：</p>
<pre tabindex=0><code>Time out ...Dependency failed for ...
</code></pre><p>结束后就 Cannot open acess to console, the root account is locked，什么也干不了，只能强制关机。</p>
<p>解决方案是重启进入 Fedora Live CD，挂载 root，修改 /etc/fstab。但是无法挂载，挂载的是 Fedora Live CD 的 root，我 TM 佛了，原因应该是这两个名一模一样，Live CD 覆盖了 root。最后是用 Ubntu Live CD 解决。</p>
<p>这告诉我们，不要只有一个 Live CD。这还告诉我们，先找自己的原因才能有耐心去解决问题。</p>
<h3 id=dmesg-x86cpu-sgx-disabled-by-bios>dmesg-x86/cpu: SGX disabled by BIOS<a hidden class=anchor aria-hidden=true href=#dmesg-x86cpu-sgx-disabled-by-bios>#</a></h3>
<p><a href=http://www.jos.org.cn/html/2018/9/5594.htm#top>SGX技术的分析和研究</a></p>
<h3 id=snd_hda_codec_hdmi-hdaudioc0d2-monitor-plugged-in-failed-to-power-up-codec-ret-13httpsbbsarchlinuxorgviewtopicphpid261225><a href="https://bbs.archlinux.org/viewtopic.php?id=261225">snd_hda_codec_hdmi hdaudioC0D2: Monitor plugged-in, Failed to power up codec ret=[-13]</a><a hidden class=anchor aria-hidden=true href=#snd_hda_codec_hdmi-hdaudioc0d2-monitor-plugged-in-failed-to-power-up-codec-ret-13httpsbbsarchlinuxorgviewtopicphpid261225>#</a></h3>
<p>set <a href=https://wiki.archlinux.org/title/Kernel_parameters_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)>Kernel parameters</a>，要使改变在重启后仍生效，您可以手动编辑 /boot/grub/grub.cfg。对于初学者，建议编辑 /etc/default/grub 并将您的内核选项添加至 GRUB_CMDLINE_LINUX_DEFAULT 行：</p>
<pre tabindex=0><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;snd_hda_codec_hdmi.enable_silent_stream=0&quot;
</code></pre><p>然后重新生成 grub.cfg 文件：</p>
<pre tabindex=0><code># grub2grub-mkconfig2 -o /boot/grub2/grub.cfg
</code></pre><h3 id=为什么-linus-torvalds-用-fedorahttpswwwzhihucomquestion36863290><a href=https://www.zhihu.com/question/36863290>为什么 Linus Torvalds 用 Fedora</a><a hidden class=anchor aria-hidden=true href=#为什么-linus-torvalds-用-fedorahttpswwwzhihucomquestion36863290>#</a></h3>
<ul>
<li>2008：linus对发行版的要求是"易安装，比较贴近上游"即可（滚动+少折腾”）。</li>
<li>2010年的时候，他指出了Fedora 14的一个bug。</li>
<li>2011年Fedora 15换Gnome3作为默认DE了，Linus直言"unholy mess" ，然后转投XFCE。</li>
<li>2011年末，Linus提出并修补了openSUSE中Xorg的一个严重bug。</li>
<li>2013年5月：Linus尝试将自己手头的MacBook Air装上Linux，把几个大的发行版全部都试了一遍。发现只有Fedora能正常工作。</li>
<li>之后的所有消息就是各种fedora了</li>
</ul>
<h3 id=代理后为什么-ping-不通httpswwwzhihucomquestion20053991><a href=https://www.zhihu.com/question/20053991>代理后为什么 ping 不通</a><a hidden class=anchor aria-hidden=true href=#代理后为什么-ping-不通httpswwwzhihucomquestion20053991>#</a></h3>
<p>问题：</p>
<p>设置了http_proxy和https_proxy在.bashrc文件里，firefox可以上网了。ping外网能够解析域名，但ping不通</p>
<p>解答：</p>
<p>首先提一个问题，为什么我们要用代理服务器上网？</p>
<p>那是因为如果不用代理服务器，我们访问的website 被blocked，最简单的方式就是在一个大型防火墙上执行： deny website IP。</p>
<p>而使用代理服务器，无非是用代理服务器的IP作为目的IP，把用户的HTTP、HTTPS封装在TCP上，这样途径防火墙时，由于目的IP不在blocked IP 之列，所以被放行，这样我们就可以浏览一些被blocked 的网页。</p>
<p>但是一般代理服务器并不为UDP/ICMP服务，最多为TCP服务，所以你ping website 时，代理服务器并没有介入，因为Ping是ICMP报文，那就意味着你的ping包的目的IP就是被blocked IP地址，很显然无法正常通过，全被丢了。</p>
<h3 id=fedora安装chrome后显示您的浏览器由所属组织管理httpsbugzillaredhatcomshow_bugcgiid1680129><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1680129">Fedora安装Chrome后显示“您的浏览器由所属组织管理”</a><a hidden class=anchor aria-hidden=true href=#fedora安装chrome后显示您的浏览器由所属组织管理httpsbugzillaredhatcomshow_bugcgiid1680129>#</a></h3>
<p>I finally got a chance to look into this today, and I don&rsquo;t think it&rsquo;s as alarming as this BZ makes it sound. Yes, Chrome (over-)states that it is &ldquo;Managed by your organization&rdquo;. Clicking on that links to <a href=https://support.google.com/chrome/answer/9281740>https://support.google.com/chrome/answer/9281740</a> which lists the things a managed system <em>can</em> do. However, if you read just a few sentences further, it tells you how to view exactly which settings your administrator has enabled, which in turn has links to the descriptions of what those features are. As clearly linked there, the only settings we&rsquo;ve enabled is &ldquo;This browser can negotiate authentication with *.fedoraproject.org&rdquo;.</p>
<p>So, I&rsquo;m inclined to say that while the initial reading page might lead a user to be slightly concerned, I don&rsquo;t feel that the situation is particularly dire. They can always just read content in the links.</p>
<p>In the worst case, if someone <em>really</em> doesn&rsquo;t want to have that message appear, they can just <code>dnf remove fedora-chromium-config</code>.</p>
<p><strong><a href=https://src.fedoraproject.org/rpms/fedora-chromium-config>fedora-chromium-config</a></strong></p>
<p>This package is used to install customizations for Chromium/Chrome that are recommended by Fedora, including a user-agent string identifying the system as Fedora.</p>
<p>It includes a GSSAPI configuration that enables access to many Fedora Project services. To add support for other domains, replace the symlink /etc/chromium/policies/managed/00_gssapi.json with your own content. (<a href=https://src.fedoraproject.org/rpms/fedora-chromium-config>upstream</a>)</p>
<h3 id=difference-between-docker-attach-and-docker-exechttpsstackoverflowcoma30962120><a href=https://stackoverflow.com/a/30962120>difference between docker attach and docker exec</a><a hidden class=anchor aria-hidden=true href=#difference-between-docker-attach-and-docker-exechttpsstackoverflowcoma30962120>#</a></h3>
<p>There was a <a href=https://github.com/docker/docker/commit/2f46ec60c012e94771698351515178fe9caea21a>commit PR</a> which added to the doc:</p>
<blockquote>
<p><strong>Note:</strong> This command (<code>attach</code>) is not for running a new process in a container. See: <code>docker exec</code>.</p>
</blockquote>
<p>The answer to &ldquo;<a href=https://askubuntu.com/a/507009/5470>Docker. How to get bash\ssh inside runned container (<code>run -d</code>)?</a>&rdquo; illustrates the difference:</p>
<blockquote>
<p>(docker >= 1.3) If we use <a href=https://docs.docker.com/engine/reference/commandline/attach/><code>docker attach</code></a>, <strong>we can use only one instance of shell</strong>.
So if we want to open new terminal with new instance of container&rsquo;s shell, we just need to run <a href=https://docs.docker.com/engine/reference/commandline/exec/><code>docker exec</code></a></p>
<p>if the docker container was started using <code>/bin/bash</code> command, you can access it using attach, if not then you need to <em>execute</em> the command to create a bash instance inside the container using <code>exec</code>.</p>
</blockquote>
<p>As mentioned in <a href=https://github.com/docker/docker/issues/2855#issuecomment-57102647>this issue</a>:</p>
<blockquote>
<ul>
<li>Attach isn&rsquo;t for running an extra thing in a container, it&rsquo;s for attaching to the running process.</li>
<li>&ldquo;<code>docker exec</code>&rdquo; is specifically for running new things in a already started container, be it a shell or some other process.</li>
</ul>
</blockquote>
<p>The same issue adds:</p>
<blockquote>
<p>While <code>attach</code> is not well named, particularly because of the LXC command <code>lxc-attach</code> (which is more akin <code>docker exec &lt;container> /bin/sh</code>, but LXC specific), it does have a specific purpose of literally attaching you to the process Docker started.
<strong>Depending on what the process is the behavior may be different</strong>, for instance attaching to <code>/bin/bash</code> will give you a shell, but attaching to redis-server will be like you&rsquo;d just started redis directly without daemonizing.</p>
</blockquote>
<h3 id=error-syncing-passwordshttpssupportgooglecomchromethread9947763error-syncing-passwordshlen><a href="https://support.google.com/chrome/thread/9947763/error-syncing-passwords?hl=en">Error syncing passwords</a><a hidden class=anchor aria-hidden=true href=#error-syncing-passwordshttpssupportgooglecomchromethread9947763error-syncing-passwordshlen>#</a></h3>
<blockquote>
<p><em>Error: MergeDataAndStartSyncing@../../components/password_manager/core/browser/sync/password_syncable_service.cc:190, datatype error was encountered: Failed to get passwords from store.</em></p>
</blockquote>
<p>The problem was solved by deleting &lsquo;Login Data&rsquo; and &lsquo;Login Data-journal&rsquo; in the profile.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ rm -rf ~/.config/google-chrome/Default/Login<span style=color:#ae81ff>\ </span>Data*
</code></pre></div><p>The <code>&lt;profile></code> part can be found in the Profile Path on the chrome://version page.</p>
<h3 id=gnome-boxes-with-sshhttpsunixstackexchangecoma649326><a href=https://unix.stackexchange.com/a/649326>Gnome Boxes with ssh</a><a hidden class=anchor aria-hidden=true href=#gnome-boxes-with-sshhttpsunixstackexchangecoma649326>#</a></h3>
<p>GNOME Boxes does not expose guests to SSH into. You are expected to have <a href=https://www.spice-space.org/download.html>SPICE guest additions</a> installed on the guest to be able:</p>
<ul>
<li>to copy and paste text with a shared clipboard between the host and the guest and</li>
<li>to drag and drop files into the guest.</li>
</ul>
<p>This approach is supposed to be intuitively comprehensible for unsophisticated users.</p>
<h3 id=where-do-packages-installed-with-dnf-get-storedhttpssuperusercomquestions1277412where-do-packages-installed-with-dnf-get-stored><a href=https://superuser.com/questions/1277412/where-do-packages-installed-with-dnf-get-stored>Where do packages installed with DNF get stored?</a><a hidden class=anchor aria-hidden=true href=#where-do-packages-installed-with-dnf-get-storedhttpssuperusercomquestions1277412where-do-packages-installed-with-dnf-get-stored>#</a></h3>
<p>With APT (Ubuntu), downloaded packages are stored at: <code>/var/cache/apt/archives</code></p>
<p>DNF stores downloaded packages and metadata in <code>/var/cache/dnf</code>, in various per-repository subdirectories.</p>
<h3 id=how-do-i-scan-for-viruses-with-clamavhttpsaskubuntucomquestions250290how-do-i-scan-for-viruses-with-clamav><a href=https://askubuntu.com/questions/250290/how-do-i-scan-for-viruses-with-clamav>How do I scan for viruses with ClamAV?</a><a hidden class=anchor aria-hidden=true href=#how-do-i-scan-for-viruses-with-clamavhttpsaskubuntucomquestions250290how-do-i-scan-for-viruses-with-clamav>#</a></h3>
<h2 id=rhel>RHEL<a hidden class=anchor aria-hidden=true href=#rhel>#</a></h2>
<h3 id=rhel-developer-subscriptionhttpsdevelopersredhatcomproductsrheldownload><a href=https://developers.redhat.com/products/rhel/download>RHEL Developer Subscription</a><a hidden class=anchor aria-hidden=true href=#rhel-developer-subscriptionhttpsdevelopersredhatcomproductsrheldownload>#</a></h3>
<p>Need to log in to download RHEL.</p>
<p>下载的时候会断，有时候甚至下载到 99% 都会断，所以最好是用专门的、支持断点续传的软件（如 aria2）下载。同时最好不要关闭浏览器，特别是保留redhat官网登录状态，如果关闭了就需要重新登录，根本没有保存登录状态选项。</p>
<p><a href=https://access.redhat.com/zh_CN/solutions/1119463>怎样使用 Red Hat Subscription Manager (RHSM) 将系统注册到红帽客户门户网站？</a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># subscription-manager register --username &lt;username&gt; --password &lt;password&gt; --auto-attach</span>
</code></pre></div><p>注意！是用户名而<strong>不是邮箱</strong>！</p>
<p><a href=https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html-single/configuring_basic_system_settings/index>配置 Red Hat Enterprise Linux 8 中基本系统设置的指南</a></p>
<h3 id=epelhttpsdocsfedoraprojectorgen-usepel--rpmfusionhttpsrpmfusionorgconfiguration><a href=https://docs.fedoraproject.org/en-US/epel/>EPEL</a> & <a href=https://rpmfusion.org/Configuration/>RPMFusion</a><a hidden class=anchor aria-hidden=true href=#epelhttpsdocsfedoraprojectorgen-usepel--rpmfusionhttpsrpmfusionorgconfiguration>#</a></h3>
<p>EPEL的全称叫 Extra Packages for Enterprise Linux 。EPEL是由 Fedora 社区打造，为 RHEL 及衍生发行版如 CentOS、Scientific Linux 等提供高质量软件包的项目。装上了 EPEL之后，就相当于添加了一个第三方源。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># subscription-manager repos --enable codeready-builder-for-rhel-9-$(arch)-rpms</span>
<span style=color:#75715e># dnf install https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm</span>
</code></pre></div><p>如果你知道rpmfusion.org的话，拿 rpmfusion 做比较还是很恰当的，rpmfusion 主要为桌面发行版提供大量rpm包（只有开源驱动才能进官方源，想要闭源驱动装rpmfusion），而EPEL则为服务器版本提供大量的rpm包，而且大多数rpm包在官方 repository 中是找不到的。</p>
<p>继上面安装 epel 后安装 RPMFusion：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># dnf install --nogpgcheck https://mirrors.rpmfusion.org/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm https://mirrors.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-$(rpm -E %rhel).noarch.rpm</span>
</code></pre></div><p>使用 BFSU MIRROR</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo dnf install --nogpgcheck https://mirrors.bfsu.edu.cn/rpmfusion/free/el/rpmfusion-free-release-<span style=color:#66d9ef>$(</span>rpm -E %rhel<span style=color:#66d9ef>)</span>.noarch.rpm https://mirrors.bfsu.edu.cn/rpmfusion/nonfree/el/rpmfusion-nonfree-release-<span style=color:#66d9ef>$(</span>rpm -E %rhel<span style=color:#66d9ef>)</span>.noarch.rpm -y
</code></pre></div><p>注意：RHEL、CentOS 及替代（Rocky、AlmaLinux、OracleLinux）等服务器版本，很多常见桌面应用是没有在源里面提供的（不论时官方源还是额外的第三方源），因此需要手动管理了。</p>
<h3 id=remis-rpm-repositoryhttpsblogremireponet><a href=https://blog.remirepo.net/>Remi&rsquo;s RPM repository</a><a hidden class=anchor aria-hidden=true href=#remis-rpm-repositoryhttpsblogremireponet>#</a></h3>
<p><a href=https://blog.remirepo.net/pages/English-FAQ#goal>这个存储库的目标是什么？</a></p>
<blockquote>
<p><a href=http://fedoraproject.org/>向Fedora</a>和<strong>Enterprise Linux</strong>（<a href=http://www.redhat.com/products/enterprise-linux/>RHEL</a>、<a href=http://www.centos.org/>CentOS</a>、<a href=http://www.oracle.com/fr/technologies/linux/>Oracle</a>、<a href=https://www.scientificlinux.org/>Scientific Linux</a>，&mldr;）用户提供 <strong>最新版本</strong>的**<a href=http://php.net/>PHP</a>**堆栈、<strong>全功能</strong>和一些其他软件。它主要包含：</p>
<ul>
<li>我也在 Fedora 中维护的包</li>
<li>Fedora 开发版中可用的软件包的反向移植</li>
<li>一些与 Fedora 政策不兼容的软件包</li>
<li>在提交到 Fedora 存储库之前正在处理的一些包</li>
<li>（几乎）<a href=http://en.wikipedia.org/wiki/Vanilla_software>香草</a>版本</li>
</ul>
<p>这与 Enterprise Linux的<a href=https://access.redhat.com/security/updates/backporting/>向后移植修复策略相去甚远。</a></p>
</blockquote>
<h3 id=getpagespeed-rhel-packages-repositoryhttpswwwgetpagespeedcomredhat><a href=https://www.getpagespeed.com/redhat>GetPageSpeed RHEL Packages Repository</a><a hidden class=anchor aria-hidden=true href=#getpagespeed-rhel-packages-repositoryhttpswwwgetpagespeedcomredhat>#</a></h3>
<p>We have by far the largest RPM repository with <a href=https://nginx-extras.getpagespeed.com/#complete-module-list>dynamic stable NGINX modules</a> and VMODs for <a href=https://extras.getpagespeed.com/redhat/7/x86_64/repoview/letter_v.group.html>Varnish 4.1</a> and <a href=https://extras.getpagespeed.com/redhat/7/varnish60/x86_64/repoview/>6.0 LTS</a>. If you want to install nginx, Varnish and lots of useful modules for them, this is your one stop repository to get all performance related software.</p>
<h3 id=elrepo-projecthttpelrepoorgtikihomepage><a href=http://elrepo.org/tiki/HomePage>ELRepo Project</a><a hidden class=anchor aria-hidden=true href=#elrepo-projecthttpelrepoorgtikihomepage>#</a></h3>
<p>The ELRepo Project focuses on hardware related packages to enhance your experience with Enterprise Linux. This includes filesystem drivers, graphics drivers, network drivers, sound drivers, webcam and video drivers.</p>
<h3 id=html5mp4-videoshttpswwwredditcomrredhatcommentsdy415fcannot_play_html5mp4_videos_within_firefox_on><a href=https://www.reddit.com/r/redhat/comments/dy415f/cannot_play_html5mp4_videos_within_firefox_on/>HTML5/MP4 videos</a><a hidden class=anchor aria-hidden=true href=#html5mp4-videoshttpswwwredditcomrredhatcommentsdy415fcannot_play_html5mp4_videos_within_firefox_on>#</a></h3>
<p>Install EPEL and RPMFusion.</p>
<p>Then <code>yum install ffmpeg</code> and you should be all set. The way Firefox works with this is it links to the avcodec/avformat (one of those two) libraries at launch, and those are provided by the ffmpeg project. ffmpeg in turn will grab the necessary codecs’ libraries it was compiled with (x264, vp9, x265, etc) and install them on your system.</p>
<h3 id=kdumphttpswwwcnblogscomaugusitep10613794html><a href=https://www.cnblogs.com/augusite/p/10613794.html>Kdump</a><a hidden class=anchor aria-hidden=true href=#kdumphttpswwwcnblogscomaugusitep10613794html>#</a></h3>
<p>Kdump是一种基于kexec的Linux内核崩溃捕获机制，简单来说系统启动时会预留一块内存，当系统崩溃调用命令kexec(kdump kernel)在预留的内存中启动kdump内核，该内核会将此时内存中的所有运行状态和数据信息收集到一个coredump文件中以便后续分析调试。</p>
<h3 id=qemu-on-rhelhttpsunixstackexchangecomquestions585610qemu-and-centos-8-where-is-usr-bin-qemu-system-x86-64-and-the-qemu-system-x86><a href=https://unix.stackexchange.com/questions/585610/qemu-and-centos-8-where-is-usr-bin-qemu-system-x86-64-and-the-qemu-system-x86>Qemu on rhel</a><a hidden class=anchor aria-hidden=true href=#qemu-on-rhelhttpsunixstackexchangecomquestions585610qemu-and-centos-8-where-is-usr-bin-qemu-system-x86-64-and-the-qemu-system-x86>#</a></h3>
<p>The main QEMU executable is now <code>/usr/libexec/qemu-kvm</code></p>
<h3 id=vnc-applicationshttpsaskubuntucomquestions438002vnc-or-remote-desktop-application-to-view-windows-desktop-from-ubuntu><a href=https://askubuntu.com/questions/438002/vnc-or-remote-desktop-application-to-view-windows-desktop-from-ubuntu>VNC applications</a><a hidden class=anchor aria-hidden=true href=#vnc-applicationshttpsaskubuntucomquestions438002vnc-or-remote-desktop-application-to-view-windows-desktop-from-ubuntu>#</a></h3>
<p>Some Free/Libre software supporting <a href=https://en.wikipedia.org/wiki/RFB_protocol>VNC/RFB protocol</a> or <a href=https://en.wikipedia.org/wiki/Remote_Desktop_Protocol#Non-Microsoft_implementations>Remote Desktop Protocol</a> (RDP):</p>
<ul>
<li><a href=http://novnc.com/><strong>noVNC</strong></a> (<a href=https://github.com/novnc/noVNC>GitHub</a>) is a browser-based app supporting many VNC features but no RDP.</li>
<li><a href=https://en.wikipedia.org/wiki/Rdesktop><strong>rdesktop</strong></a> (<a href=https://github.com/rdesktop/rdesktop>GitHub</a>)</li>
<li><a href=https://www.freerdp.com/><strong>FreeRDP</strong></a> (<a href=https://github.com/FreeRDP/FreeRDP>GitHub</a>) Fork of <strong>rdesktop</strong> to clean the code, support <em>Seamless Windows</em> (RDP6)&mldr;</li>
<li><a href=https://en.wikipedia.org/wiki/Remmina><strong>Remmina</strong></a> (<a href=https://github.com/FreeRDP/Remmina>GitHub</a>) Based on <strong>FreeRDP</strong> replaced tsclient as Ubuntu&rsquo;s default RD client (2011)</li>
<li><a href=https://en.wikipedia.org/wiki/Vinagre><strong>Vinagre</strong></a> Default GNOME VNC client supporting RDP since 2012</li>
<li><a href=https://en.wikipedia.org/wiki/Ulteo_Open_Virtual_Desktop><strong>Ulteo Open Virtual Desktop</strong></a> (guide to <a href=https://gist.github.com/jas-/3ee76618b4f056d1a052>get source code</a>)</li>
</ul>
<p><strong>VirtualBox</strong> has a built-in vRDP protocol that can be used to access GNU/Linux remote desktops (Linux distro usually lacks a RDP server). The vRDP protocol is compatible with all RDP clients. However, the proprietary <a href=https://en.wikipedia.org/wiki/VirtualBox#VirtualBox_Extension_Pack>VirtualBox Extension Pack</a> is required.</p>
<p>See also this good <a href=https://en.wikipedia.org/wiki/Comparison_of_remote_desktop_software>comparison of remote desktop software</a> (Wikipedia).</p>
<p><a href=https://www.techradar.com/news/5-of-the-best-linux-remote-desktop-clients><strong>TechRadar has also published an interesting article on this purpose</strong></a>:</p>
<blockquote>
<p><strong>Best Linux remote desktop clients: Top 5 RDC in 2018</strong>
By Mayank Sharma, January 2018
<em>We cover all the ins-and-outs of remote viewing</em></p>
<p><strong>Remote control features</strong></p>
<ul>
<li>TigerVNC <strong>3</strong>/5</li>
<li>RealVNC <strong>4</strong>/5   Top</li>
<li>Remmina <strong>4</strong>/5   Top</li>
<li>Vinagre   <strong>3</strong>/5</li>
<li>TightVNC <strong>3</strong>/5</li>
</ul>
<p><strong>Multimedia performance</strong></p>
<ul>
<li>TigerVNC <strong>4</strong>/5   Top</li>
<li>RealVNC <strong>4</strong>/5   Top</li>
<li>Remmina <strong>3</strong>/5</li>
<li>Vinagre   <strong>4</strong>/5   Top</li>
<li>TightVNC <strong>2</strong>/5</li>
</ul>
<p><strong>Interface and usability</strong></p>
<ul>
<li>TigerVNC <strong>3</strong>/5</li>
<li>RealVNC <strong>3</strong>/5</li>
<li>Remmina <strong>3</strong>/5</li>
<li>Vinagre   <strong>3</strong>/5</li>
<li>TightVNC <strong>3</strong>/5</li>
</ul>
<p><strong>Documentation and support</strong></p>
<ul>
<li>TigerVNC <strong>2</strong>/5</li>
<li>RealVNC <strong>5</strong>/5   Top</li>
<li>Remmina <strong>3</strong>/5</li>
<li>Vinagre   <strong>2</strong>/5</li>
<li>TightVNC <strong>2</strong>/5</li>
</ul>
<p><strong>Server and protocol support</strong></p>
<ul>
<li>TigerVNC <strong>2</strong>/5</li>
<li>RealVNC <strong>4</strong>/5   Top</li>
<li>Remmina <strong>3</strong>/5</li>
<li>Vinagre   <strong>3</strong>/5</li>
<li>TightVNC <strong>1</strong>/5</li>
</ul>
<p><strong>Configurable parameters</strong></p>
<ul>
<li>TigerVNC <strong>2</strong>/5</li>
<li>RealVNC <strong>4</strong>/5   Top</li>
<li>Remmina <strong>3</strong>/5</li>
<li>Vinagre   <strong>2</strong>/5</li>
<li>TightVNC <strong>2</strong>/5</li>
</ul>
<p><strong>Connection flexibility</strong></p>
<ul>
<li>TigerVNC <strong>4</strong>/5   Top</li>
<li>RealVNC <strong>3</strong>/5</li>
<li>Remmina <strong>4</strong>/5   Top</li>
<li>Vinagre   <strong>2</strong>/5</li>
<li>TightVNC <strong>4</strong>/5   Top</li>
</ul>
<p><strong>Final verdict</strong></p>
<ul>
<li><a href=https://www.tigervnc.org/>TigerVNC</a> <strong>5</strong>/5   Open source credentials and performance</li>
<li><a href=https://www.realvnc.com/>RealVNC</a> <strong>4</strong>/5   Remote desktop access on the Raspberry Pi</li>
<li><a href=https://www.remmina.org/wp>Remmina</a> <strong>3</strong>/5   Multi-protocol remote desktop client</li>
<li><a href=https://wiki.gnome.org/Apps/Vinagre>Vinagre</a>   <strong>3</strong>/5   Lacks the control offered by its peers</li>
<li><a href=http://tightvnc.net/>TightVNC</a> <strong>2</strong>/5   Focus on Windows platforms</li>
</ul>
</blockquote>
<h2 id=rocky>Rocky<a hidden class=anchor aria-hidden=true href=#rocky>#</a></h2>
<h3 id=nju-mirrorhttpsmirrorsnjueducnhelprocky><a href=https://mirrors.nju.edu.cn/help/rocky>NJU Mirror</a><a hidden class=anchor aria-hidden=true href=#nju-mirrorhttpsmirrorsnjueducnhelprocky>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sed -e <span style=color:#e6db74>&#39;s|^mirrorlist=|#mirrorlist=|g&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span> -e <span style=color:#e6db74>&#39;s|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.nju.edu.cn/rocky|g&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span> -i.bak <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span> /etc/yum.repos.d/Rocky-*.repo
 $ dnf makecache
</code></pre></div><h3 id=epelhttpsmirrorsbfsueducnhelpepel><a href=https://mirrors.bfsu.edu.cn/help/epel/>EPEL</a><a hidden class=anchor aria-hidden=true href=#epelhttpsmirrorsbfsueducnhelpepel>#</a></h3>
<p>首先从CentOS Extras这个源（本镜像站也有镜像）里安装epel-release：</p>
<pre tabindex=0><code>yum install epel-release
</code></pre><p>修改<code>/etc/yum.repos.d/epel.repo</code>，将<code>mirrorlist</code>和<code>metalink</code>开头的行注释掉。</p>
<p>接下来，取消注释这个文件里<code>baseurl</code>开头的行，并将其中的<code>http://download.fedoraproject.org/pub</code>替换成<code>https://mirrors.bfsu.edu.cn</code>。</p>
<p>可以用如下命令自动替换：（来自 <a href=https://github.com/tuna/issues/issues/687>https://github.com/tuna/issues/issues/687</a>）</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sed -e <span style=color:#e6db74>&#39;s!^metalink=!#metalink=!g&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -e <span style=color:#e6db74>&#39;s!^#baseurl=!baseurl=!g&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -e <span style=color:#e6db74>&#39;s!//download\.fedoraproject\.org/pub!//mirrors.bfsu.edu.cn!g&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -e <span style=color:#e6db74>&#39;s!//download\.example/pub!//mirrors.bfsu.edu.cn!g&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -e <span style=color:#e6db74>&#39;s!http://mirrors!https://mirrors!g&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -i /etc/yum.repos.d/epel*.repo
</code></pre></div><h2 id=centos>CentOS<a hidden class=anchor aria-hidden=true href=#centos>#</a></h2>
<h3 id=关于多线程httpsyangfeiffeigithubiopublic20190706multitheading-concepthtml><a href=https://yangfeiffei.github.io/public/2019/07/06/multitheading-concept.html>关于多线程</a><a hidden class=anchor aria-hidden=true href=#关于多线程httpsyangfeiffeigithubiopublic20190706multitheading-concepthtml>#</a></h3>
<h4 id=概述>概述<a hidden class=anchor aria-hidden=true href=#概述>#</a></h4>
<p>每个正在系统上运行的程序都是一个进程。每个进程包含一到N个线程。进程也可能是整个程序或者是部分程序的动态执行。线程是一组指令的集合，或者是程序的特殊段，它可以在程序里独立执行。也可以把它理解为代码运行的上下文。所以线程基本上是轻量级的进程，它负责在单个程序里执行多任务。通常由操作系统负责多个线程的调度和执行。线程是程序中一个单一的顺序控制流程。在单个程序中同时运行多个线程完成不同的工作,称为多线程。</p>
<p>线程和进程的区别在于,子进程和父进程有不同的代码和数据空间,而多个线程则共享数据空间,每个线程有自己的执行堆栈和程序计数器为其执行上下文.多线程主要是为了节约CPU时间,发挥利用,根据具体情况而定. 线程的运行中需要使用计算机的内存资源和CPU。</p>
<p><code>同步多线程（SMT）</code>是一种在一个CPU 的时钟周期内能够执行来自多个线程的指令的硬件多线程技术。本质上，同步多线程是一种将线程级并行处理（多CPU）转化为指令级并行处理（同一CPU）的方法。 同步多线程是单个物理处理器从多个硬件线程上下文同时分派指令的能力。同步多线程用于在商用环境中及为周期/指令（CPI）计数较高的工作负载创造性能优势。 处理器采用超标量结构，最适于以并行方式读取及运行指令。同步多线程使您可在同一处理器上同时调度两个应用程序，从而利用处理器的超标量结构性质。</p>
<p><code>超线程（HT, Hyper-Threading）</code>是英特尔研发的一种技术，于2002年发布。通过此技术，英特尔实现在一个实体CPU中，提供两个逻辑线程。</p>
<p>其实可以将<code>SMT</code>和<code>HT</code>理解为一个技术。</p>
<blockquote>
<p>Hyper-threading (officially called Hyper- ThreadingTechnology or HT Technology, and abbreviated as HTT orHT) is Intel’s proprietary simultaneous multithreading (SMT) implementation used to improve parallelization ofcomputations (doing multiple tasks at once) performed onx86 microprocessors.</p>
<p>来自 <a href="https://cn.bing.com/search?q=intel+ht&go=%E6%8F%90%E4%BA%A4&qs=ds&form=QBLHCN">https://cn.bing.com/search?q=intel+ht&go=%E6%8F%90%E4%BA%A4&qs=ds&form=QBLHCN</a></p>
</blockquote>
<h4 id=与多进程的区别>与多进程的区别<a hidden class=anchor aria-hidden=true href=#与多进程的区别>#</a></h4>
<blockquote>
<p>“进程——资源分配的最小单位，线程——程序执行的最小单位”</p>
</blockquote>
<p>实际应用中基本上都是“进程+线程”的结合方式，千万不要真的陷入一种非此即彼的误区。</p>
<table>
<thead>
<tr>
<th style=text-align:center>对比维度</th>
<th style=text-align:center>多进程</th>
<th style=text-align:center>多线程</th>
<th style=text-align:center>总结</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>数据共享、同步</td>
<td style=text-align:center>数据共享复杂，需要用IPC；数据是分开的，同步简单</td>
<td style=text-align:center>因为共享进程数据，数据共享简单，但也是因为这个原因导致同步复杂</td>
<td style=text-align:center>各有优势</td>
</tr>
<tr>
<td style=text-align:center>内存、CPU</td>
<td style=text-align:center>占用内存多，切换复杂，CPU利用率低</td>
<td style=text-align:center>占用内存少，切换简单，CPU利用率高</td>
<td style=text-align:center>线程占优</td>
</tr>
<tr>
<td style=text-align:center>创建销毁、切换</td>
<td style=text-align:center>创建销毁、切换复杂，速度慢</td>
<td style=text-align:center>创建销毁、切换简单，速度很快</td>
<td style=text-align:center>线程占优</td>
</tr>
<tr>
<td style=text-align:center>编程、调试</td>
<td style=text-align:center>编程简单，调试简单</td>
<td style=text-align:center>编程复杂，调试复杂</td>
<td style=text-align:center>进程占优</td>
</tr>
<tr>
<td style=text-align:center>可靠性</td>
<td style=text-align:center>进程间不会互相影响</td>
<td style=text-align:center>一个线程挂掉将导致整个进程挂掉</td>
<td style=text-align:center>进程占优</td>
</tr>
<tr>
<td style=text-align:center>分布式</td>
<td style=text-align:center>适应于多核、多机分布式；如果一台机器不够，扩展到多台机器比较简单</td>
<td style=text-align:center>适应于多核分布式</td>
<td style=text-align:center>进程占优</td>
</tr>
</tbody>
</table>
<ul>
<li>需要注意：</li>
</ul>
<blockquote>
<p>1）需要频繁创建销毁的优先用线程</p>
<p>2）需要进行大量计算的优先使用线程</p>
<p>3）强相关的处理用线程，弱相关的处理用进程</p>
<p>一般的Server需要完成如下任务：消息收发、消息处理。“消息收发”和“消息处理”就是弱相关的任务，而“消息处理”里面可能又分为“消息解码”、“业务处理”，这两个任务相对来说相关性就要强多了。因此“消息收发”和“消息处理”可以分进程设计，“消息解码”、“业务处理”可以分线程设计。当然这种划分方式不是一成不变的，也可以根据实际情况进行调整。</p>
<p>4）可能要扩展到多机分布的用进程，多核分布的用线程</p>
<p>5）都满足需求的情况下，用你最熟悉、最拿手的方式</p>
<p>来自 <a href=https://blog.csdn.net/lishenglong666/article/details/8557215>https://blog.csdn.net/lishenglong666/article/details/8557215</a></p>
</blockquote>
<h4 id=如何使用>如何使用？<a hidden class=anchor aria-hidden=true href=#如何使用>#</a></h4>
<p>需要CPU、BIOS、操作系统、应用软件都支持多线程技术才可以。</p>
<h4 id=支持多线程的cpu>支持多线程的<code>CPU</code><a hidden class=anchor aria-hidden=true href=#支持多线程的cpu>#</a></h4>
<p><code>Power CPU </code>支持的<code>SMT</code>技术：</p>
<blockquote>
<p>Simultaneous multithreading (SMT) is a processor technology that allows multiple instruction streams (threads) to run concurrently on the same physical processor, improving overall throughput. To the operating system, each hardware thread is treated as an independent logical processor. Single-threaded (ST) execution mode is also supported.</p>
<p>来自 <a href="https://www.ibm.com/support/knowledgecenter/SSFHY8_6.2/reference/am5gr_f0106.html?view=embed">https://www.ibm.com/support/knowledgecenter/SSFHY8_6.2/reference/am5gr_f0106.html?view=embed</a></p>
</blockquote>
<p><code>Intel CPU </code>支持的<code>HT</code>技术：</p>
<blockquote>
<p>Intel® Hyper-Threading Technology (Intel® HT Technology) uses processor resources more efficiently, enabling multiple threads to run on each core. As a performance feature, it also increases processor throughput, improving overall performance on threaded software. Intel® HT Technology is available on the latest Intel® Core™ vPro™ processors, the Intel® Core™ processor family, the Intel® Core™ M processor family, and the Intel® Xeon® processor family. By combining one of these Intel® processors and chipsets with an operating system and BIOS supporting Intel® HT Technology.</p>
<p>来自 <a href=https://www.intel.com/content/www/us/en/architecture-and-technology/hyper-threading/hyper-threading-technology.html>https://www.intel.com/content/www/us/en/architecture-and-technology/hyper-threading/hyper-threading-technology.html</a></p>
</blockquote>
<h4 id=smtht支持情况><code>SMT/HT</code>支持情况<a hidden class=anchor aria-hidden=true href=#smtht支持情况>#</a></h4>
<ul>
<li>Intel CPU : 2 Thread/Core</li>
<li>Power9 CPU： 8 Thread /Core</li>
<li>Sparc: 8 Thread /Core</li>
</ul>
<h5 id=rhel7centos7--intel-cpu><code>RHEL7/CentOS7 & Intel CPU</code><a hidden class=anchor aria-hidden=true href=#rhel7centos7--intel-cpu>#</a></h5>
<p><code>BIOS </code>中修改<code>SMT/HT</code> 的设置，使用这种方式<code>Enable</code>或者<code>Disable</code>后，将永久生效，需要重启。</p>
<pre tabindex=0><code>Hyper-Threading Technology BIOS Setup Options

For Intel® Desktop/Server Boards setup option location is the main menu of the BIOS setup program.

 • Located on the same menu screen that already had Processor Type, Processor Speed, System Bus Speed, and other related processor fields.

 • Setup Option Text

  ○ The field is called Hyper-Threading Technology.

 • Setup Option Values

  ○ The setup option values are Enabled and Disabled.

 • Setup Option Help Text

来自 &lt;https://www.intel.com/content/www/us/en/support/articles/000007645/boards-and-kits/desktop-boards.html&gt; 
</code></pre><p><code>RHEL/CentOS</code>操作系统中查看多线程情况：（更多信息：https://access.redhat.com/solutions/rhel-smt）</p>
<pre tabindex=0><code># lscpu | grep -e Socket -e Core -e Thread
Thread(s) per core: 2 # 线程数
Core(s) per socket: 6 # core 数量
Socket(s): 2
</code></pre><p>或者</p>
<pre tabindex=0><code># grep -H . /sys/devices/system/cpu/cpu*/topology/thread_siblings_list | sort -n -t ':' -k 2 -u

# 显示 /sys/devices/system/cpu/cpu0/topology/thread_siblings_list:0 # 表示HT关闭
# 显示 /sys/devices/system/cpu/cpu0/topology/thread_siblings_list:0-1 # 表示 HT 启用
</code></pre><p>操作系统层关闭多线程有几种办法：</p>
<ul>
<li>方法一：使用<code>nosmt</code>启动参数，需要新的<code>x86 CPU</code>，需要重启</li>
</ul>
<pre tabindex=0><code># grubby --args=nosmt --update-kernel=DEFAULT
# grub2-mkconfig -o  /boot/grub/grub.conf   # 创建新的grub.conf
# reboot  #重启
</code></pre><ul>
<li>方法二：临时关闭，重启后失效</li>
</ul>
<pre tabindex=0><code># echo off &gt; /sys/devices/system/cpu/smt/control
 /sys/devices/system/cpu/smt/control:
This file allows to read out the SMT control state and provides the
     ability to disable or (re)enable SMT. The possible states are:
============== ===================================================
        on SMT is supported by the CPU and enabled. All
                        logical CPUs can be onlined and offlined without
                        restrictions.
off SMT is supported by the CPU and disabled. Only
                        the so called primary SMT threads can be onlined
                        and offlined without restrictions. An attempt to
                        online a non-primary sibling is rejected
forceoff Same as 'off' but the state cannot be controlled.
                        Attempts to write to the control file are rejected.
notsupported The processor does not support SMT. It's therefore
                        not affected by the SMT implications of L1TF.
                        Attempts to write to the control file are rejected.
        ============== ===================================================
The possible states which can be written into this file to control SMT
     state are:
     - on
     - off
     - forceoff
/sys/devices/system/cpu/smt/active:
This file reports whether SMT is enabled and active, i.e. if on any
     physical core two or more sibling threads are online.
</code></pre><h5 id=aix--power>AIX & Power<a hidden class=anchor aria-hidden=true href=#aix--power>#</a></h5>
<p><code>Power9 CPU</code>默认支持8线程，使用<code>smtctl</code>命令可以查看和修改<code> smt</code>级别。更多内容查看https://www.ibm.com/support/knowledgecenter/ssw_aix_72/com.ibm.aix.cmds5/smtctl.htm</p>
<ul>
<li>查看<code> SMT level</code></li>
</ul>
<pre tabindex=0><code>smtctl
</code></pre><ul>
<li>临时修改 <code>SMT level</code>, # 可以是 <code>1, 2, 4 or 8</code>，重启后将恢复原来的<code>smt level</code></li>
</ul>
<pre tabindex=0><code>smtctl -t 2 -w now
</code></pre><ul>
<li>修改 <code>SMT level</code>永久生效，# 可以是 <code>1, 2, 4 or 8</code>，完成后需要使用<code>bosboot</code>创建启动设备</li>
</ul>
<pre tabindex=0><code> smtctl -t 4 -w boot
 bosboot -a # Creates complete boot image and device.
</code></pre><h5 id=rhel7--power>RHEL7 & Power<a hidden class=anchor aria-hidden=true href=#rhel7--power>#</a></h5>
<p><code>OpenPower CPU</code> 默认支持4线程，安装<code>RHEL</code>后可以使用开源的工具 <code>ppc64_cpu</code>进行查看和修改多线程（更多查看 <a href=https://github.com/ibm-power-utilities/powerpc-utils>https://github.com/ibm-power-utilities/powerpc-utils</a>）。</p>
<pre tabindex=0><code>ppc64_cpu
---------

This allows users to set the smt state, smt-snooze-delay and other settings

on ppc64 processors. It also allows users to control the number of processor

cores which are online (not in the sleep state).
来自 &lt;https://github.com/ibm-power-utilities/powerpc-utils&gt; 
</code></pre><p>1，查看 <code>SMT level</code></p>
<pre tabindex=0><code>ppc64_cpu --smt
</code></pre><p>2，修改 <code>SMT </code>级别， <code># is 1, 2, 4 or on</code></p>
<pre tabindex=0><code>ppc64_cpu --smt=#
</code></pre><p>3， 关闭 <code>smt</code>支持</p>
<pre tabindex=0><code>ppc64_cpu --smt=off
</code></pre><h4 id=其他>其他<a hidden class=anchor aria-hidden=true href=#其他>#</a></h4>
<h5 id=oracle数据库><code>oracle</code>数据库<a hidden class=anchor aria-hidden=true href=#oracle数据库>#</a></h5>
<p><code>Oracle Database</code> 在12c之前<code>windows</code>平台下支持多线程，<code>Unix</code>和<code>Linux</code>只支持多进程模式。在<code>Oracle Database 12c</code>中，<code>Oracle</code>引入了多线程模式，允许在<code>Windows</code>平台之外的<code>Unix</code>、<code>Linux</code>系统使用多线程模式，结合多进程与多线程模式，<code>Oracle</code>可以改进进程管理与性能。</p>
<p>通过设置初始化参数<code>threaded_execution</code>，可以启用或关闭多线程模式，该参数缺省值为<code>False</code>，设置为<code>TRUE</code>启用12c的这个新特性：</p>
<pre tabindex=0><code>SQL&gt; show parameter threaded_exec

NAME TYPE VALUE

---

threaded_execution boolean FALSE

SQL&gt; alter system set threaded_execution=true scope=spfile;

System altered.
</code></pre><p>该参数重新启动数据库后生效，但是注意，多线程模式，不支持操作系统认证，不能直接启动数据库，需要提供<code>SYS</code>的密码认证后方能启动数据库：</p>
<pre tabindex=0><code>SQL&gt; shutdown immediate;

SQL&gt; startup

ORA-01017: invalid username/password; logon denied

# 需要通过用户名和密码登录数据库。
</code></pre><p>用<code>ps -ef</code> 检查一下进程/线程：</p>
<pre tabindex=0><code>[oracle@enmocoredb dbs]$ ps -ef|grep ora_
oracle 27404 1 0 17:00 ? 00:00:00 ora_pmon_core
oracle 27406 1 0 17:00 ? 00:00:00 ora_psp0_core
oracle 27408 1 3 17:00 ? 00:00:05 ora_vktm_core
oracle 27412 1 0 17:00 ? 00:00:00 ora_u004_core
oracle 27418 1 0 17:00 ? 00:00:00 ora_u005_core
oracle 27424 1 0 17:00 ? 00:00:00 ora_dbw0_core
其中U&lt;NNN&gt;进程是共享线程的&quot;容器进程&quot;，每个进程可以容纳100个线程。
来自 https://www.eygle.com/archives/2013/07/oracle_database_12c_multithreaded_model.html 
</code></pre><h3 id=连接热点>连接热点<a hidden class=anchor aria-hidden=true href=#连接热点>#</a></h3>
<ul>
<li>
<p>打开WIFI</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ifconfig interface up 
</code></pre></div></li>
<li>
<p>查看所有可用的无线网络信号</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>iw wlp2s0 scan | grep SSID
</code></pre></div></li>
<li>
<p>连接无线网</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>wpa_supplicant -B -i wlp2s0 -c &lt;<span style=color:#f92672>(</span>wpa_passphrase <span style=color:#e6db74>&#34;SSID&#34;</span> <span style=color:#e6db74>&#34;passwd&#34;</span><span style=color:#f92672>)</span> 
</code></pre></div></li>
<li>
<p>分配IP地址</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dhclient interface
</code></pre></div></li>
<li>
<p>查看无线网卡地址信息，有ip地址表示网络连接成功</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ifconfig interface
</code></pre></div></li>
</ul>
<h3 id=pppoe-adsl拨号上网>PPPOE （ADSL）拨号上网<a hidden class=anchor aria-hidden=true href=#pppoe-adsl拨号上网>#</a></h3>
<ul>
<li>
<p>安装拨号软件</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dnf install  rp-pppoe* ppp*
</code></pre></div></li>
<li>
<p>设定</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>pppoe-setup
</code></pre></div></li>
<li>
<p>拨号上网</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>pppoe-stoppppoe-start
</code></pre></div></li>
</ul>
<h3 id=安装中文输入法>安装中文输入法<a hidden class=anchor aria-hidden=true href=#安装中文输入法>#</a></h3>
<ul>
<li>
<p>安装 fcitx</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dnf install fcitx-im fcitx-configtool fcitx-googlepinyin
</code></pre></div></li>
<li>
<p>配置</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ nano ~/.xprofile  <span style=color:#75715e># or ~/.bashrc</span>
export GTK_MODULE<span style=color:#f92672>=</span>fcitx
export QT_IM_MODULE<span style=color:#f92672>=</span>fcitx
export XMODIFIERS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@im=fcitx&#34;</span>
</code></pre></div></li>
<li>
<p>fcitx 没图标：重装fcitx，在fcitx配置里关掉Kimpanel</p>
</li>
</ul>
<h3 id=关闭触摸板>关闭触摸板<a hidden class=anchor aria-hidden=true href=#关闭触摸板>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dnf install xorg-x11-apps 
synclient TouchpadOff<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    <span style=color:#75715e># 关闭</span>
synclient TouchpadOff<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    <span style=color:#75715e># 开启</span>
</code></pre></div><h3 id=用-mtp-挂载手机>用 MTP 挂载手机<a hidden class=anchor aria-hidden=true href=#用-mtp-挂载手机>#</a></h3>
<ul>
<li>
<p>安装jmtpfs</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dnf install jmtpfs
</code></pre></div></li>
<li>
<p>查看手机 “busnum”和“devnum”</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>jmptfs -l
</code></pre></div></li>
<li>
<p>建立挂载点</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir /media/dir
</code></pre></div></li>
<li>
<p>挂载手机</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>jmtpfs -device<span style=color:#f92672>=</span>busnum,devnum /media/dir/
</code></pre></div></li>
</ul>
<h3 id=查找依赖>查找依赖<a hidden class=anchor aria-hidden=true href=#查找依赖>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ yum whatprovide package
$ dnf provides package
</code></pre></div><h3 id=默认字体>默认字体<a hidden class=anchor aria-hidden=true href=#默认字体>#</a></h3>
<p>CentOS 默认字体目录 <code>/lib/kbd/consolefonts</code></p>
<p>纯命令行是不能使用系统之外的字体的。</p>
<h3 id=centos-minimal--xfce>CentOS Minimal + Xfce<a hidden class=anchor aria-hidden=true href=#centos-minimal--xfce>#</a></h3>
<p>base 源与 epel 源，使用用阿里镜像: <a href=https://developer.aliyun.com/mirror/>https://developer.aliyun.com/mirror/</a></p>
<ul>
<li>
<p>安装Xfce4，先安装 Xfce 可以保证不安装多余的包</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dnf group listdnf groupinstall Xfce
</code></pre></div></li>
<li>
<p>安装 X Window system</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dnf groupinstall <span style=color:#e6db74>&#34;X Window system&#34;</span>
</code></pre></div></li>
<li>
<p>验证</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl isolate graphical.target
</code></pre></div></li>
<li>
<p>设置</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 设置成命令模式systemctl set-default multi-user.target        # 设置成图形模式systemctl set-default graphical.target        </span>
</code></pre></div></li>
<li>
<p>安装中文字体和中文输入法楷体字体</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dnf install cjkuni-ukai-fonts
</code></pre></div></li>
<li>
<p>输入法需要安装如下包：</p>
<ul>
<li>ibus， 这个包里有ibus-daemon这个平台服务器程序和ibus这个配置助手。</li>
<li>ibus-libpinyin， 这个是ibus平台下具体的拼音输入法。</li>
<li>im-chooser,这个是输入法平台选择助手程序。</li>
<li>执行im-chooser，选择输入法平台和输入法。重新登录系统。</li>
</ul>
</li>
<li>
<p>xfce 主题</p>
<ul>
<li>网站：xfce-look.org</li>
<li>主题目录： <code>/usr/share/themes</code> 或 <code>~/.themes</code></li>
<li>图标鼠标目录： <code>/usr/share/icons</code> 或 <code>~/.icons</code></li>
<li>壁纸： <code>/usr/share/background</code> , <code>/usr/share/wallpapers</code></li>
<li><a href=http://li.nux.ro/>Plank</a></li>
</ul>
</li>
</ul>
<h2 id=selinux>SELinux<a hidden class=anchor aria-hidden=true href=#selinux>#</a></h2>
<h3 id=selinux-初探>SELinux 初探<a hidden class=anchor aria-hidden=true href=#selinux-初探>#</a></h3>
<p>從進入了 CentOS 5.x 之後的 CentOS 版本中 (當然包括 CentOS 7)，SELinux 已經是個非常完備的核心模組了！尤其 CentOS 提供了很多管理 SELinux 的指令與機制， 因此在整體架構上面是單純且容易操作管理的！所以，在沒有自行開發網路服務軟體以及使用其他第三方協力軟體的情況下， 也就是全部使用 CentOS 官方提供的軟體來使用我們伺服器的情況下，建議大家不要關閉 SELinux 了喔！ 讓我們來仔細的玩玩這傢伙吧！</p>
<h4 id=什麼是-selinux>什麼是 SELinux<a hidden class=anchor aria-hidden=true href=#什麼是-selinux>#</a></h4>
<p>什麼是 SELinux 呢？其實他是『 Security Enhanced Linux 』的縮寫，字面上的意義就是安全強化的 Linux 之意！那麼所謂的『安全強化』是強化哪個部分？ 是網路資安還是權限管理？底下就讓我們來談談吧！</p>
<h5 id=當初設計的目標避免資源的誤用>當初設計的目標：避免資源的誤用<a hidden class=anchor aria-hidden=true href=#當初設計的目標避免資源的誤用>#</a></h5>
<p>SELinux 是由美國國家安全局 (NSA) 開發的，當初開發這玩意兒的目的是因為很多企業界發現， 通常系統出現問題的原因大部分都在於『內部員工的資源誤用』所導致的，實際由外部發動的攻擊反而沒有這麼嚴重。 那麼什麼是『員工資源誤用』呢？舉例來說，如果有個不是很懂系統的系統管理員為了自己設定的方便，將網頁所在目錄 /var/www/html/ 的權限設定為 drwxrwxrwx 時，你覺得會有什麼事情發生？</p>
<p>現在我們知道所有的系統資源都是透過程序來進行存取的，那麼 /var/www/html/ 如果設定為 777 ， 代表所有程序均可對該目錄存取，萬一你真的有啟動 WWW 伺服器軟體，那麼該軟體所觸發的程序將可以寫入該目錄， 而該程序卻是對整個 Internet 提供服務的！只要有心人接觸到這支程序，而且該程序剛好又有提供使用者進行寫入的功能， 那麼外部的人很可能就會對你的系統寫入些莫名其妙的東西！那可真是不得了！一個小小的 777 問題可是大大的！</p>
<p>為了控管這方面的權限與程序的問題，所以美國國家安全局就著手處理作業系統這方面的控管。 由於 Linux 是自由軟體，程式碼都是公開的，因此她們便使用 Linux 來作為研究的目標， 最後更將研究的結果整合到 Linux 核心裡面去，那就是 SELinux 啦！所以說， SELinux 是整合到核心的一個模組喔！ 更多的 SELinux 相關說明可以參考：http://www.nsa.gov/research/selinux/</p>
<p>這也就是說：其實 SELinux 是在進行程序、檔案等細部權限設定依據的一個核心模組！ 由於啟動網路服務的也是程序，因此剛好也能夠控制網路服務能否存取系統資源的一道關卡！ 所以，在講到 SELinux 對系統的存取控制之前，我們得先來回顧一下之前談到的系統檔案權限與使用者之間的關係。 因為先談完這個你才會知道為何需要 SELinux 的啦！</p>
<h5 id=傳統的檔案權限與帳號關係自主式存取控制-dac>傳統的檔案權限與帳號關係：自主式存取控制, DAC<a hidden class=anchor aria-hidden=true href=#傳統的檔案權限與帳號關係自主式存取控制-dac>#</a></h5>
<p>我們通过<a href=http://old.linux.vbird.org/linux_basic/0410accountmanager.php>Linux 帳號管理與 ACL 權限設定</a>的內容，知道系統的帳號主要分為系統管理員 (root) 與一般用戶，而這兩種身份能否使用系統上面的檔案資源則與 rwx 的權限設定有關。 不過你要注意的是，各種權限設定對 root 是無效的。因此，當某個程序想要對檔案進行存取時， 系統就會根據該程序的擁有者/群組，並比對檔案的權限，若通過權限檢查，就可以存取該檔案了。</p>
<p>這種存取檔案系統的方式被稱為『自主式存取控制 (Discretionary Access Control, DAC)』，基本上，就是依據程序的擁有者與檔案資源的 rwx 權限來決定有無存取的能力。 不過這種 DAC 的存取控制有幾個困擾，那就是：</p>
<ul>
<li>root 具有最高的權限：如果不小心某支程序被有心人士取得， 且該程序屬於 root 的權限，那麼這支程序就可以在系統上進行任何資源的存取！真是要命！</li>
<li>使用者可以取得程序來變更檔案資源的存取權限：如果你不小心將某個目錄的權限設定為 777 ，由於對任何人的權限會變成 rwx ，因此該目錄就會被任何人所任意存取！</li>
</ul>
<p>這些問題是非常嚴重的！尤其是當你的系統是被某些漫不經心的系統管理員所掌控時！他們甚至覺得目錄權限調為 777 也沒有什麼了不起的危險哩&mldr;</p>
<h5 id=以政策規則訂定特定程序讀取特定檔案委任式存取控制-mac>以政策規則訂定特定程序讀取特定檔案：委任式存取控制, MAC<a hidden class=anchor aria-hidden=true href=#以政策規則訂定特定程序讀取特定檔案委任式存取控制-mac>#</a></h5>
<p>現在我們知道 DAC 的困擾就是當使用者取得程序後，他可以藉由這支程序與自己預設的權限來處理他自己的檔案資源。 萬一這個使用者對 Linux 系統不熟，那就很可能會有資源誤用的問題產生。為了避免 DAC 容易發生的問題，因此 SELinux 導入了委任式存取控制 (Mandatory Access Control, MAC) 的方法！</p>
<p>委任式存取控制 (MAC) 有趣啦！他可以針對特定的程序與特定的檔案資源來進行權限的控管！ 也就是說，即使你是 root ，那麼在使用不同的程序時，你所能取得的權限並不一定是 root ， 而得要看當時該程序的設定而定。如此一來，我們針對控制的『主體』變成了『程序』而不是使用者喔！ 此外，這個主體程序也不能任意使用系統檔案資源，因為每個檔案資源也有針對該主體程序設定可取用的權限！ 如此一來，控制項目就細的多了！但整個系統程序那麼多、檔案那麼多，一項一項控制可就沒完沒了！ 所以 SELinux 也提供一些預設的政策 (Policy) ，並在該政策內提供多個規則 (rule) ，讓你可以選擇是否啟用該控制規則！</p>
<p>在委任式存取控制的設定下，我們的程序能夠活動的空間就變小了！舉例來說， WWW 伺服器軟體的達成程序為 httpd 這支程式， 而預設情況下， httpd 僅能在 /var/www/ 這個目錄底下存取檔案，如果 httpd 這個程序想要到其他目錄去存取資料時， 除了規則設定要開放外，目標目錄也得要設定成 httpd 可讀取的模式 (type) 才行喔！限制非常多！ 所以，即使不小心 httpd 被 cracker 取得了控制權，他也無權瀏覽 /etc/shadow 等重要的設定檔喔！</p>
<p>簡單的來說，針對 Apache 這個 WWW 網路服務使用 DAC 或 MAC 的結果來說，兩者間的關係可以使用下圖來說明。 底下這個圖示取自 Red Hat 訓練教材，真的是很不錯～所以被鳥哥借用來說明一下！</p>
<p><img loading=lazy src=/Distributions/dac_mac.jpg alt="使用 DAC/MAC 產生的不同結果，以 Apache 為例說明">
</p>
<p>左圖是沒有 SELinux 的 DAC 存取結果，apache 這隻 root 所主導的程序，可以在這三個目錄內作任何檔案的新建與修改～ 相當麻煩～右邊則是加上 SELinux 的 MAC 管理的結果，SELinux 僅會針對 Apache 這個『 process 』放行部份的目錄， 其他的非正規目錄就不會放行給 Apache 使用！因此不管你是誰，就是不能穿透 MAC 的框框！這樣有比較了解乎？</p>
<h4 id=selinux-的運作模式>SELinux 的運作模式<a hidden class=anchor aria-hidden=true href=#selinux-的運作模式>#</a></h4>
<p>再次的重複說明一下，SELinux 是透過 MAC 的方式來控管程序，他控制的主體是程序， 而目標則是該程序能否讀取的『檔案資源』！所以先來說明一下這些咚咚的相關性啦！</p>
<ul>
<li>
<p><strong>主體 (Subject)：</strong>
SELinux 主要想要管理的就是程序，因此你可以將『主體』跟本章談到的 process 劃上等號；</p>
</li>
<li>
<p><strong>目標 (Object)：</strong>
主體程序能否存取的『目標資源』一般就是檔案系統。因此這個目標項目可以等檔案系統劃上等號；</p>
</li>
<li>
<p><strong>政策 (Policy)</strong>：</p>
<p>由於程序與檔案數量龐大，因此 SELinux 會依據某些服務來制訂基本的存取安全性政策。這些政策內還會有詳細的規則 (rule) 來指定不同的服務開放某些資源的存取與否。在目前的 CentOS 7.x 裡面僅有提供三個主要的政策，分別是：</p>
<ul>
<li>targeted：針對網路服務限制較多，針對本機限制較少，是預設的政策；</li>
<li>minimum：由 target 修訂而來，僅針對選擇的程序來保護！</li>
<li>mls：完整的 SELinux 限制，限制方面較為嚴格。</li>
</ul>
<p>建議使用預設的 targeted 政策即可。</p>
</li>
<li>
<p><strong>安全性本文 (security context)：</strong>
我們剛剛談到了主體、目標與政策面，但是主體能不能存取目標除了政策指定之外，主體與目標的安全性本文必須一致才能夠順利存取。 這個安全性本文 (security context) 有點類似檔案系統的 rwx 啦！安全性本文的內容與設定是非常重要的！ 如果設定錯誤，你的某些服務(主體程序)就無法存取檔案系統(目標資源)，當然就會一直出現『權限不符』的錯誤訊息了！</p>
</li>
</ul>
<p>由於 SELinux 重點在保護程序讀取檔案系統的權限，因此我們將上述的幾個說明搭配起來，繪製成底下的流程圖，比較好理解：</p>
<p><img loading=lazy src=/Distributions/selinux_1.gif alt="SELinux 運作的各元件之相關性">
</p>
<p>上圖的重點在『主體』如何取得『目標』的資源存取權限！ 由上圖我們可以發現，(1)主體程序必須要通過 SELinux 政策內的規則放行後，就可以與目標資源進行安全性本文的比對， (2)若比對失敗則無法存取目標，若比對成功則可以開始存取目標。問題是，最終能否存取目標還是與檔案系統的 rwx 權限設定有關喔！如此一來，加入了 SELinux 之後，出現權限不符的情況時，你就得要一步一步的分析可能的問題了！</p>
<h5 id=安全性本文-security-context>安全性本文 (Security Context)<a hidden class=anchor aria-hidden=true href=#安全性本文-security-context>#</a></h5>
<p>CentOS 7.x 的 target 政策已經幫我們制訂好非常多的規則了，因此你只要知道如何開啟/關閉某項規則的放行與否即可。 那個安全性本文比較麻煩！因為你可能需要自行設定檔案的安全性本文呢！為何需要自行設定啊？ 舉例來說，你不也常常進行檔案的 rwx 的重新設定嗎？這個安全性本文你就將他想成 SELinux 內必備的 rwx 就是了！這樣比較好理解啦。</p>
<p>安全性本文存在於主體程序中與目標檔案資源中。程序在記憶體內，所以安全性本文可以存入是沒問題。 那檔案的安全性本文是記錄在哪裡呢？事實上，安全性本文是放置到檔案的 inode 內的，因此主體程序想要讀取目標檔案資源時，同樣需要讀取 inode ， 在 inode 內就可以比對安全性本文以及 rwx 等權限值是否正確，而給予適當的讀取權限依據。</p>
<p>那麼安全性本文到底是什麼樣的存在呢？我們先來看看 /root 底下的檔案的安全性本文好了。 觀察安全性本文可使用『 ls -Z 』去觀察如下：(注意：你必須已經啟動了 SELinux 才行！若尚未啟動，這部份請稍微看過一遍即可。底下會介紹如何啟動 SELinux 喔！)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 先來觀察一下 root 家目錄底下的『檔案的 SELinux 相關資訊』</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ls -Z</span>
-rw-------. root root system_u:object_r:admin_home_t:s0     anaconda-ks.cfg
-rw-r--r--. root root system_u:object_r:admin_home_t:s0     initial-setup-ks.cfg
-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 regular_express.txt
<span style=color:#75715e># 上述特殊字體的部分，就是安全性本文的內容！鳥哥僅列出數個預設的檔案而已，</span>
<span style=color:#75715e># 本書學習過程中所寫下的檔案則沒有列在上頭喔！</span>
</code></pre></div><p>如上所示，安全性本文主要用冒號分為三個欄位，這三個欄位的意義為：</p>
<pre tabindex=0><code>Identify:role:type
身份識別:角色:類型
</code></pre><p>這三個欄位的意義仔細的說明一下吧：</p>
<ul>
<li>
<p>身份識別 (Identify)：</p>
<p>相當於帳號方面的身份識別！主要的身份識別常見有底下幾種常見的類型：</p>
<ul>
<li>
<p>unconfined_u：不受限的用戶，也就是說，該檔案來自於不受限的程序所產生的！一般來說，我們使用可登入帳號來取得 bash 之後， 預設的 bash 環境是不受 SELinux 管制的～因為 bash 並不是什麼特別的網路服務！因此，在這個不受 SELinux 所限制的 bash 程序所產生的檔案， 其身份識別大多就是 unconfined_u 這個『不受限』用戶囉！</p>
</li>
<li>
<p>system_u：系統用戶，大部分就是系統自己產生的檔案囉！</p>
</li>
</ul>
<p>基本上，如果是系統或軟體本身所提供的檔案，大多就是 system_u 這個身份名稱，而如果是我們用戶透過 bash 自己建立的檔案，大多則是不受限的 unconfined_u 身份～如果是網路服務所產生的檔案，或者是系統服務運作過程產生的檔案，則大部分的識別就會是 system_u 囉！</p>
<p>因為鳥哥這邊教大家使用文字界面來產生許多的資料，因此你看上面的三個檔案中，系統安裝主動產生的 anaconda-ks.cfs 及 initial-setup-ks.cfg 就會是 system_u，而我們自己從網路上面抓下來的 regular_express.txt 就會是 unconfined_u 這個識別啊！</p>
</li>
<li>
<p>角色 (Role)：</p>
<p>透過角色欄位，我們可以知道這個資料是屬於程序、檔案資源還是代表使用者。一般的角色有：</p>
<ul>
<li>
<p>object_r：代表的是檔案或目錄等檔案資源，這應該是最常見的囉；</p>
</li>
<li>
<p>system_r：代表的就是程序啦！不過，一般使用者也會被指定成為 system_r 喔！</p>
</li>
</ul>
<p>你也會發現角色的欄位最後面使用『 _r 』來結尾！因為是 role 的意思嘛！</p>
</li>
<li>
<p>類型 (Type) (最重要！)：</p>
<p>在預設的 targeted 政策中， Identify 與 Role 欄位基本上是不重要的！重要的在於這個類型 (type) 欄位！ 基本上，一個主體程序能不能讀取到這個檔案資源，與類型欄位有關！而類型欄位在檔案與程序的定義不太相同，分別是：</p>
<ul>
<li>
<p>type：在檔案資源 (Object) 上面稱為類型 (Type)；</p>
</li>
<li>
<p>domain：在主體程序 (Subject) 則稱為領域 (domain) 了！</p>
</li>
</ul>
<p>domain 需要與 type 搭配，則該程序才能夠順利的讀取檔案資源啦！</p>
</li>
</ul>
<h5 id=程序與檔案-selinux-type-欄位的相關性>程序與檔案 SELinux type 欄位的相關性<a hidden class=anchor aria-hidden=true href=#程序與檔案-selinux-type-欄位的相關性>#</a></h5>
<p>那麼這三個欄位如何利用呢？首先我們來瞧瞧主體程序在這三個欄位的意義為何！透過身份識別與角色欄位的定義， 我們可以約略知道某個程序所代表的意義喔！先來動手瞧一瞧目前系統中的程序在 SELinux 底下的安全本文為何？</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 再來觀察一下系統『程序的 SELinux 相關資訊』</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ps -eZ</span>
LABEL                             PID TTY          TIME CMD
system_u:system_r:init_t:s0         <span style=color:#ae81ff>1</span> ?        00:00:03 systemd
system_u:system_r:kernel_t:s0       <span style=color:#ae81ff>2</span> ?        00:00:00 kthreadd
system_u:system_r:kernel_t:s0       <span style=color:#ae81ff>3</span> ?        00:00:00 ksoftirqd/0
.....<span style=color:#f92672>(</span>中間省略<span style=color:#f92672>)</span>.....
unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 <span style=color:#ae81ff>31513</span> ? 00:00:00 sshd
unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 <span style=color:#ae81ff>31535</span> pts/0 00:00:00 bash
<span style=color:#75715e># 基本上程序主要就分為兩大類，一種是系統有受限的 system_u:system_r，另一種則可能是用戶自己的，</span>
<span style=color:#75715e># 比較不受限的程序 (通常是本機用戶自己執行的程式)，亦即是 unconfined_u:unconfined_r 這兩種！</span>
</code></pre></div><p>基本上，這些對應資料在 targeted 政策下的對應如下：</p>
<table>
<thead>
<tr>
<th>身份識別</th>
<th>角色</th>
<th>該對應在 targeted 的意義</th>
</tr>
</thead>
<tbody>
<tr>
<td>unconfined_u</td>
<td>unconfined_r</td>
<td>一般可登入使用者的程序囉！比較沒有受限的程序之意！大多數都是用戶已經順利登入系統 (不論是網路還是本機登入來取得可用的 shell) 後， 所用來操作系統的程序！如 bash, X window 相關軟體等。</td>
</tr>
<tr>
<td>system_u</td>
<td>system_r</td>
<td>由於為系統帳號，因此是非交談式的系統運作程序，大多數的系統程序均是這種類型！</td>
</tr>
</tbody>
</table>
<p>但就如上所述，在預設的 target 政策下，其實最重要的欄位是類型欄位 (type)， 主體與目標之間是否具有可以讀寫的權限，與程序的 domain 及檔案的 type 有關！這兩者的關係我們可以使用 crond 以及他的設定檔來說明！ 亦即是 /usr/sbin/crond, /etc/crontab, /etc/cron.d 等檔案來說明。 首先，看看這幾個咚咚的安全性本文內容先：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 1. 先看看 crond 這個『程序』的安全本文內容：</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ps -eZ | grep cron</span>
system_u:system_r:crond_t:s0-s0:c0.c1023 <span style=color:#ae81ff>1338</span> ? 00:00:01 crond
system_u:system_r:crond_t:s0-s0:c0.c1023 <span style=color:#ae81ff>1340</span> ? 00:00:00 atd
<span style=color:#75715e># 這個安全本文的類型名稱為 crond_t 格式！</span>

<span style=color:#75715e># 2. 再來瞧瞧執行檔、設定檔等等的安全本文內容為何！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ll -Zd /usr/sbin/crond /etc/crontab /etc/cron.d</span>
drwxr-xr-x. root root system_u:object_r:system_cron_spool_t:s0 /etc/cron.d
-rw-r--r--. root root system_u:object_r:system_cron_spool_t:s0 /etc/crontab
-rwxr-xr-x. root root system_u:object_r:crond_exec_t:s0 /usr/sbin/crond
</code></pre></div><p>當我們執行 /usr/sbin/crond 之後，這個程式變成的程序的 domain 類型會是 crond_t 這一個～而這個 crond_t 能夠讀取的設定檔則為 system_cron_spool_t 這種的類型。因此不論 /etc/crontab, /etc/cron.d 以及 /var/spool/cron 都會是相關的 SELinux 類型 (/var/spool/cron 為 user_cron_spool_t)。 文字看起來不太容易了解，我們使用圖示來說明這幾個東西的關係！</p>
<p><img loading=lazy src=/Distributions/centos7_selinux_2.jpg alt="主體程序取得的 domain 與目標檔案資源的 type 相互關係">
</p>
<p>上圖的意義我們可以這樣看的：</p>
<ol>
<li>首先，我們觸發一個可執行的目標檔案，那就是具有 crond_exec_t 這個類型的 /usr/sbin/crond 檔案；</li>
<li>該檔案的類型會讓這個檔案所造成的主體程序 (Subject) 具有 crond 這個領域 (domain)， 我們的政策針對這個領域已經制定了許多規則，其中包括這個領域可以讀取的目標資源類型；</li>
<li>由於 crond domain 被設定為可以讀取 system_cron_spool_t 這個類型的目標檔案 (Object)， 因此你的設定檔放到 /etc/cron.d/ 目錄下，就能夠被 crond 那支程序所讀取了；</li>
<li>但最終能不能讀到正確的資料，還得要看 rwx 是否符合 Linux 權限的規範！</li>
</ol>
<p>上述的流程告訴我們幾個重點，第一個是政策內需要制訂詳細的 domain/type 相關性；第二個是若檔案的 type 設定錯誤， 那麼即使權限設定為 rwx 全開的 777 ，該主體程序也無法讀取目標檔案資源的啦！不過如此一來， 也就可以避免使用者將他的家目錄設定為 777 時所造成的權限困擾。</p>
<p>真的是這樣嗎？沒關係～讓我們來做個測試練習吧！就是，萬一你的 crond 設定檔的 SELinux 並不是 system_cron_spool_t 時， 該設定檔真的可以順利的被讀取運作嗎？來看看底下的範例！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 1. 先假設你因為不熟的緣故，因此是在『root 家目錄』建立一個如下的 cron 設定：</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># vim checktime</span>
<span style=color:#ae81ff>10</span> * * * * root sleep 60s

<span style=color:#75715e># 2. 檢查後才發現檔案放錯目錄了，又不想要保留副本，因此使用 mv 移動到正確目錄：</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># mv checktime /etc/cron.d</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ll /etc/cron.d/checktime</span>
-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>27</span> Aug  <span style=color:#ae81ff>7</span> 18:41 /etc/cron.d/checktime
<span style=color:#75715e># 仔細看喔，權限是 644 ，確定沒有問題！任何程序都能夠讀取喔！</span>

<span style=color:#75715e># 3. 強制重新啟動 crond ，然後偷看一下登錄檔，看看有沒有問題發生！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># systemctl restart crond</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># tail /var/log/cron</span>
Aug  <span style=color:#ae81ff>7</span> 18:46:01 study crond<span style=color:#f92672>[</span>28174<span style=color:#f92672>]</span>: <span style=color:#f92672>((</span>null<span style=color:#f92672>))</span> Unauthorized SELinux context<span style=color:#f92672>=</span>system_u:system_r:
system_cronjob_t:s0-s0:c0.c1023 file_context<span style=color:#f92672>=</span>unconfined_u:object_r:admin_home_t:s0 
<span style=color:#f92672>(</span>/etc/cron.d/checktime<span style=color:#f92672>)</span>
Aug  <span style=color:#ae81ff>7</span> 18:46:01 study crond<span style=color:#f92672>[</span>28174<span style=color:#f92672>]</span>: <span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> FAILED <span style=color:#f92672>(</span>loading cron table<span style=color:#f92672>)</span>
<span style=color:#75715e># 上面的意思是，有錯誤！因為原本的安全本文與檔案的實際安全本文無法搭配的緣故！</span>
</code></pre></div><p>您瞧瞧～從上面的測試案例來看，我們的設定檔確實沒有辦法被 crond 這個服務所讀取喔！而原因在登錄檔內就有說明， 主要就是來自 SELinux 安全本文 (context) type 的不同所致喔！沒辦法讀就沒辦法讀，先放著～後面再來學怎麼處理這問題吧！</p>
<h4 id=selinux-三種模式的啟動關閉與觀察>SELinux 三種模式的啟動、關閉與觀察<a hidden class=anchor aria-hidden=true href=#selinux-三種模式的啟動關閉與觀察>#</a></h4>
<p>並非所有的 Linux distributions 都支援 SELinux 的，所以你必須要先觀察一下你的系統版本為何！ 鳥哥這裡介紹的 CentOS 7.x 本身就有支援 SELinux 啦！所以你不需要自行編譯 SELinux 到你的 Linux 核心中！ 目前 SELinux 依據啟動與否，共有三種模式，分別如下：</p>
<ul>
<li>enforcing：強制模式，代表 SELinux 運作中，且已經正確的開始限制 domain/type 了；</li>
<li>permissive：寬容模式：代表 SELinux 運作中，不過僅會有警告訊息並不會實際限制 domain/type 的存取。這種模式可以運來作為 SELinux 的 debug 之用；</li>
<li>disabled：關閉，SELinux 並沒有實際運作。</li>
</ul>
<p>我們前面不是談過主體程序需要經過政策規則、安全本文比對之後，加上 rwx 的權限規範， 若一切合理才會讓程序順利的讀取檔案嗎？那麼這個 SELinux 的三種模式與上面談到的政策規則、安全本文的關係為何呢？我們還是使用圖示加上流程來讓大家理解一下：</p>
<p><img loading=lazy src=/Distributions/selinux_3.jpg alt="SELinux 的三種類型與實際運作流程圖示意">
</p>
<p>就如上圖所示，首先，你得要知道，並不是所有的程序都會被 SELinux 所管制，因此最左邊會出現一個所謂的『有受限的程序主體』！那如何觀察有沒有受限 (confined )呢？ 很簡單啊！就透過 ps -eZ 去擷取！舉例來說，我們來找一找 crond 與 bash 這兩隻程序是否有被限制吧？</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ps -eZ | grep -E &#39;cron|bash&#39;</span>
system_u:system_r:crond_t:s0-s0:c0.c1023 <span style=color:#ae81ff>1340</span> ? 00:00:00 atd
unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 <span style=color:#ae81ff>13888</span> tty2 00:00:00 bash
unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 <span style=color:#ae81ff>28054</span> pts/0 00:00:00 bash
unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 <span style=color:#ae81ff>28094</span> pts/0 00:00:00 bash
system_u:system_r:crond_t:s0-s0:c0.c1023 <span style=color:#ae81ff>28174</span> ? 00:00:00 crond
</code></pre></div><p>如前所述，因為在目前 target 這個政策底下，只有第三個類型 (type) 欄位會有影響，因此我們上表僅列出第三個欄位的資料而已。 我們可以看到， crond 確實是有受限的主體程序，而 bash 因為是本機程序，因此就是不受限 (unconfined_t) 的類型！也就是說， bash 是不需要經過上圖的流程，而是直接去判斷 rwx 而已～。</p>
<p>了解了受限的主體程序的意義之後，再來了解一下，三種模式的運作吧！首先，如果是 Disabled 的模式，那麼 SELinux 將不會運作，當然受限的程序也不會經過 SELinux ， 也是直接去判斷 rwx 而已。那如果是寬容 (permissive) 模式呢？這種模式也是不會將主體程序抵擋 (所以箭頭是可以直接穿透的喔！)，不過萬一沒有通過政策規則，或者是安全本文的比對時， 那麼該讀寫動作將會被紀錄起來 (log)，可作為未來檢查問題的判斷依據。</p>
<p>至於最終那個 Enforcing 模式，就是實際將受限主體進入規則比對、安全本文比對的流程，若失敗，就直接抵擋主體程序的讀寫行為，並且將他記錄下來。 如果通通沒問題，這才進入到 rwx 權限的判斷喔！這樣可以理解三種模式的行為了嗎？</p>
<p>那你怎麼知道目前的 SELinux 模式呢？就透過 getenforce 吧！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># getenforce</span>
Enforcing  &lt;<span style=color:#f92672>==</span>諾！就顯示出目前的模式為 Enforcing 囉！
</code></pre></div><p>另外，我們又如何知道 SELinux 的政策 (Policy) 為何呢？這時可以使用 sestatus 來觀察：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># sestatus [-vb]</span>
選項與參數：
-v  ：檢查列於 /etc/sestatus.conf 內的檔案與程序的安全性本文內容；
-b  ：將目前政策的規則布林值列出，亦即某些規則 <span style=color:#f92672>(</span>rule<span style=color:#f92672>)</span> 是否要啟動 <span style=color:#f92672>(</span>0/1<span style=color:#f92672>)</span> 之意；

範例一：列出目前的 SELinux 使用哪個政策 <span style=color:#f92672>(</span>Policy<span style=color:#f92672>)</span>？
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># sestatus</span>
SELinux status:                 enabled           &lt;<span style=color:#f92672>==</span>是否啟動 SELinux
SELinuxfs mount:                /sys/fs/selinux   &lt;<span style=color:#f92672>==</span>SELinux 的相關檔案資料掛載點
SELinux root directory:         /etc/selinux      &lt;<span style=color:#f92672>==</span>SELinux 的根目錄所在
Loaded policy name:             targeted          &lt;<span style=color:#f92672>==</span>目前的政策為何？
Current mode:                   enforcing         &lt;<span style=color:#f92672>==</span>目前的模式
Mode from config file:          enforcing         &lt;<span style=color:#f92672>==</span>目前設定檔內規範的 SELinux 模式
Policy MLS status:              enabled           &lt;<span style=color:#f92672>==</span>是否含有 MLS 的模式機制
Policy deny_unknown status:     allowed           &lt;<span style=color:#f92672>==</span>是否預設抵擋未知的主體程序
Max kernel policy version:      <span style=color:#ae81ff>28</span> 
</code></pre></div><p>如上所示，目前是啟動的，而且是 Enforcing 模式，而由設定檔查詢得知亦為 Enforcing 模式。 此外，目前的預設政策為 targeted 這一個。你應該要有疑問的是， SELinux 的設定檔是哪個檔案啊？ 其實就是 /etc/selinux/config 這個檔案喔！我們來看看內容：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># vim /etc/selinux/config</span>
SELINUX<span style=color:#f92672>=</span>enforcing     &lt;<span style=color:#f92672>==</span>調整 enforcing|disabled|permissive
SELINUXTYPE<span style=color:#f92672>=</span>targeted  &lt;<span style=color:#f92672>==</span>目前僅有 targeted, mls, minimum 三種政策
</code></pre></div><p>若有需要修改預設政策的話，就直接改 SELINUX=enforcing 那一行即可喔！</p>
<h5 id=selinux-的啟動與關閉>SELinux 的啟動與關閉<a hidden class=anchor aria-hidden=true href=#selinux-的啟動與關閉>#</a></h5>
<p>上面是預設的政策與啟動的模式！你要注意的是，如果改變了政策則需要重新開機；如果由 enforcing 或 permissive 改成 disabled ，或由 disabled 改成其他兩個，那也必須要重新開機。這是因為 SELinux 是整合到核心裡面去的， 你只可以在 SELinux 運作下切換成為強制 (enforcing) 或寬容 (permissive) 模式，不能夠直接關閉 SELinux 的！ 如果剛剛你發現 getenforce 出現 disabled 時，請到上述檔案修改成為 enforcing 然後重新開機吧！</p>
<p>不過你要注意的是，如果從 disable 轉到啟動 SELinux 的模式時， 由於系統必須要針對檔案寫入安全性本文的資訊，因此開機過程會花費不少時間在等待重新寫入 SELinux 安全性本文 (有時也稱為 SELinux Label) ，而且在寫完之後還得要再次的重新開機一次喔！你必須要等待粉長一段時間！ 等到下次開機成功後，再使用 <a href=/Distributions.php#getenforce>getenforce</a> 或 <a href=/Distributions.php#sestatus>sestatus</a> 來觀察看看有否成功的啟動到 Enforcing 的模式囉！</p>
<p>如果你已經在 Enforcing 的模式，但是可能由於一些設定的問題導致 SELinux 讓某些服務無法正常的運作， 此時你可以將 Enforcing 的模式改為寬容 (permissive) 的模式，讓 SELinux 只會警告無法順利連線的訊息， 而不是直接抵擋主體程序的讀取權限。讓 SELinux 模式在 enforcing 與 permissive 之間切換的方法為：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># setenforce [0|1]</span>
選項與參數：
<span style=color:#ae81ff>0</span> ：轉成 permissive 寬容模式；
<span style=color:#ae81ff>1</span> ：轉成 Enforcing 強制模式

範例一：將 SELinux 在 Enforcing 與 permissive 之間切換與觀察
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># setenforce 0</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># getenforce</span>
Permissive
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># setenforce 1</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># getenforce</span>
Enforcing
</code></pre></div><p>不過請注意， setenforce 無法在 Disabled 的模式底下進行模式的切換喔！</p>
<p>Tips：在某些特殊的情況底下，你從 Disabled 切換成 Enforcing 之後，竟然有一堆服務無法順利啟動，都會跟你說在 /lib/xxx 裡面的資料沒有權限讀取，所以啟動失敗。這大多是由於在重新寫入 SELinux type (Relabel) 出錯之故，使用 Permissive 就沒有這個錯誤。那如何處理呢？最簡單的方法就是在 Permissive 的狀態下，使用『 restorecon -Rv / 』重新還原所有 SELinux 的類型，就能夠處理這個錯誤！</p>
<h4 id=selinux-政策內的規則管理>SELinux 政策內的規則管理<a hidden class=anchor aria-hidden=true href=#selinux-政策內的規則管理>#</a></h4>
<p>我們知道 SELinux 的三種模式是會影響到主體程序的放行與否。 如果是進入 Enforcing 模式，那麼接著下來會影響到主體程序的，當然就是第二關：『 target 政策內的各項規則 (rules) 』了！ 好了，那麼我們怎麼知道目前這個政策裡面到底有多少會影響到主體程序的規則呢？很簡單，就透過 getsebool 來瞧一瞧即可。</p>
<ul>
<li>SELinux 各個規則的布林值查詢 getsebool</li>
</ul>
<p>如果想要查詢系統上面全部規則的啟動與否 (on/off，亦即布林值)，很簡單的透過 sestatus -b 或 getsebool -a 均可！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># getsebool [-a] [規則的名稱]</span>
選項與參數：
-a  ：列出目前系統上面的所有 SELinux 規則的布林值為開啟或關閉值

範例一：查詢本系統內所有的布林值設定狀況
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># getsebool -a</span>
abrt_anon_write --&gt; off
abrt_handle_event --&gt; off
....<span style=color:#f92672>(</span>中間省略<span style=color:#f92672>)</span>....
cron_can_relabel --&gt; off                 <span style=color:#75715e># 這個跟 cornd 比較有關！</span>
cron_userdomain_transition --&gt; on
....<span style=color:#f92672>(</span>中間省略<span style=color:#f92672>)</span>....
httpd_enable_homedirs --&gt; off            <span style=color:#75715e># 這當然就是跟網頁，亦即 http 有關的囉！</span>
....<span style=color:#f92672>(</span>底下省略<span style=color:#f92672>)</span>....
<span style=color:#75715e># 這麼多的 SELinux 規則喔！每個規則後面都列出現在是允許放行還是不許放行的布林值喔！</span>
</code></pre></div><ul>
<li>SELinux 各個規則規範的主體程序能夠讀取的檔案 SELinux type 查詢 seinfo, sesearch</li>
</ul>
<p>我們現在知道有這麼多的 SELinux 規則，但是每個規則內到底是在限制什麼東西？如果你想要知道的話，那就得要使用 seinfo 等工具！ 這些工具並沒有在我們安裝時就安裝了，因此請拿出原版光碟，放到光碟機，鳥哥假設你將原版光碟掛載到 /mnt 底下，那麼接下來這麼作， 先安裝好我們所需要的軟體才行！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># yum install /mnt/Packages/setools-console-*</span>
</code></pre></div><p>很快的安裝完畢之後，我們就可以來使用 seinfo, sesearch 等指令了！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># seinfo [-trub]</span>
選項與參數：
--all ：列出 SELinux 的狀態、規則布林值、身份識別、角色、類別等所有資訊
-u    ：列出 SELinux 的所有身份識別 <span style=color:#f92672>(</span>user<span style=color:#f92672>)</span> 種類
-r    ：列出 SELinux 的所有角色 <span style=color:#f92672>(</span>role<span style=color:#f92672>)</span> 種類
-t    ：列出 SELinux 的所有類別 <span style=color:#f92672>(</span>type<span style=color:#f92672>)</span> 種類
-b    ：列出所有規則的種類 <span style=color:#f92672>(</span>布林值<span style=color:#f92672>)</span>

範例一：列出 SELinux 在此政策下的統計狀態
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># seinfo</span>
Statistics <span style=color:#66d9ef>for</span> policy file: /sys/fs/selinux/policy
Policy Version &amp; Type: v.28 <span style=color:#f92672>(</span>binary, mls<span style=color:#f92672>)</span>

   Classes:            <span style=color:#ae81ff>83</span>    Permissions:       <span style=color:#ae81ff>255</span>
   Sensitivities:       <span style=color:#ae81ff>1</span>    Categories:       <span style=color:#ae81ff>1024</span>
   Types:            <span style=color:#ae81ff>4620</span>    Attributes:        <span style=color:#ae81ff>357</span>
   Users:               <span style=color:#ae81ff>8</span>    Roles:              <span style=color:#ae81ff>14</span>
   Booleans:          <span style=color:#ae81ff>295</span>    Cond. Expr.:       <span style=color:#ae81ff>346</span>
   Allow:          <span style=color:#ae81ff>102249</span>    Neverallow:          <span style=color:#ae81ff>0</span>
   Auditallow:        <span style=color:#ae81ff>160</span>    Dontaudit:        <span style=color:#ae81ff>8413</span>
   Type_trans:      <span style=color:#ae81ff>16863</span>    Type_change:        <span style=color:#ae81ff>74</span>
   Type_member:        <span style=color:#ae81ff>35</span>    Role allow:         <span style=color:#ae81ff>30</span>
   Role_trans:        <span style=color:#ae81ff>412</span>    Range_trans:      <span style=color:#ae81ff>5439</span>
....<span style=color:#f92672>(</span>底下省略<span style=color:#f92672>)</span>....
<span style=color:#75715e># 從上面我們可以看到這個政策是 targeted ，此政策的安全本文類別有 4620 個；</span>
<span style=color:#75715e># 而各種 SELinux 的規則 (Booleans) 共制訂了 295 條！</span>
</code></pre></div><p>我們前面簡單的談到了幾個身份識別 (user) 以及角色 (role) 而已，如果你想要查詢目前所有的身份識別與角色，就使用『 seinfo -u 』及『 seinfo -r 』就可以知道了！至於簡單的統計資料，就直接輸入 seinfo 即可！但是上面還是沒有談到規則相關的東西耶～ 沒關係～一個一個來～我們在 16.5.1 的最後面談到 /etc/cron.d/checktime 的 SELinux type 類型不太對～那我們也知道 crond 這個程序的 type 是 crond_t ， 能不能找一下 crond_t 能夠讀取的檔案 SELinux type 有哪些呢？</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># sesearch [-A] [-s 主體類別] [-t 目標類別] [-b 布林值]</span>
選項與參數：
-A  ：列出後面資料中，允許『讀取或放行』的相關資料
-t  ：後面還要接類別，例如 -t httpd_t
-b  ：後面還要接SELinux的規則，例如 -b httpd_enable_ftp_server

範例一：找出 crond_t 這個主體程序能夠讀取的檔案 SELinux type
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># sesearch -A -s crond_t | grep spool</span>
   allow crond_t system_cron_spool_t : file <span style=color:#f92672>{</span> ioctl read write create getattr ..
   allow crond_t system_cron_spool_t : dir <span style=color:#f92672>{</span> ioctl read getattr lock search op..
   allow crond_t user_cron_spool_t : file <span style=color:#f92672>{</span> ioctl read write create getattr se..
   allow crond_t user_cron_spool_t : dir <span style=color:#f92672>{</span> ioctl read write getattr lock add_n..
   allow crond_t user_cron_spool_t : lnk_file <span style=color:#f92672>{</span> read getattr <span style=color:#f92672>}</span> ;
<span style=color:#75715e># allow 後面接主體程序以及檔案的 SELinux type，上面的資料是擷取出來的，</span>
<span style=color:#75715e># 意思是說，crond_t 可以讀取 system_cron_spool_t 的檔案/目錄類型～等等！</span>

範例二：找出 crond_t 是否能夠讀取 /etc/cron.d/checktime 這個我們自訂的設定檔？
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ll -Z /etc/cron.d/checktime</span>
-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 /etc/cron.d/checktime
<span style=color:#75715e># 兩個重點，一個是 SELinux type 為 admin_home_t，一個是檔案 (file)</span>

<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># sesearch -A -s crond_t | grep admin_home_t</span>
   allow domain admin_home_t : dir <span style=color:#f92672>{</span> getattr search open <span style=color:#f92672>}</span> ;
   allow domain admin_home_t : lnk_file <span style=color:#f92672>{</span> read getattr <span style=color:#f92672>}</span> ;
   allow crond_t admin_home_t : dir <span style=color:#f92672>{</span> ioctl read getattr lock search open <span style=color:#f92672>}</span> ;
   allow crond_t admin_home_t : lnk_file <span style=color:#f92672>{</span> read getattr <span style=color:#f92672>}</span> ;
<span style=color:#75715e># 仔細看！看仔細～雖然有 crond_t admin_home_t 存在，但是這是總體的資訊，</span>
<span style=color:#75715e># 並沒有針對某些規則的尋找～所以還是不確定 checktime 能否被讀取。但是，基本上就是 SELinux</span>
<span style=color:#75715e># type 出問題～因此才會無法讀取的！</span>
</code></pre></div><p>所以，現在我們知道 /etc/cron.d/checktime 這個我們自己複製過去的檔案會沒有辦法被讀取的原因，就是因為 SELinux type 錯誤啦！ 根本就無法被讀取～好～那現在我們來查一查，那 getsebool -a 裡面看到的 httpd_enable_homedirs 到底是什麼？又是規範了哪些主體程序能夠讀取的 SELinux type 呢？</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># semanage boolean -l | grep httpd_enable_homedirs</span>
SELinux boolean                State  Default Description
httpd_enable_homedirs          <span style=color:#f92672>(</span>off  ,  off<span style=color:#f92672>)</span>  Allow httpd to enable homedirs
<span style=color:#75715e># httpd_enable_homedirs 的功能是允許 httpd 程序去讀取使用者家目錄的意思～</span>

<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># sesearch -A -b httpd_enable_homedirs</span>
範例三：列出 httpd_enable_homedirs 這個規則當中，主體程序能夠讀取的檔案 SELinux type
Found <span style=color:#ae81ff>43</span> semantic av rules:
   allow httpd_t home_root_t : dir <span style=color:#f92672>{</span> ioctl read getattr lock search open <span style=color:#f92672>}</span> ;
   allow httpd_t home_root_t : lnk_file <span style=color:#f92672>{</span> read getattr <span style=color:#f92672>}</span> ;
   allow httpd_t user_home_type : dir <span style=color:#f92672>{</span> getattr search open <span style=color:#f92672>}</span> ;
   allow httpd_t user_home_type : lnk_file <span style=color:#f92672>{</span> read getattr <span style=color:#f92672>}</span> ;
....<span style=color:#f92672>(</span>後面省略<span style=color:#f92672>)</span>....
<span style=color:#75715e># 從上面的資料才可以理解，在這個規則中，主要是放行 httpd_t 能否讀取使用者家目錄的檔案！</span>
<span style=color:#75715e># 所以，如果這個規則沒有啟動，基本上， httpd_t 這種程序就無法讀取使用者家目錄下的檔案！</span>
</code></pre></div><ul>
<li>修改 SELinux 規則的布林值 setsebool</li>
</ul>
<p>那麼如果查詢到某個 SELinux rule，並且以 sesearch 知道該規則的用途後，想要關閉或啟動他，又該如何處置？</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># setsebool  [-P]  『規則名稱』 [0|1]</span>
選項與參數：
-P  ：直接將設定值寫入設定檔，該設定資料未來會生效的！

範例一：查詢 httpd_enable_homedirs 這個規則的狀態，並且修改這個規則成為不同的布林值
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># getsebool httpd_enable_homedirs</span>
httpd_enable_homedirs --&gt; off  &lt;<span style=color:#f92672>==</span>結果是 off ，依題意給他啟動看看！

<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># setsebool -P httpd_enable_homedirs 1 # 會跑很久很久！請耐心等待！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># getsebool httpd_enable_homedirs</span>
httpd_enable_homedirs --&gt; on
</code></pre></div><p>這個 setsebool 最好記得一定要加上 -P 的選項！因為這樣才能將此設定寫入設定檔！ 這是非常棒的工具組！你一定要知道如何使用 getsebool 與 setsebool 才行！</p>
<h4 id=selinux-安全本文的修改>SELinux 安全本文的修改<a hidden class=anchor aria-hidden=true href=#selinux-安全本文的修改>#</a></h4>
<p>現在我們知道 SELinux 對受限的主體程序有沒有影響，第一關考慮 SELinux 的三種類型，第二關考慮 SELinux 的政策規則是否放行，第三關則是開始比對 SELinux type 啦！從剛剛我們也知道可以透過 sesearch 來找到主體程序與檔案的 SELinux type 關係！ 好，現在總算要來修改檔案的 SELinux type，以讓主體程序能夠讀到正確的檔案啊！這時就得要幾個重要的小東西了～來瞧瞧～</p>
<h5 id=使用-chcon-手動修改檔案的-selinux-type>使用 chcon 手動修改檔案的 SELinux type<a hidden class=anchor aria-hidden=true href=#使用-chcon-手動修改檔案的-selinux-type>#</a></h5>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># chcon [-R] [-t type] [-u user] [-r role] 檔案</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># chcon [-R] --reference=範例檔 檔案</span>
選項與參數：
-R  ：連同該目錄下的次目錄也同時修改；
-t  ：後面接安全性本文的類型欄位！例如 httpd_sys_content_t ；
-u  ：後面接身份識別，例如 system_u； <span style=color:#f92672>(</span>不重要<span style=color:#f92672>)</span>
-r  ：後面接角色，例如 system_r；     <span style=color:#f92672>(</span>不重要<span style=color:#f92672>)</span>
-v  ：若有變化成功，請將變動的結果列出來
--reference<span style=color:#f92672>=</span>範例檔：拿某個檔案當範例來修改後續接的檔案的類型！

範例一：查詢一下 /etc/hosts 的 SELinux type，並將該類型套用到 /etc/cron.d/checktime 上
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ll -Z /etc/hosts</span>
-rw-r--r--. root root system_u:object_r:net_conf_t:s0  /etc/hosts
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># chcon -v -t net_conf_t /etc/cron.d/checktime</span>
changing security context of ‘/etc/cron.d/checktime’
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ll -Z /etc/cron.d/checktime</span>
-rw-r--r--. root root unconfined_u:object_r:net_conf_t:s0 /etc/cron.d/checktime

範例二：直接以 /etc/shadow SELinux type 套用到 /etc/cron.d/checktime 上！
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># chcon -v --reference=/etc/shadow /etc/cron.d/checktime</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ll -Z /etc/shadow /etc/cron.d/checktime</span>
-rw-r--r--. root root system_u:object_r:shadow_t:s0    /etc/cron.d/checktime
----------. root root system_u:object_r:shadow_t:s0    /etc/shadow
</code></pre></div><p>上面的練習『都沒有正確的解答！』因為正確的 SELinux type 應該就是要以 /etc/cron.d/ 底下的檔案為標準來處理才對啊～ 好了～既然如此～能不能讓 SELinux 自己解決預設目錄下的 SELinux type 呢？可以！就用 restorecon 吧！</p>
<h5 id=使用-restorecon-讓檔案恢復正確的-selinux-type>使用 restorecon 讓檔案恢復正確的 SELinux type<a hidden class=anchor aria-hidden=true href=#使用-restorecon-讓檔案恢復正確的-selinux-type>#</a></h5>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># restorecon [-Rv] 檔案或目錄</span>
選項與參數：
-R  ：連同次目錄一起修改；
-v  ：將過程顯示到螢幕上

範例三：將 /etc/cron.d/ 底下的檔案通通恢復成預設的 SELinux type！
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># restorecon -Rv /etc/cron.d</span>
restorecon reset /etc/cron.d/checktime context system_u:object_r:shadow_t:s0-&gt;
system_u:object_r:system_cron_spool_t:s0
<span style=color:#75715e># 上面這兩行其實是同一行喔！表示將 checktime 由 shadow_t 改為 system_cron_spool_t</span>

範例四：重新啟動 crond 看看有沒有正確啟動 checktime 囉！？
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># systemctl restart crond</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># tail /var/log/cron</span>
<span style=color:#75715e># 再去瞧瞧這個 /var/log/cron 的內容，應該就沒有錯誤訊息了</span>
</code></pre></div><p>其實，鳥哥幾乎已經忘了 chcon 這個指令了！因為 restorecon 主動的回復預設的 SELinux type 要簡單很多！而且可以一口氣恢復整個目錄下的檔案！ 所以，鳥哥建議你幾乎只要記得 restorecon 搭配 -Rv 同時加上某個目錄這樣的指令串即可～修改 SELinux 的 type 就變得非常的輕鬆囉！</p>
<h5 id=semanage-預設目錄的安全性本文查詢與修改>semanage 預設目錄的安全性本文查詢與修改<a hidden class=anchor aria-hidden=true href=#semanage-預設目錄的安全性本文查詢與修改>#</a></h5>
<p>你應該要覺得奇怪，為什麼 restorecon 可以『恢復』原本的 SELinux type 呢？那肯定就是有個地方在紀錄每個檔案/目錄的 SELinux 預設類型囉？ 沒錯！是這樣～那要如何 (1)查詢預設的 SELinux type 以及 (2)如何增加/修改/刪除預設的 SELinux type 呢？很簡單～透過 semanage 即可！他是這樣使用的：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># semanage {login|user|port|interface|fcontext|translation} -l</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># semanage fcontext -{a|d|m} [-frst] file_spec</span>
選項與參數：
fcontext ：主要用在安全性本文方面的用途， -l 為查詢的意思；
-a ：增加的意思，你可以增加一些目錄的預設安全性本文類型設定；
-m ：修改的意思；
-d ：刪除的意思。

範例一：查詢一下 /etc /etc/cron.d 的預設 SELinux type 為何？
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># semanage fcontext -l | grep -E &#39;^/etc |^/etc/cron&#39;</span>
SELinux fcontext         type               Context
/etc                     all files          system_u:object_r:etc_t:s0
/etc/cron<span style=color:#ae81ff>\.</span>d<span style=color:#f92672>(</span>/.*<span style=color:#f92672>)</span>?       all files          system_u:object_r:system_cron_spool_t:s0
</code></pre></div><p>看到上面輸出的最後一行，那也是為啥我們直接使用 vim 去 /etc/cron.d 底下建立新檔案時，預設的 SELinux type 就是正確的！ 同時，我們也會知道使用 restorecon 回復正確的 SELinux type 時，系統會去判斷預設的類型為何的依據。現在讓我們來想一想， 如果 (當然是假的！不可能這麼幹) 我們要建立一個 /srv/mycron 的目錄，這個目錄預設也是需要變成 system_cron_spool_t 時， 我們應該要如何處理呢？基本上可以這樣作：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 1. 先建立 /srv/mycron 同時在內部放入設定檔，同時觀察 SELinux type</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># mkdir /srv/mycron</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># cp /etc/cron.d/checktime /srv/mycron</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ll -dZ /srv/mycron /srv/mycron/checktime</span>
drwxr-xr-x. root root unconfined_u:object_r:var_t:s0   /srv/mycron
-rw-r--r--. root root unconfined_u:object_r:var_t:s0   /srv/mycron/checktime

<span style=color:#75715e># 2. 觀察一下上層 /srv 的 SELinux type</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># semanage fcontext -l | grep &#39;^/srv&#39;</span>
SELinux fcontext         type               Context
/srv                     all files          system_u:object_r:var_t:s0
<span style=color:#75715e># 怪不得 mycron 會是 var_t 囉！</span>

<span style=color:#75715e># 3. 將 mycron 預設值改為 system_cron_spool_t 囉！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># semanage fcontext -a -t system_cron_spool_t &#34;/srv/mycron(/.*)?&#34;</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># semanage fcontext -l | grep &#39;^/srv/mycron&#39;</span>
SELinux fcontext         type               Context
/srv/mycron<span style=color:#f92672>(</span>/.*<span style=color:#f92672>)</span>?        all files          system_u:object_r:system_cron_spool_t:s0

<span style=color:#75715e># 4. 恢復 /srv/mycron 以及子目錄相關的 SELinux type 喔！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># restorecon -Rv /srv/mycron</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ll -dZ /srv/mycron /srv/mycron/*</span>
drwxr-xr-x. root root unconfined_u:object_r:system_cron_spool_t:s0 /srv/mycron
-rw-r--r--. root root unconfined_u:object_r:system_cron_spool_t:s0 /srv/mycron/checktime
<span style=color:#75715e># 有了預設值，未來就不會不小心被亂改了！這樣比較妥當些～</span>
</code></pre></div><p>semanage 的功能很多，不過鳥哥主要用到的僅有 fcontext 這個項目的動作而已。如上所示， 你可以使用 semanage 來查詢所有的目錄預設值，也能夠使用他來增加預設值的設定！如果您學會這些基礎的工具， 那麼 SELinux 對你來說，也不是什麼太難的咚咚囉！</p>
<h4 id=一個網路服務案例及登錄檔協助>一個網路服務案例及登錄檔協助<a hidden class=anchor aria-hidden=true href=#一個網路服務案例及登錄檔協助>#</a></h4>
<p>本章在 SELinux 小節當中談到的各個指令中，尤其是 setsebool, chcon, restorecon 等，都是為了當你的某些網路服務無法正常提供相關功能時， 才需要進行修改的一些指令動作。但是，我們怎麼知道哪個時候才需要進行這些指令的修改啊？我們怎麼知道系統因為 SELinux 的問題導致網路服務不對勁啊？如果都要靠用戶端連線失敗才來哭訴，那也太沒有效率了！所以，我們的 CentOS 7.x 有提供幾支偵測的服務在登錄 SELinux 產生的錯誤喔！那就是 auditd 與 setroubleshootd。</p>
<ul>
<li>setroubleshoot &ndash;> 錯誤訊息寫入 /var/log/messages</li>
</ul>
<p>幾乎所有 SELinux 相關的程式都會以 se 為開頭，這個服務也是以 se 為開頭！而 troubleshoot 大家都知道是錯誤克服，因此這個 setroubleshoot 自然就得要啟動他啦！這個服務會將關於 SELinux 的錯誤訊息與克服方法記錄到 /var/log/messages 與 /var/log/setroubleshoot/* 裡頭，所以你一定得要啟動這個服務才好。啟動這個服務之前當然就是得要安裝它啦！ 這玩意兒總共需要兩個軟體，分別是 setroublshoot 與 setroubleshoot-server，如果你沒有安裝，請自行使用 yum 安裝吧！</p>
<p>此外，原本的 SELinux 資訊本來是以兩個服務來記錄的，分別是 auditd 與 setroubleshootd。既然是同樣的資訊，因此 CentOS 6.x (含 7.x) 以後將兩者整合在 auditd 當中啦！所以，並沒有 setroubleshootd 的服務存在了喔！因此，當你安裝好了 setroubleshoot-server 之後，請記得要重新啟動 auditd，否則 setroubleshootd 的功能不會被啟動的。</p>
<p>Tips：事實上，CentOS 7.x 對 setroubleshootd 的運作方式是： (1)先由 auditd 去呼叫 audispd 服務， (2)然後 audispd 服務去啟動 sedispatch 程式， (3)sedispatch 再將原本的 auditd 訊息轉成 setroubleshootd 的訊息，進一步儲存下來的！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># rpm -qa | grep setroubleshoot</span>
setroubleshoot-plugins-3.0.59-1.el7.noarch
setroubleshoot-3.2.17-3.el7.x86_64
setroubleshoot-server-3.2.17-3.el7.x86_64
</code></pre></div><p>在預設的情況下，這個 setroubleshoot 應該都是會安裝的！是否正確安裝可以使用上述的表格指令去查詢。萬一沒有安裝，請使用 yum install 去安裝吧！ 再說一遍，安裝完畢最好重新啟動 auditd 這個服務喔！不過，剛剛裝好且順利啟動後， setroubleshoot 還是不會有作用，為啥？ 因為我們並沒有任何受限的網路服務主體程序在運作啊！所以，底下我們將使用一個簡單的 FTP 伺服器軟體為例，讓你了解到我們上頭講到的許多重點的應用！</p>
<ul>
<li>實例狀況說明：透過 vsftpd 這個 FTP 伺服器來存取系統上的檔案</li>
</ul>
<p>現在的年輕小伙子們傳資料都用 line, FB, dropbox, google 雲端磁碟等等，不過在網路早期傳送大容量的檔案，還是以 FTP 這個協定為主！ 現在為了速度，經常有 p2p 的軟體提供大容量檔案的傳輸，但以鳥哥這個老人家來說，可能 FTP 傳送資料還是比較有保障&mldr; 在 CentOS 7.x 的環境下，達成 FTP 的預設伺服器軟體主要是 vsftpd 這一支喔！</p>
<p>詳細的 FTP 協定我們在伺服器篇再來談，這裡只是簡單的利用 vsftpd 這個軟體與 FTP 的協定來講解 SELinux 的問題與錯誤克服而已。 不過既然要使用到 FTP 協定，一些簡單的知識還是得要存在才好！否則等一下我們沒有辦法了解為啥要這麼做！ 首先，你得要知道，用戶端需要使用『FTP 帳號登入 FTP 伺服器』才行！而有一個稱為『匿名 (anonymous) 』的帳號可以登入系統！ 但是這個匿名的帳號登入後，只能存取某一個特定的目錄，而無法脫離該目錄～！</p>
<p>在 vsftpd 中，一般用戶與匿名者的家目錄說明如下：</p>
<ul>
<li>匿名者：如果使用瀏覽器來連線到 FTP 伺服器的話，那預設就是使用匿名者登入系統。而匿名者的家目錄預設是在 /var/ftp 當中！ 同時，匿名者在家目錄下只能下載資料，不能上傳資料到 FTP 伺服器。同時，匿名者無法離開 FTP 伺服器的 /var/ftp 目錄喔！</li>
<li>一般 FTP 帳號：在預設的情況下，所有 UID 大於 1000 的帳號，都可以使用 FTP 來登入系統！ 而登入系統之後，所有的帳號都能夠取得自己家目錄底下的檔案資料！當然預設是可以上傳、下載檔案的！</li>
</ul>
<p>為了避免跟之前章節的用戶產生誤解的情況，這裡我們先建立一個名為 ftptest 的帳號，且帳號密碼為 myftp123， 先來建立一下吧！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># useradd -s /sbin/nologin ftptest</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># echo &#34;myftp123&#34; | passwd --stdin ftptest</span>
</code></pre></div><p>接下來當然就是安裝 vsftpd 這隻伺服器軟體，同時啟動這隻服務，另外，我們也希望未來開機都能夠啟動這隻服務！ 因此需要這樣做 (鳥哥假設你的 CentOS 7.x 的原版光碟已經掛載於 /mnt 了喔！)：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># yum install /mnt/Packages/vsftpd-3*</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># systemctl start vsftpd</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># systemctl enable vsftpd</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># netstat -tlnp</span>
Active Internet connections <span style=color:#f92672>(</span>only servers<span style=color:#f92672>)</span>
Proto Recv-Q Send-Q Local Address   Foreign Address   State   PID/Program name
tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:22      0.0.0.0:*         LISTEN  1326/sshd
tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 127.0.0.1:25    0.0.0.0:*         LISTEN  2349/master
tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::21           :::*              LISTEN  6256/vsftpd
tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::22           :::*              LISTEN  1326/sshd
tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> ::1:25          :::*              LISTEN  2349/master
<span style=color:#75715e># 要注意看，上面的特殊字體那行有出現，才代表 vsftpd 這隻服務有啟動喔！！</span>
</code></pre></div><ul>
<li>匿名者無法下載的問題</li>
</ul>
<p>現在讓我們來模擬一些 FTP 的常用狀態！假設你想要將 /etc/securetty 以及主要的 /etc/sysctl.conf 放置給所有人下載， 那麼你可能會這樣做！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># cp -a /etc/securetty /etc/sysctl.conf /var/ftp/pub</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ll /var/ftp/pub</span>
-rw-------. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>221</span> Oct <span style=color:#ae81ff>29</span>  <span style=color:#ae81ff>2014</span> securetty    <span style=color:#75715e># 先假設你沒有看到這個問題！</span>
-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>225</span> Mar  <span style=color:#ae81ff>6</span> 11:05 sysctl.conf
</code></pre></div><p>一般來說，預設要給用戶下載的 FTP 檔案會放置到上面表格當中的 /var/ftp/pub 目錄喔！現在讓我們使用簡單的終端機瀏覽器 curl 來觀察看看！ 看你能不能查詢到上述兩個檔案的內容呢？</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 1. 先看看 FTP 根目錄底下有什麼檔案存在？</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># curl ftp://localhost</span>
drwxr-xr-x    <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span>              <span style=color:#ae81ff>40</span> Aug <span style=color:#ae81ff>08</span> 00:51 pub
<span style=color:#75715e># 確實有存在一個名為 pub 的檔案喔！那就是在 /var/ftp 底下的 pub 囉！</span>

<span style=color:#75715e># 2. 再往下看看，能不能看到 pub 內的檔案呢？</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># curl ftp://localhost/pub/  # 因為是目錄，要加上 / 才好！</span>
-rw-------    <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span>             <span style=color:#ae81ff>221</span> Oct <span style=color:#ae81ff>29</span>  <span style=color:#ae81ff>2014</span> securetty
-rw-r--r--    <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span>             <span style=color:#ae81ff>225</span> Mar <span style=color:#ae81ff>06</span> 03:05 sysctl.conf

<span style=color:#75715e># 3. 承上，繼續看一下 sysctl.conf 的內容好了！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># curl ftp://localhost/pub/sysctl.conf</span>
<span style=color:#75715e># System default settings live in /usr/lib/sysctl.d/00-system.conf.</span>
<span style=color:#75715e># To override those settings, enter new settings here, or in an /etc/sysctl.d/&lt;name&gt;.conf file</span>
<span style=color:#75715e>#</span>
<span style=color:#75715e># For more information, see sysctl.conf(5) and sysctl.d(5).</span>
<span style=color:#75715e># 真的有看到這個檔案的內容喔！所以確定是可以讓 vsftpd 讀取到這檔案的！</span>

<span style=color:#75715e># 4. 再來瞧瞧 securetty 好了！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># curl ftp://localhost/pub/securetty</span>
curl: <span style=color:#f92672>(</span>78<span style=color:#f92672>)</span> RETR response: <span style=color:#ae81ff>550</span>
<span style=color:#75715e># 看不到耶！但是，基本的原因應該是權限問題喔！因為 vsftpd 預設放在 /var/ftp/pub 內的資料，</span>
<span style=color:#75715e># 不論什麼 SELinux type 幾乎都可以被讀取的才對喔！所以要這樣處理！</span>

<span style=color:#75715e># 5. 修訂權限之後再一次觀察 securetty 看看！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># chmod a+r /var/ftp/pub/securetty</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># curl ftp://localhost/pub/securetty</span>
<span style=color:#75715e># 此時你就可以看到實際的檔案內容囉！</span>

<span style=color:#75715e># 6. 修訂 SELinux type 的內容 (非必備)</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># restorecon -Rv /var/ftp</span>
</code></pre></div><p>上面這個例子在告訴你，要先從權限的角度來瞧一瞧，如果無法被讀取，可能就是因為沒有 r 或沒有 rx 囉！並不一定是由 SELinux 引起的！ 了解乎？好～再來瞧瞧如果是一般帳號呢？如何登入？</p>
<ul>
<li>無法從家目錄下載檔案的問題分析與解決</li>
</ul>
<p>我們前面建立了 ftptest 帳號，那如何使用文字界面來登入呢？就使用如下的方式來處理。同時請注意，因為文字型的 FTP 用戶端軟體， 預設會將用戶丟到根目錄而不是家目錄，因此，你的 URL 可能需要修訂一下如下！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 0. 為了讓 curl 這個文字瀏覽器可以傳輸資料，我們先建立一些資料在 ftptest 家目錄</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># echo &#34;testing&#34; &gt; ~ftptest/test.txt</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># cp -a /etc/hosts /etc/sysctl.conf ~ftptest/</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ll ~ftptest/</span>
-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>158</span> Jun  <span style=color:#ae81ff>7</span>  <span style=color:#ae81ff>2013</span> hosts
-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>225</span> Mar  <span style=color:#ae81ff>6</span> 11:05 sysctl.conf
-rw-r--r--. <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>8</span> Aug  <span style=color:#ae81ff>9</span> 01:05 test.txt

<span style=color:#75715e># 1. 一般帳號直接登入 FTP 伺服器，同時變換目錄到家目錄去！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># curl ftp://ftptest:myftp123@localhost/~/</span>
-rw-r--r--    <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span>             <span style=color:#ae81ff>158</span> Jun <span style=color:#ae81ff>07</span>  <span style=color:#ae81ff>2013</span> hosts
-rw-r--r--    <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span>             <span style=color:#ae81ff>225</span> Mar <span style=color:#ae81ff>06</span> 03:05 sysctl.conf
-rw-r--r--    <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span>               <span style=color:#ae81ff>8</span> Aug <span style=color:#ae81ff>08</span> 17:05 test.txt
<span style=color:#75715e># 真的有資料～看檔案最左邊的權限也是沒問題，所以，來讀一下 test.txt 的內容看看</span>

<span style=color:#75715e># 2. 開始下載 test.txt, sysctl.conf 等有權限可以閱讀的檔案看看！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># curl ftp://ftptest:myftp123@localhost/~/test.txt</span>
curl: <span style=color:#f92672>(</span>78<span style=color:#f92672>)</span> RETR response: <span style=color:#ae81ff>550</span>
<span style=color:#75715e># 竟然說沒有權限！明明我們的 rwx 是正常沒問題！那是否有可能是 SELinux 造成的？</span>

<span style=color:#75715e># 3. 先將 SELinux 從 Enforce 轉成 Permissive 看看情況！同時觀察登錄檔</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># setenforce 0</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># curl ftp://ftptest:myftp123@localhost/~/test.txt</span>
testing
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># setenforce 1  # 確定問題後，一定要轉成 Enforcing 啊！</span>
<span style=color:#75715e># 確定有資料內容！所以，確定就是 SELinux 造成無法讀取的問題～那怎辦？要改規則？還是改 type？</span>
<span style=color:#75715e># 因為都不知道，所以，就檢查一下登錄檔看看有沒有相關的資訊可以提供給我們處理！</span>

<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># vim /var/log/messages</span>
Aug  <span style=color:#ae81ff>9</span> 02:55:58 station3-39 setroubleshoot: SELinux is preventing /usr/sbin/vsftpd 
 from lock access on the file /home/ftptest/test.txt. For complete SELinux messages. 
 run sealert -l 3a57aad3-a128-461b-966a-5bb2b0ffa0f9
Aug  <span style=color:#ae81ff>9</span> 02:55:58 station3-39 python: SELinux is preventing /usr/sbin/vsftpd from 
 lock access on the file /home/ftptest/test.txt.

*****  Plugin catchall_boolean <span style=color:#f92672>(</span>47.5 confidence<span style=color:#f92672>)</span> suggests   ******************

If you want to allow ftp to home dir
Then you must tell SELinux about this by enabling the <span style=color:#e6db74>&#39;ftp_home_dir&#39;</span> boolean.
You can read <span style=color:#e6db74>&#39;None&#39;</span> man page <span style=color:#66d9ef>for</span> more details.
Do
setsebool -P ftp_home_dir <span style=color:#ae81ff>1</span>

*****  Plugin catchall_boolean <span style=color:#f92672>(</span>47.5 confidence<span style=color:#f92672>)</span> suggests   ******************

If you want to allow ftpd to full access
Then you must tell SELinux about this by enabling the <span style=color:#e6db74>&#39;ftpd_full_access&#39;</span> boolean.
You can read <span style=color:#e6db74>&#39;None&#39;</span> man page <span style=color:#66d9ef>for</span> more details.
Do
setsebool -P ftpd_full_access <span style=color:#ae81ff>1</span>

*****  Plugin catchall <span style=color:#f92672>(</span>6.38 confidence<span style=color:#f92672>)</span> suggests   **************************
.....<span style=color:#f92672>(</span>底下省略<span style=color:#f92672>)</span>.....
<span style=color:#75715e># 基本上，你會看到有個特殊字體的部份，就是 sealert 那一行。雖然底下已經列出可能的解決方案了，</span>
<span style=color:#75715e># 就是一堆底線那些東西。至少就有三個解決方案 (最後一個沒列出來)，哪種才是正確的？</span>
<span style=color:#75715e># 為了了解正確的解決方案，我們還是還執行一下 sealert 那行吧！看看情況再說！</span>

<span style=color:#75715e># 4. 透過 sealert 的解決方案來處理問題</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># sealert -l 3a57aad3-a128-461b-966a-5bb2b0ffa0f9</span>
SELinux is preventing /usr/sbin/vsftpd from lock access on the file /home/ftptest/test.txt.

<span style=color:#75715e># 底下說有 47.5% 的機率是由於這個原因所發生，並且可以使用 setsebool 去解決的意思！</span>
*****  Plugin catchall_boolean <span style=color:#f92672>(</span>47.5 confidence<span style=color:#f92672>)</span> suggests   ******************

If you want to allow ftp to home dir
Then you must tell SELinux about this by enabling the <span style=color:#e6db74>&#39;ftp_home_dir&#39;</span> boolean.
You can read <span style=color:#e6db74>&#39;None&#39;</span> man page <span style=color:#66d9ef>for</span> more details.
Do
setsebool -P ftp_home_dir <span style=color:#ae81ff>1</span>

<span style=color:#75715e># 底下說也是有 47.5% 的機率是由此產生的！</span>
*****  Plugin catchall_boolean <span style=color:#f92672>(</span>47.5 confidence<span style=color:#f92672>)</span> suggests   ******************

If you want to allow ftpd to full access
Then you must tell SELinux about this by enabling the <span style=color:#e6db74>&#39;ftpd_full_access&#39;</span> boolean.
You can read <span style=color:#e6db74>&#39;None&#39;</span> man page <span style=color:#66d9ef>for</span> more details.
Do
setsebool -P ftpd_full_access <span style=color:#ae81ff>1</span>

<span style=color:#75715e># 底下說，僅有 6.38% 的可信度是由這個情況產生的！</span>
*****  Plugin catchall <span style=color:#f92672>(</span>6.38 confidence<span style=color:#f92672>)</span> suggests   **************************

If you believe that vsftpd should be allowed lock access on the test.txt file by default.
Then you should report this as a bug.
You can generate a local policy module to allow this access.
Do
allow this access <span style=color:#66d9ef>for</span> now by executing:
<span style=color:#75715e># grep vsftpd /var/log/audit/audit.log | audit2allow -M mypol</span>
<span style=color:#75715e># semodule -i mypol.pp</span>

<span style=color:#75715e># 底下就重要了！是整個問題發生的主因～最好還是稍微瞧一瞧！</span>
Additional Information:
Source Context                system_u:system_r:ftpd_t:s0-s0:c0.c1023
Target Context                unconfined_u:object_r:user_home_t:s0
Target Objects                /home/ftptest/test.txt <span style=color:#f92672>[</span> file <span style=color:#f92672>]</span>
Source                        vsftpd
Source Path                   /usr/sbin/vsftpd
Port                          &lt;Unknown&gt;
Host                          station3-39.gocloud.vm
Source RPM Packages           vsftpd-3.0.2-9.el7.x86_64
Target RPM Packages
Policy RPM                    selinux-policy-3.13.1-23.el7.noarch
Selinux Enabled               True
Policy Type                   targeted
Enforcing Mode                Permissive
Host Name                     station3-39.gocloud.vm
Platform                      Linux station3-39.gocloud.vm 3.10.0-229.el7.x86_64
                              <span style=color:#75715e>#1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64</span>
Alert Count                   <span style=color:#ae81ff>3</span>
First Seen                    2015-08-09 01:00:12 CST
Last Seen                     2015-08-09 02:55:57 CST
Local ID                      3a57aad3-a128-461b-966a-5bb2b0ffa0f9

Raw Audit Messages
type<span style=color:#f92672>=</span>AVC msg<span style=color:#f92672>=</span>audit<span style=color:#f92672>(</span>1439060157.358:635<span style=color:#f92672>)</span>: avc:  denied  <span style=color:#f92672>{</span> lock <span style=color:#f92672>}</span> <span style=color:#66d9ef>for</span>  pid<span style=color:#f92672>=</span><span style=color:#ae81ff>5029</span> comm<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;vsftpd&#34;</span> 
 path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/ftptest/test.txt&#34;</span> dev<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;dm-2&#34;</span> ino<span style=color:#f92672>=</span><span style=color:#ae81ff>141</span> scontext<span style=color:#f92672>=</span>system_u:system_r:ftpd_t:s0-s0:
 c0.c1023 tcontext<span style=color:#f92672>=</span>unconfined_u:object_r:user_home_t:s0 tclass<span style=color:#f92672>=</span>file

type<span style=color:#f92672>=</span>SYSCALL msg<span style=color:#f92672>=</span>audit<span style=color:#f92672>(</span>1439060157.358:635<span style=color:#f92672>)</span>: arch<span style=color:#f92672>=</span>x86_64 syscall<span style=color:#f92672>=</span>fcntl success<span style=color:#f92672>=</span>yes exit<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> 
 a0<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> a1<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span> a2<span style=color:#f92672>=</span>7fffceb8cbb0 a3<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> items<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> ppid<span style=color:#f92672>=</span><span style=color:#ae81ff>5024</span> pid<span style=color:#f92672>=</span><span style=color:#ae81ff>5029</span> auid<span style=color:#f92672>=</span><span style=color:#ae81ff>4294967295</span> uid<span style=color:#f92672>=</span><span style=color:#ae81ff>1001</span> gid<span style=color:#f92672>=</span><span style=color:#ae81ff>1001</span>
 euid<span style=color:#f92672>=</span><span style=color:#ae81ff>1001</span> suid<span style=color:#f92672>=</span><span style=color:#ae81ff>1001</span> fsuid<span style=color:#f92672>=</span><span style=color:#ae81ff>1001</span> egid<span style=color:#f92672>=</span><span style=color:#ae81ff>1001</span> sgid<span style=color:#f92672>=</span><span style=color:#ae81ff>1001</span> fsgid<span style=color:#f92672>=</span><span style=color:#ae81ff>1001</span> tty<span style=color:#f92672>=(</span>none<span style=color:#f92672>)</span> ses<span style=color:#f92672>=</span><span style=color:#ae81ff>4294967295</span>
 comm<span style=color:#f92672>=</span>vsftpd exe<span style=color:#f92672>=</span>/usr/sbin/vsftpd subj<span style=color:#f92672>=</span>system_u:system_r:ftpd_t:s0-s0:c0.c1023 key<span style=color:#f92672>=(</span>null<span style=color:#f92672>)</span>

Hash: vsftpd,ftpd_t,user_home_t,file,lock
</code></pre></div><p>經過上面的測試，現在我們知道主要的問題發生在 SELinux 的 type 不是 vsftpd_t 所能讀取的原因～ 經過仔細觀察 test.txt 檔案的類型，我們知道他原本就是家目錄，因此是 user_home_t 也沒啥了不起的啊！是正確的～ 因此，分析兩個比較可信 (47.5%) 的解決方案後，可能是與 ftp_home_dir 比較有關啊！所以，我們應該不需要修改 SELinux type， 修改的應該是 SELinux rules 才對！所以，這樣做看看：</p>
<pre tabindex=0><code># 1. 先確認一下 SELinux 的模式，然後再瞧一瞧能否下載 test.txt，最終使用處理方式來解決～
[root@study ~]# getenforce
Enforcing
[root@study ~]# curl ftp://ftptest:myftp123@localhost/~/test.txt
curl: (78) RETR response: 550
# 確定還是無法讀取的喔！
[root@study ~]# setsebool -P ftp_home_dir 1
[root@study ~]# curl ftp://ftptest:myftp123@localhost/~/test.txt
testing
# OK！太讚了！處理完畢！現在使用者可以在自己的家目錄上傳/下載檔案了！

# 2. 開始下載其他檔案試看看囉！
[root@study ~]# curl ftp://ftptest:myftp123@localhost/~/sysctl.conf
# System default settings live in /usr/lib/sysctl.d/00-system.conf.
# To override those settings, enter new settings here, or in an /etc/sysctl.d/&lt;name&gt;.conf file
#
# For more information, see sysctl.conf(5) and sysctl.d(5).
</code></pre><p>沒問題喔！透過修改 SELinux rule 的布林值，現在我們就可以使用一般帳號在 FTP 服務來上傳/下載資料囉！非常愉快吧！ 那萬一我們還有其他的目錄也想要透過 FTP 來提供這個 ftptest 用戶上傳與下載呢？往下瞧瞧～</p>
<ul>
<li>一般帳號用戶從非正規目錄上傳/下載檔案</li>
</ul>
<p>假設我們還想要提供 /srv/gogogo 這個目錄給 ftptest 用戶使用，那又該如何處理呢？假設我們都沒有考慮 SELinux ， 那就是這樣的情況：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 1. 先處理好所需要的目錄資料</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># mkdir /srv/gogogo</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># chgrp ftptest /srv/gogogo</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># echo &#34;test&#34; &gt; /srv/gogogo/test.txt</span>

<span style=color:#75715e># 2. 開始直接使用 ftp 觀察一下資料！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># curl ftp://ftptest:myftp123@localhost//srv/gogogo/test.txt</span>
curl: <span style=color:#f92672>(</span>78<span style=color:#f92672>)</span> RETR response: <span style=color:#ae81ff>550</span>
<span style=color:#75715e># 有問題喔！來瞧瞧登錄檔怎麼說！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># grep sealert /var/log/messages | tail</span>
Aug  <span style=color:#ae81ff>9</span> 04:23:12 station3-39 setroubleshoot: SELinux is preventing /usr/sbin/vsftpd from
 read access on the file test.txt. For complete SELinux messages. run sealert -l
 08d3c0a2-5160-49ab-b199-47a51a5fc8dd
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># sealert -l 08d3c0a2-5160-49ab-b199-47a51a5fc8dd</span>
SELinux is preventing /usr/sbin/vsftpd from read access on the file test.txt.

<span style=color:#75715e># 雖然這個可信度比較高～不過，因為會全部放行 FTP ，所以不太考慮！</span>
*****  Plugin catchall_boolean <span style=color:#f92672>(</span>57.6 confidence<span style=color:#f92672>)</span> suggests   ******************

If you want to allow ftpd to full access
Then you must tell SELinux about this by enabling the <span style=color:#e6db74>&#39;ftpd_full_access&#39;</span> boolean.
You can read <span style=color:#e6db74>&#39;None&#39;</span> man page <span style=color:#66d9ef>for</span> more details.
Do
setsebool -P ftpd_full_access <span style=color:#ae81ff>1</span>

<span style=color:#75715e># 因為是非正規目錄的使用，所以這邊加上預設 SELinux type 恐怕會是比較正確的選擇！</span>
*****  Plugin catchall_labels <span style=color:#f92672>(</span>36.2 confidence<span style=color:#f92672>)</span> suggests   *******************

If you want to allow vsftpd to have read access on the test.txt file
Then you need to change the label on test.txt
Do
<span style=color:#75715e># semanage fcontext -a -t FILE_TYPE &#39;test.txt&#39;</span>
where FILE_TYPE is one of the following: NetworkManager_tmp_t, abrt_helper_exec_t, abrt_tmp_t,
 abrt_upload_watch_tmp_t, abrt_var_cache_t, abrt_var_run_t, admin_crontab_tmp_t, afs_cache_t,
 alsa_home_t, alsa_tmp_t, amanda_tmp_t, antivirus_home_t, antivirus_tmp_t, apcupsd_tmp_t, ...
Then execute:
restorecon -v <span style=color:#e6db74>&#39;test.txt&#39;</span>

*****  Plugin catchall <span style=color:#f92672>(</span>7.64 confidence<span style=color:#f92672>)</span> suggests   **************************

If you believe that vsftpd should be allowed read access on the test.txt file by default.
Then you should report this as a bug.
You can generate a local policy module to allow this access.
Do
allow this access <span style=color:#66d9ef>for</span> now by executing:
<span style=color:#75715e># grep vsftpd /var/log/audit/audit.log | audit2allow -M mypol</span>
<span style=color:#75715e># semodule -i mypol.pp</span>

Additional Information:
Source Context                system_u:system_r:ftpd_t:s0-s0:c0.c1023
Target Context                unconfined_u:object_r:var_t:s0
Target Objects                test.txt <span style=color:#f92672>[</span> file <span style=color:#f92672>]</span>
Source                        vsftpd
.....<span style=color:#f92672>(</span>底下省略<span style=color:#f92672>)</span>.....
</code></pre></div><p>因為是非正規目錄啊，所以感覺上似乎與 semanage 那一行的解決方案比較相關～接下來就是要找到 FTP 的 SELinux type 來解決囉！ 所以，讓我們查一下 FTP 相關的資料囉！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 3. 先查看一下 /var/ftp 這個地方的 SELinux type 吧！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># ll -Zd /var/ftp</span>
drwxr-xr-x. root root system_u:object_r:public_content_t:s0 /var/ftp

<span style=color:#75715e># 4. 以 sealert 建議的方法來處理好 SELinux type 囉！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># semanage fcontext -a -t public_content_t &#34;/srv/gogogo(/.*)?&#34;</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># restorecon -Rv /srv/gogogo</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># curl ftp://ftptest:myftp123@localhost//srv/gogogo/test.txt</span>
test
<span style=color:#75715e># 喔耶！終於再次搞定喔！</span>
</code></pre></div><p>在這個範例中，我們是修改了 SELinux type 喔！與前一個修改 SELinux rule 不太一樣！要理解理解喔！</p>
<ul>
<li>無法變更 FTP 連線埠口問題分析與解決</li>
</ul>
<p>在某些情況下，可能你的伺服器軟體需要開放在非正規的埠口，舉例來說，如果因為某些政策問題，導致 FTP 啟動的正常的 21 號埠口無法使用， 因此你想要啟用在 555 號埠口時，該如何處理呢？基本上，既然 SELinux 的主體程序大多是被受限的網路服務，沒道理不限制放行的埠口啊！ 所以，很可能會出問題～那就得要想想辦法才行！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 1. 先處理 vsftpd 的設定檔，加入換 port 的參數才行！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># vim /etc/vsftpd/vsftpd.conf</span>
<span style=color:#75715e># 請按下大寫的 G 跑到最後一行，然後新增加底下這行設定！前面不可以留白！</span>
listen_port<span style=color:#f92672>=</span><span style=color:#ae81ff>555</span>

<span style=color:#75715e># 2. 重新啟動 vsftpd 並且觀察登錄檔的變化！</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># systemctl restart vsftpd</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># grep sealert /var/log/messages</span>
Aug  <span style=color:#ae81ff>9</span> 06:34:46 station3-39 setroubleshoot: SELinux is preventing /usr/sbin/vsftpd from
 name_bind access on the tcp_socket port 555. For complete SELinux messages. run
 sealert -l 288118e7-c386-4086-9fed-2fe78865c704

<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># sealert -l 288118e7-c386-4086-9fed-2fe78865c704</span>
SELinux is preventing /usr/sbin/vsftpd from name_bind access on the tcp_socket port 555.

*****  Plugin bind_ports <span style=color:#f92672>(</span>92.2 confidence<span style=color:#f92672>)</span> suggests   ************************

If you want to allow /usr/sbin/vsftpd to bind to network port <span style=color:#ae81ff>555</span>
Then you need to modify the port type.
Do
<span style=color:#75715e># semanage port -a -t PORT_TYPE -p tcp 555</span>
    where PORT_TYPE is one of the following: certmaster_port_t, cluster_port_t,
 ephemeral_port_t, ftp_data_port_t, ftp_port_t, hadoop_datanode_port_t, hplip_port_t,
 port_t, postgrey_port_t, unreserved_port_t.
.....<span style=color:#f92672>(</span>後面省略<span style=color:#f92672>)</span>.....
<span style=color:#75715e># 看一下信任度，高達 92.2% 耶！幾乎就是這傢伙～因此不必再看～就是他了！比較重要的是，</span>
<span style=color:#75715e># 解決方案裡面，那個 PORT_TYPE 有很多選擇～但我們是要開啟 FTP 埠口嘛！所以，</span>
<span style=color:#75715e># 就由後續資料找到 ftp_port_t 那個項目囉！帶入實驗看看！</span>

<span style=color:#75715e># 3. 實際帶入 SELinux 埠口修訂後，在重新啟動 vsftpd 看看</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># semanage port -a -t ftp_port_t -p tcp 555</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># systemctl restart vsftpd</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># netstat -tlnp</span>
Active Internet connections <span style=color:#f92672>(</span>only servers<span style=color:#f92672>)</span>
Proto Recv-Q Send-Q Local Address    Foreign Address   State    PID/Program name
tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 0.0.0.0:22       0.0.0.0:*         LISTEN   1167/sshd
tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 127.0.0.1:25     0.0.0.0:*         LISTEN   1598/master
tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::555           :::*              LISTEN   8436/vsftpd
tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> :::22            :::*              LISTEN   1167/sshd
tcp6       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> ::1:25           :::*              LISTEN   1598/master

<span style=color:#75715e># 4. 實驗看看這個 port 能不能用？</span>
<span style=color:#f92672>[</span>root@study ~<span style=color:#f92672>]</span><span style=color:#75715e># curl ftp://localhost:555/pub/</span>
-rw-r--r--    <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span>             <span style=color:#ae81ff>221</span> Oct <span style=color:#ae81ff>29</span>  <span style=color:#ae81ff>2014</span> securetty
-rw-r--r--    <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span>             <span style=color:#ae81ff>225</span> Mar <span style=color:#ae81ff>06</span> 03:05 sysctl.conf
</code></pre></div><p>透過上面的幾個小練習，你會知道在正規或非正規的環境下，如何處理你的 SELinux 問題哩！仔細研究看看囉！</p>
<h2 id=swap>Swap<a hidden class=anchor aria-hidden=true href=#swap>#</a></h2>
<h3 id=譯替-swap-辯護常見的誤解httpsfarseerfcmein-defence-of-swaphtml><a href=https://farseerfc.me/in-defence-of-swap.html>【譯】替 swap 辯護：常見的誤解</a><a hidden class=anchor aria-hidden=true href=#譯替-swap-辯護常見的誤解httpsfarseerfcmein-defence-of-swaphtml>#</a></h3>
<p>這篇翻譯自 Chris Down 的博文 <a href=https://chrisdown.name/2018/01/02/in-defence-of-swap.html>In defence of swap: common misconceptions</a> 。</p>
<p>翻譯這篇文章是因爲經常看到朋友們（包括有經驗的程序員和 Linux 管理員）對 swap 和 swappiness 有諸多誤解，而這篇文章正好澄清了這些誤解，也講清楚了 Linux 中這兩者的本質。值得一提的是本文討論的 swap 針對 Linux 內核，在別的系統包括 macOS/WinNT 或者 Unix 系統中的交換文件可能有不同一樣的行爲， 需要不同的調優方式。比如在 <a href=https://www.freebsd.org/doc/handbook/bsdinstall-partitioning.html#configtuning-initial>FreeBSD handbook</a> 中明確建議了 swap 分區通常應該是兩倍物理內存大小，這一點建議對 FreeBSD 系內核的內存管理可能非常合理， 而不一定適合 Linux 內核，FreeBSD 和 Linux 有不同的內存管理方式尤其是 swap 和 page cache 和 buffer cache 的處理方式有諸多不同。</p>
<p>經常有朋友看到系統卡頓之後看系統內存使用狀況觀察到大量 swap 佔用，於是覺得卡頓是來源於 swap 。就像文中所述，相關不蘊含因果，產生內存顛簸之後的確會造成大量 swap 佔用，也會造成系統卡頓， 但是 swap 不是導致卡頓的原因，關掉 swap 或者調低 swappiness 並不能阻止卡頓，只會將 swap 造成的 I/O 轉化爲加載文件緩存造成的 I/O 。</p>
<p>以下是原文翻譯：</p>
<hr>
<p>太長不看：</p>
<ol>
<li>對維持系統的正常功能而言，有 swap 是相對挺重要的一部分。沒有它的話會更難做到合理的內存管理。</li>
<li>swap 的目的通常並不是用作緊急內存，它的目的在於讓內存回收能更平等和高效。 事實上把它當作「緊急內存」來用的想法通常是有害的。</li>
<li>禁用 swap 在內存壓力下並不能避免磁盤I/O造成的性能問題，這麼做只是讓磁盤I/O顛簸的範圍從 匿名頁面轉化到文件頁面。這不僅更低效，因爲系統能回收的頁面的選擇範圍更有限了， 而且這種做法還可能是加重了內存壓力的原因之一。</li>
<li>內核 4.0 版本之前的交換進程（swapper）有一些問題，導致很多人對 swap 有負面印象， 因爲它太急於（overeagerness）把頁面交換出去。在 4.0 之後的內核上這種情況已經改善了很多。</li>
<li>在 SSD 上，交換出匿名頁面的開銷和回收文件頁面的開銷基本上在性能/延遲方面沒有區別。 在老式的磁盤上，讀取交換文件因爲屬於隨機訪問讀取所以會更慢，於是設置較低的 <code>vm.swappiness</code> 可能比較合理（繼續讀下面關於 <code>vm.swappiness</code> 的描述）。</li>
<li>禁用 swap 並不能避免在接近 OOM 狀態下最終表現出的症狀，儘管的確有 swap 的情況下這種症狀持續的時間可能會延長。在系統調用 OOM 殺手的時候無論有沒有啓用 swap ，或者更早/更晚開始調用 OOM 殺手，結果都是一樣的：整個系統留在了一種不可預知的狀態下。 有 swap 也不能避免這一點。</li>
<li>可以用 cgroup v2 的 <code>memory.low</code> 相關機制來改善內存壓力下 swap 的行爲並且 避免發生顛簸。</li>
</ol>
<p>我的工作的一部分是改善內核中內存管理和 cgroup v2 相關，所以我和很多工程師討論過看待內存管理的態度， 尤其是在壓力下應用程序的行爲和操作系統在底層內存管理中用的基於經驗的啓發式決策邏輯。</p>
<p>在這種討論中經常重複的話題是交換區（swap）。交換區的話題是非常有爭議而且很少被理解的話題，甚至包括那些在 Linux 上工作過多年的人也是如此。很多人覺得它沒什麼用甚至是有害的：它是歷史遺蹟，從內存緊缺而 磁盤讀寫是必要之惡的時代遺留到現在，爲計算機提供在當年很必要的頁面交換功能作爲內存空間。 最近幾年我還經常能以一定頻度看到這種論調，然後我和很多同事、朋友、業界同行們討論過很多次， 幫他們理解爲什麼在現代計算機系統中交換區仍是有用的概念，即便現在的電腦中物理內存已經遠多於過去。</p>
<p>圍繞交換區的目的還有很多誤解——很多人覺得它只是某種爲了應對緊急情況的「慢速額外內存」， 但是沒能理解在整個操作系統健康運作的時候它也能改善普通負載的性能。</p>
<p>我們很多人也聽說過描述內存時所用的常見說法： 「 <a href=https://www.linuxatemyram.com/>Linux 用了太多內存</a> 」，「 <a href=https://superuser.com/a/111510>swap 應該設爲物理內存的兩倍大小</a> 」，或者類似的說法。 雖然這些誤解要麼很容易化解，或者關於他們的討論在最近幾年已經逐漸變得瑣碎，但是關於「無用」交換區 的傳言有更深的經驗傳承的根基，而不是一兩個類比就能解釋清楚的，並且要探討這個先得對內存管理有 一些基礎認知。</p>
<p>本文主要目標是針對那些管理 Linux 系統並且有興趣理解「讓系統運行於低/無交換區狀態」或者「把 <code>vm.swappiness</code> 設爲 0 」這些做法的反論。</p>
<h4 id=背景>背景<a hidden class=anchor aria-hidden=true href=#背景>#</a></h4>
<p>如果沒有基本理解 Linux 內存管理的底層機制是如何運作的，就很難討論爲什麼需要交換區以及交換出頁面 對正常運行的系統爲什麼是件好事，所以我們先確保大家有討論的基礎。</p>
<h5 id=內存的類型>內存的類型<a hidden class=anchor aria-hidden=true href=#內存的類型>#</a></h5>
<p>Linux 中內存分爲好幾種類型，每種都有各自的屬性。想理解爲什麼交換區很重要的關鍵一點在於理解這些的細微區別。</p>
<p>比如說，有種 <strong>頁面（「整塊」的內存，通常 4K）</strong> 是用來存放電腦裏每個程序運行時各自的代碼的。 也有頁面用來保存這些程序所需要讀取的文件數據和元數據的緩存，以便加速隨後的文件讀寫。 這些內存頁面構成 <strong>頁面緩存（page cache）</strong>，後文中我稱他們爲文件內存。</p>
<p>還有一些頁面是在代碼執行過程中做的內存分配得到的，比如說，當代碼調用 <code>malloc</code> 能分配到新內存區，或者使用 <code>mmap</code> 的 <code>MAP_ANONYMOUS</code> 標誌分配的內存。 這些是「匿名(anonymous)」頁面——之所以這麼稱呼它們是因爲他們沒有任何東西作後備—— 後文中我稱他們爲匿名內存。</p>
<p>還有其它類型的內存——共享內存、slab內存、內核棧內存、文件緩衝區（buffers），這種的—— 但是匿名內存和文件內存是最知名也最好理解的，所以後面的例子裏我會用這兩個說明， 雖然後面的說明也同樣適用於別的這些內存類型。</p>
<h5 id=可回收不可回收內存>可回收/不可回收內存<a hidden class=anchor aria-hidden=true href=#可回收不可回收內存>#</a></h5>
<p>考慮某種內存的類型時，一個非常基礎的問題是這種內存是否能被回收。 「回收（Reclaim）」在這裏是指系統可以，在不丟失數據的前提下，從物理內存中釋放這種內存的頁面。</p>
<p>對一些內存類型而言，是否可回收通常可以直接判斷。比如對於那些乾淨（未修改）的頁面緩存內存， 我們只是爲了性能在用它們緩存一些磁盤上現有的數據，所以我們可以直接扔掉這些頁面， 不需要做什麼特殊的操作。</p>
<p>對有些內存類型而言，回收是可能的，但是不是那麼直接。比如對髒（修改過）的頁面緩存內存， 我們不能直接扔掉這些頁面，因爲磁盤上還沒有寫入我們所做的修改。這種情況下，我們可以選擇拒絕回收， 或者選擇先等待我們的變更寫入磁盤之後才能扔掉這些內存。</p>
<p>對還有些內存類型而言，是不能回收的。比如前面提到的匿名頁面，它們只存在於內存中，沒有任何後備存儲， 所以它們必須留在內存裏。</p>
<h4 id=說到交換區的本質>說到交換區的本質<a hidden class=anchor aria-hidden=true href=#說到交換區的本質>#</a></h4>
<p>如果你去搜 Linux 上交換區的目的的描述，肯定會找到很多人說交換區只是在緊急時用來擴展物理內存的機制。 比如下面這段是我在 google 中輸入「什麼是 swap」 從前排結果中隨機找到的一篇：</p>
<blockquote>
<p>交換區本質上是緊急內存；是爲了應對你的系統臨時所需內存多餘你現有物理內存時，專門分出一塊額外空間。 大家覺得交換區「不好」是因爲它又慢又低效，並且如果你的系統一直需要使用交換區那說明它明顯沒有足夠的內存。 ［……］如果你有足夠內存覆蓋所有你需要的情況，而且你覺得肯定不會用滿內存，那麼完全可以不用交換區 安全地運行系統。</p>
</blockquote>
<p>事先說明，我不想因爲這些文章的內容責怪這些文章的作者——這些內容被很多 Linux 系統管理員認爲是「常識」， 並且很可能你問他們什麼是交換區的時候他們會給你這樣的回答。但是也很不幸的是， 這種認識是使用交換區的目的的一種普遍誤解，尤其在現代系統上。</p>
<p>前文中我說過回收匿名頁面的內存是「不可能的」，因爲匿名內存的特點，把它們從內存中清除掉之後， 沒有別的存儲區域能作爲他們的備份——因此，要回收它們會造成數據丟失。但是，如果我們爲這種內存頁面創建 一種後備存儲呢？</p>
<p>嗯，這正是交換區存在的意義。交換區是一塊存儲空間，用來讓這些看起來「不可回收」的內存頁面在需要的時候 可以交換到存儲設備上。這意味着有了交換區之後，這些匿名頁面也和別的那些可回收內存一樣， 可以作爲內存回收的候選，就像乾淨文件頁面，從而允許更有效地使用物理內存。</p>
<p><strong>交換區主要是爲了平等的回收機制，而不是爲了緊急情況的「額外內存」。使用交換區不會讓你的程序變慢——</strong> <strong>進入內存競爭的狀態才是讓程序變慢的元兇。</strong></p>
<p>那麼在這種「平等的可回收機遇」的情況下，讓我們選擇回收匿名頁面的行爲在何種場景中更合理呢？ 抽象地說，比如在下述不算罕見的場景中：</p>
<ol>
<li>程序初始化的時候，那些長期運行的程序可能要分配和使用很多頁面。這些頁面可能在最後的關閉/清理的 時候還需要使用，但是在程序「啓動」之後（以具體的程序相關的方式）持續運行的時候不需要訪問。 對後臺服務程序來說，很多後臺程序要初始化不少依賴庫，這種情況很常見。</li>
<li>在程序的正常運行過程中，我們可能分配一些很少使用的內存。對整體系統性能而言可能比起讓這些內存頁 一直留在內存中，只有在用到的時候才按需把它們用 <strong>缺頁異常（major fault）</strong> 換入內存， 可以空出更多內存留給更重要的東西。</li>
</ol>
<h4 id=考察有無交換區時會發生什麼>考察有無交換區時會發生什麼<a hidden class=anchor aria-hidden=true href=#考察有無交換區時會發生什麼>#</a></h4>
<p>我們來看一些在常見場景中，有無交換區時分別會如何運行。 在我的 <a href="https://www.youtube.com/watch?v=ikZ8_mRotT4">關於 cgroup v2 的演講</a> 中探討過「內存競爭」的指標。</p>
<h5 id=在無低內存競爭的狀態下>在無/低內存競爭的狀態下<a hidden class=anchor aria-hidden=true href=#在無低內存競爭的狀態下>#</a></h5>
<ul>
<li><strong>有交换区:</strong> 我們可以選擇換出那些只有在進程生存期內很小一部分時間會訪問的匿名內存， 這允許我們空出更多內存空間用來提升緩存命中率，或者做別的優化。</li>
<li><strong>無交換區:</strong> 我們不能換出那些很少使用的匿名內存，因爲它們被鎖在了內存中。雖然這通常不會直接表現出問題， 但是在一些工作條件下這可能造成卡頓導致不平凡的性能下降，因爲匿名內存佔着空間不能給 更重要的需求使用。</li>
</ul>
<blockquote>
<p>譯註：關於 <strong>內存熱度</strong> 和 <strong>內存顛簸（thrash）</strong></p>
<p>討論內核中內存管理的時候經常會說到內存頁的 <strong>冷熱</strong> 程度。這裏冷熱是指歷史上內存頁被訪問到的頻度， 內存管理的經驗在說，歷史上在近期頻繁訪問的 <strong>熱</strong> 內存，在未來也可能被頻繁訪問， 從而應該留在物理內存裏；反之歷史上不那麼頻繁訪問的 <strong>冷</strong> 內存，在未來也可能很少被用到， 從而可以考慮交換到磁盤或者丟棄文件緩存。</p>
<p><strong>顛簸（thrash）</strong> 這個詞在文中出現多次但是似乎沒有詳細介紹，實際計算機科學專業的課程中應該有講過。 一段時間內，讓程序繼續運行所需的熱內存總量被稱作程序的工作集（workset），估算工作集大小， 換句話說判斷進程分配的內存頁中哪些屬於 <strong>熱</strong> 內存哪些屬於 <strong>冷</strong> 內存，是內核中 內存管理的最重要的工作。當分配給程序的內存大於工作集的時候，程序可以不需要等待I/O全速運行； 而當分配給程序的內存不足以放下整個工作集的時候，意味着程序每執行一小段就需要等待換頁或者等待 磁盤緩存讀入所需內存頁，產生這種情況的時候，從用戶角度來看可以觀察到程序肉眼可見的「卡頓」。 當系統中所有程序都內存不足的時候，整個系統都處於顛簸的狀態下，響應速度直接降至磁盤I/O的帶寬。 如本文所說，禁用交換區並不能防止顛簸，只是從等待換頁變成了等待文件緩存， 給程序分配超過工作集大小的內存才能防止顛簸。</p>
</blockquote>
<h5 id=在中高內存競爭的狀態下>在中/高內存競爭的狀態下<a hidden class=anchor aria-hidden=true href=#在中高內存競爭的狀態下>#</a></h5>
<ul>
<li><strong>有交换区:</strong> 所有內存類型都有平等的被回收的可能性。這意味着我們回收頁面有更高的成功率—— 成功回收的意思是說被回收的那些頁面不會在近期內被缺頁異常換回內存中（顛簸）。</li>
<li><strong>無交換區:</strong> 匿名內存因爲無處可去所以被鎖在內存中。長期內存回收的成功率變低了，因爲我們成體上 能回收的頁面總量少了。發生缺頁顛簸的危險性更高了。缺乏經驗的讀者可能覺得這某時也是好事， 因爲這能避免進行磁盤I/O，但是實際上不是如此——我們只是把交換頁面造成的磁盤I/O變成了扔掉熱緩存頁 和扔掉代碼段，這些頁面很可能馬上又要從文件中讀回來。</li>
</ul>
<h5 id=在臨時內存佔用高峰時>在臨時內存佔用高峰時<a hidden class=anchor aria-hidden=true href=#在臨時內存佔用高峰時>#</a></h5>
<ul>
<li><strong>有交换区:</strong> 我們對內存使用激增的情況更有抵抗力，但是在嚴重的內存不足的情況下， 從開始發生內存顛簸到 OOM 殺手開始工作的時間會被延長。內存壓力造成的問題更容易觀察到， 從而可能更有效地應對，或者更有機會可控地干預。</li>
<li><strong>無交換區:</strong> 因爲匿名內存被鎖在內存中了不能被回收，所以 OOM 殺手會被更早觸發。 發生內存顛簸的可能性更大，但是發生顛簸之後到 OOM 解決問題的時間間隔被縮短了。 基於你的程序，這可能更好或是更糟。比如說，基於隊列的程序可能更希望這種從顛簸到殺進程的轉換更快發生。 即便如此，發生 OOM 的時機通常還是太遲於是沒什麼幫助——只有在系統極度內存緊缺的情況下才會請出 OOM 殺手，如果想依賴這種行爲模式，不如換成更早殺進程的方案，因爲在這之前已經發生內存競爭了。</li>
</ul>
<h5 id=好吧所以我需要系統交換區但是我該怎麼爲每個程序微調它的行爲>好吧，所以我需要系統交換區，但是我該怎麼爲每個程序微調它的行爲？<a hidden class=anchor aria-hidden=true href=#好吧所以我需要系統交換區但是我該怎麼爲每個程序微調它的行爲>#</a></h5>
<p>你肯定想到了我寫這篇文章一定會在哪兒插點 cgroup v2 的安利吧？ ;-)</p>
<p>顯然，要設計一種對所有情況都有效的啓發算法會非常難，所以給內核提一些指引就很重要。 歷史上我們只能在整個系統層面做這方面微調，通過 <code>vm.swappiness</code> 。這有兩方面問題： <code>vm.swappiness</code> 的行爲很難準確控制，因爲它只是傳遞給一個更大的啓發式算法中的一個小參數； 並且它是一個系統級別的設置，沒法針對一小部分進程微調。</p>
<p>你可以用 <code>mlock</code> 把頁面鎖在內存裏，但是這要麼必須改程序代碼，或者折騰 <code>LD_PRELOAD</code> ，或者在運行期用調試器做一些魔法操作。對基於虛擬機的語言來說這種方案也不能 很好工作，因爲通常你沒法控制內存分配，最後得用上 <code>mlockall</code> ，而這個沒有辦法精確指定你實際上想鎖住的頁面。</p>
<p>cgroup v2 提供了一套可以每個 cgroup 微調的 <code>memory.low</code> ，允許我們告訴內核說當使用的內存低於一定閾值之後優先回收別的程序的內存。這可以讓我們不強硬禁止內核 換出程序的一部分內存，但是當發生內存競爭的時候讓內核優先回收別的程序的內存。在正常條件下， 內核的交換邏輯通常還是不錯的，允許它有條件地換出一部分頁面通常可以改善系統性能。在內存競爭的時候 發生交換顛簸雖然不理想，但是這更多地是單純因爲整體內存不夠了，而不是因爲交換進程（swapper）導致的問題。 在這種場景下，你通常希望在內存壓力開始積攢的時候通過自殺一些非關鍵的進程的方式來快速退出（fail fast）。</p>
<p>你不能依賴 OOM 殺手達成這個。 OOM 殺手只有在非常急迫的情況下纔會出動，那時系統已經處於極度不健康的 狀態了，而且很可能在這種狀態下保持了一陣子了。需要在開始考慮 OOM 殺手之前，積極地自己處理這種情況。</p>
<p>不過，用傳統的 Linux 內存統計數據還是挺難判斷內存壓力的。我們有一些看起來相關的系統指標，但是都 只是支離破碎的——內存用量、頁面掃描，這些——單純從這些指標很難判斷系統是處於高效的內存利用率還是 在滑向內存競爭狀態。我們在 Facebook 有個團隊，由 <a href="https://patchwork.kernel.org/project/LKML/list/?submitter=45">Johannes</a> 牽頭，努力開發一些能評價內存壓力的新指標，希望能在今後改善目前的現狀。 如果你對這方面感興趣， <a href="https://youtu.be/ikZ8_mRotT4?t=2145">在我的 cgroup v2 的演講中介紹到一個被提議的指標</a> 。</p>
<h4 id=調優>調優<a hidden class=anchor aria-hidden=true href=#調優>#</a></h4>
<h5 id=那麼我需要多少交換空間>那麼，我需要多少交換空間？<a hidden class=anchor aria-hidden=true href=#那麼我需要多少交換空間>#</a></h5>
<p>通常而言，最優內存管理所需的最小交換空間取決於程序固定在內存中而又很少訪問到的匿名頁面的數量， 以及回收這些匿名頁面換來的價值。後者大體上來說是問哪些頁面不再會因爲要保留這些很少訪問的匿名頁面而 被回收掉騰出空間。</p>
<p>如果你有足夠大的磁盤空間和比較新的內核版本（4.0+），越大的交換空間基本上總是越好的。 更老的內核上 <code>kswapd</code> ， 內核中負責管理交換區的內核線程，在歷史上傾向於有越多交換空間就 急於交換越多內存出去。在最近一段時間，可用交換空間很大的時候的交換行爲已經改善了很多。 如果在運行 4.0+ 以後的內核，即便有很大的交換區在現代內核上也不會很激進地做交換。因此， 如果你有足夠的容量，現代內核上有個幾個 GB 的交換空間大小能讓你有更多選擇。</p>
<p>如果你的磁盤空間有限，那麼答案更多取決於你願意做的取捨，以及運行的環境。理想上應該有足夠的交換空間 能高效應對正常負載和高峰（內存）負載。我建議先用 2-3GB 或者更多的交換空間搭個測試環境， 然後監視在不同（內存）負載條件下持續一週左右的情況。只要在那一週裏沒有發生過嚴重的內存不足—— 發生了的話說明測試結果沒什麼用——在測試結束的時候大概會留有多少 MB 交換區佔用。 作爲結果說明你至少應該有那麼多可用的交換空間，再多加一些以應對負載變化。用日誌模式跑 <code>atop</code> 可以在 <code>SWAPSZ</code> 欄顯示程序的頁面被交換出去的情況，所以如果你還沒用它記錄服務器歷史日誌的話 ，這次測試中可以試試在測試機上用它記錄日誌。這也會告訴你什麼時候你的程序開始換出頁面，你可以用這個 對照事件日誌或者別的關鍵數據。</p>
<p>另一點值得考慮的是交換空間所在存儲設備的媒介。讀取交換區傾向於很隨機，因爲我們不能可靠預測什麼時候 什麼頁面會被再次訪問。在 SSD 上這不是什麼問題，但是在傳統磁盤上，隨機 I/O 操作會很昂貴， 因爲需要物理動作尋道。另一方面，重新加載文件緩存可能不那麼隨機，因爲單一程序在運行期的文件讀操作 一般不會太碎片化。這可能意味着在傳統磁盤上你想更多地回收文件頁面而不是換出匿名頁面，但仍舊， 你需要做測試評估在你的工作負載下如何取得平衡。</p>
<blockquote>
<p>譯註：關於休眠到磁盤時的交換空間大小</p>
<p>原文這裏建議交換空間至少是物理內存大小，我覺得實際上不需要。休眠到磁盤的時候內核會寫回並丟棄 所有有文件作後備的可回收頁面，交換區只需要能放下那些沒有文件後備的頁面就可以了。 如果去掉文件緩存頁面之後剩下的已用物理內存總量能完整放入交換區中，就可以正常休眠。 對於桌面瀏覽器這種內存大戶，通常有很多緩存頁可以在休眠的時候丟棄。</p>
</blockquote>
<p>對筆記本/桌面用戶如果想要休眠到交換區，這也需要考慮——這種情況下你的交換文件應該至少是物理內存大小。</p>
<h5 id=我的-swappiness-應該如何設置>我的 swappiness 應該如何設置？<a hidden class=anchor aria-hidden=true href=#我的-swappiness-應該如何設置>#</a></h5>
<p>首先很重要的一點是，要理解 <code>vm.swappiness</code> 是做什麼的。 <code>vm.swappiness</code> 是一個 sysctl 用來控制在內存回收的時候，是優先回收匿名頁面， 還是優先回收文件頁面。內存回收的時候用兩個屬性： <code>file_prio</code> （回收文件頁面的傾向） 和 <code>anon_prio</code> （回收匿名頁面的傾向）。 <code>vm.swappiness</code> 控制這兩個值， 因爲它是 <code>anon_prio</code> 的默認值，然後也是默認 200 減去它之後 <code>file_prio</code> 的默認值。 意味着如果我們設置 <code>vm.swappiness = 50</code> 那麼結果是 <code>anon_prio</code> 是 50， <code>file_prio</code> 是 150 （這裏數值本身不是很重要，重要的是兩者之間的權重比）。</p>
<blockquote>
<p>譯註：關於 SSD 上的 swappiness</p>
<p>原文這裏說 SSD 上 swap 和 drop page cache 差不多開銷所以 <code>vm.swappiness = 100</code> 。我覺得實際上要考慮 swap out 的時候會產生寫入操作，而 drop page cache 可能不需要寫入（ 要看頁面是否是髒頁）。如果負載本身對I/O帶寬比較敏感，稍微調低 swappiness 可能對性能更好， 內核的默認值 60 是個不錯的默認值。以及桌面用戶可能對性能不那麼關心，反而更關心 SSD 的寫入壽命，雖然說 SSD 寫入壽命一般也足夠桌面用戶，不過調低 swappiness 可能也能減少一部分不必要的寫入（因爲寫回髒頁是必然會發生的，而寫 swap 可以避免）。 當然太低的 swappiness 會對性能有負面影響（因爲太多匿名頁面留在物理內存裏而降低了緩存命中率） ，這裏的權衡也需要根據具體負載做測試。</p>
<p>另外澄清一點誤解， swap 分區還是 swap 文件對系統運行時的性能而言沒有差別。或許有人會覺得 swap 文件要經過文件系統所以會有性能損失，在譯文之前譯者說過 Linux 的內存管理子系統基本上獨立於文件系統。 實際上 Linux 上的 swapon 在設置 swap 文件作爲交換空間的時候會讀取一次文件系統元數據， 確定 swap 文件在磁盤上的地址範圍，隨後運行的過程中做交換就和文件系統無關了。關於 swap 空間是否連續的影響，因爲 swap 讀寫基本是頁面單位的隨機讀寫，所以即便連續的 swap 空間（swap 分區）也並不能改善 swap 的性能。希疏文件的地址範圍本身不連續，寫入希疏文件的空洞需要 文件系統分配磁盤空間，所以在 Linux 上交換文件不能是希疏文件。只要不是希疏文件， 連續的文件內地址範圍在磁盤上是否連續（是否有文件碎片）基本不影響能否 swapon 或者使用 swap 時的性能。</p>
</blockquote>
<p>這意味着，通常來說 <code>vm.swappiness</code> <strong>只是一個比例，用來衡量在你的硬件和工作負載下，</strong> <strong>回收和換回匿名內存還是文件內存哪種更昂貴</strong> 。設定的值越低，你就是在告訴內核說換出那些不常訪問的 匿名頁面在你的硬件上開銷越昂貴；設定的值越高，你就是在告訴內核說在你的硬件上交換匿名頁和 文件緩存的開銷越接近。內存管理子系統仍然還是會根據實際想要回收的內存的訪問熱度嘗試自己決定具體是 交換出文件還是匿名頁面，只不過 swappiness 會在兩種回收方式皆可的時候，在計算開銷權重的過程中左右 是該更多地做交換還是丟棄緩存。在 SSD 上這兩種方式基本上是同等開銷，所以設成 <code>vm.swappiness = 100</code> （同等比重）可能工作得不錯。在傳統磁盤上，交換頁面可能會更昂貴， 因爲通常需要隨機讀取，所以你可能想要設低一些。</p>
<p>現實是大部分人對他們的硬件需求沒有什麼感受，所以根據直覺調整這個值可能挺困難的 —— 你需要用不同的值做測試。你也可以花時間評估一下你的系統的內存分配情況和核心應用在大量回收內存的時候的行爲表現。</p>
<p>討論 <code>vm.swappiness</code> 的時候，一個極爲重要需要考慮的修改是（相對）近期在 <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe35004fbf9eaf67482b074a2e032abb9c89b1dd">2012 年左右 Satoru Moriya 對 vmscan 行爲的修改</a> ，它顯著改變了代碼對 <code>vm.swappiness = 0</code> 這個值的處理方式。</p>
<p>基本上來說這個補丁讓我們在 <code>vm.swappiness = 0</code> 的時候會極度避免掃描（進而回收）匿名頁面， 除非我們已經在經歷嚴重的內存搶佔。就如本文前面所屬，這種行爲基本上不會是你想要的， 因爲這種行爲會導致在發生內存搶佔之前無法保證內存回收的公平性，這甚至可能是最初導致發生內存搶佔的原因。 想要避免這個補丁中對掃描匿名頁面的特殊行爲的話， <code>vm.swappiness = 1</code> 是你能設置的最低值。</p>
<p>內核在這裏設置的默認值是 <code>vm.swappiness = 60</code> 。這個值對大部分工作負載來說都不會太壞， 但是很難有一個默認值能符合所有種類的工作負載。因此，對上面「 <a href=https://farseerfc.me/in-defence-of-swap.html#id17>那麼，我需要多少交換空間？</a> 」那段討論的一點重要擴展可以說，在測試系統中可以嘗試使用不同的 <code>vm.swappiness</code> ，然後監視你的程序和系統在重（內存）負載下的性能指標。在未來某天，如果我們在內核中有了合理的 <a href="https://youtu.be/ikZ8_mRotT4?t=2145">缺頁檢測</a> ，你也將能通過 cgroup v2 的頁面缺頁 指標來以負載無關的方式決定這個。</p>
<p><a href="https://www.youtube.com/watch?v=beefUhRH5lU">SREcon19 Asia/Pacific - Linux Memory Management at Scale: Under the Hood</a></p>
<h5 id=2019年07月更新內核-420-中的內存壓力指標>2019年07月更新：內核 4.20+ 中的內存壓力指標<a hidden class=anchor aria-hidden=true href=#2019年07月更新內核-420-中的內存壓力指標>#</a></h5>
<p>前文中提到的開發中的內存缺頁檢測指標已經進入 4.20+ 以上版本的內核，可以通過 <code>CONFIG_PSI=y</code> 開啓。詳情參見我在 SREcon 大約 25:05 左右的討論。</p>
<h4 id=結論>結論<a hidden class=anchor aria-hidden=true href=#結論>#</a></h4>
<ul>
<li>交換區是允許公平地回收內存的有用工具，但是它的目的經常被人誤解，導致它在業內這種負面聲譽。如果 你是按照原本的目的使用交換區的話——作爲增加內存回收公平性的方式——你會發現它是很有效的工具而不是阻礙。</li>
<li>禁用交換區並不能在內存競爭的時候防止磁盤I/O的問題，它只不過把匿名頁面的磁盤I/O變成了文件頁面的 磁盤I/O。這不僅更低效，因爲我們回收內存的時候能選擇的頁面範圍更小了，而且它可能是導致高度內存競爭 狀態的元兇。</li>
<li>有交換區會導致系統更慢地使用 OOM 殺手，因爲在缺少內存的情況下它提供了另一種更慢的內存， 會持續地內存顛簸——內核調用 OOM 殺手只是最後手段，會晚於所有事情已經被搞得一團糟之後。 解決方案取決於你的系統：
<ul>
<li>你可以預先更具每個 cgroup 的或者系統全局的內存壓力改變系統負載。這能防止我們最初進入內存競爭 的狀態，但是 Unix 的歷史中一直缺乏可靠的內存壓力檢測方式。希望不久之後在有了 <a href="https://youtu.be/ikZ8_mRotT4?t=2145">缺頁檢測</a> 這樣的性能指標之後能改善這一點。</li>
<li>你可以使用 <code>memory.low</code> 讓內核不傾向於回收（進而交換）特定一些 cgroup 中的進程， 允許你在不禁用交換區的前提下保護關鍵後臺服務。</li>
</ul>
</li>
</ul>
<h3 id=關於-swap-的一些補充httpsfarseerfcmefollowup-about-swaphtmlf><a href=https://farseerfc.me/followup-about-swap.html>關於 swap 的一些補充</a>f<a hidden class=anchor aria-hidden=true href=#關於-swap-的一些補充httpsfarseerfcmefollowup-about-swaphtmlf>#</a></h3>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://sakamotokurome.github.io/tags/unix/>Unix</a></li>
<li><a href=https://sakamotokurome.github.io/tags/linux/>Linux</a></li>
<li><a href=https://sakamotokurome.github.io/tags/fedora/>Fedora</a></li>
<li><a href=https://sakamotokurome.github.io/tags/centos/>CentOS</a></li>
<li><a href=https://sakamotokurome.github.io/tags/linux-deploy/>Linux Deploy</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://sakamotokurome.github.io/posts/opensuse/>
<span class=title>« Prev Page</span>
<br>
<span>openSUSE</span>
</a>
<a class=next href=https://sakamotokurome.github.io/posts/ubuntup4tips/>
<span class=title>Next Page »</span>
<br>
<span>Ubuntu Tips</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2024 <a href=https://sakamotokurome.github.io/>Sakamoto Kurome</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
</body>
</html>