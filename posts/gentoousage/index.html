<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Gentoo Usage | Sakamoto Kurome</title>
<meta name="keywords" content="Unix, Linux, Gentoo" />
<meta name="description" content="Portage介绍 欢迎使用 Portage Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具">
<meta name="author" content="Sakamoto Kurome">
<link rel="canonical" href="https://sakamotokurome.github.io/posts/gentoousage/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css" integrity="sha256-yIlj/i15RiAA/Q&#43;xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://sakamotokurome.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://sakamotokurome.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://sakamotokurome.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://sakamotokurome.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://sakamotokurome.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.90.0" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>

<link rel="stylesheet" href="https://sakamotokurome.github.io/custom.css">
<meta name="google-site-verification" content="i2r403EffR8m-KBf7EHi6AYg7tfnMshaXTAynoYPnpE" />
<script async src="https://www.googletagmanager.com/gtag/js?id=G-K2Y212LPQ2"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-K2Y212LPQ2', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="Gentoo Usage" />
<meta property="og:description" content="Portage介绍 欢迎使用 Portage Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sakamotokurome.github.io/posts/gentoousage/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-21T15:39:24&#43;08:00" />
<meta property="article:modified_time" content="2022-03-21T15:39:24&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Gentoo Usage"/>
<meta name="twitter:description" content="Portage介绍 欢迎使用 Portage Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://sakamotokurome.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Gentoo Usage",
      "item": "https://sakamotokurome.github.io/posts/gentoousage/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Gentoo Usage",
  "name": "Gentoo Usage",
  "description": "Portage介绍 欢迎使用 Portage Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具",
  "keywords": [
    "Unix", "Linux", "Gentoo"
  ],
  "articleBody": "Portage介绍 欢迎使用 Portage Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具。\nPortage 是用 Python 和 Bash 两种语言编写的。因为它们都是脚本语言所以用户可以直接阅读它的代码。\n大多数用户通过 emerge 使用 Portage。本章的内容不是复述 emerge 的 man page。要了解 emerge 的所有可用选项，请查阅 emerge 的 man page（emerge 中文手册）：\n# man emerge Gentoo 软件仓库 查询 Portage 的信息\n# emerge --info Ebuild 当 Gentoo 的文档介绍某个软件包的时候，这意味着 Gentoo 的用户们可以在 Gentoo 的软件仓库里找到它。ebuild 是一种包含了所有 Portage 维护软件（比如安装，搜索，查询等等）所需信息的文件，而 Gentoo 的软件仓库是它们的一个集合。这些 ebuild 文件默认储存在 /var/db/repos/gentoo。\nPortage 对于软件的行为都是基于本地的 ebuild。为了能收到新的软件包，安全更新等等，时常更新本地 ebuild 是一件很重要的事情。\n更新 Gentoo 软件仓库 Gentoo 的软件仓库通常使用 rsync 进行同步，rsync 是一个快速的文件增量传输工具。要使用它很简单，Portage 的命令行前端 emerge 提供了一个调用 rsync 的方法：\n# emerge --sync 有时防火墙会干扰 rsync 与镜像的连接。这时，我们可以使用 emerge-webrsync 来自动下载和安装 Portage 树的快照版本：\n# emerge-webrsync 使用 emerge-webrsync 的另一个好处是可以只安装由 Gentoo release engineering 团队的 GPG 密钥签名过的快照。与此有关的详细信息可以在 fetching validated Gentoo repository snapshots 找到\n维护软件 搜索软件 有很多方法可以在 Gentoo 的软件仓库寻找软件。其中之一是使用 emerge 本身。在默认情况下 emerge –search 会返回所有符合搜索条件的包名。\n举个例子，找出所有名字里含有 “pdf” 的包：\n# emerge -s  # emerge --search pdf 如果要根据描述进行搜索，可以使用 --searchdesc （或 -S）选项:\n# emerge --searchdesc pdf 需要注意的是它会输出很多信息。不过由于都有很清楚的标识，我们就不再赘述它们的意思了。\n安装软件 当你找到了软件包的名字，安装它只需要简单得使用 emerge。举个例子，如果要安装 gnumeric：\n# emerge  # emerge --ask app-office/gnumeric 由于很多软件依赖其它的软件，在安装该软件的同时很可能还会安装它的一些以来。不要担心，Portage 可以很好地处理依赖关系。如果要知道 Portage 会安装什么软件，可以在命令中加入 -p/--pretend选项。举个例子：\n# emerge --pretend gnumeric 在安装软件期间，Portage将从Internet下载必要的源代码（如果需要），并将其默认存储在 /var/cache/distfiles/ 中。 之后，它将解压缩，编译和安装包。 要让Portage仅下载源代码而不安装软件，请添加-f/--fetchonly选项到emerge命令：\n# emerge --fetchonly gnumeric 恢复上一次失败的 emerge\n# emerge -r 其它常用的选项有\n  -1/--oneshot 一般用在安装软件包时，不将该包添加到 world 集中\n  -O/--nodeps 不计算依赖关系，只操作指定的包（安装时可能会因为依赖不满足而导致安装失败）\n  -j/--jobs 设置 Portage 同时执行的最大任务数，如果未设置数量，那么 Portage 不会限制最大的任务数。如果要将该选项添加到默认选项下，那么建议配合 -l/--load-average 使用， -l/--load-average 用于配置 emerge 的负载阈值，当当前负载到达设定值后， emerge 将不再开启新任务，以避免负载过高，这在 CPU 不够强悍或者内存不宽裕的机器上很需要。比如在一个 8 核 16 线程 16G 内存的机器上，可以设置成 -j -l 12 ，这样的设定使 portage 的并行任务数不由硬性规定的数目来限制，而是通过动态负载来进行限制。\n  --keep-going 它会在安装出错时，跳过安装失败的包，并重新计算依赖后继续安装剩余包\n  -n/--noreplace 不重复安装已经安装的包（默认会忽略掉 USE 的改动以及升级的查询，除非对应加上 -D/-U 和 -u 选项）\n  -t/--tree 显示给定包的安装依赖树\n  --autounmask 类\n这是一组在新装软件包时便于解除安装限制的选项。之前有介绍，在 Portage 安装软件的过程中，可能会因为 USE/License/Keywords 等因素导致无法直接安装，需要配置后再进行，而这组选项可以自动化这个过程。个人建议的相关选项组合为 --autounmask --autounmask-keep-masks --autounmask-write=n ，此组合不会完全自动写入配置到系统下，但是提示了如何配置，方便手动写入，既简化了处理限制的流程，又能保证掌握每次安装包时的改动。\n  查找已安装软件的文档 许多软件包中包含有自己的文档，有些时候，doc的USE标记决定了软件包中的自带文档是否会被安装。您可以通过 emerge -vp category/包名命令来检查是否存在doc USE 标志：\n# emerge -vp media-libs/alsa-lib These are the packages that would be merged, in order: Calculating dependencies... done! [ebuild R ] media-libs/alsa-lib-1.1.3::gentoo USE=\"python -alisp -debug -doc\" ABI_X86=\"(64) -32 (-x32)\" PYTHON_TARGETS=\"python2_7\" 0 KiB 最好的启用 doc USE 的方式是在 /etc/portage/package.use里对想要启用的包单独启用，这样你就能只获得你想要的软件文档。了解更多信息请阅读 USE flags chapter。\n当一个软件包安装结束后，它的文档通常会存放在/usr/share/doc/目录下的，以软件包名命名的子目录中：\n$ ls -l /usr/share/doc/alsa-lib-1.1.3 total 16 -rw-r--r-- 1 root root 3098 Mar 9 15:36 asoundrc.txt.bz2 -rw-r--r-- 1 root root 672 Mar 9 15:36 ChangeLog.bz2 -rw-r--r-- 1 root root 1083 Mar 9 15:36 NOTES.bz2 -rw-r--r-- 1 root root 220 Mar 9 15:36 TODO.bz2 列出已安装文档文件的更可靠方法是使用 equery 的 --filter 选项。 equery 用于查询Portage的数据库，并作为 app-portage/gentoolkit 包的一部分：\n$ equery files --filter=doc alsa-lib * Searching for alsa-lib in media-libs ... * Contents of media-libs/alsa-lib-1.1.3: /usr/share/doc/alsa-lib-1.1.3/ChangeLog.bz2 /usr/share/doc/alsa-lib-1.1.3/NOTES.bz2 /usr/share/doc/alsa-lib-1.1.3/TODO.bz2 /usr/share/doc/alsa-lib-1.1.3/asoundrc.txt.bz2 --filter 选项可与其他规则一起使用，以查看许多其他类型文件的安装位置。可以在 equery 的手册中查看其他功能: man 1 equery。\n卸载软件 当您想把一个软件包从系统中移除的时候，使用 emerge –unmerge命令。命令执行完成后，Portage将会移除此软件包安装到您系统中的所有文件，除了那些在安装软件后您修改过的配置文件。保留这些修改过的配置文件是为了便于您今后再次使用它。\n# emerge --unmerge gnumeric # emerge -C  当您从系统中移除一个软件包时，之前那些为了满足其依赖关系而被自动安装的软件包将会被保留在系统中。要使Portage找到现在可以删除的所有依赖项，可以使用 --depclean 功能。\n自动清理系统下的软件包\n# emerge --ask --depclean # emerge -ac 默认选项 emerge 支持配置一组默认选项，用于在每次运行 emerge 时采用。这个储存默认选项的变量名为 EMERGE_DEFAULT_OPTS ，在 /etc/portage/make.conf 文件下设置。\n这里一组比较推荐的默认选项配置为\nEMERGE_DEFAULT_OPTS=\"--autounmask --autounmask-keep-masks --autounmask-write=n --keep-going -v -j -l 12\" 其中的 12 请根据实际情况修改，如果配置了上文的 binhost ，那么对应选项也添加进入。\nUnderstanding Portage’s Formatted and Colored Output Output from portage is compactly formatted to indicate a plethora of information.\nEmerge “Pretend” Output\n N = new (not yet installed) S = new SLOT installation (side-by-side versions) U = updating (to another version) D = downgrading (best version seems lower) R = replacing (re-merging same version) F = fetch restricted (must be manually downloaded) f = fetch (already downloaded) B = blocked by an already installed package  USE Flags\n An unmarked USE flag is unchanged and enabled. - A dash preceding a USE flag (yellow, green or blue) shows that it is disabled. % A percent symbol following a USE flag indicates that it is new for this package. Identical to yellow output. ***** An asterisk following a USE flag indicates that its meaning/scope has been updated. Identical to green output. () Parentheses around a USE flag indicate that it is currently masked by your profile. This is usually because the USE flag can not be supported on the given platform (for example, the win32codecs on amd64 with non-binary packages) or is irrelevant (for example, sse is available on all amd64 CPU’s, so there’s no point being able to disable it in a 64-bit environment).  Color Output\nPortage returns information to you using both symbols and colors. While the combination makes for a pretty output it also may appear confusing on first glance. Note that the color information is not required, so it repeats the symbolic output.\n red - The USE flag is enabled and has not changed. yellow - The USE flag has been added since the package was last installed. green - The USE flag has changed since the last time the package was installed, as the asterisk after it indicates. blue - The USE flag is disabled, as the dash before it indicates.  Example\nIf you run the command\n# emerge --update --verbose --deep --newuse world you might get something similar to\n[ebuild R ] sys-kernel/linux-headers-2.6.11-r2 USE=\"-gcc64%\" 36,470 kB [ebuild U ] sys-process/psmisc-22.2 USE=\"X* ipv6 nls (-selinux)\" 238 kB In this example the sys-kernel/linux-headers package would be reinstalled as indicated by the “R” at the beginning of the line. The sys-process/psmisc package is being updated, as shown by the “U” at the beginning of the line.\n The gcc64 USE flag is colored yellow and followed by “%” showing that that option has been added since the package was last installed. The “-” shows that it will be disabled during this update. The X USE flag will be green and followed by “*” because that USE flag has changed since the last time the package was installed, as the asterisk after it indicates. No “-” shows that it will be enabled during this update. The ipv6 and nls USE flags would appear red since they are enabled (No “-\") and have not changed (No “*****\"). The selinux USE flag will be blue because the flag is disabled, as the dash before it indicates. The parentheses also show that it is an unavailable or irrelevant option.  更新系统 要保持您的系统在最佳状态（更不用说安装那些最新的安全更新），您需要定期的更新您的系统。由于Portage只能检查本地已有文件，因此您首先应该更新您的Portage树。当您的Portage树更新后，您可以用 emerge –update @world命令来更新系统。在下一个例子里，我们还会使用 --ask 选项来控制Portage显示它要更新的软件包列表， 并让您决定是否继续更新。\n# emerge --update --ask @world Portage将搜索已安装的程序的新版本。 然而，它只会验证明确安装的应用程序（在 /var/lib/portage/world 列出的应用程序）的版本，却不会检查它们的依赖项。若要更新这些包的依赖项，请添加 --deep 选项：\n# emerge --update --deep @world 但是，这并不意味着会更新所有的软件包：某些系统上的软件包，会在编译和构建软件的过程中需要，但是一旦安装完软件，就不再需要这些依赖项。 Portage 称这些依赖为“构建依赖”。 若要在更新时包含这些构建依赖，请添加 --with-bdeps=y 选项：\n# emerge --update --deep --with-bdeps=y @world 因为有时那些没有明确安装的包（但作为其他软件包的依赖而装入系统中）会推出安全更新，所以推荐偶尔运行一下这个命令。\n每当您改变了系统中任何的 USE 标记后，最好加入 --newuse 选项。这样 Portage 将会验证这个 USE 标记变动后，是否需要安装新的软件包或者将现有的软件包重新编译。\n# emerge --update --deep --with-bdeps=y --newuse @world Meta软件包\nGentoo中的一些软件包并没有包含任何实际的内容，而只是用来安装一系列软件包的集合。例如，kde-plasma/plasma-meta 包就是一个包含了一系列与Plasma相关的互相依赖的软件包的集合，您可以通过安装它来在系统中搭建起一个完整的KDE Plasma 桌面环境。\n如果您试图从系统中移除一个这样的软件包的集合体，只是单纯地使用 emerge –unmerge 命令并不能完成您的要求，原因在于这些包的依赖关系仍然保留在系统中。\n不用担心，Portage也提供了移除孤立依赖的软件包的功能，但由于软件包间的依赖关系是动态的，您首先需要充分地更新您的整个系统，包括更改USE标记设定而导致的变化。在这之后您可以运行emerge –depclean来移除那些完全没有被其他包依赖的软件包。移除之后你需要重新编译那些曾经与刚刚移除的这些包动态连接过的应用程序，因为实际上这些程序不需要那些包。\n所有这些可以用以下三个命令来实现：\n# emerge --update --deep --newuse @world # emerge --depclean # revdep-rebuild 关于配置文件的更新 有时候在更新了某些软件包后你会发现出现了一个类似如下的提示信息：\n* IMPORTANT: 2 config files in '/etc' need updating. * See the CONFIGURATION FILES and CONFIGURATION FILES UPDATE TOOLS * sections of the emerge man page to learn how to update config files. 一般出现这种情况的直接原因是你通过归属于一个软件包的文件修改了其默认配置，导致新安装的文件与现存文件不符，于是 Portage 出于保护现存文件的目的，将新文件重命名为了对应目录下的 ._cfgxxxx_ 文件，这是一个很常见的情况。\n而每当出现这种情况后，需要做的操作就是人工介入，判断一下保留哪个文件，还是将两个文件合并。而自带用于进行此操作的对应命令有 dispatch-conf 与 etc-update 。\n以 dispatch-conf 为例，root 权限下执行后，它会逐个文件列出改动，然后提示你进行操作，比如按 z 保留旧的配置文件，按 u 使用新安装的配置文件替换旧的，等等。\n改变桌面环境/ Change Profile   首先修改 /var/lib/portage/world 文件，这个文件记录了用户主动安装的软件，换句话说，整个系统的构建就是围绕这 world 来创建的。将这个文件中不再需要的包删除，比方说 KDE 的软件和一些后续可以再安装，而目前保留可能造成构建麻烦的软件，比方说 htop，megasync，telegram-desktop，fcitx5 之类的，尽量减少到保留必须的就可以了，比方说内核，zfs 之类的。另外可以使用 emerge --deselect xxxx 命令清理 world 。\n  然后是修改或是删除暂时不需要的 USE 配置文件。这里需要强调一下，world 文件是我们手动安装的软件，这些软件用 /etc/portage/package.use/ 定义了其他附带安装的软件包和组。里面不再需要的包，就需要精简，甚至是删除。\n  其次使用 eselect profile 修改配置文件到需要的 Profile 。\n  再次就是运行 emerge --sync; emerge --depclean 来清理系统。一般情况下，这个步骤会删除数百个包，耐心等它完成。\n  最后就是一些收尾工作，清理结束后，运行一些小工具来解决一些新老软件依赖的问题，运行下面的命令一波清：\n# emerge -avj @preserved-rebuild; perl-cleaner --all; emerge --sync; emerge -avujDN --with-bdeps=y --autounmask-write=y @world 运行以后看看会不会有什么 Block 之类的包，或者循环依赖的包，手动删除下；还有时候解决不了看看是不是 USE 没有清理干净，多试几次就会清理干净，更新没有任何报错就可以开始后续的操作了。\n  这个时候一般会来一次全系统重构。命令如下：\n# emerge -ej --keep-going @world   清理 /home// 下的各种配置文件，安装新的桌面环境。\n  Licenses 从Portage版本2.1.7开始，可以根据其授权协议接受或拒绝安装软件。 portage 树中的所有包在其ebuild中包含一个LICENSE选项。 运行emerge –search package/category 将显示软件包的许可证。\nImportant：ebuild 中 的 LICENSE 变量仅是为 Gentoo 开发人员和用户准备的一份指南。它既不是法律声明，也不保证其真实性。因此不要过度依赖它，您需要深入检查软件包的本身，以及您使用的所有文件。\n默认情况下，Portage允许自由软件基金会，开源计划或遵循自由软件定义明确批准的许可。\n控制允许的许可证的变量称为ACCEPT_LICENSE，可以在/etc/portage/make.conf文件中设置。 在下一个示例中，将显示他的默认值：\nACCEPT_LICENSE=\"-* @FREE\" 使用此配置，可以安装具有自由软件或文档许可证的软件包。非自由软件将无法安装。\n可以在ACCEPT_LICENSE中全局设置 ACCEPT_LICENSE，或者在/etc/portage/package.license 文进行配置。\n举个例子，要允许www-client/google-chrome 包的google-chrome的授权协议， 把下面的内容添加到 /etc/portage/package.license:\n/  www-client/google-chrome google-chrome # 亦可指定版本，比如对 20210818 及以上版本的 sys-kernel/linux-firmware 进行配置 =sys-kernel/linux-firmware-20210818 linux-fw-redistributable no-source-code 这允许安装www-client/google-chrome 程序包，但禁止安装www-plugins/chrome-binary-plugins 程序包，即使它具有相同的 授权协议。\n重要：授权协议存储在 /var/db/repos/gentoo/licenses/ ，授权协议组在/var/db/repos/gentoo/profiles/license_groups 里面。CAPITAL字母中每行的第一个条目是许可证组的名称，之后的每个条目都是单独的许可证。\n在 ACCEPT_LICENSE 变量中定义的许可证组前缀为@ 符号。一种可能的设置（以前的Portage默认设置），是允许除“最终用户许可协议（EULA）”以外所有的许可证，“最终用户许可协议（EULA）”中的许可证需要阅读并签署接受协议。要完成此操作，请接受所有许可证（使用*），然后删除EULA组中的许可证，如下所示：\nACCEPT_LICENSE=\"* -@EULA\" 请注意，此设置也将接受非自由软件和文档。\nMasking \u0026 Unmasking packages package.mask中指定的软件将会不被安装（可以将其看成黑名单），当新版本的软件出现一些问题的时候（或者是不兼容）可以在这个文件中添加对应的记录。\n/etc/portage/package.unmask 文件的作用将会覆盖package.mask的效果（安装白名单）。\n屏蔽特定的包版本 如果它不存在，请创建/etc/portage/package.mask 文件：\n# echo \"x11-drivers/ati-drivers-12.6_beta_pre897\"  /etc/portage/package.mask 或者，创建/etc/portage/package.mask/ 目录：\n# mkdir -p /etc/portage/package.mask/ # echo \"x11-drivers/ati-drivers-12.6_beta_pre897\"  /etc/portage/package.mask/ati-drivers 从 ebuild 存储库中屏蔽包 创建一个文件以从名为“larry”的 ebuild 存储库中屏蔽名称为www-client/firefox 的包\n# echo \"www-client/firefox::larry\"  /etc/portage/package.mask/firefox 屏蔽 overlay 所有的包\n常规操作都是enable repository 后把所有包都mask 掉，要用的时候单独一个个开，加上 autounmask 也不用自己写。\n*/*::overlay_name ACCEPT_KEYWORDS ACCEPT_KEYWORDS 变量告诉包管理器哪个 ebuild 的 KEYWORDS 允许接受。\n变量在哪里设置？ 这个变量通常通过 Gentoo 的 profile 设置。但是可以在用户的 /etc/portage/make.conf 文件里进行覆盖，以及在 /etc/portage/package.accept_keywords 文件/目录下的每个包里或者甚至在命令行中进行覆盖。\nImportant：通过命令行覆盖 ACCEPT_KEYWORDS 变量通常被认为是个坏主意，因为设置不会被包管理器保存而且可能导致不必要的行为。\n稳定与不稳定的 keywords 在绝大多数的 profile 中 ACCEPT_KEYWORDS 变量的默认值即系统架构本身，例如 ACCEPT_KEYWORDS=\"amd64\" 或者 ACCEPT_KEYWORDS=\"arm\"。在此情况下，包管理器只接受那些KEYWORDS 变量包含此架构的 ebuild。如果用户希望能够安装那些还未被认为适合生产环境使用的 ebuild，可以在架构前添加 ~ 前缀，例如：\n# nano -w /etc/portage/make.conf ACCEPT_KEYWORDS=\"~amd64\" 由于ACCEPT_KEYWORDS变量是增量的，在添加测试关键字 (~amd64)的时候，不应当指定稳定的关键字(amd64)。\n如果不是进行系统全局设置，那么可以在 /etc/portage/package.accept_keywords 文件或目录中对每个包进行单独设置：\n/ [可选的关键字配置] # games games-fps/doomsday ~amd64 # 亦可指定版本，比如对 21.04.3 及以上版本的 kde-apps-meta 进行配置 =kde-apps/kde-apps-meta-21.04.3 除了 ACCEPT_KEYWORDS 的通常值以外， package.accept_keywords 还支持三个特殊值：\n * — 如果包在任何系统架构是稳定的，那么它可见 ~* — 如果包在任何系统架构是测试的，那么它可见 ** — 这个包总是可见的 (KEYWORDS 被完全忽略)  最后一个选项对于版本经常改变的包 （当前 svn/git/mercurial/… 版本的包， 他们通过 live ebuild 来支持，并且没有 KEYWORDS 变量。\n当Portage报错的时候 简介 正如我们之前指出的那样，Portage是一个非常强大并支持许多特性的软件包管理工具，而这是其他类似工具所欠缺的。为了理解这一点，我们为您粗略地解释一些Portage的面貌。\n通过使用Portage，一个软件的不同版本可以共存于一个系统中。其他发行版倾向于直接在软件包名字中包含版本号（例如freetype 和 freetype2），Gentoo的Portage使用一种我们称之为SLO的技术来实现这种并存。一个ebuild为它自身的版本声明了一个确切的SLOT。具有不同SLOT的同一软件的Ebuild可以共存于同一个系统中。例如，上例中那个freetype包就拥有不同的ebuilds，里面分别有 SLOT=“1” 和SLOT=“2\"的标志\n有一些不同的软件包提供了类似的功能。比如metalogd，sysklogd和syslog-ng都是系统日志记录工具。那些依赖于“系统日志记录工具”的程序并不能随便的依赖于其中之一，比如metalogd。因为其他的系统日志工具可能也是很好的选择。好在Portage允许使用虚拟包：每一个系统日志记录工具都可以提供virtual/logger包，因此应用程序们可以设定成仅仅依赖于virtual/syslog即可。\nPortage树中的软件可以存在于不同的分支中。您的系统默认只会接受那些Gentoo认为稳定的软件包。绝大多数新提交的软件会被添加到测试分支里。这意味着在此软件被标示为稳定版前需要进行更多的测试。尽管您可以看到那些软件的ebuilds已经加入Portage数据库，在它们未被加入稳定分支前Portage将不会安装它们。\n有些软件只能在某几个体系结构上使用。或者在其他体系结构中还不能运行，或者仍需要对其进行更多的测试，或者将软件提交到Portage树中的开发者还不能确定这个软件能否运行于其他体系结构。\n每一个Gentoo安装都依附于一个确定的profile，此文件里除了其他信息外还包含了一个正常工作的系统需要的软件包的列表。\n被阻挡的包 Portage关于被阻挡的包的警告(使用 –pretend参数)\n[blocks B ] mail-mta/ssmtp (is blocking mail-mta/postfix-2.2.2-r1) Portage关于被阻挡的包的警告(不使用 –pretend参数)\n!!! Error: the mail-mta/postfix package conflicts with another package. !!! both can't be installed on the same system together. !!! Please use 'emerge --pretend' to determine blockers. Ebuilds文件中包含了特定的字段，里面为Portage提供了此软件的各种依赖关系的信息。总计有两种可能的依赖关系：一种是编译依赖，在 DEPEND 区域进行声明;另一种是“运行时”依赖，在 RDEPEND 区域中进行声明。如果上述两种依赖关系中任何一个明确指明某个实体或者虚拟包（译注：可能已安装和正要安装）与要安装的包不相容的时候，就会阻挡软件的安装。\n虽然Portage的最新版本足够聪明，可以在没有用户干预的情况下解决轻微的问题，但偶尔也需要手动解决此类问题。\n为了使安装得以继续进行，您可以选择不安装这个软件包，或者先将发生冲突的包卸载。例如，在我们给出的这个例子中，您可以选择不安装postfix，或者先卸载ssmtp。\n你也可能会遇到某些特定版本的包被屏蔽的情况，比如。在这种情况下，升级到一个更新的版本就能解决问题。\n也有可能两个需要安装的包互相阻挡。这种少见的情况下，您应该明确自己为什么需要同时安装它们。绝大多数时候您只需要安装它们之中的一个就可以了。如果不是这样，请您到 Gentoo’s bugtracking system 中提交一个bug。\n被屏蔽的包 Portage关于被阻挡的包的警告\n!!! all ebuilds that could satisfy \"bootsplash\" have been masked. PPortage关于被屏蔽的包的警告——原因\n!!! possible candidates are: - gnome-base/gnome-2.8.0_pre1 (masked by: ~x86 keyword) - lm-sensors/lm-sensors-2.8.7 (masked by: -sparc keyword) - sys-libs/glibc-2.3.4.20040808 (masked by: -* keyword) - dev-util/cvsd-1.0.2 (masked by: missing keyword) - games-fps/unreal-tournament-451 (masked by: package.mask) - sys-libs/glibc-2.3.2-r11 (masked by: profile) - net-im/skype-2.1.0.81 (masked by: skype-eula license(s)) 当您想安装一个对于您系统不可用的软件包。您会收到类似这样的屏蔽错误提示。您应该试着安装那些对于您系统可用的程序或者等待那些不可用的包被置为可用的。通常一个软件包被屏蔽的原因在于：\n   Reason for mask Description     ~arch keyword 这个软件没有经过充分的测试，不能进入稳定分支，请等待一段时间后在尝试使用它。   -arch keyword or -* keyword 这个软件不能工作在您机器的体系结构中。如果您确信它能工作那么请到我们的bugzilla网站提交一个bug报告。   missing keyword 这个软件还没有在您机器的体系结构中进行过测试。您可以咨询相应体系结构移植小组是否能对它进行测试，或者您自己为他们进行这样的测试并将您得到的结论提交到我们的bugzilla网站。   package.mask 这个软件被认为是损坏的，不稳定的或者有更严重的问题，它被故意标识为“不应使用”。   profile 这个软件不适用于您的profile。安装这样的应用软件可能会破坏您的系统，或者只是不能与您使用的profile相兼容。   license 这个包的许可证的ACCEPT_LICENSE值不正确。 通过设置许可证或正确的许可证组来允许其许可证:/etc/portage/make.conf或 /etc/portage/package.license    USE必要的更改 Portage 提示 USE 标志需要进行更改\nThe following USE changes are necessary to proceed: #required by app-text/happypackage-2.0, required by happypackage (argument) =app-text/feelings-1.0.0 test 如果未使用--autounmask参数，则错误消息也可能显示如下：\nemerge: there are no ebuilds built with USE flags to satisfy \"app-text/feelings[test]\". !!! One of the following packages is required to complete your request: - app-text/feelings-1.0.0 (Change USE: +test) (dependency required by \"app-text/happypackage-2.0\" [ebuild]) (dependency required by \"happypackage\" [argument]) 当请求安装包时，发生这种警告或错误，这不仅取决于另一个包，而且还要求该包使用特定的USE标志（或一组USE标志）构建。 在给定的示例中，包应用文本/感觉需要使用 USE=“test\"构建，但此系统上未设置此USE标志。\n要解决这个问题， 到/etc/portage/make.conf编辑里面的USE标志, 或者去/etc/portage/package.use设置一个特殊的包.\n缺失依赖 Portage提示依赖性不满足\nemerge: there are no ebuilds to satisfy \"=sys-devel/gcc-3.4.2-r4\". !!! Problem with ebuild sys-devel/gcc-3.4.2-r2 !!! Possibly a DEPEND/*DEPEND problem. 这表示您正尝试安装的应用程序依赖于您的系统不可用的另外一些软件包。请到bugzilla查看是否有此问题的记录，如果没有查找到相关信息的话请提交一个报告。除非您的系统混用了不同分支，否则这类问题不应该发生，若发生了那就是一个bug。\n意指不明的软件包 Portage对于意指不明的Ebuild名称的警告\n[ Results for search key : listen ] [ Applications found : 2 ] * dev-tinyos/listen [ Masked ] Latest version available: 1.1.15 Latest version installed: [ Not Installed ] Size of files: 10,032 kB Homepage: http://www.tinyos.net/ Description: Raw listen for TinyOS License: BSD * media-sound/listen [ Masked ] Latest version available: 0.6.3 Latest version installed: [ Not Installed ] Size of files: 859 kB Homepage: http://www.listen-project.org Description: A Music player and management for GNOME License: GPL-2 !!! The short ebuild name \"listen\" is ambiguous. Please specify !!! one of the above fully-qualified ebuild names instead. 您要安装的应用程序对应有多个同名的包。您需要同时指定类别的名称。Portage会列出所有可供选择的名称匹配的包。\n循环依赖 Portage关于循环依赖问题的警告\n!!! Error: circular dependencies: ebuild / net-print/cups-1.1.15-r2 depends on ebuild / app-text/ghostscript-7.05.3-r1 ebuild / app-text/ghostscript-7.05.3-r1 depends on ebuild / net-print/cups-1.1.15-r2 两个（或多个）您想安装的包由于循环依赖而不能安装。这很可能源于Portage树中的bug。请等一段时间后重新sync再尝试安装。您也可以去 Bugzilla 看看是否已经有此问题的报告，或者提交一个关于它的报告。\n当然，最后它也会有类似如下提示的解决方案\nIt might be possible to break this cycle by applying the following change: 下载失败 Portage关于下载失败的警告\n!!! Fetch failed for sys-libs/ncurses-5.4-r5, continuing... (...) !!! Some fetch errors were encountered. Please see above for details. 当Portage下载指定软件的源代码失败时，它会尝试继续安装其它（若适用）的应用程序。源代码下载失败可能源于镜像服务器没有正确同步，也可能因为ebuild文件给出了错误的下载地址。那些保存源代码的服务器也可能因为某些原因宕机。\n一小时后重试一次，看看问题是否仍然存在。\n系统Profile保护 Portage关于profile中保护的包的警告\n!!! Trying to unmerge package(s) in system profile. 'sys-apps/portage' !!! This could be damaging to your system. 您要求移除系统核心软件包中的一个。它是您的profile中所列出的必需的软件，因此不能从系统中移除。\nDigest验证失败 Digest验证失败\n checking ebuild checksums !!! Digest verification failed: 这是Portage树中出现了错误的迹象，通常是由于将ebuild提交到Gentoo ebuild存储库时出错造成的。\n当digest校验失败的时候，请不要尝试自己去为此软件包重新产生digest。使用ebuild foo manifest 并不能修复问题，反而很可能会使问题变得更糟。\n取而代之的应该是等待一至两个小时以便让软件仓库安定下来。一般来说错误很有可能马上就会被注意到，但是修复程序可能需要一点时间来逐步扫描rsync镜像。当您等待的时候，到Bugzilla或者#gentoo (webchat) (IRC)看看是否已经有人报告了这个问题。如果没有，那就为那个损坏的ebuild提交一个bug报告吧。\n修复错误后，重新同步Gentoo ebuild仓库以获取修复的digest。\n重要：值得注意的是：不要每天多次同步Gentoo ebuild repository 仓库。正如（当您运行emerge –sync时）Gentoo官方网络礼节策略所指出的那样，那些短时间内过于频繁进行多次sync的用户将会被更新服务器软封禁一段时间，一再不遵守这一政策的滥用者可能会被硬封禁。除非绝对必要，否则通常最好等待24小时再进行同步，因为这样您不会使Gentoo的rsync镜像服务器过载而影响其他用户的正常使用。\n其他工具 单纯 Portage 自带的工具对于日常管理其会显得有些吃力，这里推荐几个比较有用的软件用于辅助管理 Portage。\napp-portage/eix 这个可以说是非常有用的软件，主要用于查询 Portage 数据库，其优势在于更快的速度、更人性化的显示格式以及更方便的查询模式。\n使用前需执行 eix-update 以更新 eix 数据库，安装它之后，可以使用 eix-sync 命令来更新 Portage 数据库，更新完毕后会自动更新 eix 数据库，并显示更新前后的软件包对比情况。\n使用 eix 查询所需软件，最基本的命令为\n# eix  也可只查询已安装的包\n# eix -I  也可查询属于一个特定分类下的所有包\n# eix -C  等等，执行 man eix 查看更多用法。\napp-portage/gentoolkit 包含了 Gentoo 的一些管理脚本，常用的命令有用于查询依赖关系，文件归属，软件包内容的 equery ，以及用于清理 distfile 的 eclean-dist 。比如\n可以查询依赖 vim-core 的软件包（仅根据 ebuild 文件内容查询）\n# equery d vim-core 可以查询 vim 下属的依赖关系图\n# equery g vim 可以查询 vim 安装了哪些文件到系统下\n# equery f vim 可以查询这个文件属于哪个包\n# equery b /usr/bin/vim eclean eclean 是一个清理仓库源文件和二进制包的工具。它是 app-portage/gentoolkit 包的一部分，并由 Portage-Tools 项目维护。\n安装\n安装 eclean：\n# emerge --ask app-portage/gentoolkit 附注：关于 app-portage/gentoolkit 包中其他工具的信息请参看 Gentoolkit article。\n使用\n默认情况下，源文件存储在 /var/db/repos/gentoo/distfiles 目录下， 二进制包存储在 /var/db/repos/gentoo/packages 目录下；可以通过修改 /etc/portage/make.conf 中的 DISTDIR 和 PKGDIR 变量更改对应的存储位置。如果不定期清理，这两个目录可能会悄然无声地变得非常巨大；这就是创建eclean的原因。\n使用 eclean –help 来查看全部的命令简介、参数列表和使用介绍：\n# eclean --help 通过 distfiles 参数清理源文件存放目录：\n# eclean distfiles 或者使用更简短的命令：\n# eclean-dist 使用下面的命令清理二进制包：\n# eclean packages 或者使用更简短的命令：\n# eclean-pkg 选项\n默认情况下，当前存储库中的任何ebuild相对应的源文件和二进制包都不会被删除。这样，只要程序包仍在当前存储库树中，系统管理员就可以轻松地降级程序包或安装以前删除的程序包。\n举个例子，比如包 foo-1.0 和 foo-1.1 都在存储库中。在从 foo-1.0 升级到 foo-1.1 之后，运行 elcean distfiles，两个版本的源文件依然被保留，因此如果 foo-1.1 出现问题，用户可以很方便的重新安装 foo-1.0，而不必重新下载。\n另一个可能的情况是安装之前删除的包。假设系统安装了 foo 包（任一版本）。在（不经意地）删除了这个包并运行了 eclean disfiles 之后，foo 的源文件依然被保留，可以重新安装而无需再次下载。\n对二进制包同样的例子也一样适用。\n为节省更多磁盘空间，请添加--deep选项：这将删除与某些当前安装的软件包（版本无关紧要）不对应的每个源文件或二进制软件包。请注意，这种方式当用户需要降级安装某个包或者重新安装之前删除的包的时候都必须重新下载。\n# eclean --deep distfiles # eclean --deep packages 一个替代方案是，同时使用 --deep 和 --package-names 选项：对于某些非当前安装的包（不管版本号是什么）的每个源文件或者二进制包都会被删除。这种方式当用户需重新安装之前删除的包的时候都必须重新下载，但是要降级安装某个包则不需要。\n更多细节请参阅 eclean(1) man page：\n# man 1 eclean app-portage/portage-utils 包含了 Portage 的帮助工具，与上面 gentoolkit 的功能有重合，他们具有互补性，常用的命令有用于分析 emerge 日志的 qlop 。它是用 C 写的，速度更快。\napp-portage/pfl Portage File List，可用于在线查询文件所归属的包，命令为 e-file  。\n多版本管理 Gentoo Linux 支持同一软件多版本同时存在于系统上，这归功于 Portage 系统的 slotting 机制。当你执行命令 eix dev-lang/python 会发现它有好多行可用版本，最前圆括号内的内容即对应的 slot 名，不同 slot 下的版本可同时安装到系统上（ slot 名内 / 符号后的内容表示其 sub-slot，同 slot 但不同 sub-slot 的版本无法共存）。比如，sys-devel/gcc , sys-devel/clang , dev-lang/lua 等等都支持多版本共存。\n对于一些多版本共存的工具， Gentoo Linux 准备了对应的 eselect 命令以方便用户选择使用。其会在对应的 $PATH 目录下创建一个指向当前选定版本命令的软链接。比如，列出当前所有已经安装的 lua 版本\n# eselect lua list 设定了系统下用户交互环境的默认 lua 版本\n# eselect lua set {序号} 其它的类似，执行 eselect help 以查看当前所有支持的模块。不是所有的多版本共存的包都会有 eselect 模块，它们并不存在强制的依赖关系。执行 eix -I2 可以显示当前系统下安装的可多版本共存的包。\n为 Portage 包管理器设置代理 开门见山，本文介绍在 Gentoo Linux 下如何正确地对其包管理器 Portage 设置代理，即日常使用的 emerge 命令。这里介绍软件下载安装时需要的配置；对于同步 Portage 树，则是部分适用。\nGentoo 的默认设置  代理： 无 工具： 默认使用 wget 作为下载工具，但对于绝大部分的 live 包，会有针对的 eclass 使用对应的版本控制工具从远程仓库抓取，这里仅以 git 为例。  live 包：即版本号带 9999* 的这些包；用于匹配 live ebuild 文件名的正则表达式为 9999*(-r[0-9]{1,3})?.ebuild$ ，可还是有一些包使用了这种版本命名规则却并非真正的 live 包，比如 openjfx/openjfx-8.999.ebuild ；这里不会通过版本号来判断是否需要配置 git 参数，所以并不影响，仅作介绍。\n持久性地修改代理 通用配置 $ man make.conf 可以看到里面有说明如何配置代理，但是过于简要，这边详细说明。\n对于一般情况，在 /etc/portage/make.conf 文件下配置如下三个变量，就完全足够：\nhttp_proxy=\"[protocol://][user[:password]@]proxyhost[:port]\" https_proxy=\"[protocol://][user[:password]@]proxyhost[:port]\" ftp_proxy=\"[protocol://][user[:password]@]proxyhost[:port]\" 这些变量会在 emerge 命令运行时，传递给预配置的 FETCHCOMMAND 即 wget 命令。但，该命令有一个问题是不支持 socks 协议；所以，对于不同的协议需要有不同的代理服务，这样子很麻烦。\n修改以支持 socks 协议有一个应变的方法，即修改默认的获取命令为 curl ，同样是在 /etc/portage/make.conf 文件下配置变量，如下：\nFETCHCOMMAND=\"curl --retry 3 --connect-timeout 60 --ftp-pasv -Lfo \\\"\\${DISTDIR}/\\${FILE}\\\" \\\"\\${URI}\\\"\" RESUMECOMMAND=\"curl -C - --retry 3 --connect-timeout 60 --ftp-pasv -Lfo \\\"\\${DISTDIR}/\\${FILE}\\\" \\\"\\${URI}\\\"\" 其中 RESUMECOMMAND 是用于恢复意外中断的下载命令，保存后即完成修改，此时，就可以给不同协议配置同样的 socks 类协议的代理服务，均可生效。如：\nhttps_proxy=\"socks5h://127.0.0.1:1080\" 单独配置 git 抓取 对于 live 包，它们目前大多数直接使用 git 命令从远程仓库抓取。其它版本控制工具（目前支持的大致有 bzr, cvs, darcs, mercurial, subversion）同理，请自行修改后套用；当然也有直接使用 wget|curl 下载 live 包的情况，那么这种情况如上「一」述。\ngit 命令支持 socks 协议，并且除了能吃上述配置的环境变量外，\n配置 https_proxy 时也配好 http_proxy ，否则可能出现 SSL_ERROR_SYSCALL 错误。\n还能独立于其它包单独配置 git 自身的代理，方法有两种：\n  git 能配置针对整个 Linux 系统的参数，运行：\n$ git config --system http.proxy '[protocol://][user[:password]@]proxyhost[:port]' 此命令会将配置写入到 /etc/gitconfig 文件内，并生效于系统级别，会被用户/项目级别的配置覆盖。\n  通过 Portage 的全局 bashrc 文件 /etc/portage/bashrc 来配置临时的 git 代理\n这种方式会对系统配置造成最少的干扰，只略微繁琐一点，需要将下述脚本代码写入上述的 bashrc 文件内：\nif [[ ${EBUILD_PHASE} == \"unpack\" \u0026\u0026 ${INHERITED} =~ git\\-r3 ]]; then git config --global http.proxy '[protocol://][user[:password]@]proxyhost[:port]' fi 这个 bashrc 只被 Portage 引用，会在进入每一个安装阶段时被导入。目前，Portage 下抓取 git 项目是通过 git-r3.eclass 实现，该 eclass 定义了 git 项目是在 src_unpack 阶段被更新，所以这里只需要在此阶段时设置即可。且，因为该目录不是被抓取包的 git 目录，所以只能设置用户级别的配置以生效，配置文件会被存放于 Portage 安装过程中沙盒的家目录下，即对应 安装软件临时目录 （这个目录是 Portage 在编译/安装软件过程中临时建立的，会在成功安装软件后被删除，所以不用担心会有文件残留。具体位置是可以自定义的，详情看 make.conf(5) 手册下 PORTAGE_TMPDIR 条目）下的 homedir/ 目录。\n  临时添加代理 对于需要临时添加代理以使用的情况，目前我知道两种方式：\n推荐：ProxyChains ProxyChains is a UNIX program, that hooks network-related libc functions in dynamically linked programs via a preloaded DLL and redirects the connections through SOCKS4a/5 or HTTP proxies.\n使用 net-misc/proxychains 软件适用所有下载方式。\n配置文件可以放在 ~/.proxychains/proxychains.conf，也可以放在 /etc/proxychains.conf，但是放在 etc 下更好，因为有时候要通过sudo安装软件。\n# emerge net-misc/proxychains # vi /etc/proxychains.conf ... socks5 127.0.0.1 7891 配置好代理列表后，通过如下命令使用：\n# proxychains -q emerge [...] 临时指定环境变量 {ftp,http,https}_proxy 的方式，适用性同持久性配置。\n即如下命令：\n# export http_proxy=\"...\" https_... # emerge [...] 或\n# http_proxy=\"...\" https_... emerge [...] Project:Portage/Sync The new plug-in sync system is the next step in that migration. Using PORTDIR and PORTDIR_OVERLAY in make.conf could only list where the repository was location. Users could not specify other important attributes about that repository. The repos.conf style configuration allows for settings to be added on a per sync-type basis. Along with this new expandability and the plug-in sync system, it will be much easier to change to new repository syncing methods.\nGeneral help Note: While Portage can handle repos.conf as either a file or a directory of files. The preferred method is to be used as a directory. Other tools like layman and mirrorselect require and expect it to be a directory. Layman creates and manages its own layman.conf file to register installed overlays with Portage. mirrorselect looks for repos.conf/gentoo.conf file in order to modify the sync-uri parameter for the gentoo repository.\nMigration Portage configuration\nIf the /etc/portage/repos.conf directory does not exist:\n# mkdir /etc/portage/repos.conf # cp /usr/share/portage/config/repos.conf /etc/portage/repos.conf/gentoo.conf Then edit the file for your installation and desired settings, continue as needed with the remaining migration instructions. Edit all repos.conf/*.conf files, add the auto-sync option to each defined repository.\nFor sync-type, edit it to one of the installed supported types.\nCurrent supported sync types include:\n rsync git svn webrsync or websync (equivalent to running emerge-webrsync separately). cvs laymansync (if installed by Layman)  Example local overlay sync-able from a git backup:\n# nano -w /etc/portage/repos.conf/gentoo.conf [DEFAULT] main-repo = gentoo [gentoo] location = /var/db/repos/gentoo sync-type = git sync-uri = https://github.com/gentoo-mirror/gentoo.git auto-sync = yes priority = 1000 The above overlay can be synced with\n# emaint sync -r gentoo Operation Primary control of all sync operations has been moved from emerge to emaint. emerge –sync now runs the emaint sync module with the --auto option. This --auto option performs a sync on only those repositories with the auto-sync setting set to yes or true. If the auto-sync option is not set to yes or is absent, then emerge –sync may not sync any repositories.\nNote: As a result of the default auto-sync = True/Yes setting, commands like eix-sync, esync -l, emerge –sync \u0026\u0026 layman -S will cause many repositories to be synced multiple times in a row. Please adjust configuration files or scripts as necessary for the new operation.\nWarning: Due to the above default. For any repositories (repos) that you EXPLICITLY do not want to be synced. You MUST set auto-sync = no\nExamples # emaint sync -a Equivalent to emerge –sync. Sync all repositories where auto-sync = true is set.\nNote: Due to the default auto-sync = true setting, this command will sync all repositories that do not have auto-sync = no explicitly set.\n# emaint sync -r foo Sync the foo repo (ignores auto-sync setting):\n# emaint sync --allrepos Sync all repositories with a valid sync-type and sync-url defined. (ignores auto-sync setting)\nUSE标记 什么是USE标志 USE标志的指导思想 你在安装gentoo（或者是其他发行版，甚至于其他特定操作系统）的时候，你要依据你工作的环境做出选择。服务器跟工作站的组织结构不同，游戏机跟3D工作站也会不一样。\n不单只是选择你想要安装的包时如此，选择某一个包需要的特性时同样如此。如果你不需要OpenGL，为什么还要花费时间安装OpenGL并在其他包中加入对OpenGL的支持？如果你不用KDE，而且软件包没有KDE也能完美运行，为什么还要在编译这些包的时候加入KDE支持？\n为了帮用户判断什么需要安装或激活，什么不需要；我们希望用户能用简单的方式设定他们自己的环境。这能促使用户判断他真正需要的东西，并让Portage做出有用的决定的过程变得简单。\nUSE标志的设定 我们来具体看看USE标志。每一个标志都是代表对某特定概念的支持和依赖关系信息的关键字。如果你设定了某个USE标志，Portage会明白他们需要支持所选关键字。当然这同时也改变了这个包的依赖关系信息。\n让我们看一个特殊示例：关键字 kde 。如果你的 USE 变量里面没有这个关键字，所有具有可选KDE支持的包在编译时都 不会 编译KDE支持。所有具有可选KDE依赖关系的包在安装时都 不会 （做为一个依赖关系而）安装KDE库。如果你设定了kde关键字，这些包在安装时都 会 编译KDE支持，而且KDE库也 会 （作为一个依赖关系而）被安装。\n通过正确设定关键字，你会得到一个根据你的需要而定制的系统。\n使用USE标志 声明永久USE标志 就像前面提到的，所有USE标志都声明在 USE 变量里面。为了让用户能方便地查找和选择USE标志，我们提供了一份默认的USE设定。这些设定是我们觉得Gentoo用户通常都要用到的USE标志的集合。这个默认设置在make.defaults 文件──你的profile声明。\n你的系统使用的profile是符号链接 /etc/portage/make.profile 所指向的目录。每个profile叠加于某个更大的profile之上，最终的结果是这些profile的并集。初始profile是base profile( /var/db/repos/gentoo/profiles/base)。\n要查看当前正在使用的USE标志（全部），请使用 emerge –info：\n# emerge --info | grep ^USE USE=\"a52 aac acpi alsa branding cairo cdr dbus dts ...\" 就像你看到的那样，这个变量已经包括了非常多的关键字。不要通过修改make.defaults 文件里的 USE 变量来满足你的需要：在升级Portage的时候，这个文件将会被覆盖。\n要改变这个默认设置，你需要在 USE 变量里添加或移去关键字。这是通过在/etc/portage/make.conf里定义USE全局变量来实现的。在这个变量里，添加你需要的额外的USE标志，或者移去你不需要的USE标志。后者可通过在标记前面加个负号 (-).前缀来实现。\n例如，要移除对 KDE 和 QT 的支持，并添加对 LDAP 的支持，可以在/etc/portage/make.conf里声明USE如下：\nUSE=\"-kde -qt4 -qt5 ldap\" 为单个包声明USE标志 如果你不是想为整个系统声明USE标志，而是想要为一个（或者几个）程序声明USE标志，你需要编辑/etc/portage/package.use文件。package.use 通常是一个文件，不过它也可以是一个充满子文件的目录；请看下面的提示和 man 5 portage 以获得更多如何使用这个约定的信息。下面的例子假设 package.use 是一个文件。\n比如说，如果你不想全局的启用 Blu-ray 支持，你只想把它应用到 VLC 包，你可以这样做：\n/  media-video/vlc bluray Tip：如果 package.use 是一个已经存在的“目录”（而不是一个单文件），只需简单地在 package.use/ 目录下创建文件，就可以修改软件包的本地USE标记。虽然任何文件命名规范都行，但是更明智的做法是统一命名方案。\n有一种规范是简单地使用包名作为子文件的标题。比如说，可以用如下方式为 media-video/vlc 软件包在本地设置 bluray USE 标记。\n# echo \"media-video/vlc bluray\"  /etc/portage/package.use/vlc 你当然也可以直接为某一个程序禁用USE标志。比如说，禁用PHP的bzip2支持（但通过make.conf中的USE标志为其他包提供支持）：\ndev-lang/php -bzip2 -* 代表去除该匹配的包的所有已经添加的以及默认的 USE\n=kde-apps/kde-apps-meta-21.04.3 -* admin Portage 有一个 USE Expand 功能，即把指定变量的值扩展成 USE，这些指定的变量被设置在 Portage 数据库路径下的 profiles/base/make.defaults 文件的 USE_EXPAND 变量中。这个功能很实用，简化了配置值，还能进行归类，更便于管理。上文有一个 显卡的配置 其实就是一个 USE_EXPAND 值。其它会使用到它的地方不多，但也有，比如配置全局的本地化配置，就可以在 make.conf 文件下配置\nL10N=\"zh-CN zh-TW zh en-GB-oxendict en\" 这样，那么以后当有包支持上述的本地化配置时，就会自动添加。\n其它比如可以对 qemu 这个虚拟机添加额外的模拟平台， 可以往 /etc/portage/package.use/qemu 文件写\napp-emulation/qemu QEMU_SOFTMMU_TARGETS: aarch x86_64 以支持 arm64 及 x86_64 平台。等等\n声明临时USE标志 有时，你只想暂时改变一个USE设置。你可以仅仅把USE 变量声明成一个环境变量，而不必两次修改/etc/portage/make.conf 。但是要记住，当你重新emerge或者升级这个程序的时候（不管是单独地还是作为系统升级的一部分），你的修改会被重置。\n下面的例子我们将在安装 SeaMonkey 的时候临时从 USE 变量中移去pulseaudio 值。\n# USE=\"-pulseaudio\" emerge www-client/seamonkey 优先级 当然，USE设置有一定的优先级。按优先级排序（第一优先级最低）：\n make.defaults 里面的USE默认设定 用户在/etc/portage/make.conf里面的USE默认设定 用户在 /etc/portage/package.use里面的USE默认设定 用户作为环境变量的USE设定  运行 emerge –info可以看到Portage识别的最终的USE设定。它会列出Portage使用的所有相关变量（包括 USE 变量）。\n# emerge --info 在整个系统上应用新的USE标志 如果你已经修改了你的USE标志，而且你想用新的USE标志更新你的系统，可以使用emerge的 --newuse选项：\n# emerge --update --deep --newuse @world 然后运行Portage的depclean来移除已经安装到你的\"旧\"系统里但是在新USE标志中被废除的条件依赖关系。\n警告：运行emerge –depclean是一项危险的操作，必须小心。请反复检查要删除的包的列表里确定没有你仍然需要的包。下面这个例子里，我们添加了 -p 选项──来只列出这些包而不删除他们：\n# emerge -p --depclean depclean完成之后， emerge会针对可能是已经删除的软件包提供的共享对象动态链接的应用程序提示重新构建。此操作完成前，为了防止破坏应用程序，Portage 将会保存必要的库。它存储着需要在 preserved-rebuild 设置的重建内容。若要重建必要的包，请运行：\n# emerge @preserved-rebuild 这些都完成之后，你的系统就已经应用上了新的USE标志的设定。\n软件包特有的USE标志 查看可用USE标志。\n让我们以seamonkey来作例子，看看它接收什么USE标志。我们可以以--pretend和 --verbose为选项执行 emerge来查看：\n# emerge --pretend --verbose www-client/seamonkey These are the packages that would be merged, in order: Calculating dependencies... done! [ebuild N ] www-client/seamonkey-2.48_beta1::gentoo USE=\"calendar chatzilla crypt dbus gmp-autoupdate ipc jemalloc pulseaudio roaming skia startup-notification -custom-cflags -custom-optimization -debug -gtk3 -jack -minimal (-neon) (-selinux) (-system-cairo) -system-harfbuzz -system-icu -system-jpeg -system-libevent -system-libvpx -system-sqlite {-test} -wifi\" L10N=\"-ca -cs -de -en-GB -es-AR -es-ES -fi -fr -gl -hu -it -ja -lt -nb -nl -pl -pt-PT -ru -sk -sv -tr -uk -zh-CN -zh-TW\" 216,860 KiB Total: 1 package (1 new), Size of downloads: 216,860 KiB emerge 并不是做这件事的唯一工具。事实上，我们有一个专门的包信息工具叫equery，它属于app-portage/gentoolkit。\n# emerge --ask app-portage/gentoolkit 现在以为参数执行 equery 来查看指定包的USE标志。例如：gnumeric包：\n# equery --nocolor uses =gnumeric-1.12.31 [ Legend : U - final flag setting for installation] [ : I - package is installed with flag ] [ Colors : set, unset ] * Found these USE flags for app-office/gnumeric-1.12.31: U I + + introspection : Add support for GObject based introspection - - libgda : Enable database support through gnome-extra/libgda. - - perl : Enable perl plugin loader. + + python : Enable python plugin loader. + + python_targets_python2_7 : Build with Python 2.7 满足 REQUIRED_USE 一些 ebuild 需要或禁止 USE 标志的某些组合才能正常工作。 这通过放置在 REQUIRED_USE ，用一组条件来表示。此条件确保所有功能和依赖性都已完成，并且构建将成功并按预期执行。 如果任何一个不符合，emerge 会提醒你，并要求你解决这个问题。\n下面是 REQUIRED_USE 的一个例子：\n   示例 描述     REQUIRED_USE=\"foo? ( bar )\" 如果设定 foo，则必须设定 bar。   REQUIRED_USE=\"foo? ( !bar )\" 如果设定 foo，则不得设定 bar。   `REQUIRED_USE=“foo? (    REQUIRED_USE=\"^^ ( foo bar baz )\" 必须在 foo、bar 或 baz 中设定一个。   `REQUIRED_USE=”    REQUIRED_USE=\"?? ( foo bar baz )\"     Portage功能特性 Portage特性 Portage有几个附加的特性，它们能够令您的Gentoo之旅更加愉快。这些特性中的大多数依赖于某些能够提高性能、可靠性、安全性等的软件工具。\n为了打开或者关闭某一Portage特性您需要编辑 /etc/portage/make.conf中的 FEATURES变量，这个变量包含不同的特性关键字，用空格分开。在一些情况下您可能还需要额外的安装被这个特性所依赖的工具。\n并不是所有Portage所支持的特性都在这里列出。完整的概述，请查阅make.conf手册页：\n# man make.conf 查看 FEATURES 的默认设置，运行emerge –info并且查找FEATURES变量或者用grep 显示它：\n# emerge --info | grep ^FEATURES= 分布式编译 使用distcc distcc 是一个分布式编译程序，可以把编译任务分配给同一网络中的不同机器，这些机器的配置不必完全相同。distcc客户端发送所有必须的信息给所有可利用的distcc服务器（运行distccd的机器）。这样它们每一个都能为客户端编译一部分源码。所获得的效果就是更短的编译时间。\n您可以在Gentoo Distcc文档里找到更多的关于Distcc的信息（包括如何让它在Gentoo上工作）。\n安装 distcc Distcc使用一个图形化监视器来监视您的机器发送出去的编译工作。请把 USE=gnome 或 USE=gtk放进您的USE设置中。\n# merge --ask sys-devel/distcc 激活Portage的distcc支持 将 distcc 添加到/etc/portage/make.conf中的 FEATURES 变量中。 接下来，编辑MAKEOPTS变量，并增加系统允许的并行构建的数量。 一个已知的方法是填写 -jN 其中N 是运行distccd（包括当前主机）的CPU数量+1（或者核心数+1），但这只是一个建议。\n现在运行 distcc-config并输入已有的DistCC服务器。作为一个简单例子，我们假设已有的DistCC服务器是192.168.1.102（当前主机）、192.168.1.103和192.168.1.104（两个远端服务器）：\n# distcc-config --set-hosts \"192.168.1.102 192.168.1.103 192.168.1.104\" 当然，也不要忘了运行distccd系统服务：\n# rc-update add distccd default # /etc/init.d/distccd start 缓冲编译结果 关于ccache ccache是一个快速编译器缓存。 无论何时编译应用程序，它都将缓存中间结果，以便每当重新编译相同的程序时，编译时间大大减少。 第一次运行ccache时，它会比正常编译慢得多。 但是后续的重新编译应该更快。 ccache只有在相同的应用程序将被重新编译多次（或相同应用程序的升级频繁发生）时才有用; 因此它通常只对软件开发人员有用。\n如果您对ccache的工作机制有兴趣，请访问homepage主页.\n警告：已知ccache会导致大量的编译失败。 有时ccache会保留旧代码对象或损坏的文件，这可能导致无法破损的源码。 如果发生这种情况（例如\"File not recognized: File truncated\"出现在构建日志中），请尝试重新编译ccache导致错误的应用程序 。添加FEATURES=\"-ccache\" 到/etc/portage/make.conf或者\n# FEATURES=\"-ccache\" emerge  安装 ccache 要安装ccache，只需要：\n# emerge --ask dev-util/ccache 激活Portage ccache 支持 打开 /etc/portage/make.conf并添加ccache到FEATURES变量:\nFEATURES=\"ccache\" CCACHE_SIZE=\"2G\" 要检查ccache是否运行，只需让它提供给您它的统计数据。因为Portage使用一个不同的ccache主目录，您需要设定CCACHE_DIR变量：\n# CCACHE_DIR=\"/var/tmp/ccache\" ccache -s /var/tmp/ccache/是Portage的默认ccache主目录；为了修改这个设置，您可以设定/etc/portage/make.conf中的CCACHE_DIR参数。\n不过，如果您运行 ccache ，它使用的默认目录是${HOME}/.ccache/。这就是为什么当您查询（Portage）ccache统计数据的时候您需要设定 CCACHE_DIR参数的原因。\n非Portage编译中使用ccache 如果您需要在非Portage编译中使用ccache，添加 /usr/lib/ccache/bin/到您 PATH参数里靠前的位置（在/usr/bin之前）。这一点可以通过编辑在您用户主目录中的~/.bash_profile文件来实现。使用~/.bash_profile是定义 PATH参数的一个方式\nPATH=\"/usr/lib/ccache/bin:${PATH}\" 二进制包支持 创建预编译包 Portage 也支持安装预编译软件包。尽管 Gentoo 本身并不提供预编译包，但 Portage 依然能够处理预编译包。\n如果某个包已经被安装在您的系统上，您可以用 quickpkg 来创建预编译包。也可以用带有 --buildpkg 或 --buildpkgonly 选项的 emerge 命令。\n如果您希望 Portage 为您所安装的每一个软件包创建预编译软件包，那么请在 FEATURES 中添加 buildpkg 变量。\n预编译包的更多扩展支持可以用 catalyst 得到。关于catalyst的更多信息请参阅 Catalyst FAQ。\n安装预编译包 尽管Gentoo并不提供，但是您可以自己建立一个“中心仓库”来存放预编译包。如果您希望使用这个仓库，您需要设定PORTAGE_BINHOST参数使Portage能够知道它。例如，如果预编译包在 ftp://buildhost/gentoo 上：\n# nano -w /etc/portage/make.conf PORTAGE_BINHOST=\"ftp://buildhost/gentoo\" 当您需要安装预编译包的时候，在emerge命令后的 --getbinpkg选项旁加入 --usepkg 选项。前者让emerge命令从预定的服务器上下载预编译包，后者让emerge首先试图安装预编译包，如果预编译包不存在，那么才下载并编译源码。\n例如：用预编译包安装gnumeric\n# emerge --usepkg --getbinpkg gnumeric 关于emerge的预编译包的更多信息请参阅emerge手册页:\n# man emerge 将预构建的软件包分发给他人 如果预构建的软件要分发给其他人，请确保这样做是被允许的。 检查上游软件包的分发要求。 例如，对于在GNU GPL协议下发布的软件，源代码必须与二进制文件一起提供。\n如果构建的二进制程序不可分发，则Ebuild可以在其RESTRICT 变量中定义 bindist限制。 有时，此限制取决于一个或多个USE标志。\n默认情况下，Portage将不会屏蔽任何包，因为有限制。 这可以通过在/etc/portage/make.conf中设置ACCEPT_RESTRICT变量来全局更改。 例如，要掩盖具有bindist 限制的软件包，请将以下行添加到make.conf：\nACCEPT_RESTRICT=\"* -bindist\" 还可以通过将ACCEPT_RESTRICT选项用于emerge命令，来覆盖--accept-restrict 变量。 例如， --accept-restrict=-bindist将临时屏蔽带有bindist 限制的包。\n还可以考虑在分发包时设置ACCEPT_LICENSE变量。 请参阅 授权许可。\n重要：每个 用户完全有责任遵守软件许可条款和每个用户国家的法律。 ebuilds（RESTRICT或LICENSE）定义的元数据变量可以为禁止预编译文件分发提供指导。但是Portage的输出或Gentoo开发人员的回答 不是 法律声明，不应该依赖他们。 谨慎遵守您的当地的法律。\n下载文件 并行下载 Portage 通常是以root 用户运行的， FEATURES=\"userfetch\"可以让Portage在下载源码包的时候弃用 root 权限，并以 portage:portage 的用户/组权限运行。这是一个小小的安全性的提高方法。\n如果在 FEATURES 设置了 userfetch，请确保在 root 权限下，使用 chown 命令更改在 /var/db/repos/gentoo 下所有文件的所有者：\n# chown --recursive --verbose portage:portage /var/db/repos/gentoo 验证源文件 要重新验证完整性并(可能)重新下载当前所有安装的软件包以前删除或损坏的 distfiles，请运行：\n# emerge --ask --fetchonly --emptytree @world 环境变量 环境变量 简介 环境变量是一个具有特定名字的对象，它包含了一个或者多个应用程序所将使用到的信息。通过使用环境变量，你可以很容易的修改一个牵涉到一个或多个应用程序的配置信息。\n重要的例子 下表展示了一些Linux系统使用的变量并说明了它们的用处。在表格后面将列举一些变量例值。\n   Variable Description     PATH 这个变量包含了一系列由冒号分隔开的目录，系统就从这些目录里寻找可执行文件。如果你输入的可执行文件（例如 ls, rc-update或者 emerge）不在这些目录中，系统就无法执行它（除非你输入这个命令的完整路径，如/bin/ls）。   ROOTPATH 这个变量的功能和 PATH相同，但它只罗列出超级用户（root）键入命令时所需检查的目录。   LDPATH 这个变量包含了一系列用冒号隔开的目录，动态链接器将在这些目录里查找库文件。   MANPATH 这个变量包含了一系列用冒号隔开的目录，命令 man 会在这些目录里搜索man页面。   INFODIR 这个变量包含了一系列用冒号隔开的目录，命令 info 将在这些目录里搜索info页面。   PAGER 这个变量包含了浏览文件内容的程序的路径，比如(less 或者 more)   EDITOR 这个变量包含了修改文件内容的程序（文件编辑器）的路径(比如 nano 或 vi).   KDEDIRS 这个变量包含了一系列用冒号隔开的目录，里面放的是KDE相关的资料。   CONFIG_PROTECT 这个变量包含了一系列用空格隔开的目录，它们在更新的时候会被Portage保护起来。   CONFIG_PROTECT_MASK 这个变量包含了一系列用空格隔开的目录，它们在更新的时候不会被Portage保护起来。    下面你可以找到所有这些变量定义的范例：\nPATH=\"/bin:/usr/bin:/usr/local/bin:/opt/bin:/usr/games/bin\" ROOTPATH=\"/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin\" LDPATH=\"/lib:/usr/lib:/usr/local/lib:/usr/lib/gcc-lib/i686-pc-linux-gnu/3.2.3\" MANPATH=\"/usr/share/man:/usr/local/share/man\" INFODIR=\"/usr/share/info:/usr/local/share/info\" PAGER=\"/usr/bin/less\" EDITOR=\"/usr/bin/vim\" KDEDIRS=\"/usr\" CONFIG_PROTECT=\"/usr/X11R6/lib/X11/xkb /opt/tomcat/conf \\ /usr/kde/3.1/share/config /usr/share/texmf/tex/generic/config/ \\ /usr/share/texmf/tex/platex/config/ /usr/share/config\" CONFIG_PROTECT_MASK=\"/etc/gconf\" 全局变量的定义 env.d目录 Gentoo采用了/etc/env.d/目录来集中定义全局变量。在这个目录里，你会发现很多类似 00basic, 05gcc等等这样的文件，它们包含了文件名中提到的应用程序需要的变量。\n举个例子，当你安装 gcc时，一个名为 05gcc 的文件就会被ebuild所创建，里面包含了如下一些变量：\nPATH=\"/usr/i686-pc-linux-gnu/gcc-bin/3.2\" ROOTPATH=\"/usr/i686-pc-linux-gnu/gcc-bin/3.2\" MANPATH=\"/usr/share/gcc-data/i686-pc-linux-gnu/3.2/man\" INFOPATH=\"/usr/share/gcc-data/i686-pc-linux-gnu/3.2/info\" CC=\"gcc\" CXX=\"g++\" LDPATH=\"/usr/lib/gcc-lib/i686-pc-linux-gnu/3.2.3\" 其他的发行版会让你到/etc/profile或者其他地方修改和添加这些变量的定义。而Gentoo为用户（还有为Portage）提供了更加便捷的方式来维护和管理环境变量，以后你不再需要把精力放在那些众多的包含环境变量的文件身上了。\n比如，当你更新完gcc 的时候， /etc/env.d/05gcc也会被同时更新，而不需要你手工来完成。\n这不仅对Portage有益，作为用户，你也是受益者。有时候你需要设置某个系统范围的环境变量。我们拿http_proxy变量来做例子，为了避免http_proxy 搞乱，你只要新建一个文件/etc/env.d/99local然后添加你的定义：\nhttp_proxy=\"proxy.server.com:8080\" 通过使用同一个文件来定义你所有的变量，你对如何定义自己的变量有了个大概的了解。\nenv-update /etc/env.d/ 中的好几个文件都定义了PATH变量。这并没有错：当你运行env-update的时候，它会在更新环境变量之前把这些定义都追加到PATH里，因此对于软件包（或者用户）来说将会很容易地设置他们自己的环境变量，而不影响到现有变量的值。\nenv-update 脚本会根据 /etc/env.d/ 里文件的字母顺序来附加变量的值。这些文件名必须要以两位数字开头。\n00basic 99kde-env 99local +-------------+----------------+-------------+ PATH=\"/bin:/usr/bin:/usr/kde/3.2/bin:/usr/local/bin\" 变量并不总是被串联起来，只有下列变量才会被串联： ADA_INCLUDE_PATH, ADA_OBJECTS_PATH, CLASSPATH, KDEDIRS, PATH, LDPATH, MANPATH, INFODIR, INFOPATH, ROOTPATH, CONFIG_PROTECT, CONFIG_PROTECT_MASK, PRELINK_PATH, PRELINK_PATH_MASK, PKG_CONFIG_PATH,和PYTHONPATH。对于( /etc/env.d/) 里的文件中按照字母顺序排列后）其他所有变量，最新定义的值才会被使用到。\n可以通过将变量名添加到 COLON_SEPARATED or SPACE_SEPARATED （也在 /etc/env.d/ 文件）。\n当你运行 env-update的时候，它会在文件/etc/profile.env 里（会被/etc/profile使用）创建所有的环境变量。它也会从变量 LDPATH 中获取信息用来建立/etc/ld.so.conf。这些完成以后，它将运行 ldconfig来重建动态链接器需要的文件/etc/ld.so.cache。\n如果你想在运行env-update后立即看到效果，执行下面的命令来更新你的环境。自己安装过Gentoo的用户可能已经记住了这个安装指南中提到过的命令：\n# env-update \u0026\u0026 source /etc/profile 附注：上面的命令只会更新你当前终端里的环境变量、新控制台以及它们的子程序。因此，假如你正在X11里工作，你要么在每一个你打开的终端里输入source /etc/profile ，要么重新启动X，这样所有新的终端才能引用到新的变量。如果你使用了登录管理器，登陆成root然后输入 /etc/init.d/xdm 。如果不是这样，你需要注销然后重新登录回X这样才能产生使用新变量值的子程序。\n重要：你在定义其他变量时不能使用shell变量。这意味着这样的定义 FOO=\"$BAR\"（此处$BAR 是另外一个变量）是不允许的。\n本地变量的定义 特定用户 你并不是一直都想定义全局变量。比如你想把/home/my_user/bin和当前目录（你当前所在的目录）添加到PATH 变量中，但又不想让其他用户的PATH变量中也有这个。如果你想定义一个本地变量，可以使用 ~/.bashrc 或者~/.bash_profile:\nPATH=\"${PATH}:/home/my_user/bin:\" 当你重新登录的时候，你的PATH变量将被更新。\n特定会话 有时候甚至需要更加严格的定义。你可能要使用一个你临时创建的目录里面的程序，而又不想输入它的路径或者为此短时间内内修改 ~/.bashrc。\n在这种情况下，你只需要在当前会话中使用export来定义 PATH 变量。只要你不注销，PATH变量将保持这个临时的设置。\n# export PATH=\"${PATH}:/home/my_user/tmp/usr/bin\" ebuild Gentoo Development Guide Chinese Ebuild 编写基本指南 一个 ebuild 文件是一个文本文件，供 Gentoo 包管理器使用，它标识一个特定的软件包以及 Gentoo 包管理器应该如何处理它。它使用一个 bash 类似语法风格，并通过 EAPI 版本进行标准化。\nGentoo Linux 使用 ebuild 作为单个软件的包管理格式。这些 ebuild 包含相关软件的元数据（软件的名称和版本、软件使用的许可证和主页）、依赖信息（构建时和运行时依赖）以及有关如何处理的说明使用软件（配置、构建、安装、测试…）。\nGentoo 中 ebuild 的默认位置是 /var/db/repos/gentoo/，该位置由repos.conf文件确定。自定义ebuild建议放在自定义库中，比如/var/db/repos/larry。\nebuild 也是运行各种 ebuild 函数 的 Portage 命令。通过运行以下命令在本地找到相关信息：\n# man 1 ebuild # man 5 ebuild 实时 ebuild\n如果源代码是从修订控制系统 (VCS) 获取的，那么此 ebuild 就是“实时 ebuild”。它们往往（但不一定）具有版本号 9999，以便可以轻松将其与基于上游版本的普通 ebuild 区分开来。\n如果 ebuild 有一个变量 PROPERTIES，其中的值是“live”，那么它就是“实时的”。如果一个 ebuild 继承了一个 VCS eclass（例如 git-r3、mercurial、darcs），它将是实时的，因为这些 eclass 中有一行 PROPERTIES+=\"live\"。\n在 packages.gentoo.org 站点中，实时 ebuild 具有标志 L 。在 eix 的输出中，它用 *l 标记。\n如何创建一个 ebuild vim 的用户自动获取基本骨架（由 app-vim/gentoo-syntax 提供）：\n# vim ./foobar.ebuild 模板\n# Copyright 1999-2022 Gentoo Authors # Distributed under the terms of the GNU General Public License v2 EAPI=7 DESCRIPTION=\"\" HOMEPAGE=\"\" SRC_URI=\"\" LICENSE=\"\" SLOT=\"0\" KEYWORDS=\"~amd64 ~x86\" IUSE=\"\" DEPEND=\"\" RDEPEND=\"${DEPEND}\" BDEPEND=\"\" GNU Emacs 或 XEmacs 用户可以使用类似的工具（分别由 app-emacs/ebuild-mode 或 app-xemacs/ebuild-mode 提供）。\n其他编辑器的用户从 skel.ebuild 手动复制：\n# cp /var/db/repos/gentoo/skel.ebuild ./foobar.ebuild 应该知道新包的基本信息，并将其添加到 ebuild-defined variables。\n给定源压缩包示例 为 Scrub 创建一个 ebuild：\n# mkdir -p /var/db/repos/larry/app-misc/scrub # cd $_ # vim ./scrub-2.6.1.ebuild 模板\n# Copyright 1999-2022 Gentoo Authors # Distributed under the terms of the GNU General Public License v2 EAPI=7 DESCRIPTION=\"Some words here\" HOMEPAGE=\"https://github.com/chaos/scrub\" SRC_URI=\"https://github.com/chaos/scrub/releases/download/2.6.1/scrub-2.6.1.tar.gz\" LICENSE=\"GPL-2\" SLOT=\"0\" KEYWORDS=\"~amd64 ~x86\" IUSE=\"\" DEPEND=\"\" RDEPEND=\"${DEPEND}\" BDEPEND=\"\" 允许在SRC_URI中使用${PN} variable，但不建议。虽然它可能会缩小这条线，但一些 reasoning why not to use it也值得考虑。\nSRC_URI=\"https://github.com/chaos/${PN}/releases/download/${PV}/${P}.tar.gz\" 可以使用ebuild命令来测试它:\n# ebuild ./scrub-2.6.1.ebuild clean unpack 这应该下载并解压源压缩包。在极少数情况下，包应该可以工作，并且不需要在 ebuild 中进一步调整。\n打补丁 如果源代码需要打补丁，可以从 patches文章中解释的解压源代码创建补丁。\n补丁将被列在一个名为PATCHES的数组中，正如devmanual中所解释的那样。\nPATCHES=( \"${FILESDIR}\"/${P}-foo.patch \"${FILESDIR}\"/${P}-bar.patch ) src_prepare() { default ... } 初探 ebuild 2015-10-05\n无论你使用过多少/多久其他的 Linux 发行版，初次接触 Gentoo 时，极有可能会觉得它在软件包的安装方面很神奇。若要在 Gentoo 中安装一个软件包，通常要定义如何进行软件源代码包的下载、解包、打补丁、编译、安装以及合并。为了实现对软件包进行细微的定制，还需要定义一些有用的元数据（即 USE 旗标）、补丁文件以及一些操控软件包编译与安装的过程。Gentoo 是通过 GNU Bash shell 脚本来定义这一切，这种脚本就是所谓的 ebuild 文件。\nebuild 在哪里？ 我们在安装 Gentoo 时，一个必须的步骤是下载一个 Portage 树的镜像包，解包后通常安置于 /var/db/repos/gentoo 目录，之后每次执行 emerge --sync 时，便会根据官方远程网站上的 Portage 树来更新你本地的 Portage 树。\n粗枝大叶的看，Portage 树有四层结点。根结点便是 /var/db/repos/gentoo 目录，第 2 层结点是软件包所属分类目录，第 3 层结点是软件包的名称目录，叶子结点则是 ebuild 文件以及其他辅助性文件或目录。以 gnome-shell-3.12.2.ebuild 文件为例，它在 Portage 树中的完整路径是 /var/db/repos/gentoo/gnome-base/gnome-shell/gnome-shell-41.1.ebuild。\n对于我们期望的软件包，如果 Portage 树未提供针对它的 ebuild 文件，那么我们需要自己动手丰衣足食。一般是不建议将我们所写的 ebuild 文件放在 Portage 树中的，因为它们可能会在 emerge --sync 期间被冲刷（比如被官方的同名文件替换）。\nPortage 树支持一种被称为 Overlay 的技术。简单来说，就是我们可以另行建立一棵新的 Portage 树，这棵树的规模虽然比官方的 Portage 树小很多，但是 Portage 树的管理系统可以将这可新的 Portage 树与官方 Portage 树『合并』。如果新的 Portage 树中某些结点与官方的 Portage 树存在重叠，那么 Portage 树的管理系统会以前者覆盖后者，因此我们新建的 Portage 树通常被直呼为『Overlay』。\n建立自己的 Overlay 在 /var/db/repos/ 目录中创建自己的 Overlay：\n# mkdir -p /var/db/repos/localrepo/{metadata,profiles} # chown -R portage:portage /var/db/repos/localrepo 在该 /var/db/repos/localrepo/profiles/ 内添加 repo_name 文件。我们可以在这份文件中设置 Overlay 名称，只需将 Overlay 名称写入该文件即可。例如，我将我的 Overlay 命名为 localrepo：\n# echo 'localrepo'  /var/db/repos/localrepo/profiles/repo_name 为了让我们的 Overlay 能够被 Portage 管理系统所接受，需要在 /var/db/repos/localrepo/metadata/layout.conf 内添加：\nmasters = gentoo auto-sync = false 需要将 Overlay 路径告知 Portage 管理系统，即在 /etc/portage/repos.conf/localrepo.conf 文件中添加以下代码：\n[localrepo] location = /var/db/repos/localrepo 今后，就在这个 Overlay 中学习 ebuild 文件的编写。\nHello World! 下面通过写一个非常简单的 ebuild 文件来获取一些直观的认识。假设在 app-misc 这个分类中有一个名为 hello-world 的软件包，现在我们要为这个软件包的 1.0 版的安装写一份 ebuild 文件。\n 注意：软件包的分类名并不是随意的，它必须要与 /var/db/repos/gentoo 中的某个子目录名一致。\n 首先在 Overlay 中建立软件包所在的分支：\n# mkdir -p /var/db/repos/localrepo/app-misc/hello-world 可从 /var/db/repos/gentoo/header.txt 文件中获得 ebuild 文件默认的文件头，即：\n# Copyright 2021 Gentoo Authors # Distributed under the terms of the GNU General Public License v2 只不过是一些 Bash 脚本注释形式的文件描述信息而已，但它们是必须的。可以直接将 /var/db/repos/gentoo/header.txt 文件复制为 hello-world-1.0.ebuild 文件，这样便可获得一个含有上述内容的空 ebuild 文件。ebuild 文件的名称必须符合 Portage 所认可的格式，即：软件包名称-版本号.ebuild。这一点很重要。\n# cp /var/db/repos/gentoo/header.txt /var/db/repos/localrepo/app-misc/hello-world/hello-world-1.0.ebuild 下面，为这份 ebuild 文件增加以下内容：\nSLOT=\"0\" 这样，我们便建立了一份最为简单的 ebuild 文件。接下来就是在这份文件上签个字……也就是为之生成一份签名文件，表示这个 ebuild 的是我们做的，出了事我们负责。\n# cd /var/db/repos/localrepo/app-misc/hello-world # ebuild ./hello-world-1.0.ebuild manifest 若签名成功，会在 ebuild 文件同一目录中生成一份名为 Manifest 的文件。将来发布这份 ebuild 文件时，需要将数字签名文件一起发出，这样他人便可以验证这份 ebuild 是不是我们做的。因为非常有可能我们在向朋友们发送 ebuild 文件的过程中会被坏人拦截，然后篡改 ebuild 文件。由于 ebuild 是可被系统执行的脚本，因此很有可能变成『病毒』。因此，ebuild 文件的数字签名非常有必要。不过，这里为了简单起见，没有涉及如何用自己的密钥实现对 ebuild 的签名，所得 Manifest 文件仅仅是为了让 ebuild 能够被 Portage 管理系统所认可。\n下面，继续向这份 ebuild 加入一些内容，使之变为：\n# Copyright 2021 Gentoo Authors # Distributed under the terms of the GNU General Public License v2 EAPI=\"7\" SLOT=\"0\" DESCRIPTION=\"A classical example to use when starting on something new.\" HOMEPAGE=\"http://wiki.gentoo.org/index.php?title=Basic_guide_to_write_Gentoo_Ebuilds\" LICENSE=\"MIT\" KEYWORDS=\"~alpha ~amd64 ~arm ~hppa ~ia64 ~ppc ~ppc64 ~s390 ~sh ~sparc ~x86\" 基本上就是在原来那份最简单的 ebuild 文件的基础上增加了几个变量：\n EAPI：Portage 系统已经为我们编写了许多有用的 Bash 函数，将 EAPI 的值设为 7 表示我们要用目前最新的 Bash 函数。这个变量必须要在 ebuild 文件头之后进行设定。 DESCRIPTION：这个变量存储了 hello-world 这个软件包的简介信息。 HOMEPAGE：定义了 hello-world 这个软件包的项目主页。 LICENSE：定义了 hello-world 这个软件包所使用的许可证，例如 LGPL，GPL V2，GPL V3，MIT 等。 KEYWORDS：如果你期望 hello-world 这个软件包能够安装在你的机器上，那么 KEYWORDS 变量的值必须要包含你在 /etc/make.conf 中所设定的 ACCEPT_KEYWORDS 值。  一旦改动了 ebuild 文件内容，那么必须重新生成 Manifest 文件：\n# ebuild ./hello-world-1.0.ebuild manifest 现在，便可以使用 emerge 命令安装这个目前依然是子虚乌有的软件包了。\n# emerge -a hello-world These are the packages that would be merged, in order: Calculating dependencies... done! [ebuild N ~] app-misc/hello-world-1.0::localrepo 0 KiB Total: 1 package (1 new), Size of downloads: 0 KiB 虽然到现在为止，还是什么也没有做出来，但是看着 emerge 神奇的发现了我写的 ebuild，心底还是蔓生了一些幸福。\nemerge 与 ebuild 有什么联系？ 简单的说，就是 emerge 这个 Python 脚本会调用 ebuild.sh 这个 Bash 脚本，让后者去执行 ebuild 文件定义的软件包的下载、编译及安装过程。\nebuild.sh 所操控的软件包安装过程是在一个沙箱（Sandbox）中进行的。这一过程结束后，emerge 脚本需要将沙箱中的成果转移到真实世界，即 / 目录。\nSLOT SLOT, 即「槽」, 和具体某个包相关的概念, 是Gentoo实现多版本共存的基础。\n0 是默认的slot名, 表示没有使用slot;\nslot名是空字符串表示彻底禁止使用slot;\n带有slot的包, 包名后面会有:冒号分隔, 并带上slot, 如:\ndev-python/dnspython-1.12.0-r200:py2 dev-python/dnspython-1.12.0-r300:py3 表示dnspython这个包分别有py2和py3两个slot。\n相关的一些命令:\neix 可以直接查看包的所有slot:\n$ eix dnspython * dev-python/dnspython Available versions: (py2) 1.12.0-r200 (py3) 1.12.0-r300 {examples test PYTHON_TARGETS=\"python2_7 python3_3 python3_4\"} Homepage: http://www.dnspython.org/ https://pypi.python.org/pypi/dnspython Description: DNS toolkit for Python equery list -p:\n$ equery l -po dnspython * Searching for dnspython ... [-P-] [ ] dev-python/dnspython-1.12.0-r200:py2 [-P-] [ ] dev-python/dnspython-1.12.0-r300:py3 [-P-] [ ~] dev-python/dnspython-1.12.0-r301:py3 equery keywords:\n$ equery keywords dnspython Keywords for dev-python/dnspython: | | u | | a a a n p r s | n | | l m r h i m m i p i s p | u s | r | p d a m p a 6 i o p c s 3 a x | s l | e | h 6 r 6 p 6 8 p s p 6 c 9 s r 8 | e o | p | a 4 m 4 a 4 k s 2 c 4 v 0 h c 6 | d t | o ------------+---------------------------------+-------+------- 1.12.0-r200 | + + + ~ + + o o o + + o ~ ~ + + | o py2 | gentoo ------------+---------------------------------+-------+------- 1.12.0-r300 | + + + ~ + + o o o + + o ~ ~ + + | o py3 | gentoo 1.12.0-r301 | ~ ~ ~ ~ ~ ~ o o o ~ ~ o ~ ~ ~ ~ | o | gentoo 真实的 Hello World！ 在一个遥远的地方，真的存在着 hello-world 的源码包。我们只要通过 ebuild 文件将这个源码包的位置告诉 ebuild.sh 脚本，ebuild.sh 便会不远万里将其擒来。所以，我们需要在 hello-world-1.0.ebuild 文件中添加以下内容：\nSRC_URI=\"https://gitlab.com/alogim/gentoo-basic-ebuild/-/raw/master/update1/hello-world-1.0.tar.gz?inline=false\" SRC_URI 这个变量便是存储源码包的下载地址的。\n在重新生成 Manifest 时，ebuild.sh 便会自动将源码包下载到 /var/cache/distfiles/ 目录，并为这个源码包也生成一个数字签名存储在 Manifest 文件中。\n既然有了 hello-world 的源码包，那么下一步就该思考如何在 ebuild 文件中定义这个源码包的编译过程了。不过，解开刚才下载的 hello-world-1.0.tar.gz 包看一下，发现包里只有一份 Bash 脚本 hello-world，其内容为：\n#!/bin/sh  echo \"Hello world!\" 所以，这个源码包就没必要编译了，直接安装到系统中即可。从而，我们在 ebuild 文件中获得了第一次编写 ebuild 函数的机会。在现有的 hello-world-1.0.ebuile 的文件中继续添加以下内容：\nsrc_install() { dobin hello-world } src_install 是 ebuild.sh 脚本能够识别并执行的函数名。也就是说，从 ebuild.sh 脚本的角度来看，你若想让我替你将软件包安装至系统中，那么你必须得按照我的习惯来。我的习惯就是在你提供给我的 ebuild 文件中寻找 src_install 这个函数，如果有这个函数，我就执行它，否则我就什么也不做。这就是 ebuild.sh 与 ebuild 文件之间达成的一个约定。\n现在我们在 ebuild 文件中向 ebuild.sh 提供了 src_install 这个函数。这个函数只包含一条命令：dobin hello-world 。这个命令的意思是为 hello-world 这个脚本设置可执行权限，然后将其安装至系统默认的可执行文件目录中，即 /usr/bin 目录。\nsrc_install 只是 ebuild.sh 与 ebuild 文件之间众多约定函数中的一个而已，并且这些约定函数是顺次被 ebuild.sh 执行的，如下图所示：\n这里存在一个问题，hello-world 这个 Bash 脚本是包含在 hello-world-1.0.tar.gz 这个包内的，而我们只在 hello-world-1.0.ebuild 文件中定义了 src_install 函数，那么 hello-world-1.0.tar.gz 何时被解包的呢？这个问题的答案是，Portage 管理系统中已经为这些约定的函数定义了默认行为。比如，用于为源码包解包的 src_unpack 函数，其默认的定义是：\nsrc_unpack() { if [ \"${A}\" != \"\" ]; then unpack ${A} fi } 如果在 ebuild 文件中没有重新定义 src_unpack 函数，那么 ebuild.sh 便会按照上面图示的管线调用默认的 src_unpack 函数。所以 hello-world 脚本得以从 hello-world-1.0.tar.gz 中解出。\n对现在的 hello-world-1.0.ebuild 再次生成 Manifest，然后就可以用它将 hello-world 脚本安装至 /usr/bin 目录中了。\n这就是我们用自己写的 ebuild 安装的第一个『软件包』。\nebuild repository An ebuild repository, colloquially known as an overlay, is a structure of directories and files used to add and extend software packages for a Gentoo-based system.\nEbuild repositories contain ebuilds, eclasses, and other types of descriptive metadata files. These files inform the package manager of software available for installation, news items, and profile targets. An ebuild repository should conform to one or more Ebuild APIs as detailed in Gentoo’s Package Manager Specification.\nThe Gentoo ebuild repository, as Gentoo’s primary and “official” repository, is the source for all the information needed to build and install Gentoo packages, contained in ebuilds.\nAdministrators of Gentoo systems can add additional ebuild repositories by using various utilities and methods described below.\nThe Gentoo ebuild repository The Gentoo ebuild repository will sometimes be called by shorter, or even colloquial, names, such as the Gentoo repository, the Gentoo repo, ::gentoo, gentoo.git, or occasionally just the “repo”. It was historically known within the Gentoo community as the Portage tree, rsync tree, or sometimes just “the tree”.\nRepositories in general Repositories are handled through /etc/portage/repos.conf (which, like many other Portage configuration locations, can be a file or a directory), and the eselect repository is is a tool to manage this configuration.\nRepository definitions inside /etc/portage/repos.conf also inform Portage if and how the repository can be updated. With it, calling emaint sync –auto will automatically update the enabled repositories as well.\nA deprecated, yet still supported method is to use the PORTDIR_OVERLAY variable inside /etc/portage/make.conf. This variable can point to one or more additional locations on the file system where additional repositories are available. The use of the /etc/portage/repos.conf/ directory is highly preferred.\nFor more information, see /etc/portage/repos.conf and the Portage/Sync article.\nPriorities Ebuilds from repositories with higher priority numbers (for example 60) will take precedence over ebuilds from repositories with lower priorities (such as 50).\nThe list of ebuild repositories with their priorities can be obtained through the output of the following commands (look for the “Repositories” string):\n# emerge --info --verbose # portageq repos_config / The Gentoo ebuild repository will have a priority of -1000 which means that all other repositories generally take precedence if they are assigned a higher priority. This is the default behaviour, because ebuild repositories are designed to “lay over” or “on top” of the Gentoo repository. To set the priority of other repositories, manually edit the relevant repos.conf section and set priority = to the desired value. For example:\n# nano -w /etc/portage/repos.conf/eselect-repo.conf [guru] location = /var/db/repos/guru sync-type = git sync-uri = https://github.com/gentoo-mirror/guru.git priority = 100 Repositories that do not have a priority set default to 0.\nRepository synchronization Repository synchronization is generally managed with the emaint sync command. See the Portage sync article, and man emaint for information on how to use the portage synchronization commands.\nThe emerge –sync command is now only a compatibility command, calling the emaint module. eix-sync is a wrapper using emerge –sync, followed by eix-update. For further details see the Eix article and man eix.\nThe emerge-webrsync tool can be used to download and install the daily Gentoo Repository snapshot. This may help with firewall restrictions.\nRepository management tools eselect-repository eselect repository maintains /etc/portage/repos.conf entries for Portage to access and synchronize.\nLayman eselect repository supersedes layman for most uses.\nUsage Emerging a duplicate package When working with ebuild repositories it is possible to encounter a situation where multiple versions of the same package are available from different ebuild repositories. Instruct Portage to install a specific package from a specific ebuild repository with the :: version specifier:\n# emerge --ask category/atom::repository-name The same notation can be used for different emerge instructions, including uninstalling a package through --depclean.\nBest practices Cache generation When large ebuild repositories are installed, Portage may take a long time to perform operations like dependency resolution. This is because ebuild repositories do not usually contain a metadata cache.\nGenerate a local metadata cache by running emerge –regen after syncing the ebuild repositories:\n# emaint sync --allrepos # ( ulimit -n 4096 \u0026\u0026 emerge --regen ) Be careful, because emerge –regen takes a lot of time and it’s not recommended for rsync users as rsync updates the cache using server-side caches (most of users of portage are rsync users). Rsync users should simply run emerge –sync (or eix-sync) to regenerate the cache. It’s probably only users of very large ebuild repositories should try emerge –regen.\nMasking enabled ebuild repositories When using large ebuild repositories or those with unknown/low quality code, it is best practice to hard mask the whole ebuild repository and only accept specific ebuilds on a case-by-case basis. For example, for an overlay named “repository-foobar”:\n# nano -w /etc/portage/package.mask/repository-foobar */*::repository-foobar Then add the specific package(s) from the repository-foobar overlay so that they will be available visible to Portage for installation:\n# nano -w /etc/portage/package.unmask/bar foo-category/bar::repository-name After the above unmask the package named “foo-category/bar” should be available and none of the other packages from the repository-foobar overlay will be available, which is by design.\nZFS_FreeBSD Handbook  Z 檔案系統 或 ZFS 是設計來克服許多在以往設計中發現的主要問題的一個先進的檔案系統。\n最初由 Sun™ 所開發，後來的開放源始碼 ZFS 開發已移到 OpenZFS 計劃。\nZFS 的設計目標主要有三個：\n 資料完整性：所有資料都會有一個資料的校驗碼 (checksum)，資料寫入時會計算校驗碼然後一併寫入，往後讀取資料時會再計算一次校驗碼，若校驗碼與當初寫入時不相符，便可偵測到資料錯誤，此時若有可用的資料備援 (Data redundancy)，ZFS 會嘗試自動修正錯誤。 儲存池：實體的儲存裝置都會先被加入到一個儲存池 (Pool)，這個共用的儲存池可用來配置儲存空間，儲存池的空間可被所有的檔案系統使用且透過加入新的儲存裝置來增加空間。 效能：提供多個快取機制來增加效能。先進、以記憶體為基礎的讀取快取可使用 ARC。第二層以磁碟為基礎的讀取快取可使用 L2ARC，以磁碟為基礎的同步寫入快取則可使用 ZIL。  完整的功能清單與術語在 [ZFS 特色與術語](#ZFS 特色與術語) 中有詳述。\n什麼使 ZFS 與眾不同 ZFS 與以往任何的檔案系統有顯著的不同，因為它不只是一個檔案系統，ZFS 的獨特優點來自結合了以往被分開的磁碟區管理程式 (Volume Manager) 及檔案系統兩個角色，讓檔案系統也能夠察覺磁碟底層結構的變動。傳統在一個磁碟上只能建立一個檔案系統，若有兩個磁碟則會需要建立兩個分開的檔案系統，在傳統要解決這個問題要使用硬體 RAID 來製作一個空間實際上由數顆實體磁碟所組成的單一的邏輯磁碟給作業系統，作業系統便可在這個邏輯磁碟上放置檔案系統，即使是在那些使用 GEOM 提供的軟體 RAID 解決方案也是一樣，把 UFS 檔案系統放在 RAID Transform 上面當做是一個單一的裝置。ZFS 結合了磁碟區管理程式 (Volume Manager) 與檔案系統來解決這個問題並讓建立多個檔案系統可以共用一個儲存池 (Pool)。ZFS 最大的優點是可以察覺實體磁碟配置的變動，當有額外的磁碟加入到儲存池時可以自動擴增現有的檔案系統，所有的檔案系統便可使用這個新的空間。ZFS 也有數個不同的屬性可以套用到各別檔案系統上，比起單一檔案系統，對建立數個不同檔案系統與資料集 (Dataset) 時有許多的好處。\n快速入門指南 這裡有一個啟動機制，可讓 FreeBSD 在系統初始化時掛載 ZFS 儲存池。要開啟這個功能，可加入此行到 /etc/rc.conf：\nzfs_enable=\"YES\" 然後啟動服務：\n# service zfs start 本節的例子會假設有三個 SCSI 磁碟，名稱分別為 da0, da1 及 da2。SATA 硬體的使用者裝置名稱改為 ada 。\n單磁碟儲存池 要使用一個磁碟裝置建立一個簡單、無備援的儲存池可：\n# zpool create example /dev/da0 要檢視這個新的儲存池，可查看 df 的輸出結果：\n# df Filesystem 1K-blocks Used Avail Capacity Mounted on ... example 17547136 0 17547136 0% /example 這個輸出結果說明 example 儲存池已建立且被掛載，現在已經可以作為檔案系統存取，可以在上面建立檔案且使用者可以瀏覽：\n# cd /example # ls # touch testfile # ls -al total 4 drwxr-xr-x 2 root wheel 3 Aug 29 23:15 . drwxr-xr-x 21 root wheel 512 Aug 29 23:12 .. -rw-r--r-- 1 root wheel 0 Aug 29 23:15 testfile 但是，這個儲存池並未運用到任何 ZFS 功能，若要在這個儲存池上建立一個有開啟壓縮功能的資料集：\n# zfs create example/compressed # zfs set compression=gzip example/compressed example/compressed 資料集現在是一個 ZFS 壓縮的檔案系統，可以試著複製較大的檔案到 /example/compressed。\n壓縮功能也可以使用以下指令關閉：\n# zfs set compression=off example/compressed 要卸載檔案系統，使用 zfs umount 然後再使用 df 確認：\n# zfs umount example/compressed # df Filesystem 1K-blocks Used Avail Capacity Mounted on ... example 17547008 0 17547008 0% /example 要重新掛載檔案系統以便再次使用，使用 zfs mount 然後以 df 檢查：\n# zfs mount example/compressed # df Filesystem 1K-blocks Used Avail Capacity Mounted on ... example 17547008 0 17547008 0% /example example/compressed 17547008 0 17547008 0% /example/compressed 儲存池與檔案系統也可以從 mount 的結果查詢到：\n# mount /dev/ad0s1a on / (ufs, local) devfs on /dev (devfs, local) /dev/ad0s1d on /usr (ufs, local, soft-updates) example on /example (zfs, local) example/compressed on /example/compressed (zfs, local) 在建立之後，ZFS 的資料集可如同其他檔案系統一般使用，且有許多額外功能可在每個資料集上設定。例如，建立一個預計存放重要的資料的新檔案系統 data，要設定每個資料區塊 (Data block) 要保留兩份備份：\n# zfs create example/data # zfs set copies=2 example/data 現在，可以使用 df 指令來查看資料與空間的使用率：\n# df Filesystem 1K-blocks Used Avail Capacity Mounted on ... example 17547008 0 17547008 0% /example example/compressed 17547008 0 17547008 0% /example/compressed example/data 17547008 0 17547008 0% /example/data 注意，從這個可以發現每個在儲存池上的檔案系統都擁有相同的可用空間，這是為什麼要在這些範例使用 df 的原因，為了要顯示檔案系統只會用它們所需要使用到的空間，且均取自同一個儲存池。ZFS 淘汰了磁碟區 (Volume) 與分割區 (Partition) 的概念，且允許多個檔案系統共用相同的儲存池。\n不需要使用時可摧毀檔案系統後再摧毀儲存池：\n# zfs destroy example/compressed # zfs destroy example/data # zpool destroy example RAID-Z 磁碟損壞時，要避免資料因磁碟故障造成遺失便是使用 RAID。ZFS 在它的儲存池設計中支援了這項功能。RAID-Z 儲存池需要使用三個或更多的磁碟，但可以提供比鏡像 (Mirror) 儲存池更多的可用空間。\n這個例子會建立一個 RAID-Z 儲存池，並指定要加入這個儲存池的磁碟：\n# zpool create storage raidz da0 da1 da2  Sun™ 建議用在 RAID-Z 設定的裝置數在三到九個之間。若需要由 10 個或更多磁碟組成單一儲存池的環境，可考慮分成較小的 RAID-Z 群組。若只有兩個可用的磁碟且需要做備援 (Redundancy)，可考慮使用 ZFS 鏡像 (Mirror)。請參考 zpool(8) 取得更多詳細資訊。\n 先前的例子已經建立了 storage 儲存池 (zpool)，現在這個例子會在該儲存池中建立一個新的檔案系統，名稱為 home：\n# zfs create storage/home 可以設定開啟壓縮及保留目錄及檔案額外備份的功能：\n# zfs set copies=2 storage/home # zfs set compression=gzip storage/home 要讓這個空間作為使用者的新家目錄位置，需複製使用者資料到這個目錄並建立適合的符號連結 (Symbolic link)：\n# cp -rp /home/* /storage/home # rm -rf /home /usr/home # ln -s /storage/home /home # ln -s /storage/home /usr/home 現在使用者的資料會儲存在新建立的 /storage/home，可以加入新使用者並登入該使用者來測試。\n試著建立檔案系統快照 (Snapshot)，稍後可用來還原 (Rollback)：\n# zfs snapshot storage/home@08-30-08 快照只可以使用整個檔案系統製作，無法使用各別目錄或檔案。\n@ 字元用來區隔檔案系統名稱 (File system) 或磁碟區 (Volume) 名稱，若有重要的目錄意外被刪除，檔案系統可以備份然後還原到先前目錄還存在時的快照 (Snapshot)：\n# zfs rollback storage/home@08-30-08 要列出所有可用的快照，可在檔案系統的 .zfs/snapshot 目錄執行 ls，舉例來說，要查看先前已做的快照：\n# ls /storage/home/.zfs/snapshot 也可以寫一個 Script 來對使用者資料做例行性的快照，但隨著時間快照可能消耗大量的磁碟空間。先前的快照可以使用指令移除：\n# zfs destroy storage/home@08-30-08 在測試之後，便可讓 /storage/home 成為真正的 /home 使用此指令：\n# zfs set mountpoint=/home storage/home 執行 df 興 mount 來確認系統現在是否以把檔案系統做為真正的 /home：\n# mount ... storage on /storage (zfs, local) storage/home on /home (zfs, local) # df Filesystem 1K-blocks Used Avail Capacity Mounted on ... storage 26320512 0 26320512 0% /storage storage/home 26320512 0 26320512 0% /home 這個動作完成 RAID-Z 最後的設定，有關已建立的檔案系統每日狀態更新可以做為 periodic(8) 的一部份在每天晚上執行。加入此行到 /etc/periodic.conf：\ndaily_status_zfs_enable=\"YES\" 復原 RAID-Z 每個軟體 RAID 都有監控其狀態 (state) 的方式，而 RAID-Z 裝置的狀態可以使用這個指令來查看：\n# zpool status -x 如果所有儲存池為上線 (Online) 且正常，則訊息會顯示：\nall pools are healthy 如果有發生問題，可能磁碟會呈現離線 (Offline) 的狀態，此時儲存池的狀態會是：\npool: storage state: DEGRADED status: One or more devices has been taken offline by the administrator. Sufficient replicas exist for the pool to continue functioning in a degraded state. action: Online the device using 'zpool online' or replace the device with 'zpool replace'. scrub: none requested config: NAME STATE READ WRITE CKSUM storage DEGRADED 0 0 0 raidz1 DEGRADED 0 0 0 da0 ONLINE 0 0 0 da1 OFFLINE 0 0 0 da2 ONLINE 0 0 0 errors: No known data errors 這代表著裝置在之前被管理者使用此指令拿下線：\n# zpool offline storage da1 現在系統可以關機然後更換 da1，當系統恢復上線，則可以替換掉儲存池中故障的磁碟：\n# zpool replace storage da1 到這裡，可以再檢查狀態一次，這時不需使用 -x 參數來顯示所有的儲存池：\n# zpool status storage pool: storage state: ONLINE scrub: resilver completed with 0 errors on Sat Aug 30 19:44:11 2008 config: NAME STATE READ WRITE CKSUM storage ONLINE 0 0 0 raidz1 ONLINE 0 0 0 da0 ONLINE 0 0 0 da1 ONLINE 0 0 0 da2 ONLINE 0 0 0 errors: No known data errors 在這個例子中，所有的磁碟均已正常運作。\n資料檢驗 ZFS 使用校驗碼 (Checksum) 來檢驗資料的完整性 (Integrity)，會在建立檔案系統時便自動開啟。\n 校驗碼 (Checksum) 可以關閉，但並不建議！校驗碼只會使用非常少的儲存空間來確保資料的完整性。若關閉校驗碼會使許多 ZFS 功能無法正常運作，且關閉校驗碼對並不會明顯的改善效能。\n 檢驗校驗碼這個動作即所謂的清潔 (Scrub)，可以使用以下指令來檢驗 storage 儲存池的資料完整性：\n# zpool scrub storage 清潔所需要的時間依儲存的資料量而定，較大的資料量相對會需要花費較長的時間來檢驗。清潔會對 I/O 有非常密集的操作且一次只能進行一個清潔動作。在清潔完成之後，可以使用 status 來查看狀態：\n# zpool status storage pool: storage state: ONLINE scrub: scrub completed with 0 errors on Sat Jan 26 19:57:37 2013 config: NAME STATE READ WRITE CKSUM storage ONLINE 0 0 0 raidz1 ONLINE 0 0 0 da0 ONLINE 0 0 0 da1 ONLINE 0 0 0 da2 ONLINE 0 0 0 errors: No known data errors 查詢結果會顯示上次完成清潔的時間來協助追蹤是否要再做清潔。定期清潔可以協助保護資料不會默默損壞且確保儲存池的完整性。\n請參考 zfs(8) 及 zpool(8) 來取得其他 ZFS 選項。\nzpool 管理 ZFS 管理分成兩個主要的工具。zpool 工具用來控制儲存池的運作並可處理磁碟的新增、移除、更換與管理。[zfs](#zfs 管理) 工具用來建立、摧毀與管理檔案系統 (File system) 與磁碟區 (Volume) 的資料集。\n建立與摧毀儲存池 建立 ZFS 儲存池 (zpool) 要做幾個涉及長遠規劃的決定，因為建立儲存池之後便無法再更改儲存池的結構。最重要的決定是要使用那一種型態的 vdev 來將實體磁碟設為同一群組。請參考 vdev 型態 的清單來取得有關可用選項的詳細資訊。大部份的 vdev 型態不允許在建立儲存池之後再加入額外的磁碟，鏡像 (Mirror) 是可以允許加入額外的磁碟到 vdev 的其中一個例外，另一個則是串連 (Stripe)，可以加入額外的磁碟到 vdev 來升級為鏡像。雖然可以加入額外的 vdev 來擴充儲存池，但儲存池的配置在建立之後便無法更改，若要要更改，則必須先備份資料，把儲存池摧毀後再重新建立。\n建立一個簡單的鏡像儲存池：\n# zpool create mypool mirror /dev/ada1 /dev/ada2 # zpool status pool: mypool state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada1 ONLINE 0 0 0 ada2 ONLINE 0 0 0 errors: No known data errors 可以一次建立數個 vdev，磁碟群組間使用 vdev 型態關鍵字來區隔，在這個例子使用 mirror：\n# zpool create mypool mirror /dev/ada1 /dev/ada2 mirror /dev/ada3 /dev/ada4 pool: mypool state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada1 ONLINE 0 0 0 ada2 ONLINE 0 0 0 mirror-1 ONLINE 0 0 0 ada3 ONLINE 0 0 0 ada4 ONLINE 0 0 0 errors: No known data errors 儲存池也可以不使用整個磁碟而改使用分割區 (Partition) 來建立。把 ZFS 放到不同的分割區可讓同一個磁碟有其他的分割區可做其他用途，尤其是有 Bootcode 與檔案系統要用來開機的分割區，這讓磁碟可以用來開機也同樣可以做為儲存池的一部份。在 FreeBSD 用分割區來替代整個磁碟並不會對效能有影響。使用分割區也讓管理者可以對磁碟容量做 少算的預備，使用比完整容量少的容量，未來若要替換的磁碟號稱與原磁碟相同，但實際上卻比較小時，也可符合這個較小的分割區容量，以使用替換的磁碟。\n使用分割區建立一個 RAID-Z2 儲存池：\n# zpool create mypool raidz2 /dev/ada0p3 /dev/ada1p3 /dev/ada2p3 /dev/ada3p3 /dev/ada4p3 /dev/ada5p3 # zpool status pool: mypool state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 raidz2-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 ada3p3 ONLINE 0 0 0 ada4p3 ONLINE 0 0 0 ada5p3 ONLINE 0 0 0 errors: No known data errors 不需使用的儲存池可以摧毀，來讓磁碟可以再次使用。摧毀一個儲存池要先卸載所有該儲存池的資料集。若資料集在使用中，卸載的操作會失敗且儲存池不會被摧毀。儲存池的摧毀可以使用 -f 來強制執行，但這可能造成那些有開啟這些資料集之中檔案的應用程式無法辨識的行為。\n加入與移除裝置 加入磁碟到儲存池 (zpool) 會有兩種情形：使用 zpool attach 加入一個磁碟到既有的 vdev，或使用 zpool add 加入 vdev 到儲存池。只有部份 vdev 型態 允許在 vdev 建立之後加入磁碟。\n由單一磁碟所建立的儲存池缺乏備援 (Redundancy) 功能，可以偵測到資料的損壞但無法修復，因為資料沒有其他備份可用。備份數 (Copies) 屬性可以讓您從較小的故障中復原，如磁碟壞軌 (Bad sector)，但無法提供與鏡像或 RAID-Z 同樣層級的保護。由單一磁碟所建立的儲存池可以使用 zpool attach 來加入額外的磁碟到 vdev，來建立鏡像。zpool attach 也可用來加入額外的磁碟到鏡像群組，來增加備援與讀取效率。若使用的磁碟已有分割區，可以複製該磁碟的分割區配置到另一個，使用 gpart backup 與 gpart restore 可讓這件事變的很簡單。\n加入 ada1p3 來升級單一磁碟串連 (stripe) vdev ada0p3 採用鏡像型態 (mirror)：\n# zpool status pool: mypool state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 errors: No known data errors # zpool attach mypool ada0p3 ada1p3 Make sure to wait until resilver is done before rebooting. If you boot from pool 'mypool', you may need to update boot code on newly attached disk 'ada1p3'. Assuming you use GPT partitioning and 'da0' is your new boot disk you may use the following command: gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 da0 # gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1 bootcode written to ada1 # zpool status pool: mypool state: ONLINE status: One or more devices is currently being resilvered. The pool will continue to function, possibly in a degraded state. action: Wait for the resilver to complete. scan: resilver in progress since Fri May 30 08:19:19 2014 527M scanned out of 781M at 47.9M/s, 0h0m to go 527M resilvered, 67.53% done config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 (resilvering) errors: No known data errors # zpool status pool: mypool state: ONLINE scan: resilvered 781M in 0h0m with 0 errors on Fri May 30 08:15:58 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 errors: No known data errors 若不想選擇加入磁碟到既有的 vdev ，對 RAID-Z 來說，可選擇另一種方式，便是加入另一個 vdev 到儲存池。額外的 vdev 可以提供更高的效能，分散寫入資料到 vdev 之間，每個 vdev 會負責自己的備援。也可以混合使用不同的 vdev 型態，但並不建議，例如混合使用 mirror 與 RAID-Z，加入一個無備援的 vdev 到一個含有 mirror 或 RAID-Z vdev 的儲存池會讓資料損壞的風險擴大整個儲存池，由於會分散寫入資料，若在無備援的磁碟上發生故障的結果便是遺失大半寫到儲存池的資料區塊。\n在每個 vdev 間的資料是串連的，例如，有兩個 mirror vdev，便跟 RAID 10 一樣在兩個 mirror 間分散寫入資料，且會做空間的分配，因此 vdev 會在同時達到全滿 100% 的用量。若 vdev 間的可用空間量不同則會影響到效能，因為資料量會不成比例的寫入到使用量較少的 vdev。\n當連接額外的裝置到一個可以開機的儲存池，要記得更新 Bootcode。\n連接第二個 mirror 群組 (ada2p3 及 ada3p3) 到既有的 mirror：\n# zpool status pool: mypool state: ONLINE scan: resilvered 781M in 0h0m with 0 errors on Fri May 30 08:19:35 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 errors: No known data errors # zpool add mypool mirror ada2p3 ada3p3 # gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2 bootcode written to ada2 # gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada3 bootcode written to ada3 # zpool status pool: mypool state: ONLINE scan: scrub repaired 0 in 0h0m with 0 errors on Fri May 30 08:29:51 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 mirror-1 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 ada3p3 ONLINE 0 0 0 errors: No known data errors 現在已無法從儲存池上移除 vdev，且磁碟只能夠在有足夠備援空間的情況下從 mirror 移除，若在 mirror 群組中只剩下一個磁碟，便會取消 mirror 然後還原為 stripe，若剩下的那個磁碟故障，便會影響到整個儲存池。\n從一個三方 mirror 群組移除一個磁碟：\n# zpool status pool: mypool state: ONLINE scan: scrub repaired 0 in 0h0m with 0 errors on Fri May 30 08:29:51 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 errors: No known data errors # zpool detach mypool ada2p3 # zpool status pool: mypool state: ONLINE scan: scrub repaired 0 in 0h0m with 0 errors on Fri May 30 08:29:51 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 errors: No known data errors 檢查儲存池狀態 儲存池的狀態很重要，若有磁碟機離線或偵測到讀取、寫入或校驗碼 (Checksum) 錯誤，對應的錯誤計數便會增加。status 會顯示儲存池中每一個磁碟機的設定與狀態及整個儲存池的狀態。需要處置的方式與有關最近清潔 (Scrub) 的詳細資訊也會一併顯示。\n# zpool status pool: mypool state: ONLINE scan: scrub repaired 0 in 2h25m with 0 errors on Sat Sep 14 04:25:50 2013 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 raidz2-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 ada3p3 ONLINE 0 0 0 ada4p3 ONLINE 0 0 0 ada5p3 ONLINE 0 0 0 errors: No known data errors 清除錯誤 當偵測到錯誤發生，讀取、寫入或校驗碼 (Checksum) 的計數便會增加。使用 zpool clear mypool 可以清除錯誤訊息及重置計數。清空錯誤狀態對當儲存池發生錯誤要使用自動化 Script 通知的管理者來說會很重要，因在舊的錯誤尚未清除前不會回報後續的錯誤。\n更換運作中的裝置 可能有一些情況會需要更換磁碟為另一個磁碟，當要更換運作中的磁碟，此程序會維持舊有的磁碟在更換的過程為上線的狀態，儲存池不會進入降級 (Degraded) 的狀態，來減少資料遺失的風險。zpool replace 會複製所有舊磁碟的資料到新磁碟，操作完成之後舊磁碟便會與 vdev 中斷連線。若新磁碟容量較舊磁碟大，也可以會增加儲存池來使用新的空間，請參考 擴增儲存池。\n更換儲存池中正在運作的狀置：\n# zpool status pool: mypool state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 errors: No known data errors # zpool replace mypool ada1p3 ada2p3 Make sure to wait until resilver is done before rebooting. If you boot from pool 'zroot', you may need to update boot code on newly attached disk 'ada2p3'. Assuming you use GPT partitioning and 'da0' is your new boot disk you may use the following command: gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 da0 # gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2 # zpool status pool: mypool state: ONLINE status: One or more devices is currently being resilvered. The pool will continue to function, possibly in a degraded state. action: Wait for the resilver to complete. scan: resilver in progress since Mon Jun 2 14:21:35 2014 604M scanned out of 781M at 46.5M/s, 0h0m to go 604M resilvered, 77.39% done config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 replacing-1 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 (resilvering) errors: No known data errors # zpool status pool: mypool state: ONLINE scan: resilvered 781M in 0h0m with 0 errors on Mon Jun 2 14:21:52 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 errors: No known data errors 處理故障裝置 當儲存池中的磁碟故障，該故障硬碟所屬的 vdev 便會進入降級 (Degraded) 狀態，所有的資料仍可使用，但效能可能會降低，因為遺失的資料必須從可用的備援資料計算才能取得。要將 vdev 恢復完整運作的狀態必須更換故障的實體裝置。然後 ZFS 便會開始修復 (Resilver，古代鏡子的修復稱 Resilver) 作業，會從可用的備援資料計算出故障磁碟中的資料並寫入到替換的裝置上。完成後 vdev 便會重新返回上線 (Online) 的狀態。\n若 vdev 沒有任何備援資料或有多個裝置故障，沒有足夠的備援資料可以補償，儲存池便會進入故障 (Faulted) 的狀態。\n更換故障的磁碟時，故障磁碟的名稱會更換為裝置的 GUID，若替換裝置要使用相同的裝置名稱，則在 zpool replace 不須加上新裝置名稱參數。\n使用 zpool replace 更換故障的磁碟：\n# zpool status pool: mypool state: DEGRADED status: One or more devices could not be opened. Sufficient replicas exist for the pool to continue functioning in a degraded state. action: Attach the missing device and online it using 'zpool online'. see: http://illumos.org/msg/ZFS-8000-2Q scan: none requested config: NAME STATE READ WRITE CKSUM mypool DEGRADED 0 0 0 mirror-0 DEGRADED 0 0 0 ada0p3 ONLINE 0 0 0 316502962686821739 UNAVAIL 0 0 0 was /dev/ada1p3 errors: No known data errors # zpool replace mypool 316502962686821739 ada2p3 # zpool status pool: mypool state: DEGRADED status: One or more devices is currently being resilvered. The pool will continue to function, possibly in a degraded state. action: Wait for the resilver to complete. scan: resilver in progress since Mon Jun 2 14:52:21 2014 641M scanned out of 781M at 49.3M/s, 0h0m to go 640M resilvered, 82.04% done config: NAME STATE READ WRITE CKSUM mypool DEGRADED 0 0 0 mirror-0 DEGRADED 0 0 0 ada0p3 ONLINE 0 0 0 replacing-1 UNAVAIL 0 0 0 15732067398082357289 UNAVAIL 0 0 0 was /dev/ada1p3/old ada2p3 ONLINE 0 0 0 (resilvering) errors: No known data errors # zpool status pool: mypool state: ONLINE scan: resilvered 781M in 0h0m with 0 errors on Mon Jun 2 14:52:38 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 errors: No known data errors 清潔儲存池 建議儲存池要定期清潔 (Scrub)，最好是每一個月清潔一次。 scrub 作業對磁碟操作非常的密集，在執行時會降低磁碟的效能。在排程 scrub 時避免在使用高峰的時期，或使用 vfs.zfs.scrub_delay 來調整 scrub 的相對優先權來避免影響其他的工作。\n# zpool scrub mypool # zpool status pool: mypool state: ONLINE scan: scrub in progress since Wed Feb 19 20:52:54 2014 116G scanned out of 8.60T at 649M/s, 3h48m to go 0 repaired, 1.32% done config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 raidz2-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 ada3p3 ONLINE 0 0 0 ada4p3 ONLINE 0 0 0 ada5p3 ONLINE 0 0 0 errors: No known data errors 若發生需要取消清潔作業的事，可以下 zpool scrub -s mypool。\n自我修復 校驗碼 (Checksum) 會隨資料區塊一併儲存，這使得檔案系統可以做到自我修復。這個功能可以在校驗碼與儲存池中的另一個裝置不同時自動修復資料。舉例來說，有兩個磁碟做鏡像 (Mirror)，其中一個磁碟機開始失常並無法正常儲存資料，甚至是資料放在長期封存的儲存裝置上，已經很久沒有被存取。傳統的檔案系統需要執行演算法來檢查並修復資料如 fsck(8)，這些指令耗費時間，且在嚴重時需要管理者手動決定要做那一種修復操作。當 ZFS 偵測到資料區塊的校驗碼不對時，它除了把資料交給需要的應用程式外，也會修正在磁碟上錯誤的資料。這件事不需要與系統管理者作任何互動便會在一般的儲存池操作時完成。\n接下來的例子會示範自我修復會如何運作。建立一個使用磁碟 /dev/ada0 及 /dev/ada1 做鏡像的儲存池。\n# zpool create healer mirror /dev/ada0 /dev/ada1 # zpool status healer pool: healer state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM healer ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 0 errors: No known data errors # zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT healer 960M 92.5K 960M - - 0% 0% 1.00x ONLINE - 將部份需要使用自我修復功能來保護的重要資料複製到該儲存池，建立一個儲存池的校驗碼供稍後做比較時使用。\n# cp /some/important/data /healer # zfs list NAME SIZE ALLOC FREE CAP DEDUP HEALTH ALTROOT healer 960M 67.7M 892M 7% 1.00x ONLINE - # sha1 /healer  checksum.txt # cat checksum.txt SHA1 (/healer) = 2753eff56d77d9a536ece6694bf0a82740344d1f 寫入隨機的資料到鏡像的第一個磁碟來模擬資料損毀的情況。要避免 ZFS 偵測到錯誤時馬上做修復，接著要將儲存池匯出，待模擬資料損毀之後再匯入。\n 這是一個危險的操作，會破壞重要的資料。在這裡使用僅為了示範用，不應在儲存池正常運作時嘗試使用，也不應將這個故意損壞資料的例子用在任何其他的檔案系統上，所以請勿使用任何不屬於該儲存池的其他磁碟裝置名稱並確定在執行指令前已對儲存池做正確的備份！\n # zpool export healer # dd if=/dev/random of=/dev/ada1 bs=1m count=200 200+0 records in 200+0 records out 209715200 bytes transferred in 62.992162 secs (3329227 bytes/sec) # zpool import healer 儲存池的狀態顯示有一個裝置發生了錯誤。注意，應用程式從儲存池讀取的資料中並沒有任何的錯誤資料，ZFS 會自 ada0 裝置提供有正確校驗碼的資料。結果裡面 CKSUM 欄位含有非零值便是有錯誤校驗碼的裝置。\n# zpool status healer pool: healer state: ONLINE status: One or more devices has experienced an unrecoverable error. An attempt was made to correct the error. Applications are unaffected. action: Determine if the device needs to be replaced, and clear the errors using 'zpool clear' or replace the device with 'zpool replace'. see: http://illumos.org/msg/ZFS-8000-4J scan: none requested config: NAME STATE READ WRITE CKSUM healer ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 1 errors: No known data errors 錯誤已經被偵測到並且由未被影響的 ada0 鏡像磁碟上的備援提供資料。可與原來的校驗碼做比較來看儲存池是否已修復為一致。\n# sha1 /healer  checksum.txt # cat checksum.txt SHA1 (/healer) = 2753eff56d77d9a536ece6694bf0a82740344d1f SHA1 (/healer) = 2753eff56d77d9a536ece6694bf0a82740344d1f 儲存池在故意竄改資料前與後的兩個校驗碼仍相符顯示了 ZFS 在校驗碼不同時偵測與自動修正錯誤的能力。注意，這只在當儲存池中有足夠的備援時才可做到，由單一裝置組成的儲存池並沒有自我修復的能力。這也是為什麼在 ZFS 中校驗碼如此重要，任何原因都不該關閉。不需要 fsck(8) 或類似的檔案系統一致性檢查程式便能夠偵測與修正問題，且儲存儲存池在發生問題時仍可正常運作。接著需要做清潔作業來覆蓋在 ada1 上的錯誤資料。\n# zpool scrub healer # zpool status healer pool: healer state: ONLINE status: One or more devices has experienced an unrecoverable error. An attempt was made to correct the error. Applications are unaffected. action: Determine if the device needs to be replaced, and clear the errors using 'zpool clear' or replace the device with 'zpool replace'. see: http://illumos.org/msg/ZFS-8000-4J scan: scrub in progress since Mon Dec 10 12:23:30 2012 10.4M scanned out of 67.0M at 267K/s, 0h3m to go 9.63M repaired, 15.56% done config: NAME STATE READ WRITE CKSUM healer ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 627 (repairing) errors: No known data errors 清潔作業會從 ada0 讀取資料並重新寫入任何在 ada1 上有錯誤校驗碼的資料。這個操作可以由 zpool status 的輸出中呈現修復中 (repairing) 的項目來辨識。這個作業完成後，儲存池的狀態會更改為：\n# zpool status healer pool: healer state: ONLINE status: One or more devices has experienced an unrecoverable error. An attempt was made to correct the error. Applications are unaffected. action: Determine if the device needs to be replaced, and clear the errors using 'zpool clear' or replace the device with 'zpool replace'. see: http://illumos.org/msg/ZFS-8000-4J scan: scrub repaired 66.5M in 0h2m with 0 errors on Mon Dec 10 12:26:25 2012 config: NAME STATE READ WRITE CKSUM healer ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 2.72K errors: No known data errors 清潔操作完成便同步了 ada0 到 ada1 間的所有資料。執行 zpool clear 可以清除 (Clear) 儲存池狀態的錯誤訊息。\n# zpool clear healer # zpool status healer pool: healer state: ONLINE scan: scrub repaired 66.5M in 0h2m with 0 errors on Mon Dec 10 12:26:25 2012 config: NAME STATE READ WRITE CKSUM healer ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 0 errors: No known data errors 儲存池現在恢復完整運作的狀態且清除所有的錯誤了。\n擴增儲存池 可用的備援儲存池大小會受到每個 vdev 中容量最小的裝置限制。最小的裝置可以替換成較大的裝置，在更換 (Replace) 或修復 (Resilver) 作業後，儲存池可以成長到該新裝置的可用容量。例如，要做一個 1 TB 磁碟機與一個 2 TB 磁碟機的鏡像，可用的空間會是 1 TB，當 1 TB 磁碟機備更換成另一個 2 TB 的磁碟機時，修復程序會複製既有的資料到新的磁碟機，由於現在兩個裝置都有 2 TB 的容量，所以鏡像的可用空間便會成長到 2 TB。\n可以在每個裝置用 zpool online -e 來觸發擴充的動作，在擴充完所有裝置後，儲存池便可使用額外的空間。\n匯入與匯出儲存池 儲存池在移動到其他系統之前需要做匯出 (Export)，會卸載所有的資料集，然後標記每個裝置為已匯出，為了避免被其他磁碟子系統存取，因此仍會鎖定這些裝置。這個動作讓儲存池可以在支援 ZFS 的其他機器、其他作業系統做匯入 (Import)，甚至是不同的硬體架構 (有一些注意事項，請參考 zpool(8))。當資料集有被開啟的檔案，可使用 zpool export -f 來強制匯出儲存池，使用這個指令需要小心，資料集是被強制卸載的，因此有可能造成在該資料集開啟檔案的應用程式發生無法預期的結果。\n匯出未使用的儲存池：\n# zpool export mypool 匯入儲存池會自動掛載資料集，若不想自動掛載，可以使用 zpool import -N。zpool import -o 可以設定在匯入時暫時使用的屬性。zpool import altroot= 允許匯入時指定基礎掛載點 (Base mount point) 來替換檔案系統根目錄。若儲存池先前用在不同的系統且不正常匯出，可能會需要使用 zpool import -f 來強制匯入。zpool import -a 會匯入所有沒有被其他系統使用的儲存池。\n列出所有可以匯入的儲存池：\n# zpool import pool: mypool id: 9930174748043525076 state: ONLINE action: The pool can be imported using its name or numeric identifier. config: mypool ONLINE ada2p3 ONLINE 使用替代的根目錄匯入儲存池：\n# zpool import -o altroot=/mnt mypool # zfs list zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 110K 47.0G 31K /mnt/mypool 升級儲存儲存池 在升級 FreeBSD 之後或儲存池是由其他使用舊版 ZFS 的系統匯入，儲存池可以手動升級到最新版本的 ZFS 來支援新的功能。在升級前請評估儲存池是否還要在舊的系統做匯入，由於升級是一個單向的程序，舊的儲存池可以升級，但有新功能的儲存池無法降級。\n升級一個 v28 的儲存以支援功能旗標 (Feature Flags)：\n# zpool status pool: mypool state: ONLINE status: The pool is formatted using a legacy on-disk format. The pool can still be used, but some features are unavailable. action: Upgrade the pool using 'zpool upgrade'. Once this is done, the pool will no longer be accessible on software that does not support feat flags. scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 0 errors: No known data errors # zpool upgrade This system supports ZFS pool feature flags. The following pools are formatted with legacy version numbers and can be upgraded to use feature flags. After being upgraded, these pools will no longer be accessible by software that does not support feature flags. VER POOL --- ------------ 28 mypool Use 'zpool upgrade -v' for a list of available legacy versions. Every feature flags pool has all supported features enabled. # zpool upgrade mypool This system supports ZFS pool feature flags. Successfully upgraded 'mypool' from version 28 to feature flags. Enabled the following features on 'mypool': async_destroy empty_bpobj lz4_compress multi_vdev_crash_dump ZFS 的新功能在 zpool upgrade 尚未完成之前無法使用。可以用 zpool upgrade -v 來查看升級後有那些新功能，也同時會列出已經支援那些功能。\n升級儲存池支援新版的功能旗標 (Feature flags)：\n# zpool status pool: mypool state: ONLINE status: Some supported features are not enabled on the pool. The pool can still be used, but some features are unavailable. action: Enable all features using 'zpool upgrade'. Once this is done, the pool may no longer be accessible by software that does not support the features. See zpool-features(7) for details. scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 0 errors: No known data errors # zpool upgrade This system supports ZFS pool feature flags. All pools are formatted using feature flags. Some supported features are not enabled on the following pools. Once a feature is enabled the pool may become incompatible with software that does not support the feature. See zpool-features(7) for details. POOL FEATURE --------------- zstore multi_vdev_crash_dump spacemap_histogram enabled_txg hole_birth extensible_dataset bookmarks filesystem_limits # zpool upgrade mypool This system supports ZFS pool feature flags. Enabled the following features on 'mypool': spacemap_histogram enabled_txg hole_birth extensible_dataset bookmarks filesystem_limits  在使用儲存池來開機的系統上的 Boot code 也必須一併更新來支援新的儲存池版本，可在含有 Boot code 的分割區使用 gpart bootcode 來更新。目前有兩種 Boot code 可使用，需視系統開機的方式使用：GPT (最常用的選項) 以及 EFI (較新的系統)。針對傳統使用 GPT 開機的系統，可以使用以下指令：# gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1針對使用 EFI 開機的系統可以執行以下指令：# gpart bootcode -p /boot/boot1.efifat -i 1 ada1套用 Boot code 到所有儲存池中可開機的磁碟。請參考 gpart(8) 以取得更多資訊。\n 顯示已記錄的儲存池歷史日誌 修改儲存池的指令會被記錄下來，會記錄的動作包含資料集的建立，屬性更改或更換磁碟。這個歷史記錄用來查看儲存池是如何建立、由誰執行、什麼動作及何時。歷史記錄並非儲存在日誌檔 (Log file)，而是儲存在儲存池。查看這個歷史記錄的指令名稱為 zpool history：\n# zpool history History for 'tank': 2013-02-26.23:02:35 zpool create tank mirror /dev/ada0 /dev/ada1 2013-02-27.18:50:58 zfs set atime=off tank 2013-02-27.18:51:09 zfs set checksum=fletcher4 tank 2013-02-27.18:51:18 zfs create tank/backup 輸出結果顯示曾在該儲存池上執行的 zpool 與 zfs 指令以及時間戳記。只有會修改儲存池或類似的指令會被記錄下來，像是 zfs list 這種指令並不會被記錄。當不指定儲存池名稱時，會列出所有儲存池的歷史記錄。\n在提供選項 -i 或 -l 時 zpool history 可以顯更多詳細資訊。-i 會顯示使用者觸發的事件外，也會顯示內部記錄的 ZFS 事件。\n# zpool history -i History for 'tank': 2013-02-26.23:02:35 [internal pool create txg:5] pool spa 28; zfs spa 28; zpl 5;uts 9.1-RELEASE 901000 amd64 2013-02-27.18:50:53 [internal property set txg:50] atime=0 dataset = 21 2013-02-27.18:50:58 zfs set atime=off tank 2013-02-27.18:51:04 [internal property set txg:53] checksum=7 dataset = 21 2013-02-27.18:51:09 zfs set checksum=fletcher4 tank 2013-02-27.18:51:13 [internal create txg:55] dataset = 39 2013-02-27.18:51:18 zfs create tank/backup 更多詳細的資訊可加上 -l 來取得，歷史記錄會以較長的格式顯示，包含的資訊有執行指令的使用者名稱、主機名稱以及更改的項目。\n# zpool history -l History for 'tank': 2013-02-26.23:02:35 zpool create tank mirror /dev/ada0 /dev/ada1 [user 0 (root) on :global] 2013-02-27.18:50:58 zfs set atime=off tank [user 0 (root) on myzfsbox:global] 2013-02-27.18:51:09 zfs set checksum=fletcher4 tank [user 0 (root) on myzfsbox:global] 2013-02-27.18:51:18 zfs create tank/backup [user 0 (root) on myzfsbox:global] 輸出結果顯示 root 使用者使用 /dev/ada0 及 /dev/ada1 建立鏡像的儲存池。主機名稱 myzfsbox 在建立完儲存池後也同樣會顯示。由於儲存池可以從一個系統匯出再匯入到另一個系統，因此主機名稱也很重要，這樣一來可以清楚的辦識在其他系統上執行的每一個指令的主機名稱。\n兩個 zpool history 選項可以合併使用來取得最完整的儲存池詳細資訊。儲存池歷史記錄在追蹤執行什麼動作或要取得除錯所需的輸出結果提供了非常有用的資訊。\n監視效能 內建的監視系統可以即時顯示儲存池的 I/O 統計資訊。它會顯示儲存池剩餘的空間與使用的空間，每秒執行了多少讀取與寫入的操作，有多少 I/O 頻寬被使用。預設會監視所有在系統中的儲存池都並顯示出來，可以提供儲存池名稱來只顯示該儲存池的監視資訊。舉一個簡單的例子：\n# zpool iostat capacity operations bandwidth pool alloc free read write read write ---------- ----- ----- ----- ----- ----- ----- data 288G 1.53T 2 11 11.3K 57.1K 要持續監視 I/O 的活動可以在最後的參數指定一個數字，這個數字代表每次更新資訊所間隔的秒數。在每次經過間隔的時間後會列出新一行的統計資訊，按下 Ctrl+C 可以中止監視。或者在指令列的間隔時間之後再指定一個數字，代表總共要顯示的統計資訊筆數。\n使用 -v 可以顯示更詳細的 I/O 統計資訊。每個在儲存池中的裝置會以一行統計資訊顯示。這可以幫助了解每一個裝置做了多少讀取與寫入的操作，並可協助確認是否有各別裝置拖慢了整個儲存池的速度。以下範例會顯示有兩個裝置的鏡像儲存池：\n# zpool iostat -v capacity operations bandwidth pool alloc free read write read write ----------------------- ----- ----- ----- ----- ----- ----- data 288G 1.53T 2 12 9.23K 61.5K mirror 288G 1.53T 2 12 9.23K 61.5K ada1 - - 0 4 5.61K 61.7K ada2 - - 1 4 5.04K 61.7K ----------------------- ----- ----- ----- ----- ----- ----- 分割儲存儲存池 由一個或多個鏡像 vdev 所組成的儲存池可以切分開成兩個儲存池。除非有另外指定，否則每個鏡像的最後一個成員會被分離，用來建立一個含有相同資料的新儲存池。在做這個操作的第一次應先使用 -n，會顯示預計會做的操作而不會真的執行，這可以協助確認操作是否與使用者所要的相同。\nzfs 管理 zfs 工具負責建立、摧毀與管理在一個儲存池中所有的 ZFS 資料集。儲存池使用 [zpool](#zpool 管理) 來管理。\n建立與摧毀資料集 不同於傳統的磁碟與磁碟區管理程式 (Volume manager) ，在 ZFS 中的空間並不會預先分配。傳統的檔案系統在分割與分配空間完後，若沒有增加新的磁碟便無法再增加額外的檔案系統。在 ZFS，可以隨時建立新的檔案系統，每個資料集 (Dataset) 都有自己的屬性，包含壓縮 (Compression)、去重複 (Deduplication)、快取 (Caching) 與配額 (Quota) 功能以及其他有用的屬性如唯讀 (Readonly)、區分大小寫 (Case sensitivity)、網路檔案分享 (Network file sharing) 以及掛載點 (Mount point)。資料集可以存在於其他資料集中，且子資料集會繼承其父資料集的屬性。每個資料集都可以作為一個單位來管理、委託 (Delegate)、備份 (Replicate)、快照 (Snapshot)、監禁 ([Jail](#ZFS 與 Jail)) 與摧毀 (Destroy)，替每種不同類型或集合的檔案建立各別的資料集還有許多的好處。唯一的缺點是在當有非常大數量的資料集時，部份指令例如 zfs list 會變的較緩慢，且掛載上百個或其至上千個資料集可能會使 FreeBSD 的開機程序變慢。\n建立一個新資料集並開啟 LZ4 壓縮：\n# zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 781M 93.2G 144K none mypool/ROOT 777M 93.2G 144K none mypool/ROOT/default 777M 93.2G 777M / mypool/tmp 176K 93.2G 176K /tmp mypool/usr 616K 93.2G 144K /usr mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/ports 144K 93.2G 144K /usr/ports mypool/usr/src 144K 93.2G 144K /usr/src mypool/var 1.20M 93.2G 608K /var mypool/var/crash 148K 93.2G 148K /var/crash mypool/var/log 178K 93.2G 178K /var/log mypool/var/mail 144K 93.2G 144K /var/mail mypool/var/tmp 152K 93.2G 152K /var/tmp # zfs create -o compress=lz4 mypool/usr/mydataset # zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 781M 93.2G 144K none mypool/ROOT 777M 93.2G 144K none mypool/ROOT/default 777M 93.2G 777M / mypool/tmp 176K 93.2G 176K /tmp mypool/usr 704K 93.2G 144K /usr mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/mydataset 87.5K 93.2G 87.5K /usr/mydataset mypool/usr/ports 144K 93.2G 144K /usr/ports mypool/usr/src 144K 93.2G 144K /usr/src mypool/var 1.20M 93.2G 610K /var mypool/var/crash 148K 93.2G 148K /var/crash mypool/var/log 178K 93.2G 178K /var/log mypool/var/mail 144K 93.2G 144K /var/mail mypool/var/tmp 152K 93.2G 152K /var/tmp 摧毀資料集會比刪除所有在資料集上所殘留的檔案來的快，由於摧毀資料集並不會掃描所有檔案並更新所有相關的 Metadata。\n摧毀先前建立的資料集：\n# zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 880M 93.1G 144K none mypool/ROOT 777M 93.1G 144K none mypool/ROOT/default 777M 93.1G 777M / mypool/tmp 176K 93.1G 176K /tmp mypool/usr 101M 93.1G 144K /usr mypool/usr/home 184K 93.1G 184K /usr/home mypool/usr/mydataset 100M 93.1G 100M /usr/mydataset mypool/usr/ports 144K 93.1G 144K /usr/ports mypool/usr/src 144K 93.1G 144K /usr/src mypool/var 1.20M 93.1G 610K /var mypool/var/crash 148K 93.1G 148K /var/crash mypool/var/log 178K 93.1G 178K /var/log mypool/var/mail 144K 93.1G 144K /var/mail mypool/var/tmp 152K 93.1G 152K /var/tmp # zfs destroy mypool/usr/mydataset # zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 781M 93.2G 144K none mypool/ROOT 777M 93.2G 144K none mypool/ROOT/default 777M 93.2G 777M / mypool/tmp 176K 93.2G 176K /tmp mypool/usr 616K 93.2G 144K /usr mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/ports 144K 93.2G 144K /usr/ports mypool/usr/src 144K 93.2G 144K /usr/src mypool/var 1.21M 93.2G 612K /var mypool/var/crash 148K 93.2G 148K /var/crash mypool/var/log 178K 93.2G 178K /var/log mypool/var/mail 144K 93.2G 144K /var/mail mypool/var/tmp 152K 93.2G 152K /var/tmp 在最近版本的 ZFS，zfs destroy 是非同步的，且釋放出的空間會許要花費數分鐘才會出現在儲存池上，可使用 zpool get freeing poolname 來查看 freeing 屬性，這個屬性會指出資料集在背景已經釋放多少資料區塊了。若有子資料集，如快照 (Snapshot) 或其他資料集存在的話，則會無法摧毀父資料集。要摧毀一個資料集及其所有子資料集，可使用 -r 來做遞迴摧毀資料集及其所有子資料集，可用 -n -v 來列出會被這個操作所摧毀的資料集及快照，而不會真的摧毀，因摧毀快照所釋放出的空間也會同時顯示。\n建立與摧毀磁碟區 磁碟區 (Volume) 是特殊類型的資料集，不會被掛載成一個檔案系統，而是會被當做儲存區塊裝置出現在 /dev/zvol/poolname/dataset 下。這讓磁碟區可供其他檔案系統使用、拿來備份虛擬機器的磁碟或是使用 iSCSI 或 HAST 通訊協定匯出。\n磁碟區可以被格式化成任何檔案系統，或不使用檔案系統來儲存原始資料。對一般使用者，磁碟區就像是一般的磁碟，可以放置一般的檔案系統在這些 zvols 上，並提供一般磁碟或檔案系統一般所沒有的功能。例如，使用壓縮屬性在一個 250 MB 的磁碟區可建立一個壓縮的 FAT 檔案系統。\n# zfs create -V 250m -o compression=on tank/fat32 # zfs list tank NAME USED AVAIL REFER MOUNTPOINT tank 258M 670M 31K /tank # newfs_msdos -F32 /dev/zvol/tank/fat32 # mount -t msdosfs /dev/zvol/tank/fat32 /mnt # df -h /mnt | grep fat32 Filesystem Size Used Avail Capacity Mounted on /dev/zvol/tank/fat32 249M 24k 249M 0% /mnt # mount | grep fat32 /dev/zvol/tank/fat32 on /mnt (msdosfs, local) 摧毀一個磁碟區與摧毀一個一般的檔案系統資料集差不多。操作上幾乎是即時的，但在背景會需要花費數分鐘來讓釋放空間再次可用。\n重新命名資料集 資料集的名稱可以使用 zfs rename 更改。父資料集也同樣可以使用這個指令來更改名稱。重新命名一個資料集到另一個父資料集也會更改自父資料集繼承的屬性值。重新命名資料集後，會被卸載然後重新掛載到新的位置 (依繼承的新父資料集而定)，可使用 -u 來避免重新掛載。\n重新命名一個資料集並移動該資料集到另一個父資料集：\n# zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 780M 93.2G 144K none mypool/ROOT 777M 93.2G 144K none mypool/ROOT/default 777M 93.2G 777M / mypool/tmp 176K 93.2G 176K /tmp mypool/usr 704K 93.2G 144K /usr mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/mydataset 87.5K 93.2G 87.5K /usr/mydataset mypool/usr/ports 144K 93.2G 144K /usr/ports mypool/usr/src 144K 93.2G 144K /usr/src mypool/var 1.21M 93.2G 614K /var mypool/var/crash 148K 93.2G 148K /var/crash mypool/var/log 178K 93.2G 178K /var/log mypool/var/mail 144K 93.2G 144K /var/mail mypool/var/tmp 152K 93.2G 152K /var/tmp # zfs rename mypool/usr/mydataset mypool/var/newname # zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 780M 93.2G 144K none mypool/ROOT 777M 93.2G 144K none mypool/ROOT/default 777M 93.2G 777M / mypool/tmp 176K 93.2G 176K /tmp mypool/usr 616K 93.2G 144K /usr mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/ports 144K 93.2G 144K /usr/ports mypool/usr/src 144K 93.2G 144K /usr/src mypool/var 1.29M 93.2G 614K /var mypool/var/crash 148K 93.2G 148K /var/crash mypool/var/log 178K 93.2G 178K /var/log mypool/var/mail 144K 93.2G 144K /var/mail mypool/var/newname 87.5K 93.2G 87.5K /var/newname mypool/var/tmp 152K 93.2G 152K /var/tmp 快照也可以像這樣重新命名，由於快照的本質使其無法被重新命名到另一個父資料集。要遞迴重新命名快照可指定 -r，然後在子資料集中所有同名的快照也會一併被重新命名。\n# zfs list -t snapshot NAME USED AVAIL REFER MOUNTPOINT mypool/var/newname@first_snapshot 0 - 87.5K - # zfs rename mypool/var/newname@first_snapshot new_snapshot_name # zfs list -t snapshot NAME USED AVAIL REFER MOUNTPOINT mypool/var/newname@new_snapshot_name 0 - 87.5K - 設定資料集屬性 每個 ZFS 資料集有數個屬性可以用來控制其行為。大部份的屬性會自動繼承自其父資料集，但可以被自己覆蓋。設定資料集上的屬性可使用 zfs set property=value dataset。大部份屬性有限制可用的值，zfs get 會顯示每個可以使用的屬性及其可用的值。大部份可以使用 zfs inherit 還原成其繼承的值。\n也可設定使用者自訂的屬性。這些屬性也會成為資料集設定的一部份，且可以被用來提供資料集或其內容的額外資訊。要分別自訂屬性與 ZFS 提供的屬性，會使用冒號 (:) 建立一個自訂命名空間供自訂屬性使用。\n# zfs set custom:costcenter=1234 tank # zfs get custom:costcenter tank NAME PROPERTY VALUE SOURCE tank custom:costcenter 1234 local 要移除自訂屬性，可用 zfs inherit 加上 -r。若父資料集未定義任何自訂屬性，將會將該屬性完全移除 (更改動作仍會記錄於儲存池的歷史記錄)。\n# zfs inherit -r custom:costcenter tank # zfs get custom:costcenter tank NAME PROPERTY VALUE SOURCE tank custom:costcenter - - # zfs get all tank | grep custom:costcenter # 取得與設定共享屬性 两个常用和有用的数据集属性是NFS和SMB共享选项。设置这些参数可以定义是否以及如何在网络上共享ZFS数据集。目前，FreeBSD只支持通过NFS设置共享。输入以下命令获取当前共享状态:\n# zfs get sharenfs mypool/usr/home NAME PROPERTY VALUE SOURCE mypool/usr/home sharenfs on local # zfs get sharesmb mypool/usr/home NAME PROPERTY VALUE SOURCE mypool/usr/home sharesmb off local 如果需要共享数据集，请输入:\n# zfs set sharenfs=on mypool/usr/home 还可以为通过NFS共享数据集设置额外的选项，例如-alldirs、-maprot和-network。如果要为NFS共享的数据集设置其他选项，请输入:\n# zfs set sharenfs=\"-alldirs,-maproot=root,-network=192.168.1.0/24\" mypool/usr/home 管理快照 (Snapshot) 快照 (Snapshot) 是 ZFS 最強大的功能之一。快照提供了資料集唯讀、單一時間點 (Point-in-Time) 的複製功能，使用了寫入時複製 (Copy-On-Write, COW) 的技術，可以透過保存在磁碟上的舊版資料快速的建立快照。若沒有快照存在，在資料被覆蓋或刪除時，便回收空間供未來使用。由於只記錄前一個版本與目前資料集的差異，因此快照可節省磁碟空間。快照只允許在整個資料集上使用，無法在各別檔案或目錄。當建立了一個資料集的快照時，便備份了所有內含的資料，這包含了檔案系統屬性、檔案、目錄、權限等等。第一次建立快照時只會使用到更改參照到資料區塊的空間，不會用到其他額外的空間。使用 -r 可以對使用同名的資料集及其所有子資料集的建立一個遞迴快照，提供一致且即時 (Moment-in-time) 的完整檔案系統快照功能，這對於那些彼此有相關或相依檔案存放在不同資料集的應用程式非常重要。不使用快照所備份的資料其實是分散不同時間點的。\nZFS 中的快照提供了多種功能，即使是在其他缺乏快照功能的檔案系統上。一個使用快照的典型例子是在安裝軟體或執行系統升級這種有風險的動作時，能有一個快速的方式可以備份檔案系統目前的狀態，若動作失敗，可以使用快照還原 (Roll back) 到與快照建立時相同的系統狀態，若升級成功，便可刪除快照來釋放空間。若沒有快照功能，升級失敗通常會需要使用備份來恢復 (Restore) 系統，而這個動作非常繁瑣、耗時且可能會需要停機一段時間系統無法使用。使用快照可以快速的還原，即使系統正在執行一般的運作，只而要短暫或甚至不需停機。能夠節省大量在有數 TB 的儲存系統上從備份複製所需資料的時間。快照並非要用來取代儲存池的完整備份，但可以用在快速且簡單的保存某個特定時間點的資料集。\n建立快照 快照可以使用 zfs snapshot dataset@snapshotname 來建立。加入 -r 可以遞迴對所有同名的子資料集建立快照。\n建立一個整個儲存池的遞迴快照：\n# zfs list -t all NAME USED AVAIL REFER MOUNTPOINT mypool 780M 93.2G 144K none mypool/ROOT 777M 93.2G 144K none mypool/ROOT/default 777M 93.2G 777M / mypool/tmp 176K 93.2G 176K /tmp mypool/usr 616K 93.2G 144K /usr mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/ports 144K 93.2G 144K /usr/ports mypool/usr/src 144K 93.2G 144K /usr/src mypool/var 1.29M 93.2G 616K /var mypool/var/crash 148K 93.2G 148K /var/crash mypool/var/log 178K 93.2G 178K /var/log mypool/var/mail 144K 93.2G 144K /var/mail mypool/var/newname 87.5K 93.2G 87.5K /var/newname mypool/var/newname@new_snapshot_name 0 - 87.5K - mypool/var/tmp 152K 93.2G 152K /var/tmp # zfs snapshot -r mypool@my_recursive_snapshot # zfs list -t snapshot NAME USED AVAIL REFER MOUNTPOINT mypool@my_recursive_snapshot 0 - 144K - mypool/ROOT@my_recursive_snapshot 0 - 144K - mypool/ROOT/default@my_recursive_snapshot 0 - 777M - mypool/tmp@my_recursive_snapshot 0 - 176K - mypool/usr@my_recursive_snapshot 0 - 144K - mypool/usr/home@my_recursive_snapshot 0 - 184K - mypool/usr/ports@my_recursive_snapshot 0 - 144K - mypool/usr/src@my_recursive_snapshot 0 - 144K - mypool/var@my_recursive_snapshot 0 - 616K - mypool/var/crash@my_recursive_snapshot 0 - 148K - mypool/var/log@my_recursive_snapshot 0 - 178K - mypool/var/mail@my_recursive_snapshot 0 - 144K - mypool/var/newname@new_snapshot_name 0 - 87.5K - mypool/var/newname@my_recursive_snapshot 0 - 87.5K - mypool/var/tmp@my_recursive_snapshot 0 - 152K - 建立的快照不會顯示在一般的 zfs list 操作結果，要列出快照需在 zfs list 後加上 -t snapshot，使用 -t all 可以同時列出檔案系統的內容及快照。\n快照並不會直接掛載，因此 MOUNTPOINT 欄位的路徑如此顯示。在 AVAIL 欄位不會有可用的磁碟空間，因為快照建立之後便無法再寫入。比較快照與其原來建立時的資料集：\n# zfs list -rt all mypool/usr/home NAME USED AVAIL REFER MOUNTPOINT mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/home@my_recursive_snapshot 0 - 184K - 同時顯示資料集與快照可以了解快照如何使用 COW 技術來運作。快照只會保存有更動 (差異) 的資料，並非整個檔案系統的內容，這個意思是說，快照只會在有做更動時使用一小部份的空間，複製一個檔案到該資料集，可以讓空間使用量變的更明顯，然後再做第二個快照：\n# cp /etc/passwd /var/tmp # zfs snapshot mypool/var/tmp@after_cp # zfs list -rt all mypool/var/tmp NAME USED AVAIL REFER MOUNTPOINT mypool/var/tmp 206K 93.2G 118K /var/tmp mypool/var/tmp@my_recursive_snapshot 88K - 152K - mypool/var/tmp@after_cp 0 - 118K - 第二快照只會包含了資料集做了複製動作後的更動，這樣的機制可以節省大量的空間。注意在複製之後快照 mypool/var/tmp@my_recursive_snapshot 於 USED 欄位中的大小也更改了，這說明了這個更動在前次快照與之後快照間的關係。\n比對快照 ZFS 提供了內建指令可以用來比對兩個快照 (Snapshot) 之間的差異，在使用者想要查看一段時間之間檔案系統所的變更時非常有用。例如 zfs diff 可以讓使用者在最後一次快照中找到意外刪除的檔案。對前面一節所做的兩個快照使用這個指令會產生以下結果：\n# zfs list -rt all mypool/var/tmp NAME USED AVAIL REFER MOUNTPOINT mypool/var/tmp 206K 93.2G 118K /var/tmp mypool/var/tmp@my_recursive_snapshot 88K - 152K - mypool/var/tmp@after_cp 0 - 118K - # zfs diff mypool/var/tmp@my_recursive_snapshot M /var/tmp/ + /var/tmp/passwd 指令會列出指定快照 (在這個例子中為 mypool/var/tmp@my_recursive_snapshot) 與目前檔案系統間的更改。第一個欄位是更改的類型：\n   类型 含义     + 加入了該路徑或檔案。   - 刪除了該路徑或檔案。   M 修改了該路徑或檔案。   R 重新命名了該路徑或檔案。    對照這個表格來看輸出的結果，可以明顯的看到 passwd 是在快照 mypool/var/tmp@my_recursive_snapshot 建立之後才加入的，結果也同樣看的到掛載到 /var/tmp 的父目錄已經做過修改。\n在使用 ZFS 備份功能來傳輸一個資料集到另一個主機備份時比對兩個快照也同樣很有用。\n比對兩個快照需要提供兩個資料集的完整資料集名稱與快照名稱：\n# cp /var/tmp/passwd /var/tmp/passwd.copy # zfs snapshot mypool/var/tmp@diff_snapshot # zfs diff mypool/var/tmp@my_recursive_snapshot mypool/var/tmp@diff_snapshot M /var/tmp/ + /var/tmp/passwd + /var/tmp/passwd.copy # zfs diff mypool/var/tmp@my_recursive_snapshot mypool/var/tmp@after_cp M /var/tmp/ + /var/tmp/passwd 備份管理者可以比對兩個自傳送主機所接收到的兩個快照並查看實際在資料集中的變更。請參考 備份 一節來取得更多資訊。\n使用快照還原 只要至少有一個可用的快照便可以隨時還原。大多數在已不需要目前資料集，想要改用較舊版的資料的情況，例如，本地開發的測試發生錯誤、不良的系統更新破壞了系統的整體功能或需要還原意外刪除檔案或目錄 … 等，都是非常常見的情形。幸運的，要還原到某個快照只需要簡單輸入 zfs rollback snapshotname。會依快照所做的變更數量來決定處理的時間，還原的操作會在一段時間後完成。在這段時間中，資料集會一直保持一致的狀態，類似一個符合 ACID 原則的資料庫在做還原。還原可在資料集處於上線及可存取的情況下完成，不需要停機。還原到快照之後，資料集便回到當初執行快照時相同的狀態，所有沒有在快照中的其他資料便會被丟棄，因此往後若還有可能需要部份資料時，建議在還原到前一個快照之前先對目前的資料集做快照，這樣一來，使用者便可以在快照之間來回快換，而不會遺失重要的資料。\n在第一個範例中，因為 rm 操作不小心移除了預期外的資料，要還原到快照。\n# zfs list -rt all mypool/var/tmp NAME USED AVAIL REFER MOUNTPOINT mypool/var/tmp 262K 93.2G 120K /var/tmp mypool/var/tmp@my_recursive_snapshot 88K - 152K - mypool/var/tmp@after_cp 53.5K - 118K - mypool/var/tmp@diff_snapshot 0 - 120K - # ls /var/tmp passwd passwd.copy vi.recover # rm /var/tmp/passwd* # ls /var/tmp vi.recover 在此時，使用者發現到刪除了太多檔案並希望能夠還原。ZFS 提供了簡單的方可以取回檔案，便是使用還原 (Rollback)，但這只在有定期對重要的資料使用快照時可用。要拿回檔案並從最後一次快照重新開始，可執行以下指令：\n# zfs rollback mypool/var/tmp@diff_snapshot # ls /var/tmp passwd passwd.copy vi.recover 還原操作會將資料集還原為最後一次快照的狀態。這也可以還原到更早之前，有其他在其之後建立的快照。要這麼做時，ZFS 會發出這個警告：\n# zfs list -rt snapshot mypool/var/tmp AME USED AVAIL REFER MOUNTPOINT mypool/var/tmp@my_recursive_snapshot 88K - 152K - mypool/var/tmp@after_cp 53.5K - 118K - mypool/var/tmp@diff_snapshot 0 - 120K - # zfs rollback mypool/var/tmp@my_recursive_snapshot cannot rollback to 'mypool/var/tmp@my_recursive_snapshot': more recent snapshots exist use '-r' to force deletion of the following snapshots: mypool/var/tmp@after_cp mypool/var/tmp@diff_snapshot 這個警告是因在該快照與資料集的目前狀態之間有其他快照存在，然而使用者想要還原到該快照。要完成這樣的還原動作，必須刪除在這之間的快照，因為 ZFS 無法追蹤不同資料集狀態間的變更。在使用者未指定 -r 來確認這個動作前，ZFS 不會刪除受影響的快照。若確定要這麼做，那麼必須要知道會遺失所有在這之間的快照，然後可執行以下指令：\n# zfs rollback -r mypool/var/tmp@my_recursive_snapshot # zfs list -rt snapshot mypool/var/tmp NAME USED AVAIL REFER MOUNTPOINT mypool/var/tmp@my_recursive_snapshot 8K - 152K - # ls /var/tmp vi.recover 可從 zfs list -t snapshot 的結果來確認 zfs rollback -r 會移除的快照。\n從快照還原個別檔案 快照會掛載在父資料集下的隱藏目錄：.zfs/snapshots/snapshotname。預設不會顯示這些目錄，即使是用 ls -a 指令。雖然該目錄不會顯示，但該目錄實際存在，而且可以像一般的目錄一樣存取。一個名稱為 snapdir 的屬性可以控制是否在目錄清單中顯示這些隱藏目錄，設定該屬性為可見 (visible) 可以讓這些目錄出現在 ls 以及其他處理目錄內容的指令中。\n# zfs get snapdir mypool/var/tmp NAME PROPERTY VALUE SOURCE mypool/var/tmp snapdir hidden default # ls -a /var/tmp . .. passwd vi.recover # zfs set snapdir=visible mypool/var/tmp # ls -a /var/tmp . .. .zfs passwd vi.recover 要還原個別檔案到先前的狀態非常簡單，只要從快照中複製檔案到父資料集。在 .zfs/snapshot 目錄結構下有一個與先前所做的快照名稱相同的目錄，可以很容易的找到。在下個範例中，我們會示範從隱藏的 .zfs 目錄還原一個檔案，透過從含有該檔案的最新版快照複製：\n# rm /var/tmp/passwd # ls -a /var/tmp . .. .zfs vi.recover # ls /var/tmp/.zfs/snapshot after_cp my_recursive_snapshot # ls /var/tmp/.zfs/snapshot/after_cp passwd vi.recover # cp /var/tmp/.zfs/snapshot/after_cp/passwd /var/tmp 執行 ls .zfs/snapshot 時，雖然 snapdir 可能已經設為隱藏，但仍可能可以顯示該目錄中的內容，這取決於管理者是否要顯示這些目錄，可以只顯示特定的資料集，而其他的則不顯示。從這個隱藏的 .zfs/snapshot 複製檔案或目錄非常簡單，除此之外，嘗試其他的動作則會出現以下錯誤：\n# cp /etc/rc.conf /var/tmp/.zfs/snapshot/after_cp/ cp: /var/tmp/.zfs/snapshot/after_cp/rc.conf: Read-only file system 這個錯誤用來提醒使用者快照是唯讀的，在建立之後不能更改。無法複製檔案進去或從該快照目錄中移除，因為這會變更該資料集所代表的狀態。\n快照所消耗的空間是依據自快照之後父檔案系統做了多少變更來決定，快照的 written 屬性可以用來追蹤有多少空間被快照所使用。\n使用 zfs destroy dataset@snapshot 可以摧毀快照並回收空間。加上 -r 可以遞迴移除所有在父資料集下使用同名的快照。加入 -n -v 來顯示將要移除的快照清單以及估計回收的空間，而不會實際執行摧毀的操作。\n管理複本 (Clone) 複本 (Clone) 是快照的複製，但更像是一般的資料集，與快照不同的是，複本是非唯讀的 (可寫)，且可掛載，可以有自己的屬性。使用 zfs clone 建立複本之後，便無法再摧毀用來建立複本的快照。複本與快照的父/子關係可以使用 zfs promote 來對換。提升複本之後 ，快照便會成為複本的子資料集，而不是原來的父資料集，這個動作會改變空間計算的方式，但並不會實際改變空間的使用量。複本可以被掛載到 ZFS 檔案系統階層中的任何一點，並非只能位於原來快照的位置底下。\n要示範複本功能會用到這個範例資料集：\n# zfs list -rt all camino/home/joe NAME USED AVAIL REFER MOUNTPOINT camino/home/joe 108K 1.3G 87K /usr/home/joe camino/home/joe@plans 21K - 85.5K - camino/home/joe@backup 0K - 87K - 會使用到複本一般是要在可以保留快照以便出錯時可還原的情況下使用指定的資料集做實驗，由於快照並無法做更改，所以會建立一個可以讀/寫的快照複本。當在複本中做完想要執行的動作後，便可以提升複本成資料集，然後移除舊的檔案系統。嚴格來說這並非必要，因為複本與資料集可同時存在，不會有任何問題。\n# zfs clone camino/home/joe@backup camino/home/joenew # ls /usr/home/joe* /usr/home/joe: backup.txz plans.txt /usr/home/joenew: backup.txz plans.txt # df -h /usr/home Filesystem Size Used Avail Capacity Mounted on usr/home/joe 1.3G 31k 1.3G 0% /usr/home/joe usr/home/joenew 1.3G 31k 1.3G 0% /usr/home/joenew 建立完的複本便有與建立快照時狀態相同的資料集，現在複本可以獨立於原來的資料集來做更改。剩下唯一與資料集之間的關係便是快照，ZFS 會在屬性 origin 記錄這個關係，一旦在快照與複本之間的相依關係因為使用 zfs promote 提升而移除時，複本的 origin 也會因為成為一個完全獨立的資料集而移除。以下範例會示範這個動作：\n# zfs get origin camino/home/joenew NAME PROPERTY VALUE SOURCE camino/home/joenew origin camino/home/joe@backup - # zfs promote camino/home/joenew # zfs get origin camino/home/joenew NAME PROPERTY VALUE SOURCE camino/home/joenew origin - - 做為部份更改之後，例如複製 loader.conf 到提升後的複本，這個例子中的舊目錄便無須保留，取而代之的是提升後的複本，這個動作可以用兩個連續的指令來完成：在舊資料集上執行 zfs destroy 並在與舊資料相似名稱 (也可能用完全不同的名稱) 的複本上執行 zfs rename。\n# cp /boot/defaults/loader.conf /usr/home/joenew # zfs destroy -f camino/home/joe # zfs rename camino/home/joenew camino/home/joe # ls /usr/home/joe backup.txz loader.conf plans.txt # df -h /usr/home Filesystem Size Used Avail Capacity Mounted on usr/home/joe 1.3G 128k 1.3G 0% /usr/home/joe 快照的複本現在可以如同一般資料集一樣使用，它的內容包含了所有來自原始快照的資料以及後來加入的檔案，例如 loader.conf。複本可以在許多不同的情境下使用提供 ZFS 的使用者有用的功能，例如，Jail 可以透過含有已安裝了各種應用程式集的快照來提供，使用者可以複製這些快照然後加入自己想要嘗試的應用程式，一但更改可以滿足需求，便可提升複本為完整的資料集然後提供給終端使用者，讓終端使用者可以如同實際擁有資料集一般的使用，這個以節省提供這些 Jail 的時間與管理成本。\n備份 (Replication) 將資料保存在單一地點的單一儲存池上會讓資料暴露在盜竊、自然或人為的風險之下，定期備份整個儲存池非常重要，ZFS 提供了內建的序列化 (Serialization) 功能可以將資料以串流傳送到標準輸出。使用這項技術，不僅可以將資料儲存到另一個已連結到本地系統的儲存池，也可以透過網路將資料傳送到另一個系統，這種備份方式以快照為基礎 (請參考章節 ZFS 快照(Snapshot))。用來備份資料的指令為 zfs send 及 zfs receive。\n以下例子將示範使用兩個儲存池來做 ZFS 備份：\n# zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT backup 960M 77K 896M - - 0% 0% 1.00x ONLINE - mypool 984M 43.7M 940M - - 0% 4% 1.00x ONLINE - 名為 mypool 的儲存池為主要的儲存池，資料會定期寫入與讀取的位置。第二個儲存池 backup 用來待命 (Standby)，萬一主要儲存池無法使用時可替換。注意，ZFS 並不會自動做容錯移轉 (Fail-over)，必須要由系統管理者在需要的時候手動完成。快照會用來提供一個與檔系統一致的版本來做備份，mypool 的快照建立之後，便可以複製到 backup 儲存池，只有快照可以做備份，最近一次快照之後所做的變更不會含在內容裡面。\n# zfs snapshot mypool@backup1 # zfs list -t snapshot NAME USED AVAIL REFER MOUNTPOINT mypool@backup1 0 - 43.6M - 快照存在以後，便可以使用 zfs send 來建立一個代表快照內容的串流，這個串流可以儲存成檔案或由其他儲存池接收。串流會寫入到標準輸出，但是必須要重新導向到一個檔案或轉接到其他地方，否則會錯誤：\n# zfs send mypool@backup1 Error: Stream can not be written to a terminal. You must redirect standard output. 要使用 zfs send 備份一個資料集，可重新導向到一個位於在已掛載到備份儲存池上的檔案。確定該儲存池有足夠的空間容納要傳送的快照，這裡指的是該快照中內含的所有資料，並非只有上次快照到該快照間的變更。\n# zfs send mypool@backup1  /backup/backup1 # zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT backup 960M 63.7M 896M - - 0% 6% 1.00x ONLINE - mypool 984M 43.7M 940M - - 0% 4% 1.00x ONLINE - zfs send 會傳輸在快照 backup1 中所有的資料到儲存池 backup。可以使用 cron(8) 排程來自動完成建立與傳送快照的動作。\n若不想將備份以封存檔案儲存，ZFS 可用實際的檔案系統來接收資料，讓備份的資料可以直接被存取。要取得實際包含在串流中的資料可以用 zfs receive 將串流轉換回檔案與目錄。以下例子會以管線符號連接 zfs send 及 zfs receive，將資料從一個儲存池複製到另一個，傳輸完成後可以直接使用接收儲存池上的資料。一個資料集只可以被複製到另一個空的資料集。\n# zfs snapshot mypool@replica1 # zfs send -v mypool@replica1 | zfs receive backup/mypool send from @ to mypool@replica1 estimated size is 50.1M total estimated size is 50.1M TIME SENT SNAPSHOT # zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT backup 960M 63.7M 896M - - 0% 6% 1.00x ONLINE - mypool 984M 43.7M 940M - - 0% 4% 1.00x ONLINE - 漸進式備份 zfs send 也可以比較兩個快照之間的差異，並且只傳送兩者之間的差異，這麼做可以節省磁碟空間及傳輸時間。例如：\n# zfs snapshot mypool@replica2 # zfs list -t snapshot NAME USED AVAIL REFER MOUNTPOINT mypool@replica1 5.72M - 43.6M - mypool@replica2 0 - 44.1M - # zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT backup 960M 61.7M 898M - - 0% 6% 1.00x ONLINE - mypool 960M 50.2M 910M - - 0% 5% 1.00x ONLINE - 會建立一個名為 replica2 的第二個快照，這個快照只中只會含有目前與前次快照 replica1 之間檔案系統所做的變更。使用 zfs send -i 並指定要用來產生漸進備份串流的快照，串流中只會含有做過更改的資料。這個動作只在接收端已經有初始快照時才可用。\n# zfs send -v -i mypool@replica1 mypool@replica2 | zfs receive /backup/mypool send from @replica1 to mypool@replica2 estimated size is 5.02M total estimated size is 5.02M TIME SENT SNAPSHOT # zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT backup 960M 80.8M 879M - - 0% 8% 1.00x ONLINE - mypool 960M 50.2M 910M - - 0% 5% 1.00x ONLINE - # zfs list NAME USED AVAIL REFER MOUNTPOINT backup 55.4M 240G 152K /backup backup/mypool 55.3M 240G 55.2M /backup/mypool mypool 55.6M 11.6G 55.0M /mypool # zfs list -t snapshot NAME USED AVAIL REFER MOUNTPOINT backup/mypool@replica1 104K - 50.2M - backup/mypool@replica2 0 - 55.2M - mypool@replica1 29.9K - 50.0M - mypool@replica2 0 - 55.0M - 如此一來，便成功傳輸漸進式的串流，只有做過更改的資料會被備份，不會傳送完整的 replica1。由於不會備份完整的儲存池，只傳送差異的部份，所以可以減少傳輸的時間並節省磁碟空間，特別是在網路緩慢或需要考量每位元傳輸成本時非常有用。\n從儲存池 mypool 複製所有檔案與資料的新檔案系統 backup/mypool 便可以使用。若指定 -P，會一併複製資料集的屬性，這包含壓縮 (Compression) 設定，配額 (Quota) 及掛載點 (Mount point)。若指定 -R，會複製所有指定資料集的子資料集，及這些子資料集的所有屬性。可將傳送與接收自動化來定期使用第二個儲存池做備份。\n透過 SSH 傳送加密的備份 透過網路來傳送串流是一個做遠端備份不錯的方式，但是也有一些缺點，透過網路連線傳送的資料沒有加密，這會讓任何人都可以在未告知傳送方的情況下攔截並轉換串流回資料，這是我們所不想見到的情況，特別是在使用網際網路傳送串流到遠端的主機時。SSH 可用來加密要透過網路連線傳送的資料，在 ZFS 只需要將串流重新導向到標準輸出，如此一來便可簡單的轉接到 SSH。若要讓檔案系統內容在傳送或在遠端系統中也維持在加密的狀態可考慮使用 PEFS。\n有一些設定以及安全性注意事項必須先完成，只有對 zfs send 操作必要的步驟才會在此說明，要取得更多有關 SSH 的資訊請參考 OpenSSH。\n必要的環境設定：\n  使用 SSH 金鑰設定傳送端與接收端間無密碼的 SSH 存取\n  正常會需要 root 的權限來傳送與接收串流，這需要可以 root 登入到接收端系統。但是，預設因安全性考慮會關閉以 root 登入。ZFS 委託 (ZFS Delegation) 系統可以用來允許一個非 root 使用者在每個系統上執行各自的發送與接收操作。\n  在傳送端系統上：\n# zfs allow -u someuser send,snapshot mypool   要掛載儲存池，無權限的使用者必須擁有該目錄且必須允許一般的使用者掛載檔案系統。在接收端系統上：\n# sysctl vfs.usermount=1 vfs.usermount: 0 - 1 # sysrc -f /etc/sysctl.conf vfs.usermount=1 # zfs create recvpool/backup # zfs allow -u someuser create,mount,receive recvpool/backup # chown someuser /recvpool/backup   無權限的使用者現在有能力可以接收並掛載資料集，且 home 資料集可以被複製到遠端系統：\n% zfs snapshot -r mypool/home@monday % zfs send -R mypool/home@monday | ssh someuser@backuphost zfs recv -dvu recvpool/backup 替儲存在儲存池 mypool 上的檔案系統資料集 home 製作一個遞迴快照 monday，然後使用 zfs send -R 來傳送包含該資料集及其所有子資料集、快照、複製與設定的串流。輸出會被導向到 SSH 連線的遠端主機 backuphost 上等候輸入的 zfs receive，在此建議使用完整網域名稱或 IP 位置。接收端的機器會寫入資料到 recvpool 儲存池上的 backup 資料集，在 zfs recv 加上 -d 可覆寫在接收端使用相同名稱的快照，加上 -u 可讓檔案系統在接收端不會被掛載，當使用 -v，會顯示更多有關傳輸的詳細資訊，包含已花費的時間及已傳輸的資料量。\n資料集、使用者以及群組配額 資料集配額 (Dataset quota) 可用來限制特定資料集可以使用的的空間量。參考配額 (Reference Quota) 的功能也非常相似，差在參考配額只會計算資料集自己使用的空間，不含快照與子資料集。類似的，使用者 (User) 與群組 (Group) 配額可以用來避免使用者或群組用掉儲存池或資料集的所有空間。\n要設定 storage/home/bob 的資料集配額為 10 GB：\n# zfs set quota=10G storage/home/bob 要設定 storage/home/bob 的參考配額為 10 GB：\n# zfs set refquota=10G storage/home/bob 要移除 storage/home/bob 的 10 GB 配額：\n# zfs set quota=none storage/home/bob 設定使用者配額的一般格式為 userquota@user=size 使用者的名稱必須使用以下格式：\n POSIX 相容的名稱，如 joe。 POSIX 數字 ID，如 789。 SID 名稱，如 joe.bloggs@example.com。 SID 數字 ID，如 S-1-123-456-789。  例如，要設定使用者名為 joe 的使用者配額為 50 GB：\n# zfs set userquota@joe=50G 要移除所有配額：\n# zfs set userquota@joe=none  使用者配額的屬性不會顯示在 zfs get all。非 root 的使用者只可以看到自己的配額，除非它們有被授予 userquota 權限，擁有這個權限的使用者可以檢視與設定任何人的配額。\n 要設定群組配額的一般格式為：groupquota@group=size。\n要設定群組 firstgroup 的配額為 50 GB 可使用：\n# zfs set groupquota@firstgroup=50G 要移除群組 firstgroup 的配額，或確保該群組未設定配額可使用：\n# zfs set groupquota@firstgroup=none 如同使用者配額屬性，非 root 使用者只可以查看自己所屬群組的配額。而 root 或擁有 groupquota 權限的使用者，可以檢視並設定所有群組的任何配額。\n要顯示在檔案系統或快照上每位使用者所使用的空間量及配額可使用 zfs userspace，要取得群組的資訊則可使用 zfs groupspace，要取得有關支援的選項資訊或如何只顯示特定選項的資訊請參考 zfs(1)。\n有足夠權限的使用者及 root 可以使用以下指令列出 storage/home/bob 的配額：\n# zfs get quota storage/home/bob 保留空間 保留空間 (Reservation) 可以確保資料集最少可用的空間量，其他任何資料集無法使用保留的空間，這個功能在要確保有足夠的可用空間來存放重要的資料集或日誌檔時特別有用。\nreservation 屬性的一般格式為 reservation=size，所以要在 storage/home/bob 設定保留 10 GB 的空間可以用：\n# zfs set reservation=10G storage/home/bob 要清除任何保留空間：\n# zfs set reservation=none storage/home/bob 同樣的原則可以應用在 refreservation 屬性來設定參考保留空間 (Reference Reservation)，參考保留空間的一般格式為 refreservation=size。\n這個指令會顯示任何已設定於 storage/home/bob 的 reservation 或 refreservation：\n# zfs get reservation storage/home/bob # zfs get refreservation storage/home/bob 壓縮 (Compression) ZFS 提供直接的壓縮功能，在資料區塊層級壓縮資料不僅可以節省空間，也可以增加磁碟的效能。若資料壓縮了 25%，但壓縮的資料會使用了與未壓縮版本相同的速率寫入到磁碟，所以實際的寫入速度會是原來的 125%。壓縮功能也可來替代去重複 (Deduplication) 功能，因為壓縮並不需要使用額外的記憶體。\nZFS 提了多種不同的壓縮演算法，每一種都有不同的優缺點，隨著 ZFS v5000 引進了 LZ4 壓縮技術，可對整個儲存池開啟壓縮，而不像其他演算法需要消耗大量的效能來達成，最大的優點是 LZ4 擁有 提早放棄 的功能，若 LZ4 無法在資料一開始的部份達成至少 12.5% 的壓縮率，便會以不壓縮的方式來寫入資料區塊來避免 CPU 在那些已經壓縮過或無法壓縮的資料上浪費運算能力。要取得更多有關 ZFS 中可用的壓縮演算法詳細資訊，可參考術語章節中的壓縮 (Compression) 項目。\n管理者可以使用資料集的屬性來監視壓縮的效果。\n# zfs get used,compressratio,compression,logicalused mypool/compressed_dataset NAME PROPERTY VALUE SOURCE mypool/compressed_dataset used 449G - mypool/compressed_dataset compressratio 1.11x - mypool/compressed_dataset compression lz4 local mypool/compressed_dataset logicalused 496G - 資料集目前使用了 449 GB 的空間 (在 used 屬性)。在尚未壓縮前，該資料集應該會使用 496 GB 的空間 (於 logicalused 屬性)，這個結果顯示目前的壓縮比為 1.11:1。\n壓縮功能在與使用者配額 (User Quota) 一併使用時可能會產生無法預期的副作用。使用者配額會限制一個使用者在一個資料集上可以使用多少空間，但衡量的依據是以 壓縮後 所使用的空間，因此，若一個使用者有 10 GB 的配額，寫入了 10 GB 可壓縮的資料，使用者將還會有空間儲存額外的資料。若使用者在之後更新了一個檔案，例如一個資料庫，可能有更多或較少的可壓縮資料，那麼剩餘可用的空間量也會因此而改變，這可能會造成奇怪的現象便是，一個使用者雖然沒有增加實際的資料量 (於 logicalused 屬性)，但因為更改影響了壓縮率，導致使用者達到配額的上限。\n壓縮功能在與備份功能一起使用時也可能會有類似的問題，通常會使用配額功能來限制能夠儲存的資料量來確保有足夠的備份空間可用。但是由於配額功能並不會考量壓縮狀況，可能會有比未壓縮版本備份更多的資料量會被寫入到資料集。\n去重複 (Deduplication) 當開啟，去重複 (Deduplication) 功能會使用每個資料區塊的校驗碼 (Checksum) 來偵測重複的資料區塊，當新的資料區塊與現有的資料區塊重複，ZFS 便會寫入連接到現有資料的參考來替代寫入重複的資料區塊，這在資料中有大量重複的檔案或資訊時可以節省大量的空間，要注意的是：去重複功能需要使用大量的記憶體且大部份可節省的空間可改開啟壓縮功能來達成，而壓縮功能不需要使用額外的記憶體。\n要開啟去重複功能，需在目標儲存池設定 dedup 屬性：\n# zfs set dedup=on pool 只有要被寫入到儲存池的新資料才會做去重複的動作，先前已被寫入到儲存池的資料不會因此啟動了這個選項而做去重複。查看已開啟去重複屬性的儲存池會如下：\n# zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT pool 2.84G 2.19M 2.83G - - 0% 0% 1.00x ONLINE - DEDUP 欄位會顯示儲存池的實際去重複率，數值為 1.00x 代表資料尚未被去重複。在下一個例子會在前面所建立的去重複儲存池中複製三份 Port 樹到不同的目錄中。\n# for d in dir1 dir2 dir3; do  mkdir $d \u0026\u0026 cp -R /usr/ports $d \u0026  done 已經偵測到重複的資料並做去重複：\n# zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT pool 2.84G 20.9M 2.82G - - 0% 0% 3.00x ONLINE - DEDUP 欄位顯示有 3.00x 的去重複率，這代表已偵測到多份複製的 Port 樹資料並做了去重複的動作，且只會使用第三份資料所佔的空間。去重複能節省空間的潛力可以非常巨大，但會需要消耗大量的記憶體來持續追蹤去重複的資料區塊。\n去重複並非總是有效益的，特別是當儲存池中的資料本身並沒有重複時。ZFS 可以透過在現有儲存池上模擬開啟去重複功能來顯示可能節省的空間：\n# zdb -S pool Simulated DDT histogram: bucket allocated referenced ______ ______________________________ ______________________________ refcnt blocks LSIZE PSIZE DSIZE blocks LSIZE PSIZE DSIZE ------ ------ ----- ----- ----- ------ ----- ----- ----- 1 2.58M 289G 264G 264G 2.58M 289G 264G 264G 2 206K 12.6G 10.4G 10.4G 430K 26.4G 21.6G 21.6G 4 37.6K 692M 276M 276M 170K 3.04G 1.26G 1.26G 8 2.18K 45.2M 19.4M 19.4M 20.0K 425M 176M 176M 16 174 2.83M 1.20M 1.20M 3.33K 48.4M 20.4M 20.4M 32 40 2.17M 222K 222K 1.70K 97.2M 9.91M 9.91M 64 9 56K 10.5K 10.5K 865 4.96M 948K 948K 128 2 9.50K 2K 2K 419 2.11M 438K 438K 256 5 61.5K 12K 12K 1.90K 23.0M 4.47M 4.47M 1K 2 1K 1K 1K 2.98K 1.49M 1.49M 1.49M Total 2.82M 303G 275G 275G 3.20M 319G 287G 287G dedup = 1.05, compress = 1.11, copies = 1.00, dedup * compress / copies = 1.16 在 zdb -S 分析完儲存池後會顯示在啟動去重複後可達到的空間減少比例。在本例中，1.16 是非常差的空間節省比例，因為這個比例使用壓縮功能便能達成。若在此儲存池上啟動去重複並不能明顯的節省空間使用量，那麼就不值得耗費大量的記憶體來開啟去重複功能。透過公式 ratio = dedup * compress / copies，系統管理者可以規劃儲存空間的配置，來判斷要處理的資料是否有足夠的重複資料區塊來平衡所需的記憶體。若資料是可壓縮的，那麼空間節少的效果可能會非常好，建議先開啟壓縮功能，且壓縮功能也可以大大提高效能。去重複功能只有在可以節省可觀的空間且有足夠的記憶體做 DDT 時才開啟。\nZFS 與 Jail zfs jail 以及相關的 jailed 屬性可以用來將一個 ZFS 資料集委託給一個 Jail 管理。zfs jail *jailid* 可以將一個資料集連結到一個指定的 Jail，而 zfs unjail 則可解除連結。資料集要可以在 Jail 中控制需設定 jailed 屬性，一旦資料集被隔離便無法再掛載到主機，因為有掛載點可能會破壞主機的安全性。\n委託管理 一個全面性的權限委託系統可能無權限的使用者執行 ZFS 的管理功能。例如，若每個使用者的家目錄均為一個資料集，便可以給予使用者權限建立與摧毀它們家目錄中的快照。可以給予備份使用者使用備份功能的權限。一個使用量統計的 Script 可以允許其在執行時能存取所有使用者的空間利用率資料。甚至可以將委託權限委託給其他人，每個子指令與大多數屬性都可使用權限委託。\n委託資料集建立 zfs allow someuser create mydataset 可以給予指定的使用者在指定的父資料集下建立子資料集的權限。這裡需要注意：建立新資料集會牽涉到掛載，因此需要設定 FreeBSD 的 vfs.usermount sysctl(8) 為 1 來允許非 root 的使用者掛載一個檔案系統。這裡還有另一項限制可以避免濫用：非 root 使用者必須擁有掛載點在檔案系統中所在位置的權限才可掛載。\n委託權限委託 zfs allow someuser allow mydataset 可以給予指定的使用者有權限指派它們在目標資料集或其子資料集上擁有的任何權限給其他人。若該使用者擁有 snapshot 權限及 allow 權限，則該使用者可以授權 snapshot 權限給其他使用者。\n進階主題 調校 這裡有數個可調校的項目可以調整，來讓 ZFS 在面對各種工作都能以最佳狀況運作。\n…\ni386 上的 ZFS ZFS 所提供的部份功能需要使用大量記憶體，且可能需要對有限 RAM 的系統調校來取得最佳的效率。\n記憶體 最低需求，總系統記憶體應至少有 1 GB，建議的 RAM 量需視儲存池的大小以及使用的 ZFS 功能而定。一般的經驗法則是每 1 TB 的儲存空間需要 1 GB 的 RAM，若有開啟去重複的功能，一般的經驗法則是每 1 TB 的要做去重複的儲存空間需要 5 GB 的 RAM。雖然有部份使用者成功使用較少的 RAM 來運作 ZFS，但系統在負載較重時有可能會因為記憶用耗而導致當機，對於要使用低於建議 RAM 需求量來運作的系統可能會需要更進一步的調校。\n核心設定 由於在 i386™ 平台上位址空間的限制，在 i386™ 架構上的 ZFS 使用者必須加入這個選項到自訂核心設定檔，重新編譯核心並重新開啟：\noptions KVA_PAGES=512 這個選項會增加核心位址空間，允許調整 vm.kvm_size 超出目前的 1 GB 限制或在 PAE 的 2 GB 限制。要找到這個選項最合適的數值，可以將想要的位址空間換算成 MB 然後除以 4，在本例中，以 2 GB 計算後即為 512。\n載入程式可調參數 在所有的 FreeBSD 架構上均可增加 kmem 位址空間，經測試在一個 1 GB 實體記憶體的測試系統上，加入以下選項到 /boot/loader.conf，重新開啟系統，可成功設定：\nvm.kmem_size=\"330M\" vm.kmem_size_max=\"330M\" vfs.zfs.arc_max=\"40M\" vfs.zfs.vdev.cache.size=\"5M\" 要取得更多詳細的 ZFS 相關調校的建議清單，請參考 https://wiki.freebsd.org/ZFSTuningGuide。\n其他資源  FreeBSD Wiki - ZFS FreeBSD Wiki - ZFS Tuning Illumos Wiki - ZFS Oracle Solaris ZFS Administration Guide Calomel Blog - ZFS Raidz Performance, Capacity and Integrity  特色與術語 ZFS 是一個從本質上與眾不同的檔案系統，由於它並非只是一個檔案系統，ZFS 結合了檔案系統及磁碟區管理程式，讓額外的儲存裝置可以即時的加入到系統並可讓既有的檔案系統立即使用這些在儲存池中空間。透過結合傳統區分為二的兩個角色，ZFS 能夠克服以往 RAID 磁碟群組無法擴充的限制。每個在儲存池頂層的裝置稱作 vdev，其可以是一個簡單的磁碟或是一個 RAID 如鏡像或 RAID-Z 陣列。ZFS 的檔案系統 (稱作 資料集 (Dataset)) 每一個資料集均可存取整個存池所共通的可用空間，隨著使用儲存池來配置空間區塊，儲存池能給每個檔案系統使用的可用空間就會減少，這個方法可以避免擴大分割區會使的可用空間分散分割區之間的常見問題。\n   術語 含义     儲存池 (Pool) 儲存池 (Pool) 是建構 ZFS 最基礎的單位。一個儲存池可由一個或多個 vdev 所組成，是用來儲存資料的底層裝置。儲存池會被拿來建立一個或多個檔案系統 (資料集 Dataset) 或區塊裝置 (磁碟區 Volume)，這些資料集與磁碟區會共用儲存池的剩餘可用空間。每一個儲存池可由名稱與 GUID 來辨識。可用的功能會依儲存池上的 ZFS 版本而有不同。   vdev 型態 (vdev Types) 儲存池是由一個或多個 vdev 所組成，vdev 可以是一個磁碟或是 RAID Transform 的磁碟群組。當使用多個 vdev，ZFS 可以分散資料到各個 vdev 來增加效能與最大的可用空間。磁碟 (Disk) - 最基本的 vdev 型態便是一個標準的資料區塊裝置，這可以是一整個磁碟 (例如 /dev/ada0 或 /dev/da0) 或一個分割區 (/dev/ada0p3)。在 FreeBSD 上，使用分割區來替代整個磁碟不會影響效能，這可能與 Solaris 說明文件所建議的有所不同。檔案 (File) - 除了磁碟外，ZFS 儲存池可以使用一般檔案為基礎，這在測試與實驗時特別有用。在 zpool create 時使用檔案的完整路徑作為裝置路徑。所有 vdev 必須至少有 128 MB 的大小。鏡像 (Mirror) - 要建立鏡像，需使用 mirror 關鍵字，後面接著要做為該鏡像成員裝置的清單。一個鏡像需要由兩個或多個裝置來組成，所有的資料都會被寫入到所有的成員裝置。鏡像 vdev 可以對抗所有成員故障只剩其中一個而不損失任何資料。正常單一磁碟的 vdev 可以使用 zpool attach 隨時升級成為鏡像 vdev。RAID-Z - ZFS 實作了 RAID-Z，以標準的 RAID-5 修改而來，可提供奇偶校驗 (Parity) 更佳的分散性並去除了 “RAID-5 write hole” 導致在預期之外的重啟後資料與奇偶校驗資訊不一致的問題。ZFS 支援三個層級的 RAID-Z，可提供不同程度的備援來換取減少不同程度的可用空間，類型的名稱以陣列中奇偶校驗裝置的數量與儲存池可以容許磁碟故障的數量來命名，從 RAID-Z1 到 RAID-Z3 。在 RAID-Z1 配置 4 個磁碟，每個磁碟 1 TB，可用的儲存空間則為 3 TB，且若其中一個磁碟故障仍可以降級 (Degraded) 的模式運作，若在故障磁碟尚未更換並修復 (Resilver) 之前又有磁碟故障，所有在儲存池中的資料便會遺失。在 RAID-Z3 配置 8 個 1 TB 的磁碟，磁碟區將會可以提供 5 TB 的可用空間且在 3 個磁碟故障的情況下仍可運作。Sun™ 建議單一個 vdev 不要使用超過 9 個磁碟。若配置需要使用更多磁碟，建議分成兩個 vdev，這樣儲存池的資料便會分散到這兩個 vdev。使用兩個 RAID-Z2 各由 8 個磁碟組成的 vdev 的配置可以建立一個類似 RAID-60 的陣列。RAID-Z 群組的儲存空量會接近其中最小的磁碟乘上非奇偶校驗磁碟的數量。4 個 1 TB 磁碟在 RAID-Z1 會有接近 3 TB 的實際大小，且一個由 8 個 1 TB 磁碟組成的 RAID-Z3 陣列會有 5 TB 的可用空間。備援 (Spare) - ZFS 有特殊的虛擬 vdev 型態可用來持續追蹤可用的熱備援裝置 (Hot spare)。注意，安裝的熱備援裝置並不會自動佈署，熱備援裝置需要手動使用 zfs replace 設定替換故障的裝置。日誌 (Log) - ZFS 記錄裝置，也被稱作 ZFS 意圖日誌 (ZFS Intent Log, ZIL) 會從正常的儲存池裝置移動意圖日誌到獨立的裝置上，通常是一個 SSD。有了獨立的日誌裝置，可以明顯的增進有大量同步寫入應用程式的效能，特別是資料庫。日誌裝置可以做成鏡像，但不支援 RAID-Z，若使用多個日誌裝置，寫入動作會被負載平衡分散到這些裝置。快取 (Cache) - 加入快取 vdev 到儲存池可以增加儲存空間的 L2ARC 快取。快取裝置無法做鏡像，因快取裝置只會儲存額外的現有資料的複本，並沒有資料遺失的風險。   交易群組 (Transaction Group, TXG) 交易群組是一種將更動的資料區塊包裝成一組的方式，最後再一次寫入到儲存池。交易群組是 ZFS 用來檢驗一致性的基本單位。每個交易群組會被分配一個獨一無二的 64-bit 連續代號。最多一次可以有三個活動中的交易群組，這三個交易群組的每一個都有這三種狀態：* 開放 (Open) - 新的交易群組建立之後便處於開放的狀態，可以接受新的寫入動作。永遠會有開放狀態的交易群組，即始交易群組可能會因到達上限而拒絕新的寫入動作。一但開放的交易群組到達上限或到達 vfs.zfs.txg.timeout，交易群組便會繼續進入下一個狀態。 * 靜置中 (Quiescing) - 一個短暫的狀態，會等候任何未完成的操作完成，不會阻擋新開放的交易群組建立。一旦所有在群組中的交易完成，交易群組便會進入到最終狀態。 * 同步中 (Syncing) - 所有在交易群組中的資料會被寫任到穩定的儲存空間，這個程序會依序修改其他也需同樣寫入到穩定儲存空間的資料，如 Metadata 與空間對應表。同步的程多會牽涉多個循環，首先是同步所有更改的資料區塊，也是最大的部份，接著是 Metadata，這可能會需要多個循環來完成。由於要配置空間供資料區塊使用會產生新的 Metadata，同步中狀態在到達循環完成而不再需要分配任何額外空間的狀態前無法結束。同步中狀態也是完成 synctask 的地方，Synctask 是指管理操作，如：建立或摧毀快照與資料集，會修改 uberblock，也會在此時完成。同步狀態完成後，其他處於狀態中狀態的交易群組便會進入同步中狀態。 所有管理功能如快照 (Snapshot) 會作為交易群組的一部份寫入。當 synctask 建立之後，便會加入到目前開放的交易群組中，然後該群組會盡快的進入同步中狀態來減少管理指令的延遲。   Adaptive Replacement Cache (ARC) ZFS 使用了自適應替換快取 (Adaptive Replacement Cache, ARC)，而不是傳統的最近最少使用 (Least Recently Used, LRU) 快取，LRU 快取在快取中是一個簡單的項目清單，會依每個物件最近使用的時間來排序，新項會加入到清單的最上方，當快取額滿了便會去除清單最下方的項目來空出空間給較常使用的物件。ARC 結合了四種快取清單，最近最常使用 (Most Recently Used, MRU) 及最常使用 (Most Frequently Used, MFU) 物件加上兩個清單各自的幽靈清單 (Ghost list)，這些幽靈清單會追蹤最近被去除的物件來避免又被加回到快取，避免過去只有偶爾被使用的物件加入清單可以增加快取的命中率。同時使用 MRU 及 MFU 的另外一個優點是掃描一個完整檔案系統可以去除在 MRU 或 LRU 快取中的所有資料，有利於這些才剛存取的內容。使用 ZFS 也有 MFU 可只追蹤最常使用的物件並保留最常被存取的資料區塊快取。   L2ARC L2ARC 是 ZFS 快取系統的第二層，主要的 ARC 會儲存在 RAM 當中，但因為 RAM 可用的空間量通常有限，因此 ZFS 也可以使用 快取 vdev (Cache vdev)。固態磁碟 (Solid State Disk, SSD) 常被拿來此處作為快取裝置，因為比起傳統旋轉碟片的磁碟，固態磁碟有較快的速度與較低的延遲。L2ARC 是選用的，但使用可以明顯增進那些已使用 SSD 快取的檔案讀取速度，無須從一般磁碟讀取。L2ARC 也同樣可以加速去重複 (Deduplication)，因為 DDT 並不適合放在 RAM，但適合放在 L2ARC，比起要從磁碟讀取，可以加快不少速度。為了避免 SSD 因寫入次速過多而過早耗損，加入到快取裝置的資料速率會被限制，直到快取用盡 (去除第一個資料區塊來騰出空間) 之前，寫入到 L2ARC 的資料速率會限制在寫入限制 (Write limit) 與加速限制 (Boost limit) 的總合，之後則會限制為寫入限制，可以控制這兩個速度限制的 sysctl(8) 數值分別為 vfs.zfs.l2arc_write_max 控制每秒有多少數位元組可寫入到快取，而 vfs.zfs.l2arc_write_boost 可在 “渦輪預熱階段” (即寫入加速) 時增加寫入限制。   ZIL ZIL 會使用比主要儲存池還更快的儲存裝置來加速同步寫入動作 (Synchronous transaction)，如 SSD。當應用程式請求做一個同步的寫入時 (保証資料會安全的儲存到磁碟，而不是先快取稍後再寫入)，資料會先寫入到速度較快的 ZIL 儲存空間，之後再一併寫入到一般的磁碟。這可大量的減少延遲並增進效能。ZIL 只會有利於使用像資料庫這類的同步工作，一般非同步的寫入像複製檔案，則完全不會用到 ZIL。   寫入時複製 (Copy-On-Write) 不像傳統的檔案系統，在 ZFS，當資料要被覆寫時，不會直接覆寫舊資料所在的位置，而是將新資料會寫入到另一個資料區塊，只在資料寫入完成後才會更新 Metadata 指向新的位置。因此，在發生寫入中斷 (在寫入檔案的過程中系統當機或電源中斷) 時，原來檔案的完整內容並不會遺失，只會放棄未寫入完成的新資料，這也意謂著 ZFS 在發生預期之外的關機後不需要做 fsck(8)。   資料集 (Dataset) 資料集 (Dataset) 是 ZFS 檔案系統、磁碟區、快照或複本的通用術語。每個資料集都有獨一無二的名稱使用 poolname/path@snapshot 格式。儲存池的根部技術上來說也算一個資料集，子資料集會採用像目錄一樣的層級來命名，例如 mypool/home，home 資料集是 mypool 的子資料集並且會繼承其屬性。這可以在往後繼續擴展成 mypool/home/user，這個孫資料集會繼承其父及祖父的屬性。在子資料集的屬性可以覆蓋預設繼承自父及祖父的屬性。資料集及其子資料級的管理權限可以委託 (Delegate) 給他人。   檔案系統 (File system) ZFS 資料集最常被當做檔案系統使用。如同大多數其他的檔案系統，ZFS 檔案系統會被掛載在系統目錄層級的某一處且內含各自擁有權限、旗標及 Metadata 的檔案與目錄。   磁碟區 (Volume) 除了一般的檔案系統資料集之外，ZFS 也可以建立磁碟區 (Volume)，磁碟區是資料區塊裝置。磁碟區有許多與資料集相似的功能，包含複製時寫入、快照、複本以及資料校驗。要在 ZFS 的頂層執行其他檔案系統格式時使用磁碟區非常有用，例如 UFS 虛擬化或匯出 iSCSI 延伸磁區 (Extent)。   快照 (Snapshot) ZFS 的寫入時複製 (Copy-On-Write, COW) 設計可以使用任意的名稱做到幾乎即時、一致的快照。在製做資料集的快照或父資料集遞迴快照 (會包含其所有子資料集) 之後，新的資料會寫入到資的資料區塊，但不會回收舊的資料區塊為可用空間，快照中會使用原版本的檔案系統，而快照之後所做的變更則會儲存在目前的檔案系統，因此不會重複使用額外的空間。當新的資料寫入到目前的檔案系統，便會配置新的資料區塊來儲存這些資料。快照表面大小 (Apparent size) 會隨著在目前檔案系統停止使用的資料區塊而成長，但僅限於快照。可以用唯讀的方式掛載這些快照來復原先前版本的檔案，也可以還原 (Rollback) 目前的檔案系統到指定的快照，來還原任何在快照之後所做的變更。每個在儲存池中的資料區塊都會有一個參考記數器，可以用來持續追蹤有多少快照、複本、資料集或是磁碟區使用這個資料區塊，當刪除檔案與快照參照的計數變會滅少，直到沒有任何東西參考這個資料區塊才會被回收為可用空間。快照也可使用 hold 來標記，檔標記為 hold 時，任何嘗試要刪除該快照的動作便會回傳 EBUSY 的錯誤，每個快照可以標記多個不同唯一名稱的 hold，而 release 指令則可以移除 hold，這樣才可刪除快照。在磁碟區上快可以製作快照，但只能用來複製或還原，無法獨立掛載。   複本 (Clone) 快照也可以做複本，複本是可寫入版本的快照，讓檔案系統可分支成為新的資料集。如同快照，複本一開始不會消耗任何額外空間，隨著新資料寫入到複本會配置新的資料區塊，複本的表面大小 (Apparent size) 才會成長，當在複本檔案系統或磁碟區的資料區塊被覆寫時，在先前資料區塊的參考計數則會減少。建立複本所使用的快照無法被刪除，因為複本會相依該快照，快照為父，複本為子。複本可以被提升 (promoted)、反轉相依關係，來讓複本成為父，之前的父變為子，這個操作不需要額外的空間。由於反轉了父與子使用的空間量，所以可能會影響既有的配額 (Quota) 與保留空間 (Reservation)。   校驗碼 (Checksum) 配置每個資料區塊快的同時也會做資料校驗，資料校驗用的演算法是依資料集屬性而有所不同的，請參考 set。每個資料區塊會在讀取的過成便完成校驗，讓 ZFS 可以偵測到隱藏的損壞，若資料不符合預期的校驗碼，ZFS 會嘗試從任何可用的備援來還原資料，例如鏡像 (Mirror) 或 RAID-Z。要檢驗所有資料的校驗碼可以使用清潔 (Scrub)，資料校驗的演算法有：* fletcher2 * fletcher4 * sha256 fletcher 演算法最快，而 sha256 雖較消耗效能，但其有強大的密碼雜湊與較低的衝突率。也可關閉資料校驗，但並不建議。   壓縮 (Compression) 每個資料集都有壓縮 (Compression) 屬性，預設是關閉的，這個屬性可以設定使用以下幾個壓縮演算法的其中一個來壓縮寫入到資料集的新資料。壓縮除了減少空間使用量外，常也會增加讀取與寫入的吞吐量，因為會減少讀取與寫入的資料區塊。* LZ4 - ZFS 儲存池版本 5000 (功能旗標) 後所增加，LZ4 現在是建議的壓縮演算法，在處理可壓縮的資料時 LZ4 壓縮比 LZJB 快將近 50%，在處理不可壓縮的資料時快將近三倍，LZ4 解壓縮也比 LZJB 將近 80%。在現代的 CPU 上，LZ4 經常平均可用 500 MB/s 的速度壓縮，而解壓縮可到達 1.5 GB/s (每個 CPU 核心)。* LZJB - 預設的壓縮演算法。由 Jeff Bonwick 所開發 (ZFS 的創始人之一)。LZJB 與 GZIP 相比，可以較低的 CPU 提供較佳的壓縮功能。在未來預設的壓縮演算法將會更換為 LZ4。* GZIP - 在 ZFS 可用的熱門串流壓縮演算法。使用 GZIP 主要的優點之一便是可設定壓縮層級。當設定 compress 屬性，管理者可以選擇壓縮層級範圍從最低的壓縮層級 gzip1 到最高的壓縮層級 gzip9。這讓管理者可以控制要使用多少 CPU 來節省磁碟空間。* ZLE - 零長度編號是一個特殊的壓縮演算法，它只會壓縮連續的零。這種壓縮演算法只在資料集中含有大量為零的資料區塊時有用。   備份數 (Copies) 當設定大於 1 的數值時，copies 屬性會指示 ZFS 備份每個在檔案系統 (File System) 或磁碟區 (Volume) 的資料區塊數份。在重要的資料集上設定這個屬性可以做額外的備援以在資料校驗碼不相符時可做復原。在沒有做備援的儲存池上，備份功能提供只是一種資料的備援方式，備份功能可以復原單一壞軌或其他情況的次要損壞，但無法復原儲存池中整個磁碟損壞所損失的資料。   去重複 (Deduplication) 校驗碼讓在寫入時可以偵測重複資料區塊，使用去重複，可以增加既有、完全相同的資料區塊參考數來節省儲存空間。要偵測重複的資料區塊需要在記憶體中儲存去重複資料表 (Deduplication table, DDT)，這個資料表中會有唯一的校驗碼清單、這些資料區塊的所在位置以及參考數。當寫入新資料時，便會計算校驗碼然後比對清單中是否有符合的既有資料區塊已在清單。去重複使用了 SHA256 校驗碼演算法來提供一個安全的加密雜湊，去重複功能是可以調校的，若 dedup 設為 on 只要符合校驗碼便會認為資料完全相同，若 dedup 設為 verify 則會一個一個位元檢查兩個資料區塊的資料來確保資料真的完全相同，若資料不同便會註記與雜湊衝突並會分別儲存兩個資料區塊。由於 DDT 須要儲存每個唯一資料區塊的雜湊，所以會消耗大量的記憶體，一般的經驗法則是每 1 TB 的去重複資料需要使用 5-6 GB 的記憶體。由於要有足夠的 RAM 來儲存整個 DDT 在實務上並不實際，導致在每個新資料區塊寫入前需要從磁碟來讀取 DDT 會對效能有很大的影響，去重複功能可以使用 L2ARC 儲存 DDT 以在快速的系統記憶體及較慢的磁碟之間取得一個平衡點。也可以考慮使用壓縮功能來取代此功能，因為壓縮也能節省相近的空間使用量而不需要大量額外的記憶體。   清潔 (Scrub) ZFS 有 scrub 來替代 fsck(8) 來做一致性的檢查。scrub 會讀取所有儲存在儲存池中的資料區塊並且根據儲存在 Metadata 中已知良好的校驗碼來檢驗這些資料區塊的校驗碼，定期檢查儲存池中儲存的所有資料可以確保實際使用這些資料前已將所有損壞的資料區塊復原。在不正常的關閉之後並不需要做清潔動作，但建議每三個月至少執行一次。在正常使用讀取時便會檢查每個資料區塊的校驗碼，但清潔動作可以確保那些不常用的資料也會被檢查以避免隱藏的損壞，如此便能增進資料的安全性，特別是對用來保存資料的儲存裝置。scrub 可以使用 vfs.zfs.scrub_delay 調整相對優先權來避免清潔動作降低儲存池上其他工作的效率。   資料集配額 (Dataset Quota) 除了配額及空間保留外，ZFS 提供非常快速且準確的資料集、使用者及群組空間的計算功能，這可讓管理者調整空間配置的方式且可為重要的檔案系統保留空間。ZFS supports different types of quotas: the dataset quota, the reference quota (refquota), the user quota, and the group quota.配額會限制資料集及後裔包含資料集的快照、子資料集及子資料集的快照能使用的空間量。磁碟區上無法設定配額，因為 volsize 屬性已經被用來做內定的配額。   參考配額 (Reference Quota) 參考配額可以設定一個硬性限制 (Hard limit) 來限制資料集能使用的空間量，而這個硬性限制只包含了資料集參考的空間，並不含其後裔所使用的空間，如：檔案系統或快照。   使用者配額 (User Quota) 使用者配額在用來限制特定使用者能使用的空間量時非常有用。   群組配額 (Group Quota) 群組配額可以限制特定群組能使用的空間量。   資料集保留空間 (Dataset Reservation) reservation 屬性可以確保對特定資料集及其後裔最小可用的空間量，若在 storage/home/bob 設定 10 GB 的保留空間且其他資料集嘗試使用所有剩餘的空間時，會保留至少 10 GB 的空間供這個資料集使用。若要製作 storage/home/bob 的快照，該快照所使用的空間也會被列入保留空間計算。 refreservation 屬性也以類似的方式運作，但是他 不包含 後裔，例如：快照。不管那一種保留空間在許多情境皆很有用，例如：要規劃與測試磁碟空間配置在新系統上的適應性，或是確保有足夠的空間供稽查日誌或系統還原程序及檔案使用。   參考保留空間 (Reference Reservation) refreservation 屬性可以確保對特定資料集 不包含 其後裔最小可用的空間，這代表若在 storage/home/bob 設定 10 GB 的保留空間且其他資料集嘗試使用所有剩餘的空間時，會保留至少 10 GB 的空間供這個資料集使用。於正常 reservation 不同的是，由快照及後裔資料集所使用的空間並不會列入保留空間計算。例如，若要製作一個 storage/home/bob 的快照，在 refreservation 空間之外必須要有足夠的空間才能成功完成這項操作，主資料集的後裔並不會列入 refreservation 空間額計算，所以也不會佔用保留空間。   修復 (Resilver) 當有磁碟故障且被更換後，新的磁碟必須回存先前所遺失的資料，會使用分散在其他磁碟上的奇偶校驗資訊來計算並寫入遺失的資料到新的磁碟機的這個程序稱作 修復 (Resilvering)。   上線 (Online) 一個儲存池或 vdev 處於線上 (Online) 狀態時代表所有該裝置的成員均已連結且正常運作。個別裝置處於線上 (Online) 狀態時代表功能正常。   離線 (Offline) 若有足夠的備援可避免儲存池或 vdev 進入故障 (Faulted) 狀態，個別裝置若可由管理者設為離線 (Offline) 狀態，管理者可以選擇要設定那一個磁碟為離線來準備更換或是讓其更容易辨識。   降級 (Degraded) 一個儲存池或 vdev 處於降級 (Degraded) 狀態代表其有一個或多個磁碟已斷線或故障，此時儲存池仍可以使用，但只要再有其他的裝置故障，儲存池會無法復原。重新連線缺少的裝置或更換故障的磁碟，並在新裝置完成修復 (Resilver) 程序可讓儲存池返回線上 (Online) 狀態。   故障 (Faulted) 一個儲存池或 vdev 處於故障 (Faulted) 狀態代表無法運作，會無法存取在該裝置上的資料。當在 vdev 中缺少或故障的裝置數超過備援的層級，儲存池或 vdev 會進入故障 (Faulted) 狀態。若缺少的裝置可以重新連結上，儲存池便會返回線上 (Online) 狀態。若沒有足夠的備援可補償故障的磁碟數量便會遺失儲存池中的內容且只能從備份還原。    Gentoo on ZFS 备份 初始化硬盘 这里的初始化硬盘是为了将原来的数据全部清除并且重新建立LUKS和文件系统。出于安全的考虑，备份不应该直接在硬盘上分区创建文件系统后备份在上面，应该做一层加密再去创建文件系统和备份。\n将硬盘插入需要备份的电脑上\n查看新增的设备\n$ fdisk -l Disk /dev/sda: 232.9 GiB, 250055122432 bytes, 488388911 sectors Disk model: 00AAJS-00B4A0 Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0x80f01a9c Device Boot Start End Sectors Size Id Type /dev/sda1 2048 488388910 488386863 232.9G 83 Linux 这里可以看到新添加的磁盘，上面是有以前的东西，这里为了安全起见用随机数据覆盖掉这个分区。 这里会清除可能存在的任何没有加密的旧数据，如果遭受攻击这会让攻击者更难确定数据位置，这一步会很慢（取决于你的接口速度和硬盘速率）。\n$ sudo dd if=/dev/urandom of=/dev/sda bs=1M status=progress \u0026\u0026 sync 完成之后，我们需要重新对这个硬盘进行分区\n$ sudo fdisk /dev/sda Welcome to fdisk (util-linux 2.35.2). Changes will remain in memory only, until you decide to write them. Be careful before using the write command. Command (m for help): n Partition type p primary (0 primary, 0 extended, 4 free) e extended (container for logical partitions) Select (default p): Using default response p. Partition number (1-4, default 1): First sector (2048-488388910, default 2048): Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-488388910, default 488388910): Created a new partition 1 of type 'Linux' and of size 232.9 GiB. Command (m for help): w The partition table has been altered. Calling ioctl() to re-read partition table. Syncing disks. 这样就创建了一个分区，接下来我们要在这个分区上创建LUKS\n创建 LUKS 我们这里可以使用cryptsetup这个命令来初始化我们的LUKS分区\n如果你没有这个命令可以运行这条命令进行安装：\n$ emerge -av cryptsetup 然后初始化分区\n$ sudo cryptsetup luksFormat /dev/sda1 WARNING! ======== This will overwrite data on /dev/sda1 irrevocably. Are you sure? (Type 'yes' in capital letters): YES Enter passphrase for /dev/sda1: Verify passphrase: 这里会提示这个操作将会将这个分区里面的内容全部删掉，输入大写的YES确认，然后输入两次密码，注意密码是没有回显的。\n打开 LUKS 和创建文件系统 现在是LUKS已经做好了，但是我们还需要在上面格式化分区才能够挂载使用，我们首先要打开LUKS分区：\n$ sudo cryptsetup luksOpen /dev/sda1 backup Password: Enter passphrase for /dev/sda1: 我这里是想打开这个LUKS卷，为了区分和其他的我给这个名字叫做backup，然后会提示你输入LUKS的密码，正确输入之后就可以在/dev/mappaer下面看到一个backup的设备了\n现在对这个分区进行格式化，这次用的是ext4的分区\n$ sudo mkfs.ext4 -v /dev/mapper/backup 创建挂载点和挂载 在完成了分区初始化之后我们还需要创建一个挂载点用于挂载这个备份的分区:\n$ sudo mkdir -pv /backup 挂载分区:\n$ sudo mount -v /dev/mapper/backup /backup 备份系统 下载就可以备份系统了，这次使用的是rsync工具来进行备份系统：\n$ sudo rsync -aAXv --exclude={\"/dev/*\",\"/proc/*\",\"/sys/*\",\"/tmp/*\",\"/run/*\",\"/mnt/*\",\"/media/*\",\"/lost+found\",\"/backup/*\",\"/swapfile\"} / /backup 这里使用的-aAXv选项的意思是：文件将会以归档模式传输，保留符号设备，文件权限，修改时间，ACL和扩展属性，并且将备份的过程打印在屏幕上。\n--exclude就是排除特定的文件类似于/dev、/proc之类的，/backup是我们的备份分区不需要再去搞一份防止出现奇奇怪怪的后果。\n这会耗费很多时间可以休息一下做其他的事情。\n等待这个备份完成之后我们就可以卸载这块硬盘进行保存了。\n卸载挂载点\n$ umount /backup 关闭LUKS分区\n$ cryptsetup luksClose backup 迁移到 ZFS 分区 首先我需要把之前的分区全部干掉，然后创建如下表的分区：\n   分区 文件系统 大小     /dev/nvme0n1p1 fat32 128M   /dev/nvme0n1p2 swap 64G   /dev/nvme0n1p3 ZFS ALL    直接在系统里面丢swapfile是不合理的，最好是有个单独的分区给swap。\n初始化分区 创建完成分区之后我们还需要对分区进行初始化：\n$ mkfs.vfat -F32 /dev/nvme0n1p1 $ mkswap /dev/nvme0n1p2 创建 pool 这里需要注意一点是像是我们之前分区的/dev/nvme0n这种设备或者是/dev/sda这样的，如果插拔U盘之类的可能盘序会发生变化，但是ZFS池是不会意识到这个变化的，这样就会产生zfs池不可用的问题，我们需要一些方法来获取到磁盘的id并以此来创建我们的zfs池。\n$ ls -l /dev/disk/by-id lrwxrwxrwx 1 root root 13 Feb 13 12:29 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM - ../../nvme0n1 lrwxrwxrwx 1 root root 15 Feb 13 12:32 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part1 - ../../nvme0n1p1 lrwxrwxrwx 1 root root 15 Feb 13 12:29 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part2 - ../../nvme0n1p2 KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part3 - ../../nvme0n1p3 ... 这里的KXG50PNV2T04_KIOXIA_Y9IS103FTHDM就是我们的硬盘，nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part1就是我们创建作为未来的/boot分区。\n当我们创建zfs池的时候尽可能选择用这种id的方式去创建。现在我们创建一个加密的zpool：\n$ zpool create -f -o ashift=12 -o cachefile=/etc/zfs/zpool.cache -O compression=lz4 -O xattr=sa -O relatime=on -O acltype=posixacl -O dedup=off -O encryption=on -O keyformat=passphrase -m none -R /mnt/gentoo rock /dev/disk/by-id/nvme-eui.000000000000001000080d0200600f01-part3 zpoolprops\n ashift=ashift: Pool sector size exponent, to the power of 2 (internally referred to as ashift). The typical case for setting this property is when performance is important and the underlying disks use 4KiB sectors but report 512B sectors to the OS (for compatibility reasons); in that case, set ashift=12 (which is 1«12 = 4096). cachefile=path|none: Controls the location of where the pool configuration is cached. Setting this property caches the pool configuration in a different location that can later be imported with zpool import -c.  根据提示输入密码（注意密码不会有回显，并不是键盘坏了）。\n这条命令创建了一个名为 rock的zfs池 使用的压缩算法为lz4。\n如果说你想创建一个不带加密的zpool可以去掉-O encryption=on -O keyformat=passphrase这两个选项。\n创建 datasets 接下来我们要创建自己的rootfs，并且在上面打开加密功能：\n$ zfs create -o mountpoint=none -o canmount=off rock/os $ zfs create -o mountpoint=/ rock/os/gentoo 安装系统 这次安装系统的话，是打算直接从硬盘恢复的，首先插上备份好的硬盘：\n$ fdisk -l ........ Disk /dev/sdc: 232.88 GiB, 250055122432 bytes, 488388911 sectors Disk model: 00AAJS-00B4A0 Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 4096 bytes / 33553920 bytes Disklabel type: dos Disk identifier: 0x80f01a9c Device Boot Start End Sectors Size Id Type /dev/sdc1 2048 488388910 488386863 232.9G 83 Linux 这里看到我们的备份硬盘。我们要创建一个目录用来挂载这个分区：\n$ mkdir -pv /backup 打开LUKS分区：\n$ cryptsetup luksOpen /dev/sdc1 backup Enter passphrase for /dev/sdc1: 输入之前设置的密码。挂载分区：\n$ mount -v /dev/mapper/backup /backup 还有一个分区我们要注意一下就是/boot分区，创建boot分区的挂载点：\n$ mkdir -pv /mnt/gentoo/boot 挂载分区：\n$ mount -v /dev/nvme0n1p1 /mnt/gentoo/boot 将所有文件同步到zfs的dataset里面：\n$ rsync -aAXv --exclude={\"/dev/*\",\"/proc/*\",\"/sys/*\",\"/tmp/*\",\"/run/*\",\"/mnt/*\",\"/media/*\",\"/lost+found\",\"/backup/*\",\"/swapfile\"} /backup/ /mnt/gentoo 这个复制需要一定的时间，耐心等待完成，期间不要断开硬盘或者是拔掉电源。\nchroot 等到复制原来的系统完成之后我们就需要进入chroot环境，然后完成其他的必要配置了。\n拷贝ZFS池缓存文件：\n$ mkdir -pv /mnt/gentoo/etc/zfs $ cp -v /etc/zfs/zpool.cache /mnt/gentoo/etc/zfs 拷贝网络的DNS：\n$ cp --dereference /etc/resolv.conf /mnt/gentoo/etc/ 挂载必要的文件系统：\n$ mount --types proc /proc /mnt/gentoo/proc $ mount --rbind /sys /mnt/gentoo/sys $ mount --make-rslave /mnt/gentoo/sys $ mount --rbind /dev /mnt/gentoo/dev $ mount --make-rslave /mnt/gentoo/dev 我们不是在官方的Livecd下面还需要执行：\n$ test -L /dev/shm \u0026\u0026 rm /dev/shm \u0026\u0026 mkdir /dev/shm $ mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm $ chmod 1777 /dev/shm 进入chroot：\n$ chroot /mnt/gentoo /bin/bash $ source /etc/profile $ export PS1=\"(chroot) $PS1\" ZFS 安装和配置 首先是要给原来的系统安装上ZFS的支持，确保内核打开了Zlib的支持：\nGeneral Architecture Dependent Options --- GCC plug ins --- [ ] Randomize layout of sensitive kernel structures Cryptographic API ---  Deflate compression algorithm Security options --- [ ] Harden common str/mem functions against buffer overflows 我们还需要调整portage让ZFS包接收测试分支的包：\n$ echo \"sys-fs/zfs-kmod ~amd64\"  /etc/portage/package.accept_keywords/zfs-kmod $ echo \"sys-fs/zfs ~amd64\"  /etc/portage/package.accept_keywords/zfs 如果你想要使用实时的包可以:\n$ echo \"=sys-fs/zfs-kmod-9999 **\"  /etc/portage/package.accept_keywords/zfs-kmod $ echo \"=sys-fs/zfs-9999 **\"  /etc/portage/package.accept_keywords/zfs 但是不推荐用最新的，要到处找patch。\n安装ZFS：\n$ emerge -av zfs 有一个很重要的点，每次更新内核或者是编译内核之后最好是重新构建一下模块，否则有可能遇到zpool无法正常初始化的问题：\n$ emerge -va @module-rebuild 将zfs加入到开机启动项和对应的启动级别：\n$ systemctl enable zfs.target $ systemctl enable zfs-import-cache $ systemctl enable zfs-mount $ systemctl enable zfs-import.target 生成和验证zfs hostid文件，这个文件是用于genkernel生成initramfs和zfs导入池的时候验证完整性时候需要的：\n$ zgenhostid $ file /etc/hostid Bootload fstab and Initramfs GRUB 修改grub的配置文件，内容如下：\nGRUB_CMDLINE_LINUX=\"dozfs root=ZFS=rock/os/gentoo\" 安装bootload：\n$ grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=Gentoo 生成配置文件：\n$ grub-mkconfig -o /boot/grub/grub.cfg fstab 挂载的工作这次交给zfs来去完成，我们这里还需要修改一下fstab\n首先查看分区的id：\n$ blkid /dev/nvme0n1p1: UUID=\"129F-3405\" BLOCK_SIZE=\"512\" TYPE=\"vfat\" PARTUUID=\"537bd932-cc1f-5643-a297-feebaeb6a5ea\" /dev/nvme0n1p2: LABEL=\"rock\" UUID=\"7999529021869478878\" UUID_SUB=\"11607083434113154920\" BLOCK_SIZE=\"4096\" TYPE=\"zfs_member\" PARTUUID=\"d68d6b86-a407-4141-a1a7-1379cbe1e049\" 可以看到我们的/boot分分区UUID是129F-3405，现在可以修改/etc/fstab\n$ nano -w /etc/fstab 内容如下\n# /dev/nvme0n1p1 /dev/nvme0n1p1 /boot vfat rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=iso8859-1,shortname=mixed,errors=remount-ro\t0 2 initramfs 重新生成initramfs，之前的initramfs没有zfs的支持这次要加上，为了保证工作正常还需要将genkrenel切换到testing分支\n$ echo \"=sys-kernel/genkernel-9999 **\"  /etc/portage/package.accept_keywords/genkernel 更新genkernel\n$ emerge -av genkernel 重新生成initramfs文件\n$ genkernel initramfs --zfs --compress-initramfs 重启 在重启验证之前我们需要先做一些清理工作\n首先退出chroot环境\n$ exit 卸载备份分区\n$ umount -R /backup 关闭backup卷\n$ cryptsetup luksClose backup 然后就可以重启啦\n$ reboot 重启之后第一次可能还是没办法正常进入系统，需要进入到shell里面导入一下zpool\n$ zpool import -f rock 设置一下分区挂载点\n$ zfs set mountpoint=/ rock/os/gentoo 然后再重启一下就可以正常进入系统了。\n使用ZFS备份 创建备份ZFS池 首先进入livecd，查看设备：\n$ fdisk -l Disk /dev/nvme0n1: 1.86 TiB, 2048408248320 bytes, 4000797360 sectors ... Disk /dev/sda: 233.76 GiB, 251000193024 bytes, 490234752 sectors ... Disk /dev/sdc: 57.81 GiB, 62075699200 bytes, 121241600 sectors ... 这里的设备分别为：\n   物理位置 说明     /dev/nvme0n1 系统盘   /dev/sda 备份盘   /dev/sdc 启动盘    首先在备份盘上创建一个分区（分配所有空间到这个分区上）：\n$ fdisk /dev/sda Welcome to fdisk (util-linux 2.36). Changes will remain in memory only, until you decide to write them. Be careful before using the write command. Device does not contain a recognized partition table. Created a new DOS disklabel with disk identifier 0x108318f9. Command (m for help): n Partition type p primary (0 primary, 0 extended, 4 free) e extended (container for logical partitions) Select (default p): Using default response p. Partition number (1-4, default 1): First sector (2048-490234751, default 2048): Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-490234751, default 490234751): Created a new partition 1 of type 'Linux' and of size 233.8 GiB. Command (m for help): w The partition table has been altered. Calling ioctl() to re-read partition table. Syncing disks. 查看硬盘ID\n$ ls -l /dev/disk/by-id ... lrwxrwxrwx 1 root root 10 Feb 27 14:53 usb-ACASIS_MAC3E_000000000001-0:0-part1 - ../../sda1 ... usb-ACASIS_MAC3E_000000000001-0:0-part1这里就是我们所需要的硬盘ID，我们使用这个来创建备份池子：\n$ zpool create -f -o ashift=12 -o cachefile=/etc/zfs/zpool.cache -O compression=lz4 -O xattr=sa -O relatime=on -O acltype=posixacl -O dedup=off -m none -R /mnt/backup backup /dev/disk/by-id/usb-ACASIS_MAC3E_000000000001-0:0-part1 备份池也可以加密。\n创建快照 首先导入原来的zpool\n$ zpool import -f rock 给之前的系统创建一个快照：\n$ sudo zfs snapshot rock/os/gentoo@2021-02-27-0000-01-install 查看\n$ zfs list -r -t snapshot -o name,creation rock/os/gentoo rock/os/gentoo@2021-02-27-0000-01-install Sat Feb 27 14:16 2021 发送快照 我们需要打开原来的rock/os/gentoo数据集\n但是首先要设置一下挂载点：\n$ zfs set mountpoint=/mnt/gentoo rock/os/gentoo 打开rock/os/gentoo数据集\n$ zfs mount -l -a 发送快照到backup/os/gentoo\n$ zfs send rock/os/gentoo@2021-02-27-0000-01-install | zfs recv backup/2021-02-27-0000-01-backup 这个会花很长的时间，取决于你使用的接口速度，可以通过这条命令查看io情况：\n$ zpool iostat 2 这条命令是查看所有的zpoolio情况，2秒刷新一次。\n备份/boot分区 设置挂载点\n$ zfs set mountpoint=/mnt/backup backup/2021-02-27-0000-01-backup 备份\n$ mkdir -pv /mnt/boot $ mount -v /dev/nvme0n1p1 /mnt/boot $ cp -rv /mnt/boot/* /mnt/backup/boot/ 恢复快照 卸除挂载：\n$ zfs umount backup/2021-02-27-0000-01-backup 现在就可以恢复快照了：\n$ zfs send backup/2021-02-27-0000-01-backup | zfs recv -F -x encryption rock/os/gentoo 定期备份 在Gentoo的Portage Tree中提供了一个sys-fs/zfs-auto-snapshot的包，这个包可以帮我们创建一个定时任务周期性的备份我们的ZFS\n$ sudo emerge -av sys-fs/zfs-auto-snapshot 可以根据需要配置备份的周期：\n$ sudo zfs set com.sun:auto-snapshot:daily=true rock/os/gentoo $ sudo zfs set com.sun:auto-snapshot:weekly=true rock/os/gentoo 问题排查 grub 救援 grub rescue set prefix=(hd0,1)/boot/grub grub rescue set root=(hd0,1) grub rescue insmod normal grub rescue normal grub rescue insmod linux grub rescue linux /boot/vmlinuz-3.13.0-29-generic dozfs root=ZFS=rock/os/gentoo grub rescue initrd /boot/initrd.img-3.13.0-29-generic grub rescue boot 通过 livecd 修复 导入 zpool\n$ zpool import -f rock $ zfs set mountpoint=/mnt/gentoo rock/os/gentoo 挂载 dataset\n$ zfs mount -la 挂载 boot 分区\n$ mount /dev/nvme0n1p1 /mnt/gentoo/boot/ 挂载必要的文件系统\n$ mount --types proc /proc /mnt/gentoo/proc $ mount --rbind /sys /mnt/gentoo/sys $ mount --make-rslave /mnt/gentoo/sys $ mount --rbind /dev /mnt/gentoo/dev $ mount --make-rslave /mnt/gentoo/dev # 我们不是在官方的Livecd下面还需要执行： $ test -L /dev/shm \u0026\u0026 rm /dev/shm \u0026\u0026 mkdir /dev/shm $ mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm $ chmod 1777 /dev/shm 进入 chroot\n$ chroot /mnt/gentoo /bin/bash $ source /etc/profile $ export PS1=\"(chroot) $PS1\" 退出 chroot\n$ exit 卸除挂载\n$ umount -R /mnt/gentoo 改回 rootfs 挂载点\n$ zfs set mountpoint=/ rock/os/gentoo 重启\n$ reboot LUKS 数据的安全，保密性在现在的生活中显得越来越重要。随着数字化的时代的来临，越来越多的数据被数字化，特别是更多有关于我们隐私的数据在不断生成，甚至还有我们需要离线保存的密钥等。而且通常我们使用磁盘，USB 闪存，SD 卡等存储介质进行存储，即便我们已经离线存储，仍然不能保证该存储介质不会丢失，如果丢失那么对于我们来说有可能是灾难性的事件。因此对这些离线存储的重要数据，再次进行进行加密是非常有必要的，本文将告诉你如何加密你的移动存储介质。\n在此之前先介绍一下 LUKS：\n LUKS （Linux Unified Key Setup）是 Linux 硬盘加密的标准。 通过提供标准的磁盘格式，它不仅可以促进发行版之间的兼容性，还可以提供对多个用户密码的安全管理。 与现有解决方案相比，LUKS 将所有必要的设置信息存储在分区信息首部中，使用户能够无缝传输或迁移其数据。\n 内核配置（可选） 通常来说，大部分发行版的内核都已经配置了相关的加密部分，因此非 gentoo 用户可以跳过此部分。\n配置 device mapper 和 crypt target：\n[*] Enable loadable module support Device Drivers --- [*] Multiple devices driver support (RAID and LVM) ---  Device mapper support  Crypt target support 配置加密 API：\n[*] Cryptographic API ---  XTS support  SHA224 and SHA256 digest algorithm  AES cipher algorithms  AES cipher algorithms (x86_64)  User-space interface for hash algorithms  User-space interface for symmetric key cipher algorithms 编译新内核并配置应用，然后重启：\n# make -j9 \u0026\u0026 make modules_install \u0026\u0026 make install 安装软件 通常的发行版已经预装了该软件包，可以直接使用，下面是 Gentoo 的安装方法\n# emerge --ask sys-fs/cryptsetup 创建加密分区 注意，该操作会清空你选择分区或设备上的所有数据，请谨慎操作，输入大写的 YES 确认\n# cryptsetup -s 512 luksFormat /dev/sdd WARNING! ======== This will overwrite data on /dev/sdd irrevocably. Are you sure? (Type uppercase yes): YES Enter passphrase: Verify passphrase: 利用密钥文件加密分区 除了密码之外，还可以选择使用密钥文件解密你的硬盘，也就是相当于一个密钥，当然可以也可以只使用密钥文件或者同时使用密码与密钥文件。\n生成随机密钥文件 # dd if=/dev/urandom of=/root/enc.key bs=1 count=4096 添加密钥文件作为密码之一 # cryptsetup luksAddKey /dev/sdd /root/enc.key Enter any existing passphrase: 移除解密密码 移除普通密码：\n# cryptsetup luksRemoveKey /dev/sdd Enter LUKS passphrase to be deleted: ... 移除 key file 密码：\n# cryptsetup luksRemoveKey -d /root/enc.key /dev/sdd 注意：千万不要将所有密码移除，至少需要留有一个密码访问设备，移除操作不可撤销\n解密与挂载 密码解密 # cryptsetup luksOpen /dev/sdd myusb Enter passphrase for /dev/sdd: key file 解密 # cryptsetup luksOpen -d /root/enc.key /dev/sdd myusb 创建文件系统 在挂载使用之前，我们仍然需要对设备创建文件系统才可以使用，可以选择任何你喜欢的文件系统，例如 btrfs，ext4，vfat，ntfs 等\n# mkfs.ext4 /dev/mapper/myusb mke2fs 1.43.6 (29-Aug-2017) Creating filesystem with 488448 4k blocks and 122160 inodes Filesystem UUID: 995e172a-2bc6-432c-a60f-2d4d7093e748 Superblock backups stored on blocks: 32768, 98304, 163840, 229376, 294912 Allocating group tables: done Writing inode tables: done Creating journal (8192 blocks): done Writing superblocks and filesystem accounting information: done 挂载 现在可以像正常分区一样挂载我们的加密分区设备了\n# mount /dev/mapper/myusb /mnt/ # df -h /dev/mapper/myusb 1.9G 5.7M 1.7G 1% /mnt 卸载挂载点并关闭加密分区 # umount /mnt # cryptsetup luksClose myusb 总结 在完成整个步骤以后，您现在需要做的就是妥善保管您的加密存储，可采用同样的方式加密多个设备进行备份，因为谁也不能保证这移动设备会不会在什么时候丢掉。\n双显卡笔记本独显直通 介绍 双显卡笔记本中直通独显（dGPU）到 win10 虚拟机。\n环境：\n 联想 Legion R7000P 2020 笔记本 RTX2060 笔记本显卡 libvirt+qemu Host: Gentoo Linux Guest: Windows 10 LTSC 2019  MUXed MUXed 结构的笔记本才容易实现独立显卡直通，Legion R7000P 应该就是 MUXed 的。关于什么是 MUXed 的，可以看下图的解释。\n关于如何检测笔记本是否是 MUXed 的，目前没有什么好的办法。有一种说法是运行 lspci，查找有关 Intel HD Graphics/AMD GPU 和 NVIDIA 的设备：\n 如果独显设备名以 3D Controller 开头，那你的电脑就是第二种 MUXless（核显直连显示器）。 如果独显设备名以 VGA Controller 开头，并且有一个 HD Graphics/AMD GPU 核显，那你的电脑是第三种 MUXed（核显、独显切换）。  启用 IOMMU 和 vfio 模块 IOMMU  intel CPU：添加内核参数 intel_iommu=on iommu=pt ，BIOS 开启 VT-d amd CPU：添加内核参数 iommu=pt ，BIOS 开启 AMD-Vi  vfio 添加模块 vfio_pci vfio vfio_iommu_type1 vfio_virqfd 到 initramfs 中。如果是像我一样使用 dracut 生成 initramfs，则在 /etc/dracut.conf 中添加配置 add_drivers+=\" vfio_pci vfio vfio_iommu_type1 vfio_virqfd \" ，之后重新生成 initramfs。\n隔离 GPU #!/bin/bash shopt -s nullglob for g in `find /sys/kernel/iommu_groups/* -maxdepth 0 -type d | sort -V`; do echo \"IOMMU Group ${g###*/}:\" for d in $g/devices/*; do echo -e \"\\t$(lspci -nns ${d###*/})\" done; done; 运行上述脚本，查看显卡所在的 IOMMU Group，并得到显卡相关设备的 device id。\nIOMMU Group 10: 01:00.0 VGA compatible controller [0300]: NVIDIA Corporation TU106M [GeForce RTX 2060 Mobile] [10de:1f15] (rev a1) 01:00.1 Audio device [0403]: NVIDIA Corporation TU106 High Definition Audio Controller [10de:10f9] (rev a1) 01:00.2 USB controller [0c03]: NVIDIA Corporation TU106 USB 3.1 Host Controller [10de:1ada] (rev a1) 01:00.3 Serial bus controller [0c80]: NVIDIA Corporation TU106 USB Type-C UCSI Controller [10de:1adb] (rev a1) 如上所见，device id 分别为 10de:1f15 、 10de:10f9 、 10de:1ada 、 10de:1adb 。再将以上 deivce id 作为参数添加到内核参数或 /etc/modprobe.d/vfio.conf 中。\n 内核参数：vfio-pci.ids=10de:1f15,10de:10f9,10de:1ada,10de:1adb /etc/modprobe.d/vfio.conf ：options vfio-pci ids=10de:1f15,10de:10f9,10de:1ada,10de:1adb  dracut 必须将 device id 添加到内核参数中，并且添加参数 rd.driver.pre=vfio_pci 。\n最后重启电脑。开机后通过命令 lspci -k 确认上述 device id 对应的设备在使用 vfio-pci 驱动。如果有各别设备没有使用 vfio-pci 驱动，则可以通过手动 unbind 和 bind 驱动的方式加载 vfio-pci 驱动。比如如果 0000:01:00.2 仍在使用 xhci_hcd 驱动，则：\n# run as root echo -n \"0000:01:00.2\"  /sys/bus/pci/drivers/xhci_hcd/unbind echo -n \"0000:01:00.2\"  /sys/bus/pci/drivers/vfio-pci/bind 创建虚拟机 首先使用 libvirt 创建一个非显卡直通的虚拟机，如果你有多余的显示器和键鼠，也可以直接创建显卡直通的虚拟机。这里我们假设没有多余的设备，并且之后使用 RDP 连接虚拟机。\n首先下载windows 10 LTSC 2019和 virtio windows驱动镜像。\n创建虚拟机：\n Overview ：Firmware 选择 UEFI x86_64:/usr/share/edk2-ovmf/OVMF_CODE.fd CPUs ：选择 Topology，Manually set CPU topology，Sockets 设为 1，Cores 按需要来，我设为 4，Threads 设置为 2。这样一共就分配了 4 核 8 线程的 CPU Memory ：内存我设置为 32G SATA Disk ：Disk Bus 选择 Virtio，可以最小化磁盘性能损耗 NIC ：Device model 也选择 virtio 之后再添加一个 Stroage ，选择 Select custom storage 并选中之前下载的 virtio windows 驱动镜像，然后 Device type 选择 CDROM device 最后在 Boot Options 中选中需要启动的设备  开始安装，在 windows 安装进行到选择硬盘的时候，通过之前加载的 virtio win 驱动的 CDROM，安装 virtio 的磁盘和网络驱动。具体参考可见视频 https://www.bilibili.com/video/BV1dQ4y1o78R 的 29 分 35 秒。安装完毕进入 windows，开启远程桌面并记下 IP，之后通过 RDP 连接虚拟机。\n配置和优化 RemoteFX 配置 RemoteFX  通过 Win+R 运行 gpedit.msc 定位到 计算机配置 - 管理模板 - Windows组件 - 远程桌面服务 - 远程桌面会话主机 - 远程会话环境  开启 对 RemoteApp 使用高级 RemoteFX 图形 （可选）开启 配置 RemoteFX 自适应图形的图像质量 ，设置为高 开启 为专门针对 Windows Server 2008 R2 SP1 设计的 RemoteFX 客户端启动 RemoteFX 编码 开启 配置 RemoteFX 数据的压缩 ，并设置为不需使用 RDP 压缩算法  连接压缩会导致编码和解码时产生额外的延迟     定位到 计算机配置 - 管理模板 - Windows组件 - 远程桌面服务 - 远程桌面会话主机 - 远程会话环境 - RemoteFX for Windows Server 2008 R2  开启 配置RemoteFX （可选）开启 使用RemoteFX时优化视觉体验 ，并都设置为最高    解除 30-ish fps 限制  启动注册表编辑器 定位并单击以下注册表子键： HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations 在 编辑 菜单中选择 新建 ，然后再选择 DWORD（32位）值 输入 DWMFRAMEINTERVAL 并回车 右键 DWMFRAMEINTERVAL ，选择 修改 选择十进制，并输入 15。该设置将最大帧率设置为每秒 60 帧 (FPS)。  显卡直通 先关闭虚拟机。首先我们需要确认 host 和 guest 中的 GPU 硬件 ID 一致的，然而 Legion R7000P 中两者不一致，准确的来说是其中的 Sub ID 部分不一致，所以需要手动修改一下。首先通过命令 lspci -nnk | egrep -A3 \"VGA|3D\" 查看显卡的 Vendor ID 和 Device ID。\n$ lspci -nnk | egrep -A3 \"VGA|3D\" 01:00.0 VGA compatible controller [0300]: NVIDIA Corporation TU106M [GeForce RTX 2060 Mobile] [10de:1f15] (rev a1) Subsystem: Lenovo TU106M [GeForce RTX 2060 Mobile] [17aa:3a43] Kernel driver in use: vfio-pci Kernel modules: nouveau -- 06:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Renoir [1002:1636] (rev c6) Subsystem: Lenovo Renoir [17aa:3a47] Kernel driver in use: amdgpu Kernel modules: amdgpu 其中 NVIDIA 独显的 Vendor ID 为 10de，Device ID 为 1f15。再用命令 grep \"PCI_SUBSYS_ID=\" /sys/bus/pci/devices/0000:01:00.0/uevent 查看 Sub Vendor ID 和 Sub Device ID。\n$ grep \"PCI_SUBSYS_ID=\" /sys/bus/pci/devices/0000:01:00.0/uevent PCI_SUBSYS_ID=17AA:3A47 其中 Sub Vendor ID 为 17AA，Sub Device ID 为 3A47。将 17AA 和 3A47 转换为十进制 6058 和 14919，并在虚拟机的 XML 中添加配置：\n xmlns:qemu=\"http://libvirt.org/schemas/domain/qemu/1.0\" type=\"kvm\" ...   value='-set'/  value='device.hostdev0.x-pci-sub-vendor-id=6058'/  value='-set'/  value='device.hostdev0.x-pci-sub-device-id=14919'/   注意 XML 的第一行一定要添加 xmlns:qemu=\"http://libvirt.org/schemas/domain/qemu/1.0\" ，否则后面的配置无法成功添加。\n在 libvirt 中添加硬件，选择 PCI Host Device，然后将 0000:01:00.0 NVIDIA Corporation GeForce RTX 2060 Mobile 和 0000:01:00.1 NVIDIA Corporation High Definition Audio Controller 等都添加进去。\n最后再在 libvirt 中删除虚拟机的 Display Spice 和 Video QXL ，在 CPUs 中取消 Copy host CPU configuration 并将 Model 选择为 host passthrough。如果你需要直通鼠标和键盘，也可以在这个时候添加。\n创建网桥 有线网卡的网桥创建起来较为简单，这里就不详细介绍了，有需要的可以查看我上一篇软路由虚拟机的 BLOG。因为是笔记本，所以这里主要介绍无线网卡的桥接方法。\n先开启 proxy_arp 和 ip_forward，修改配置文件 /etc/sysctl.conf ，添加下述配置：\nnet.ipv4.ip_forward = 1 net.ipv4.conf.all.proxy_arp = 1 再点击 libvirt 菜单栏上的 Edit - Connection Details ，假设 host 的 ip 为 192.168.3.12，无线网卡为 wlp4s0，新建一个 Network， Name 设置为 proxyArp， Mode 选择 Routed， Forward to 选择 Physical device， Device 设置为 wlp4s0， IPv4 的 Network 设置为 192.168.3.100/28，完成创建。\n然后修改 win10 虚拟机的 NIC 配置，将 Network source 改为 Virtual network ‘proxyArp’: Route to wlp4s0，最后重新启动虚拟机与物理机。\n远程连接 重新启动虚拟机后，使用 RDP 连接到虚拟机中。到 nvidia 官网下载驱动，并进行安装。如果安装过程中并未出现问题，则至此显卡直通配置完成。另外如果不外接显示器的话，windows 的分辨率似乎会被限制在 640x480，不知道会不会对游戏有影响，所以有条件还是买一个 HDMI 欺骗器接到独显连接的显示接口上。\n远程连接方式一共有三种，分别可以适用于不同的情况。\nRDP 简单使用方法：\n 确保使用 FreeRDP 2.0 获取 windows 虚拟机 IP，比如 192.168.3.108 xfreerdp /v:192.168.3.108:3389 /w:1600 /h:900 /bpp:32 +clipboard +fonts /gdi:hw /rfx /rfx-mode:video /sound:sys:pulse +menu-anims +window-drag  对于使用 xfreedp 的 RemoteFX 连接的一些问题：\n 只有窗口化的游戏可以运行，全屏将会触发 d3d11 0x087A0001 不能设置分辨率等问题。媒体播放器不受其影响。  作为解决方案，使用无边框模式游戏，或其他等效方案 windows 客户端似乎没有该问题   由于 RDSH/RDVH 连接不支持“相对”鼠标，鼠标会乱跑  重定向 XBOX 手柄或 USB 摇杆可能会解决这个问题？ 使用 Synergy (v1) 并启用相对鼠标模式 通过 RDP RemoteFX 运行 3D 游戏鼠标不稳定    Looking glass Looking glass 的优点是低延迟，其并不是通过网络与虚拟机通信，而是直接使用一块共享内存。缺点是只能本地连接，而且似乎需要外接一个显示设备（或 HDMI 欺骗器）才能让键盘、鼠标正常工作，并且似乎不能使用 spice 套娃远程操作 looking glass。\n安装 client 首先在 host 系统上安装 looking glass client，在 gentoo 上可以通过如下步骤直接安装我打包的 looking glass。\n$ sudo eselect repository enable gig $ sudo emerge --sync gig $ sudo emerge -avt looking-glass 计算内存大小 通过以下公式，根据你期望的最大分辨率来计算内存大小。\nwidth x height x 4 x 2 = total bytes total bytes / 1024 / 1024 = total megabytes + 10 比如，我想要最大使用 4K 分辨率（3840x2160）：\n3840 x 2160 x 4 x 2 = 66355200 bytes 66355200 / 1024 / 1024 = 63.28 MB + 10 = 73.28 最后要注意内存的大小要上向取整到最接近的 2 的幂，在上面的例子中则应为 128。\n配置 libvirt ...  ...  name='looking-glass'  type='ivshmem-plain'/  unit='M'128   ... 将以上内容添加到虚拟机的 XML 配置中，其中 128 即为上面计算出来的大小。\n如果想要通过 spice 实现键盘和鼠标输入与剪贴板共享，则必须添加 spice 设备。\n  在 libvirt 中，选择 Add Hardware ，然后再选择 Graphics ，使用默认的 spice 配置即可，最后完成添加\n  选择 Video 设备，然后在 Model 栏中输入 none，注意必须要完成这一步，否则可能会造成虚拟机不使用直通的显卡渲染\n  如果有 tablet 设备，则删除\n  如果没有 Mouse 设备，则添加一个\n  如果没有 Keyboard 设备，则添加一个\n 这里使用 Virtio 的键盘可以更好的提高性能，然而 PS/2 的键盘没办法删掉，不知道被哪个设备依赖了，所以就使用 PS/2 的键盘了    还有如果使用 Virtio 的键盘，则需要通过上面加载的 virtio windows 驱动 的 CDROM，以安装驱动\n  创建共享内存文件 新建文件 /etc/tmpfiles.d/10-looking-glass.conf ，其内容为：\n#Type Path Mode UID GID Age Argument f /dev/shm/looking-glass 0660 user kvm - 将其中的 user，改为你自己的用户名。最后使用命令 systemd-tmpfiles --create /etc/tmpfiles.d/10-looking-glass.conf 创建共享内存文件，无需等待下次重启。\n安装 host 首先需要在 windows 中安装 IVSHMEM 驱动，windows 不会自己安装 IVSHMEM 设备，相反它只会为该设备安装一个假驱动。先下载需要安装的驱动程序，https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/upstream-virtio/ ，注意必须下载 0.1.161 或更高的版本，最后将其解压。\n安装 IVSHMEM 驱动需要打开 设备管理器 ，然后在 系统设备 下，找到 PCI标准内存控制器 ，然后选择 更新驱动程序 ，再选择手动更新，选择我们之前下载并解压好的驱动目录，然后安装驱动即可。\nhost 需要在 windows 虚拟机中安装，先下载与 client 版本对应的 host 安装文件：https://looking-glass.io/downloads 。下载完成后解压、安装即可，完成后重启虚拟机，然后通过 log 文件查看其是否正常启动，log 在开始菜单里就有。\n最后再安装一下 spice guest tools， https://www.spice-space.org/download.html#windows-binaries ，以更好的支持鼠标与剪贴板共享。\n配置 client 我使用的配置如下，将配置文件放在 ~/.looking-glass-client.ini 或 /etc/looking-glass-client.ini ：\n[app] renderer=egl shmFile=/dev/shm/looking-glass [win] borderless=yes fullScreen=yes size=1920x1080 [input] grabKeyboard=yes escapeKey=97 [spice] captureOnStart=yes 由于我的笔记本没有 ScrLk 按键，所以将 escape 键设置为了 右 Ctrl 按键。\n至此 looking glass 配置完成，运行命令 looking-glass-client 连接到虚拟机。\n配置 Scream 由于 looking glass 不支持传递音频，所以我们还需要使用 Scream 将 VM 的音频传递给 host。\n首先，编辑 windows 虚拟机的 XML，添加以下部分：\n...  ...  name='scream-ivshmem'  type='ivshmem-plain'/  unit='M'2   ... 然后再如 looking glass 一样，添加配置文件 /etc/tmpfiles.d/11-scream-ivshmem.conf ，并运行命令 systemd-tmpfiles --create /etc/tmpfiles.d/11-scream-ivshmem.conf 。\nf /dev/shm/scream-ivshmem 0660 user kvm - 如果没有安装 IVSHMEM 驱动，则需要安装一下，跟上面一样。然后下载 scream 的 windows 驱动，地址： https://github.com/duncanthrax/scream/releases ，解压并进行安装。\n再以管理员权限在 CMD 中运行 REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Services\\Scream\\Options /v UseIVSHMEM /t REG_DWORD /d 2 。\n在 Linux 物理机中安装 scream，然后创建配置文件 ~/.config/systemd/user/scream-ivshmem-pulse.service ：\n[Unit] Description=Scream IVSHMEM pulse receiver After=pulseaudio.service Wants=pulseaudio.service [Service] Type=simple ExecStartPre=/usr/bin/truncate -s 0 /dev/shm/scream-ivshmem ExecStartPre=/bin/dd if=/dev/zero of=/dev/shm/scream-ivshmem bs=1M count=2 ExecStart=/usr/bin/scream -m /dev/shm/scream-ivshmem [Install] WantedBy=default.target 最后运行以下命令即可：\n$ sudo systemctl start --user scream-ivshmem-pulse $ sudo systemctl enable --user scream-ivshmem-pulse 这样就配置完成了，在 looing glass 里就可以听到声音了。\nsteam 远程畅玩（流式传输） 因为 RDP 的限制，像 steam 家庭串流或 Geforce Experience 的方式对游戏来说更为推荐。\n如果不想每次串流游戏都输入密码解锁屏幕，则可以通过 RDP 以管理员权限运行 cmd，然后运行以下命令，也可以将其保存为脚本，方便以后使用。注意运行完该命令会立马断开 RDP。\n@powershell -NoProfile -ExecutionPolicy unrestricted -Command \"$sessionid=((quser $env:USERNAME | select -Skip 1) -split '\\s+')[2]; tscon $sessionid /dest:console\" 2 UnlockErrors.log benchmark 简单运行了一下 3dmark 的 Time Spy，做虚拟机的图形性能测试。测试了以下几种情况：\n win10 + 物理机直接运行，3dmark 得分 6900 win10 + 虚拟机显卡直通 + 外接显示器，3dmark 得分 6000 win10 + 虚拟机显卡直通 + steam 串流，3dmark 得分 5600 win10 + 虚拟机显卡直通 + looking glass，3dmark 得分 5000，并且在加载的时候，画面延迟近 10 秒  由此可见，想要玩游戏，还是最好外接显示器，或者起码使用 steam 串流吧，个人感觉 looking glass 的性能甚至可能没有 RDP 高，但 RDP 无法运行 3dmark，所以无法比较测试。另外这几种情况中，CPU 得分的差距更大，但一般游戏也不会占用过多 CPU 资源，所以这里并没有记录。\nPS：win10 + 虚拟机显卡直通 + looking glass + HDMI 欺骗器，3dmark 得分也是 5600，looking glass 的性能有待进一步测试。\n参考链接  PCI passthrough via OVMF https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF [GUIDE] Optimus laptop dGPU passthrough https://gist.github.com/Misairu-G/616f7b2756c488148b7309addc940b28 Vendor ID \u0026 Device ID https://github.com/marcosscriven/ovmf-with-vbios-patch/issues/2 笔记本 Optimus MUXless 下的 Intel 和 NVIDIA 虚拟机显卡直通 https://lantian.pub/article/modify-computer/laptop-intel-nvidia-optimus-passthrough.lantian/ ledis 的单显卡直通教程 https://github.com/ledisthebest/LEDs-single-gpu-passthrough/blob/main/README-cn.md Looking glass Installation https://looking-glass.io/docs/676/install Bridging Network Connections with Proxy ARP https://wiki.debian.org/BridgeNetworkConnectionsProxyArp setup kvm on a wireless interface on a laptop machine https://unix.stackexchange.com/questions/159191/setup-kvm-on-a-wireless-interface-on-a-laptop-machine 桥接无线网卡 https://blog.lilydjwg.me/2020/5/19/bridged-wireless-network.215330.html  附录：XML 配置 最后附上我的虚拟机的 XML 配置。\n type='kvm' id='1' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0' win10 d5da831a-c1eb-4668-a864-0731557d80a0   xmlns:libosinfo=\"http://libosinfo.org/xmlns/libvirt/domain/1.0\"  id=\"http://microsoft.com/win/10\"/    unit='KiB'33554432  unit='KiB'33554432  placement='static'8  /machine    arch='x86_64' machine='pc-q35-6.0'hvm  readonly='yes' type='pflash'/usr/share/edk2-ovmf/OVMF_CODE.fd /var/lib/libvirt/qemu/nvram/win10_VARS.fd  enable='no'/       state='on'/  state='on'/  state='on' retries='8191'/   state='off'/   mode='host-passthrough' check='partial' migratable='on'  sockets='1' dies='1' cores='4' threads='2'/   offset='localtime'  name='rtc' tickpolicy='catchup'/  name='pit' tickpolicy='delay'/  name='hpet' present='no'/  name='hypervclock' present='yes'/  destroy restart destroy   enabled='no'/  enabled='no'/   /usr/bin/qemu-system-x86_64  type='file' device='disk'  name='qemu' type='qcow2'/  file='/var/lib/libvirt/images/win10.qcow2' index='3'/   dev='vda' bus='virtio'/  order='1'/  name='virtio-disk0'/  type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/   type='file' device='cdrom'  name='qemu' type='raw'/  file='/home/petrus/Downloads/iso/cn_windows_10_enterprise_ltsc_2019_x64_dvd_9c09ff24.iso' index='2'/   dev='sdb' bus='sata'/   order='2'/  name='sata0-0-1'/  type='drive' controller='0' bus='0' target='0' unit='1'/   type='file' device='cdrom'  name='qemu' type='raw'/  file='/home/petrus/Downloads/iso/virtio-win-0.1.185.iso' index='1'/   dev='sdc' bus='sata'/   name='sata0-0-2'/  type='drive' controller='0' bus='0' target='0' unit='2'/   type='usb' index='0' model='qemu-xhci' ports='15'  name='usb'/  type='pci' domain='0x0000' bus='0x02' slot='0x00' function='0x0'/   type='sata' index='0'  name='ide'/  type='pci' domain='0x0000' bus='0x00' slot='0x1f' function='0x2'/   type='pci' index='0' model='pcie-root'  name='pcie.0'/   type='pci' index='1' model='pcie-root-port'  name='pcie-root-port'/  chassis='1' port='0x10'/  name='pci.1'/  type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0' multifunction='on'/   type='pci' index='2' model='pcie-root-port'  name='pcie-root-port'/  chassis='2' port='0x11'/  name='pci.2'/  type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x1'/   type='pci' index='3' model='pcie-root-port'  name='pcie-root-port'/  chassis='3' port='0x12'/  name='pci.3'/  type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x2'/   type='pci' index='4' model='pcie-root-port'  name='pcie-root-port'/  chassis='4' port='0x13'/  name='pci.4'/  type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x3'/   type='pci' index='5' model='pcie-root-port'  name='pcie-root-port'/  chassis='5' port='0x14'/  name='pci.5'/  type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x4'/   type='pci' index='6' model='pcie-root-port'  name='pcie-root-port'/  chassis='6' port='0x15'/  name='pci.6'/  type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x5'/   type='pci' index='7' model='pcie-root-port'  name='pcie-root-port'/  chassis='7' port='0x8'/  name='pci.7'/  type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x0' multifunction='on'/   type='pci' index='8' model='pcie-root-port'  name='pcie-root-port'/  chassis='8' port='0x9'/  name='pci.8'/  type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/   type='pci' index='9' model='pcie-root-port'  name='pcie-root-port'/  chassis='9' port='0xa'/  name='pci.9'/  type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/   type='pci' index='10' model='pcie-root-port'  name='pcie-root-port'/  chassis='10' port='0xb'/  name='pci.10'/  type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x3'/   type='pci' index='11' model='pcie-to-pci-bridge'  name='pcie-pci-bridge'/  name='pci.11'/  type='pci' domain='0x0000' bus='0x0a' slot='0x00' function='0x0'/   type='pci' index='12' model='pcie-root-port'  name='pcie-root-port'/  chassis='12' port='0xc'/  name='pci.12'/  type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x4'/   type='virtio-serial' index='0'  name='virtio-serial0'/  type='pci' domain='0x0000' bus='0x03' slot='0x00' function='0x0'/   type='network'  address='52:54:00:9c:b1:61'/  network='proxyArp' portid='dea4d995-d8d9-408d-ac30-ac45bfd5627e' bridge='virbr1'/  dev='vnet0'/  type='virtio'/  name='net0'/  type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/   type='pty'  path='/dev/pts/0'/  type='isa-serial' port='0'  name='isa-serial'/   name='serial0'/   type='pty' tty='/dev/pts/0'  path='/dev/pts/0'/  type='serial' port='0'/  name='serial0'/   type='spicevmc'  type='virtio' name='com.redhat.spice.0' state='connected'/  name='channel0'/  type='virtio-serial' controller='0' bus='0' port='1'/   type='mouse' bus='ps2'  name='input0'/   type='keyboard' bus='ps2'  name='input1'/   type='spice' port='5900' autoport='yes' listen='127.0.0.1'  type='address' address='127.0.0.1'/  compression='off'/  enable='no'/   model='ich9'  name='sound0'/  type='pci' domain='0x0000' bus='0x00' slot='0x1b' function='0x0'/   id='1' type='spice'/   type='none'/  name='video0'/   mode='subsystem' type='pci' managed='yes'  name='vfio'/   domain='0x0000' bus='0x01' slot='0x00' function='0x0'/   name='hostdev0'/  type='pci' domain='0x0000' bus='0x06' slot='0x00' function='0x0'/   mode='subsystem' type='pci' managed='yes'  name='vfio'/   domain='0x0000' bus='0x01' slot='0x00' function='0x1'/   name='hostdev1'/  type='pci' domain='0x0000' bus='0x07' slot='0x00' function='0x0'/   mode='subsystem' type='pci' managed='yes'  name='vfio'/   domain='0x0000' bus='0x01' slot='0x00' function='0x2'/   name='hostdev2'/  type='pci' domain='0x0000' bus='0x08' slot='0x00' function='0x0'/   mode='subsystem' type='pci' managed='yes'  name='vfio'/   domain='0x0000' bus='0x01' slot='0x00' function='0x3'/   name='hostdev3'/  type='pci' domain='0x0000' bus='0x09' slot='0x00' function='0x0'/   bus='usb' type='spicevmc'  name='redir0'/  type='usb' bus='0' port='2'/   bus='usb' type='spicevmc'  name='redir1'/  type='usb' bus='0' port='3'/   model='virtio'  name='balloon0'/  type='pci' domain='0x0000' bus='0x05' slot='0x00' function='0x0'/   name='looking-glass'  type='ivshmem-plain'/  unit='M'128  name='shmem0'/  type='pci' domain='0x0000' bus='0x0b' slot='0x01' function='0x0'/   name='scream-ivshmem'  type='ivshmem-plain'/  unit='M'2  name='shmem1'/  type='pci' domain='0x0000' bus='0x0b' slot='0x02' function='0x0'/    type='dynamic' model='dac' relabel='yes' +77:+77 +77:+77    value='-set'/  value='device.hostdev0.x-pci-sub-vendor-id=6058'/  value='-set'/  value='device.hostdev0.x-pci-sub-device-id=14919'/   Apps 中文字体 在应用之前，最好先安装好中文字体和 emojis\n# emerge media-fonts/noto-cjk media-fonts/noto-emoji # eselect fontconfig list # eselect fontconfig enable 70-noto-cjk.conf 也可以将字体文件复制到目录 ~/.local/share/fonts/ 下，然后执行 fc-cache -f -v 创建字体缓存。\n改善字体渲染效果   安装字体：下载更纱黑体\nTUNA (CN): https://mirrors.tuna.tsinghua.edu.cn/github-release/be5invis/Sarasa-Gothic\nNJU (CN): https://mirror.nju.edu.cn/github-release/be5invis/Sarasa-Gothic\n  调整系统字体：系统设置 - 字体\n在系统字体设置那将那些默认的noto sans字体改为更纱黑体即可，前三个最好相应调大一个等级。等距字体可以使用等距更纱黑体，也可以使用你喜欢的等距字体。\n  调整系统缩放：系统设置 - 显示和监控 - 显示配置 - 缩放显示\n默认是100%，可以调整到110～120之间，具体数值根据自己效果设定\n  调整字体DPI：系统设置 - 字体 - 勾选“固定字体DPI”并调整DPI的值\n默认是96，同样也可以调整到110~120之间，具体数值根据自己效果设定\n  调整字体展示优先级：将下述内容保存为 ~/.fonts.conf文件\n    sans-serif  Sarasa Gothic SC Sarasa Gothic TC Sarasa Gothic J Sarasa Gothic K    monospace  Sarasa Mono SC Sarasa Mono TC Sarasa Mono J Sarasa Mono K      调整完之后注销重新登入\n输入法 作为中文用户，肯定需要款输入法，我推荐使用 fcitx （还有一款叫 ibus）。目前稳定维护的 fcitx 版本是 5 ，但是官方仓库 ::gentoo 目前只有 4 （也能用，就是不怎么维护了）。\n官方仓库 fcitx4 重要：先配置下 fcitx4 开启对 gtk2 的支持以避免有些程序无法使用（gtk3 默认开启了）\n# echo 'app-i18n/fcitx gtk2'  /etc/portage/package.use/fcitx 然后安装\n# emerge app-i18n/fcitx:4 app-i18n/fcitx-configtool:4 app-i18n/fcitx-qt5:4 app-i18n/fcitx-libpinyin:4 其中：\n app-i18n/fcitx 是 fcitx 的主程序 app-i18n/fcitx-configtool 是它的配置工具 app-i18n/fcitx-qt5 用于支持在 qt 程序上使用它 app-i18n/fcitx-libpinyin 是一个输入法  额外仓库 fcitx5 为使用最新的 fcitx5，这里需要使用额外的仓库 ，因为官方仓库目前（2021-11-23）没有。提供 fcitx5 的 Gentoo 仓库（Overlay）推荐 gentoo-zh 。具体方法为：\n  先安装添加额外的仓库必要的工具\n# emerge app-eselect/eselect-repository   然后启用仓库，启用过程中，可能会因为网络原因导致比较慢，请耐心等待\n# eselect repository enable gentoo-zh   更新以获取下仓库内容。\n# emerge dev-vcs/git # emerge --sync gentoo-zh 如果一直卡在这里，那说明当前网络访问 github.com 不流畅。这时候有一种方法是：访问 https://fastgit.org （我不对该网站做任何保证），　修改 /etc/portage/repos.conf/eselect-repo.conf 文件，替换对应链接的域名为上述网站内指定值，并再次同步。\n  添加 portage 配置用于安装\n# mkdir -p /etc/portage/package.mask/ # nano /etc/portage/package.mask/gentoo-zh */*::gentoo-zh # mkdir -p /etc/portage/package.unmask/ # nano /etc/portage/package.unmask/fcitx5 app-i18n/fcitx5-meta::gentoo-zh app-i18n/fcitx5::gentoo-zh app-i18n/fcitx5-configtool::gentoo-zh app-i18n/fcitx5-chinese-addons::gentoo-zh app-i18n/fcitx5-gtk::gentoo-zh app-i18n/fcitx5-qt::gentoo-zh app-i18n/libime::gentoo-zh x11-libs/xcb-imdkit::gentoo-zh # mkdir -p /etc/portage/package.accept_keywords # nano /etc/portage/package.accept_keywords/fcitx5 app-i18n/fcitx5-meta ~amd64 app-i18n/fcitx5 ~amd64 app-i18n/fcitx5-configtool ~amd64 app-i18n/fcitx5-chinese-addons ~amd64 app-i18n/fcitx5-gtk ~amd64 app-i18n/fcitx5-qt ~amd64 app-i18n/libime ~amd64 x11-libs/xcb-imdkit ~amd64   之后安装\n# emerge app-i18n/fcitx5-meta 或者\n# EGIT_OVERRIDE_REPO_FCITX_LIBIME=https://hub.fastgit.org/fcitx/libime.git EGIT_OVERRIDE_REPO_KPU_KENLM=https://hub.fastgit.org/kpu/kenlm.git emerge app-i18n/fcitx5-meta 这里安装了 fcitx 的元包，它会自动依赖安装 fcitx5 主体、 RIME 输入法、配置工具等，这个仓库也会默认安装上 fcitx5-chinese-addons ，里面包含有中文输入法。\n如果安装的时候长时间停止在校验 manifest，尝试用 eclean 清除 distfiles 和 packages。可能原因是混合使用了 gentoo（官方） 和 gentoo-zh（overlay）。\n  最后安装肥猫百万大词库：\nDownload latest version of “zhwiki.dict” from https://github.com/felixonmars/fcitx5-pinyin-zhwiki/releases\nCopy into ~/.local/share/fcitx5/pinyin/dictionaries/ (create the folder if it does not exist)\n  提示：\n  当使用非官方的 Fcitx5 时，因为没有镜像收录，所以源码需从 Github 下载，这时可能遇到因网络问题导致无法下载的情况（可以从 /var/log/emerge-fetch.log 文件查看源码包下载情况），如果遇到这种情况那么请自行通过各种途径下载好对应的 .tar.gz 格式（或类似）软件包，然后移动到 /var/cache/distfiles/ 目录下。\n  软件包需更名为对应的包名加完整的版本号（执行上述 emerge  命令后可以看到完整的版本号），比如当显示的包名为 app-i18n/fcitx-gtk-5.0.8:5::gentoo-zh 那么就更名下载的源码包为 fcitx-gtk-5.0.8.tar.gz （ / 符号后以及 : 符号前的内容），以此类推。\n  或者，在 emerge-fetch.log 可以看到下载链接和类似如下的行\nSaving to: ‘/var/cache/distfiles/fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2.__download__’ 通过下载链接下载文件后，改名为删除 .__download__ 剩余部分，如 fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2，然后删除对应的 /var/cache/distfiles/fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2.__download__ 缓存文件，并把重命名的文件移动到 /var/cache/distfiles/。\n  拥抱Fcitx5 起因\n2015年12月，计科杀手 csslayer 创建了fcitx/fcitx5代码库，独自开始了对 Fcitx5 的开发。\n如今五年过去了，Fcitx5 也日渐成熟。（个人感觉算法上相当不错\n今年年初，我从 fcitx-rime 换到 fcitx5-rime ，感觉并不明显 （毕竟对于 Rime 用户来说从4到5最大的变化是界面\n然后，在 Arch Linux CN 众多群友的诱惑下, 我决定尝试一下 Fcitx5 自带的拼音输入法。\n首次使用的体验是相当的棒的，Fcitx5 在默认配置下表现良好，云拼音也有百度，Google，Google CN 三种可选尽管我不怎么用云拼音，整句输入也是相当的棒，还有输入预测功能。\n但这并不是让我抛弃我在 Rime 积攒下的词库投靠老K输入法Fcitx5自带拼音的理由……真正的原因是最近发生的几件事……\n  首先是非常好的反馈体验，开发者老K对待用户非常友好，而且生产力十足\n  然后是 Felix 爬了维基百科制作了肥猫百万大词库，随后大佬 outloudvi 制作了萌娘百科词库，Fcitx5 的日用词库基本满足（AUR 上皆有打包，且在 Arch CN 源有打包\n  肥猫大词库中的一个讨论促使Fcitx5引入了一项新功能——根据前缀生成候选项，效果如图：\n这个功能我觉得对于长词输入是很棒的\n  添加了类似搜狗U模式的拆字模式，效果如图：\n  还有一件事是 Fcitx5 可以使用 fcitx, fcitx5, ibus 的输入法模块（感觉黑科技\n  我从 rime 移植过来一份符号表，这样输入就方便了很多\n  优势\n 上述几条个人认为皆为优势 fcitx5-rime 支持加载动态库形式的 Rime 插件，在设置中填写插件名称即可使用，注意 octagram 插件名称与文件名并不一样（fcitx-rime 无此支持，ibus-rime 有此支持但是似乎配置文件有点问题（喜讯：Arch 官方仓库中的 librime 已经打包了 lua 和 octagram（即语料库）插件 自带一套 LaTeX 简易输入表（虽然只能输入一小部分特殊字符 笔画过滤: 参见 Fcitx5_使用笔画过滤 以词定字 查看选中文字的 Unicode 编码：选中文字，然后使用快捷键 ctrl + alt + shift + u 可以查看选中文字的编码 更好的支持（Fcitx4 已经停止支持  关于设置\n推荐以下设置：\n 预测看个人喜好 启用颜文字 云拼音根据需要来，但是不推荐 Google 后端，原因显然 preedit 也就是单行显示自己选择 安装肥猫百万大词库（墙裂推荐 Lua 插件！！！自带日期和时间，另外推荐几个，内含进制转换、简易计算器和密码生成器  主题美化\n有以下几种选择：\n  kimpanel(KDE)/gnome-shell-extension-kimpanel(Gnome) （同时这也应该是目前 Wayland 下唯一的方案）\n  Material Color 主题，有多种颜色以及单行双行两种模式，Arch 官方源有打包\n  黑色透明主题\n  黑色主题\n  Materia EXP 主题，系统使用暗色主题的用户请谨慎使用\n  Simple Blue 主题\n  Adwaita-dark，推荐 Gnome 用户使用\n  经典的Material 主题，这个主题同时支持4和5 我都没注意这个主题更新了 fcitx5 支持（fcitx5 版本有人在 AUR 上打了包，包名：fcitx5-skin-material\n  base16 material darker 主题\n  自制主题 （顺便写份主题文档吧\n  以上主题在 AUR 皆有打包(似乎目前已有主题在 AUR 上都有打包了\nfcitx5皮肤制作 这次是 fcitx5 是用搜狗皮肤（无法实现动态）！\n下载仓库\n$ git clone https://github.com/fkxxyz/ssfconv.git $ cd ssfconv 下载皮肤\n先从搜狗输入法的皮肤官网下载自己喜欢的皮肤，得到ssf格式的文件，例如 【雨欣】蒲公英的思念.ssf\n转换皮肤\n$ ./ssfconv -t fcitx5 【雨欣】蒲公英的思念.ssf 【雨欣】蒲公英的思念 复制到用户皮肤目录\n$ mkdir -p ~/.local/share/fcitx5/themes/ $ cp -r 【雨欣】蒲公英的思念 ~/.local/share/fcitx5/themes/ 使用该皮肤\n用下面这条命令可以看到该皮肤的名称：\n$ grep Name ~/.local/share/fcitx5/themes/【雨欣】蒲公英的思念/theme.conf 直接修改配置文件 ~/.config/fcitx5/conf/classicui.conf，将 Theme 的值改成这个皮肤的名称即可。\nfcitx(5)+rime的畅快体验   下载词库转换工具：imewlconverter\n  安装 dotnet-runtime\n  寻找词库文件\n 比如从搜狗词库中寻找：搜狗细胞词库词库下载词典_输入法字典 或者从qq词库中寻找：QQ输入法-词库平台    转换词库文件：以“网络工程词库.scel”为例\n$ dotnet ImeWlConverterCmd.dll -ct:pinyin -os:linux -i:scel ./网络工程词库.scel -o:rime ./network.txt  -i:scel对应搜狗的词库文件后缀，如果你要转换qq的词库文件把这里改成qcel -o:rime ./network.txt表示按照rime输入法词库文件格式转换，转换出的文件在当前目录下，且名字为network.txt    转换完成之后将这个文件拷贝到你的用户资料目录下：\n fcitx4: ~/.config/fcitx/rime fcitx5:~/.local/share/fcixt5/rime  文件以luna_pinyin.xxx.dict.yaml的格式命名，如luna_pinyin.network.dict.yaml，之后重启fcitx(5)即可\n  dict.7z 是我的词库文件，拿去解压到你的用户资料目录下即可使用。\n环境配置 无论选择哪个版本、哪个仓库，安装完成后，均执行此配置，这里另开一个终端，以普通用户编辑 ~/.pam_environment 文件（这里为普通用户的家目录下，不存在则创建一个），然后添加以下内容：\nGTK_IM_MODULE DEFAULT=fcitx QT_IM_MODULE DEFAULT=fcitx XMODIFIERS DEFAULT=\\@im=fcitx SDL_IM_MODULE DEFAULT=fcitx 之后，登出 KDE Plasma，后重新登陆，此时只需做最后的配置，以安装的为 fcitx:5 为例，\n 右击托盘区输入法图标，选择 Configure 点击右下角 Add Input Method search 框下输入 Pinyin 选中 Pinyin 后点击右下角的 Add Apply 后退出界面 右击托盘区输入法图标，选择 Restart  Rime 安装 rime 输入法引擎\n# fcitx4 $ sudo emerge app-i18n/fcitx-rime # fcitx5 $ sudo emerge app-i18n/fcitx5-rime 下载 rime-cloverpinyin 最新版本（如clover.schema-build-1.1.4.zip）输入方案（配置方案），解压到用户资料夹：\n fcitx：~/.config/fcitx/rime fcitx5：~/.local/share/fcitx5/rime  在用户资料夹下创建 default.custom.yaml ，内容为\npatch: \"menu/page_size\": 8 schema_list: - schema: clover 其中 8 表示打字的时候输入面板的每一页的候选词数目，可以设置成 1~9 任意数字。\n写好该文件之后，点击右下角托盘图标右键菜单，点“重新部署”，然后再点右键，在方案列表里面应该就有“ 🍀️四叶草拼音输入法”的选项了。\n更多访问 Rime 官网。\nKDE System Settings Appearance\n Global Theme: Breeze  Workspace Behavior\n General Behavior  Clicking files or folders: Selects them   Screen Locking  Lock screen automatically: 10 minutes    Startup and Shutdown\n Login Screen  Breeze    Regional Settings\n Date \u0026 Time  Set date and time automatically    Connections\n IPv4  Method: Automatic (Only addresses) DNS Servers: 114.114.114.114    Settings\n Proxy  Use manually specified proxy configuration    Display Configuration\n  Night Color\n  Activate Night Color\n  Sunset to sunrise at manual location\nBeijin: 39.90403 116.40753\n    Bluetooth 蓝牙默认是无法使用的\n# systemctl enable bluetooth 首选编辑器 Gentoo Linux 默认安装的编辑器为 nano ，这是一个初始设置下就很适合新手的编辑器，如果你有其它的要求，比如想使用 vim 或者 emacs ，可以先安装\n# emerge -vj app-editors/vim # emerge -vj app-editors/emacs 列出当前存在的编辑器\n# eselect editor list 根据所需要的编辑器对应的序号，设置默认\n# eselect editor set 「序号」 # . /etc/profile mutt # emerge net-mail/fetchmail mail-filter/procmail mail-client/mutt mail-mta/msmtp mpv # emerge media-video/mpv spotify # emerge media-sound/spotify youtube-dl # emerge dev-python/pip ... aria2 # echo 'net-misc/aria2 bittorrent'  /etc/portage/package.use/aria2 # emerge net-misc/aria2 Typora # echo '=app-editors/typora-0.11.18::gentoo-zh='  /etc/portage/package.unmask/typora # echo '=app-editors/typora-0.11.18::gentoo-zh ~amd64'  /etc/portage/package.accept_keywords/typora # cp -av /opt/typora/share/icons/hicolor/* /usr/share/icons/hicolor/ zsh # emerge app-shells/zsh $ chsh Password: Changing the login shell for kurome Enter the new value, or press ENTER for the default Login Shell [/bin/bash]: /bin/zsh Clash clash 需要 root 执行，编写一个 service 就可以了。\ncfw 无法设置 port，总是重置为 0。\nBrowsers 关于浏览器的选择有很多，比如\n www-client/google-chrome （chrome 的官方二进制包） www-client/google-chrome-beta （chrome 的官方二进制包， beta 分支） www-client/chromium （chromium 源码包，需编译，时间很久很久） www-client/firefox-bin （火狐官方二进制包，国际版） www-client/firefox （火狐源码包，需编译，时间很久） www-client/microsoft-edge-beta （Edge 官方二进制包， beta 分支） 等  可以自行选择安装。命令依旧是 emerge  。安装个别浏览器时，可能会因为许可问题导致无法安装，如何解决看下文的 软件的许可 一节。\n其它的应用自行发掘。这里有推荐应用列表：\n https://wiki.gentoo.org/wiki/Recommended_applications https://wiki.archlinux.org/title/List_of_applications  至此，桌面配置告一段落。\nkio-extras (only for kde)\nMTP (Media Transfer Protocol) is a protocol to allow the transfer of files to external devices. It is provided by several programs, most of them depending on FUSE.\n# echo 'kde-apps/kio-extras mtp'  /etc/portage/package.use/kio-extras # emerge --ask kde-apps/kio-extras Gwenview KDE app，看图。\n# emerge kde-apps/gwenview Okular KDE app，PDF 阅读。\n# emerge kde-apps/okular KTimer KDE app，类似于 cronie，只不过是GUI。\n# emerge kde-apps/ktimer KClock KDE app，一个时钟。\n# eselect repository enable guru # emerge --sync guru # echo '*/*::guru'  /etc/portage/package.mask/guru # echo '=kde-apps/kclock-21.12::guru'  /etc/portage/package.unmask/kclock # echo '=kde-apps/kclock-21.12::guru ~amd64'  /etc/portage/package.accept_keywords/kclock # echo '=kde-frameworks/kirigami-addons-0.2::guru'  /etc/portage/package.unmask/kclock # echo '=kde-frameworks/kirigami-addons-0.2::guru ~amd64'  /etc/portage/package.accept_keywords/kcloc # emerge kde-apps/kclock RSIBreak 番茄钟\nLibreOffice # emerge app-office/libreoffice-bin Flameshot 很棒的截图软件\n$ sudo emerge media-gfx/flameshot Spectacle KDE app，用的不是很习惯。\n# emerge kde-apps/spectacle KeePassXC # emerge app-admin/keepassxc PPSSPP # echo \"games-emulation/ppsspp ~amd64\"  /etc/portage/package.accept_keywords/ppsspp # emerge games-emulation/ppsspp papirus-icon-theme $ sudo emerge -a papirus-icon-theme Vulkan # emerge --ask media-libs/vulkan-loader tree # emerge app-text/tree qemu # echo 'QEMU_SOFTMMU_TARGETS=\"x86_64\"'  /etc/portage/make.conf # echo 'QEMU_USER_TARGETS=\"x86_64\"'  /etc/portage/make.conf # emerge app-emulation/qemu net-fs/samba # gpasswd -a kurome kvm Could not access KVM kernel module: Permission denied\nDocker # emerge --ask --verbose app-emulation/docker # systemctl enable docker.service # systemctl start docker.service # usermod -aG docker  # docker run --rm hello-world lsusb # emerge --ask sys-apps/usbutils p7zip # emerge app-arch/p7zip Important: The 7-zip archive format does not store standard Unix file permissions such as owner/group or extended file attributes. Those who desire to use 7-zip as a long-term backup or archiving solution should wrap files in a tar archive before compressing with 7z. Use the following command to archive directories of files, preserving Unix file permissions:\n$ tar cf -  | 7za a -si .tar.7z To extract:\n$ 7za x -so .tar.7z | tar xf - zip # emerge app-arch/zip Ark File archiver by KDE\n# emerge kde-apps/ark ADB and Fastboot Fastboot is included with ADB inside the dev-util/android-tools package::\n# emerge --ask dev-util/android-tools To run adb without root privileges then the unprivileged user account must be added to the plugdev group:\n# groupmod -a plugdev -U kurome no permissions (missing udev rules? user is in the plugdev group)\n需添加 udev 规则：使用下面的模板，并用你的 [VENDOR ID] 和 [PRODUCT ID] 替换里面的值。 然后把这些规则复制到 /etc/udev/rules.d/51-android.rules：\nSUBSYSTEM==\"usb\", ATTR{idVendor}==\"[VENDOR ID]\", MODE=\"0666\", GROUP=\"adbusers\" SUBSYSTEM==\"usb\",ATTR{idVendor}==\"[VENDOR ID]\",ATTR{idProduct}==\"[PRODUCT ID]\",SYMLINK+=\"android_adb\" SUBSYSTEM==\"usb\",ATTR{idVendor}==\"[VENDOR ID]\",ATTR{idProduct}==\"[PRODUCT ID]\",SYMLINK+=\"android_fastboot\" 再加载刚定义的规则，运行：\n# udevadm control --reload-rules 确保你是 adbusers user group 的成员，以访问 adb 设备。\nadb: device unauthorized.\n请打开手机同意 USB 调试。\nFile transfer Push a file\n$ adb push mypicture.png /sdcard/on/device Push a folder\n$ adb push myfolder /sdcard/on/device Push all files in a folder\n$ adb push myfolder/ /sdcard/on/device Pull a file\n$ adb pull /sdcard/on/device/mypicture.png Pull a folder\n$ adb pull /sdcard/on/device /home/̩$(whoami)/android-folder/ Flatpak # cat  /etc/portage/package.accept_keywords/flatpak sys-apps/flatpak ~amd64 acct-user/flatpak ~amd64 acct-group/flatpak ~amd64 dev-util/ostree ~amd64 # emerge sys-apps/flatpak # flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo # flatpak remote-modify flathub --url=https://mirror.sjtu.edu.cn/flathub neofetch $ sudo emerge app-misc/neofetch 使用自定义图像 默认情况下，Neofetch 将显示你的操作系统 logo 以及系统信息。当然，你可以根据需要更改图像。\n要显示图像，Linux 系统应该安装以下依赖项：\n w3m-img（用于显示图像。w3m-img 有时与 w3m 包捆绑在一起）， Imagemagick（用于创建缩略图），  大多数 Linux 发行版的默认仓库中都提供了 w3m-img 和 ImageMagick 包。因此，你可以使用你的发行版的默认包管理器来安装它们。\n现在，运行以下命令以使用自定义图像显示系统信息：\n$ neofetch --w3m /home/sk/Pictures/image.png 或者，\n$ neofetch --w3m --source /home/sk/Pictures/image.png 或者，你可以指向包含以下图像的目录。\n$ neofetch --w3m  配置 Neofetch 当我们第一次运行 Neofetch 时，它默认会为每个用户在 $HOME/.config/neofetch/config.conf 中创建一个配置文件。你可以调整此文件来告诉 neofetch 该显示、删除和/或修改哪些详细信息。\n还可以在不同版本中保留此配置文件。这意味着你只需根据自己的喜好自定义一次，并在升级到更新版本后使用相同的设置。你甚至可以将此文件共享给你的朋友和同事，使他拥有与你相同的设置。\ncpuid2cpuflags 检测cpu指令集\n$ sudo emerge app-portage/cpuid2cpuflags $ sudo cpuid2cpuflags 安装完成之后使用该指令并将输出值作为CPU_FLAGS_X86的值输入到make.conf中\nflaggie 安装flaggie来更加方便的管理单个包的USE变量\n$ sudo emerge app-portage/flaggie 用法：比如添加a包的b特性\n# flaggie a +b 去掉c包的d特性\n# flaggie c -d dwm 长时间日常使用动态窗口管理器之后发现，相比与传统的DE型桌面，这种WM型窗口管理方式确实能很大程度上提高工作效率。\nDE和WM的区别 首先说明一下我即将提到的东西是什么。\n DE：Desktop Environment WM：Window Manager  桌面环境是一个相对完整的概念，一般情况下DE包含WM，比如Gnome3的默认WM是Mutter，KDE5的默认WM是KWin。主流的桌面环境都提供了大量自带的桌面组件来构成其完整的桌面体验。\n窗口管理器只是管理出现在你的桌面上的各种窗口的组件，具体的管理内容包含比如：窗口堆叠方式，窗口移动规则等。大多数人接触到的是堆叠式窗口管理器，一个窗口可以叠放在其他窗口之上，调整窗口的主要方式是鼠标。我即将介绍的dwm（Dynamic Window Manager）属于动态窗口管理器，可以自定义不同窗口的出现规则如平铺或者堆叠，主要的调整窗口的方式是键盘。\n大多数窗口管理器只提供管理窗口的逻辑和人机交互的处理，并不自带其他组件如程序启动器、终端等软件，因此只运行一个窗口管理器理论上是要比运行一个完整的桌面环境更加节约资源，也有更好的可伸缩性。\n实际上WM这个概念是应用了奥卡姆剃刀原理，把那些看似有点用但实际上多余的功能全部剔除，只留下你真正需要的和最常用的功能并加以强化，Less is More.\ndwm与其他wm的区别 前面已经说明了dwm与堆叠式窗口管理器的区别，下面说明一下dwm与其他平铺\u0026动态窗口管理器的区别。\ndwm使用C语言编写，使用修改源代码的方式来进行配置。说到源代码可能有些同学就有点害怕，其实修改源代码也很简单，因为有现成的例子可以复(bai)用(piao)嘛！通过直接修改源代码理论上可以确保你的dwm能满足你所有的需求，同时也没有多余的，你不需要的功能。\n相比之下，另外一个相当流行的动态窗口管理器i3wm也是使用C语言编写，但是通过修改其配置文件来配置，这相当于i3wm向你暴露可以被配置的接口来满足你的需求，但是这样的配置方式缺点在于你不能向其添加你需要的需求，只能向上游提交issue来完成enhancement。\n具有和dwm相似配置能力的窗口管理器是xmonad，它也是通过直接修改源代码的方式来调整配置，但是因为使用haskell编写的所以需要安装相当多的依赖，此外其运行效率也不及dwm。\n通用的wm配置 因为一个可独立运行的窗口管理器默认不携带任何多余的软件，所以为了满足日常使用需要进行一定程度的自定义配置，下面给出一下通用的配置：\n常用软件的推荐\n用半角逗号分隔的同类别软件顺序表示推荐等级\n 终端：kitty, alacritty, termite（前两个有GPU加速） 护眼：redshift-gtk 程序启动器：dmenu, rofi Shell：fish, zsh 壁纸设置器：feh, nitrogen 音乐播放器：mpd\u0026ncmpcpp（基于终端）, deadbeaf-git 特效合成器：picom-jonaburg-git, picom 文件管理器：thunar, nemo 电源管理器：xfce4-power-manager 截图工具：flameshot, scrot 主题设置器：lxappearance\u0026qt5ct\u0026xsettingsd 输入法：fcitx5 科学上网工具：qv2ray 剪切板管理器：copyq 云同步工具：nutstore（坚果云）, dropbox 通知管理器：dunst 锁屏管理器：betterlockscreen, xautolock（用于自动锁屏） pdf 阅读器：zathura（vim风格）, atril（没有gnome依赖的evince） 文本编辑器：nvim, doom emacs(可选)，(vs)code 屏幕亮度调节器：light  关于平铺还是浮动\n个人建议多数窗口平铺，以下窗口默认浮动：\nvirtualbox, lxappearance, qq, gpick, qalculator, slickpicker\n关于GTK主题和QT主题\n我建议让QT程序使用GTK主题，除上文提到的qt5ct再安装qt5-styleplugins\n在qt5ct中设置风格为gtk2\ndwm安装 $ wget https://dl.suckless.org/dwm/dwm-6.2.tar.gz $ tar xpvf dwm-6.2.tar.gz $ mv dwm-6.2 ~/.dwm dwm配置 配置dwm主要需要修改的文件是config.def.h，主要的配置方式是使用被人写好的patch加必要时候的手动修改。dwm的patch都在其官方网站\n具体过程是这样的：\n 找到你需要的patch并下载 将其移动到~/.dwm目录下  $ patch 之后会输出这个patch过程的详细情况，一般情况不会出现问题\n需要注意的是要一个一个来\n出现问题之后需要对照如：config.def.h.rej, dwm.c.rej等后缀为rej的文件来手动修改对应的没有rej后缀的源文件\n打开之后rej文件中行首标有+的行是需要添加的行，标有-的行是需要删除的行\n所有更改都修改完毕之后重新编译安装，执行：\n$ rm -f ./config.h \u0026\u0026 sudo make clean install 不要忘记添加dwm.desktop文件：\n$ sudo vim /usr/share/xsessions/dwm.desktop [Desktop Entry] Encoding=UTF-8 Name=Dwm Comment=Dynamic window manager Exec=dwm Icon=dwm Type=XSession 下面是我自己打完patch之后的配置：\nhttps://github.com/ayamir/dwm-dotfilesgithub.com/ayamir/dwm-dotfiles\n新手可以直接使用我的配置，相对比较完整，使用说明我已经写好了，基本上实现了i3wm上提供的功能。\nCrossover # nano /etc/portage/package.accept_keywords/crossover app-emulation/crossover-bin ~amd64 # nano /etc/portage/package.use/crossover sys-libs/ncurses -gpm # USE=\"abi_x86_32 abi_x86_64\" emerge app-emulation/crossover-bin 作为环境变量的USE设定特点是，本次安装的所有软件都启用该 USE，区别在 make.conf 中使整个系统都启用该 USE 和在 package.use 中为一个一个的包设置同一个 USE（这种情况每次运行只会提示一个包，特别麻烦）。\nUsing ABI_X86 in Gentoo\nABI_X86 is a USE_EXPAND variable; setting ABI_X86=\"32 64\" or USE=\"abi_x86_32 abi_x86_64\" are equivalent.\nRecommended applications: Gentoo List of applications: Arch Tips Petrus.Z Portage command #!/bin/bash euse -E use-flags\t#设置允许use flag（修改/etc/make.conf中的USE） euse -D use-flags\t#设置禁止use flag（修改/etc/make.conf中的USE） euse -i use-flag\t#查询use flag描述 eix RegExp\t#搜索软件包 eix -I\t#列出系统中已安装的软件包 eix --installed-with-use `use`\t#显示哪些已安装的包有`use` flag equery files `PackageName`\t#列出已安装包的文件 equery belongs `FileName`\t#查询已安装的指定文件属于哪个包 equery hasuse `use`\t#查询哪些已安装的包有use flag equery uses `PackageName`\t#显示packege有哪些use ebuild xxx.ebuild digest\t#生成摘要文件 ebuild /var/db/pkg/xxx/xxx.ebuild config\t#初始化配置 equery d package\t#查看依赖package的软件 equery g package\t#查看package的依赖 qdepends package\t# 查询package的依赖 qdepends -rv package\t#输出类似ebuild中或与shell兼容并格式化的依赖 qdepends -Q package\t# 查询哪些包依赖package qlist package\t# 查看package的所有文件列表 qfile file\t# 查看file被哪个package拥有 qcheck package\t# 检查package完整性 qgrep -l package\t# 查找提及package名称的ebuild qgrep -JN package\t# -J限制仅查找已安装的包，-N将打印atom而不是文件名 qlop -um # 查看merge和unmerge log qlop -rt # 查看那当前emerge还有运行了多长时间 qmanifest qtegrity genlop -c #查看当前正在merge的package的编译时间 genlop -t package\t#查看package的编译时间 genlop -u #查看安装与删除的package历史 e-file eread elogv eclean epkginfo apply patches #!/bin/bash  #1.create dir for patches mkdir -p /etc/portage/patches//- #2.put patches at dir which just created above #3.test patches cd $(portageq get_repo_path / gentoo)// ebuild -.ebuild clean prepare #4.With the message \"User patches applied.\" all is good and the package needs to be re-emerged as normally. Kernel #!/bin/bash  #1.select the kernel will use eselect kernel list eselect kernel set  #2.configure the kernel with old config (and diff with previous config) zcat /proc/config.gz  /usr/src/linux/.config diff .config ../linux-x.xx.x-gentoo/.config make silentoldconfig/syncconfig/oldconfig #3.compile\u0026install kernel/modules make -j9 make install # compile\u0026install out-of-tree module(s) make modules_prepare emerge --ask @module-rebuild # install initramfs genkernel --install initramfs #4.clean up old kernel files eclean-kernel grub-mkconfig -o /boot/grub/grub.cfg UpgradeGentoo How to upgrade gentoo #!/bin/bash  #1.sync portage tree to lastest emerge-websync emerge --sync #2.upgrade the system emerge -avutDN --with-bdeps=y @world # -a = --ask, -v = --vebose, -u = --update, -t == --tree, -D = --deep, -N = --newuse emerge -a @smart-live-rebuild #3.may be need to update the new config file dispatch-conf # or etc-update #4.clean the unused package emerge -ac # -c = --depclean #5.rebuild dependency library emerge @preserved-rebuild revdep-rebuild emerge -a @module-rebuild #6.clean old distfiles eclean -d distfiles # or eclean-dist -d How to upgrade python local package # 通过脚本维护local-python-world列表 # 安装或删除 pip_user install  pip_user uninstall  # 将所有local python package升级 pip_upgrade 使用 GNU stow 管理你的點文件 我昨天偶然間發現一些我覺得值得分享的經驗，就是那種「爲毛我沒有早點知道這個？」那一類的。 我將在這篇文章中介紹如何使用 GNU Stow 管理你的 GNU/Linux 系統中位於用戶家目錄裏的各種配置文件 （通常又叫「點文件(dotfiles)」比如 .bashrc）。\n這件事的困難之處在於，如果能用版本管理系統(VCS, Version Control System)比如 Git, Mercurial(hg), Bazaar(bzr) 管理點文件的話會非常方便，但是這些點文件大部分都位於家目錄的頂級目錄下， 在這個位置不太適合初始化一個版本管理倉庫。這些年下來我試過很多程序，設計目的在於解決這個問題， 幫你把這些配置文件安置在某個下級目錄中，然後安裝或者鏈接這些文件到它們應該在的位置。 嘗試下來這些程序沒有一個真正能打動我。它們要麼有很多依賴（比如 Ruby 和一大坨庫）， 要麼需要我記住如何用它，考慮到同步配置這種不算經常使用的場合，要記住用法真的挺難。\n最近我在用 GNU Stow 來管理我從源代碼在本地編譯安裝到 /usr/local/中的一些程序。 基本上說，在這種常見用法下，是你把這些本地編譯的包配置安裝到 /usr/local/stow/${PKGNAME}-{PKGVERSION} 這樣的位置，然後在 /usr/local/stow/目錄中執行 # stow ${PKGNAME}-${PKGVERSION} ，然後它就會爲程序所有的文件創建符號鏈接放在 /usr/local 中合適的地方。然後當你想用 Stow 卸載這個程序的時候，就不必再考慮會留下什麼垃圾文件， 或者找不到安裝時用的 Makefile 了。這種安裝方式下也可以非常容易地切換一個程序的不同版本 （比如我想嘗試不同配置選項下的 dwm 或者 st 的時候）。\n前段時間在我掃郵件列表的時候，看到某個帖子中某人在說使用 Stow 管理安裝他的點文件。 當時我沒特別在意這個帖子，但是大概我大腦潛意識把它歸檔保存爲今後閱讀了。 昨天我想起來試試這種用法，試過後我不得不說，這比那些專門設計用來做這任務的點文件管理器要方便太多了， 雖然表面上看起來這種用法沒那麼顯而易見。\n方法很簡單。我建了個 ${HOME}/dotfiles 文件夾，然後在裏面爲我想管理的每個程序配置都 創建一個子文件夾。然後我把這些程序的配置從原本的家目錄移動到這每一個對應的子文件夾中， 並保持它們在家目錄中的文件夾結構。比如，如果某個文件原本應該位於家目錄的頂層文件夾裏， 那它現在應該放在這個程序名子目錄的頂層文件夾。如果某個配置文件通常應該位於默認的 ${XDG_CONFIG_HOME}/${PKGNAME} 位置 ( ${HOME}/.config/${PKGNAME} )， 那麼現在它應該放在 ${HOME}/dotfiles/${PKGNAME}/.config/${PKGNAME} ，如此類推。然後在那個 dotfiles 文件夾裏面，直接運行 $ stow $PKGNAME 命令， Stow 就會爲你自動創建這些配置文件的符號鏈接到合適的位置。接下來就很容易爲這個 dotfiles 目錄初始化版本管理倉庫，從而記錄你對這些配置文件做的修改（並且這也可以極度簡化在不同電腦之間 共享配置，這也是我想要這麼做的主要原因）。\n舉個例子，比如說你想管理 Bash, VIM, Uzbl 這三個程序的配置文件。Bash 會在家目錄的頂層文件夾 放幾個文件； VIM 通常會有在頂層文件夾的 .vimrc 文件和 .vim 目錄；然後 Uzbl 的配置位於 ${XDG_CONFIG_HOME}/uzbl 以及 ${XDG_DATA_HOME}/uzbl 。於是在遷移配置前，你的家目錄的文件夾結構應該看起來像這樣：\nhome/ brandon/ .config/ uzbl/ [...some files] .local/ share/ uzbl/ [...some files] .vim/ [...some files] .bashrc .bash_profile .bash_logout .vimrc 然後遷移配置的方式是，應該建一個 dotfiles 子目錄，然後像這樣移動所有配置文件：\nhome/ /brandon/ .config/ .local/ .share/ dotfiles/ bash/ .bashrc .bash_profile .bash_logout uzbl/ .config/ uzbl/ [...some files] .local/ share/ uzbl/ [...some files] vim/ .vim/ [...some files] .vimrc 然後執行以下命令：\n$ cd ~/dotfiles $ stow bash $ stow uzbl $ stow vim 然後，瞬間，所有你的配置文件（的符號鏈接）就安安穩穩地放入了它們該在的地方，無論原本這些目錄結構 有多麼錯綜複雜，這樣安排之後的 dotfiles 文件夾內的目錄結構立刻整理得有條有理， 並且可以很容易地轉換成版本控制倉庫。非常有用的一點是，如果你有多臺電腦，可能這些電腦並沒有 安裝完全一樣的軟件集，那麼你可以手選一些你需要的軟件配置來安裝。在你的 dotfiles 文件夾中總是 可以找到所有的配置文件，但是如果你不需要某個程序的某份配置，那你就不對它執行 stow 命令，它就不會擾亂你的家目錄。\n嗯，以上就是整個用法介紹。希望能有別人覺得這個用法有用！我知道對我來說這個非常有幫助。\nFreeing disk space How to Change \u0026 Set the Default crontab Editor $ EDITOR=nano crontab -e How to update dolphin file manager in real time The way in order to refresh Dolphin is to press F5. However, this would be manual.\nIn order to continuously refresh, an automatic solution, create a bash script that runs on boot. This bash script should press F5 every five seconds if Dolphin is open. Create a file named dolphin-update in /usr/local/bin with the following contents:\n#!/bin/bash while true; do PID=$(pgrep \"dolphin\") if [ \"$?\" -ne \"0\" ]; then xdotool key 'F5' fi sleep 5 done You may need to first create it as root and then change the owner to your user:\nsudo chown username:username /usr/local/bin/dolphin-update Ensure that it has executable permissions:\nchmod +x /usr/local/bin/dolphin-update Now we need that to run on boot. To do that run sudo crontab -e and add the following line to the end of the file:\n@reboot /usr/local/bin/dolphin-update This script will run on boot.\nYou should now have a continuously refreshing Dolphin!\nThere are some caveats to this script.\n If you open Dolphin, go to another application where F5 triggers something, (eg Chromium refreshes the page), the script will still run and be a constant annoyance. Solution: Close Dolphin when not actively using it. As a cron job is used, if your computer crashes, the script will not run on boot. However this is a problem with cron not the script.  What the script means, line by line:\n #!/bin/bash - shebang to run with bash while true; do - run continuously PID=$(pgrep \"dolphin\") - find the process ID of a dolphin instance. This is purely there to check whether there is even a instance of Dolphin running. if [ \"$?\" -ne \"0\" ]; then - check the result of whether there is a Dolphin instance running. If there is, then … xdotool key 'F5' - press F5 fi - end the if block sleep 5 - wait 5 seconds before repeating the process done - end the while block  How do I convert a .PNG into a .ICO? $ ffmpeg -i img.png img.ico $ ffmpeg -i img.png -vf scale=32:32 img.ico Crop a photo to fit a circle using ffmpeg $ ffmpeg -i avatar.png -i mask.png -filter_complex \"[0]scale=400:400[ava];[1]alphaextract[alfa];[ava][alfa]alphamerge\" output.png scale=400:400 是 mask.png 的大小。\nmask.png is just a circle, example:\nPath to KDE Picture of the Day $ cd $HOME/.cache/plasma_engine_potd $ file * apod: JPEG image data, JFIF standard 1.01, resolution (DPI), density 96x96, segment length 16, comment: \"Description: Adobe ImageReady\", baseline, precision 8, 960x634, components 3 bing: JPEG image data, JFIF standard 1.01, resolution (DPI), density 96x96, segment length 16, baseline, precision 8, 1920x1080, components 3 unsplash:1065976: JPEG image data, JFIF standard 1.01, resolution (DPI), density 72x72, segment length 16, baseline, precision 8, 3840x2160, components 3 Baloo Baloo is the file indexing and file search framework for KDE Plasma, with a focus on providing a very small memory footprint along with with extremely fast searching.\nIndexing limitations\nBaloo uses the file metadata extractors in KFileMetadata to get information about each file it indexes. This means for a file’s content to be indexed\n the file must have a recognizable MIME type KDE must have an extractor for that MIME type  Other limitations:\n Baloo doesn’t index text files (those whose MIME type is detected as “text/something\") over 10 MB (source). The KFileMetadata extractor for text attempts to convert text to Unicode. If the file uses another encoding, such as iso-8859-1, any file contents after the first character that is invalid in Unicode will not be indexed. You may find the -i option to the file command-line utility useful; it tries to infer the character set of a file, e.g. file -i path/to/myfile.txt.  Using Baloo\nBaloo is not an application, but a daemon to index files. Applications can use the Baloo framework to provide file search results. For example, Dolphin’s Content search can use Baloo.\nKDE System Settings  File Search provides an intentionally limited number of settings. You can make additional adjustments in Baloo’s configuration file.\nbalooctl\nbalooctl is a CLI command to perform certain operations on Baloo. Enter balooctl --help in a terminal app such as userbase:Konsole to list its available subcommands.\nBaloo File Extractor Crashes on every boot I find Baloo fragile and a nuisance. Sometimes it works OK on my amd64 and ~amd64 machines, other times not. If you are not interested in file indexing, you can disable it:\n$ balooctl disable 这个不好用，菊苣（巨巨、大佬）们都推荐关闭。\n内核升级一般步骤 升级内核 建议在make.conf中添加USE='symlink'，然后更新系统。\n$ sudo emerge --ask --verbose --update --deep --newuse @world Configuration $ sudo make menuconfig Build $ sudo make -j4 Install $ sudo make modules_install $ sudo make install BootLoader $ sudo grub-mkconfig -o /boot/grub/grub.cfg 重启以应用新的内核。\nClean $ sudo eclean-kernel -n 1 仅保留当前内核。\nQuestions Problem with transparencies and windowing ghosting out Anyhow, I now applied the “force smoothest animations” in the KDE compositor settings and it seems to have done the trick!Telegram not launching from the browser xdg-open\nTelegram not launching from the browser xdg-open I am receiving the following message:\nUnable to create io-slave. klauncher said: Unknown protocol 'tg'. Hey! So it’s easy to solve\n Open the folder \\~/.local/share/applications find some files about telegram desktop, like an example, my is userapp-Telegram Desktop-FXJ6T0.desktop Add the line at the end of file MimeType=application/x-xdg-protocol-tg;x-scheme-handler/tg; Reload your browser (maybe do not need…) Enjoy!  我的该目录下有两个与telegram相关的desktop文件，都改了之后就行了。\nHow to reset KDE / display settings after a move to a new machine I had to remove .local/share/kscreen on plasma5\nHow can I reset my display settings through terminal? Removing ~/.config/monitors.xml should do it:\ncfw 在gentoo下用不了，设置端口总为0；\nclash 在gentoo下需要root权限，最好用 systemd service 运行。\n",
  "wordCount" : "79889",
  "inLanguage": "en",
  "datePublished": "2022-03-21T15:39:24+08:00",
  "dateModified": "2022-03-21T15:39:24+08:00",
  "author":{
    "@type": "Person",
    "name": "Sakamoto Kurome"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://sakamotokurome.github.io/posts/gentoousage/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Sakamoto Kurome",
    "logo": {
      "@type": "ImageObject",
      "url": "https://sakamotokurome.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://sakamotokurome.github.io/" accesskey="h" title="Sakamoto Kurome (Alt + H)">Sakamoto Kurome</a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://sakamotokurome.github.io/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://sakamotokurome.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://sakamotokurome.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Gentoo Usage
    </h1>
    <div class="post-meta"><span title='2022-03-21 15:39:24 +0800 CST'>March 21, 2022</span>&nbsp;·&nbsp;160 min&nbsp;·&nbsp;Sakamoto Kurome

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#portage%e4%bb%8b%e7%bb%8dhttpswikigentooorgwikihandbookamd64workingportage" aria-label="Portage介绍"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/Portage">Portage介绍</a></a><ul>
                        
                <li>
                    <a href="#%e6%ac%a2%e8%bf%8e%e4%bd%bf%e7%94%a8-portage" aria-label="欢迎使用 Portage">欢迎使用 Portage</a></li>
                <li>
                    <a href="#gentoo-%e8%bd%af%e4%bb%b6%e4%bb%93%e5%ba%93" aria-label="Gentoo 软件仓库">Gentoo 软件仓库</a><ul>
                        
                <li>
                    <a href="#ebuild" aria-label="Ebuild">Ebuild</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0-gentoo-%e8%bd%af%e4%bb%b6%e4%bb%93%e5%ba%93" aria-label="更新 Gentoo 软件仓库">更新 Gentoo 软件仓库</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bb%b4%e6%8a%a4%e8%bd%af%e4%bb%b6" aria-label="维护软件">维护软件</a><ul>
                        
                <li>
                    <a href="#%e6%90%9c%e7%b4%a2%e8%bd%af%e4%bb%b6" aria-label="搜索软件">搜索软件</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e8%bd%af%e4%bb%b6" aria-label="安装软件">安装软件</a></li>
                <li>
                    <a href="#%e6%9f%a5%e6%89%be%e5%b7%b2%e5%ae%89%e8%a3%85%e8%bd%af%e4%bb%b6%e7%9a%84%e6%96%87%e6%a1%a3" aria-label="查找已安装软件的文档">查找已安装软件的文档</a></li>
                <li>
                    <a href="#%e5%8d%b8%e8%bd%bd%e8%bd%af%e4%bb%b6" aria-label="卸载软件">卸载软件</a></li>
                <li>
                    <a href="#%e9%bb%98%e8%ae%a4%e9%80%89%e9%a1%b9" aria-label="默认选项">默认选项</a></li>
                <li>
                    <a href="#understanding-portages-formatted-and-colored-outputhttpwikigentooksiezycplhowto_use_portage_correctlyhtm" aria-label="Understanding Portage&amp;rsquo;s Formatted and Colored Output"><strong><a href="http://wikigentoo.ksiezyc.pl/HOWTO_Use_Portage_Correctly.htm">Understanding Portage&rsquo;s Formatted and Colored Output</a></strong></a></li></ul>
                </li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0%e7%b3%bb%e7%bb%9f" aria-label="更新系统">更新系统</a><ul>
                        
                <li>
                    <a href="#%e5%85%b3%e4%ba%8e%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e7%9a%84%e6%9b%b4%e6%96%b0" aria-label="关于配置文件的更新">关于配置文件的更新</a></li>
                <li>
                    <a href="#%e6%94%b9%e5%8f%98%e6%a1%8c%e9%9d%a2%e7%8e%af%e5%a2%83httpslitterhougelangleylifeblog20210609gentoo-maintain-02-change-profile" aria-label="改变桌面环境/ Change Profile"><a href="https://litterhougelangley.life/blog/2021/06/09/gentoo-maintain-02/">改变桌面环境</a>/ Change Profile</a></li></ul>
                </li>
                <li>
                    <a href="#licenses" aria-label="Licenses">Licenses</a></li>
                <li>
                    <a href="#masking--unmasking-packages" aria-label="Masking &amp;amp; Unmasking packages">Masking &amp; Unmasking packages</a><ul>
                        
                <li>
                    <a href="#%e5%b1%8f%e8%94%bd%e7%89%b9%e5%ae%9a%e7%9a%84%e5%8c%85%e7%89%88%e6%9c%ac" aria-label="屏蔽特定的包版本">屏蔽特定的包版本</a></li>
                <li>
                    <a href="#%e4%bb%8e-ebuild-%e5%ad%98%e5%82%a8%e5%ba%93%e4%b8%ad%e5%b1%8f%e8%94%bd%e5%8c%85" aria-label="从 ebuild 存储库中屏蔽包">从 ebuild 存储库中屏蔽包</a></li></ul>
                </li>
                <li>
                    <a href="#accept_keywordshttpswikigentooorgwikiaccept_keywordszh-cn" aria-label="ACCEPT_KEYWORDS"><a href="https://wiki.gentoo.org/wiki/ACCEPT_KEYWORDS/zh-cn">ACCEPT_KEYWORDS</a></a><ul>
                        
                <li>
                    <a href="#%e5%8f%98%e9%87%8f%e5%9c%a8%e5%93%aa%e9%87%8c%e8%ae%be%e7%bd%ae" aria-label="变量在哪里设置？">变量在哪里设置？</a></li>
                <li>
                    <a href="#%e7%a8%b3%e5%ae%9a%e4%b8%8e%e4%b8%8d%e7%a8%b3%e5%ae%9a%e7%9a%84-keywords" aria-label="稳定与不稳定的 keywords">稳定与不稳定的 keywords</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bd%93portage%e6%8a%a5%e9%94%99%e7%9a%84%e6%97%b6%e5%80%99" aria-label="当Portage报错的时候">当Portage报错的时候</a><ul>
                        
                <li>
                    <a href="#%e7%ae%80%e4%bb%8b" aria-label="简介">简介</a></li>
                <li>
                    <a href="#%e8%a2%ab%e9%98%bb%e6%8c%a1%e7%9a%84%e5%8c%85" aria-label="被阻挡的包">被阻挡的包</a></li>
                <li>
                    <a href="#%e8%a2%ab%e5%b1%8f%e8%94%bd%e7%9a%84%e5%8c%85" aria-label="被屏蔽的包">被屏蔽的包</a></li>
                <li>
                    <a href="#use%e5%bf%85%e8%a6%81%e7%9a%84%e6%9b%b4%e6%94%b9" aria-label="USE必要的更改">USE必要的更改</a></li>
                <li>
                    <a href="#%e7%bc%ba%e5%a4%b1%e4%be%9d%e8%b5%96" aria-label="缺失依赖">缺失依赖</a></li>
                <li>
                    <a href="#%e6%84%8f%e6%8c%87%e4%b8%8d%e6%98%8e%e7%9a%84%e8%bd%af%e4%bb%b6%e5%8c%85" aria-label="意指不明的软件包">意指不明的软件包</a></li>
                <li>
                    <a href="#%e5%be%aa%e7%8e%af%e4%be%9d%e8%b5%96" aria-label="循环依赖">循环依赖</a></li>
                <li>
                    <a href="#%e4%b8%8b%e8%bd%bd%e5%a4%b1%e8%b4%a5" aria-label="下载失败">下载失败</a></li>
                <li>
                    <a href="#%e7%b3%bb%e7%bb%9fprofile%e4%bf%9d%e6%8a%a4" aria-label="系统Profile保护">系统Profile保护</a></li>
                <li>
                    <a href="#digest%e9%aa%8c%e8%af%81%e5%a4%b1%e8%b4%a5" aria-label="Digest验证失败">Digest验证失败</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e5%b7%a5%e5%85%b7" aria-label="其他工具">其他工具</a><ul>
                        
                <li>
                    <a href="#app-portageeixhttpspackagesgentooorgpackagesapp-portageeix" aria-label="app-portage/eix"><a href="https://packages.gentoo.org/packages/app-portage/eix">app-portage/eix</a></a></li>
                <li>
                    <a href="#app-portagegentoolkithttpspackagesgentooorgpackagesapp-portagegentoolkit" aria-label="app-portage/gentoolkit"><a href="https://packages.gentoo.org/packages/app-portage/gentoolkit">app-portage/gentoolkit</a></a><ul>
                        
                <li>
                    <a href="#ecleanhttpswikigentooorgwikiecleanzh-cn" aria-label="eclean"><a href="https://wiki.gentoo.org/wiki/Eclean/zh-cn">eclean</a></a></li></ul>
                </li>
                <li>
                    <a href="#app-portageportage-utilshttpspackagesgentooorgpackagesapp-portageportage-utils" aria-label="app-portage/portage-utils"><a href="https://packages.gentoo.org/packages/app-portage/portage-utils">app-portage/portage-utils</a></a></li>
                <li>
                    <a href="#app-portagepflhttpspackagesgentooorgpackagesapp-portagepfl" aria-label="app-portage/pfl"><a href="https://packages.gentoo.org/packages/app-portage/pfl">app-portage/pfl</a></a></li>
                <li>
                    <a href="#%e5%a4%9a%e7%89%88%e6%9c%ac%e7%ae%a1%e7%90%86" aria-label="多版本管理">多版本管理</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%ba-portage-%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8%e8%ae%be%e7%bd%ae%e4%bb%a3%e7%90%86httpsbitbilinetset-proxy-for-gentoo-portagehtml" aria-label="为 Portage 包管理器设置代理"><a href="https://bitbili.net/set-proxy-for-gentoo-portage.html">为 Portage 包管理器设置代理</a></a><ul>
                        
                <li>
                    <a href="#gentoo-%e7%9a%84%e9%bb%98%e8%ae%a4%e8%ae%be%e7%bd%ae" aria-label="Gentoo 的默认设置">Gentoo 的默认设置</a></li>
                <li>
                    <a href="#%e6%8c%81%e4%b9%85%e6%80%a7%e5%9c%b0%e4%bf%ae%e6%94%b9%e4%bb%a3%e7%90%86" aria-label="持久性地修改代理">持久性地修改代理</a><ul>
                        
                <li>
                    <a href="#%e9%80%9a%e7%94%a8%e9%85%8d%e7%bd%ae" aria-label="通用配置">通用配置</a></li>
                <li>
                    <a href="#%e5%8d%95%e7%8b%ac%e9%85%8d%e7%bd%ae-git-%e6%8a%93%e5%8f%96" aria-label="单独配置 git 抓取">单独配置 git 抓取</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%b4%e6%97%b6%e6%b7%bb%e5%8a%a0%e4%bb%a3%e7%90%86" aria-label="临时添加代理">临时添加代理</a><ul>
                        
                <li>
                    <a href="#%e6%8e%a8%e8%8d%90proxychains" aria-label="推荐：ProxyChains">推荐：ProxyChains</a></li>
                <li>
                    <a href="#%e4%b8%b4%e6%97%b6%e6%8c%87%e5%ae%9a%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" aria-label="临时指定环境变量">临时指定环境变量</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#projectportagesynchttpswikigentooorgwikiprojectportagesync" aria-label="Project:Portage/Sync"><a href="https://wiki.gentoo.org/wiki/Project:Portage/Sync">Project:Portage/Sync</a></a><ul>
                        
                <li>
                    <a href="#general-help" aria-label="General help">General help</a><ul>
                        
                <li>
                    <a href="#migration" aria-label="Migration">Migration</a></li>
                <li>
                    <a href="#operation" aria-label="Operation">Operation</a></li>
                <li>
                    <a href="#examples" aria-label="Examples">Examples</a></li></ul>
                </li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#use%e6%a0%87%e8%ae%b0httpswikigentooorgwikihandbookamd64workinguse" aria-label="USE标记"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/USE">USE标记</a></a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%afuse%e6%a0%87%e5%bf%97" aria-label="什么是USE标志">什么是USE标志</a><ul>
                        
                <li>
                    <a href="#use%e6%a0%87%e5%bf%97%e7%9a%84%e6%8c%87%e5%af%bc%e6%80%9d%e6%83%b3" aria-label="USE标志的指导思想">USE标志的指导思想</a></li>
                <li>
                    <a href="#use%e6%a0%87%e5%bf%97%e7%9a%84%e8%ae%be%e5%ae%9a" aria-label="USE标志的设定">USE标志的设定</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8use%e6%a0%87%e5%bf%97" aria-label="使用USE标志">使用USE标志</a><ul>
                        
                <li>
                    <a href="#%e5%a3%b0%e6%98%8e%e6%b0%b8%e4%b9%85use%e6%a0%87%e5%bf%97" aria-label="声明永久USE标志">声明永久USE标志</a></li>
                <li>
                    <a href="#%e4%b8%ba%e5%8d%95%e4%b8%aa%e5%8c%85%e5%a3%b0%e6%98%8euse%e6%a0%87%e5%bf%97" aria-label="为单个包声明USE标志">为单个包声明USE标志</a></li>
                <li>
                    <a href="#%e5%a3%b0%e6%98%8e%e4%b8%b4%e6%97%b6use%e6%a0%87%e5%bf%97" aria-label="声明临时USE标志">声明临时USE标志</a></li>
                <li>
                    <a href="#%e4%bc%98%e5%85%88%e7%ba%a7" aria-label="优先级">优先级</a></li>
                <li>
                    <a href="#%e5%9c%a8%e6%95%b4%e4%b8%aa%e7%b3%bb%e7%bb%9f%e4%b8%8a%e5%ba%94%e7%94%a8%e6%96%b0%e7%9a%84use%e6%a0%87%e5%bf%97" aria-label="在整个系统上应用新的USE标志">在整个系统上应用新的USE标志</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%bd%af%e4%bb%b6%e5%8c%85%e7%89%b9%e6%9c%89%e7%9a%84use%e6%a0%87%e5%bf%97" aria-label="软件包特有的USE标志">软件包特有的USE标志</a></li>
                <li>
                    <a href="#%e6%bb%a1%e8%b6%b3-required_use" aria-label="满足 REQUIRED_USE">满足 REQUIRED_USE</a></li></ul>
                </li>
                <li>
                    <a href="#portage%e5%8a%9f%e8%83%bd%e7%89%b9%e6%80%a7httpswikigentooorgwikihandbookamd64workingfeatures" aria-label="Portage功能特性"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/Features">Portage功能特性</a></a><ul>
                        
                <li>
                    <a href="#portage%e7%89%b9%e6%80%a7" aria-label="Portage特性">Portage特性</a></li>
                <li>
                    <a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%bc%96%e8%af%91" aria-label="分布式编译">分布式编译</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8distcc" aria-label="使用distcc">使用distcc</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85-distcc" aria-label="安装 distcc">安装 distcc</a></li>
                <li>
                    <a href="#%e6%bf%80%e6%b4%bbportage%e7%9a%84distcc%e6%94%af%e6%8c%81" aria-label="激活Portage的distcc支持">激活Portage的distcc支持</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bc%93%e5%86%b2%e7%bc%96%e8%af%91%e7%bb%93%e6%9e%9c" aria-label="缓冲编译结果">缓冲编译结果</a><ul>
                        
                <li>
                    <a href="#%e5%85%b3%e4%ba%8eccache" aria-label="关于ccache">关于ccache</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85-ccache" aria-label="安装 ccache">安装 ccache</a></li>
                <li>
                    <a href="#%e6%bf%80%e6%b4%bbportage-ccache-%e6%94%af%e6%8c%81" aria-label="激活Portage ccache 支持">激活Portage ccache 支持</a></li>
                <li>
                    <a href="#%e9%9d%9eportage%e7%bc%96%e8%af%91%e4%b8%ad%e4%bd%bf%e7%94%a8ccache" aria-label="非Portage编译中使用ccache">非Portage编译中使用ccache</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%8c%85%e6%94%af%e6%8c%81" aria-label="二进制包支持">二进制包支持</a><ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e9%a2%84%e7%bc%96%e8%af%91%e5%8c%85" aria-label="创建预编译包">创建预编译包</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e9%a2%84%e7%bc%96%e8%af%91%e5%8c%85" aria-label="安装预编译包">安装预编译包</a></li>
                <li>
                    <a href="#%e5%b0%86%e9%a2%84%e6%9e%84%e5%bb%ba%e7%9a%84%e8%bd%af%e4%bb%b6%e5%8c%85%e5%88%86%e5%8f%91%e7%bb%99%e4%bb%96%e4%ba%ba" aria-label="将预构建的软件包分发给他人">将预构建的软件包分发给他人</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%8b%e8%bd%bd%e6%96%87%e4%bb%b6" aria-label="下载文件">下载文件</a><ul>
                        
                <li>
                    <a href="#%e5%b9%b6%e8%a1%8c%e4%b8%8b%e8%bd%bd" aria-label="并行下载">并行下载</a></li>
                <li>
                    <a href="#%e9%aa%8c%e8%af%81%e6%ba%90%e6%96%87%e4%bb%b6" aria-label="验证源文件">验证源文件</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8fhttpswikigentooorgwikihandbookamd64workingenvvar" aria-label="环境变量"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/EnvVar">环境变量</a></a><ul>
                        
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" aria-label="环境变量">环境变量</a><ul>
                        
                <li>
                    <a href="#%e7%ae%80%e4%bb%8b-1" aria-label="简介">简介</a></li>
                <li>
                    <a href="#%e9%87%8d%e8%a6%81%e7%9a%84%e4%be%8b%e5%ad%90" aria-label="重要的例子">重要的例子</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f%e7%9a%84%e5%ae%9a%e4%b9%89" aria-label="全局变量的定义">全局变量的定义</a><ul>
                        
                <li>
                    <a href="#envd%e7%9b%ae%e5%bd%95" aria-label="env.d目录">env.d目录</a></li>
                <li>
                    <a href="#env-update" aria-label="env-update">env-update</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%9c%ac%e5%9c%b0%e5%8f%98%e9%87%8f%e7%9a%84%e5%ae%9a%e4%b9%89" aria-label="本地变量的定义">本地变量的定义</a><ul>
                        
                <li>
                    <a href="#%e7%89%b9%e5%ae%9a%e7%94%a8%e6%88%b7" aria-label="特定用户">特定用户</a></li>
                <li>
                    <a href="#%e7%89%b9%e5%ae%9a%e4%bc%9a%e8%af%9d" aria-label="特定会话">特定会话</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#ebuild-1" aria-label="ebuild">ebuild</a><ul>
                        
                <li>
                    <a href="#gentoo-development-guide-chinesehttpsblogsoymilkfungentoo-development-guide-chinese" aria-label="Gentoo Development Guide Chinese"><a href="https://blog.soymilk.fun/Gentoo-Development-Guide-Chinese/">Gentoo Development Guide Chinese</a></a></li>
                <li>
                    <a href="#ebuild-%e7%bc%96%e5%86%99%e5%9f%ba%e6%9c%ac%e6%8c%87%e5%8d%97httpswikigentooorgwikibasic_guide_to_write_gentoo_ebuilds" aria-label="Ebuild 编写基本指南"><a href="https://wiki.gentoo.org/wiki/Basic_guide_to_write_Gentoo_Ebuilds">Ebuild 编写基本指南</a></a><ul>
                        
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa-ebuild" aria-label="如何创建一个 ebuild">如何创建一个 ebuild</a></li>
                <li>
                    <a href="#%e7%bb%99%e5%ae%9a%e6%ba%90%e5%8e%8b%e7%bc%a9%e5%8c%85%e7%a4%ba%e4%be%8b" aria-label="给定源压缩包示例">给定源压缩包示例</a></li>
                <li>
                    <a href="#%e6%89%93%e8%a1%a5%e4%b8%81" aria-label="打补丁">打补丁</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9d%e6%8e%a2-ebuildhttpssegmentfaultcoma1190000003819421" aria-label="初探 ebuild"><a href="https://segmentfault.com/a/1190000003819421">初探 ebuild</a></a><ul>
                        
                <li>
                    <a href="#ebuild-%e5%9c%a8%e5%93%aa%e9%87%8c" aria-label="ebuild 在哪里？">ebuild 在哪里？</a></li>
                <li>
                    <a href="#%e5%bb%ba%e7%ab%8b%e8%87%aa%e5%b7%b1%e7%9a%84-overlay" aria-label="建立自己的 Overlay">建立自己的 Overlay</a></li>
                <li>
                    <a href="#hello-world" aria-label="Hello World!">Hello World!</a></li>
                <li>
                    <a href="#emerge-%e4%b8%8e-ebuild-%e6%9c%89%e4%bb%80%e4%b9%88%e8%81%94%e7%b3%bb" aria-label="emerge 与 ebuild 有什么联系？">emerge 与 ebuild 有什么联系？</a></li></ul>
                </li>
                <li>
                    <a href="#slothttpswikitankywoocomlinuxgentoohtmlslot" aria-label="SLOT"><a href="https://wiki.tankywoo.com/linux/gentoo.html#slot">SLOT</a></a><ul>
                        
                <li>
                    <a href="#%e7%9c%9f%e5%ae%9e%e7%9a%84-hello-world" aria-label="真实的 Hello World！">真实的 Hello World！</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#ebuild-repositoryhttpswikigentooorgwikiebuild_repository" aria-label="ebuild repository"><a href="https://wiki.gentoo.org/wiki/Ebuild_repository">ebuild repository</a></a><ul>
                        
                <li>
                    <a href="#the-gentoo-ebuild-repository" aria-label="The Gentoo ebuild repository">The Gentoo ebuild repository</a></li>
                <li>
                    <a href="#repositories-in-general" aria-label="Repositories in general">Repositories in general</a><ul>
                        
                <li>
                    <a href="#priorities" aria-label="Priorities">Priorities</a></li></ul>
                </li>
                <li>
                    <a href="#repository-synchronization" aria-label="Repository synchronization">Repository synchronization</a></li>
                <li>
                    <a href="#repository-management-tools" aria-label="Repository management tools">Repository management tools</a><ul>
                        
                <li>
                    <a href="#eselect-repository" aria-label="eselect-repository">eselect-repository</a></li>
                <li>
                    <a href="#layman" aria-label="Layman">Layman</a></li></ul>
                </li>
                <li>
                    <a href="#usage" aria-label="Usage">Usage</a><ul>
                        
                <li>
                    <a href="#emerging-a-duplicate-package" aria-label="Emerging a duplicate package">Emerging a duplicate package</a></li></ul>
                </li>
                <li>
                    <a href="#best-practices" aria-label="Best practices">Best practices</a><ul>
                        
                <li>
                    <a href="#cache-generation" aria-label="Cache generation">Cache generation</a></li>
                <li>
                    <a href="#masking-enabled-ebuild-repositories" aria-label="Masking enabled ebuild repositories">Masking enabled ebuild repositories</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#zfs_freebsd-handbook-httpsdocsfreebsdorgzh-twbookshandbookzfs" aria-label="ZFS_FreeBSD Handbook "><a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/">ZFS_FreeBSD Handbook </a></a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e9%ba%bc%e4%bd%bf-zfs-%e8%88%87%e7%9c%be%e4%b8%8d%e5%90%8c" aria-label="什麼使 ZFS 與眾不同">什麼使 ZFS 與眾不同</a></li>
                <li>
                    <a href="#%e5%bf%ab%e9%80%9f%e5%85%a5%e9%96%80%e6%8c%87%e5%8d%97" aria-label="快速入門指南">快速入門指南</a><ul>
                        
                <li>
                    <a href="#%e5%96%ae%e7%a3%81%e7%a2%9f%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="單磁碟儲存池">單磁碟儲存池</a></li>
                <li>
                    <a href="#raid-z" aria-label="RAID-Z">RAID-Z</a></li>
                <li>
                    <a href="#%e5%be%a9%e5%8e%9f-raid-z" aria-label="復原 RAID-Z">復原 RAID-Z</a></li>
                <li>
                    <a href="#%e8%b3%87%e6%96%99%e6%aa%a2%e9%a9%97" aria-label="資料檢驗">資料檢驗</a></li></ul>
                </li>
                <li>
                    <a href="#zpool-%e7%ae%a1%e7%90%86" aria-label="zpool 管理"><code>zpool</code> 管理</a><ul>
                        
                <li>
                    <a href="#%e5%bb%ba%e7%ab%8b%e8%88%87%e6%91%a7%e6%af%80%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="建立與摧毀儲存池">建立與摧毀儲存池</a></li>
                <li>
                    <a href="#%e5%8a%a0%e5%85%a5%e8%88%87%e7%a7%bb%e9%99%a4%e8%a3%9d%e7%bd%ae" aria-label="加入與移除裝置">加入與移除裝置</a></li>
                <li>
                    <a href="#%e6%aa%a2%e6%9f%a5%e5%84%b2%e5%ad%98%e6%b1%a0%e7%8b%80%e6%85%8b" aria-label="檢查儲存池狀態">檢查儲存池狀態</a></li>
                <li>
                    <a href="#%e6%b8%85%e9%99%a4%e9%8c%af%e8%aa%a4" aria-label="清除錯誤">清除錯誤</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%8f%9b%e9%81%8b%e4%bd%9c%e4%b8%ad%e7%9a%84%e8%a3%9d%e7%bd%ae" aria-label="更換運作中的裝置">更換運作中的裝置</a></li>
                <li>
                    <a href="#%e8%99%95%e7%90%86%e6%95%85%e9%9a%9c%e8%a3%9d%e7%bd%ae" aria-label="處理故障裝置">處理故障裝置</a></li>
                <li>
                    <a href="#%e6%b8%85%e6%bd%94%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="清潔儲存池">清潔儲存池</a></li>
                <li>
                    <a href="#%e8%87%aa%e6%88%91%e4%bf%ae%e5%be%a9" aria-label="自我修復">自我修復</a></li>
                <li>
                    <a href="#%e6%93%b4%e5%a2%9e%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="擴增儲存池">擴增儲存池</a></li>
                <li>
                    <a href="#%e5%8c%af%e5%85%a5%e8%88%87%e5%8c%af%e5%87%ba%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="匯入與匯出儲存池">匯入與匯出儲存池</a></li>
                <li>
                    <a href="#%e5%8d%87%e7%b4%9a%e5%84%b2%e5%ad%98%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="升級儲存儲存池">升級儲存儲存池</a></li>
                <li>
                    <a href="#%e9%a1%af%e7%a4%ba%e5%b7%b2%e8%a8%98%e9%8c%84%e7%9a%84%e5%84%b2%e5%ad%98%e6%b1%a0%e6%ad%b7%e5%8f%b2%e6%97%a5%e8%aa%8c" aria-label="顯示已記錄的儲存池歷史日誌">顯示已記錄的儲存池歷史日誌</a></li>
                <li>
                    <a href="#%e7%9b%a3%e8%a6%96%e6%95%88%e8%83%bd" aria-label="監視效能">監視效能</a></li>
                <li>
                    <a href="#%e5%88%86%e5%89%b2%e5%84%b2%e5%ad%98%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="分割儲存儲存池">分割儲存儲存池</a></li></ul>
                </li>
                <li>
                    <a href="#zfs-%e7%ae%a1%e7%90%86" aria-label="zfs 管理"><code>zfs</code> 管理</a><ul>
                        
                <li>
                    <a href="#%e5%bb%ba%e7%ab%8b%e8%88%87%e6%91%a7%e6%af%80%e8%b3%87%e6%96%99%e9%9b%86" aria-label="建立與摧毀資料集">建立與摧毀資料集</a></li>
                <li>
                    <a href="#%e5%bb%ba%e7%ab%8b%e8%88%87%e6%91%a7%e6%af%80%e7%a3%81%e7%a2%9f%e5%8d%80" aria-label="建立與摧毀磁碟區">建立與摧毀磁碟區</a></li>
                <li>
                    <a href="#%e9%87%8d%e6%96%b0%e5%91%bd%e5%90%8d%e8%b3%87%e6%96%99%e9%9b%86" aria-label="重新命名資料集">重新命名資料集</a></li>
                <li>
                    <a href="#%e8%a8%ad%e5%ae%9a%e8%b3%87%e6%96%99%e9%9b%86%e5%b1%ac%e6%80%a7" aria-label="設定資料集屬性">設定資料集屬性</a><ul>
                        
                <li>
                    <a href="#%e5%8f%96%e5%be%97%e8%88%87%e8%a8%ad%e5%ae%9a%e5%85%b1%e4%ba%ab%e5%b1%ac%e6%80%a7" aria-label="取得與設定共享屬性">取得與設定共享屬性</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ae%a1%e7%90%86%e5%bf%ab%e7%85%a7-snapshot" aria-label="管理快照 (Snapshot)">管理快照 (Snapshot)</a><ul>
                        
                <li>
                    <a href="#%e5%bb%ba%e7%ab%8b%e5%bf%ab%e7%85%a7" aria-label="建立快照">建立快照</a></li>
                <li>
                    <a href="#%e6%af%94%e5%b0%8d%e5%bf%ab%e7%85%a7" aria-label="比對快照">比對快照</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e5%bf%ab%e7%85%a7%e9%82%84%e5%8e%9f" aria-label="使用快照還原">使用快照還原</a></li>
                <li>
                    <a href="#%e5%be%9e%e5%bf%ab%e7%85%a7%e9%82%84%e5%8e%9f%e5%80%8b%e5%88%a5%e6%aa%94%e6%a1%88" aria-label="從快照還原個別檔案">從快照還原個別檔案</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ae%a1%e7%90%86%e8%a4%87%e6%9c%ac-clone" aria-label="管理複本 (Clone)">管理複本 (Clone)</a></li>
                <li>
                    <a href="#%e5%82%99%e4%bb%bd-replication" aria-label="備份 (Replication)">備份 (Replication)</a><ul>
                        
                <li>
                    <a href="#%e6%bc%b8%e9%80%b2%e5%bc%8f%e5%82%99%e4%bb%bd" aria-label="漸進式備份">漸進式備份</a></li>
                <li>
                    <a href="#%e9%80%8f%e9%81%8e-ssh-%e5%82%b3%e9%80%81%e5%8a%a0%e5%af%86%e7%9a%84%e5%82%99%e4%bb%bd" aria-label="透過 SSH 傳送加密的備份">透過 SSH 傳送加密的備份</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%b3%87%e6%96%99%e9%9b%86%e4%bd%bf%e7%94%a8%e8%80%85%e4%bb%a5%e5%8f%8a%e7%be%a4%e7%b5%84%e9%85%8d%e9%a1%8d" aria-label="資料集、使用者以及群組配額">資料集、使用者以及群組配額</a></li>
                <li>
                    <a href="#%e4%bf%9d%e7%95%99%e7%a9%ba%e9%96%93" aria-label="保留空間">保留空間</a></li>
                <li>
                    <a href="#%e5%a3%93%e7%b8%ae-compression" aria-label="壓縮 (Compression)">壓縮 (Compression)</a></li>
                <li>
                    <a href="#%e5%8e%bb%e9%87%8d%e8%a4%87-deduplication" aria-label="去重複 (Deduplication)">去重複 (Deduplication)</a></li>
                <li>
                    <a href="#zfs-%e8%88%87-jail" aria-label="ZFS 與 Jail">ZFS 與 Jail</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%a7%94%e8%a8%97%e7%ae%a1%e7%90%86" aria-label="委託管理">委託管理</a><ul>
                        
                <li>
                    <a href="#%e5%a7%94%e8%a8%97%e8%b3%87%e6%96%99%e9%9b%86%e5%bb%ba%e7%ab%8b" aria-label="委託資料集建立">委託資料集建立</a></li>
                <li>
                    <a href="#%e5%a7%94%e8%a8%97%e6%ac%8a%e9%99%90%e5%a7%94%e8%a8%97" aria-label="委託權限委託">委託權限委託</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%80%b2%e9%9a%8e%e4%b8%bb%e9%a1%8c" aria-label="進階主題">進階主題</a><ul>
                        
                <li>
                    <a href="#%e8%aa%bf%e6%a0%a1" aria-label="調校">調校</a><ul>
                        
                <li>
                    <a href="#i386-%e4%b8%8a%e7%9a%84-zfs" aria-label="i386 上的 ZFS">i386 上的 ZFS</a></li>
                <li>
                    <a href="#%e8%a8%98%e6%86%b6%e9%ab%94" aria-label="記憶體">記憶體</a></li>
                <li>
                    <a href="#%e6%a0%b8%e5%bf%83%e8%a8%ad%e5%ae%9a" aria-label="核心設定">核心設定</a></li>
                <li>
                    <a href="#%e8%bc%89%e5%85%a5%e7%a8%8b%e5%bc%8f%e5%8f%af%e8%aa%bf%e5%8f%83%e6%95%b8" aria-label="載入程式可調參數">載入程式可調參數</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e8%b3%87%e6%ba%90" aria-label="其他資源">其他資源</a></li>
                <li>
                    <a href="#%e7%89%b9%e8%89%b2%e8%88%87%e8%a1%93%e8%aa%9e" aria-label="特色與術語">特色與術語</a></li></ul>
                </li>
                <li>
                    <a href="#gentoo-on-zfshttpswikigentooorgwikiuserali3nxinstalling_gentoo_linux_efistub_on_zfs" aria-label="Gentoo on ZFS"><a href="https://wiki.gentoo.org/wiki/User:Ali3nx/Installing_Gentoo_Linux_EFISTUB_On_ZFS">Gentoo on ZFS</a></a><ul>
                        
                <li>
                    <a href="#%e5%a4%87%e4%bb%bdhttpswwwyafamoepostbackup-your-gentoo-system" aria-label="备份"><a href="https://www.yafa.moe/post/backup-your-gentoo-system/">备份</a></a><ul>
                        
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e7%a1%ac%e7%9b%98" aria-label="初始化硬盘">初始化硬盘</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba-luks" aria-label="创建 LUKS">创建 LUKS</a></li>
                <li>
                    <a href="#%e6%89%93%e5%bc%80-luks-%e5%92%8c%e5%88%9b%e5%bb%ba%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" aria-label="打开 LUKS 和创建文件系统">打开 LUKS 和创建文件系统</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e6%8c%82%e8%bd%bd%e7%82%b9%e5%92%8c%e6%8c%82%e8%bd%bd" aria-label="创建挂载点和挂载">创建挂载点和挂载</a></li>
                <li>
                    <a href="#%e5%a4%87%e4%bb%bd%e7%b3%bb%e7%bb%9f" aria-label="备份系统">备份系统</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%bf%81%e7%a7%bb%e5%88%b0-zfshttpswwwyafamoepostgentoo-on-zfs" aria-label="迁移到 ZFS"><a href="https://www.yafa.moe/post/gentoo-on-zfs/">迁移到 ZFS</a></a><ul>
                        
                <li>
                    <a href="#%e5%88%86%e5%8c%ba" aria-label="分区">分区</a><ul>
                        
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e5%88%86%e5%8c%ba" aria-label="初始化分区">初始化分区</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba-pool" aria-label="创建 pool">创建 pool</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba-datasets" aria-label="创建 datasets">创建 datasets</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e7%b3%bb%e7%bb%9f" aria-label="安装系统">安装系统</a></li>
                <li>
                    <a href="#chroot" aria-label="chroot">chroot</a></li>
                <li>
                    <a href="#zfs-%e5%ae%89%e8%a3%85%e5%92%8c%e9%85%8d%e7%bd%ae" aria-label="ZFS 安装和配置">ZFS 安装和配置</a></li>
                <li>
                    <a href="#bootload-fstab-and-initramfs" aria-label="Bootload fstab and Initramfs">Bootload fstab and Initramfs</a><ul>
                        
                <li>
                    <a href="#grub" aria-label="GRUB">GRUB</a></li>
                <li>
                    <a href="#fstab" aria-label="fstab">fstab</a></li>
                <li>
                    <a href="#initramfs" aria-label="initramfs">initramfs</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%87%8d%e5%90%af" aria-label="重启">重启</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8zfs%e5%a4%87%e4%bb%bdhttpswwwyafamoepostuse-zfs-backup-system" aria-label="使用ZFS备份"><a href="https://www.yafa.moe/post/use-zfs-backup-system/">使用ZFS备份</a></a><ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%a4%87%e4%bb%bdzfs%e6%b1%a0" aria-label="创建备份ZFS池">创建备份ZFS池</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%bf%ab%e7%85%a7" aria-label="创建快照">创建快照</a></li>
                <li>
                    <a href="#%e5%8f%91%e9%80%81%e5%bf%ab%e7%85%a7" aria-label="发送快照">发送快照</a></li>
                <li>
                    <a href="#%e5%a4%87%e4%bb%bdboot%e5%88%86%e5%8c%ba" aria-label="备份/boot分区">备份<code>/boot</code>分区</a></li>
                <li>
                    <a href="#%e6%81%a2%e5%a4%8d%e5%bf%ab%e7%85%a7" aria-label="恢复快照">恢复快照</a></li>
                <li>
                    <a href="#%e5%ae%9a%e6%9c%9f%e5%a4%87%e4%bb%bd" aria-label="定期备份">定期备份</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%97%ae%e9%a2%98%e6%8e%92%e6%9f%a5" aria-label="问题排查">问题排查</a><ul>
                        
                <li>
                    <a href="#grub-%e6%95%91%e6%8f%b4" aria-label="grub 救援">grub 救援</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87-livecd-%e4%bf%ae%e5%a4%8d" aria-label="通过 livecd 修复">通过 livecd 修复</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#lukshttpslinuxcnarticle-9640-1html" aria-label="LUKS"><a href="https://linux.cn/article-9640-1.html">LUKS</a></a><ul>
                        
                <li>
                    <a href="#%e5%86%85%e6%a0%b8%e9%85%8d%e7%bd%ae%e5%8f%af%e9%80%89" aria-label="内核配置（可选）">内核配置（可选）</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e8%bd%af%e4%bb%b6-1" aria-label="安装软件">安装软件</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%8a%a0%e5%af%86%e5%88%86%e5%8c%ba" aria-label="创建加密分区">创建加密分区</a></li>
                <li>
                    <a href="#%e5%88%a9%e7%94%a8%e5%af%86%e9%92%a5%e6%96%87%e4%bb%b6%e5%8a%a0%e5%af%86%e5%88%86%e5%8c%ba" aria-label="利用密钥文件加密分区">利用密钥文件加密分区</a><ul>
                        
                <li>
                    <a href="#%e7%94%9f%e6%88%90%e9%9a%8f%e6%9c%ba%e5%af%86%e9%92%a5%e6%96%87%e4%bb%b6" aria-label="生成随机密钥文件">生成随机密钥文件</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0%e5%af%86%e9%92%a5%e6%96%87%e4%bb%b6%e4%bd%9c%e4%b8%ba%e5%af%86%e7%a0%81%e4%b9%8b%e4%b8%80" aria-label="添加密钥文件作为密码之一">添加密钥文件作为密码之一</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%a7%bb%e9%99%a4%e8%a7%a3%e5%af%86%e5%af%86%e7%a0%81" aria-label="移除解密密码">移除解密密码</a></li>
                <li>
                    <a href="#%e8%a7%a3%e5%af%86%e4%b8%8e%e6%8c%82%e8%bd%bd" aria-label="解密与挂载">解密与挂载</a><ul>
                        
                <li>
                    <a href="#%e5%af%86%e7%a0%81%e8%a7%a3%e5%af%86" aria-label="密码解密">密码解密</a></li>
                <li>
                    <a href="#key-file-%e8%a7%a3%e5%af%86" aria-label="key file 解密">key file 解密</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" aria-label="创建文件系统">创建文件系统</a></li>
                <li>
                    <a href="#%e6%8c%82%e8%bd%bd" aria-label="挂载">挂载</a></li>
                <li>
                    <a href="#%e5%8d%b8%e8%bd%bd%e6%8c%82%e8%bd%bd%e7%82%b9%e5%b9%b6%e5%85%b3%e9%97%ad%e5%8a%a0%e5%af%86%e5%88%86%e5%8c%ba" aria-label="卸载挂载点并关闭加密分区">卸载挂载点并关闭加密分区</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8f%8c%e6%98%be%e5%8d%a1%e7%ac%94%e8%ae%b0%e6%9c%ac%e7%8b%ac%e6%98%be%e7%9b%b4%e9%80%9ahttpswwwcodeplayerorgbloge58f8ce698bee58da1e7ac94e8aeb0e69cace78bace698bee79bb4e9809ahtml" aria-label="双显卡笔记本独显直通"><a href="https://www.codeplayer.org/Blog/%E5%8F%8C%E6%98%BE%E5%8D%A1%E7%AC%94%E8%AE%B0%E6%9C%AC%E7%8B%AC%E6%98%BE%E7%9B%B4%E9%80%9A.html">双显卡笔记本独显直通</a></a><ul>
                        
                <li>
                    <a href="#%e4%bb%8b%e7%bb%8d" aria-label="介绍">介绍</a></li>
                <li>
                    <a href="#muxed" aria-label="MUXed">MUXed</a></li>
                <li>
                    <a href="#%e5%90%af%e7%94%a8-iommu-%e5%92%8c-vfio-%e6%a8%a1%e5%9d%97" aria-label="启用 IOMMU 和 vfio 模块">启用 IOMMU 和 vfio 模块</a><ul>
                        
                <li>
                    <a href="#iommu" aria-label="IOMMU">IOMMU</a></li>
                <li>
                    <a href="#vfio" aria-label="vfio">vfio</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%9a%94%e7%a6%bb-gpu" aria-label="隔离 GPU">隔离 GPU</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba" aria-label="创建虚拟机">创建虚拟机</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e5%92%8c%e4%bc%98%e5%8c%96-remotefx" aria-label="配置和优化 RemoteFX">配置和优化 RemoteFX</a><ul>
                        
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae-remotefx" aria-label="配置 RemoteFX">配置 RemoteFX</a></li>
                <li>
                    <a href="#%e8%a7%a3%e9%99%a4-30-ish-fps-%e9%99%90%e5%88%b6" aria-label="解除 30-ish fps 限制">解除 30-ish fps 限制</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%98%be%e5%8d%a1%e7%9b%b4%e9%80%9a" aria-label="显卡直通">显卡直通</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e7%bd%91%e6%a1%a5" aria-label="创建网桥">创建网桥</a></li>
                <li>
                    <a href="#%e8%bf%9c%e7%a8%8b%e8%bf%9e%e6%8e%a5" aria-label="远程连接">远程连接</a><ul>
                        
                <li>
                    <a href="#rdp" aria-label="RDP">RDP</a></li>
                <li>
                    <a href="#looking-glass" aria-label="Looking glass">Looking glass</a><ul>
                        
                <li>
                    <a href="#%e5%ae%89%e8%a3%85-client" aria-label="安装 client">安装 client</a></li>
                <li>
                    <a href="#%e8%ae%a1%e7%ae%97%e5%86%85%e5%ad%98%e5%a4%a7%e5%b0%8f" aria-label="计算内存大小">计算内存大小</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae-libvirt" aria-label="配置 libvirt">配置 libvirt</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%85%b1%e4%ba%ab%e5%86%85%e5%ad%98%e6%96%87%e4%bb%b6" aria-label="创建共享内存文件">创建共享内存文件</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85-host" aria-label="安装 host">安装 host</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae-client" aria-label="配置 client">配置 client</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae-scream" aria-label="配置 Scream">配置 Scream</a></li></ul>
                </li>
                <li>
                    <a href="#steam-%e8%bf%9c%e7%a8%8b%e7%95%85%e7%8e%a9%e6%b5%81%e5%bc%8f%e4%bc%a0%e8%be%93" aria-label="steam 远程畅玩（流式传输）">steam 远程畅玩（流式传输）</a></li></ul>
                </li>
                <li>
                    <a href="#benchmark" aria-label="benchmark">benchmark</a></li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" aria-label="参考链接">参考链接</a></li>
                <li>
                    <a href="#%e9%99%84%e5%bd%95xml-%e9%85%8d%e7%bd%ae" aria-label="附录：XML 配置">附录：XML 配置</a></li></ul>
                </li>
                <li>
                    <a href="#apps" aria-label="Apps">Apps</a><ul>
                        
                <li>
                    <a href="#%e4%b8%ad%e6%96%87%e5%ad%97%e4%bd%93httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle4b8ade69687e5ad97e4bd93" aria-label="中文字体"><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93">中文字体</a></a><ul>
                        
                <li>
                    <a href="#%e6%94%b9%e5%96%84%e5%ad%97%e4%bd%93%e6%b8%b2%e6%9f%93%e6%95%88%e6%9e%9chttpszhuanlanzhihucomp343934880" aria-label="改善字体渲染效果"><a href="https://zhuanlan.zhihu.com/p/343934880">改善字体渲染效果</a></a></li></ul>
                </li>
                <li>
                    <a href="#%e8%be%93%e5%85%a5%e6%b3%95httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle8be93e585a5e6b395" aria-label="输入法"><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E8%BE%93%E5%85%A5%E6%B3%95">输入法</a></a><ul>
                        
                <li>
                    <a href="#%e5%ae%98%e6%96%b9%e4%bb%93%e5%ba%93-fcitx4" aria-label="官方仓库 fcitx4">官方仓库 fcitx4</a></li>
                <li>
                    <a href="#%e9%a2%9d%e5%a4%96%e4%bb%93%e5%ba%93-fcitx5" aria-label="额外仓库 fcitx5">额外仓库 fcitx5</a><ul>
                        
                <li>
                    <a href="#%e6%8b%a5%e6%8a%b1fcitx5httpsblogcoelacanthusmoepoststechwelcome-to-fcitx5" aria-label="拥抱Fcitx5"><a href="https://blog.coelacanthus.moe/posts/tech/welcome-to-fcitx5/">拥抱Fcitx5</a></a></li>
                <li>
                    <a href="#fcitx5%e7%9a%ae%e8%82%a4%e5%88%b6%e4%bd%9chttpsbbsdeepinorgphonezhpost223810" aria-label="fcitx5皮肤制作"><a href="https://bbs.deepin.org/phone/zh/post/223810">fcitx5皮肤制作</a></a></li>
                <li>
                    <a href="#fcitx5rime%e7%9a%84%e7%95%85%e5%bf%ab%e4%bd%93%e9%aa%8chttpszhuanlanzhihucomp287774005" aria-label="fcitx(5)&#43;rime的畅快体验"><a href="https://zhuanlan.zhihu.com/p/287774005">fcitx(5)+rime的畅快体验</a></a></li></ul>
                </li>
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%aehttpswikiarchlinuxorgtitlefcitxset_environment_variables_for_im_modules" aria-label="环境配置"><a href="https://wiki.archlinux.org/title/fcitx#Set_environment_variables_for_IM_modules">环境配置</a></a></li>
                <li>
                    <a href="#rimehttpszhuanlanzhihucomp114296129" aria-label="Rime"><a href="https://zhuanlan.zhihu.com/p/114296129">Rime</a></a></li></ul>
                </li>
                <li>
                    <a href="#kde-system-settings" aria-label="KDE System Settings">KDE System Settings</a></li>
                <li>
                    <a href="#bluetoothhttpswikigentooorgwikibluetooth" aria-label="Bluetooth"><a href="https://wiki.gentoo.org/wiki/Bluetooth">Bluetooth</a></a></li>
                <li>
                    <a href="#%e9%a6%96%e9%80%89%e7%bc%96%e8%be%91%e5%99%a8" aria-label="首选编辑器">首选编辑器</a></li>
                <li>
                    <a href="#mutt" aria-label="mutt">mutt</a></li>
                <li>
                    <a href="#mpv" aria-label="mpv">mpv</a></li>
                <li>
                    <a href="#spotify" aria-label="spotify">spotify</a></li>
                <li>
                    <a href="#youtube-dl" aria-label="youtube-dl">youtube-dl</a></li>
                <li>
                    <a href="#aria2" aria-label="aria2">aria2</a></li>
                <li>
                    <a href="#typora" aria-label="Typora">Typora</a></li>
                <li>
                    <a href="#zsh" aria-label="zsh">zsh</a></li>
                <li>
                    <a href="#clash" aria-label="Clash">Clash</a></li>
                <li>
                    <a href="#browsers" aria-label="Browsers">Browsers</a></li>
                <li>
                    <a href="#kio-extrashttpswikigentooorgwikimtp" aria-label="kio-extras"><a href="https://wiki.gentoo.org/wiki/MTP">kio-extras</a></a></li>
                <li>
                    <a href="#gwenview" aria-label="Gwenview">Gwenview</a></li>
                <li>
                    <a href="#okular" aria-label="Okular">Okular</a></li>
                <li>
                    <a href="#ktimer" aria-label="KTimer">KTimer</a></li>
                <li>
                    <a href="#kclock" aria-label="KClock">KClock</a></li>
                <li>
                    <a href="#rsibreakhttpsuserbasekdeorgrsibreakzh-cn" aria-label="RSIBreak"><a href="https://userbase.kde.org/RSIBreak/zh-cn">RSIBreak</a></a></li>
                <li>
                    <a href="#libreoffice" aria-label="LibreOffice">LibreOffice</a></li>
                <li>
                    <a href="#flameshot" aria-label="Flameshot">Flameshot</a><ul>
                        
                <li>
                    <a href="#spectacle" aria-label="Spectacle">Spectacle</a></li></ul>
                </li>
                <li>
                    <a href="#keepassxchttpskeepassxcorg" aria-label="KeePassXC"><a href="https://keepassxc.org/">KeePassXC</a></a></li>
                <li>
                    <a href="#ppsspp" aria-label="PPSSPP">PPSSPP</a></li>
                <li>
                    <a href="#papirus-icon-themehttpsgithubcompapirusdevelopmentteampapirus-icon-theme" aria-label="papirus-icon-theme"><a href="https://github.com/PapirusDevelopmentTeam/papirus-icon-theme">papirus-icon-theme</a></a></li>
                <li>
                    <a href="#vulkanhttpswikigentooorgwikivulkan" aria-label="Vulkan"><a href="https://wiki.gentoo.org/wiki/Vulkan">Vulkan</a></a></li>
                <li>
                    <a href="#tree" aria-label="tree">tree</a></li>
                <li>
                    <a href="#qemu" aria-label="qemu">qemu</a></li>
                <li>
                    <a href="#dockerhttpswikigentooorgwikidocker" aria-label="Docker"><a href="https://wiki.gentoo.org/wiki/Docker">Docker</a></a></li>
                <li>
                    <a href="#lsusbhttpswikigentooorgwikiusbutils" aria-label="lsusb"><a href="https://wiki.gentoo.org/wiki/Usbutils">lsusb</a></a></li>
                <li>
                    <a href="#p7ziphttpswikigentooorgwikip7zip" aria-label="p7zip"><a href="https://wiki.gentoo.org/wiki/P7zip">p7zip</a></a><ul>
                        
                <li>
                    <a href="#ziphttpswwwtecmintcomunzip-extract-zip-files-to-specific-directory-in-linux" aria-label="zip"><a href="https://www.tecmint.com/unzip-extract-zip-files-to-specific-directory-in-linux/">zip</a></a></li>
                <li>
                    <a href="#arkhttpsappskdeorgark" aria-label="Ark"><a href="https://apps.kde.org/ark/">Ark</a></a></li></ul>
                </li>
                <li>
                    <a href="#adb-and-fastboothttpswikigentooorgwikiandroidadb" aria-label="ADB and Fastboot"><a href="https://wiki.gentoo.org/wiki/Android/adb">ADB and Fastboot</a></a><ul>
                        
                <li>
                    <a href="#file-transfer" aria-label="File transfer">File transfer</a></li></ul>
                </li>
                <li>
                    <a href="#flatpakhttpsflatpakorgsetupgentoo" aria-label="Flatpak"><a href="https://flatpak.org/setup/Gentoo">Flatpak</a></a></li>
                <li>
                    <a href="#neofetchhttpszhuanlanzhihucomp69777438" aria-label="neofetch"><a href="https://zhuanlan.zhihu.com/p/69777438">neofetch</a></a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e8%87%aa%e5%ae%9a%e4%b9%89%e5%9b%be%e5%83%8f" aria-label="使用自定义图像">使用自定义图像</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae-neofetch" aria-label="配置 Neofetch">配置 Neofetch</a></li></ul>
                </li>
                <li>
                    <a href="#cpuid2cpuflags" aria-label="cpuid2cpuflags">cpuid2cpuflags</a></li>
                <li>
                    <a href="#flaggie" aria-label="flaggie">flaggie</a></li>
                <li>
                    <a href="#dwmhttpszhuanlanzhihucomp346719806" aria-label="dwm"><a href="https://zhuanlan.zhihu.com/p/346719806">dwm</a></a><ul>
                        
                <li>
                    <a href="#de%e5%92%8cwm%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="DE和WM的区别">DE和WM的区别</a></li>
                <li>
                    <a href="#dwm%e4%b8%8e%e5%85%b6%e4%bb%96wm%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="dwm与其他wm的区别">dwm与其他wm的区别</a></li>
                <li>
                    <a href="#%e9%80%9a%e7%94%a8%e7%9a%84wm%e9%85%8d%e7%bd%ae" aria-label="通用的wm配置">通用的wm配置</a></li>
                <li>
                    <a href="#dwm%e5%ae%89%e8%a3%85" aria-label="dwm安装">dwm安装</a></li>
                <li>
                    <a href="#dwm%e9%85%8d%e7%bd%aehttpszhuanlanzhihucomp183861786" aria-label="dwm配置"><a href="https://zhuanlan.zhihu.com/p/183861786">dwm配置</a></a></li></ul>
                </li>
                <li>
                    <a href="#crossover" aria-label="Crossover">Crossover</a></li>
                <li>
                    <a href="#recommended-applicationshttpswikigentooorgwikirecommended_applications-gentoo" aria-label="Recommended applications: Gentoo"><a href="https://wiki.gentoo.org/wiki/Recommended_applications">Recommended applications</a>: Gentoo</a></li>
                <li>
                    <a href="#list-of-applicationshttpswikiarchlinuxorgtitlelist_of_applications-arch" aria-label="List of applications: Arch"><a href="https://wiki.archlinux.org/title/List_of_applications">List of applications</a>: Arch</a></li></ul>
                </li>
                <li>
                    <a href="#tips" aria-label="Tips">Tips</a><ul>
                        
                <li>
                    <a href="#petrusz" aria-label="Petrus.Z">Petrus.Z</a><ul>
                        
                <li>
                    <a href="#portagehttpswwwcodeplayerorgwikigentooportagehtml" aria-label="Portage"><a href="https://www.codeplayer.org/Wiki/Gentoo/Portage.html">Portage</a></a><ul>
                        
                <li>
                    <a href="#command" aria-label="command">command</a></li>
                <li>
                    <a href="#apply-patches" aria-label="apply patches">apply patches</a></li></ul>
                </li>
                <li>
                    <a href="#kernelhttpswwwcodeplayerorgwikigentookernelhtml" aria-label="Kernel"><a href="https://www.codeplayer.org/Wiki/Gentoo/kernel.html">Kernel</a></a></li>
                <li>
                    <a href="#upgradegentoohttpswwwcodeplayerorgwikigentooupgradegentoohtml" aria-label="UpgradeGentoo"><a href="https://www.codeplayer.org/Wiki/Gentoo/UpgradeGentoo.html">UpgradeGentoo</a></a><ul>
                        
                <li>
                    <a href="#how-to-upgrade-gentoo" aria-label="How to upgrade gentoo">How to upgrade gentoo</a></li>
                <li>
                    <a href="#how-to-upgrade-python-local-package" aria-label="How to upgrade python local package">How to upgrade python local package</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-gnu-stow-%e7%ae%a1%e7%90%86%e4%bd%a0%e7%9a%84%e9%bb%9e%e6%96%87%e4%bb%b6httpfarseerfcmeusing-gnu-stow-to-manage-your-dotfileshtml" aria-label="使用 GNU stow 管理你的點文件"><a href="http://farseerfc.me/using-gnu-stow-to-manage-your-dotfiles.html#">使用 GNU stow 管理你的點文件</a></a></li>
                <li>
                    <a href="#freeing-disk-spacehttpswikigentooorgwikiknowledge_basefreeing_disk_space" aria-label="Freeing disk space"><a href="https://wiki.gentoo.org/wiki/Knowledge_Base:Freeing_disk_space">Freeing disk space</a></a></li>
                <li>
                    <a href="#how-to-change--set-the-default-crontab-editorhttpswwwservernoobscomchange-set-the-default-crontab-editortextif20you20want20to20change20your20default20crontabin20general2c20you20use20this20command3a20export20editor3d2fusr2fbin2fnano" aria-label="How to Change &amp;amp; Set the Default crontab Editor"><a href="https://www.servernoobs.com/change-set-the-default-crontab-editor/#:~:text=If%20you%20want%20to%20change%20your%20default%20crontab,in%20general%2C%20you%20use%20this%20command%3A%20export%20EDITOR%3D%2Fusr%2Fbin%2Fnano.">How to Change &amp; Set the Default crontab Editor</a></a></li>
                <li>
                    <a href="#how-to-update-dolphin-file-manager-in-real-timehttpsaskubuntucomquestions311303how-to-update-dolphin-file-manager-in-real-time" aria-label="How to update dolphin file manager in real time"><a href="https://askubuntu.com/questions/311303/how-to-update-dolphin-file-manager-in-real-time">How to update dolphin file manager in real time</a></a></li>
                <li>
                    <a href="#how-do-i-convert-a-png-into-a-icohttpssuperusercomquestions227736how-do-i-convert-a-png-into-a-ico1012535" aria-label="How do I convert a .PNG into a .ICO?"><a href="https://superuser.com/questions/227736/how-do-i-convert-a-png-into-a-ico/1012535">How do I convert a .PNG into a .ICO?</a></a></li>
                <li>
                    <a href="#crop-a-photo-to-fit-a-circle-using-ffmpeghttpsstackoverflowcomquestions63997289can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg" aria-label="Crop a photo to fit a circle using ffmpeg"><a href="https://stackoverflow.com/questions/63997289/can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg">Crop a photo to fit a circle using ffmpeg</a></a></li>
                <li>
                    <a href="#path-to-kde-picture-of-the-dayhttpsaskubuntucomquestions1197417where-is-bings-picture-of-the-day-stored-on-my-system" aria-label="Path to KDE Picture of the Day"><a href="https://askubuntu.com/questions/1197417/where-is-bings-picture-of-the-day-stored-on-my-system">Path to KDE Picture of the Day</a></a></li>
                <li>
                    <a href="#baloohttpscommunitykdeorgbaloo" aria-label="Baloo"><a href="https://community.kde.org/Baloo">Baloo</a></a><ul>
                        
                <li>
                    <a href="#baloo-file-extractor-crashes-on-every-boothttpsforumsgentooorgviewtopic-t-1096234-start-0html" aria-label="Baloo File Extractor Crashes on every boot"><a href="https://forums.gentoo.org/viewtopic-t-1096234-start-0.html">Baloo File Extractor Crashes on every boot</a></a></li></ul>
                </li>
                <li>
                    <a href="#%e5%86%85%e6%a0%b8%e5%8d%87%e7%ba%a7%e4%b8%80%e8%88%ac%e6%ad%a5%e9%aa%a4httpsblogsoymilkfun20201117linuxgentoogentookernelupdate" aria-label="内核升级一般步骤"><a href="https://blog.soymilk.fun/2020/11/17/Linux/Gentoo/GentooKernelUpdate/">内核升级一般步骤</a></a><ul>
                        
                <li>
                    <a href="#%e5%8d%87%e7%ba%a7%e5%86%85%e6%a0%b8" aria-label="升级内核">升级内核</a></li>
                <li>
                    <a href="#configuration" aria-label="Configuration">Configuration</a></li>
                <li>
                    <a href="#build" aria-label="Build">Build</a></li>
                <li>
                    <a href="#install" aria-label="Install">Install</a></li>
                <li>
                    <a href="#bootloader" aria-label="BootLoader">BootLoader</a></li>
                <li>
                    <a href="#clean" aria-label="Clean">Clean</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#questions" aria-label="Questions">Questions</a><ul>
                        
                <li>
                    <a href="#problem-with-transparencies-and-windowing-ghosting-outhttpsforumgarudalinuxorgtproblem-with-transparencies-and-windowing-ghosting-out9568" aria-label="Problem with transparencies and windowing ghosting out"><a href="https://forum.garudalinux.org/t/problem-with-transparencies-and-windowing-ghosting-out/9568">Problem with transparencies and windowing ghosting out</a></a></li>
                <li>
                    <a href="#telegram-not-launching-from-the-browser-xdg-openhttpswwwredditcomrmanjarolinuxcommentsk76cphtelegram_not_launching_from_the_browser_xdgopen" aria-label="Telegram not launching from the browser xdg-open"><a href="https://www.reddit.com/r/ManjaroLinux/comments/k76cph/telegram_not_launching_from_the_browser_xdgopen/">Telegram not launching from the browser xdg-open</a></a></li>
                <li>
                    <a href="#how-to-reset-kde--display-settings-after-a-move-to-a-new-machinehttpsaskubuntucomquestions299241how-to-reset-kde-display-settings-after-a-move-to-a-new-machine" aria-label="How to reset KDE / display settings after a move to a new machine"><a href="https://askubuntu.com/questions/299241/how-to-reset-kde-display-settings-after-a-move-to-a-new-machine">How to reset KDE / display settings after a move to a new machine</a></a></li>
                <li>
                    <a href="#how-can-i-reset-my-display-settings-through-terminalhttpsaskubuntucomquestions749333how-can-i-reset-my-display-settings-through-terminal" aria-label="How can I reset my display settings through terminal?"><a href="https://askubuntu.com/questions/749333/how-can-i-reset-my-display-settings-through-terminal">How can I reset my display settings through terminal?</a></a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="portage介绍httpswikigentooorgwikihandbookamd64workingportage"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/Portage">Portage介绍</a><a hidden class="anchor" aria-hidden="true" href="#portage介绍httpswikigentooorgwikihandbookamd64workingportage">#</a></h2>
<h3 id="欢迎使用-portage">欢迎使用 Portage<a hidden class="anchor" aria-hidden="true" href="#欢迎使用-portage">#</a></h3>
<p>Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具。</p>
<p>Portage 是用 <a href="https://www.python.org/">Python</a> 和 <a href="https://www.gnu.org/software/bash">Bash</a> 两种语言编写的。因为它们都是脚本语言所以用户可以直接阅读它的代码。</p>
<p>大多数用户通过 <strong>emerge</strong> 使用 Portage。本章的内容不是复述 emerge 的 man page。要了解 emerge 的所有可用选项，请查阅 emerge 的 man page（<a href="http://www.jinbuguo.com/pkgmanager/gentoo/emerge.html">emerge 中文手册</a>）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># man emerge</span>
</code></pre></div><h3 id="gentoo-软件仓库">Gentoo 软件仓库<a hidden class="anchor" aria-hidden="true" href="#gentoo-软件仓库">#</a></h3>
<p>查询 Portage 的信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --info</span>
</code></pre></div><h4 id="ebuild">Ebuild<a hidden class="anchor" aria-hidden="true" href="#ebuild">#</a></h4>
<p>当 Gentoo 的文档介绍某个软件包的时候，这意味着 Gentoo 的用户们可以在 Gentoo 的软件仓库里找到它。ebuild 是一种包含了所有 Portage 维护软件（比如安装，搜索，查询等等）所需信息的文件，而 Gentoo 的软件仓库是它们的一个集合。这些 ebuild 文件默认储存在 <code>/var/db/repos/gentoo</code>。</p>
<p>Portage 对于软件的行为都是基于本地的 ebuild。为了能收到新的软件包，安全更新等等，时常更新本地 ebuild 是一件很重要的事情。</p>
<h4 id="更新-gentoo-软件仓库">更新 Gentoo 软件仓库<a hidden class="anchor" aria-hidden="true" href="#更新-gentoo-软件仓库">#</a></h4>
<p>Gentoo 的软件仓库通常使用 <strong>rsync</strong> 进行同步，rsync 是一个快速的文件增量传输工具。要使用它很简单，Portage 的命令行前端 <strong>emerge</strong> 提供了一个调用 <strong>rsync</strong> 的方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --sync</span>
</code></pre></div><p>有时防火墙会干扰 <strong>rsync</strong> 与镜像的连接。这时，我们可以使用 <strong>emerge-webrsync</strong> 来自动下载和安装 Portage 树的快照版本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge-webrsync</span>
</code></pre></div><p>使用 <strong>emerge-webrsync</strong> 的另一个好处是可以只安装由 Gentoo release engineering 团队的 GPG 密钥签名过的快照。与此有关的详细信息可以在 <a href="https://wiki.gentoo.org/wiki/Handbook:Parts/Working/Features#Validated_Gentoo_repository_snapshots">fetching validated Gentoo repository snapshots</a> 找到</p>
<h3 id="维护软件">维护软件<a hidden class="anchor" aria-hidden="true" href="#维护软件">#</a></h3>
<h4 id="搜索软件">搜索软件<a hidden class="anchor" aria-hidden="true" href="#搜索软件">#</a></h4>
<p>有很多方法可以在 Gentoo 的软件仓库寻找软件。其中之一是使用 <strong>emerge</strong> 本身。在默认情况下 <strong>emerge &ndash;search</strong> 会返回所有符合搜索条件的包名。</p>
<p>举个例子，找出所有名字里含有 “pdf” 的包：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -s &lt;包名&gt;</span>
<span style="color:#75715e"># emerge --search pdf</span>
</code></pre></div><p>如果要根据描述进行搜索，可以使用 <code>--searchdesc</code> （或 <code>-S</code>）选项:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --searchdesc pdf</span>
</code></pre></div><p>需要注意的是它会输出很多信息。不过由于都有很清楚的标识，我们就不再赘述它们的意思了。</p>
<h4 id="安装软件">安装软件<a hidden class="anchor" aria-hidden="true" href="#安装软件">#</a></h4>
<p>当你找到了软件包的名字，安装它只需要简单得使用 <strong>emerge</strong>。举个例子，如果要安装 gnumeric：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge &lt;包名&gt;</span>
<span style="color:#75715e"># emerge --ask app-office/gnumeric</span>
</code></pre></div><p>由于很多软件依赖其它的软件，在安装该软件的同时很可能还会安装它的一些以来。不要担心，Portage 可以很好地处理依赖关系。如果要知道 Portage 会安装什么软件，可以在命令中加入 <code>-p/--pretend</code>选项。举个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --pretend gnumeric</span>
</code></pre></div><p>在安装软件期间，Portage将从Internet下载必要的源代码（如果需要），并将其默认存储在 <code>/var/cache/distfiles/</code> 中。 之后，它将解压缩，编译和安装包。 要让Portage仅下载源代码而不安装软件，请添加<code>-f/--fetchonly</code>选项到emerge命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --fetchonly gnumeric</span>
</code></pre></div><p>恢复上一次失败的 emerge</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -r</span>
</code></pre></div><p>其它常用的选项有</p>
<ul>
<li>
<p><code>-1/--oneshot</code> 一般用在安装软件包时，不将该包添加到 world 集中</p>
</li>
<li>
<p><code>-O/--nodeps</code> 不计算依赖关系，只操作指定的包（安装时可能会因为依赖不满足而导致安装失败）</p>
</li>
<li>
<p><code>-j/--jobs</code> 设置 Portage 同时执行的最大任务数，如果未设置数量，那么 Portage 不会限制最大的任务数。如果要将该选项添加到默认选项下，那么建议配合 <code>-l/--load-average</code> 使用， <code>-l/--load-average</code> 用于配置 emerge 的负载阈值，当当前负载到达设定值后， emerge 将不再开启新任务，以避免负载过高，这在 CPU 不够强悍或者内存不宽裕的机器上很需要。比如在一个 8 核 16 线程 16G 内存的机器上，可以设置成 <code>-j -l 12</code> ，这样的设定使 portage 的并行任务数不由硬性规定的数目来限制，而是通过动态负载来进行限制。</p>
</li>
<li>
<p><code>--keep-going</code> 它会在安装出错时，跳过安装失败的包，并重新计算依赖后继续安装剩余包</p>
</li>
<li>
<p><code>-n/--noreplace</code> 不重复安装已经安装的包（默认会忽略掉 USE 的改动以及升级的查询，除非对应加上 <code>-D/-U</code> 和 <code>-u</code> 选项）</p>
</li>
<li>
<p><code>-t/--tree</code> 显示给定包的安装依赖树</p>
</li>
<li>
<p><code>--autounmask</code> 类</p>
<p>这是一组在新装软件包时便于解除安装限制的选项。之前有介绍，在 Portage 安装软件的过程中，可能会因为 USE/License/Keywords 等因素导致无法直接安装，需要配置后再进行，而这组选项可以自动化这个过程。个人建议的相关选项组合为 <code>--autounmask --autounmask-keep-masks --autounmask-write=n</code> ，此组合不会完全自动写入配置到系统下，但是提示了如何配置，方便手动写入，既简化了处理限制的流程，又能保证掌握每次安装包时的改动。</p>
</li>
</ul>
<h4 id="查找已安装软件的文档">查找已安装软件的文档<a hidden class="anchor" aria-hidden="true" href="#查找已安装软件的文档">#</a></h4>
<p>许多软件包中包含有自己的文档，有些时候，<code>doc</code>的USE标记决定了软件包中的自带文档是否会被安装。您可以通过 <strong>emerge -vp category/包名</strong>命令来检查是否存在<code>doc</code> USE 标志：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -vp media-libs/alsa-lib</span>
These are the packages that would be merged, in order:
 
Calculating dependencies... <span style="color:#66d9ef">done</span>!
<span style="color:#f92672">[</span>ebuild   R    <span style="color:#f92672">]</span> media-libs/alsa-lib-1.1.3::gentoo  USE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;python -alisp -debug -doc&#34;</span> ABI_X86<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;(64) -32 (-x32)&#34;</span> PYTHON_TARGETS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;python2_7&#34;</span> <span style="color:#ae81ff">0</span> KiB
</code></pre></div><p>最好的启用 <code>doc</code> USE 的方式是在 /etc/portage/package.use里对想要启用的包单独启用，这样你就能只获得你想要的软件文档。了解更多信息请阅读 <a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/USE/zh-cn">USE flags chapter</a>。</p>
<p>当一个软件包安装结束后，它的文档通常会存放在/usr/share/doc/目录下的，以软件包名命名的子目录中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -l /usr/share/doc/alsa-lib-1.1.3
total <span style="color:#ae81ff">16</span>
-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">3098</span> Mar  <span style="color:#ae81ff">9</span> 15:36 asoundrc.txt.bz2
-rw-r--r-- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">672</span> Mar  <span style="color:#ae81ff">9</span> 15:36 ChangeLog.bz2
-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">1083</span> Mar  <span style="color:#ae81ff">9</span> 15:36 NOTES.bz2
-rw-r--r-- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">220</span> Mar  <span style="color:#ae81ff">9</span> 15:36 TODO.bz2
</code></pre></div><p>列出已安装文档文件的更可靠方法是使用 <strong>equery</strong> 的 <code>--filter</code> 选项。 <strong>equery</strong> 用于查询Portage的数据库，并作为 <a href="https://packages.gentoo.org/packages/app-portage/gentoolkit">app-portage/gentoolkit</a> 包的一部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ equery files --filter<span style="color:#f92672">=</span>doc alsa-lib
 * Searching <span style="color:#66d9ef">for</span> alsa-lib in media-libs ...
 * Contents of media-libs/alsa-lib-1.1.3:
/usr/share/doc/alsa-lib-1.1.3/ChangeLog.bz2
/usr/share/doc/alsa-lib-1.1.3/NOTES.bz2
/usr/share/doc/alsa-lib-1.1.3/TODO.bz2
/usr/share/doc/alsa-lib-1.1.3/asoundrc.txt.bz2
</code></pre></div><p><code>--filter</code> 选项可与其他规则一起使用，以查看许多其他类型文件的安装位置。可以在 <strong>equery</strong> 的手册中查看其他功能: <strong>man 1 equery</strong>。</p>
<h4 id="卸载软件">卸载软件<a hidden class="anchor" aria-hidden="true" href="#卸载软件">#</a></h4>
<p>当您想把一个软件包从系统中移除的时候，使用 <strong>emerge &ndash;unmerge</strong>命令。命令执行完成后，Portage将会移除此软件包安装到您系统中的所有文件，除了那些在安装软件后您修改过的配置文件。保留这些修改过的配置文件是为了便于您今后再次使用它。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --unmerge gnumeric</span>
<span style="color:#75715e"># emerge -C &lt;包名&gt;</span>
</code></pre></div><p>当您从系统中移除一个软件包时，之前那些为了满足其依赖关系而被自动安装的软件包将会被保留在系统中。要使Portage找到现在可以删除的所有依赖项，可以使用 <code>--depclean</code> 功能。</p>
<p>自动清理系统下的软件包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask --depclean</span>
<span style="color:#75715e"># emerge -ac</span>
</code></pre></div><h4 id="默认选项">默认选项<a hidden class="anchor" aria-hidden="true" href="#默认选项">#</a></h4>
<p>emerge 支持配置一组默认选项，用于在每次运行 emerge 时采用。这个储存默认选项的变量名为 <code>EMERGE_DEFAULT_OPTS</code> ，在 <code>/etc/portage/make.conf</code> 文件下设置。</p>
<p>这里一组比较推荐的默认选项配置为</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">EMERGE_DEFAULT_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--autounmask --autounmask-keep-masks --autounmask-write=n --keep-going -v -j -l 12&#34;</span>
</code></pre></div><p>其中的 12 请根据实际情况修改，如果配置了上文的 binhost ，那么对应选项也添加进入。</p>
<h4 id="understanding-portages-formatted-and-colored-outputhttpwikigentooksiezycplhowto_use_portage_correctlyhtm"><strong><a href="http://wikigentoo.ksiezyc.pl/HOWTO_Use_Portage_Correctly.htm">Understanding Portage&rsquo;s Formatted and Colored Output</a></strong><a hidden class="anchor" aria-hidden="true" href="#understanding-portages-formatted-and-colored-outputhttpwikigentooksiezycplhowto_use_portage_correctlyhtm">#</a></h4>
<p>Output from portage is compactly formatted to indicate a plethora of information.</p>
<p><strong>Emerge &ldquo;Pretend&rdquo; Output</strong></p>
<ul>
<li>N = new (not yet installed)</li>
<li>S = new SLOT installation (side-by-side versions)</li>
<li>U = updating (to another version)</li>
<li>D = downgrading (best version seems lower)</li>
<li>R = replacing (re-merging same version)</li>
<li>F = fetch restricted (must be manually downloaded)</li>
<li>f = fetch (already downloaded)</li>
<li>B = blocked by an already installed package</li>
</ul>
<p><strong>USE Flags</strong></p>
<ul>
<li>An unmarked USE flag is unchanged and enabled.</li>
<li><strong>-</strong> A dash preceding a USE flag (<strong>yellow</strong>, <strong>green</strong> or <strong>blue</strong>) shows that it is disabled.</li>
<li><strong>%</strong> A percent symbol following a USE flag indicates that it is new for this package. Identical to yellow output.</li>
<li>***** An asterisk following a USE flag indicates that its meaning/scope has been updated. Identical to green output.</li>
<li><strong>()</strong> Parentheses around a USE flag indicate that it is currently masked by your profile. This is usually because the USE flag can not be supported on the given platform (for example, the <strong>win32codecs</strong> on <strong>amd64</strong> with non-binary packages) or is irrelevant (for example, <strong>sse</strong> is available on all <strong>amd64</strong> CPU&rsquo;s, so there&rsquo;s no point being able to disable it in a 64-bit environment).</li>
</ul>
<p><strong>Color Output</strong></p>
<p>Portage returns information to you using both symbols and colors. While the combination makes for a pretty output it also may appear confusing on first glance. Note that the color information is not required, so it repeats the symbolic output.</p>
<ul>
<li><strong>red</strong> - The USE flag is enabled and has not changed.</li>
<li><strong>yellow</strong> - The USE flag has been added since the package was last installed.</li>
<li><strong>green</strong> - The USE flag has changed since the last time the package was installed, as the asterisk after it indicates.</li>
<li><strong>blue</strong> - The USE flag is disabled, as the dash before it indicates.</li>
</ul>
<p><strong>Example</strong></p>
<p>If you run the command</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --verbose --deep --newuse world</span>
</code></pre></div><p>you might get something similar to</p>
<pre tabindex="0"><code>[ebuild   R    ] sys-kernel/linux-headers-2.6.11-r2  USE=&quot;-gcc64%&quot; 36,470 kB 
[ebuild    U   ] sys-process/psmisc-22.2  USE=&quot;X* ipv6 nls (-selinux)&quot; 238 kB
</code></pre><p>In this example the <strong>sys-kernel/linux-headers</strong> package would be reinstalled as indicated by the &ldquo;R&rdquo; at the beginning of the line. The <strong>sys-process/psmisc</strong> package is being updated, as shown by the &ldquo;U&rdquo; at the beginning of the line.</p>
<ul>
<li>The <strong>gcc64</strong> USE flag is colored <strong>yellow</strong> and followed by &ldquo;<strong>%</strong>&rdquo; showing that that option has been added since the package was last installed. The &ldquo;<strong>-</strong>&rdquo; shows that it will be disabled during this update.</li>
<li>The <strong>X</strong> USE flag will be <strong>green</strong> and followed by &ldquo;*<strong><strong>&rdquo; because that USE flag has changed since the last time the package was installed, as the asterisk after it indicates. No &ldquo;</strong>-</strong>&rdquo; shows that it will be enabled during this update.</li>
<li>The <strong>ipv6</strong> and <strong>nls</strong> USE flags would appear <strong>red</strong> since they are enabled (No &ldquo;<strong>-</strong>&quot;) and have not changed (No &ldquo;*****&quot;).</li>
<li>The <strong>selinux</strong> USE flag will be <strong>blue</strong> because the flag is disabled, as the dash before it indicates. The parentheses also show that it is an unavailable or irrelevant option.</li>
</ul>
<h3 id="更新系统">更新系统<a hidden class="anchor" aria-hidden="true" href="#更新系统">#</a></h3>
<p>要保持您的系统在最佳状态（更不用说安装那些最新的安全更新），您需要定期的更新您的系统。由于Portage只能检查本地已有文件，因此您首先应该更新您的Portage树。当您的Portage树更新后，您可以用 <strong>emerge &ndash;update @world</strong>命令来更新系统。在下一个例子里，我们还会使用 <code>--ask</code> 选项来控制Portage显示它要更新的软件包列表， 并让您决定是否继续更新。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --ask @world</span>
</code></pre></div><p>Portage将搜索已安装的程序的新版本。 然而，它只会验证明确安装的应用程序（在 /var/lib/portage/world 列出的应用程序）的版本，却不会检查它们的依赖项。若要更新这些包的依赖项，请添加 <code>--deep</code> 选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --deep @world</span>
</code></pre></div><p>但是，这并不意味着会更新所有的软件包：某些系统上的软件包，会在编译和构建软件的过程中需要，但是一旦安装完软件，就不再需要这些依赖项。 Portage 称这些依赖为“构建依赖”。 若要在更新时包含这些构建依赖，请添加 <code>--with-bdeps=y</code> 选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --deep --with-bdeps=y @world</span>
</code></pre></div><p>因为有时那些没有明确安装的包（但作为其他软件包的依赖而装入系统中）会推出安全更新，所以推荐偶尔运行一下这个命令。</p>
<p>每当您改变了系统中任何的 USE 标记后，最好加入 <code>--newuse</code> 选项。这样 Portage 将会验证这个 USE 标记变动后，是否需要安装新的软件包或者将现有的软件包重新编译。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --deep --with-bdeps=y --newuse @world</span>
</code></pre></div><p><strong>Meta软件包</strong></p>
<p>Gentoo中的一些软件包并没有包含任何实际的内容，而只是用来安装一系列软件包的集合。例如，<a href="https://packages.gentoo.org/packages/kde-plasma/plasma-meta">kde-plasma/plasma-meta</a> 包就是一个包含了一系列与Plasma相关的互相依赖的软件包的集合，您可以通过安装它来在系统中搭建起一个完整的KDE Plasma 桌面环境。</p>
<p>如果您试图从系统中移除一个这样的软件包的集合体，只是单纯地使用 <strong>emerge &ndash;unmerge</strong> 命令并不能完成您的要求，原因在于这些包的依赖关系仍然保留在系统中。</p>
<p>不用担心，Portage也提供了移除孤立依赖的软件包的功能，但由于软件包间的依赖关系是动态的，您首先需要充分地更新您的整个系统，包括更改USE标记设定而导致的变化。在这之后您可以运行<strong>emerge &ndash;depclean</strong>来移除那些完全没有被其他包依赖的软件包。移除之后你需要重新编译那些曾经与刚刚移除的这些包动态连接过的应用程序，因为实际上这些程序不需要那些包。</p>
<p>所有这些可以用以下三个命令来实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --deep --newuse @world</span>
<span style="color:#75715e"># emerge --depclean</span>
<span style="color:#75715e"># revdep-rebuild</span>
</code></pre></div><h4 id="关于配置文件的更新">关于配置文件的更新<a hidden class="anchor" aria-hidden="true" href="#关于配置文件的更新">#</a></h4>
<p>有时候在更新了某些软件包后你会发现出现了一个类似如下的提示信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">* IMPORTANT: <span style="color:#ae81ff">2</span> config files in <span style="color:#e6db74">&#39;/etc&#39;</span> need updating.
* See the CONFIGURATION FILES and CONFIGURATION FILES UPDATE TOOLS
* sections of the emerge man page to learn how to update config files.
</code></pre></div><p>一般出现这种情况的直接原因是你通过归属于一个软件包的文件修改了其默认配置，导致新安装的文件与现存文件不符，于是 Portage 出于保护现存文件的目的，将新文件重命名为了对应目录下的 <code>._cfgxxxx_&lt;原名&gt;</code> 文件，这是一个很常见的情况。</p>
<p>而每当出现这种情况后，需要做的操作就是人工介入，判断一下保留哪个文件，还是将两个文件合并。而自带用于进行此操作的对应命令有 <code>dispatch-conf</code> 与 <code>etc-update</code> 。</p>
<p>以 <code>dispatch-conf</code> 为例，root 权限下执行后，它会逐个文件列出改动，然后提示你进行操作，比如按 z 保留旧的配置文件，按 u 使用新安装的配置文件替换旧的，等等。</p>
<h4 id="改变桌面环境httpslitterhougelangleylifeblog20210609gentoo-maintain-02-change-profile"><a href="https://litterhougelangley.life/blog/2021/06/09/gentoo-maintain-02/">改变桌面环境</a>/ Change Profile<a hidden class="anchor" aria-hidden="true" href="#改变桌面环境httpslitterhougelangleylifeblog20210609gentoo-maintain-02-change-profile">#</a></h4>
<ul>
<li>
<p>首先修改 <code>/var/lib/portage/world</code> 文件，这个文件记录了用户主动安装的软件，换句话说，整个系统的构建就是围绕这 world 来创建的。将这个文件中不再需要的包删除，比方说 KDE 的软件和一些后续可以再安装，而目前保留可能造成构建麻烦的软件，比方说 htop，megasync，telegram-desktop，fcitx5 之类的，尽量减少到保留必须的就可以了，比方说内核，zfs 之类的。另外可以使用 <code>emerge --deselect xxxx</code> 命令清理 world 。</p>
</li>
<li>
<p>然后是修改或是删除暂时不需要的 USE 配置文件。这里需要强调一下，world 文件是我们手动安装的软件，这些软件用  <code>/etc/portage/package.use/</code>  定义了其他附带安装的软件包和组。里面不再需要的包，就需要精简，甚至是删除。</p>
</li>
<li>
<p>其次使用 eselect profile 修改配置文件到需要的 Profile 。</p>
</li>
<li>
<p>再次就是运行 <code>emerge --sync; emerge --depclean</code> 来清理系统。一般情况下，这个步骤会删除数百个包，耐心等它完成。</p>
</li>
<li>
<p>最后就是一些收尾工作，清理结束后，运行一些小工具来解决一些新老软件依赖的问题，运行下面的命令一波清：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -avj @preserved-rebuild; perl-cleaner --all; emerge --sync; emerge -avujDN --with-bdeps=y --autounmask-write=y @world</span>
</code></pre></div><p>运行以后看看会不会有什么 Block 之类的包，或者循环依赖的包，手动删除下；还有时候解决不了看看是不是 USE 没有清理干净，多试几次就会清理干净，更新没有任何报错就可以开始后续的操作了。</p>
</li>
<li>
<p>这个时候一般会来一次全系统重构。命令如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -ej --keep-going @world</span>
</code></pre></div></li>
<li>
<p>清理 <code>/home/&lt;user&gt;/</code> 下的各种配置文件，安装新的桌面环境。</p>
</li>
</ul>
<h3 id="licenses">Licenses<a hidden class="anchor" aria-hidden="true" href="#licenses">#</a></h3>
<p>从Portage版本2.1.7开始，可以根据其授权协议接受或拒绝安装软件。 portage 树中的所有包在其ebuild中包含一个LICENSE选项。 运行<strong>emerge &ndash;search package/category</strong> 将显示软件包的许可证。</p>
<p><strong>Important</strong>：ebuild 中 的 LICENSE 变量仅是为 Gentoo 开发人员和用户准备的一份指南。它既不是法律声明，也不保证其真实性。因此不要过度依赖它，您需要深入检查软件包的本身，以及您使用的所有文件。</p>
<p>默认情况下，Portage允许<a href="https://www.gnu.org/licenses/license-list.html">自由软件基金会</a>，<a href="https://opensource.org/licenses">开源计划</a>或遵循<a href="https://www.gnu.org/philosophy/free-sw.html">自由软件定义</a>明确批准的许可。</p>
<p>控制允许的许可证的变量称为ACCEPT_LICENSE，可以在<code>/etc/portage/make.conf</code>文件中设置。 在下一个示例中，将显示他的默认值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ACCEPT_LICENSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-* @FREE&#34;</span>
</code></pre></div><p>使用此配置，可以安装具有自由软件或文档许可证的软件包。非自由软件将无法安装。</p>
<p>可以在ACCEPT_LICENSE中全局设置 ACCEPT_LICENSE，或者在<code>/etc/portage/package.license</code> 文进行配置。</p>
<p>举个例子，要允许<a href="https://packages.gentoo.org/packages/www-client/google-chrome">www-client/google-chrome</a> 包的google-chrome的授权协议， 把下面的内容添加到 <code>/etc/portage/package.license</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;类&gt;/&lt;名&gt; &lt;许可名称&gt;
www-client/google-chrome google-chrome
<span style="color:#75715e"># 亦可指定版本，比如对 20210818 及以上版本的 sys-kernel/linux-firmware 进行配置</span>
&gt;<span style="color:#f92672">=</span>sys-kernel/linux-firmware-20210818 linux-fw-redistributable no-source-code
</code></pre></div><p>这允许安装<a href="https://packages.gentoo.org/packages/www-client/google-chrome">www-client/google-chrome</a> 程序包，但禁止安装<a href="https://packages.gentoo.org/packages/www-plugins/chrome-binary-plugins">www-plugins/chrome-binary-plugins</a> 程序包，即使它具有相同的 授权协议。</p>
<p><strong>重要</strong>：授权协议存储在 /var/db/repos/gentoo/licenses/ ，授权协议组在/var/db/repos/gentoo/profiles/license_groups 里面。<em>CAPITAL</em>字母中每行的第一个条目是许可证组的名称，之后的每个条目都是单独的许可证。</p>
<p>在 ACCEPT_LICENSE 变量中定义的许可证组前缀为<code>@</code> 符号。一种可能的设置（以前的Portage默认设置），是允许除“最终用户许可协议（EULA）”以外所有的许可证，“最终用户许可协议（EULA）”中的许可证需要阅读并签署接受协议。要完成此操作，请接受所有许可证（使用<code>*</code>），然后删除EULA组中的许可证，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ACCEPT_LICENSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;* -@EULA&#34;</span>
</code></pre></div><p>请注意，此设置也将接受非自由软件和文档。</p>
<h3 id="masking--unmasking-packages">Masking &amp; Unmasking packages<a hidden class="anchor" aria-hidden="true" href="#masking--unmasking-packages">#</a></h3>
<p>package.mask中指定的软件将会不被安装（可以将其看成黑名单），当新版本的软件出现一些问题的时候（或者是不兼容）可以在这个文件中添加对应的记录。</p>
<p><strong><code>/etc/portage/package.unmask</code></strong> 文件的作用将会覆盖package.mask的效果（安装白名单）。</p>
<h4 id="屏蔽特定的包版本">屏蔽特定的包版本<a hidden class="anchor" aria-hidden="true" href="#屏蔽特定的包版本">#</a></h4>
<p>如果它不存在，请创建/etc/portage/package.mask <em>文件</em>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#34;&gt;x11-drivers/ati-drivers-12.6_beta_pre897&#34; &gt;&gt; /etc/portage/package.mask</span>
</code></pre></div><p>或者，创建/etc/portage/package.mask/ <em>目录</em>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /etc/portage/package.mask/</span>
<span style="color:#75715e"># echo &#34;&gt;x11-drivers/ati-drivers-12.6_beta_pre897&#34; &gt; /etc/portage/package.mask/ati-drivers</span>
</code></pre></div><h4 id="从-ebuild-存储库中屏蔽包">从 ebuild 存储库中屏蔽包<a hidden class="anchor" aria-hidden="true" href="#从-ebuild-存储库中屏蔽包">#</a></h4>
<p>创建一个文件以从名为“larry”的 ebuild 存储库中屏蔽名称为<a href="https://packages.gentoo.org/packages/www-client/firefox">www-client/firefox </a>的包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#34;www-client/firefox::larry&#34; &gt; /etc/portage/package.mask/firefox</span>
</code></pre></div><p><strong><a href="https://forums.gentoo.org/viewtopic-p-7518568.html">屏蔽 overlay 所有的包</a></strong></p>
<p>常规操作都是enable repository 后把所有包都mask 掉，要用的时候单独一个个开，加上 autounmask 也不用自己写。</p>
<pre tabindex="0"><code>*/*::overlay_name
</code></pre><h3 id="accept_keywordshttpswikigentooorgwikiaccept_keywordszh-cn"><a href="https://wiki.gentoo.org/wiki/ACCEPT_KEYWORDS/zh-cn">ACCEPT_KEYWORDS</a><a hidden class="anchor" aria-hidden="true" href="#accept_keywordshttpswikigentooorgwikiaccept_keywordszh-cn">#</a></h3>
<p>ACCEPT_KEYWORDS 变量告诉包管理器哪个 ebuild 的 <a href="https://wiki.gentoo.org/wiki/KEYWORDS">KEYWORDS</a> 允许接受。</p>
<h4 id="变量在哪里设置">变量在哪里设置？<a hidden class="anchor" aria-hidden="true" href="#变量在哪里设置">#</a></h4>
<p>这个变量通常通过 Gentoo 的 <a href="https://wiki.gentoo.org/wiki/Profile_(Portage)">profile</a> 设置。但是可以在用户的 <a href="https://wiki.gentoo.org/wiki//etc/portage/make.conf">/etc/portage/make.conf</a> 文件里进行覆盖，以及在 <a href="https://wiki.gentoo.org/wiki//etc/portage/package.accept_keywords">/etc/portage/package.accept_keywords</a> 文件/目录下的每个包里或者甚至在命令行中进行覆盖。</p>
<p><strong>Important</strong>：通过命令行覆盖 ACCEPT_KEYWORDS 变量通常被认为是个坏主意，因为设置不会被包管理器保存而且可能导致不必要的行为。</p>
<h4 id="稳定与不稳定的-keywords">稳定与不稳定的 keywords<a hidden class="anchor" aria-hidden="true" href="#稳定与不稳定的-keywords">#</a></h4>
<p>在绝大多数的 profile 中 ACCEPT_KEYWORDS 变量的默认值即系统架构本身，例如 <code>ACCEPT_KEYWORDS=&quot;amd64&quot;</code> 或者 <code>ACCEPT_KEYWORDS=&quot;arm&quot;</code>。在此情况下，包管理器只接受那些KEYWORDS 变量包含此架构的 ebuild。如果用户希望能够安装那些还未被认为适合生产环境使用的 ebuild，可以在架构前添加 <code>~</code> 前缀，例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/make.conf</span>
ACCEPT_KEYWORDS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;~amd64&#34;</span>
</code></pre></div><p>由于ACCEPT_KEYWORDS变量是增量的，在添加测试关键字 (<code>~amd64</code>)的时候，不应当指定稳定的关键字(<code>amd64</code>)。</p>
<p>如果不是进行系统全局设置，那么可以在 <code>/etc/portage/package.accept_keywords</code> 文件或目录中对每个包进行单独设置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;类&gt;/&lt;名&gt; <span style="color:#f92672">[</span>可选的关键字配置<span style="color:#f92672">]</span>
<span style="color:#75715e"># games</span>
games-fps/doomsday ~amd64
<span style="color:#75715e"># 亦可指定版本，比如对 21.04.3 及以上版本的 kde-apps-meta 进行配置</span>
&gt;<span style="color:#f92672">=</span>kde-apps/kde-apps-meta-21.04.3
</code></pre></div><p>除了 ACCEPT_KEYWORDS 的通常值以外， package.accept_keywords 还支持三个特殊值：</p>
<ul>
<li><code>*</code> — 如果包在任何系统架构是稳定的，那么它可见</li>
<li><code>~*</code> — 如果包在任何系统架构是测试的，那么它可见</li>
<li><code>**</code> — 这个包总是可见的 (KEYWORDS 被完全忽略)</li>
</ul>
<p>最后一个选项对于版本经常改变的包 （当前 svn/git/mercurial/… 版本的包， 他们通过 live ebuild 来支持，并且没有 KEYWORDS 变量。</p>
<h3 id="当portage报错的时候">当Portage报错的时候<a hidden class="anchor" aria-hidden="true" href="#当portage报错的时候">#</a></h3>
<h4 id="简介">简介<a hidden class="anchor" aria-hidden="true" href="#简介">#</a></h4>
<p>正如我们之前指出的那样，Portage是一个非常强大并支持许多特性的软件包管理工具，而这是其他类似工具所欠缺的。为了理解这一点，我们为您粗略地解释一些Portage的面貌。</p>
<p>通过使用Portage，一个软件的不同版本可以共存于一个系统中。其他发行版倾向于直接在软件包名字中包含版本号（例如freetype 和 freetype2），Gentoo的Portage使用一种我们称之为<em>SLO的技术来实现这种并存。一个ebuild为它自身的版本声明了一个确切的SLOT。具有不同SLOT的同一软件的Ebuild可以共存于同一个系统中。例如，上例中那个freetype包就拥有不同的ebuilds，里面分别有 SLOT=&ldquo;1&rdquo; 和SLOT=&ldquo;2&quot;的标志</em></p>
<p>有一些不同的软件包提供了类似的功能。比如metalogd，sysklogd和syslog-ng都是系统日志记录工具。那些依赖于“系统日志记录工具”的程序并不能随便的依赖于其中之一，比如metalogd。因为其他的系统日志工具可能也是很好的选择。好在Portage允许使用虚拟包：每一个系统日志记录工具都可以提供<a href="https://packages.gentoo.org/packages/virtual/logger">virtual/logger</a>包，因此应用程序们可以设定成仅仅依赖于virtual/syslog即可。</p>
<p>Portage树中的软件可以存在于不同的分支中。您的系统默认只会接受那些Gentoo认为稳定的软件包。绝大多数新提交的软件会被添加到测试分支里。这意味着在此软件被标示为稳定版前需要进行更多的测试。尽管您可以看到那些软件的ebuilds已经加入Portage数据库，在它们未被加入稳定分支前Portage将不会安装它们。</p>
<p>有些软件只能在某几个体系结构上使用。或者在其他体系结构中还不能运行，或者仍需要对其进行更多的测试，或者将软件提交到Portage树中的开发者还不能确定这个软件能否运行于其他体系结构。</p>
<p>每一个Gentoo安装都依附于一个确定的profile，此文件里除了其他信息外还包含了一个正常工作的系统需要的软件包的列表。</p>
<h4 id="被阻挡的包">被阻挡的包<a hidden class="anchor" aria-hidden="true" href="#被阻挡的包">#</a></h4>
<p>Portage关于被阻挡的包的警告(使用 &ndash;pretend参数)</p>
<pre tabindex="0"><code>[blocks B     ] mail-mta/ssmtp (is blocking mail-mta/postfix-2.2.2-r1)
</code></pre><p>Portage关于被阻挡的包的警告(不使用 &ndash;pretend参数)</p>
<pre tabindex="0"><code>!!! Error: the mail-mta/postfix package conflicts with another package.
!!!        both can't be installed on the same system together.
!!!        Please use 'emerge --pretend' to determine blockers.
</code></pre><p>Ebuilds文件中包含了特定的字段，里面为Portage提供了此软件的各种依赖关系的信息。总计有两种可能的依赖关系：一种是编译依赖，在 DEPEND 区域进行声明;另一种是“运行时”依赖，在 RDEPEND 区域中进行声明。如果上述两种依赖关系中任何一个明确指明某个实体或者虚拟包（译注：可能已安装和正要安装）与要安装的包不相容的时候，就会阻挡软件的安装。</p>
<p>虽然Portage的最新版本足够聪明，可以在没有用户干预的情况下解决轻微的问题，但偶尔也需要手动解决此类问题。</p>
<p>为了使安装得以继续进行，您可以选择不安装这个软件包，或者先将发生冲突的包卸载。例如，在我们给出的这个例子中，您可以选择不安装postfix，或者先卸载ssmtp。</p>
<p>你也可能会遇到某些特定版本的包被屏蔽的情况，比如<code>&lt;media-video/mplayer-1.0_rc1-r2</code>。在这种情况下，升级到一个更新的版本就能解决问题。</p>
<p>也有可能两个需要安装的包互相阻挡。这种少见的情况下，您应该明确自己为什么需要同时安装它们。绝大多数时候您只需要安装它们之中的一个就可以了。如果不是这样，请您到 <a href="https://bugs.gentoo.org/">Gentoo&rsquo;s bugtracking system</a> 中提交一个bug。</p>
<h4 id="被屏蔽的包">被屏蔽的包<a hidden class="anchor" aria-hidden="true" href="#被屏蔽的包">#</a></h4>
<p>Portage关于被阻挡的包的警告</p>
<pre tabindex="0"><code>!!! all ebuilds that could satisfy &quot;bootsplash&quot; have been masked.
</code></pre><p>PPortage关于被屏蔽的包的警告——原因</p>
<pre tabindex="0"><code>!!! possible candidates are:
  
- gnome-base/gnome-2.8.0_pre1 (masked by: ~x86 keyword)
- lm-sensors/lm-sensors-2.8.7 (masked by: -sparc keyword)
- sys-libs/glibc-2.3.4.20040808 (masked by: -* keyword)
- dev-util/cvsd-1.0.2 (masked by: missing keyword)
- games-fps/unreal-tournament-451 (masked by: package.mask)
- sys-libs/glibc-2.3.2-r11 (masked by: profile)
- net-im/skype-2.1.0.81 (masked by: skype-eula license(s))
</code></pre><p>当您想安装一个对于您系统不可用的软件包。您会收到类似这样的屏蔽错误提示。您应该试着安装那些对于您系统可用的程序或者等待那些不可用的包被置为可用的。通常一个软件包被屏蔽的原因在于：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Reason for mask</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">~arch keyword</td>
<td style="text-align:left">这个软件没有经过充分的测试，不能进入稳定分支，请等待一段时间后在尝试使用它。</td>
</tr>
<tr>
<td style="text-align:left">-arch keyword or -* keyword</td>
<td style="text-align:left">这个软件不能工作在您机器的体系结构中。如果您确信它能工作那么请到我们的bugzilla网站提交一个bug报告。</td>
</tr>
<tr>
<td style="text-align:left">missing keyword</td>
<td style="text-align:left">这个软件还没有在您机器的体系结构中进行过测试。您可以咨询相应体系结构移植小组是否能对它进行测试，或者您自己为他们进行这样的测试并将您得到的结论提交到我们的bugzilla网站。</td>
</tr>
<tr>
<td style="text-align:left">package.mask</td>
<td style="text-align:left">这个软件被认为是损坏的，不稳定的或者有更严重的问题，它被故意标识为“不应使用”。</td>
</tr>
<tr>
<td style="text-align:left">profile</td>
<td style="text-align:left">这个软件不适用于您的profile。安装这样的应用软件可能会破坏您的系统，或者只是不能与您使用的profile相兼容。</td>
</tr>
<tr>
<td style="text-align:left">license</td>
<td style="text-align:left">这个包的许可证的ACCEPT_LICENSE值不正确。 通过设置许可证或正确的许可证组来允许其许可证:/etc/portage/make.conf或 /etc/portage/package.license</td>
</tr>
</tbody>
</table>
<h4 id="use必要的更改">USE必要的更改<a hidden class="anchor" aria-hidden="true" href="#use必要的更改">#</a></h4>
<p>Portage 提示 USE 标志需要进行更改</p>
<pre tabindex="0"><code>The following USE changes are necessary to proceed:
#required by app-text/happypackage-2.0, required by happypackage (argument)
&gt;=app-text/feelings-1.0.0 test
</code></pre><p>如果未使用<code>--autounmask</code>参数，则错误消息也可能显示如下：</p>
<pre tabindex="0"><code>emerge: there are no ebuilds built with USE flags to satisfy &quot;app-text/feelings[test]&quot;.
!!! One of the following packages is required to complete your request:
- app-text/feelings-1.0.0 (Change USE: +test)
(dependency required by &quot;app-text/happypackage-2.0&quot; [ebuild])
(dependency required by &quot;happypackage&quot; [argument])
</code></pre><p>当请求安装包时，发生这种警告或错误，这不仅取决于另一个包，而且还要求该包使用特定的USE标志（或一组USE标志）构建。 在给定的示例中，包应用文本/感觉需要使用 USE=&ldquo;test&quot;构建，但此系统上未设置此USE标志。</p>
<p>要解决这个问题， 到/etc/portage/make.conf编辑里面的USE标志, 或者去/etc/portage/package.use设置一个特殊的包.</p>
<h4 id="缺失依赖">缺失依赖<a hidden class="anchor" aria-hidden="true" href="#缺失依赖">#</a></h4>
<p>Portage提示依赖性不满足</p>
<pre tabindex="0"><code>emerge: there are no ebuilds to satisfy &quot;&gt;=sys-devel/gcc-3.4.2-r4&quot;.
  
!!! Problem with ebuild sys-devel/gcc-3.4.2-r2
!!! Possibly a DEPEND/*DEPEND problem.
</code></pre><p>这表示您正尝试安装的应用程序依赖于您的系统不可用的另外一些软件包。请到bugzilla查看是否有此问题的记录，如果没有查找到相关信息的话请提交一个报告。除非您的系统混用了不同分支，否则这类问题不应该发生，若发生了那就是一个bug。</p>
<h4 id="意指不明的软件包">意指不明的软件包<a hidden class="anchor" aria-hidden="true" href="#意指不明的软件包">#</a></h4>
<p>Portage对于意指不明的Ebuild名称的警告</p>
<pre tabindex="0"><code>[ Results for search key : listen ]
[ Applications found : 2 ]
  
*  dev-tinyos/listen [ Masked ]
      Latest version available: 1.1.15
      Latest version installed: [ Not Installed ]
      Size of files: 10,032 kB
      Homepage:      http://www.tinyos.net/
      Description:   Raw listen for TinyOS
      License:       BSD
  
*  media-sound/listen [ Masked ]
      Latest version available: 0.6.3
      Latest version installed: [ Not Installed ]
      Size of files: 859 kB
      Homepage:      http://www.listen-project.org
      Description:   A Music player and management for GNOME
      License:       GPL-2
  
!!! The short ebuild name &quot;listen&quot; is ambiguous. Please specify
!!! one of the above fully-qualified ebuild names instead.
</code></pre><p>您要安装的应用程序对应有多个同名的包。您需要同时指定类别的名称。Portage会列出所有可供选择的名称匹配的包。</p>
<h4 id="循环依赖">循环依赖<a hidden class="anchor" aria-hidden="true" href="#循环依赖">#</a></h4>
<p>Portage关于循环依赖问题的警告</p>
<pre tabindex="0"><code>!!! Error: circular dependencies: 
  
ebuild / net-print/cups-1.1.15-r2 depends on ebuild / app-text/ghostscript-7.05.3-r1
ebuild / app-text/ghostscript-7.05.3-r1 depends on ebuild / net-print/cups-1.1.15-r2
</code></pre><p>两个（或多个）您想安装的包由于循环依赖而不能安装。这很可能源于Portage树中的bug。请等一段时间后重新sync再尝试安装。您也可以去 <a href="https://bugs.gentoo.org/">Bugzilla</a> 看看是否已经有此问题的报告，或者提交一个关于它的报告。</p>
<p>当然，最后它也会有类似如下提示的解决方案</p>
<pre tabindex="0"><code>It might be possible to break this cycle
by applying the following change:
</code></pre><h4 id="下载失败">下载失败<a hidden class="anchor" aria-hidden="true" href="#下载失败">#</a></h4>
<p>Portage关于下载失败的警告</p>
<pre tabindex="0"><code>!!! Fetch failed for sys-libs/ncurses-5.4-r5, continuing...
(...)
!!! Some fetch errors were encountered.  Please see above for details.
</code></pre><p>当Portage下载指定软件的源代码失败时，它会尝试继续安装其它（若适用）的应用程序。源代码下载失败可能源于镜像服务器没有正确同步，也可能因为ebuild文件给出了错误的下载地址。那些保存源代码的服务器也可能因为某些原因宕机。</p>
<p>一小时后重试一次，看看问题是否仍然存在。</p>
<h4 id="系统profile保护">系统Profile保护<a hidden class="anchor" aria-hidden="true" href="#系统profile保护">#</a></h4>
<p>Portage关于profile中保护的包的警告</p>
<pre tabindex="0"><code>!!! Trying to unmerge package(s) in system profile. 'sys-apps/portage'
!!! This could be damaging to your system.
</code></pre><p>您要求移除系统核心软件包中的一个。它是您的profile中所列出的必需的软件，因此不能从系统中移除。</p>
<h4 id="digest验证失败">Digest验证失败<a hidden class="anchor" aria-hidden="true" href="#digest验证失败">#</a></h4>
<p>Digest验证失败</p>
<pre tabindex="0"><code>&gt;&gt;&gt; checking ebuild checksums
!!! Digest verification failed:
</code></pre><p>这是Portage树中出现了错误的迹象，通常是由于将ebuild提交到Gentoo ebuild存储库时出错造成的。</p>
<p>当digest校验失败的时候，请不要尝试自己去为此软件包重新产生digest。使用<strong>ebuild foo manifest</strong> 并不能修复问题，反而很可能会使问题变得更糟。</p>
<p>取而代之的应该是等待一至两个小时以便让软件仓库安定下来。一般来说错误很有可能马上就会被注意到，但是修复程序可能需要一点时间来逐步扫描rsync镜像。当您等待的时候，到<a href="https://bugs.gentoo.org/">Bugzilla</a>或者<a href="ircs://irc.libera.chat/#gentoo">#gentoo</a> (<a href="https://web.libera.chat/#gentoo">webchat</a>) (IRC)看看是否已经有人报告了这个问题。如果没有，那就为那个损坏的ebuild提交一个bug报告吧。</p>
<p>修复错误后，重新同步Gentoo ebuild仓库以获取修复的digest。</p>
<p><strong>重要</strong>：值得注意的是：不要每天多次同步<a href="https://gitweb.gentoo.org/repo/gentoo.git/">Gentoo ebuild repository</a> 仓库。正如（当您运行<strong>emerge &ndash;sync</strong>时）Gentoo官方网络礼节策略所指出的那样，那些短时间内过于频繁进行多次sync的用户将会被更新服务器软封禁一段时间，一再不遵守这一政策的滥用者可能会被硬封禁。除非绝对必要，否则通常最好等待24小时再进行同步，因为这样您不会使Gentoo的rsync镜像服务器过载而影响其他用户的正常使用。</p>
<h3 id="其他工具">其他工具<a hidden class="anchor" aria-hidden="true" href="#其他工具">#</a></h3>
<p>单纯 Portage 自带的工具对于日常管理其会显得有些吃力，这里推荐几个比较有用的软件用于辅助管理 Portage。</p>
<h4 id="app-portageeixhttpspackagesgentooorgpackagesapp-portageeix"><a href="https://packages.gentoo.org/packages/app-portage/eix">app-portage/eix</a><a hidden class="anchor" aria-hidden="true" href="#app-portageeixhttpspackagesgentooorgpackagesapp-portageeix">#</a></h4>
<p>这个可以说是非常有用的软件，主要用于查询 Portage 数据库，其优势在于更快的速度、更人性化的显示格式以及更方便的查询模式。</p>
<p>使用前需执行 <code>eix-update</code> 以更新 eix 数据库，安装它之后，可以使用 <code>eix-sync</code> 命令来更新 Portage 数据库，更新完毕后会自动更新 eix 数据库，并显示更新前后的软件包对比情况。</p>
<p>使用 eix 查询所需软件，最基本的命令为</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eix &lt;包名匹配字符串&gt;</span>
</code></pre></div><p>也可只查询已安装的包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eix -I &lt;包名匹配字符串&gt;</span>
</code></pre></div><p>也可查询属于一个特定分类下的所有包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eix -C &lt;类名&gt;</span>
</code></pre></div><p>等等，执行 <code>man eix</code> 查看更多用法。</p>
<h4 id="app-portagegentoolkithttpspackagesgentooorgpackagesapp-portagegentoolkit"><a href="https://packages.gentoo.org/packages/app-portage/gentoolkit">app-portage/gentoolkit</a><a hidden class="anchor" aria-hidden="true" href="#app-portagegentoolkithttpspackagesgentooorgpackagesapp-portagegentoolkit">#</a></h4>
<p>包含了 Gentoo 的一些管理脚本，常用的命令有用于查询依赖关系，文件归属，软件包内容的 <code>equery</code> ，以及用于清理 distfile 的 <code>eclean-dist</code> 。比如</p>
<p>可以查询依赖 vim-core 的软件包（仅根据 ebuild 文件内容查询）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># equery d vim-core</span>
</code></pre></div><p>可以查询 vim 下属的依赖关系图</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># equery g vim</span>
</code></pre></div><p>可以查询 vim 安装了哪些文件到系统下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># equery f vim</span>
</code></pre></div><p>可以查询这个文件属于哪个包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># equery b /usr/bin/vim</span>
</code></pre></div><h5 id="ecleanhttpswikigentooorgwikiecleanzh-cn"><a href="https://wiki.gentoo.org/wiki/Eclean/zh-cn">eclean</a><a hidden class="anchor" aria-hidden="true" href="#ecleanhttpswikigentooorgwikiecleanzh-cn">#</a></h5>
<p><strong>eclean</strong> 是一个清理仓库源文件和二进制包的工具。它是 <a href="https://packages.gentoo.org/packages/app-portage/gentoolkit">app-portage/gentoolkit</a> 包的一部分，并由 <a href="https://wiki.gentoo.org/wiki/Project:Portage-Tools">Portage-Tools</a> 项目维护。</p>
<p><strong>安装</strong></p>
<p>安装 <strong>eclean</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask app-portage/gentoolkit</span>
</code></pre></div><p><strong>附注</strong>：关于 <a href="https://packages.gentoo.org/packages/app-portage/gentoolkit">app-portage/gentoolkit</a> 包中其他工具的信息请参看 <a href="https://wiki.gentoo.org/wiki/Gentoolkit">Gentoolkit article</a>。</p>
<p><strong>使用</strong></p>
<p>默认情况下，源文件存储在 /var/db/repos/gentoo/distfiles 目录下， 二进制包存储在 /var/db/repos/gentoo/packages 目录下；可以通过修改 /etc/portage/make.conf 中的 <a href="https://wiki.gentoo.org/wiki/DISTDIR">DISTDIR</a> 和 PKGDIR 变量更改对应的存储位置。如果不定期清理，这两个目录可能会悄然无声地变得非常巨大；这就是创建<strong>eclean</strong>的原因。</p>
<p>使用 <strong>eclean &ndash;help</strong> 来查看全部的命令简介、参数列表和使用介绍：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eclean --help</span>
</code></pre></div><p>通过 <code>distfiles</code> 参数清理源文件存放目录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eclean distfiles</span>
</code></pre></div><p>或者使用更简短的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eclean-dist</span>
</code></pre></div><p>使用下面的命令清理二进制包：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eclean packages</span>
</code></pre></div><p>或者使用更简短的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eclean-pkg</span>
</code></pre></div><p><strong>选项</strong></p>
<p>默认情况下，当前存储库中的任何ebuild相对应的源文件和二进制包都不会被删除。这样，只要程序包仍在当前存储库树中，系统管理员就可以轻松地降级程序包或安装以前删除的程序包。</p>
<p>举个例子，比如包 foo-1.0 和 foo-1.1 都在存储库中。在从 foo-1.0 升级到 foo-1.1 之后，运行 <strong>elcean distfiles</strong>，两个版本的源文件依然被保留，因此如果 foo-1.1 出现问题，用户可以很方便的重新安装 foo-1.0，而不必重新下载。</p>
<p>另一个可能的情况是安装之前删除的包。假设系统安装了 foo 包（任一版本）。在（不经意地）删除了这个包并运行了 <strong>eclean disfiles</strong> 之后，foo 的源文件依然被保留，可以重新安装而无需再次下载。</p>
<p>对二进制包同样的例子也一样适用。</p>
<p>为节省更多磁盘空间，请添加<code>--deep</code>选项：这将删除与某些当前安装的软件包（版本无关紧要）不对应的每个源文件或二进制软件包。请注意，这种方式当用户需要降级安装某个包或者重新安装之前删除的包的时候都必须重新下载。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eclean --deep distfiles</span>
<span style="color:#75715e"># eclean --deep packages</span>
</code></pre></div><p>一个替代方案是，同时使用 <code>--deep</code> 和 <code>--package-names</code> 选项：对于某些非当前安装的包（不管版本号是什么）的每个源文件或者二进制包都会被删除。这种方式当用户需重新安装之前删除的包的时候都必须重新下载，但是要降级安装某个包则不需要。</p>
<p>更多细节请参阅 eclean(1) man page：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># man 1 eclean</span>
</code></pre></div><h4 id="app-portageportage-utilshttpspackagesgentooorgpackagesapp-portageportage-utils"><a href="https://packages.gentoo.org/packages/app-portage/portage-utils">app-portage/portage-utils</a><a hidden class="anchor" aria-hidden="true" href="#app-portageportage-utilshttpspackagesgentooorgpackagesapp-portageportage-utils">#</a></h4>
<p>包含了 Portage 的帮助工具，与上面 gentoolkit 的功能有重合，他们具有互补性，常用的命令有用于分析 emerge 日志的 <code>qlop</code> 。它是用 C 写的，速度更快。</p>
<h4 id="app-portagepflhttpspackagesgentooorgpackagesapp-portagepfl"><a href="https://packages.gentoo.org/packages/app-portage/pfl">app-portage/pfl</a><a hidden class="anchor" aria-hidden="true" href="#app-portagepflhttpspackagesgentooorgpackagesapp-portagepfl">#</a></h4>
<p>Portage File List，可用于在线查询文件所归属的包，命令为 <code>e-file &lt;文件名&gt;</code> 。</p>
<h4 id="多版本管理">多版本管理<a hidden class="anchor" aria-hidden="true" href="#多版本管理">#</a></h4>
<p>Gentoo Linux 支持同一软件多版本同时存在于系统上，这归功于 Portage 系统的 slotting 机制。当你执行命令 <code>eix dev-lang/python</code> 会发现它有好多行可用版本，最前圆括号内的内容即对应的 slot 名，不同 slot 下的版本可同时安装到系统上（ slot 名内 <code>/</code> 符号后的内容表示其 sub-slot，同 slot 但不同 sub-slot 的版本无法共存）。比如，<code>sys-devel/gcc</code> , <code>sys-devel/clang</code> , <code>dev-lang/lua</code> 等等都支持多版本共存。</p>
<p>对于一些多版本共存的工具， Gentoo Linux 准备了对应的 <code>eselect</code> 命令以方便用户选择使用。其会在对应的 <code>$PATH</code> 目录下创建一个指向当前选定版本命令的软链接。比如，列出当前所有已经安装的 lua 版本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect lua list</span>
</code></pre></div><p>设定了系统下用户交互环境的默认 lua 版本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect lua set {序号}</span>
</code></pre></div><p>其它的类似，执行 <code>eselect help</code> 以查看当前所有支持的模块。不是所有的多版本共存的包都会有 eselect 模块，它们并不存在强制的依赖关系。执行 <code>eix -I2</code> 可以显示当前系统下安装的可多版本共存的包。</p>
<h3 id="为-portage-包管理器设置代理httpsbitbilinetset-proxy-for-gentoo-portagehtml"><a href="https://bitbili.net/set-proxy-for-gentoo-portage.html">为 Portage 包管理器设置代理</a><a hidden class="anchor" aria-hidden="true" href="#为-portage-包管理器设置代理httpsbitbilinetset-proxy-for-gentoo-portagehtml">#</a></h3>
<p>开门见山，本文介绍在 Gentoo Linux 下如何正确地对其包管理器 Portage 设置代理，即日常使用的 emerge 命令。这里介绍软件下载安装时需要的配置；对于同步 Portage 树，则是部分适用。</p>
<h4 id="gentoo-的默认设置">Gentoo 的默认设置<a hidden class="anchor" aria-hidden="true" href="#gentoo-的默认设置">#</a></h4>
<ul>
<li>代理： 无</li>
<li>工具： 默认使用 <code>wget</code> 作为下载工具，但对于绝大部分的 live 包，会有针对的 eclass 使用对应的版本控制工具从远程仓库抓取，这里仅以 <code>git</code> 为例。</li>
</ul>
<p>live 包：即版本号带 <code>9999*</code> 的这些包；用于匹配 live ebuild 文件名的正则表达式为 <code>9999*(-r[0-9]{1,3})?.ebuild$</code> ，可还是有一些包使用了这种版本命名规则却并非真正的 live 包，比如 <code>openjfx/openjfx-8.999.ebuild</code> ；这里不会通过版本号来判断是否需要配置 git 参数，所以并不影响，仅作介绍。</p>
<h4 id="持久性地修改代理">持久性地修改代理<a hidden class="anchor" aria-hidden="true" href="#持久性地修改代理">#</a></h4>
<h5 id="通用配置">通用配置<a hidden class="anchor" aria-hidden="true" href="#通用配置">#</a></h5>
<p><code>$ man make.conf</code> 可以看到里面有说明如何配置代理，但是过于简要，这边详细说明。</p>
<p>对于一般情况，在 <code>/etc/portage/make.conf</code> 文件下配置如下三个变量，就完全足够：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">http_proxy<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[protocol://][user[:password]@]proxyhost[:port]&#34;</span>
https_proxy<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[protocol://][user[:password]@]proxyhost[:port]&#34;</span>
ftp_proxy<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[protocol://][user[:password]@]proxyhost[:port]&#34;</span>
</code></pre></div><p>这些变量会在 emerge 命令运行时，传递给预配置的 <code>FETCHCOMMAND</code> 即 <code>wget</code> 命令。但，该命令有一个问题是不支持 socks 协议；所以，对于不同的协议需要有不同的代理服务，这样子很麻烦。</p>
<p>修改以支持 socks 协议有一个应变的方法，即修改默认的获取命令为 <code>curl</code> ，同样是在 <code>/etc/portage/make.conf</code> 文件下配置变量，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">FETCHCOMMAND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;curl --retry 3 --connect-timeout 60 --ftp-pasv -Lfo \&#34;\${DISTDIR}/\${FILE}\&#34; \&#34;\${URI}\&#34;&#34;</span>
RESUMECOMMAND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;curl -C - --retry 3 --connect-timeout 60 --ftp-pasv -Lfo \&#34;\${DISTDIR}/\${FILE}\&#34; \&#34;\${URI}\&#34;&#34;</span>
</code></pre></div><p>其中 <code>RESUMECOMMAND</code> 是用于恢复意外中断的下载命令，保存后即完成修改，此时，就可以给不同协议配置同样的 socks 类协议的代理服务，均可生效。如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">https_proxy<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;socks5h://127.0.0.1:1080&#34;</span>
</code></pre></div><h5 id="单独配置-git-抓取">单独配置 git 抓取<a hidden class="anchor" aria-hidden="true" href="#单独配置-git-抓取">#</a></h5>
<p>对于 live 包，它们目前大多数直接使用 <code>git</code> 命令从远程仓库抓取。其它版本控制工具（目前支持的大致有 bzr, cvs, darcs, mercurial, subversion）同理，请自行修改后套用；当然也有直接使用 <code>wget|curl</code> 下载 live 包的情况，那么这种情况如上「一」述。</p>
<p><code>git</code> 命令支持 socks 协议，并且除了能吃上述配置的环境变量外，</p>
<p>配置 <code>https_proxy</code> 时也配好 <code>http_proxy</code> ，否则可能出现 SSL_ERROR_SYSCALL 错误。</p>
<p>还能独立于其它包单独配置 git 自身的代理，方法有两种：</p>
<ol>
<li>
<p>git 能配置针对整个 Linux 系统的参数，运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ git config --system http.proxy <span style="color:#e6db74">&#39;[protocol://][user[:password]@]proxyhost[:port]&#39;</span>
</code></pre></div><p>此命令会将配置写入到 <code>/etc/gitconfig</code> 文件内，并生效于系统级别，会被用户/项目级别的配置覆盖。</p>
</li>
<li>
<p>通过 Portage 的全局 <a href="https://wiki.gentoo.org/wiki//etc/portage/bashrc">bashrc</a> 文件 <code>/etc/portage/bashrc</code> 来配置临时的 git 代理</p>
<p>这种方式会对系统配置造成最少的干扰，只略微繁琐一点，需要将下述脚本代码写入上述的 bashrc 文件内：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">${</span>EBUILD_PHASE<span style="color:#e6db74">}</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;unpack&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#e6db74">${</span>INHERITED<span style="color:#e6db74">}</span> <span style="color:#f92672">=</span>~ git<span style="color:#ae81ff">\-</span>r3 <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
  git config --global http.proxy <span style="color:#e6db74">&#39;[protocol://][user[:password]@]proxyhost[:port]&#39;</span>
<span style="color:#66d9ef">fi</span>
</code></pre></div><p>这个 bashrc 只被 Portage 引用，会在进入每一个安装阶段时被导入。目前，Portage 下抓取 git 项目是通过 <code>git-r3.eclass</code> 实现，该 eclass 定义了 git 项目是在 src_unpack 阶段被更新，所以这里只需要在此阶段时设置即可。且，因为该目录不是被抓取包的 git 目录，所以只能设置用户级别的配置以生效，配置文件会被存放于 Portage 安装过程中沙盒的家目录下，即对应 <em>安装软件临时目录</em> （这个目录是 Portage 在编译/安装软件过程中临时建立的，会在成功安装软件后被删除，所以不用担心会有文件残留。具体位置是可以自定义的，详情看 make.conf(5) 手册下 PORTAGE_TMPDIR 条目）下的 <code>homedir/</code> 目录。</p>
</li>
</ol>
<h4 id="临时添加代理">临时添加代理<a hidden class="anchor" aria-hidden="true" href="#临时添加代理">#</a></h4>
<p>对于需要临时添加代理以使用的情况，目前我知道两种方式：</p>
<h5 id="推荐proxychains">推荐：ProxyChains<a hidden class="anchor" aria-hidden="true" href="#推荐proxychains">#</a></h5>
<p><a href="https://github.com/haad/proxychains">ProxyChains</a> is a UNIX program, that hooks network-related libc functions in dynamically linked programs via a preloaded DLL and redirects the connections through SOCKS4a/5 or HTTP proxies.</p>
<p>使用 <a href="https://packages.gentoo.org/packages/net-misc/proxychains"><strong>net-misc/proxychains</strong></a> 软件适用所有下载方式。</p>
<p>配置文件可以放在 <code>~/.proxychains/proxychains.conf</code>，也可以放在 <code>/etc/proxychains.conf</code>，但是放在 etc 下更好，因为有时候要通过sudo安装软件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge net-misc/proxychains</span>
<span style="color:#75715e"># vi /etc/proxychains.conf</span>
...
socks5 127.0.0.1 <span style="color:#ae81ff">7891</span>
</code></pre></div><p>配置好代理列表后，通过如下命令使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># proxychains -q emerge [&lt;args&gt;...]</span>
</code></pre></div><h5 id="临时指定环境变量">临时指定环境变量<a hidden class="anchor" aria-hidden="true" href="#临时指定环境变量">#</a></h5>
<p>{ftp,http,https}_proxy 的方式，适用性同持久性配置。</p>
<p>即如下命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># export http_proxy=&#34;...&#34; https_...</span>
<span style="color:#75715e"># emerge [&lt;args&gt;...]</span>
</code></pre></div><p>或</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># http_proxy=&#34;...&#34; https_... emerge [&lt;args&gt;...]</span>
</code></pre></div><h3 id="projectportagesynchttpswikigentooorgwikiprojectportagesync"><a href="https://wiki.gentoo.org/wiki/Project:Portage/Sync">Project:Portage/Sync</a><a hidden class="anchor" aria-hidden="true" href="#projectportagesynchttpswikigentooorgwikiprojectportagesync">#</a></h3>
<p>The new plug-in sync system is the next step in that migration. Using PORTDIR and PORTDIR_OVERLAY in make.conf could only list <em>where</em> the repository was location. Users could not specify other important attributes about that repository. The repos.conf style configuration allows for settings to be added on a per sync-type basis. Along with this new expandability and the plug-in sync system, it will be much easier to change to new repository syncing methods.</p>
<h4 id="general-help">General help<a hidden class="anchor" aria-hidden="true" href="#general-help">#</a></h4>
<p><strong>Note</strong>: While Portage can handle repos.conf as either a file or a directory of files. The preferred method is to be used as a <em><strong>directory</strong></em>. Other tools like <strong>layman</strong> and <strong>mirrorselect</strong> require and expect it to be a directory. Layman creates and manages its own layman.conf file to register installed overlays with Portage. <strong>mirrorselect</strong> looks for repos.conf/gentoo.conf file in order to modify the <code>sync-uri</code> parameter for the gentoo repository.</p>
<h5 id="migration">Migration<a hidden class="anchor" aria-hidden="true" href="#migration">#</a></h5>
<p><strong>Portage configuration</strong></p>
<p>If the /etc/portage/repos.conf directory does not exist:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir /etc/portage/repos.conf</span>
<span style="color:#75715e"># cp /usr/share/portage/config/repos.conf /etc/portage/repos.conf/gentoo.conf</span>
</code></pre></div><p>Then edit the file for your installation and desired settings, continue as needed with the remaining migration instructions. Edit all repos.conf/*.conf files, add the auto-sync option to each defined repository.</p>
<p>For sync-type, edit it to one of the installed supported types.</p>
<p>Current supported sync types include:</p>
<ol>
<li><code>rsync</code></li>
<li><code>git</code></li>
<li><code>svn</code></li>
<li><code>webrsync</code> or <code>websync</code> (equivalent to running <strong>emerge-webrsync</strong> separately).</li>
<li><code>cvs</code></li>
<li><code>laymansync</code> (if installed by <a href="https://wiki.gentoo.org/wiki/Layman">Layman</a>)</li>
</ol>
<p><a href="https://forums.gentoo.org/viewtopic-t-1072466-start-0.html">Example</a> local overlay sync-able from a git backup:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/repos.conf/gentoo.conf</span>
<span style="color:#f92672">[</span>DEFAULT<span style="color:#f92672">]</span>
main-repo <span style="color:#f92672">=</span> gentoo

<span style="color:#f92672">[</span>gentoo<span style="color:#f92672">]</span>
location <span style="color:#f92672">=</span> /var/db/repos/gentoo
sync-type <span style="color:#f92672">=</span> git
sync-uri <span style="color:#f92672">=</span> https://github.com/gentoo-mirror/gentoo.git
auto-sync <span style="color:#f92672">=</span> yes
priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
</code></pre></div><p>The above overlay can be synced with</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emaint sync -r gentoo</span>
</code></pre></div><h5 id="operation">Operation<a hidden class="anchor" aria-hidden="true" href="#operation">#</a></h5>
<p>Primary control of all sync operations has been moved from <strong>emerge</strong> to <strong>emaint</strong>. <strong>emerge &ndash;sync</strong> now runs the emaint sync module with the <code>--auto</code> option. This <code>--auto</code> option performs a sync on only those repositories with the auto-sync setting set to <code>yes</code> or <code>true</code>. If the auto-sync option is <em>not</em> set to <code>yes</code> or is absent, then <strong>emerge &ndash;sync</strong> may not sync any repositories.</p>
<p><strong>Note</strong>: As a result of the default auto-sync = True/Yes setting, commands like <strong>eix-sync</strong>, <strong>esync -l</strong>, <strong>emerge &ndash;sync &amp;&amp; layman -S</strong> will cause many repositories to be synced multiple times in a row. Please adjust configuration files or scripts as necessary for the new operation.</p>
<p><strong>Warning</strong>: Due to the above default. For any repositories (repos) that you EXPLICITLY do <em><strong>not</strong></em> want to be synced. You MUST set <code>auto-sync = no</code></p>
<h5 id="examples">Examples<a hidden class="anchor" aria-hidden="true" href="#examples">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emaint sync -a</span>
</code></pre></div><p>Equivalent to <strong>emerge &ndash;sync</strong>. Sync all repositories where <code>auto-sync = true</code> is set.</p>
<p><strong>Note</strong>: Due to the default <code>auto-sync = true</code> setting, this command will sync all repositories that do not have <code>auto-sync = no</code> explicitly set.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emaint sync -r foo</span>
</code></pre></div><p>Sync the foo repo (ignores auto-sync setting):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emaint sync --allrepos</span>
</code></pre></div><p>Sync all repositories with a valid sync-type and sync-url defined. (ignores auto-sync setting)</p>
<h2 id="use标记httpswikigentooorgwikihandbookamd64workinguse"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/USE">USE标记</a><a hidden class="anchor" aria-hidden="true" href="#use标记httpswikigentooorgwikihandbookamd64workinguse">#</a></h2>
<h3 id="什么是use标志">什么是USE标志<a hidden class="anchor" aria-hidden="true" href="#什么是use标志">#</a></h3>
<h4 id="use标志的指导思想">USE标志的指导思想<a hidden class="anchor" aria-hidden="true" href="#use标志的指导思想">#</a></h4>
<p>你在安装gentoo（或者是其他发行版，甚至于其他特定操作系统）的时候，你要依据你工作的环境做出选择。服务器跟工作站的组织结构不同，游戏机跟3D工作站也会不一样。</p>
<p>不单只是选择你想要安装的包时如此，选择某一个包需要的特性时同样如此。如果你不需要OpenGL，为什么还要花费时间安装OpenGL并在其他包中加入对OpenGL的支持？如果你不用KDE，而且软件包没有KDE也能完美运行，为什么还要在编译这些包的时候加入KDE支持？</p>
<p>为了帮用户判断什么需要安装或激活，什么不需要；我们希望用户能用简单的方式设定他们自己的环境。这能促使用户判断他真正需要的东西，并让Portage做出有用的决定的过程变得简单。</p>
<h4 id="use标志的设定">USE标志的设定<a hidden class="anchor" aria-hidden="true" href="#use标志的设定">#</a></h4>
<p>我们来具体看看USE标志。每一个标志都是代表对某特定概念的支持和依赖关系信息的关键字。如果你设定了某个USE标志，Portage会明白他们需要支持所选关键字。当然这同时也改变了这个包的依赖关系信息。</p>
<p>让我们看一个特殊示例：关键字 <code>kde</code> 。如果你的 USE 变量里面没有这个关键字，所有具有可选KDE支持的包在编译时都 <em>不会</em> 编译KDE支持。所有具有可选KDE依赖关系的包在安装时都 <em>不会</em> （做为一个依赖关系而）安装KDE库。如果你设定了kde关键字，这些包在安装时都 <em>会</em> 编译KDE支持，而且KDE库也 <em>会</em> （作为一个依赖关系而）被安装。</p>
<p>通过正确设定关键字，你会得到一个根据你的需要而定制的系统。</p>
<h3 id="使用use标志">使用USE标志<a hidden class="anchor" aria-hidden="true" href="#使用use标志">#</a></h3>
<h4 id="声明永久use标志">声明永久USE标志<a hidden class="anchor" aria-hidden="true" href="#声明永久use标志">#</a></h4>
<p>就像前面提到的，所有USE标志都声明在 USE 变量里面。为了让用户能方便地查找和选择USE标志，我们提供了一份默认的USE设定。这些设定是我们觉得Gentoo用户通常都要用到的USE标志的集合。这个默认设置在make.defaults 文件──你的profile声明。</p>
<p>你的系统使用的profile是符号链接 <code>/etc/portage/make.profile</code> 所指向的目录。每个profile叠加于某个更大的profile之上，最终的结果是这些profile的并集。初始profile是base profile( <code>/var/db/repos/gentoo/profiles/base</code>)。</p>
<p>要查看当前正在使用的USE标志（全部），请使用 <strong>emerge &ndash;info</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --info | grep ^USE</span>
USE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;a52 aac acpi alsa branding cairo cdr dbus dts ...&#34;</span>
</code></pre></div><p>就像你看到的那样，这个变量已经包括了非常多的关键字。不要通过修改make.defaults 文件里的 USE 变量来满足你的需要：在升级Portage的时候，这个文件将会被覆盖。</p>
<p>要改变这个默认设置，你需要在 USE 变量里添加或移去关键字。这是通过在<code>/etc/portage/make.conf</code>里定义USE全局变量来实现的。在这个变量里，添加你需要的额外的USE标志，或者移去你不需要的USE标志。后者可通过在标记前面加个负号 (<code>-</code>).前缀来实现。</p>
<p>例如，要移除对 KDE 和 QT 的支持，并添加对 LDAP 的支持，可以在<code>/etc/portage/make.conf</code>里声明USE如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">USE</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-kde -qt4 -qt5 ldap&#34;</span>
</code></pre></div><h4 id="为单个包声明use标志">为单个包声明USE标志<a hidden class="anchor" aria-hidden="true" href="#为单个包声明use标志">#</a></h4>
<p>如果你不是想为整个系统声明USE标志，而是想要为一个（或者几个）程序声明USE标志，你需要编辑<code>/etc/portage/package.use</code>文件。package.use 通常是一个文件，不过它也可以是一个充满子文件的目录；请看下面的提示和 <strong>man 5 portage</strong> 以获得更多如何使用这个约定的信息。下面的例子假设 package.use 是一个文件。</p>
<p>比如说，如果你不想全局的启用 Blu-ray 支持，你只想把它应用到 VLC 包，你可以这样做：</p>
<pre tabindex="0"><code>&lt;类&gt;/&lt;名&gt; &lt;USE&gt;
media-video/vlc bluray
</code></pre><p><strong>Tip</strong>：如果 package.use 是一个已经存在的“目录”（而不是一个单文件），只需简单地在 package.use/ 目录下创建文件，就可以修改软件包的本地USE标记。虽然任何文件命名规范都行，但是更明智的做法是统一命名方案。</p>
<p>有一种规范是简单地使用包名作为子文件的标题。比如说，可以用如下方式为 <a href="https://packages.gentoo.org/packages/media-video/vlc">media-video/vlc</a> 软件包在本地设置 <code>bluray</code> USE 标记。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#34;media-video/vlc bluray&#34; &gt;&gt; /etc/portage/package.use/vlc</span>
</code></pre></div><p>你当然也可以直接为某一个程序禁用USE标志。比如说，禁用PHP的bzip2支持（但通过make.conf中的USE标志为其他包提供支持）：</p>
<pre tabindex="0"><code>dev-lang/php -bzip2
</code></pre><p><code>-*</code> 代表去除该匹配的包的所有已经添加的以及默认的 USE</p>
<pre tabindex="0"><code>&gt;=kde-apps/kde-apps-meta-21.04.3 -* admin
</code></pre><p>Portage 有一个 USE Expand 功能，即把指定变量的值扩展成 USE，这些指定的变量被设置在 Portage 数据库路径下的 <code>profiles/base/make.defaults</code> 文件的 USE_EXPAND 变量中。这个功能很实用，简化了配置值，还能进行归类，更便于管理。上文有一个 <a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E6%98%BE%E5%8D%A1%E7%9A%84%E9%85%8D%E7%BD%AE">显卡的配置</a> 其实就是一个 USE_EXPAND 值。其它会使用到它的地方不多，但也有，比如配置全局的本地化配置，就可以在 make.conf 文件下配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">L10N<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zh-CN zh-TW zh en-GB-oxendict en&#34;</span>
</code></pre></div><p>这样，那么以后当有包支持上述的本地化配置时，就会自动添加。</p>
<p>其它比如可以对 qemu 这个虚拟机添加额外的模拟平台， 可以往 <code>/etc/portage/package.use/qemu</code> 文件写</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">app-emulation/qemu QEMU_SOFTMMU_TARGETS: aarch x86_64
</code></pre></div><p>以支持 arm64 及 x86_64 平台。等等</p>
<h4 id="声明临时use标志">声明临时USE标志<a hidden class="anchor" aria-hidden="true" href="#声明临时use标志">#</a></h4>
<p>有时，你只想暂时改变一个USE设置。你可以仅仅把USE 变量声明成一个环境变量，而不必两次修改/etc/portage/make.conf 。但是要记住，当你重新emerge或者升级这个程序的时候（不管是单独地还是作为系统升级的一部分），你的修改会被重置。</p>
<p>下面的例子我们将在安装 SeaMonkey 的时候临时从 USE 变量中移去<code>pulseaudio</code> 值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># USE=&#34;-pulseaudio&#34; emerge www-client/seamonkey</span>
</code></pre></div><h4 id="优先级">优先级<a hidden class="anchor" aria-hidden="true" href="#优先级">#</a></h4>
<p>当然，USE设置有一定的优先级。按优先级排序（第一优先级最低）：</p>
<ol>
<li>make.defaults 里面的USE默认设定</li>
<li>用户在/etc/portage/make.conf里面的USE默认设定</li>
<li>用户在 /etc/portage/package.use里面的USE默认设定</li>
<li>用户作为环境变量的USE设定</li>
</ol>
<p>运行 <strong>emerge &ndash;info</strong>可以看到Portage识别的最终的USE设定。它会列出Portage使用的所有相关变量（包括 USE 变量）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --info</span>
</code></pre></div><h4 id="在整个系统上应用新的use标志">在整个系统上应用新的USE标志<a hidden class="anchor" aria-hidden="true" href="#在整个系统上应用新的use标志">#</a></h4>
<p>如果你已经修改了你的USE标志，而且你想用新的USE标志更新你的系统，可以使用<strong>emerge</strong>的 <code>--newuse</code>选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --deep --newuse @world</span>
</code></pre></div><p>然后运行Portage的depclean来移除已经安装到你的&quot;旧&quot;系统里但是在新USE标志中被废除的条件依赖关系。</p>
<p><strong>警告</strong>：运行<strong>emerge &ndash;depclean</strong>是一项危险的操作，必须小心。请反复检查要删除的包的列表里确定没有你仍然需要的包。下面这个例子里，我们添加了 <code>-p</code> 选项──来只列出这些包而不删除他们：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -p --depclean</span>
</code></pre></div><p>depclean完成之后， <strong>emerge</strong>会针对可能是已经删除的软件包提供的共享对象动态链接的应用程序提示重新构建。此操作完成前，为了防止破坏应用程序，Portage 将会保存必要的库。它存储着需要在 <code>preserved-rebuild</code> 设置的重建内容。若要重建必要的包，请运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge @preserved-rebuild</span>
</code></pre></div><p>这些都完成之后，你的系统就已经应用上了新的USE标志的设定。</p>
<h3 id="软件包特有的use标志">软件包特有的USE标志<a hidden class="anchor" aria-hidden="true" href="#软件包特有的use标志">#</a></h3>
<p>查看可用USE标志。</p>
<p>让我们以seamonkey来作例子，看看它接收什么USE标志。我们可以以<code>--pretend</code>和 <code>--verbose</code>为选项执行 <strong>emerge</strong>来查看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --pretend --verbose www-client/seamonkey</span>
These are the packages that would be merged, in order:
 
Calculating dependencies... <span style="color:#66d9ef">done</span>!
<span style="color:#f92672">[</span>ebuild  N     <span style="color:#f92672">]</span> www-client/seamonkey-2.48_beta1::gentoo  USE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;calendar chatzilla crypt dbus gmp-autoupdate ipc jemalloc pulseaudio roaming skia startup-notification -custom-cflags -custom-optimization -debug -gtk3 -jack -minimal (-neon) (-selinux) (-system-cairo) -system-harfbuzz -system-icu -system-jpeg -system-libevent -system-libvpx -system-sqlite {-test} -wifi&#34;</span> L10N<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-ca -cs -de -en-GB -es-AR -es-ES -fi -fr -gl -hu -it -ja -lt -nb -nl -pl -pt-PT -ru -sk -sv -tr -uk -zh-CN -zh-TW&#34;</span> 216,860 KiB
 
Total: <span style="color:#ae81ff">1</span> package <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> new<span style="color:#f92672">)</span>, Size of downloads: 216,860 KiB
</code></pre></div><p><strong>emerge</strong> 并不是做这件事的唯一工具。事实上，我们有一个专门的包信息工具叫<strong>equery</strong>，它属于<a href="https://packages.gentoo.org/packages/app-portage/gentoolkit">app-portage/gentoolkit</a>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask app-portage/gentoolkit</span>
</code></pre></div><p>现在以为参数执行 <strong>equery</strong> 来查看指定包的USE标志。例如：gnumeric包：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># equery --nocolor uses =gnumeric-1.12.31</span>
<span style="color:#f92672">[</span> Legend : U - final flag setting <span style="color:#66d9ef">for</span> installation<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>        : I - package is installed with flag     <span style="color:#f92672">]</span>
<span style="color:#f92672">[</span> Colors : set, unset                             <span style="color:#f92672">]</span>
 * Found these USE flags <span style="color:#66d9ef">for</span> app-office/gnumeric-1.12.31:
 U I
 + + introspection            : Add support <span style="color:#66d9ef">for</span> GObject based introspection
 - - libgda                   : Enable database support through gnome-extra/libgda.
 - - perl                     : Enable perl plugin loader.
 + + python                   : Enable python plugin loader.
 + + python_targets_python2_7 : Build with Python 2.7
</code></pre></div><h3 id="满足-required_use">满足 REQUIRED_USE<a hidden class="anchor" aria-hidden="true" href="#满足-required_use">#</a></h3>
<p>一些 ebuild 需要或禁止 USE 标志的某些组合才能正常工作。 这通过放置在 REQUIRED_USE ，用一组条件来表示。此条件确保所有功能和依赖性都已完成，并且构建将成功并按预期执行。 如果任何一个不符合，emerge 会提醒你，并要求你解决这个问题。</p>
<p>下面是 REQUIRED_USE 的一个例子：</p>
<table>
<thead>
<tr>
<th style="text-align:left">示例</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>REQUIRED_USE=&quot;foo? ( bar )&quot;</code></td>
<td style="text-align:left">如果设定 <code>foo</code>，则必须设定 <code>bar</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>REQUIRED_USE=&quot;foo? ( !bar )&quot;</code></td>
<td style="text-align:left">如果设定 <code>foo</code>，则不得设定 <code>bar</code>。</td>
</tr>
<tr>
<td style="text-align:left">`REQUIRED_USE=&ldquo;foo? (</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>REQUIRED_USE=&quot;^^ ( foo bar baz )&quot;</code></td>
<td style="text-align:left">必须在 <code>foo</code>、<code>bar</code> 或 <code>baz</code> 中设定一个。</td>
</tr>
<tr>
<td style="text-align:left">`REQUIRED_USE=&rdquo;</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>REQUIRED_USE=&quot;?? ( foo bar baz )&quot;</code></td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h2 id="portage功能特性httpswikigentooorgwikihandbookamd64workingfeatures"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/Features">Portage功能特性</a><a hidden class="anchor" aria-hidden="true" href="#portage功能特性httpswikigentooorgwikihandbookamd64workingfeatures">#</a></h2>
<h3 id="portage特性">Portage特性<a hidden class="anchor" aria-hidden="true" href="#portage特性">#</a></h3>
<p>Portage有几个附加的特性，它们能够令您的Gentoo之旅更加愉快。这些特性中的大多数依赖于某些能够提高性能、可靠性、安全性等的软件工具。</p>
<p>为了打开或者关闭某一Portage特性您需要编辑 <code>/etc/portage/make.conf</code>中的 FEATURES变量，这个变量包含不同的特性关键字，用空格分开。在一些情况下您可能还需要额外的安装被这个特性所依赖的工具。</p>
<p>并不是所有Portage所支持的特性都在这里列出。完整的概述，请查阅make.conf手册页：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># man make.conf</span>
</code></pre></div><p>查看 FEATURES 的默认设置，运行<strong>emerge &ndash;info</strong>并且查找FEATURES变量或者用<strong>grep</strong> 显示它：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --info | grep ^FEATURES=</span>
</code></pre></div><h3 id="分布式编译">分布式编译<a hidden class="anchor" aria-hidden="true" href="#分布式编译">#</a></h3>
<h4 id="使用distcc">使用distcc<a hidden class="anchor" aria-hidden="true" href="#使用distcc">#</a></h4>
<p><strong>distcc</strong> 是一个分布式编译程序，可以把编译任务分配给同一网络中的不同机器，这些机器的配置不必完全相同。distcc客户端发送所有必须的信息给所有可利用的distcc服务器（运行distccd的机器）。这样它们每一个都能为客户端编译一部分源码。所获得的效果就是更短的编译时间。</p>
<p>您可以在Gentoo Distcc文档里找到更多的关于<a href="https://wiki.gentoo.org/wiki/Distcc">Distcc</a>的信息（包括如何让它在Gentoo上工作）。</p>
<h4 id="安装-distcc">安装 distcc<a hidden class="anchor" aria-hidden="true" href="#安装-distcc">#</a></h4>
<p>Distcc使用一个图形化监视器来监视您的机器发送出去的编译工作。请把 <code>USE=gnome</code> 或 <code>USE=gtk</code>放进您的USE设置中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># merge --ask sys-devel/distcc</span>
</code></pre></div><h4 id="激活portage的distcc支持">激活Portage的distcc支持<a hidden class="anchor" aria-hidden="true" href="#激活portage的distcc支持">#</a></h4>
<p>将 <code>distcc</code> 添加到<code>/etc/portage/make.conf</code>中的 <code>FEATURES &lt;/ var&gt;</code>变量中。 接下来，编辑MAKEOPTS变量，并增加系统允许的并行构建的数量。 一个已知的方法是填写 <code>-jN</code> 其中<code>N</code> 是运行distccd（包括当前主机）的CPU数量+1（或者核心数+1），但这只是一个建议。</p>
<p>现在运行 <strong>distcc-config</strong>并输入已有的DistCC服务器。作为一个简单例子，我们假设已有的DistCC服务器是192.168.1.102（当前主机）、192.168.1.103和192.168.1.104（两个远端服务器）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># distcc-config --set-hosts &#34;192.168.1.102 192.168.1.103 192.168.1.104&#34;</span>
</code></pre></div><p>当然，也不要忘了运行distccd系统服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># rc-update add distccd default</span>
<span style="color:#75715e"># /etc/init.d/distccd start</span>
</code></pre></div><h3 id="缓冲编译结果">缓冲编译结果<a hidden class="anchor" aria-hidden="true" href="#缓冲编译结果">#</a></h3>
<h4 id="关于ccache">关于ccache<a hidden class="anchor" aria-hidden="true" href="#关于ccache">#</a></h4>
<p><strong>ccache</strong>是一个快速编译器缓存。 无论何时编译应用程序，它都将缓存中间结果，以便每当重新编译相同的程序时，编译时间大大减少。 第一次运行ccache时，它会比正常编译慢得多。 但是后续的重新编译应该更快。 ccache只有在相同的应用程序将被重新编译多次（或相同应用程序的升级频繁发生）时才有用; 因此它通常只对软件开发人员有用。</p>
<p>如果您对ccache的工作机制有兴趣，请访问<a href="https://ccache.samba.org/">homepage</a>主页.</p>
<p><strong>警告</strong>：已知ccache会导致大量的编译失败。 有时ccache会保留旧代码对象或损坏的文件，这可能导致无法破损的源码。 如果发生这种情况（例如&quot;File not recognized: File truncated&quot;出现在构建日志中），请尝试重新编译ccache导致错误的应用程序 。添加<code>FEATURES=&quot;-ccache&quot;</code> 到/etc/portage/make.conf或者</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># FEATURES=&#34;-ccache&#34; emerge &lt;category/package&gt;</span>
</code></pre></div><h4 id="安装-ccache">安装 ccache<a hidden class="anchor" aria-hidden="true" href="#安装-ccache">#</a></h4>
<p>要安装ccache，只需要：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask dev-util/ccache</span>
</code></pre></div><h4 id="激活portage-ccache-支持">激活Portage ccache 支持<a hidden class="anchor" aria-hidden="true" href="#激活portage-ccache-支持">#</a></h4>
<p>打开 <code>/etc/portage/make.conf</code>并添加<code>ccache</code>到FEATURES变量:</p>
<pre tabindex="0"><code>FEATURES=&quot;ccache&quot;
CCACHE_SIZE=&quot;2G&quot;
</code></pre><p>要检查ccache是否运行，只需让它提供给您它的统计数据。因为Portage使用一个不同的ccache主目录，您需要设定CCACHE_DIR变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># CCACHE_DIR=&#34;/var/tmp/ccache&#34; ccache -s</span>
</code></pre></div><p><code>/var/tmp/ccache/</code>是Portage的默认ccache主目录；为了修改这个设置，您可以设定<code>/etc/portage/make.conf</code>中的CCACHE_DIR参数。</p>
<p>不过，如果您运行 <strong>ccache</strong> ，它使用的默认目录是<code>${HOME}/.ccache/</code>。这就是为什么当您查询（Portage）ccache统计数据的时候您需要设定 CCACHE_DIR参数的原因。</p>
<h4 id="非portage编译中使用ccache">非Portage编译中使用ccache<a hidden class="anchor" aria-hidden="true" href="#非portage编译中使用ccache">#</a></h4>
<p>如果您需要在非Portage编译中使用ccache，添加 <code>/usr/lib/ccache/bin/</code>到您 PATH参数里靠前的位置（在/usr/bin之前）。这一点可以通过编辑在您用户主目录中的<code>~/.bash_profile</code>文件来实现。使用<code>~/.bash_profile</code>是定义 PATH参数的一个方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/usr/lib/ccache/bin:</span><span style="color:#e6db74">${</span>PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</code></pre></div><h3 id="二进制包支持">二进制包支持<a hidden class="anchor" aria-hidden="true" href="#二进制包支持">#</a></h3>
<h4 id="创建预编译包">创建预编译包<a hidden class="anchor" aria-hidden="true" href="#创建预编译包">#</a></h4>
<p>Portage 也支持安装预编译软件包。尽管 Gentoo 本身并不提供预编译包，但 Portage 依然能够处理预编译包。</p>
<p>如果某个包已经被安装在您的系统上，您可以用 <strong>quickpkg</strong> 来创建预编译包。也可以用带有 <code>--buildpkg</code> 或 <code>--buildpkgonly</code> 选项的 emerge 命令。</p>
<p>如果您希望 Portage 为您所安装的每一个软件包创建预编译软件包，那么请在 FEATURES 中添加 <code>buildpkg</code> 变量。</p>
<p>预编译包的更多扩展支持可以用 catalyst 得到。关于catalyst的更多信息请参阅 <a href="https://wiki.gentoo.org/wiki/Project:Catalyst/FAQ">Catalyst FAQ</a>。</p>
<h4 id="安装预编译包">安装预编译包<a hidden class="anchor" aria-hidden="true" href="#安装预编译包">#</a></h4>
<p>尽管Gentoo并不提供，但是您可以自己建立一个“中心仓库”来存放预编译包。如果您希望使用这个仓库，您需要设定PORTAGE_BINHOST参数使Portage能够知道它。例如，如果预编译包在 ftp://buildhost/gentoo 上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/make.conf</span>
PORTAGE_BINHOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ftp://buildhost/gentoo&#34;</span>
</code></pre></div><p>当您需要安装预编译包的时候，在emerge命令后的 <code>--getbinpkg</code>选项旁加入 <code>--usepkg</code> 选项。前者让emerge命令从预定的服务器上下载预编译包，后者让emerge首先试图安装预编译包，如果预编译包不存在，那么才下载并编译源码。</p>
<p>例如：用预编译包安装gnumeric</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --usepkg --getbinpkg gnumeric</span>
</code></pre></div><p>关于emerge的预编译包的更多信息请参阅emerge手册页:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># man emerge</span>
</code></pre></div><h4 id="将预构建的软件包分发给他人">将预构建的软件包分发给他人<a hidden class="anchor" aria-hidden="true" href="#将预构建的软件包分发给他人">#</a></h4>
<p>如果预构建的软件要分发给其他人，请确保这样做是被允许的。 检查上游软件包的分发要求。 例如，对于在GNU GPL协议下发布的软件，源代码必须与二进制文件一起提供。</p>
<p>如果构建的二进制程序不可分发，则Ebuild可以在其RESTRICT 变量中定义 <code>bindist</code>限制。 有时，此限制取决于一个或多个USE标志。</p>
<p>默认情况下，Portage将不会屏蔽任何包，因为有限制。 这可以通过在<code>/etc/portage/make.conf</code>中设置ACCEPT_RESTRICT变量来全局更改。 例如，要掩盖具有<code>bindist</code> 限制的软件包，请将以下行添加到make.conf：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ACCEPT_RESTRICT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;* -bindist&#34;</span>
</code></pre></div><p>还可以通过将ACCEPT_RESTRICT选项用于<strong>emerge</strong>命令，来覆盖<code>--accept-restrict</code> 变量。 例如， <code>--accept-restrict=-bindist</code>将临时屏蔽带有<code>bindist</code> 限制的包。</p>
<p>还可以考虑在分发包时设置ACCEPT_LICENSE变量。 请参阅 <a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/Portage/zh-cn#Licenses">授权许可</a>。</p>
<p><strong>重要</strong>：每个 <em>用户</em>完全有责任遵守软件许可条款和每个用户国家的法律。 ebuilds（RESTRICT或LICENSE）定义的元数据变量可以为禁止预编译文件分发提供指导。但是Portage的输出或Gentoo开发人员的回答 <em>不是</em> 法律声明，不应该依赖他们。 谨慎遵守您的当地的法律。</p>
<h3 id="下载文件">下载文件<a hidden class="anchor" aria-hidden="true" href="#下载文件">#</a></h3>
<h4 id="并行下载">并行下载<a hidden class="anchor" aria-hidden="true" href="#并行下载">#</a></h4>
<p>Portage 通常是以root 用户运行的， <code>FEATURES=&quot;userfetch&quot;</code>可以让Portage在下载源码包的时候弃用 root 权限，并以 portage:portage 的用户/组权限运行。这是一个小小的安全性的提高方法。</p>
<p>如果在 FEATURES 设置了 <code>userfetch</code>，请确保在 root 权限下，使用 <strong>chown</strong> 命令更改在 /var/db/repos/gentoo 下所有文件的所有者：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># chown --recursive --verbose portage:portage /var/db/repos/gentoo</span>
</code></pre></div><h4 id="验证源文件">验证源文件<a hidden class="anchor" aria-hidden="true" href="#验证源文件">#</a></h4>
<p>要重新验证完整性并(可能)重新下载当前所有安装的软件包以前删除或损坏的 distfiles，请运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask --fetchonly --emptytree @world</span>
</code></pre></div><h2 id="环境变量httpswikigentooorgwikihandbookamd64workingenvvar"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/EnvVar">环境变量</a><a hidden class="anchor" aria-hidden="true" href="#环境变量httpswikigentooorgwikihandbookamd64workingenvvar">#</a></h2>
<h3 id="环境变量">环境变量<a hidden class="anchor" aria-hidden="true" href="#环境变量">#</a></h3>
<h4 id="简介-1">简介<a hidden class="anchor" aria-hidden="true" href="#简介-1">#</a></h4>
<p>环境变量是一个具有特定名字的对象，它包含了一个或者多个应用程序所将使用到的信息。通过使用环境变量，你可以很容易的修改一个牵涉到一个或多个应用程序的配置信息。</p>
<h4 id="重要的例子">重要的例子<a hidden class="anchor" aria-hidden="true" href="#重要的例子">#</a></h4>
<p>下表展示了一些Linux系统使用的变量并说明了它们的用处。在表格后面将列举一些变量例值。</p>
<table>
<thead>
<tr>
<th style="text-align:left">Variable</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PATH</td>
<td style="text-align:left">这个变量包含了一系列由冒号分隔开的目录，系统就从这些目录里寻找可执行文件。如果你输入的可执行文件（例如 <strong>ls</strong>, <strong>rc-update</strong>或者 <strong>emerge</strong>）不在这些目录中，系统就无法执行它（除非你输入这个命令的完整路径，如/bin/ls）。</td>
</tr>
<tr>
<td style="text-align:left">ROOTPATH</td>
<td style="text-align:left">这个变量的功能和 PATH相同，但它只罗列出超级用户（root）键入命令时所需检查的目录。</td>
</tr>
<tr>
<td style="text-align:left">LDPATH</td>
<td style="text-align:left">这个变量包含了一系列用冒号隔开的目录，动态链接器将在这些目录里查找库文件。</td>
</tr>
<tr>
<td style="text-align:left">MANPATH</td>
<td style="text-align:left">这个变量包含了一系列用冒号隔开的目录，命令 man 会在这些目录里搜索man页面。</td>
</tr>
<tr>
<td style="text-align:left">INFODIR</td>
<td style="text-align:left">这个变量包含了一系列用冒号隔开的目录，命令 info 将在这些目录里搜索info页面。</td>
</tr>
<tr>
<td style="text-align:left">PAGER</td>
<td style="text-align:left">这个变量包含了浏览文件内容的程序的路径，比如(<strong>less</strong> 或者 <strong>more</strong>)</td>
</tr>
<tr>
<td style="text-align:left">EDITOR</td>
<td style="text-align:left">这个变量包含了修改文件内容的程序（文件编辑器）的路径(比如 <strong>nano</strong> 或 <strong>vi</strong>).</td>
</tr>
<tr>
<td style="text-align:left">KDEDIRS</td>
<td style="text-align:left">这个变量包含了一系列用冒号隔开的目录，里面放的是KDE相关的资料。</td>
</tr>
<tr>
<td style="text-align:left">CONFIG_PROTECT</td>
<td style="text-align:left">这个变量包含了一系列用空格隔开的目录，它们在更新的时候会被Portage保护起来。</td>
</tr>
<tr>
<td style="text-align:left">CONFIG_PROTECT_MASK</td>
<td style="text-align:left">这个变量包含了一系列用空格隔开的目录，它们在更新的时候不会被Portage保护起来。</td>
</tr>
</tbody>
</table>
<p>下面你可以找到所有这些变量定义的范例：</p>
<pre tabindex="0"><code>PATH=&quot;/bin:/usr/bin:/usr/local/bin:/opt/bin:/usr/games/bin&quot;
ROOTPATH=&quot;/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin&quot;
LDPATH=&quot;/lib:/usr/lib:/usr/local/lib:/usr/lib/gcc-lib/i686-pc-linux-gnu/3.2.3&quot;
MANPATH=&quot;/usr/share/man:/usr/local/share/man&quot;
INFODIR=&quot;/usr/share/info:/usr/local/share/info&quot;
PAGER=&quot;/usr/bin/less&quot;
EDITOR=&quot;/usr/bin/vim&quot;
KDEDIRS=&quot;/usr&quot;
CONFIG_PROTECT=&quot;/usr/X11R6/lib/X11/xkb /opt/tomcat/conf \
                /usr/kde/3.1/share/config /usr/share/texmf/tex/generic/config/ \
                /usr/share/texmf/tex/platex/config/ /usr/share/config&quot;
CONFIG_PROTECT_MASK=&quot;/etc/gconf&quot;
</code></pre><h3 id="全局变量的定义">全局变量的定义<a hidden class="anchor" aria-hidden="true" href="#全局变量的定义">#</a></h3>
<h4 id="envd目录">env.d目录<a hidden class="anchor" aria-hidden="true" href="#envd目录">#</a></h4>
<p>Gentoo采用了/etc/env.d/目录来集中定义全局变量。在这个目录里，你会发现很多类似 00basic, 05gcc等等这样的文件，它们包含了文件名中提到的应用程序需要的变量。</p>
<p>举个例子，当你安装 <strong>gcc</strong>时，一个名为 05gcc 的文件就会被ebuild所创建，里面包含了如下一些变量：</p>
<pre tabindex="0"><code>PATH=&quot;/usr/i686-pc-linux-gnu/gcc-bin/3.2&quot;
ROOTPATH=&quot;/usr/i686-pc-linux-gnu/gcc-bin/3.2&quot;
MANPATH=&quot;/usr/share/gcc-data/i686-pc-linux-gnu/3.2/man&quot;
INFOPATH=&quot;/usr/share/gcc-data/i686-pc-linux-gnu/3.2/info&quot;
CC=&quot;gcc&quot;
CXX=&quot;g++&quot;
LDPATH=&quot;/usr/lib/gcc-lib/i686-pc-linux-gnu/3.2.3&quot;
</code></pre><p>其他的发行版会让你到/etc/profile或者其他地方修改和添加这些变量的定义。而Gentoo为用户（还有为Portage）提供了更加便捷的方式来维护和管理环境变量，以后你不再需要把精力放在那些众多的包含环境变量的文件身上了。</p>
<p>比如，当你更新完<strong>gcc</strong> 的时候， /etc/env.d/05gcc也会被同时更新，而不需要你手工来完成。</p>
<p>这不仅对Portage有益，作为用户，你也是受益者。有时候你需要设置某个系统范围的环境变量。我们拿http_proxy变量来做例子，为了避免http_proxy 搞乱，你只要新建一个文件/etc/env.d/99local然后添加你的定义：</p>
<pre tabindex="0"><code>http_proxy=&quot;proxy.server.com:8080&quot;
</code></pre><p>通过使用同一个文件来定义你所有的变量，你对如何定义自己的变量有了个大概的了解。</p>
<h4 id="env-update">env-update<a hidden class="anchor" aria-hidden="true" href="#env-update">#</a></h4>
<p>/etc/env.d/ 中的好几个文件都定义了PATH变量。这并没有错：当你运行<strong>env-update</strong>的时候，它会在更新环境变量之前把这些定义都追加到PATH里，因此对于软件包（或者用户）来说将会很容易地设置他们自己的环境变量，而不影响到现有变量的值。</p>
<p><strong>env-update</strong> 脚本会根据 /etc/env.d/ 里文件的字母顺序来附加变量的值。这些文件名必须要以两位数字开头。</p>
<pre tabindex="0"><code>00basic        99kde-env       99local
     +-------------+----------------+-------------+
PATH=&quot;/bin:/usr/bin:/usr/kde/3.2/bin:/usr/local/bin&quot;
</code></pre><p>变量并不总是被串联起来，只有下列变量才会被串联： ADA_INCLUDE_PATH, ADA_OBJECTS_PATH, CLASSPATH, KDEDIRS, PATH, LDPATH, MANPATH, INFODIR, INFOPATH, ROOTPATH, CONFIG_PROTECT, CONFIG_PROTECT_MASK, PRELINK_PATH, PRELINK_PATH_MASK, PKG_CONFIG_PATH,和PYTHONPATH。对于( /etc/env.d/) 里的文件中按照字母顺序排列后）其他所有变量，最新定义的值才会被使用到。</p>
<p>可以通过将变量名添加到 COLON_SEPARATED or SPACE_SEPARATED （也在 /etc/env.d/ 文件）。</p>
<p>当你运行 <strong>env-update</strong>的时候，它会在文件/etc/profile.env 里（会被/etc/profile使用）创建所有的环境变量。它也会从变量 LDPATH 中获取信息用来建立/etc/ld.so.conf。这些完成以后，它将运行 <strong>ldconfig</strong>来重建动态链接器需要的文件/etc/ld.so.cache。</p>
<p>如果你想在运行<strong>env-update</strong>后立即看到效果，执行下面的命令来更新你的环境。自己安装过Gentoo的用户可能已经记住了这个安装指南中提到过的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># env-update &amp;&amp; source /etc/profile</span>
</code></pre></div><p><strong>附注</strong>：上面的命令只会更新你当前终端里的环境变量、新控制台以及它们的子程序。因此，假如你正在X11里工作，你要么在每一个你打开的终端里输入<strong>source /etc/profile</strong> ，要么重新启动X，这样所有新的终端才能引用到新的变量。如果你使用了登录管理器，登陆成root然后输入 /etc/init.d/xdm 。如果不是这样，你需要注销然后重新登录回X这样才能产生使用新变量值的子程序。</p>
<p><strong>重要</strong>：你在定义其他变量时不能使用shell变量。这意味着这样的定义 <code>FOO=&quot;$BAR&quot;</code>（此处$BAR 是另外一个变量）是不允许的。</p>
<h3 id="本地变量的定义">本地变量的定义<a hidden class="anchor" aria-hidden="true" href="#本地变量的定义">#</a></h3>
<h4 id="特定用户">特定用户<a hidden class="anchor" aria-hidden="true" href="#特定用户">#</a></h4>
<p>你并不是一直都想定义全局变量。比如你想把/home/my_user/bin和当前目录（你当前所在的目录）添加到PATH 变量中，但又不想让其他用户的PATH变量中也有这个。如果你想定义一个本地变量，可以使用 ~/.bashrc 或者~/.bash_profile:</p>
<pre tabindex="0"><code>PATH=&quot;${PATH}:/home/my_user/bin:&quot;
</code></pre><p>当你重新登录的时候，你的PATH变量将被更新。</p>
<h4 id="特定会话">特定会话<a hidden class="anchor" aria-hidden="true" href="#特定会话">#</a></h4>
<p>有时候甚至需要更加严格的定义。你可能要使用一个你临时创建的目录里面的程序，而又不想输入它的路径或者为此短时间内内修改 ~/.bashrc。</p>
<p>在这种情况下，你只需要在当前会话中使用<strong>export</strong>来定义 PATH 变量。只要你不注销，PATH变量将保持这个临时的设置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># export PATH=&#34;${PATH}:/home/my_user/tmp/usr/bin&#34;</span>
</code></pre></div><h2 id="ebuild-1">ebuild<a hidden class="anchor" aria-hidden="true" href="#ebuild-1">#</a></h2>
<h3 id="gentoo-development-guide-chinesehttpsblogsoymilkfungentoo-development-guide-chinese"><a href="https://blog.soymilk.fun/Gentoo-Development-Guide-Chinese/">Gentoo Development Guide Chinese</a><a hidden class="anchor" aria-hidden="true" href="#gentoo-development-guide-chinesehttpsblogsoymilkfungentoo-development-guide-chinese">#</a></h3>
<h3 id="ebuild-编写基本指南httpswikigentooorgwikibasic_guide_to_write_gentoo_ebuilds"><a href="https://wiki.gentoo.org/wiki/Basic_guide_to_write_Gentoo_Ebuilds">Ebuild 编写基本指南</a><a hidden class="anchor" aria-hidden="true" href="#ebuild-编写基本指南httpswikigentooorgwikibasic_guide_to_write_gentoo_ebuilds">#</a></h3>
<p>一个 ebuild 文件是一个文本文件，供 Gentoo 包管理器使用，它标识一个特定的软件包以及 Gentoo 包管理器应该如何处理它。它使用一个 <a href="https://en.wikipedia.org/wiki/Bash_(Unix_shell)">bash</a> 类似语法风格，并通过 <a href="https://wiki.gentoo.org/wiki/EAPI">EAPI</a> 版本进行标准化。</p>
<p>Gentoo Linux 使用 ebuild 作为单个软件的包管理格式。这些 ebuild 包含相关软件的元数据（软件的名称和版本、软件使用的许可证和主页）、依赖信息（构建时和运行时依赖）以及有关如何处理的说明使用软件（配置、构建、安装、测试&hellip;）。</p>
<p>Gentoo 中 ebuild 的默认位置是 <a href="https://wiki.gentoo.org/wiki//var/db/repos/gentoo"><code>/var/db/repos/gentoo</code></a>/，该位置由<a href="https://wiki.gentoo.org/wiki/Repos.conf">repos.conf</a>文件确定。自定义ebuild建议放在<a href="https://wiki.gentoo.org/wiki/Custom_repository">自定义库</a>中，比如<code>/var/db/repos/larry</code>。</p>
<p><strong>ebuild</strong> 也是运行各种 <a href="https://devmanual.gentoo.org/ebuild-writing/functions/">ebuild 函数</a> 的 <a href="https://wiki.gentoo.org/wiki/Portage">Portage</a> 命令。通过运行以下命令在本地找到相关信息：</p>
<pre tabindex="0"><code># man 1 ebuild
# man 5 ebuild
</code></pre><p><strong>实时 ebuild</strong></p>
<p>如果源代码是从修订控制系统 (VCS) 获取的，那么此 ebuild 就是“实时 ebuild”。它们往往（但不一定）具有版本号 9999，以便可以轻松将其与基于上游版本的普通 ebuild 区分开来。</p>
<p>如果 ebuild 有一个变量 <code>PROPERTIES</code>，其中的值是“live”，那么它就是“实时的”。如果一个 ebuild 继承了一个 VCS eclass（例如 git-r3、mercurial、darcs），它将是实时的，因为这些 eclass 中有一行 <code>PROPERTIES+=&quot;live&quot;</code>。</p>
<p>在 packages.gentoo.org 站点中，实时 ebuild 具有标志 L 。在 eix 的输出中，它用 <code>*l</code> 标记。</p>
<h4 id="如何创建一个-ebuild">如何创建一个 ebuild<a hidden class="anchor" aria-hidden="true" href="#如何创建一个-ebuild">#</a></h4>
<p><a href="https://wiki.gentoo.org/wiki/Vim">vim</a> 的用户自动获取基本骨架（由 <a href="https://packages.gentoo.org/packages/app-vim/gentoo-syntax">app-vim/gentoo-syntax</a> 提供）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># vim ./foobar.ebuild</span>
</code></pre></div><p>模板</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Copyright 1999-2022 Gentoo Authors</span>
<span style="color:#75715e"># Distributed under the terms of the GNU General Public License v2</span>
 
EAPI<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>
 
DESCRIPTION<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
HOMEPAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
SRC_URI<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
 
LICENSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
SLOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span>
KEYWORDS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;~amd64 ~x86&#34;</span>
IUSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
 
DEPEND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
RDEPEND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DEPEND<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
BDEPEND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</code></pre></div><p>GNU Emacs 或 XEmacs 用户可以使用类似的工具（分别由 <a href="https://packages.gentoo.org/packages/app-emacs/ebuild-mode">app-emacs/ebuild-mode</a> 或 <a href="https://packages.gentoo.org/packages/app-xemacs/ebuild-mode">app-xemacs/ebuild-mode</a> 提供）。</p>
<p>其他编辑器的用户从 skel.ebuild 手动复制：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /var/db/repos/gentoo/skel.ebuild ./foobar.ebuild</span>
</code></pre></div><p>应该知道新包的基本信息，并将其添加到 <a href="https://devmanual.gentoo.org/ebuild-writing/variables/index.html#ebuild-defined-variables">ebuild-defined variables</a>。</p>
<h4 id="给定源压缩包示例">给定源压缩包示例<a hidden class="anchor" aria-hidden="true" href="#给定源压缩包示例">#</a></h4>
<p>为 <a href="https://github.com/chaos/scrub">Scrub</a> 创建一个 ebuild：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /var/db/repos/larry/app-misc/scrub</span>
<span style="color:#75715e"># cd $_</span>
<span style="color:#75715e"># vim ./scrub-2.6.1.ebuild</span>
</code></pre></div><p>模板</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Copyright 1999-2022 Gentoo Authors</span>
<span style="color:#75715e"># Distributed under the terms of the GNU General Public License v2</span>
 
EAPI<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>
 
DESCRIPTION<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Some words here&#34;</span>
HOMEPAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://github.com/chaos/scrub&#34;</span>
SRC_URI<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://github.com/chaos/scrub/releases/download/2.6.1/scrub-2.6.1.tar.gz&#34;</span>
 
LICENSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;GPL-2&#34;</span>
SLOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span>
KEYWORDS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;~amd64 ~x86&#34;</span>
IUSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
 
DEPEND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
RDEPEND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DEPEND<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
BDEPEND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</code></pre></div><p>允许在SRC_URI中使用<a href="https://devmanual.gentoo.org/ebuild-writing/variables/"><code>${PN}</code> variable</a>，但不建议。虽然它可能会缩小这条线，但一些 <a href="https://projects.gentoo.org/qa/policy-guide/ebuild-format.html#pg0103">reasoning why not to use it</a>也值得考虑。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">SRC_URI<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://github.com/chaos/</span><span style="color:#e6db74">${</span>PN<span style="color:#e6db74">}</span><span style="color:#e6db74">/releases/download/</span><span style="color:#e6db74">${</span>PV<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>P<span style="color:#e6db74">}</span><span style="color:#e6db74">.tar.gz&#34;</span>
</code></pre></div><p>可以使用<a href="https://dev.gentoo.org/~zmedico/portage/doc/man/ebuild.1.html">ebuild</a>命令来测试它:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ebuild ./scrub-2.6.1.ebuild clean unpack</span>
</code></pre></div><p>这应该下载并解压源压缩包。在极少数情况下，包应该可以工作，并且不需要在 ebuild 中进一步调整。</p>
<h4 id="打补丁">打补丁<a hidden class="anchor" aria-hidden="true" href="#打补丁">#</a></h4>
<p>如果源代码需要打补丁，可以从 <a href="https://wiki.gentoo.org/wiki/Patches">patches</a>文章中解释的解压源代码创建补丁。</p>
<p>补丁将被列在一个名为PATCHES的数组中，正如<a href="https://devmanual.gentoo.org/ebuild-writing/functions/src_prepare/epatch/index.html">devmanual</a>中所解释的那样。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PATCHES<span style="color:#f92672">=(</span>
	<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>FILESDIR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/<span style="color:#e6db74">${</span>P<span style="color:#e6db74">}</span>-foo.patch
	<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>FILESDIR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/<span style="color:#e6db74">${</span>P<span style="color:#e6db74">}</span>-bar.patch
<span style="color:#f92672">)</span>
 
src_prepare<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    default
    ...
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="初探-ebuildhttpssegmentfaultcoma1190000003819421"><a href="https://segmentfault.com/a/1190000003819421">初探 ebuild</a><a hidden class="anchor" aria-hidden="true" href="#初探-ebuildhttpssegmentfaultcoma1190000003819421">#</a></h3>
<p>2015-10-05</p>
<p>无论你使用过多少/多久其他的 Linux 发行版，初次接触 Gentoo 时，极有可能会觉得它在软件包的安装方面很神奇。若要在 Gentoo 中安装一个软件包，通常要定义如何进行软件源代码包的下载、解包、打补丁、编译、安装以及合并。为了实现对软件包进行细微的定制，还需要定义一些有用的元数据（即 USE 旗标）、补丁文件以及一些操控软件包编译与安装的过程。Gentoo 是通过 GNU Bash shell 脚本来定义这一切，这种脚本就是所谓的 ebuild 文件。</p>
<h4 id="ebuild-在哪里">ebuild 在哪里？<a hidden class="anchor" aria-hidden="true" href="#ebuild-在哪里">#</a></h4>
<p>我们在安装 Gentoo 时，一个必须的步骤是下载一个 Portage 树的镜像包，解包后通常安置于 <code>/var/db/repos/gentoo</code> 目录，之后每次执行 <code>emerge --sync</code> 时，便会根据官方远程网站上的 Portage 树来更新你本地的 Portage 树。</p>
<p>粗枝大叶的看，Portage 树有四层结点。根结点便是 <code>/var/db/repos/gentoo</code> 目录，第 2 层结点是软件包所属分类目录，第 3 层结点是软件包的名称目录，叶子结点则是 ebuild 文件以及其他辅助性文件或目录。以 <code>gnome-shell-3.12.2.ebuild</code> 文件为例，它在 Portage 树中的完整路径是 <code>/var/db/repos/gentoo/gnome-base/gnome-shell/gnome-shell-41.1.ebuild</code>。</p>
<p>对于我们期望的软件包，如果 Portage 树未提供针对它的 ebuild 文件，那么我们需要自己动手丰衣足食。一般是不建议将我们所写的 ebuild 文件放在 Portage 树中的，因为它们可能会在 <code>emerge --sync</code> 期间被冲刷（比如被官方的同名文件替换）。</p>
<p>Portage 树支持一种被称为 Overlay 的技术。简单来说，就是我们可以另行建立一棵新的 Portage 树，这棵树的规模虽然比官方的 Portage 树小很多，但是 Portage 树的管理系统可以将这可新的 Portage 树与官方 Portage 树『合并』。如果新的 Portage 树中某些结点与官方的 Portage 树存在重叠，那么 Portage 树的管理系统会以前者覆盖后者，因此我们新建的 Portage 树通常被直呼为『Overlay』。</p>
<h4 id="建立自己的-overlay">建立自己的 Overlay<a hidden class="anchor" aria-hidden="true" href="#建立自己的-overlay">#</a></h4>
<p>在 <code>/var/db/repos/</code> 目录中创建自己的 Overlay：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /var/db/repos/localrepo/{metadata,profiles}</span>
<span style="color:#75715e"># chown -R portage:portage /var/db/repos/localrepo</span>
</code></pre></div><p>在该 <code>/var/db/repos/localrepo/profiles/</code> 内添加 <code>repo_name</code> 文件。我们可以在这份文件中设置 Overlay 名称，只需将 Overlay 名称写入该文件即可。例如，我将我的 Overlay 命名为 <code>localrepo</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;localrepo&#39; &gt; /var/db/repos/localrepo/profiles/repo_name</span>
</code></pre></div><p>为了让我们的 Overlay 能够被 Portage 管理系统所接受，需要在 <code>/var/db/repos/localrepo/metadata/layout.conf</code> 内添加：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">masters</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">gentoo</span>
<span style="color:#a6e22e">auto-sync</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</code></pre></div><p>需要将 Overlay 路径告知 Portage 管理系统，即在 <code>/etc/portage/repos.conf/localrepo.conf</code> 文件中添加以下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[localrepo]</span>
<span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/var/db/repos/localrepo</span>
</code></pre></div><p>今后，就在这个 Overlay 中学习 ebuild 文件的编写。</p>
<h4 id="hello-world">Hello World!<a hidden class="anchor" aria-hidden="true" href="#hello-world">#</a></h4>
<p>下面通过写一个非常简单的 ebuild 文件来获取一些直观的认识。假设在 <code>app-misc</code> 这个分类中有一个名为 <code>hello-world</code> 的软件包，现在我们要为这个软件包的 1.0 版的安装写一份 ebuild 文件。</p>
<blockquote>
<p>注意：软件包的分类名并不是随意的，它必须要与 <code>/var/db/repos/gentoo</code> 中的某个子目录名一致。</p>
</blockquote>
<p>首先在 Overlay 中建立软件包所在的分支：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /var/db/repos/localrepo/app-misc/hello-world</span>
</code></pre></div><p>可从 <code>/var/db/repos/gentoo/header.txt</code> 文件中获得 ebuild 文件默认的文件头，即：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-apache" data-lang="apache"><span style="color:#75715e"># Copyright 2021 Gentoo Authors</span>
<span style="color:#75715e"># Distributed under the terms of the GNU General Public License v2</span>
</code></pre></div><p>只不过是一些 Bash 脚本注释形式的文件描述信息而已，但它们是必须的。可以直接将 <code>/var/db/repos/gentoo/header.txt</code> 文件复制为 <code>hello-world-1.0.ebuild</code> 文件，这样便可获得一个含有上述内容的空 ebuild 文件。ebuild 文件的名称必须符合 Portage 所认可的格式，即：<code>软件包名称-版本号.ebuild</code>。这一点很重要。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /var/db/repos/gentoo/header.txt /var/db/repos/localrepo/app-misc/hello-world/hello-world-1.0.ebuild</span>
</code></pre></div><p>下面，为这份 ebuild 文件增加以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">SLOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span>
</code></pre></div><p>这样，我们便建立了一份最为简单的 ebuild 文件。接下来就是在这份文件上签个字……也就是为之生成一份签名文件，表示这个 ebuild 的是我们做的，出了事我们负责。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cd /var/db/repos/localrepo/app-misc/hello-world</span>
<span style="color:#75715e"># ebuild ./hello-world-1.0.ebuild manifest</span>
</code></pre></div><p>若签名成功，会在 ebuild 文件同一目录中生成一份名为 <code>Manifest</code> 的文件。将来发布这份 ebuild 文件时，需要将数字签名文件一起发出，这样他人便可以验证这份 ebuild 是不是我们做的。因为非常有可能我们在向朋友们发送 ebuild 文件的过程中会被坏人拦截，然后篡改 ebuild 文件。由于 ebuild 是可被系统执行的脚本，因此很有可能变成『病毒』。因此，ebuild 文件的数字签名非常有必要。不过，这里为了简单起见，没有涉及如何用自己的密钥实现对 ebuild 的签名，所得 <code>Manifest</code> 文件仅仅是为了让 ebuild 能够被 Portage 管理系统所认可。</p>
<p>下面，继续向这份 ebuild 加入一些内容，使之变为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#75715e"># Copyright 2021 Gentoo Authors</span>
<span style="color:#75715e"># Distributed under the terms of the GNU General Public License v2</span>
 
<span style="color:#a6e22e">EAPI</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;7&#34;</span>
<span style="color:#a6e22e">SLOT</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span>
<span style="color:#a6e22e">DESCRIPTION</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;A classical example to use when starting on something new.&#34;</span>
<span style="color:#a6e22e">HOMEPAGE</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://wiki.gentoo.org/index.php?title=Basic_guide_to_write_Gentoo_Ebuilds&#34;</span>
 
<span style="color:#a6e22e">LICENSE</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;MIT&#34;</span>
<span style="color:#a6e22e">KEYWORDS</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;~alpha ~amd64 ~arm ~hppa ~ia64 ~ppc ~ppc64 ~s390 ~sh ~sparc ~x86&#34;</span>
</code></pre></div><p>基本上就是在原来那份最简单的 ebuild 文件的基础上增加了几个变量：</p>
<ul>
<li><code>EAPI</code>：Portage 系统已经为我们编写了许多有用的 Bash 函数，将 <code>EAPI</code> 的值设为 <code>7</code> 表示我们要用目前最新的 Bash 函数。这个变量必须要在 ebuild 文件头之后进行设定。</li>
<li><code>DESCRIPTION</code>：这个变量存储了 <code>hello-world</code> 这个软件包的简介信息。</li>
<li><code>HOMEPAGE</code>：定义了 <code>hello-world</code> 这个软件包的项目主页。</li>
<li><code>LICENSE</code>：定义了 <code>hello-world</code> 这个软件包所使用的许可证，例如 LGPL，GPL V2，GPL V3，MIT 等。</li>
<li><code>KEYWORDS</code>：如果你期望 <code>hello-world</code> 这个软件包能够安装在你的机器上，那么 <code>KEYWORDS</code> 变量的值必须要包含你在 <code>/etc/make.conf</code> 中所设定的 <code>ACCEPT_KEYWORDS</code> 值。</li>
</ul>
<p>一旦改动了 ebuild 文件内容，那么必须重新生成 <code>Manifest</code> 文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ebuild ./hello-world-1.0.ebuild manifest</span>
</code></pre></div><p>现在，便可以使用 <code>emerge</code> 命令安装这个目前依然是子虚乌有的软件包了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -a hello-world</span>

These are the packages that would be merged, in order:

Calculating dependencies... <span style="color:#66d9ef">done</span>!
<span style="color:#f92672">[</span>ebuild  N    ~<span style="color:#f92672">]</span> app-misc/hello-world-1.0::localrepo  <span style="color:#ae81ff">0</span> KiB

Total: <span style="color:#ae81ff">1</span> package <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> new<span style="color:#f92672">)</span>, Size of downloads: <span style="color:#ae81ff">0</span> KiB
</code></pre></div><p>虽然到现在为止，还是什么也没有做出来，但是看着 <code>emerge</code> 神奇的发现了我写的 <code>ebuild</code>，心底还是蔓生了一些幸福。</p>
<h4 id="emerge-与-ebuild-有什么联系">emerge 与 ebuild 有什么联系？<a hidden class="anchor" aria-hidden="true" href="#emerge-与-ebuild-有什么联系">#</a></h4>
<p>简单的说，就是 <code>emerge</code> 这个 Python 脚本会调用 <code>ebuild.sh</code> 这个 Bash 脚本，让后者去执行 ebuild 文件定义的软件包的下载、编译及安装过程。</p>
<p><img loading="lazy" src="/Distributions/2056857414-5611b125e4a99_fix732.png" alt=""  />
</p>
<p><code>ebuild.sh</code> 所操控的软件包安装过程是在一个沙箱（Sandbox）中进行的。这一过程结束后，<code>emerge</code> 脚本需要将沙箱中的成果转移到真实世界，即 <code>/</code> 目录。</p>
<h3 id="slothttpswikitankywoocomlinuxgentoohtmlslot"><a href="https://wiki.tankywoo.com/linux/gentoo.html#slot">SLOT</a><a hidden class="anchor" aria-hidden="true" href="#slothttpswikitankywoocomlinuxgentoohtmlslot">#</a></h3>
<p>SLOT, 即「槽」, 和具体某个包相关的概念, 是Gentoo实现多版本共存的基础。</p>
<p><code>0</code> 是默认的slot名, 表示没有使用slot;</p>
<p>slot名是空字符串表示彻底禁止使用slot;</p>
<p>带有slot的包, 包名后面会有<code>:</code>冒号分隔, 并带上slot, 如:</p>
<pre tabindex="0"><code>dev-python/dnspython-1.12.0-r200:py2
dev-python/dnspython-1.12.0-r300:py3
</code></pre><p>表示dnspython这个包分别有py2和py3两个slot。</p>
<p>相关的一些命令:</p>
<p><code>eix</code> 可以直接查看包的所有slot:</p>
<pre tabindex="0"><code>$ eix dnspython
* dev-python/dnspython
     Available versions:
     (py2)  1.12.0-r200
     (py3)  1.12.0-r300
       {examples test PYTHON_TARGETS=&quot;python2_7 python3_3 python3_4&quot;}
     Homepage:            http://www.dnspython.org/ https://pypi.python.org/pypi/dnspython
     Description:         DNS toolkit for Python
</code></pre><p><code>equery list -p</code>:</p>
<pre tabindex="0"><code>$ equery l -po dnspython
 * Searching for dnspython ...
[-P-] [  ] dev-python/dnspython-1.12.0-r200:py2
[-P-] [  ] dev-python/dnspython-1.12.0-r300:py3
[-P-] [ ~] dev-python/dnspython-1.12.0-r301:py3
</code></pre><p><code>equery keywords</code>:</p>
<pre tabindex="0"><code>$ equery keywords dnspython
Keywords for dev-python/dnspython:
            |                                 | u     |
            | a a   a         n   p r     s   | n     |
            | l m   r h i m m i   p i s   p   | u s   | r
            | p d a m p a 6 i o p c s 3   a x | s l   | e
            | h 6 r 6 p 6 8 p s p 6 c 9 s r 8 | e o   | p
            | a 4 m 4 a 4 k s 2 c 4 v 0 h c 6 | d t   | o
------------+---------------------------------+-------+-------
1.12.0-r200 | + + + ~ + + o o o + + o ~ ~ + + | o py2 | gentoo
------------+---------------------------------+-------+-------
1.12.0-r300 | + + + ~ + + o o o + + o ~ ~ + + | o py3 | gentoo
1.12.0-r301 | ~ ~ ~ ~ ~ ~ o o o ~ ~ o ~ ~ ~ ~ | o     | gentoo
</code></pre><h4 id="真实的-hello-world">真实的 Hello World！<a hidden class="anchor" aria-hidden="true" href="#真实的-hello-world">#</a></h4>
<p>在一个遥远的地方，真的存在着 hello-world 的源码包。我们只要通过 ebuild 文件将这个源码包的位置告诉 <code>ebuild.sh</code> 脚本，<code>ebuild.sh</code> 便会不远万里将其擒来。所以，我们需要在 <code>hello-world-1.0.ebuild</code> 文件中添加以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">SRC_URI</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://gitlab.com/alogim/gentoo-basic-ebuild/-/raw/master/update1/hello-world-1.0.tar.gz?inline=false&#34;</span>
</code></pre></div><p><code>SRC_URI</code> 这个变量便是存储源码包的下载地址的。</p>
<p>在重新生成 <code>Manifest</code> 时，<code>ebuild.sh</code> 便会自动将源码包下载到 <code>/var/cache/distfiles/</code> 目录，并为这个源码包也生成一个数字签名存储在 <code>Manifest</code> 文件中。</p>
<p>既然有了 <code>hello-world</code> 的源码包，那么下一步就该思考如何在 ebuild 文件中定义这个源码包的编译过程了。不过，解开刚才下载的 <code>hello-world-1.0.tar.gz</code> 包看一下，发现包里只有一份 Bash 脚本 <code>hello-world</code>，其内容为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>
echo <span style="color:#e6db74">&#34;Hello world!&#34;</span>
</code></pre></div><p>所以，这个源码包就没必要编译了，直接安装到系统中即可。从而，我们在 ebuild 文件中获得了第一次编写 ebuild 函数的机会。在现有的 <code>hello-world-1.0.ebuile</code> 的文件中继续添加以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">src_install<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    dobin hello-world
<span style="color:#f92672">}</span>
</code></pre></div><p><code>src_install</code> 是 <code>ebuild.sh</code> 脚本能够识别并执行的函数名。也就是说，从 <code>ebuild.sh</code> 脚本的角度来看，你若想让我替你将软件包安装至系统中，那么你必须得按照我的习惯来。我的习惯就是在你提供给我的 ebuild 文件中寻找 <code>src_install</code> 这个函数，如果有这个函数，我就执行它，否则我就什么也不做。这就是 <code>ebuild.sh</code> 与 ebuild 文件之间达成的一个约定。</p>
<p>现在我们在 ebuild 文件中向 <code>ebuild.sh</code> 提供了 <code>src_install</code> 这个函数。这个函数只包含一条命令：<code>dobin hello-world</code> 。这个命令的意思是为 <code>hello-world</code> 这个脚本设置可执行权限，然后将其安装至系统默认的可执行文件目录中，即 <code>/usr/bin</code> 目录。</p>
<p><code>src_install</code> 只是 <code>ebuild.sh</code> 与 ebuild 文件之间众多约定函数中的一个而已，并且这些约定函数是顺次被 <code>ebuild.sh</code> 执行的，如下图所示：</p>
<p><img loading="lazy" src="/Distributions/4012241762-5611b1511041c_fix732.png" alt=""  />
</p>
<p>这里存在一个问题，<code>hello-world</code> 这个 Bash 脚本是包含在 <code>hello-world-1.0.tar.gz</code> 这个包内的，而我们只在 <code>hello-world-1.0.ebuild</code> 文件中定义了 <code>src_install</code> 函数，那么 <code>hello-world-1.0.tar.gz</code> 何时被解包的呢？这个问题的答案是，Portage 管理系统中已经为这些约定的函数定义了默认行为。比如，用于为源码包解包的 <code>src_unpack</code> 函数，其默认的定义是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">src_unpack<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>A<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
        unpack <span style="color:#e6db74">${</span>A<span style="color:#e6db74">}</span>
    <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>如果在 ebuild 文件中没有重新定义 <code>src_unpack</code> 函数，那么 <code>ebuild.sh</code> 便会按照上面图示的管线调用默认的 <code>src_unpack</code> 函数。所以 <code>hello-world</code> 脚本得以从 <code>hello-world-1.0.tar.gz</code> 中解出。</p>
<p>对现在的 <code>hello-world-1.0.ebuild</code> 再次生成 <code>Manifest</code>，然后就可以用它将 <code>hello-world</code> 脚本安装至 <code>/usr/bin</code> 目录中了。</p>
<p>这就是我们用自己写的 ebuild 安装的第一个『软件包』。</p>
<h2 id="ebuild-repositoryhttpswikigentooorgwikiebuild_repository"><a href="https://wiki.gentoo.org/wiki/Ebuild_repository">ebuild repository</a><a hidden class="anchor" aria-hidden="true" href="#ebuild-repositoryhttpswikigentooorgwikiebuild_repository">#</a></h2>
<p>An <strong>ebuild repository</strong>, colloquially known as an <strong>overlay</strong>, is a structure of directories and files used to add and extend software packages for a Gentoo-based system.</p>
<p>Ebuild repositories contain ebuilds, eclasses, and other types of descriptive metadata files. These files inform the package manager of software available for installation, news items, and profile targets. An ebuild repository should conform to one or more <a href="https://wiki.gentoo.org/wiki/EAPI">Ebuild APIs</a> as detailed in Gentoo&rsquo;s <a href="https://wiki.gentoo.org/wiki/Package_Manager_Specification">Package Manager Specification</a>.</p>
<p>The <em><strong><a href="https://wiki.gentoo.org/wiki/Ebuild_repository#The_Gentoo_ebuild_repository">Gentoo ebuild repository</a></strong></em>, as Gentoo&rsquo;s primary and &ldquo;official&rdquo; repository, is the source for all the information needed to build and install Gentoo packages, contained in <a href="https://wiki.gentoo.org/wiki/Ebuild">ebuilds</a>.</p>
<p>Administrators of Gentoo systems can add additional ebuild repositories by using various utilities and methods described below.</p>
<h3 id="the-gentoo-ebuild-repository">The Gentoo ebuild repository<a hidden class="anchor" aria-hidden="true" href="#the-gentoo-ebuild-repository">#</a></h3>
<p>The <em>Gentoo ebuild repository</em> will sometimes be called by shorter, or even colloquial, names, such as the <em><strong>Gentoo repository</strong></em>, the <em><strong>Gentoo repo</strong></em>, <em><strong>::gentoo</strong></em>, <em><strong>gentoo.git</strong></em>, or occasionally just the &ldquo;<em><strong>repo</strong></em>&rdquo;. It was historically known within the Gentoo community as the <em>Portage tree</em>, <em>rsync tree</em>, or sometimes just &ldquo;<em>the tree</em>&rdquo;.</p>
<h3 id="repositories-in-general">Repositories in general<a hidden class="anchor" aria-hidden="true" href="#repositories-in-general">#</a></h3>
<p>Repositories are handled through <a href="https://wiki.gentoo.org/wiki//etc/portage/repos.conf">/etc/portage/repos.conf</a> (which, like many other Portage configuration locations, can be a file or a directory), and the <a href="https://wiki.gentoo.org/wiki/Eselect/Repository"><strong>eselect repository</strong></a> is is a tool to manage this configuration.</p>
<p>Repository definitions inside /etc/portage/repos.conf also inform Portage if and how the repository can be updated. With it, calling <strong>emaint sync &ndash;auto</strong> will automatically update the enabled repositories as well.</p>
<p>A deprecated, yet still supported method is to use the PORTDIR_OVERLAY variable inside /etc/portage/make.conf. This variable can point to one or more additional locations on the file system where additional repositories are available. The use of the <a href="https://wiki.gentoo.org/wiki//etc/portage/repos.conf">/etc/portage/repos.conf</a>/ directory is highly preferred.</p>
<p>For more information, see <a href="https://wiki.gentoo.org/wiki//etc/portage/repos.conf">/etc/portage/repos.conf</a> and the <a href="https://wiki.gentoo.org/wiki/Project:Portage/Sync#Operation">Portage/Sync article</a>.</p>
<h4 id="priorities">Priorities<a hidden class="anchor" aria-hidden="true" href="#priorities">#</a></h4>
<p>Ebuilds from repositories with higher priority numbers (for example <code>60</code>) will take precedence over ebuilds from repositories with lower priorities (such as <code>50</code>).</p>
<p>The list of ebuild repositories with their priorities can be obtained through the output of the following commands (look for the &ldquo;Repositories&rdquo; string):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --info --verbose</span>
<span style="color:#75715e"># portageq repos_config /</span>
</code></pre></div><p>The Gentoo ebuild repository will have a priority of <code>-1000</code> which means that all other repositories generally take precedence if they are assigned a higher priority. This is the default behaviour, because ebuild repositories are designed to &ldquo;lay over&rdquo; or &ldquo;on top&rdquo; of the Gentoo repository. To set the priority of other repositories, manually edit the relevant repos.conf section and set <strong>priority =</strong> to the desired value. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/repos.conf/eselect-repo.conf</span>

<span style="color:#f92672">[</span>guru<span style="color:#f92672">]</span>
location <span style="color:#f92672">=</span> /var/db/repos/guru
sync-type <span style="color:#f92672">=</span> git
sync-uri <span style="color:#f92672">=</span> https://github.com/gentoo-mirror/guru.git
priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</code></pre></div><p>Repositories that do not have a priority set default to 0.</p>
<h3 id="repository-synchronization">Repository synchronization<a hidden class="anchor" aria-hidden="true" href="#repository-synchronization">#</a></h3>
<p>Repository synchronization is generally managed with the <strong>emaint sync</strong> command. See the <a href="https://wiki.gentoo.org/wiki/Project:Portage/Sync#Operation">Portage sync</a> article, and <strong>man emaint</strong> for information on how to use the portage synchronization commands.</p>
<p>The <strong>emerge &ndash;sync</strong> command is now only a compatibility command, calling the emaint module. <strong>eix-sync</strong> is a wrapper using <strong>emerge &ndash;sync</strong>, followed by <strong>eix-update</strong>. For further details see the <a href="https://wiki.gentoo.org/wiki/Eix">Eix</a> article and <strong>man eix</strong>.</p>
<p>The <a href="https://wiki.gentoo.org/wiki/Portage#emerge-webrsync">emerge-webrsync</a> tool can be used to download and install the daily Gentoo Repository snapshot. This may help with firewall restrictions.</p>
<h3 id="repository-management-tools">Repository management tools<a hidden class="anchor" aria-hidden="true" href="#repository-management-tools">#</a></h3>
<h4 id="eselect-repository">eselect-repository<a hidden class="anchor" aria-hidden="true" href="#eselect-repository">#</a></h4>
<p><a href="https://wiki.gentoo.org/wiki/Eselect/Repository"><strong>eselect repository</strong></a> maintains /etc/portage/repos.conf entries for Portage to access and synchronize.</p>
<h4 id="layman">Layman<a hidden class="anchor" aria-hidden="true" href="#layman">#</a></h4>
<p><a href="https://wiki.gentoo.org/wiki/Eselect/Repository"><strong>eselect repository</strong></a> supersedes layman for most uses.</p>
<h3 id="usage">Usage<a hidden class="anchor" aria-hidden="true" href="#usage">#</a></h3>
<h4 id="emerging-a-duplicate-package">Emerging a duplicate package<a hidden class="anchor" aria-hidden="true" href="#emerging-a-duplicate-package">#</a></h4>
<p>When working with ebuild repositories it is possible to encounter a situation where multiple versions of the same package are available from different ebuild repositories. Instruct <a href="https://wiki.gentoo.org/wiki/Portage">Portage</a> to install a specific package from a specific ebuild repository with the <code>::</code> <a href="https://wiki.gentoo.org/wiki/Version_specifier#By_ebuild_repository">version specifier</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask category/atom::repository-name</span>
</code></pre></div><p>The same notation can be used for different emerge instructions, including uninstalling a package through <code>--depclean</code>.</p>
<h3 id="best-practices">Best practices<a hidden class="anchor" aria-hidden="true" href="#best-practices">#</a></h3>
<h4 id="cache-generation">Cache generation<a hidden class="anchor" aria-hidden="true" href="#cache-generation">#</a></h4>
<p>When large ebuild repositories are installed, Portage may take a long time to perform operations like dependency resolution. This is because ebuild repositories do not usually contain a metadata cache.</p>
<p>Generate a local metadata cache by running <strong>emerge &ndash;regen</strong> after syncing the ebuild repositories:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emaint sync --allrepos</span>
<span style="color:#75715e"># ( ulimit -n 4096 &amp;&amp; emerge --regen )</span>
</code></pre></div><p>Be careful, because <strong>emerge &ndash;regen</strong> takes a lot of time and it&rsquo;s not recommended for rsync users as rsync updates the cache using server-side caches (most of users of portage are rsync users). Rsync users should simply run <strong>emerge &ndash;sync</strong> (or <strong>eix-sync</strong>) to regenerate the cache. It&rsquo;s probably only users of very large ebuild repositories should try <strong>emerge &ndash;regen</strong>.</p>
<h4 id="masking-enabled-ebuild-repositories">Masking enabled ebuild repositories<a hidden class="anchor" aria-hidden="true" href="#masking-enabled-ebuild-repositories">#</a></h4>
<p>When using <em>large</em> ebuild repositories or those with <em>unknown/low quality code</em>, it is best practice to hard mask the whole ebuild repository and only accept specific ebuilds on a case-by-case basis. For example, for an overlay named &ldquo;repository-foobar&rdquo;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/package.mask/repository-foobar</span>
*/*::repository-foobar
</code></pre></div><p>Then add the specific package(s) from the repository-foobar overlay so that they will be available visible to Portage for installation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/package.unmask/bar</span>
foo-category/bar::repository-name
</code></pre></div><p>After the above unmask the package named &ldquo;foo-category/bar&rdquo; should be available and none of the other packages from the repository-foobar overlay will be available, which is by design.</p>
<h2 id="zfs_freebsd-handbook-httpsdocsfreebsdorgzh-twbookshandbookzfs"><a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/">ZFS_FreeBSD Handbook </a><a hidden class="anchor" aria-hidden="true" href="#zfs_freebsd-handbook-httpsdocsfreebsdorgzh-twbookshandbookzfs">#</a></h2>
<p><em>Z 檔案系統</em> 或 ZFS 是設計來克服許多在以往設計中發現的主要問題的一個先進的檔案系統。</p>
<p>最初由 Sun™ 所開發，後來的開放源始碼 ZFS 開發已移到 <a href="http://open-zfs.org/">OpenZFS 計劃</a>。</p>
<p>ZFS 的設計目標主要有三個：</p>
<ul>
<li>資料完整性：所有資料都會有一個資料的校驗碼 (checksum)，資料寫入時會計算校驗碼然後一併寫入，往後讀取資料時會再計算一次校驗碼，若校驗碼與當初寫入時不相符，便可偵測到資料錯誤，此時若有可用的資料備援 (Data redundancy)，ZFS 會嘗試自動修正錯誤。</li>
<li>儲存池：實體的儲存裝置都會先被加入到一個儲存池 (Pool)，這個共用的儲存池可用來配置儲存空間，儲存池的空間可被所有的檔案系統使用且透過加入新的儲存裝置來增加空間。</li>
<li>效能：提供多個快取機制來增加效能。先進、以記憶體為基礎的讀取快取可使用 ARC。第二層以磁碟為基礎的讀取快取可使用 L2ARC，以磁碟為基礎的同步寫入快取則可使用 ZIL。</li>
</ul>
<p>完整的功能清單與術語在 [ZFS 特色與術語](#ZFS 特色與術語) 中有詳述。</p>
<h3 id="什麼使-zfs-與眾不同">什麼使 ZFS 與眾不同<a hidden class="anchor" aria-hidden="true" href="#什麼使-zfs-與眾不同">#</a></h3>
<p>ZFS 與以往任何的檔案系統有顯著的不同，因為它不只是一個檔案系統，ZFS 的獨特優點來自結合了以往被分開的磁碟區管理程式 (Volume Manager) 及檔案系統兩個角色，讓檔案系統也能夠察覺磁碟底層結構的變動。傳統在一個磁碟上只能建立一個檔案系統，若有兩個磁碟則會需要建立兩個分開的檔案系統，在傳統要解決這個問題要使用硬體 RAID 來製作一個空間實際上由數顆實體磁碟所組成的單一的邏輯磁碟給作業系統，作業系統便可在這個邏輯磁碟上放置檔案系統，即使是在那些使用 GEOM 提供的軟體 RAID 解決方案也是一樣，把 UFS 檔案系統放在 RAID Transform 上面當做是一個單一的裝置。ZFS 結合了磁碟區管理程式 (Volume Manager) 與檔案系統來解決這個問題並讓建立多個檔案系統可以共用一個儲存池 (Pool)。ZFS 最大的優點是可以察覺實體磁碟配置的變動，當有額外的磁碟加入到儲存池時可以自動擴增現有的檔案系統，所有的檔案系統便可使用這個新的空間。ZFS 也有數個不同的屬性可以套用到各別檔案系統上，比起單一檔案系統，對建立數個不同檔案系統與資料集 (Dataset) 時有許多的好處。</p>
<h3 id="快速入門指南">快速入門指南<a hidden class="anchor" aria-hidden="true" href="#快速入門指南">#</a></h3>
<p>這裡有一個啟動機制，可讓 FreeBSD 在系統初始化時掛載 ZFS 儲存池。要開啟這個功能，可加入此行到 <strong>/etc/rc.conf</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zfs_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YES&#34;</span>
</code></pre></div><p>然後啟動服務：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># service zfs start</span>
</code></pre></div><p>本節的例子會假設有三個 SCSI 磁碟，名稱分別為 <strong>da0</strong>, <strong>da1</strong> 及 <strong>da2</strong>。SATA 硬體的使用者裝置名稱改為 <strong>ada</strong> 。</p>
<h4 id="單磁碟儲存池">單磁碟儲存池<a hidden class="anchor" aria-hidden="true" href="#單磁碟儲存池">#</a></h4>
<p>要使用一個磁碟裝置建立一個簡單、無備援的儲存池可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool create example /dev/da0</span>
</code></pre></div><p>要檢視這個新的儲存池，可查看 <code>df</code> 的輸出結果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># df</span>
Filesystem  1K-blocks    Used    Avail Capacity  Mounted on
...
example      <span style="color:#ae81ff">17547136</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547136</span>     0%    /example
</code></pre></div><p>這個輸出結果說明 <code>example</code> 儲存池已建立且被掛載，現在已經可以作為檔案系統存取，可以在上面建立檔案且使用者可以瀏覽：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cd /example</span>
<span style="color:#75715e"># ls</span>
<span style="color:#75715e"># touch testfile</span>
<span style="color:#75715e"># ls -al</span>
total <span style="color:#ae81ff">4</span>
drwxr-xr-x   <span style="color:#ae81ff">2</span> root  wheel    <span style="color:#ae81ff">3</span> Aug <span style="color:#ae81ff">29</span> 23:15 .
drwxr-xr-x  <span style="color:#ae81ff">21</span> root  wheel  <span style="color:#ae81ff">512</span> Aug <span style="color:#ae81ff">29</span> 23:12 ..
-rw-r--r--   <span style="color:#ae81ff">1</span> root  wheel    <span style="color:#ae81ff">0</span> Aug <span style="color:#ae81ff">29</span> 23:15 testfile
</code></pre></div><p>但是，這個儲存池並未運用到任何 ZFS 功能，若要在這個儲存池上建立一個有開啟壓縮功能的資料集：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs create example/compressed</span>
<span style="color:#75715e"># zfs set compression=gzip example/compressed</span>
</code></pre></div><p><code>example/compressed</code> 資料集現在是一個 ZFS 壓縮的檔案系統，可以試著複製較大的檔案到 <strong>/example/compressed</strong>。</p>
<p>壓縮功能也可以使用以下指令關閉：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set compression=off example/compressed</span>
</code></pre></div><p>要卸載檔案系統，使用 <code>zfs umount</code> 然後再使用 <code>df</code> 確認：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs umount example/compressed</span>
<span style="color:#75715e"># df</span>
Filesystem  1K-blocks    Used    Avail Capacity  Mounted on
...
example      <span style="color:#ae81ff">17547008</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547008</span>     0%    /example
</code></pre></div><p>要重新掛載檔案系統以便再次使用，使用 <code>zfs mount</code> 然後以 <code>df</code> 檢查：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs mount example/compressed</span>
<span style="color:#75715e"># df</span>
Filesystem         1K-blocks    Used    Avail Capacity  Mounted on
...
example             <span style="color:#ae81ff">17547008</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547008</span>     0%    /example
example/compressed  <span style="color:#ae81ff">17547008</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547008</span>     0%    /example/compressed
</code></pre></div><p>儲存池與檔案系統也可以從 <code>mount</code> 的結果查詢到：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mount</span>
/dev/ad0s1a on / <span style="color:#f92672">(</span>ufs, local<span style="color:#f92672">)</span>
devfs on /dev <span style="color:#f92672">(</span>devfs, local<span style="color:#f92672">)</span>
/dev/ad0s1d on /usr <span style="color:#f92672">(</span>ufs, local, soft-updates<span style="color:#f92672">)</span>
example on /example <span style="color:#f92672">(</span>zfs, local<span style="color:#f92672">)</span>
example/compressed on /example/compressed <span style="color:#f92672">(</span>zfs, local<span style="color:#f92672">)</span>
</code></pre></div><p>在建立之後，ZFS 的資料集可如同其他檔案系統一般使用，且有許多額外功能可在每個資料集上設定。例如，建立一個預計存放重要的資料的新檔案系統 <code>data</code>，要設定每個資料區塊 (Data block) 要保留兩份備份：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs create example/data</span>
<span style="color:#75715e"># zfs set copies=2 example/data</span>
</code></pre></div><p>現在，可以使用 <code>df</code> 指令來查看資料與空間的使用率：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># df</span>
Filesystem         1K-blocks    Used    Avail Capacity  Mounted on
...
example             <span style="color:#ae81ff">17547008</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547008</span>     0%    /example
example/compressed  <span style="color:#ae81ff">17547008</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547008</span>     0%    /example/compressed
example/data        <span style="color:#ae81ff">17547008</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547008</span>     0%    /example/data
</code></pre></div><p>注意，從這個可以發現每個在儲存池上的檔案系統都擁有相同的可用空間，這是為什麼要在這些範例使用 <code>df</code> 的原因，為了要顯示檔案系統只會用它們所需要使用到的空間，且均取自同一個儲存池。ZFS 淘汰了磁碟區 (Volume) 與分割區 (Partition) 的概念，且允許多個檔案系統共用相同的儲存池。</p>
<p>不需要使用時可摧毀檔案系統後再摧毀儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs destroy example/compressed</span>
<span style="color:#75715e"># zfs destroy example/data</span>
<span style="color:#75715e"># zpool destroy example</span>
</code></pre></div><h4 id="raid-z">RAID-Z<a hidden class="anchor" aria-hidden="true" href="#raid-z">#</a></h4>
<p>磁碟損壞時，要避免資料因磁碟故障造成遺失便是使用 RAID。ZFS 在它的儲存池設計中支援了這項功能。RAID-Z 儲存池需要使用三個或更多的磁碟，但可以提供比鏡像 (Mirror) 儲存池更多的可用空間。</p>
<p>這個例子會建立一個 RAID-Z 儲存池，並指定要加入這個儲存池的磁碟：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool create storage raidz da0 da1 da2</span>
</code></pre></div><blockquote>
<p>Sun™ 建議用在 RAID-Z 設定的裝置數在三到九個之間。若需要由 10 個或更多磁碟組成單一儲存池的環境，可考慮分成較小的 RAID-Z 群組。若只有兩個可用的磁碟且需要做備援 (Redundancy)，可考慮使用 ZFS 鏡像 (Mirror)。請參考 <a href="https://www.freebsd.org/cgi/man.cgi?query=zpool&amp;sektion=8&amp;format=html">zpool(8)</a> 取得更多詳細資訊。</p>
</blockquote>
<p>先前的例子已經建立了 <code>storage</code> 儲存池 (zpool)，現在這個例子會在該儲存池中建立一個新的檔案系統，名稱為 <code>home</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs create storage/home</span>
</code></pre></div><p>可以設定開啟壓縮及保留目錄及檔案額外備份的功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set copies=2 storage/home</span>
<span style="color:#75715e"># zfs set compression=gzip storage/home</span>
</code></pre></div><p>要讓這個空間作為使用者的新家目錄位置，需複製使用者資料到這個目錄並建立適合的符號連結 (Symbolic link)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp -rp /home/* /storage/home</span>
<span style="color:#75715e"># rm -rf /home /usr/home</span>
<span style="color:#75715e"># ln -s /storage/home /home</span>
<span style="color:#75715e"># ln -s /storage/home /usr/home</span>
</code></pre></div><p>現在使用者的資料會儲存在新建立的 <strong>/storage/home</strong>，可以加入新使用者並登入該使用者來測試。</p>
<p>試著建立檔案系統快照 (Snapshot)，稍後可用來還原 (Rollback)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs snapshot storage/home@08-30-08</span>
</code></pre></div><p>快照只可以使用整個檔案系統製作，無法使用各別目錄或檔案。</p>
<p><code>@</code> 字元用來區隔檔案系統名稱 (File system) 或磁碟區 (Volume) 名稱，若有重要的目錄意外被刪除，檔案系統可以備份然後還原到先前目錄還存在時的快照 (Snapshot)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs rollback storage/home@08-30-08</span>
</code></pre></div><p>要列出所有可用的快照，可在檔案系統的 <strong>.zfs/snapshot</strong> 目錄執行 <code>ls</code>，舉例來說，要查看先前已做的快照：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ls /storage/home/.zfs/snapshot</span>
</code></pre></div><p>也可以寫一個 Script 來對使用者資料做例行性的快照，但隨著時間快照可能消耗大量的磁碟空間。先前的快照可以使用指令移除：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs destroy storage/home@08-30-08</span>
</code></pre></div><p>在測試之後，便可讓 <strong>/storage/home</strong> 成為真正的 <strong>/home</strong> 使用此指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set mountpoint=/home storage/home</span>
</code></pre></div><p>執行 <code>df</code> 興 <code>mount</code> 來確認系統現在是否以把檔案系統做為真正的 <strong>/home</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mount</span>
...
storage on /storage <span style="color:#f92672">(</span>zfs, local<span style="color:#f92672">)</span>
storage/home on /home <span style="color:#f92672">(</span>zfs, local<span style="color:#f92672">)</span>
<span style="color:#75715e"># df</span>
Filesystem   1K-blocks    Used    Avail Capacity  Mounted on
...
storage       <span style="color:#ae81ff">26320512</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">26320512</span>     0%    /storage
storage/home  <span style="color:#ae81ff">26320512</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">26320512</span>     0%    /home
</code></pre></div><p>這個動作完成 RAID-Z 最後的設定，有關已建立的檔案系統每日狀態更新可以做為 <a href="https://www.freebsd.org/cgi/man.cgi?query=periodic&amp;sektion=8&amp;format=html">periodic(8)</a> 的一部份在每天晚上執行。加入此行到 <strong>/etc/periodic.conf</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">daily_status_zfs_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YES&#34;</span>
</code></pre></div><h4 id="復原-raid-z">復原 RAID-Z<a hidden class="anchor" aria-hidden="true" href="#復原-raid-z">#</a></h4>
<p>每個軟體 RAID 都有監控其狀態 (<code>state</code>) 的方式，而 RAID-Z 裝置的狀態可以使用這個指令來查看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status -x</span>
</code></pre></div><p>如果所有儲存池為上線 (Online) 且正常，則訊息會顯示：</p>
<pre tabindex="0"><code>all pools are healthy
</code></pre><p>如果有發生問題，可能磁碟會呈現離線 (Offline) 的狀態，此時儲存池的狀態會是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">  pool: storage
 state: DEGRADED
status: One or more devices has been taken offline by the administrator.
	Sufficient replicas exist <span style="color:#66d9ef">for</span> the pool to <span style="color:#66d9ef">continue</span> functioning in a
	degraded state.
action: Online the device using <span style="color:#e6db74">&#39;zpool online&#39;</span> or replace the device with
	<span style="color:#e6db74">&#39;zpool replace&#39;</span>.
 scrub: none requested
config:

	NAME        STATE     READ WRITE CKSUM
	storage     DEGRADED     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	  raidz1    DEGRADED     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da1     OFFLINE      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da2     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>這代表著裝置在之前被管理者使用此指令拿下線：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool offline storage da1</span>
</code></pre></div><p>現在系統可以關機然後更換 <strong>da1</strong>，當系統恢復上線，則可以替換掉儲存池中故障的磁碟：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool replace storage da1</span>
</code></pre></div><p>到這裡，可以再檢查狀態一次，這時不需使用 <code>-x</code> 參數來顯示所有的儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status storage</span>
 pool: storage
 state: ONLINE
 scrub: resilver completed with <span style="color:#ae81ff">0</span> errors on Sat Aug <span style="color:#ae81ff">30</span> 19:44:11 <span style="color:#ae81ff">2008</span>
config:

	NAME        STATE     READ WRITE CKSUM
	storage     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	  raidz1    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da2     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>在這個例子中，所有的磁碟均已正常運作。</p>
<h4 id="資料檢驗">資料檢驗<a hidden class="anchor" aria-hidden="true" href="#資料檢驗">#</a></h4>
<p>ZFS 使用校驗碼 (Checksum) 來檢驗資料的完整性 (Integrity)，會在建立檔案系統時便自動開啟。</p>
<blockquote>
<p>校驗碼 (Checksum) 可以關閉，但並<em>不</em>建議！校驗碼只會使用非常少的儲存空間來確保資料的完整性。若關閉校驗碼會使許多 ZFS 功能無法正常運作，且關閉校驗碼對並不會明顯的改善效能。</p>
</blockquote>
<p>檢驗校驗碼這個動作即所謂的<em>清潔 (Scrub)</em>，可以使用以下指令來檢驗 <code>storage</code> 儲存池的資料完整性：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool scrub storage</span>
</code></pre></div><p>清潔所需要的時間依儲存的資料量而定，較大的資料量相對會需要花費較長的時間來檢驗。清潔會對 I/O 有非常密集的操作且一次只能進行一個清潔動作。在清潔完成之後，可以使用 <code>status</code> 來查看狀態：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status storage</span>
 pool: storage
 state: ONLINE
 scrub: scrub completed with <span style="color:#ae81ff">0</span> errors on Sat Jan <span style="color:#ae81ff">26</span> 19:57:37 <span style="color:#ae81ff">2013</span>
config:

	NAME        STATE     READ WRITE CKSUM
	storage     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	  raidz1    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da2     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>查詢結果會顯示上次完成清潔的時間來協助追蹤是否要再做清潔。定期清潔可以協助保護資料不會默默損壞且確保儲存池的完整性。</p>
<p>請參考 <a href="https://www.freebsd.org/cgi/man.cgi?query=zfs&amp;sektion=8&amp;format=html">zfs(8)</a> 及 <a href="https://www.freebsd.org/cgi/man.cgi?query=zpool&amp;sektion=8&amp;format=html">zpool(8)</a> 來取得其他 ZFS 選項。</p>
<h3 id="zpool-管理"><code>zpool</code> 管理<a hidden class="anchor" aria-hidden="true" href="#zpool-管理">#</a></h3>
<p>ZFS 管理分成兩個主要的工具。<code>zpool</code> 工具用來控制儲存池的運作並可處理磁碟的新增、移除、更換與管理。[<code>zfs</code>](#<code>zfs</code> 管理) 工具用來建立、摧毀與管理檔案系統 (File system) 與磁碟區 (Volume) 的資料集。</p>
<h4 id="建立與摧毀儲存池">建立與摧毀儲存池<a hidden class="anchor" aria-hidden="true" href="#建立與摧毀儲存池">#</a></h4>
<p>建立 ZFS 儲存池 (<em>zpool</em>) 要做幾個涉及長遠規劃的決定，因為建立儲存池之後便無法再更改儲存池的結構。最重要的決定是要使用那一種型態的 vdev 來將實體磁碟設為同一群組。請參考 vdev 型態 的清單來取得有關可用選項的詳細資訊。大部份的 vdev 型態不允許在建立儲存池之後再加入額外的磁碟，鏡像 (Mirror) 是可以允許加入額外的磁碟到 vdev 的其中一個例外，另一個則是串連 (Stripe)，可以加入額外的磁碟到 vdev 來升級為鏡像。雖然可以加入額外的 vdev 來擴充儲存池，但儲存池的配置在建立之後便無法更改，若要要更改，則必須先備份資料，把儲存池摧毀後再重新建立。</p>
<p>建立一個簡單的鏡像儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool create mypool mirror /dev/ada1 /dev/ada2</span>
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>可以一次建立數個 vdev，磁碟群組間使用 vdev 型態關鍵字來區隔，在這個例子使用 <code>mirror</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool create mypool mirror /dev/ada1 /dev/ada2 mirror /dev/ada3 /dev/ada4</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-1  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada3    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada4    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>儲存池也可以不使用整個磁碟而改使用分割區 (Partition) 來建立。把 ZFS 放到不同的分割區可讓同一個磁碟有其他的分割區可做其他用途，尤其是有 Bootcode 與檔案系統要用來開機的分割區，這讓磁碟可以用來開機也同樣可以做為儲存池的一部份。在 FreeBSD 用分割區來替代整個磁碟並不會對效能有影響。使用分割區也讓管理者可以對磁碟容量做 <em>少算的預備</em>，使用比完整容量少的容量，未來若要替換的磁碟號稱與原磁碟相同，但實際上卻比較小時，也可符合這個較小的分割區容量，以使用替換的磁碟。</p>
<p>使用分割區建立一個 RAID-Z2 儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool create mypool raidz2 /dev/ada0p3 /dev/ada1p3 /dev/ada2p3 /dev/ada3p3 /dev/ada4p3 /dev/ada5p3</span>
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          raidz2-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada3p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada4p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada5p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>不需使用的儲存池可以摧毀，來讓磁碟可以再次使用。摧毀一個儲存池要先卸載所有該儲存池的資料集。若資料集在使用中，卸載的操作會失敗且儲存池不會被摧毀。儲存池的摧毀可以使用 <code>-f</code> 來強制執行，但這可能造成那些有開啟這些資料集之中檔案的應用程式無法辨識的行為。</p>
<h4 id="加入與移除裝置">加入與移除裝置<a hidden class="anchor" aria-hidden="true" href="#加入與移除裝置">#</a></h4>
<p>加入磁碟到儲存池 (zpool) 會有兩種情形：使用 <code>zpool attach</code> 加入一個磁碟到既有的 vdev，或使用 <code>zpool add</code> 加入 vdev 到儲存池。只有部份 vdev 型態 允許在 vdev 建立之後加入磁碟。</p>
<p>由單一磁碟所建立的儲存池缺乏備援 (Redundancy) 功能，可以偵測到資料的損壞但無法修復，因為資料沒有其他備份可用。備份數 (Copies) 屬性可以讓您從較小的故障中復原，如磁碟壞軌 (Bad sector)，但無法提供與鏡像或 RAID-Z 同樣層級的保護。由單一磁碟所建立的儲存池可以使用 <code>zpool attach</code> 來加入額外的磁碟到 vdev，來建立鏡像。<code>zpool attach</code> 也可用來加入額外的磁碟到鏡像群組，來增加備援與讀取效率。若使用的磁碟已有分割區，可以複製該磁碟的分割區配置到另一個，使用 <code>gpart backup</code> 與 <code>gpart restore</code> 可讓這件事變的很簡單。</p>
<p>加入 <em>ada1p3</em> 來升級單一磁碟串連 (stripe) vdev <em>ada0p3</em> 採用鏡像型態 (mirror)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          ada0p3    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool attach mypool ada0p3 ada1p3</span>
Make sure to wait <span style="color:#66d9ef">until</span> resilver is <span style="color:#66d9ef">done</span> before rebooting.

If you boot from pool <span style="color:#e6db74">&#39;mypool&#39;</span>, you may need to update
boot code on newly attached disk <span style="color:#e6db74">&#39;ada1p3&#39;</span>.

Assuming you use GPT partitioning and <span style="color:#e6db74">&#39;da0&#39;</span> is your new boot disk
you may use the following command:

        gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i <span style="color:#ae81ff">1</span> da0
<span style="color:#75715e"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1</span>
bootcode written to ada1
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
status: One or more devices is currently being resilvered.  The pool will
        <span style="color:#66d9ef">continue</span> to <span style="color:#66d9ef">function</span>, possibly in a degraded state.
action: Wait <span style="color:#66d9ef">for</span> the resilver to complete.
  scan: resilver in progress since Fri May <span style="color:#ae81ff">30</span> 08:19:19 <span style="color:#ae81ff">2014</span>
        527M scanned out of 781M at 47.9M/s, 0h0m to go
        527M resilvered, 67.53% <span style="color:#66d9ef">done</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>resilvering<span style="color:#f92672">)</span>

errors: No known data errors
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with <span style="color:#ae81ff">0</span> errors on Fri May <span style="color:#ae81ff">30</span> 08:15:58 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>若不想選擇加入磁碟到既有的 vdev ，對 RAID-Z 來說，可選擇另一種方式，便是加入另一個 vdev 到儲存池。額外的 vdev 可以提供更高的效能，分散寫入資料到 vdev 之間，每個 vdev 會負責自己的備援。也可以混合使用不同的 vdev 型態，但並不建議，例如混合使用 <code>mirror</code> 與 <code>RAID-Z</code>，加入一個無備援的 vdev 到一個含有 mirror 或 RAID-Z vdev 的儲存池會讓資料損壞的風險擴大整個儲存池，由於會分散寫入資料，若在無備援的磁碟上發生故障的結果便是遺失大半寫到儲存池的資料區塊。</p>
<p>在每個 vdev 間的資料是串連的，例如，有兩個 mirror vdev，便跟 RAID 10 一樣在兩個 mirror 間分散寫入資料，且會做空間的分配，因此 vdev 會在同時達到全滿 100% 的用量。若 vdev 間的可用空間量不同則會影響到效能，因為資料量會不成比例的寫入到使用量較少的 vdev。</p>
<p>當連接額外的裝置到一個可以開機的儲存池，要記得更新 Bootcode。</p>
<p>連接第二個 mirror 群組 (<strong>ada2p3</strong> 及 <strong>ada3p3</strong>) 到既有的 mirror：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with <span style="color:#ae81ff">0</span> errors on Fri May <span style="color:#ae81ff">30</span> 08:19:35 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool add mypool mirror ada2p3 ada3p3</span>
<span style="color:#75715e"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2</span>
bootcode written to ada2
<span style="color:#75715e"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada3</span>
bootcode written to ada3
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub repaired <span style="color:#ae81ff">0</span> in 0h0m with <span style="color:#ae81ff">0</span> errors on Fri May <span style="color:#ae81ff">30</span> 08:29:51 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-1  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada3p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>現在已無法從儲存池上移除 vdev，且磁碟只能夠在有足夠備援空間的情況下從 mirror 移除，若在 mirror 群組中只剩下一個磁碟，便會取消 mirror 然後還原為 stripe，若剩下的那個磁碟故障，便會影響到整個儲存池。</p>
<p>從一個三方 mirror 群組移除一個磁碟：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub repaired <span style="color:#ae81ff">0</span> in 0h0m with <span style="color:#ae81ff">0</span> errors on Fri May <span style="color:#ae81ff">30</span> 08:29:51 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool detach mypool ada2p3</span>
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub repaired <span style="color:#ae81ff">0</span> in 0h0m with <span style="color:#ae81ff">0</span> errors on Fri May <span style="color:#ae81ff">30</span> 08:29:51 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><h4 id="檢查儲存池狀態">檢查儲存池狀態<a hidden class="anchor" aria-hidden="true" href="#檢查儲存池狀態">#</a></h4>
<p>儲存池的狀態很重要，若有磁碟機離線或偵測到讀取、寫入或校驗碼 (Checksum) 錯誤，對應的錯誤計數便會增加。<code>status</code> 會顯示儲存池中每一個磁碟機的設定與狀態及整個儲存池的狀態。需要處置的方式與有關最近清潔 (<a href="#%E6%B8%85%E6%BD%94%E5%84%B2%E5%AD%98%E6%B1%A0"><code>Scrub</code></a>) 的詳細資訊也會一併顯示。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub repaired <span style="color:#ae81ff">0</span> in 2h25m with <span style="color:#ae81ff">0</span> errors on Sat Sep <span style="color:#ae81ff">14</span> 04:25:50 <span style="color:#ae81ff">2013</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          raidz2-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada3p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada4p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada5p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><h4 id="清除錯誤">清除錯誤<a hidden class="anchor" aria-hidden="true" href="#清除錯誤">#</a></h4>
<p>當偵測到錯誤發生，讀取、寫入或校驗碼 (Checksum) 的計數便會增加。使用 <code>zpool clear mypool</code> 可以清除錯誤訊息及重置計數。清空錯誤狀態對當儲存池發生錯誤要使用自動化 Script 通知的管理者來說會很重要，因在舊的錯誤尚未清除前不會回報後續的錯誤。</p>
<h4 id="更換運作中的裝置">更換運作中的裝置<a hidden class="anchor" aria-hidden="true" href="#更換運作中的裝置">#</a></h4>
<p>可能有一些情況會需要更換磁碟為另一個磁碟，當要更換運作中的磁碟，此程序會維持舊有的磁碟在更換的過程為上線的狀態，儲存池不會進入降級 (Degraded) 的狀態，來減少資料遺失的風險。<code>zpool replace</code> 會複製所有舊磁碟的資料到新磁碟，操作完成之後舊磁碟便會與 vdev 中斷連線。若新磁碟容量較舊磁碟大，也可以會增加儲存池來使用新的空間，請參考 <a href="#%E6%93%B4%E5%A2%9E%E5%84%B2%E5%AD%98%E6%B1%A0">擴增儲存池</a>。</p>
<p>更換儲存池中正在運作的狀置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool replace mypool ada1p3 ada2p3</span>
Make sure to wait <span style="color:#66d9ef">until</span> resilver is <span style="color:#66d9ef">done</span> before rebooting.

If you boot from pool <span style="color:#e6db74">&#39;zroot&#39;</span>, you may need to update
boot code on newly attached disk <span style="color:#e6db74">&#39;ada2p3&#39;</span>.

Assuming you use GPT partitioning and <span style="color:#e6db74">&#39;da0&#39;</span> is your new boot disk
you may use the following command:

        gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i <span style="color:#ae81ff">1</span> da0
<span style="color:#75715e"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2</span>
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
status: One or more devices is currently being resilvered.  The pool will
        <span style="color:#66d9ef">continue</span> to <span style="color:#66d9ef">function</span>, possibly in a degraded state.
action: Wait <span style="color:#66d9ef">for</span> the resilver to complete.
  scan: resilver in progress since Mon Jun  <span style="color:#ae81ff">2</span> 14:21:35 <span style="color:#ae81ff">2014</span>
        604M scanned out of 781M at 46.5M/s, 0h0m to go
        604M resilvered, 77.39% <span style="color:#66d9ef">done</span>
config:

        NAME             STATE     READ WRITE CKSUM
        mypool           ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0       ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3       ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            replacing-1  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
              ada1p3     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
              ada2p3     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>resilvering<span style="color:#f92672">)</span>

errors: No known data errors
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with <span style="color:#ae81ff">0</span> errors on Mon Jun  <span style="color:#ae81ff">2</span> 14:21:52 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><h4 id="處理故障裝置">處理故障裝置<a hidden class="anchor" aria-hidden="true" href="#處理故障裝置">#</a></h4>
<p>當儲存池中的磁碟故障，該故障硬碟所屬的 vdev 便會進入降級 (Degraded) 狀態，所有的資料仍可使用，但效能可能會降低，因為遺失的資料必須從可用的備援資料計算才能取得。要將 vdev 恢復完整運作的狀態必須更換故障的實體裝置。然後 ZFS 便會開始修復 (Resilver，古代鏡子的修復稱 Resilver) 作業，會從可用的備援資料計算出故障磁碟中的資料並寫入到替換的裝置上。完成後 vdev 便會重新返回上線 (Online) 的狀態。</p>
<p>若 vdev 沒有任何備援資料或有多個裝置故障，沒有足夠的備援資料可以補償，儲存池便會進入故障 (Faulted) 的狀態。</p>
<p>更換故障的磁碟時，故障磁碟的名稱會更換為裝置的 GUID，若替換裝置要使用相同的裝置名稱，則在 <code>zpool replace</code> 不須加上新裝置名稱參數。</p>
<p>使用 <code>zpool replace</code> 更換故障的磁碟：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: DEGRADED
status: One or more devices could not be opened.  Sufficient replicas exist <span style="color:#66d9ef">for</span>
        the pool to <span style="color:#66d9ef">continue</span> functioning in a degraded state.
action: Attach the missing device and online it using <span style="color:#e6db74">&#39;zpool online&#39;</span>.
   see: http://illumos.org/msg/ZFS-8000-2Q
  scan: none requested
config:

        NAME                    STATE     READ WRITE CKSUM
        mypool                  DEGRADED     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0              DEGRADED     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3              ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            <span style="color:#ae81ff">316502962686821739</span>  UNAVAIL      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  was /dev/ada1p3

errors: No known data errors
<span style="color:#75715e"># zpool replace mypool 316502962686821739 ada2p3</span>
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: DEGRADED
status: One or more devices is currently being resilvered.  The pool will
        <span style="color:#66d9ef">continue</span> to <span style="color:#66d9ef">function</span>, possibly in a degraded state.
action: Wait <span style="color:#66d9ef">for</span> the resilver to complete.
  scan: resilver in progress since Mon Jun  <span style="color:#ae81ff">2</span> 14:52:21 <span style="color:#ae81ff">2014</span>
        641M scanned out of 781M at 49.3M/s, 0h0m to go
        640M resilvered, 82.04% <span style="color:#66d9ef">done</span>
config:

        NAME                        STATE     READ WRITE CKSUM
        mypool                      DEGRADED     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0                  DEGRADED     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3                  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            replacing-1             UNAVAIL      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
              <span style="color:#ae81ff">15732067398082357289</span>  UNAVAIL      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  was /dev/ada1p3/old
              ada2p3                ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>resilvering<span style="color:#f92672">)</span>

errors: No known data errors
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with <span style="color:#ae81ff">0</span> errors on Mon Jun  <span style="color:#ae81ff">2</span> 14:52:38 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><h4 id="清潔儲存池">清潔儲存池<a hidden class="anchor" aria-hidden="true" href="#清潔儲存池">#</a></h4>
<p>建議儲存池要定期清潔 (Scrub)，最好是每一個月清潔一次。 <code>scrub</code> 作業對磁碟操作非常的密集，在執行時會降低磁碟的效能。在排程 <code>scrub</code> 時避免在使用高峰的時期，或使用 <code>vfs.zfs.scrub_delay</code> 來調整 <code>scrub</code> 的相對優先權來避免影響其他的工作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool scrub mypool</span>
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub in progress since Wed Feb <span style="color:#ae81ff">19</span> 20:52:54 <span style="color:#ae81ff">2014</span>
        116G scanned out of 8.60T at 649M/s, 3h48m to go
        <span style="color:#ae81ff">0</span> repaired, 1.32% <span style="color:#66d9ef">done</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          raidz2-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada3p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada4p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada5p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>若發生需要取消清潔作業的事，可以下 <code>zpool scrub -s mypool</code>。</p>
<h4 id="自我修復">自我修復<a hidden class="anchor" aria-hidden="true" href="#自我修復">#</a></h4>
<p>校驗碼 (Checksum) 會隨資料區塊一併儲存，這使得檔案系統可以做到<em>自我修復</em>。這個功能可以在校驗碼與儲存池中的另一個裝置不同時自動修復資料。舉例來說，有兩個磁碟做鏡像 (Mirror)，其中一個磁碟機開始失常並無法正常儲存資料，甚至是資料放在長期封存的儲存裝置上，已經很久沒有被存取。傳統的檔案系統需要執行演算法來檢查並修復資料如 <a href="https://www.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a>，這些指令耗費時間，且在嚴重時需要管理者手動決定要做那一種修復操作。當 ZFS 偵測到資料區塊的校驗碼不對時，它除了把資料交給需要的應用程式外，也會修正在磁碟上錯誤的資料。這件事不需要與系統管理者作任何互動便會在一般的儲存池操作時完成。</p>
<p>接下來的例子會示範自我修復會如何運作。建立一個使用磁碟 <strong>/dev/ada0</strong> 及 <strong>/dev/ada1</strong> 做鏡像的儲存池。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool create healer mirror /dev/ada0 /dev/ada1</span>
<span style="color:#75715e"># zpool status healer</span>
  pool: healer
 state: ONLINE
  scan: none requested
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
      mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool list</span>
NAME     SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG   CAP  DEDUP  HEALTH  ALTROOT
healer   960M  92.5K   960M         -         -     0%    0%  1.00x  ONLINE  -
</code></pre></div><p>將部份需要使用自我修復功能來保護的重要資料複製到該儲存池，建立一個儲存池的校驗碼供稍後做比較時使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /some/important/data /healer</span>
<span style="color:#75715e"># zfs list</span>
NAME     SIZE  ALLOC   FREE    CAP  DEDUP  HEALTH  ALTROOT
healer   960M  67.7M   892M     7%  1.00x  ONLINE  -
<span style="color:#75715e"># sha1 /healer &gt; checksum.txt</span>
<span style="color:#75715e"># cat checksum.txt</span>
SHA1 <span style="color:#f92672">(</span>/healer<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 2753eff56d77d9a536ece6694bf0a82740344d1f
</code></pre></div><p>寫入隨機的資料到鏡像的第一個磁碟來模擬資料損毀的情況。要避免 ZFS 偵測到錯誤時馬上做修復，接著要將儲存池匯出，待模擬資料損毀之後再匯入。</p>
<blockquote>
<p>這是一個危險的操作，會破壞重要的資料。在這裡使用僅為了示範用，不應在儲存池正常運作時嘗試使用，也不應將這個故意損壞資料的例子用在任何其他的檔案系統上，所以請勿使用任何不屬於該儲存池的其他磁碟裝置名稱並確定在執行指令前已對儲存池做正確的備份！</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool export healer</span>
<span style="color:#75715e"># dd if=/dev/random of=/dev/ada1 bs=1m count=200</span>
200+0 records in
200+0 records out
<span style="color:#ae81ff">209715200</span> bytes transferred in 62.992162 secs <span style="color:#f92672">(</span><span style="color:#ae81ff">3329227</span> bytes/sec<span style="color:#f92672">)</span>
<span style="color:#75715e"># zpool import healer</span>
</code></pre></div><p>儲存池的狀態顯示有一個裝置發生了錯誤。注意，應用程式從儲存池讀取的資料中並沒有任何的錯誤資料，ZFS 會自 <strong>ada0</strong> 裝置提供有正確校驗碼的資料。結果裡面 <code>CKSUM</code> 欄位含有非零值便是有錯誤校驗碼的裝置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status healer</span>
    pool: healer
   state: ONLINE
  status: One or more devices has experienced an unrecoverable error.  An
          attempt was made to correct the error.  Applications are unaffected.
  action: Determine <span style="color:#66d9ef">if</span> the device needs to be replaced, and clear the errors
          using <span style="color:#e6db74">&#39;zpool clear&#39;</span> or replace the device with <span style="color:#e6db74">&#39;zpool replace&#39;</span>.
     see: http://illumos.org/msg/ZFS-8000-4J
    scan: none requested
  config:

      NAME        STATE     READ WRITE CKSUM
      healer      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
        mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
         ada0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
         ada1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">1</span>

errors: No known data errors
</code></pre></div><p>錯誤已經被偵測到並且由未被影響的 <strong>ada0</strong> 鏡像磁碟上的備援提供資料。可與原來的校驗碼做比較來看儲存池是否已修復為一致。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># sha1 /healer &gt;&gt; checksum.txt</span>
<span style="color:#75715e"># cat checksum.txt</span>
SHA1 <span style="color:#f92672">(</span>/healer<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 2753eff56d77d9a536ece6694bf0a82740344d1f
SHA1 <span style="color:#f92672">(</span>/healer<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 2753eff56d77d9a536ece6694bf0a82740344d1f
</code></pre></div><p>儲存池在故意竄改資料前與後的兩個校驗碼仍相符顯示了 ZFS 在校驗碼不同時偵測與自動修正錯誤的能力。注意，這只在當儲存池中有足夠的備援時才可做到，由單一裝置組成的儲存池並沒有自我修復的能力。這也是為什麼在 ZFS 中校驗碼如此重要，任何原因都不該關閉。不需要 <a href="https://www.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a> 或類似的檔案系統一致性檢查程式便能夠偵測與修正問題，且儲存儲存池在發生問題時仍可正常運作。接著需要做清潔作業來覆蓋在 <strong>ada1</strong> 上的錯誤資料。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool scrub healer</span>
<span style="color:#75715e"># zpool status healer</span>
  pool: healer
 state: ONLINE
status: One or more devices has experienced an unrecoverable error.  An
            attempt was made to correct the error.  Applications are unaffected.
action: Determine <span style="color:#66d9ef">if</span> the device needs to be replaced, and clear the errors
            using <span style="color:#e6db74">&#39;zpool clear&#39;</span> or replace the device with <span style="color:#e6db74">&#39;zpool replace&#39;</span>.
   see: http://illumos.org/msg/ZFS-8000-4J
  scan: scrub in progress since Mon Dec <span style="color:#ae81ff">10</span> 12:23:30 <span style="color:#ae81ff">2012</span>
        10.4M scanned out of 67.0M at 267K/s, 0h3m to go
        9.63M repaired, 15.56% <span style="color:#66d9ef">done</span>
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
      mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">627</span>  <span style="color:#f92672">(</span>repairing<span style="color:#f92672">)</span>

errors: No known data errors
</code></pre></div><p>清潔作業會從 <strong>ada0</strong> 讀取資料並重新寫入任何在 <strong>ada1</strong> 上有錯誤校驗碼的資料。這個操作可以由 <code>zpool status</code> 的輸出中呈現修復中 <code>(repairing)</code> 的項目來辨識。這個作業完成後，儲存池的狀態會更改為：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status healer</span>
  pool: healer
 state: ONLINE
status: One or more devices has experienced an unrecoverable error.  An
        attempt was made to correct the error.  Applications are unaffected.
action: Determine <span style="color:#66d9ef">if</span> the device needs to be replaced, and clear the errors
             using <span style="color:#e6db74">&#39;zpool clear&#39;</span> or replace the device with <span style="color:#e6db74">&#39;zpool replace&#39;</span>.
   see: http://illumos.org/msg/ZFS-8000-4J
  scan: scrub repaired 66.5M in 0h2m with <span style="color:#ae81ff">0</span> errors on Mon Dec <span style="color:#ae81ff">10</span> 12:26:25 <span style="color:#ae81ff">2012</span>
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
      mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> 2.72K

errors: No known data errors
</code></pre></div><p>清潔操作完成便同步了 <strong>ada0</strong> 到 <strong>ada1</strong> 間的所有資料。執行 <code>zpool clear</code> 可以清除 (<a href="#%E6%B8%85%E9%99%A4%E9%8C%AF%E8%AA%A4">Clear</a>) 儲存池狀態的錯誤訊息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool clear healer</span>
<span style="color:#75715e"># zpool status healer</span>
  pool: healer
 state: ONLINE
  scan: scrub repaired 66.5M in 0h2m with <span style="color:#ae81ff">0</span> errors on Mon Dec <span style="color:#ae81ff">10</span> 12:26:25 <span style="color:#ae81ff">2012</span>
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
      mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>儲存池現在恢復完整運作的狀態且清除所有的錯誤了。</p>
<h4 id="擴增儲存池">擴增儲存池<a hidden class="anchor" aria-hidden="true" href="#擴增儲存池">#</a></h4>
<p>可用的備援儲存池大小會受到每個 vdev 中容量最小的裝置限制。最小的裝置可以替換成較大的裝置，在更換 (Replace) 或修復 (Resilver) 作業後，儲存池可以成長到該新裝置的可用容量。例如，要做一個 1 TB 磁碟機與一個 2 TB 磁碟機的鏡像，可用的空間會是 1 TB，當 1 TB 磁碟機備更換成另一個 2 TB 的磁碟機時，修復程序會複製既有的資料到新的磁碟機，由於現在兩個裝置都有 2 TB 的容量，所以鏡像的可用空間便會成長到 2 TB。</p>
<p>可以在每個裝置用 <code>zpool online -e</code> 來觸發擴充的動作，在擴充完所有裝置後，儲存池便可使用額外的空間。</p>
<h4 id="匯入與匯出儲存池">匯入與匯出儲存池<a hidden class="anchor" aria-hidden="true" href="#匯入與匯出儲存池">#</a></h4>
<p>儲存池在移動到其他系統之前需要做匯出 (<em>Export</em>)，會卸載所有的資料集，然後標記每個裝置為已匯出，為了避免被其他磁碟子系統存取，因此仍會鎖定這些裝置。這個動作讓儲存池可以在支援 ZFS 的其他機器、其他作業系統做匯入 (<em>Import</em>)，甚至是不同的硬體架構 (有一些注意事項，請參考 <a href="https://www.freebsd.org/cgi/man.cgi?query=zpool&amp;sektion=8&amp;format=html">zpool(8)</a>)。當資料集有被開啟的檔案，可使用 <code>zpool export -f</code> 來強制匯出儲存池，使用這個指令需要小心，資料集是被強制卸載的，因此有可能造成在該資料集開啟檔案的應用程式發生無法預期的結果。</p>
<p>匯出未使用的儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool export mypool</span>
</code></pre></div><p>匯入儲存池會自動掛載資料集，若不想自動掛載，可以使用 <code>zpool import -N</code>。<code>zpool import -o</code> 可以設定在匯入時暫時使用的屬性。<code>zpool import altroot=</code> 允許匯入時指定基礎掛載點 (Base mount point) 來替換檔案系統根目錄。若儲存池先前用在不同的系統且不正常匯出，可能會需要使用 <code>zpool import -f</code> 來強制匯入。<code>zpool import -a</code> 會匯入所有沒有被其他系統使用的儲存池。</p>
<p>列出所有可以匯入的儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool import</span>
   pool: mypool
     id: <span style="color:#ae81ff">9930174748043525076</span>
  state: ONLINE
 action: The pool can be imported using its name or numeric identifier.
 config:

        mypool      ONLINE
          ada2p3    ONLINE
</code></pre></div><p>使用替代的根目錄匯入儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool import -o altroot=/mnt mypool</span>
<span style="color:#75715e"># zfs list</span>
zfs list
NAME                 USED  AVAIL  REFER  MOUNTPOINT
mypool               110K  47.0G    31K  /mnt/mypool
</code></pre></div><h4 id="升級儲存儲存池">升級儲存儲存池<a hidden class="anchor" aria-hidden="true" href="#升級儲存儲存池">#</a></h4>
<p>在升級 FreeBSD 之後或儲存池是由其他使用舊版 ZFS 的系統匯入，儲存池可以手動升級到最新版本的 ZFS 來支援新的功能。在升級前請評估儲存池是否還要在舊的系統做匯入，由於升級是一個單向的程序，舊的儲存池可以升級，但有新功能的儲存池無法降級。</p>
<p>升級一個 v28 的儲存以支援功能旗標 (<code>Feature Flags</code>)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
status: The pool is formatted using a legacy on-disk format.  The pool can
        still be used, but some features are unavailable.
action: Upgrade the pool using <span style="color:#e6db74">&#39;zpool upgrade&#39;</span>.  Once this is <span style="color:#66d9ef">done</span>, the
        pool will no longer be accessible on software that does not support feat
        flags.
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    ada0    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    ada1    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool upgrade</span>
This system supports ZFS pool feature flags.

The following pools are formatted with legacy version numbers and can
be upgraded to use feature flags.  After being upgraded, these pools
will no longer be accessible by software that does not support feature
flags.

VER  POOL
---  ------------
<span style="color:#ae81ff">28</span>   mypool

Use <span style="color:#e6db74">&#39;zpool upgrade -v&#39;</span> <span style="color:#66d9ef">for</span> a list of available legacy versions.
Every feature flags pool has all supported features enabled.
<span style="color:#75715e"># zpool upgrade mypool</span>
This system supports ZFS pool feature flags.

Successfully upgraded <span style="color:#e6db74">&#39;mypool&#39;</span> from version <span style="color:#ae81ff">28</span> to feature flags.
Enabled the following features on <span style="color:#e6db74">&#39;mypool&#39;</span>:
  async_destroy
  empty_bpobj
  lz4_compress
  multi_vdev_crash_dump
</code></pre></div><p>ZFS 的新功能在 <code>zpool upgrade</code> 尚未完成之前無法使用。可以用 <code>zpool upgrade -v</code> 來查看升級後有那些新功能，也同時會列出已經支援那些功能。</p>
<p>升級儲存池支援新版的功能旗標 (Feature flags)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
status: Some supported features are not enabled on the pool. The pool can
        still be used, but some features are unavailable.
action: Enable all features using <span style="color:#e6db74">&#39;zpool upgrade&#39;</span>. Once this is <span style="color:#66d9ef">done</span>,
        the pool may no longer be accessible by software that does not support
        the features. See zpool-features<span style="color:#f92672">(</span>7<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> details.
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    ada0    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    ada1    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool upgrade</span>
This system supports ZFS pool feature flags.

All pools are formatted using feature flags.

Some supported features are not enabled on the following pools. Once a
feature is enabled the pool may become incompatible with software
that does not support the feature. See zpool-features<span style="color:#f92672">(</span>7<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> details.

POOL  FEATURE
---------------
zstore
      multi_vdev_crash_dump
      spacemap_histogram
      enabled_txg
      hole_birth
      extensible_dataset
      bookmarks
      filesystem_limits
<span style="color:#75715e"># zpool upgrade mypool</span>
This system supports ZFS pool feature flags.

Enabled the following features on <span style="color:#e6db74">&#39;mypool&#39;</span>:
  spacemap_histogram
  enabled_txg
  hole_birth
  extensible_dataset
  bookmarks
  filesystem_limits
</code></pre></div><blockquote>
<p>在使用儲存池來開機的系統上的 Boot code 也必須一併更新來支援新的儲存池版本，可在含有 Boot code 的分割區使用 <code>gpart bootcode</code> 來更新。目前有兩種 Boot code 可使用，需視系統開機的方式使用：GPT (最常用的選項) 以及 EFI (較新的系統)。針對傳統使用 GPT 開機的系統，可以使用以下指令：<code># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1</code>針對使用 EFI 開機的系統可以執行以下指令：<code># gpart bootcode -p /boot/boot1.efifat -i 1 ada1</code>套用 Boot code 到所有儲存池中可開機的磁碟。請參考 <a href="https://www.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a> 以取得更多資訊。</p>
</blockquote>
<h4 id="顯示已記錄的儲存池歷史日誌">顯示已記錄的儲存池歷史日誌<a hidden class="anchor" aria-hidden="true" href="#顯示已記錄的儲存池歷史日誌">#</a></h4>
<p>修改儲存池的指令會被記錄下來，會記錄的動作包含資料集的建立，屬性更改或更換磁碟。這個歷史記錄用來查看儲存池是如何建立、由誰執行、什麼動作及何時。歷史記錄並非儲存在日誌檔 (Log file)，而是儲存在儲存池。查看這個歷史記錄的指令名稱為 <code>zpool history</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool history</span>
History <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;tank&#39;</span>:
2013-02-26.23:02:35 zpool create tank mirror /dev/ada0 /dev/ada1
2013-02-27.18:50:58 zfs set atime<span style="color:#f92672">=</span>off tank
2013-02-27.18:51:09 zfs set checksum<span style="color:#f92672">=</span>fletcher4 tank
2013-02-27.18:51:18 zfs create tank/backup
</code></pre></div><p>輸出結果顯示曾在該儲存池上執行的 <code>zpool</code> 與 <code>zfs</code> 指令以及時間戳記。只有會修改儲存池或類似的指令會被記錄下來，像是 <code>zfs list</code> 這種指令並不會被記錄。當不指定儲存池名稱時，會列出所有儲存池的歷史記錄。</p>
<p>在提供選項 <code>-i</code> 或 <code>-l</code> 時 <code>zpool history</code> 可以顯更多詳細資訊。<code>-i</code> 會顯示使用者觸發的事件外，也會顯示內部記錄的 ZFS 事件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool history -i</span>
History <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;tank&#39;</span>:
2013-02-26.23:02:35 <span style="color:#f92672">[</span>internal pool create txg:5<span style="color:#f92672">]</span> pool spa 28; zfs spa 28; zpl 5;uts  9.1-RELEASE <span style="color:#ae81ff">901000</span> amd64
2013-02-27.18:50:53 <span style="color:#f92672">[</span>internal property set txg:50<span style="color:#f92672">]</span> atime<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> dataset <span style="color:#f92672">=</span> <span style="color:#ae81ff">21</span>
2013-02-27.18:50:58 zfs set atime<span style="color:#f92672">=</span>off tank
2013-02-27.18:51:04 <span style="color:#f92672">[</span>internal property set txg:53<span style="color:#f92672">]</span> checksum<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> dataset <span style="color:#f92672">=</span> <span style="color:#ae81ff">21</span>
2013-02-27.18:51:09 zfs set checksum<span style="color:#f92672">=</span>fletcher4 tank
2013-02-27.18:51:13 <span style="color:#f92672">[</span>internal create txg:55<span style="color:#f92672">]</span> dataset <span style="color:#f92672">=</span> <span style="color:#ae81ff">39</span>
2013-02-27.18:51:18 zfs create tank/backup
</code></pre></div><p>更多詳細的資訊可加上 <code>-l</code> 來取得，歷史記錄會以較長的格式顯示，包含的資訊有執行指令的使用者名稱、主機名稱以及更改的項目。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool history -l</span>
History <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;tank&#39;</span>:
2013-02-26.23:02:35 zpool create tank mirror /dev/ada0 /dev/ada1 <span style="color:#f92672">[</span>user <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> on :global<span style="color:#f92672">]</span>
2013-02-27.18:50:58 zfs set atime<span style="color:#f92672">=</span>off tank <span style="color:#f92672">[</span>user <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> on myzfsbox:global<span style="color:#f92672">]</span>
2013-02-27.18:51:09 zfs set checksum<span style="color:#f92672">=</span>fletcher4 tank <span style="color:#f92672">[</span>user <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> on myzfsbox:global<span style="color:#f92672">]</span>
2013-02-27.18:51:18 zfs create tank/backup <span style="color:#f92672">[</span>user <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> on myzfsbox:global<span style="color:#f92672">]</span>
</code></pre></div><p>輸出結果顯示 <code>root</code> 使用者使用 <strong>/dev/ada0</strong> 及 <strong>/dev/ada1</strong> 建立鏡像的儲存池。主機名稱 <code>myzfsbox</code> 在建立完儲存池後也同樣會顯示。由於儲存池可以從一個系統匯出再匯入到另一個系統，因此主機名稱也很重要，這樣一來可以清楚的辦識在其他系統上執行的每一個指令的主機名稱。</p>
<p>兩個 <code>zpool history</code> 選項可以合併使用來取得最完整的儲存池詳細資訊。儲存池歷史記錄在追蹤執行什麼動作或要取得除錯所需的輸出結果提供了非常有用的資訊。</p>
<h4 id="監視效能">監視效能<a hidden class="anchor" aria-hidden="true" href="#監視效能">#</a></h4>
<p>內建的監視系統可以即時顯示儲存池的 I/O 統計資訊。它會顯示儲存池剩餘的空間與使用的空間，每秒執行了多少讀取與寫入的操作，有多少 I/O 頻寬被使用。預設會監視所有在系統中的儲存池都並顯示出來，可以提供儲存池名稱來只顯示該儲存池的監視資訊。舉一個簡單的例子：</p>
<pre tabindex="0"><code># zpool iostat
               capacity     operations    bandwidth
pool        alloc   free   read  write   read  write
----------  -----  -----  -----  -----  -----  -----
data         288G  1.53T      2     11  11.3K  57.1K
</code></pre><p>要持續監視 I/O 的活動可以在最後的參數指定一個數字，這個數字代表每次更新資訊所間隔的秒數。在每次經過間隔的時間後會列出新一行的統計資訊，按下 Ctrl+C 可以中止監視。或者在指令列的間隔時間之後再指定一個數字，代表總共要顯示的統計資訊筆數。</p>
<p>使用 <code>-v</code> 可以顯示更詳細的 I/O 統計資訊。每個在儲存池中的裝置會以一行統計資訊顯示。這可以幫助了解每一個裝置做了多少讀取與寫入的操作，並可協助確認是否有各別裝置拖慢了整個儲存池的速度。以下範例會顯示有兩個裝置的鏡像儲存池：</p>
<pre tabindex="0"><code># zpool iostat -v
                            capacity     operations    bandwidth
pool                     alloc   free   read  write   read  write
-----------------------  -----  -----  -----  -----  -----  -----
data                      288G  1.53T      2     12  9.23K  61.5K
  mirror                  288G  1.53T      2     12  9.23K  61.5K
    ada1                     -      -      0      4  5.61K  61.7K
    ada2                     -      -      1      4  5.04K  61.7K
-----------------------  -----  -----  -----  -----  -----  -----
</code></pre><h4 id="分割儲存儲存池">分割儲存儲存池<a hidden class="anchor" aria-hidden="true" href="#分割儲存儲存池">#</a></h4>
<p>由一個或多個鏡像 vdev 所組成的儲存池可以切分開成兩個儲存池。除非有另外指定，否則每個鏡像的最後一個成員會被分離，用來建立一個含有相同資料的新儲存池。在做這個操作的第一次應先使用 <code>-n</code>，會顯示預計會做的操作而不會真的執行，這可以協助確認操作是否與使用者所要的相同。</p>
<h3 id="zfs-管理"><code>zfs</code> 管理<a hidden class="anchor" aria-hidden="true" href="#zfs-管理">#</a></h3>
<p><code>zfs</code> 工具負責建立、摧毀與管理在一個儲存池中所有的 ZFS 資料集。儲存池使用 [<code>zpool</code>](#<code>zpool</code> 管理) 來管理。</p>
<h4 id="建立與摧毀資料集">建立與摧毀資料集<a hidden class="anchor" aria-hidden="true" href="#建立與摧毀資料集">#</a></h4>
<p>不同於傳統的磁碟與磁碟區管理程式 (Volume manager) ，在 ZFS 中的空間並<em>不</em>會預先分配。傳統的檔案系統在分割與分配空間完後，若沒有增加新的磁碟便無法再增加額外的檔案系統。在 ZFS，可以隨時建立新的檔案系統，每個資料集 (<em>Dataset</em>) 都有自己的屬性，包含壓縮 (Compression)、去重複 (Deduplication)、快取 (Caching) 與配額 (Quota) 功能以及其他有用的屬性如唯讀 (Readonly)、區分大小寫 (Case sensitivity)、網路檔案分享 (Network file sharing) 以及掛載點 (Mount point)。資料集可以存在於其他資料集中，且子資料集會繼承其父資料集的屬性。每個資料集都可以作為一個單位來管理、委託 (<a href="#%E5%A7%94%E8%A8%97%E7%AE%A1%E7%90%86">Delegate</a>)、備份 (<a href="#%E5%82%99%E4%BB%BD" title="Replication">Replicate</a>)、快照 (<a href="#%E7%AE%A1%E7%90%86%E5%BF%AB%E7%85%A7" title="Snapshot">Snapshot</a>)、監禁 ([Jail](#ZFS 與 Jail)) 與摧毀 (Destroy)，替每種不同類型或集合的檔案建立各別的資料集還有許多的好處。唯一的缺點是在當有非常大數量的資料集時，部份指令例如 <code>zfs list</code> 會變的較緩慢，且掛載上百個或其至上千個資料集可能會使 FreeBSD 的開機程序變慢。</p>
<p>建立一個新資料集並開啟 LZ4 壓縮：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list</span>
NAME                  USED  AVAIL  REFER  MOUNTPOINT
mypool                781M  93.2G   144K  none
mypool/ROOT           777M  93.2G   144K  none
mypool/ROOT/default   777M  93.2G   777M  /
mypool/tmp            176K  93.2G   176K  /tmp
mypool/usr            616K  93.2G   144K  /usr
mypool/usr/home       184K  93.2G   184K  /usr/home
mypool/usr/ports      144K  93.2G   144K  /usr/ports
mypool/usr/src        144K  93.2G   144K  /usr/src
mypool/var           1.20M  93.2G   608K  /var
mypool/var/crash      148K  93.2G   148K  /var/crash
mypool/var/log        178K  93.2G   178K  /var/log
mypool/var/mail       144K  93.2G   144K  /var/mail
mypool/var/tmp        152K  93.2G   152K  /var/tmp
<span style="color:#75715e"># zfs create -o compress=lz4 mypool/usr/mydataset</span>
<span style="color:#75715e"># zfs list</span>
NAME                   USED  AVAIL  REFER  MOUNTPOINT
mypool                 781M  93.2G   144K  none
mypool/ROOT            777M  93.2G   144K  none
mypool/ROOT/default    777M  93.2G   777M  /
mypool/tmp             176K  93.2G   176K  /tmp
mypool/usr             704K  93.2G   144K  /usr
mypool/usr/home        184K  93.2G   184K  /usr/home
mypool/usr/mydataset  87.5K  93.2G  87.5K  /usr/mydataset
mypool/usr/ports       144K  93.2G   144K  /usr/ports
mypool/usr/src         144K  93.2G   144K  /usr/src
mypool/var            1.20M  93.2G   610K  /var
mypool/var/crash       148K  93.2G   148K  /var/crash
mypool/var/log         178K  93.2G   178K  /var/log
mypool/var/mail        144K  93.2G   144K  /var/mail
mypool/var/tmp         152K  93.2G   152K  /var/tmp
</code></pre></div><p>摧毀資料集會比刪除所有在資料集上所殘留的檔案來的快，由於摧毀資料集並不會掃描所有檔案並更新所有相關的 Metadata。</p>
<p>摧毀先前建立的資料集：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list</span>
NAME                   USED  AVAIL  REFER  MOUNTPOINT
mypool                 880M  93.1G   144K  none
mypool/ROOT            777M  93.1G   144K  none
mypool/ROOT/default    777M  93.1G   777M  /
mypool/tmp             176K  93.1G   176K  /tmp
mypool/usr             101M  93.1G   144K  /usr
mypool/usr/home        184K  93.1G   184K  /usr/home
mypool/usr/mydataset   100M  93.1G   100M  /usr/mydataset
mypool/usr/ports       144K  93.1G   144K  /usr/ports
mypool/usr/src         144K  93.1G   144K  /usr/src
mypool/var            1.20M  93.1G   610K  /var
mypool/var/crash       148K  93.1G   148K  /var/crash
mypool/var/log         178K  93.1G   178K  /var/log
mypool/var/mail        144K  93.1G   144K  /var/mail
mypool/var/tmp         152K  93.1G   152K  /var/tmp
<span style="color:#75715e"># zfs destroy mypool/usr/mydataset</span>
<span style="color:#75715e"># zfs list</span>
NAME                  USED  AVAIL  REFER  MOUNTPOINT
mypool                781M  93.2G   144K  none
mypool/ROOT           777M  93.2G   144K  none
mypool/ROOT/default   777M  93.2G   777M  /
mypool/tmp            176K  93.2G   176K  /tmp
mypool/usr            616K  93.2G   144K  /usr
mypool/usr/home       184K  93.2G   184K  /usr/home
mypool/usr/ports      144K  93.2G   144K  /usr/ports
mypool/usr/src        144K  93.2G   144K  /usr/src
mypool/var           1.21M  93.2G   612K  /var
mypool/var/crash      148K  93.2G   148K  /var/crash
mypool/var/log        178K  93.2G   178K  /var/log
mypool/var/mail       144K  93.2G   144K  /var/mail
mypool/var/tmp        152K  93.2G   152K  /var/tmp
</code></pre></div><p>在最近版本的 ZFS，<code>zfs destroy</code> 是非同步的，且釋放出的空間會許要花費數分鐘才會出現在儲存池上，可使用 <code>zpool get freeing poolname</code> 來查看 <code>freeing</code> 屬性，這個屬性會指出資料集在背景已經釋放多少資料區塊了。若有子資料集，如快照 (Snapshot) 或其他資料集存在的話，則會無法摧毀父資料集。要摧毀一個資料集及其所有子資料集，可使用 <code>-r</code> 來做遞迴摧毀資料集及其所有子資料集，可用 <code>-n -v</code> 來列出會被這個操作所摧毀的資料集及快照，而不會真的摧毀，因摧毀快照所釋放出的空間也會同時顯示。</p>
<h4 id="建立與摧毀磁碟區">建立與摧毀磁碟區<a hidden class="anchor" aria-hidden="true" href="#建立與摧毀磁碟區">#</a></h4>
<p>磁碟區 (Volume) 是特殊類型的資料集，不會被掛載成一個檔案系統，而是會被當做儲存區塊裝置出現在 <strong>/dev/zvol/poolname/dataset</strong> 下。這讓磁碟區可供其他檔案系統使用、拿來備份虛擬機器的磁碟或是使用 iSCSI 或 HAST 通訊協定匯出。</p>
<p>磁碟區可以被格式化成任何檔案系統，或不使用檔案系統來儲存原始資料。對一般使用者，磁碟區就像是一般的磁碟，可以放置一般的檔案系統在這些 <em>zvols</em> 上，並提供一般磁碟或檔案系統一般所沒有的功能。例如，使用壓縮屬性在一個 250 MB 的磁碟區可建立一個壓縮的 FAT 檔案系統。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs create -V 250m -o compression=on tank/fat32</span>
<span style="color:#75715e"># zfs list tank</span>
NAME USED AVAIL REFER MOUNTPOINT
tank 258M  670M   31K /tank
<span style="color:#75715e"># newfs_msdos -F32 /dev/zvol/tank/fat32</span>
<span style="color:#75715e"># mount -t msdosfs /dev/zvol/tank/fat32 /mnt</span>
<span style="color:#75715e"># df -h /mnt | grep fat32</span>
Filesystem           Size Used Avail Capacity Mounted on
/dev/zvol/tank/fat32 249M  24k  249M     0%   /mnt
<span style="color:#75715e"># mount | grep fat32</span>
/dev/zvol/tank/fat32 on /mnt <span style="color:#f92672">(</span>msdosfs, local<span style="color:#f92672">)</span>
</code></pre></div><p>摧毀一個磁碟區與摧毀一個一般的檔案系統資料集差不多。操作上幾乎是即時的，但在背景會需要花費數分鐘來讓釋放空間再次可用。</p>
<h4 id="重新命名資料集">重新命名資料集<a hidden class="anchor" aria-hidden="true" href="#重新命名資料集">#</a></h4>
<p>資料集的名稱可以使用 <code>zfs rename</code> 更改。父資料集也同樣可以使用這個指令來更改名稱。重新命名一個資料集到另一個父資料集也會更改自父資料集繼承的屬性值。重新命名資料集後，會被卸載然後重新掛載到新的位置 (依繼承的新父資料集而定)，可使用 <code>-u</code> 來避免重新掛載。</p>
<p>重新命名一個資料集並移動該資料集到另一個父資料集：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list</span>
NAME                   USED  AVAIL  REFER  MOUNTPOINT
mypool                 780M  93.2G   144K  none
mypool/ROOT            777M  93.2G   144K  none
mypool/ROOT/default    777M  93.2G   777M  /
mypool/tmp             176K  93.2G   176K  /tmp
mypool/usr             704K  93.2G   144K  /usr
mypool/usr/home        184K  93.2G   184K  /usr/home
mypool/usr/mydataset  87.5K  93.2G  87.5K  /usr/mydataset
mypool/usr/ports       144K  93.2G   144K  /usr/ports
mypool/usr/src         144K  93.2G   144K  /usr/src
mypool/var            1.21M  93.2G   614K  /var
mypool/var/crash       148K  93.2G   148K  /var/crash
mypool/var/log         178K  93.2G   178K  /var/log
mypool/var/mail        144K  93.2G   144K  /var/mail
mypool/var/tmp         152K  93.2G   152K  /var/tmp
<span style="color:#75715e"># zfs rename mypool/usr/mydataset mypool/var/newname</span>
<span style="color:#75715e"># zfs list</span>
NAME                  USED  AVAIL  REFER  MOUNTPOINT
mypool                780M  93.2G   144K  none
mypool/ROOT           777M  93.2G   144K  none
mypool/ROOT/default   777M  93.2G   777M  /
mypool/tmp            176K  93.2G   176K  /tmp
mypool/usr            616K  93.2G   144K  /usr
mypool/usr/home       184K  93.2G   184K  /usr/home
mypool/usr/ports      144K  93.2G   144K  /usr/ports
mypool/usr/src        144K  93.2G   144K  /usr/src
mypool/var           1.29M  93.2G   614K  /var
mypool/var/crash      148K  93.2G   148K  /var/crash
mypool/var/log        178K  93.2G   178K  /var/log
mypool/var/mail       144K  93.2G   144K  /var/mail
mypool/var/newname   87.5K  93.2G  87.5K  /var/newname
mypool/var/tmp        152K  93.2G   152K  /var/tmp
</code></pre></div><p>快照也可以像這樣重新命名，由於快照的本質使其無法被重新命名到另一個父資料集。要遞迴重新命名快照可指定 <code>-r</code>，然後在子資料集中所有同名的快照也會一併被重新命名。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -t snapshot</span>
NAME                                USED  AVAIL  REFER  MOUNTPOINT
mypool/var/newname@first_snapshot      <span style="color:#ae81ff">0</span>      -  87.5K  -
<span style="color:#75715e"># zfs rename mypool/var/newname@first_snapshot new_snapshot_name</span>
<span style="color:#75715e"># zfs list -t snapshot</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/newname@new_snapshot_name      <span style="color:#ae81ff">0</span>      -  87.5K  -
</code></pre></div><h4 id="設定資料集屬性">設定資料集屬性<a hidden class="anchor" aria-hidden="true" href="#設定資料集屬性">#</a></h4>
<p>每個 ZFS 資料集有數個屬性可以用來控制其行為。大部份的屬性會自動繼承自其父資料集，但可以被自己覆蓋。設定資料集上的屬性可使用 <code>zfs set property=value dataset</code>。大部份屬性有限制可用的值，<code>zfs get</code> 會顯示每個可以使用的屬性及其可用的值。大部份可以使用 <code>zfs inherit</code> 還原成其繼承的值。</p>
<p>也可設定使用者自訂的屬性。這些屬性也會成為資料集設定的一部份，且可以被用來提供資料集或其內容的額外資訊。要分別自訂屬性與 ZFS 提供的屬性，會使用冒號 (<code>:</code>) 建立一個自訂命名空間供自訂屬性使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set custom:costcenter=1234 tank</span>
<span style="color:#75715e"># zfs get custom:costcenter tank</span>
NAME PROPERTY           VALUE SOURCE
tank custom:costcenter  <span style="color:#ae81ff">1234</span>  local
</code></pre></div><p>要移除自訂屬性，可用 <code>zfs inherit</code> 加上 <code>-r</code>。若父資料集未定義任何自訂屬性，將會將該屬性完全移除 (更改動作仍會記錄於儲存池的歷史記錄)。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs inherit -r custom:costcenter tank</span>
<span style="color:#75715e"># zfs get custom:costcenter tank</span>
NAME    PROPERTY           VALUE              SOURCE
tank    custom:costcenter  -                  -
<span style="color:#75715e"># zfs get all tank | grep custom:costcenter</span>
<span style="color:#75715e">#</span>
</code></pre></div><h5 id="取得與設定共享屬性">取得與設定共享屬性<a hidden class="anchor" aria-hidden="true" href="#取得與設定共享屬性">#</a></h5>
<p>两个常用和有用的数据集属性是NFS和SMB共享选项。设置这些参数可以定义是否以及如何在网络上共享ZFS数据集。目前，FreeBSD只支持通过NFS设置共享。输入以下命令获取当前共享状态:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs get sharenfs mypool/usr/home</span>
NAME             PROPERTY  VALUE    SOURCE
mypool/usr/home  sharenfs  on       local
<span style="color:#75715e"># zfs get sharesmb mypool/usr/home</span>
NAME             PROPERTY  VALUE    SOURCE
mypool/usr/home  sharesmb  off      local
</code></pre></div><p>如果需要共享数据集，请输入:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#  zfs set sharenfs=on mypool/usr/home</span>
</code></pre></div><p>还可以为通过NFS共享数据集设置额外的选项，例如<code>-alldirs</code>、<code>-maprot</code>和<code>-network</code>。如果要为NFS共享的数据集设置其他选项，请输入:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#  zfs set sharenfs=&#34;-alldirs,-maproot=root,-network=192.168.1.0/24&#34; mypool/usr/home</span>
</code></pre></div><h4 id="管理快照-snapshot">管理快照 (Snapshot)<a hidden class="anchor" aria-hidden="true" href="#管理快照-snapshot">#</a></h4>
<p>快照 (Snapshot) 是 ZFS 最強大的功能之一。快照提供了資料集唯讀、單一時間點 (Point-in-Time) 的複製功能，使用了寫入時複製 (Copy-On-Write, COW) 的技術，可以透過保存在磁碟上的舊版資料快速的建立快照。若沒有快照存在，在資料被覆蓋或刪除時，便回收空間供未來使用。由於只記錄前一個版本與目前資料集的差異，因此快照可節省磁碟空間。快照只允許在整個資料集上使用，無法在各別檔案或目錄。當建立了一個資料集的快照時，便備份了所有內含的資料，這包含了檔案系統屬性、檔案、目錄、權限等等。第一次建立快照時只會使用到更改參照到資料區塊的空間，不會用到其他額外的空間。使用 <code>-r</code> 可以對使用同名的資料集及其所有子資料集的建立一個遞迴快照，提供一致且即時 (Moment-in-time) 的完整檔案系統快照功能，這對於那些彼此有相關或相依檔案存放在不同資料集的應用程式非常重要。不使用快照所備份的資料其實是分散不同時間點的。</p>
<p>ZFS 中的快照提供了多種功能，即使是在其他缺乏快照功能的檔案系統上。一個使用快照的典型例子是在安裝軟體或執行系統升級這種有風險的動作時，能有一個快速的方式可以備份檔案系統目前的狀態，若動作失敗，可以使用快照還原 (Roll back) 到與快照建立時相同的系統狀態，若升級成功，便可刪除快照來釋放空間。若沒有快照功能，升級失敗通常會需要使用備份來恢復 (Restore) 系統，而這個動作非常繁瑣、耗時且可能會需要停機一段時間系統無法使用。使用快照可以快速的還原，即使系統正在執行一般的運作，只而要短暫或甚至不需停機。能夠節省大量在有數 TB 的儲存系統上從備份複製所需資料的時間。快照並非要用來取代儲存池的完整備份，但可以用在快速且簡單的保存某個特定時間點的資料集。</p>
<h5 id="建立快照">建立快照<a hidden class="anchor" aria-hidden="true" href="#建立快照">#</a></h5>
<p>快照可以使用 <code>zfs snapshot dataset@snapshotname</code> 來建立。加入 <code>-r</code> 可以遞迴對所有同名的子資料集建立快照。</p>
<p>建立一個整個儲存池的遞迴快照：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -t all</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool                                 780M  93.2G   144K  none
mypool/ROOT                            777M  93.2G   144K  none
mypool/ROOT/default                    777M  93.2G   777M  /
mypool/tmp                             176K  93.2G   176K  /tmp
mypool/usr                             616K  93.2G   144K  /usr
mypool/usr/home                        184K  93.2G   184K  /usr/home
mypool/usr/ports                       144K  93.2G   144K  /usr/ports
mypool/usr/src                         144K  93.2G   144K  /usr/src
mypool/var                            1.29M  93.2G   616K  /var
mypool/var/crash                       148K  93.2G   148K  /var/crash
mypool/var/log                         178K  93.2G   178K  /var/log
mypool/var/mail                        144K  93.2G   144K  /var/mail
mypool/var/newname                    87.5K  93.2G  87.5K  /var/newname
mypool/var/newname@new_snapshot_name      <span style="color:#ae81ff">0</span>      -  87.5K  -
mypool/var/tmp                         152K  93.2G   152K  /var/tmp
<span style="color:#75715e"># zfs snapshot -r mypool@my_recursive_snapshot</span>
<span style="color:#75715e"># zfs list -t snapshot</span>
NAME                                        USED  AVAIL  REFER  MOUNTPOINT
mypool@my_recursive_snapshot                   <span style="color:#ae81ff">0</span>      -   144K  -
mypool/ROOT@my_recursive_snapshot              <span style="color:#ae81ff">0</span>      -   144K  -
mypool/ROOT/default@my_recursive_snapshot      <span style="color:#ae81ff">0</span>      -   777M  -
mypool/tmp@my_recursive_snapshot               <span style="color:#ae81ff">0</span>      -   176K  -
mypool/usr@my_recursive_snapshot               <span style="color:#ae81ff">0</span>      -   144K  -
mypool/usr/home@my_recursive_snapshot          <span style="color:#ae81ff">0</span>      -   184K  -
mypool/usr/ports@my_recursive_snapshot         <span style="color:#ae81ff">0</span>      -   144K  -
mypool/usr/src@my_recursive_snapshot           <span style="color:#ae81ff">0</span>      -   144K  -
mypool/var@my_recursive_snapshot               <span style="color:#ae81ff">0</span>      -   616K  -
mypool/var/crash@my_recursive_snapshot         <span style="color:#ae81ff">0</span>      -   148K  -
mypool/var/log@my_recursive_snapshot           <span style="color:#ae81ff">0</span>      -   178K  -
mypool/var/mail@my_recursive_snapshot          <span style="color:#ae81ff">0</span>      -   144K  -
mypool/var/newname@new_snapshot_name           <span style="color:#ae81ff">0</span>      -  87.5K  -
mypool/var/newname@my_recursive_snapshot       <span style="color:#ae81ff">0</span>      -  87.5K  -
mypool/var/tmp@my_recursive_snapshot           <span style="color:#ae81ff">0</span>      -   152K  -
</code></pre></div><p>建立的快照不會顯示在一般的 <code>zfs list</code> 操作結果，要列出快照需在 <code>zfs list</code> 後加上 <code>-t snapshot</code>，使用 <code>-t all</code> 可以同時列出檔案系統的內容及快照。</p>
<p>快照並不會直接掛載，因此 <code>MOUNTPOINT</code> 欄位的路徑如此顯示。在 <code>AVAIL</code> 欄位不會有可用的磁碟空間，因為快照建立之後便無法再寫入。比較快照與其原來建立時的資料集：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -rt all mypool/usr/home</span>
NAME                                    USED  AVAIL  REFER  MOUNTPOINT
mypool/usr/home                         184K  93.2G   184K  /usr/home
mypool/usr/home@my_recursive_snapshot      <span style="color:#ae81ff">0</span>      -   184K  -
</code></pre></div><p>同時顯示資料集與快照可以了解快照如何使用 COW 技術來運作。快照只會保存有更動 (<em>差異</em>) 的資料，並非整個檔案系統的內容，這個意思是說，快照只會在有做更動時使用一小部份的空間，複製一個檔案到該資料集，可以讓空間使用量變的更明顯，然後再做第二個快照：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /etc/passwd /var/tmp</span>
<span style="color:#75715e"># zfs snapshot mypool/var/tmp@after_cp</span>
<span style="color:#75715e"># zfs list -rt all mypool/var/tmp</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp                         206K  93.2G   118K  /var/tmp
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp                   <span style="color:#ae81ff">0</span>      -   118K  -
</code></pre></div><p>第二快照只會包含了資料集做了複製動作後的更動，這樣的機制可以節省大量的空間。注意在複製之後快照 <em>mypool/var/tmp@my_recursive_snapshot</em> 於 <code>USED</code> 欄位中的大小也更改了，這說明了這個更動在前次快照與之後快照間的關係。</p>
<h5 id="比對快照">比對快照<a hidden class="anchor" aria-hidden="true" href="#比對快照">#</a></h5>
<p>ZFS 提供了內建指令可以用來比對兩個快照 (Snapshot) 之間的差異，在使用者想要查看一段時間之間檔案系統所的變更時非常有用。例如 <code>zfs diff</code> 可以讓使用者在最後一次快照中找到意外刪除的檔案。對前面一節所做的兩個快照使用這個指令會產生以下結果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -rt all mypool/var/tmp</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp                         206K  93.2G   118K  /var/tmp
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp                   <span style="color:#ae81ff">0</span>      -   118K  -
<span style="color:#75715e"># zfs diff mypool/var/tmp@my_recursive_snapshot</span>
M       /var/tmp/
+       /var/tmp/passwd
</code></pre></div><p>指令會列出指定快照 (在這個例子中為 <code>mypool/var/tmp@my_recursive_snapshot</code>) 與目前檔案系統間的更改。第一個欄位是更改的類型：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>+</td>
<td>加入了該路徑或檔案。</td>
</tr>
<tr>
<td>-</td>
<td>刪除了該路徑或檔案。</td>
</tr>
<tr>
<td>M</td>
<td>修改了該路徑或檔案。</td>
</tr>
<tr>
<td>R</td>
<td>重新命名了該路徑或檔案。</td>
</tr>
</tbody>
</table>
<p>對照這個表格來看輸出的結果，可以明顯的看到 <strong>passwd</strong> 是在快照 <code>mypool/var/tmp@my_recursive_snapshot</code> 建立之後才加入的，結果也同樣看的到掛載到 <code>/var/tmp</code> 的父目錄已經做過修改。</p>
<p>在使用 ZFS 備份功能來傳輸一個資料集到另一個主機備份時比對兩個快照也同樣很有用。</p>
<p>比對兩個快照需要提供兩個資料集的完整資料集名稱與快照名稱：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /var/tmp/passwd /var/tmp/passwd.copy</span>
<span style="color:#75715e"># zfs snapshot mypool/var/tmp@diff_snapshot</span>
<span style="color:#75715e"># zfs diff mypool/var/tmp@my_recursive_snapshot mypool/var/tmp@diff_snapshot</span>
M       /var/tmp/
+       /var/tmp/passwd
+       /var/tmp/passwd.copy
<span style="color:#75715e"># zfs diff mypool/var/tmp@my_recursive_snapshot mypool/var/tmp@after_cp</span>
M       /var/tmp/
+       /var/tmp/passwd
</code></pre></div><p>備份管理者可以比對兩個自傳送主機所接收到的兩個快照並查看實際在資料集中的變更。請參考 <a href="#%E5%82%99%E4%BB%BD" title="Replication">備份</a> 一節來取得更多資訊。</p>
<h5 id="使用快照還原">使用快照還原<a hidden class="anchor" aria-hidden="true" href="#使用快照還原">#</a></h5>
<p>只要至少有一個可用的快照便可以隨時還原。大多數在已不需要目前資料集，想要改用較舊版的資料的情況，例如，本地開發的測試發生錯誤、不良的系統更新破壞了系統的整體功能或需要還原意外刪除檔案或目錄 … 等，都是非常常見的情形。幸運的，要還原到某個快照只需要簡單輸入 <code>zfs rollback snapshotname</code>。會依快照所做的變更數量來決定處理的時間，還原的操作會在一段時間後完成。在這段時間中，資料集會一直保持一致的狀態，類似一個符合 ACID 原則的資料庫在做還原。還原可在資料集處於上線及可存取的情況下完成，不需要停機。還原到快照之後，資料集便回到當初執行快照時相同的狀態，所有沒有在快照中的其他資料便會被丟棄，因此往後若還有可能需要部份資料時，建議在還原到前一個快照之前先對目前的資料集做快照，這樣一來，使用者便可以在快照之間來回快換，而不會遺失重要的資料。</p>
<p>在第一個範例中，因為 <code>rm</code> 操作不小心移除了預期外的資料，要還原到快照。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -rt all mypool/var/tmp</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp                         262K  93.2G   120K  /var/tmp
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp               53.5K      -   118K  -
mypool/var/tmp@diff_snapshot              <span style="color:#ae81ff">0</span>      -   120K  -
<span style="color:#75715e"># ls /var/tmp</span>
passwd          passwd.copy     vi.recover
<span style="color:#75715e"># rm /var/tmp/passwd*</span>
<span style="color:#75715e"># ls /var/tmp</span>
vi.recover
</code></pre></div><p>在此時，使用者發現到刪除了太多檔案並希望能夠還原。ZFS 提供了簡單的方可以取回檔案，便是使用還原 (Rollback)，但這只在有定期對重要的資料使用快照時可用。要拿回檔案並從最後一次快照重新開始，可執行以下指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs rollback mypool/var/tmp@diff_snapshot</span>
<span style="color:#75715e"># ls /var/tmp</span>
passwd          passwd.copy     vi.recover
</code></pre></div><p>還原操作會將資料集還原為最後一次快照的狀態。這也可以還原到更早之前，有其他在其之後建立的快照。要這麼做時，ZFS 會發出這個警告：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -rt snapshot mypool/var/tmp</span>
AME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp               53.5K      -   118K  -
mypool/var/tmp@diff_snapshot              <span style="color:#ae81ff">0</span>      -   120K  -
<span style="color:#75715e"># zfs rollback mypool/var/tmp@my_recursive_snapshot</span>
cannot rollback to <span style="color:#e6db74">&#39;mypool/var/tmp@my_recursive_snapshot&#39;</span>: more recent snapshots exist
use <span style="color:#e6db74">&#39;-r&#39;</span> to force deletion of the following snapshots:
mypool/var/tmp@after_cp
mypool/var/tmp@diff_snapshot
</code></pre></div><p>這個警告是因在該快照與資料集的目前狀態之間有其他快照存在，然而使用者想要還原到該快照。要完成這樣的還原動作，必須刪除在這之間的快照，因為 ZFS 無法追蹤不同資料集狀態間的變更。在使用者未指定 <code>-r</code> 來確認這個動作前，ZFS 不會刪除受影響的快照。若確定要這麼做，那麼必須要知道會遺失所有在這之間的快照，然後可執行以下指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs rollback -r mypool/var/tmp@my_recursive_snapshot</span>
<span style="color:#75715e"># zfs list -rt snapshot mypool/var/tmp</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp@my_recursive_snapshot     8K      -   152K  -
<span style="color:#75715e"># ls /var/tmp</span>
vi.recover
</code></pre></div><p>可從 <code>zfs list -t snapshot</code> 的結果來確認 <code>zfs rollback -r</code> 會移除的快照。</p>
<h5 id="從快照還原個別檔案">從快照還原個別檔案<a hidden class="anchor" aria-hidden="true" href="#從快照還原個別檔案">#</a></h5>
<p>快照會掛載在父資料集下的隱藏目錄：<strong>.zfs/snapshots/snapshotname</strong>。預設不會顯示這些目錄，即使是用 <code>ls -a</code> 指令。雖然該目錄不會顯示，但該目錄實際存在，而且可以像一般的目錄一樣存取。一個名稱為 <code>snapdir</code> 的屬性可以控制是否在目錄清單中顯示這些隱藏目錄，設定該屬性為可見 (<code>visible</code>) 可以讓這些目錄出現在 <code>ls</code> 以及其他處理目錄內容的指令中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs get snapdir mypool/var/tmp</span>
NAME            PROPERTY  VALUE    SOURCE
mypool/var/tmp  snapdir   hidden   default
<span style="color:#75715e"># ls -a /var/tmp</span>
.               ..              passwd          vi.recover
<span style="color:#75715e"># zfs set snapdir=visible mypool/var/tmp</span>
<span style="color:#75715e"># ls -a /var/tmp</span>
.               ..              .zfs            passwd          vi.recover
</code></pre></div><p>要還原個別檔案到先前的狀態非常簡單，只要從快照中複製檔案到父資料集。在 <strong>.zfs/snapshot</strong> 目錄結構下有一個與先前所做的快照名稱相同的目錄，可以很容易的找到。在下個範例中，我們會示範從隱藏的 <strong>.zfs</strong> 目錄還原一個檔案，透過從含有該檔案的最新版快照複製：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># rm /var/tmp/passwd</span>
<span style="color:#75715e"># ls -a /var/tmp</span>
.               ..              .zfs            vi.recover
<span style="color:#75715e"># ls /var/tmp/.zfs/snapshot</span>
after_cp                my_recursive_snapshot
<span style="color:#75715e"># ls /var/tmp/.zfs/snapshot/after_cp</span>
passwd          vi.recover
<span style="color:#75715e"># cp /var/tmp/.zfs/snapshot/after_cp/passwd /var/tmp</span>
</code></pre></div><p>執行 <code>ls .zfs/snapshot</code> 時，雖然 <code>snapdir</code> 可能已經設為隱藏，但仍可能可以顯示該目錄中的內容，這取決於管理者是否要顯示這些目錄，可以只顯示特定的資料集，而其他的則不顯示。從這個隱藏的 <strong>.zfs/snapshot</strong> 複製檔案或目錄非常簡單，除此之外，嘗試其他的動作則會出現以下錯誤：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /etc/rc.conf /var/tmp/.zfs/snapshot/after_cp/</span>
cp: /var/tmp/.zfs/snapshot/after_cp/rc.conf: Read-only file system
</code></pre></div><p>這個錯誤用來提醒使用者快照是唯讀的，在建立之後不能更改。無法複製檔案進去或從該快照目錄中移除，因為這會變更該資料集所代表的狀態。</p>
<p>快照所消耗的空間是依據自快照之後父檔案系統做了多少變更來決定，快照的 <code>written</code> 屬性可以用來追蹤有多少空間被快照所使用。</p>
<p>使用 <code>zfs destroy dataset@snapshot</code> 可以摧毀快照並回收空間。加上 <code>-r</code> 可以遞迴移除所有在父資料集下使用同名的快照。加入 <code>-n -v</code> 來顯示將要移除的快照清單以及估計回收的空間，而不會實際執行摧毀的操作。</p>
<h4 id="管理複本-clone">管理複本 (Clone)<a hidden class="anchor" aria-hidden="true" href="#管理複本-clone">#</a></h4>
<p>複本 (Clone) 是快照的複製，但更像是一般的資料集，與快照不同的是，複本是非唯讀的 (可寫)，且可掛載，可以有自己的屬性。使用 <code>zfs clone</code> 建立複本之後，便無法再摧毀用來建立複本的快照。複本與快照的父/子關係可以使用 <code>zfs promote</code> 來對換。提升複本之後 ，快照便會成為複本的子資料集，而不是原來的父資料集，這個動作會改變空間計算的方式，但並不會實際改變空間的使用量。複本可以被掛載到 ZFS 檔案系統階層中的任何一點，並非只能位於原來快照的位置底下。</p>
<p>要示範複本功能會用到這個範例資料集：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -rt all camino/home/joe</span>
NAME                    USED  AVAIL  REFER  MOUNTPOINT
camino/home/joe         108K   1.3G    87K  /usr/home/joe
camino/home/joe@plans    21K      -  85.5K  -
camino/home/joe@backup    0K      -    87K  -
</code></pre></div><p>會使用到複本一般是要在可以保留快照以便出錯時可還原的情況下使用指定的資料集做實驗，由於快照並無法做更改，所以會建立一個可以讀/寫的快照複本。當在複本中做完想要執行的動作後，便可以提升複本成資料集，然後移除舊的檔案系統。嚴格來說這並非必要，因為複本與資料集可同時存在，不會有任何問題。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs clone camino/home/joe@backup camino/home/joenew</span>
<span style="color:#75715e"># ls /usr/home/joe*</span>
/usr/home/joe:
backup.txz     plans.txt

/usr/home/joenew:
backup.txz     plans.txt
<span style="color:#75715e"># df -h /usr/home</span>
Filesystem          Size    Used   Avail Capacity  Mounted on
usr/home/joe        1.3G     31k    1.3G     0%    /usr/home/joe
usr/home/joenew     1.3G     31k    1.3G     0%    /usr/home/joenew
</code></pre></div><p>建立完的複本便有與建立快照時狀態相同的資料集，現在複本可以獨立於原來的資料集來做更改。剩下唯一與資料集之間的關係便是快照，ZFS 會在屬性 <code>origin</code> 記錄這個關係，一旦在快照與複本之間的相依關係因為使用 <code>zfs promote</code> 提升而移除時，複本的 <code>origin</code> 也會因為成為一個完全獨立的資料集而移除。以下範例會示範這個動作：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs get origin camino/home/joenew</span>
NAME                  PROPERTY  VALUE                     SOURCE
camino/home/joenew    origin    camino/home/joe@backup    -
<span style="color:#75715e"># zfs promote camino/home/joenew</span>
<span style="color:#75715e"># zfs get origin camino/home/joenew</span>
NAME                  PROPERTY  VALUE   SOURCE
camino/home/joenew    origin    -       -
</code></pre></div><p>做為部份更改之後，例如複製 <strong>loader.conf</strong> 到提升後的複本，這個例子中的舊目錄便無須保留，取而代之的是提升後的複本，這個動作可以用兩個連續的指令來完成：在舊資料集上執行 <code>zfs destroy</code> 並在與舊資料相似名稱 (也可能用完全不同的名稱) 的複本上執行 <code>zfs rename</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /boot/defaults/loader.conf /usr/home/joenew</span>
<span style="color:#75715e"># zfs destroy -f camino/home/joe</span>
<span style="color:#75715e"># zfs rename camino/home/joenew camino/home/joe</span>
<span style="color:#75715e"># ls /usr/home/joe</span>
backup.txz     loader.conf     plans.txt
<span style="color:#75715e"># df -h /usr/home</span>
Filesystem          Size    Used   Avail Capacity  Mounted on
usr/home/joe        1.3G    128k    1.3G     0%    /usr/home/joe
</code></pre></div><p>快照的複本現在可以如同一般資料集一樣使用，它的內容包含了所有來自原始快照的資料以及後來加入的檔案，例如 <strong>loader.conf</strong>。複本可以在許多不同的情境下使用提供 ZFS 的使用者有用的功能，例如，Jail 可以透過含有已安裝了各種應用程式集的快照來提供，使用者可以複製這些快照然後加入自己想要嘗試的應用程式，一但更改可以滿足需求，便可提升複本為完整的資料集然後提供給終端使用者，讓終端使用者可以如同實際擁有資料集一般的使用，這個以節省提供這些 Jail 的時間與管理成本。</p>
<h4 id="備份-replication">備份 (Replication)<a hidden class="anchor" aria-hidden="true" href="#備份-replication">#</a></h4>
<p>將資料保存在單一地點的單一儲存池上會讓資料暴露在盜竊、自然或人為的風險之下，定期備份整個儲存池非常重要，ZFS 提供了內建的序列化 (Serialization) 功能可以將資料以串流傳送到標準輸出。使用這項技術，不僅可以將資料儲存到另一個已連結到本地系統的儲存池，也可以透過網路將資料傳送到另一個系統，這種備份方式以快照為基礎 (請參考章節 <a href="#%E7%AE%A1%E7%90%86%E5%BF%AB%E7%85%A7" title="Snapshot">ZFS 快照(Snapshot)</a>)。用來備份資料的指令為 <code>zfs send</code> 及 <code>zfs receive</code>。</p>
<p>以下例子將示範使用兩個儲存池來做 ZFS 備份：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG   CAP  DEDUP  HEALTH  ALTROOT
backup  960M    77K   896M         -         -     0%    0%  1.00x  ONLINE  -
mypool  984M  43.7M   940M         -         -     0%    4%  1.00x  ONLINE  -
</code></pre></div><p>名為 <em>mypool</em> 的儲存池為主要的儲存池，資料會定期寫入與讀取的位置。第二個儲存池 <em>backup</em> 用來待命 (Standby)，萬一主要儲存池無法使用時可替換。注意，ZFS 並不會自動做容錯移轉 (Fail-over)，必須要由系統管理者在需要的時候手動完成。快照會用來提供一個與檔系統一致的版本來做備份，<em>mypool</em> 的快照建立之後，便可以複製到 <em>backup</em> 儲存池，只有快照可以做備份，最近一次快照之後所做的變更不會含在內容裡面。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs snapshot mypool@backup1</span>
<span style="color:#75715e"># zfs list -t snapshot</span>
NAME                    USED  AVAIL  REFER  MOUNTPOINT
mypool@backup1             <span style="color:#ae81ff">0</span>      -  43.6M  -
</code></pre></div><p>快照存在以後，便可以使用 <code>zfs send</code> 來建立一個代表快照內容的串流，這個串流可以儲存成檔案或由其他儲存池接收。串流會寫入到標準輸出，但是必須要重新導向到一個檔案或轉接到其他地方，否則會錯誤：</p>
<pre tabindex="0"><code># zfs send mypool@backup1
Error: Stream can not be written to a terminal.
You must redirect standard output.
</code></pre><p>要使用 <code>zfs send</code> 備份一個資料集，可重新導向到一個位於在已掛載到備份儲存池上的檔案。確定該儲存池有足夠的空間容納要傳送的快照，這裡指的是該快照中內含的所有資料，並非只有上次快照到該快照間的變更。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs send mypool@backup1 &gt; /backup/backup1</span>
<span style="color:#75715e"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT
backup  960M  63.7M   896M         -         -     0%     6%  1.00x  ONLINE  -
mypool  984M  43.7M   940M         -         -     0%     4%  1.00x  ONLINE  -
</code></pre></div><p><code>zfs send</code> 會傳輸在快照 <em>backup1</em> 中所有的資料到儲存池 <em>backup</em>。可以使用 <a href="https://www.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a> 排程來自動完成建立與傳送快照的動作。</p>
<p>若不想將備份以封存檔案儲存，ZFS 可用實際的檔案系統來接收資料，讓備份的資料可以直接被存取。要取得實際包含在串流中的資料可以用 <code>zfs receive</code> 將串流轉換回檔案與目錄。以下例子會以管線符號連接 <code>zfs send</code> 及 <code>zfs receive</code>，將資料從一個儲存池複製到另一個，傳輸完成後可以直接使用接收儲存池上的資料。一個資料集只可以被複製到另一個空的資料集。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs snapshot mypool@replica1</span>
<span style="color:#75715e"># zfs send -v mypool@replica1 | zfs receive backup/mypool</span>
send from @ to mypool@replica1 estimated size is 50.1M
total estimated size is 50.1M
TIME        SENT   SNAPSHOT

<span style="color:#75715e"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT
backup  960M  63.7M   896M         -         -     0%     6%  1.00x  ONLINE  -
mypool  984M  43.7M   940M         -         -     0%     4%  1.00x  ONLINE  -
</code></pre></div><h5 id="漸進式備份">漸進式備份<a hidden class="anchor" aria-hidden="true" href="#漸進式備份">#</a></h5>
<p><code>zfs send</code> 也可以比較兩個快照之間的差異，並且只傳送兩者之間的差異，這麼做可以節省磁碟空間及傳輸時間。例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs snapshot mypool@replica2</span>
<span style="color:#75715e"># zfs list -t snapshot</span>
NAME                    USED  AVAIL  REFER  MOUNTPOINT
mypool@replica1         5.72M      -  43.6M  -
mypool@replica2             <span style="color:#ae81ff">0</span>      -  44.1M  -
<span style="color:#75715e"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG   CAP  DEDUP  HEALTH  ALTROOT
backup  960M  61.7M   898M         -         -     0%    6%  1.00x  ONLINE  -
mypool  960M  50.2M   910M         -         -     0%    5%  1.00x  ONLINE  -
</code></pre></div><p>會建立一個名為 <em>replica2</em> 的第二個快照，這個快照只中只會含有目前與前次快照 <em>replica1</em> 之間檔案系統所做的變更。使用 <code>zfs send -i</code> 並指定要用來產生漸進備份串流的快照，串流中只會含有做過更改的資料。這個動作只在接收端已經有初始快照時才可用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs send -v -i mypool@replica1 mypool@replica2 | zfs receive /backup/mypool</span>
send from @replica1 to mypool@replica2 estimated size is 5.02M
total estimated size is 5.02M
TIME        SENT   SNAPSHOT

<span style="color:#75715e"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG  CAP  DEDUP  HEALTH  ALTROOT
backup  960M  80.8M   879M         -         -     0%   8%  1.00x  ONLINE  -
mypool  960M  50.2M   910M         -         -     0%   5%  1.00x  ONLINE  -

<span style="color:#75715e"># zfs list</span>
NAME                         USED  AVAIL  REFER  MOUNTPOINT
backup                      55.4M   240G   152K  /backup
backup/mypool               55.3M   240G  55.2M  /backup/mypool
mypool                      55.6M  11.6G  55.0M  /mypool

<span style="color:#75715e"># zfs list -t snapshot</span>
NAME                                         USED  AVAIL  REFER  MOUNTPOINT
backup/mypool@replica1                       104K      -  50.2M  -
backup/mypool@replica2                          <span style="color:#ae81ff">0</span>      -  55.2M  -
mypool@replica1                             29.9K      -  50.0M  -
mypool@replica2                                 <span style="color:#ae81ff">0</span>      -  55.0M  -
</code></pre></div><p>如此一來，便成功傳輸漸進式的串流，只有做過更改的資料會被備份，不會傳送完整的 <em>replica1</em>。由於不會備份完整的儲存池，只傳送差異的部份，所以可以減少傳輸的時間並節省磁碟空間，特別是在網路緩慢或需要考量每位元傳輸成本時非常有用。</p>
<p>從儲存池 <em>mypool</em> 複製所有檔案與資料的新檔案系統 <em>backup/mypool</em> 便可以使用。若指定 <code>-P</code>，會一併複製資料集的屬性，這包含壓縮 (Compression) 設定，配額 (Quota) 及掛載點 (Mount point)。若指定 <code>-R</code>，會複製所有指定資料集的子資料集，及這些子資料集的所有屬性。可將傳送與接收自動化來定期使用第二個儲存池做備份。</p>
<h5 id="透過-ssh-傳送加密的備份">透過 SSH 傳送加密的備份<a hidden class="anchor" aria-hidden="true" href="#透過-ssh-傳送加密的備份">#</a></h5>
<p>透過網路來傳送串流是一個做遠端備份不錯的方式，但是也有一些缺點，透過網路連線傳送的資料沒有加密，這會讓任何人都可以在未告知傳送方的情況下攔截並轉換串流回資料，這是我們所不想見到的情況，特別是在使用網際網路傳送串流到遠端的主機時。SSH 可用來加密要透過網路連線傳送的資料，在 ZFS 只需要將串流重新導向到標準輸出，如此一來便可簡單的轉接到 SSH。若要讓檔案系統內容在傳送或在遠端系統中也維持在加密的狀態可考慮使用 <a href="https://wiki.freebsd.org/PEFS">PEFS</a>。</p>
<p>有一些設定以及安全性注意事項必須先完成，只有對 <code>zfs send</code> 操作必要的步驟才會在此說明，要取得更多有關 SSH 的資訊請參考 <a href="https://docs.freebsd.org/zh-tw/books/handbook/security/index.html#openssh">OpenSSH</a>。</p>
<p>必要的環境設定：</p>
<ul>
<li>
<p>使用 SSH 金鑰設定傳送端與接收端間無密碼的 SSH 存取</p>
</li>
<li>
<p>正常會需要 <code>root</code> 的權限來傳送與接收串流，這需要可以 <code>root</code> 登入到接收端系統。但是，預設因安全性考慮會關閉以 <code>root</code> 登入。ZFS 委託 (<a href="#%E5%A7%94%E8%A8%97%E7%AE%A1%E7%90%86">ZFS Delegation</a>) 系統可以用來允許一個非 <code>root</code> 使用者在每個系統上執行各自的發送與接收操作。</p>
</li>
<li>
<p>在傳送端系統上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs allow -u someuser send,snapshot mypool</span>
</code></pre></div></li>
<li>
<p>要掛載儲存池，無權限的使用者必須擁有該目錄且必須允許一般的使用者掛載檔案系統。在接收端系統上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># sysctl vfs.usermount=1</span>
vfs.usermount: <span style="color:#ae81ff">0</span> -&gt; <span style="color:#ae81ff">1</span>
<span style="color:#75715e"># sysrc -f /etc/sysctl.conf vfs.usermount=1</span>
<span style="color:#75715e"># zfs create recvpool/backup</span>
<span style="color:#75715e"># zfs allow -u someuser create,mount,receive recvpool/backup</span>
<span style="color:#75715e"># chown someuser /recvpool/backup</span>
</code></pre></div></li>
</ul>
<p>無權限的使用者現在有能力可以接收並掛載資料集，且 <em>home</em> 資料集可以被複製到遠端系統：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">% zfs snapshot -r mypool/home@monday
% zfs send -R mypool/home@monday | ssh someuser@backuphost zfs recv -dvu recvpool/backup
</code></pre></div><p>替儲存在儲存池 <em>mypool</em> 上的檔案系統資料集 <em>home</em> 製作一個遞迴快照 <em>monday</em>，然後使用 <code>zfs send -R</code> 來傳送包含該資料集及其所有子資料集、快照、複製與設定的串流。輸出會被導向到 SSH 連線的遠端主機 <em>backuphost</em> 上等候輸入的 <code>zfs receive</code>，在此建議使用完整網域名稱或 IP 位置。接收端的機器會寫入資料到 <em>recvpool</em> 儲存池上的 <em>backup</em> 資料集，在 <code>zfs recv</code> 加上 <code>-d</code> 可覆寫在接收端使用相同名稱的快照，加上 <code>-u</code> 可讓檔案系統在接收端不會被掛載，當使用 <code>-v</code>，會顯示更多有關傳輸的詳細資訊，包含已花費的時間及已傳輸的資料量。</p>
<h4 id="資料集使用者以及群組配額">資料集、使用者以及群組配額<a hidden class="anchor" aria-hidden="true" href="#資料集使用者以及群組配額">#</a></h4>
<p>資料集配額 (Dataset quota) 可用來限制特定資料集可以使用的的空間量。參考配額 (Reference Quota) 的功能也非常相似，差在參考配額只會計算資料集自己使用的空間，不含快照與子資料集。類似的，使用者 (User) 與群組 (Group) 配額可以用來避免使用者或群組用掉儲存池或資料集的所有空間。</p>
<p>要設定 <strong>storage/home/bob</strong> 的資料集配額為 10 GB：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set quota=10G storage/home/bob</span>
</code></pre></div><p>要設定 <strong>storage/home/bob</strong> 的參考配額為 10 GB：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set refquota=10G storage/home/bob</span>
</code></pre></div><p>要移除 <strong>storage/home/bob</strong> 的 10 GB 配額：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set quota=none storage/home/bob</span>
</code></pre></div><p>設定使用者配額的一般格式為 <code>userquota@user=size</code> 使用者的名稱必須使用以下格式：</p>
<ul>
<li>POSIX 相容的名稱，如 <em>joe</em>。</li>
<li>POSIX 數字 ID，如 <em>789</em>。</li>
<li>SID 名稱，如 <em><a href="mailto:joe.bloggs@example.com">joe.bloggs@example.com</a></em>。</li>
<li>SID 數字 ID，如 <em>S-1-123-456-789</em>。</li>
</ul>
<p>例如，要設定使用者名為 <em>joe</em> 的使用者配額為 50 GB：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set userquota@joe=50G</span>
</code></pre></div><p>要移除所有配額：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set userquota@joe=none</span>
</code></pre></div><blockquote>
<p>使用者配額的屬性不會顯示在 <code>zfs get all</code>。非 <code>root</code> 的使用者只可以看到自己的配額，除非它們有被授予 <code>userquota</code> 權限，擁有這個權限的使用者可以檢視與設定任何人的配額。</p>
</blockquote>
<p>要設定群組配額的一般格式為：<code>groupquota@group=size</code>。</p>
<p>要設定群組 <em>firstgroup</em> 的配額為 50 GB 可使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set groupquota@firstgroup=50G</span>
</code></pre></div><p>要移除群組 <em>firstgroup</em> 的配額，或確保該群組未設定配額可使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set groupquota@firstgroup=none</span>
</code></pre></div><p>如同使用者配額屬性，非 <code>root</code> 使用者只可以查看自己所屬群組的配額。而 <code>root</code> 或擁有 <code>groupquota</code> 權限的使用者，可以檢視並設定所有群組的任何配額。</p>
<p>要顯示在檔案系統或快照上每位使用者所使用的空間量及配額可使用 <code>zfs userspace</code>，要取得群組的資訊則可使用 <code>zfs groupspace</code>，要取得有關支援的選項資訊或如何只顯示特定選項的資訊請參考 <a href="https://www.freebsd.org/cgi/man.cgi?query=zfs&amp;sektion=1&amp;format=html">zfs(1)</a>。</p>
<p>有足夠權限的使用者及 <code>root</code> 可以使用以下指令列出 <strong>storage/home/bob</strong> 的配額：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs get quota storage/home/bob</span>
</code></pre></div><h4 id="保留空間">保留空間<a hidden class="anchor" aria-hidden="true" href="#保留空間">#</a></h4>
<p>保留空間 (Reservation) 可以確保資料集最少可用的空間量，其他任何資料集無法使用保留的空間，這個功能在要確保有足夠的可用空間來存放重要的資料集或日誌檔時特別有用。</p>
<p><code>reservation</code> 屬性的一般格式為 <code>reservation=size</code>，所以要在 <strong>storage/home/bob</strong> 設定保留 10 GB 的空間可以用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set reservation=10G storage/home/bob</span>
</code></pre></div><p>要清除任何保留空間：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set reservation=none storage/home/bob</span>
</code></pre></div><p>同樣的原則可以應用在 <code>refreservation</code> 屬性來設定參考保留空間 (Reference Reservation)，參考保留空間的一般格式為 <code>refreservation=size</code>。</p>
<p>這個指令會顯示任何已設定於 <strong>storage/home/bob</strong> 的 reservation 或 refreservation：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs get reservation storage/home/bob</span>
<span style="color:#75715e"># zfs get refreservation storage/home/bob</span>
</code></pre></div><h4 id="壓縮-compression">壓縮 (Compression)<a hidden class="anchor" aria-hidden="true" href="#壓縮-compression">#</a></h4>
<p>ZFS 提供直接的壓縮功能，在資料區塊層級壓縮資料不僅可以節省空間，也可以增加磁碟的效能。若資料壓縮了 25%，但壓縮的資料會使用了與未壓縮版本相同的速率寫入到磁碟，所以實際的寫入速度會是原來的 125%。壓縮功能也可來替代去重複 (Deduplication) 功能，因為壓縮並不需要使用額外的記憶體。</p>
<p>ZFS 提了多種不同的壓縮演算法，每一種都有不同的優缺點，隨著 ZFS v5000 引進了 LZ4 壓縮技術，可對整個儲存池開啟壓縮，而不像其他演算法需要消耗大量的效能來達成，最大的優點是 LZ4 擁有 <em>提早放棄</em> 的功能，若 LZ4 無法在資料一開始的部份達成至少 12.5% 的壓縮率，便會以不壓縮的方式來寫入資料區塊來避免 CPU 在那些已經壓縮過或無法壓縮的資料上浪費運算能力。要取得更多有關 ZFS 中可用的壓縮演算法詳細資訊，可參考術語章節中的壓縮 (Compression) 項目。</p>
<p>管理者可以使用資料集的屬性來監視壓縮的效果。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs get used,compressratio,compression,logicalused mypool/compressed_dataset</span>
NAME        PROPERTY          VALUE     SOURCE
mypool/compressed_dataset  used              449G      -
mypool/compressed_dataset  compressratio     1.11x     -
mypool/compressed_dataset  compression       lz4       local
mypool/compressed_dataset  logicalused       496G      -
</code></pre></div><p>資料集目前使用了 449 GB 的空間 (在 used 屬性)。在尚未壓縮前，該資料集應該會使用 496 GB 的空間 (於 <code>logicalused</code> 屬性)，這個結果顯示目前的壓縮比為 1.11:1。</p>
<p>壓縮功能在與使用者配額 (User Quota) 一併使用時可能會產生無法預期的副作用。使用者配額會限制一個使用者在一個資料集上可以使用多少空間，但衡量的依據是以 <em>壓縮後</em> 所使用的空間，因此，若一個使用者有 10 GB 的配額，寫入了 10 GB 可壓縮的資料，使用者將還會有空間儲存額外的資料。若使用者在之後更新了一個檔案，例如一個資料庫，可能有更多或較少的可壓縮資料，那麼剩餘可用的空間量也會因此而改變，這可能會造成奇怪的現象便是，一個使用者雖然沒有增加實際的資料量 (於 <code>logicalused</code> 屬性)，但因為更改影響了壓縮率，導致使用者達到配額的上限。</p>
<p>壓縮功能在與備份功能一起使用時也可能會有類似的問題，通常會使用配額功能來限制能夠儲存的資料量來確保有足夠的備份空間可用。但是由於配額功能並不會考量壓縮狀況，可能會有比未壓縮版本備份更多的資料量會被寫入到資料集。</p>
<h4 id="去重複-deduplication">去重複 (Deduplication)<a hidden class="anchor" aria-hidden="true" href="#去重複-deduplication">#</a></h4>
<p>當開啟，去重複 (Deduplication) 功能會使用每個資料區塊的校驗碼 (Checksum) 來偵測重複的資料區塊，當新的資料區塊與現有的資料區塊重複，ZFS 便會寫入連接到現有資料的參考來替代寫入重複的資料區塊，這在資料中有大量重複的檔案或資訊時可以節省大量的空間，要注意的是：去重複功能需要使用大量的記憶體且大部份可節省的空間可改開啟壓縮功能來達成，而壓縮功能不需要使用額外的記憶體。</p>
<p>要開啟去重複功能，需在目標儲存池設定 <code>dedup</code> 屬性：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set dedup=on pool</span>
</code></pre></div><p>只有要被寫入到儲存池的新資料才會做去重複的動作，先前已被寫入到儲存池的資料不會因此啟動了這個選項而做去重複。查看已開啟去重複屬性的儲存池會如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool list</span>
NAME  SIZE ALLOC  FREE   CKPOINT  EXPANDSZ   FRAG   CAP   DEDUP   HEALTH   ALTROOT
pool 2.84G 2.19M 2.83G         -         -     0%    0%   1.00x   ONLINE   -
</code></pre></div><p><code>DEDUP</code> 欄位會顯示儲存池的實際去重複率，數值為 <code>1.00x</code> 代表資料尚未被去重複。在下一個例子會在前面所建立的去重複儲存池中複製三份 Port 樹到不同的目錄中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># for d in dir1 dir2 dir3; do</span>
&gt; mkdir $d <span style="color:#f92672">&amp;&amp;</span> cp -R /usr/ports $d &amp;
&gt; <span style="color:#66d9ef">done</span>
</code></pre></div><p>已經偵測到重複的資料並做去重複：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool list</span>
NAME SIZE  ALLOC  FREE   CKPOINT  EXPANDSZ   FRAG  CAP   DEDUP   HEALTH   ALTROOT
pool 2.84G 20.9M 2.82G         -         -     0%   0%   3.00x   ONLINE   -
</code></pre></div><p><code>DEDUP</code> 欄位顯示有 <code>3.00x</code> 的去重複率，這代表已偵測到多份複製的 Port 樹資料並做了去重複的動作，且只會使用第三份資料所佔的空間。去重複能節省空間的潛力可以非常巨大，但會需要消耗大量的記憶體來持續追蹤去重複的資料區塊。</p>
<p>去重複並非總是有效益的，特別是當儲存池中的資料本身並沒有重複時。ZFS 可以透過在現有儲存池上模擬開啟去重複功能來顯示可能節省的空間：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zdb -S pool</span>
Simulated DDT histogram:

bucket              allocated                       referenced
______   ______________________________   ______________________________
refcnt   blocks   LSIZE   PSIZE   DSIZE   blocks   LSIZE   PSIZE   DSIZE
------   ------   -----   -----   -----   ------   -----   -----   -----
     <span style="color:#ae81ff">1</span>    2.58M    289G    264G    264G    2.58M    289G    264G    264G
     <span style="color:#ae81ff">2</span>     206K   12.6G   10.4G   10.4G     430K   26.4G   21.6G   21.6G
     <span style="color:#ae81ff">4</span>    37.6K    692M    276M    276M     170K   3.04G   1.26G   1.26G
     <span style="color:#ae81ff">8</span>    2.18K   45.2M   19.4M   19.4M    20.0K    425M    176M    176M
    <span style="color:#ae81ff">16</span>      <span style="color:#ae81ff">174</span>   2.83M   1.20M   1.20M    3.33K   48.4M   20.4M   20.4M
    <span style="color:#ae81ff">32</span>       <span style="color:#ae81ff">40</span>   2.17M    222K    222K    1.70K   97.2M   9.91M   9.91M
    <span style="color:#ae81ff">64</span>        <span style="color:#ae81ff">9</span>     56K   10.5K   10.5K      <span style="color:#ae81ff">865</span>   4.96M    948K    948K
   <span style="color:#ae81ff">128</span>        <span style="color:#ae81ff">2</span>   9.50K      2K      2K      <span style="color:#ae81ff">419</span>   2.11M    438K    438K
   <span style="color:#ae81ff">256</span>        <span style="color:#ae81ff">5</span>   61.5K     12K     12K    1.90K   23.0M   4.47M   4.47M
    1K        <span style="color:#ae81ff">2</span>      1K      1K      1K    2.98K   1.49M   1.49M   1.49M
 Total    2.82M    303G    275G    275G    3.20M    319G    287G    287G

dedup <span style="color:#f92672">=</span> 1.05, compress <span style="color:#f92672">=</span> 1.11, copies <span style="color:#f92672">=</span> 1.00, dedup * compress / copies <span style="color:#f92672">=</span> 1.16
</code></pre></div><p>在 <code>zdb -S</code> 分析完儲存池後會顯示在啟動去重複後可達到的空間減少比例。在本例中，<code>1.16</code> 是非常差的空間節省比例，因為這個比例使用壓縮功能便能達成。若在此儲存池上啟動去重複並不能明顯的節省空間使用量，那麼就不值得耗費大量的記憶體來開啟去重複功能。透過公式 <em>ratio = dedup * compress / copies</em>，系統管理者可以規劃儲存空間的配置，來判斷要處理的資料是否有足夠的重複資料區塊來平衡所需的記憶體。若資料是可壓縮的，那麼空間節少的效果可能會非常好，建議先開啟壓縮功能，且壓縮功能也可以大大提高效能。去重複功能只有在可以節省可觀的空間且有足夠的記憶體做 DDT 時才開啟。</p>
<h4 id="zfs-與-jail">ZFS 與 Jail<a hidden class="anchor" aria-hidden="true" href="#zfs-與-jail">#</a></h4>
<p><code>zfs jail</code> 以及相關的 <code>jailed</code> 屬性可以用來將一個 ZFS 資料集委託給一個 <a href="https://docs.freebsd.org/zh-tw/books/handbook/jails/index.html#jails">Jail</a> 管理。<code>zfs jail *jailid*</code> 可以將一個資料集連結到一個指定的 Jail，而 <code>zfs unjail</code> 則可解除連結。資料集要可以在 Jail 中控制需設定 <code>jailed</code> 屬性，一旦資料集被隔離便無法再掛載到主機，因為有掛載點可能會破壞主機的安全性。</p>
<h3 id="委託管理">委託管理<a hidden class="anchor" aria-hidden="true" href="#委託管理">#</a></h3>
<p>一個全面性的權限委託系統可能無權限的使用者執行 ZFS 的管理功能。例如，若每個使用者的家目錄均為一個資料集，便可以給予使用者權限建立與摧毀它們家目錄中的快照。可以給予備份使用者使用備份功能的權限。一個使用量統計的 Script 可以允許其在執行時能存取所有使用者的空間利用率資料。甚至可以將委託權限委託給其他人，每個子指令與大多數屬性都可使用權限委託。</p>
<h4 id="委託資料集建立">委託資料集建立<a hidden class="anchor" aria-hidden="true" href="#委託資料集建立">#</a></h4>
<p><code>zfs allow someuser create mydataset</code> 可以給予指定的使用者在指定的父資料集下建立子資料集的權限。這裡需要注意：建立新資料集會牽涉到掛載，因此需要設定 FreeBSD 的 <code>vfs.usermount</code> <a href="https://www.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> 為 <code>1</code> 來允許非 root 的使用者掛載一個檔案系統。這裡還有另一項限制可以避免濫用：非 <code>root</code> 使用者必須擁有掛載點在檔案系統中所在位置的權限才可掛載。</p>
<h4 id="委託權限委託">委託權限委託<a hidden class="anchor" aria-hidden="true" href="#委託權限委託">#</a></h4>
<p><code>zfs allow someuser allow mydataset</code> 可以給予指定的使用者有權限指派它們在目標資料集或其子資料集上擁有的任何權限給其他人。若該使用者擁有 <code>snapshot</code> 權限及 <code>allow</code> 權限，則該使用者可以授權 <code>snapshot</code> 權限給其他使用者。</p>
<h3 id="進階主題">進階主題<a hidden class="anchor" aria-hidden="true" href="#進階主題">#</a></h3>
<h4 id="調校">調校<a hidden class="anchor" aria-hidden="true" href="#調校">#</a></h4>
<p>這裡有數個可調校的項目可以調整，來讓 ZFS 在面對各種工作都能以最佳狀況運作。</p>
<p>&hellip;</p>
<h5 id="i386-上的-zfs">i386 上的 ZFS<a hidden class="anchor" aria-hidden="true" href="#i386-上的-zfs">#</a></h5>
<p>ZFS 所提供的部份功能需要使用大量記憶體，且可能需要對有限 RAM 的系統調校來取得最佳的效率。</p>
<h5 id="記憶體">記憶體<a hidden class="anchor" aria-hidden="true" href="#記憶體">#</a></h5>
<p>最低需求，總系統記憶體應至少有 1 GB，建議的 RAM 量需視儲存池的大小以及使用的 ZFS 功能而定。一般的經驗法則是每 1 TB 的儲存空間需要 1 GB 的 RAM，若有開啟去重複的功能，一般的經驗法則是每 1 TB 的要做去重複的儲存空間需要 5 GB 的 RAM。雖然有部份使用者成功使用較少的 RAM 來運作 ZFS，但系統在負載較重時有可能會因為記憶用耗而導致當機，對於要使用低於建議 RAM 需求量來運作的系統可能會需要更進一步的調校。</p>
<h5 id="核心設定">核心設定<a hidden class="anchor" aria-hidden="true" href="#核心設定">#</a></h5>
<p>由於在 i386™ 平台上位址空間的限制，在 i386™ 架構上的 ZFS 使用者必須加入這個選項到自訂核心設定檔，重新編譯核心並重新開啟：</p>
<pre tabindex="0"><code>options KVA_PAGES=512
</code></pre><p>這個選項會增加核心位址空間，允許調整 <code>vm.kvm_size</code> 超出目前的 1 GB 限制或在 PAE 的 2 GB 限制。要找到這個選項最合適的數值，可以將想要的位址空間換算成 MB 然後除以 4，在本例中，以 2 GB 計算後即為 <code>512</code>。</p>
<h5 id="載入程式可調參數">載入程式可調參數<a hidden class="anchor" aria-hidden="true" href="#載入程式可調參數">#</a></h5>
<p>在所有的 FreeBSD 架構上均可增加 <strong>kmem</strong> 位址空間，經測試在一個 1 GB 實體記憶體的測試系統上，加入以下選項到 <strong>/boot/loader.conf</strong>，重新開啟系統，可成功設定：</p>
<pre tabindex="0"><code>vm.kmem_size=&quot;330M&quot;
vm.kmem_size_max=&quot;330M&quot;
vfs.zfs.arc_max=&quot;40M&quot;
vfs.zfs.vdev.cache.size=&quot;5M&quot;
</code></pre><p>要取得更多詳細的 ZFS 相關調校的建議清單，請參考 <a href="https://wiki.freebsd.org/ZFSTuningGuide">https://wiki.freebsd.org/ZFSTuningGuide</a>。</p>
<h3 id="其他資源">其他資源<a hidden class="anchor" aria-hidden="true" href="#其他資源">#</a></h3>
<ul>
<li><a href="https://wiki.freebsd.org/ZFS">FreeBSD Wiki - ZFS</a></li>
<li><a href="https://wiki.freebsd.org/ZFSTuningGuide">FreeBSD Wiki - ZFS Tuning</a></li>
<li><a href="http://wiki.illumos.org/display/illumos/ZFS">Illumos Wiki - ZFS</a></li>
<li><a href="http://docs.oracle.com/cd/E19253-01/819-5461/index.html">Oracle Solaris ZFS Administration Guide</a></li>
<li><a href="https://calomel.org/zfs_raid_speed_capacity.html">Calomel Blog - ZFS Raidz Performance, Capacity and Integrity</a></li>
</ul>
<h3 id="特色與術語">特色與術語<a hidden class="anchor" aria-hidden="true" href="#特色與術語">#</a></h3>
<p>ZFS 是一個從本質上與眾不同的檔案系統，由於它並非只是一個檔案系統，ZFS 結合了檔案系統及磁碟區管理程式，讓額外的儲存裝置可以即時的加入到系統並可讓既有的檔案系統立即使用這些在儲存池中空間。透過結合傳統區分為二的兩個角色，ZFS 能夠克服以往 RAID 磁碟群組無法擴充的限制。每個在儲存池頂層的裝置稱作 <em>vdev</em>，其可以是一個簡單的磁碟或是一個 RAID 如鏡像或 RAID-Z 陣列。ZFS 的檔案系統 (稱作 <em>資料集 (Dataset)</em>) 每一個資料集均可存取整個存池所共通的可用空間，隨著使用儲存池來配置空間區塊，儲存池能給每個檔案系統使用的可用空間就會減少，這個方法可以避免擴大分割區會使的可用空間分散分割區之間的常見問題。</p>
<table>
<thead>
<tr>
<th>術語</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>儲存池 (Pool)</td>
<td><em>儲存池 (Pool)</em> 是建構 ZFS 最基礎的單位。一個儲存池可由一個或多個 vdev 所組成，是用來儲存資料的底層裝置。儲存池會被拿來建立一個或多個檔案系統 (資料集 Dataset) 或區塊裝置 (磁碟區 Volume)，這些資料集與磁碟區會共用儲存池的剩餘可用空間。每一個儲存池可由名稱與 GUID 來辨識。可用的功能會依儲存池上的 ZFS 版本而有不同。</td>
</tr>
<tr>
<td>vdev 型態 (vdev Types)</td>
<td>儲存池是由一個或多個 vdev 所組成，vdev 可以是一個磁碟或是 RAID Transform 的磁碟群組。當使用多個 vdev，ZFS 可以分散資料到各個 vdev 來增加效能與最大的可用空間。<em>磁碟 (Disk)</em> - 最基本的 vdev 型態便是一個標準的資料區塊裝置，這可以是一整個磁碟 (例如 <strong>/dev/ada0</strong> 或 <strong>/dev/da0</strong>) 或一個分割區 (<strong>/dev/ada0p3</strong>)。在 FreeBSD 上，使用分割區來替代整個磁碟不會影響效能，這可能與 Solaris 說明文件所建議的有所不同。<em>檔案 (File)</em> - 除了磁碟外，ZFS 儲存池可以使用一般檔案為基礎，這在測試與實驗時特別有用。在 <code>zpool create</code> 時使用檔案的完整路徑作為裝置路徑。所有 vdev 必須至少有 128 MB 的大小。<em>鏡像 (Mirror)</em> - 要建立鏡像，需使用 <code>mirror</code> 關鍵字，後面接著要做為該鏡像成員裝置的清單。一個鏡像需要由兩個或多個裝置來組成，所有的資料都會被寫入到所有的成員裝置。鏡像 vdev 可以對抗所有成員故障只剩其中一個而不損失任何資料。正常單一磁碟的 vdev 可以使用 <code>zpool attach</code> 隨時升級成為鏡像 vdev。<em>RAID-Z</em> - ZFS 實作了 RAID-Z，以標準的 RAID-5 修改而來，可提供奇偶校驗 (Parity) 更佳的分散性並去除了 &ldquo;RAID-5 write hole&rdquo; 導致在預期之外的重啟後資料與奇偶校驗資訊不一致的問題。ZFS 支援三個層級的 RAID-Z，可提供不同程度的備援來換取減少不同程度的可用空間，類型的名稱以陣列中奇偶校驗裝置的數量與儲存池可以容許磁碟故障的數量來命名，從 RAID-Z1 到 RAID-Z3 。在 RAID-Z1 配置 4 個磁碟，每個磁碟 1 TB，可用的儲存空間則為 3 TB，且若其中一個磁碟故障仍可以降級 (Degraded) 的模式運作，若在故障磁碟尚未更換並修復 (Resilver) 之前又有磁碟故障，所有在儲存池中的資料便會遺失。在 RAID-Z3 配置 8 個 1 TB 的磁碟，磁碟區將會可以提供 5 TB 的可用空間且在 3 個磁碟故障的情況下仍可運作。Sun™ 建議單一個 vdev 不要使用超過 9 個磁碟。若配置需要使用更多磁碟，建議分成兩個 vdev，這樣儲存池的資料便會分散到這兩個 vdev。使用兩個 RAID-Z2 各由 8 個磁碟組成的 vdev 的配置可以建立一個類似 RAID-60 的陣列。RAID-Z 群組的儲存空量會接近其中最小的磁碟乘上非奇偶校驗磁碟的數量。4 個 1 TB 磁碟在 RAID-Z1 會有接近 3 TB 的實際大小，且一個由 8 個 1 TB 磁碟組成的 RAID-Z3 陣列會有 5 TB 的可用空間。<em>備援 (Spare)</em> - ZFS 有特殊的虛擬 vdev 型態可用來持續追蹤可用的熱備援裝置 (Hot spare)。注意，安裝的熱備援裝置並不會自動佈署，熱備援裝置需要手動使用 <code>zfs replace</code> 設定替換故障的裝置。<em>日誌 (Log)</em> - ZFS 記錄裝置，也被稱作 ZFS 意圖日誌 (ZFS Intent Log, <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-zil">ZIL</a>) 會從正常的儲存池裝置移動意圖日誌到獨立的裝置上，通常是一個 SSD。有了獨立的日誌裝置，可以明顯的增進有大量同步寫入應用程式的效能，特別是資料庫。日誌裝置可以做成鏡像，但不支援 RAID-Z，若使用多個日誌裝置，寫入動作會被負載平衡分散到這些裝置。<em>快取 (Cache)</em> - 加入快取 vdev 到儲存池可以增加儲存空間的 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-l2arc">L2ARC</a> 快取。快取裝置無法做鏡像，因快取裝置只會儲存額外的現有資料的複本，並沒有資料遺失的風險。</td>
</tr>
<tr>
<td>交易群組 (Transaction Group, TXG)</td>
<td>交易群組是一種將更動的資料區塊包裝成一組的方式，最後再一次寫入到儲存池。交易群組是 ZFS 用來檢驗一致性的基本單位。每個交易群組會被分配一個獨一無二的 64-bit 連續代號。最多一次可以有三個活動中的交易群組，這三個交易群組的每一個都有這三種狀態：* <em>開放 (Open)</em> - 新的交易群組建立之後便處於開放的狀態，可以接受新的寫入動作。永遠會有開放狀態的交易群組，即始交易群組可能會因到達上限而拒絕新的寫入動作。一但開放的交易群組到達上限或到達 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-advanced-tuning-txg-timeout"><code>vfs.zfs.txg.timeout</code></a>，交易群組便會繼續進入下一個狀態。 * <em>靜置中 (Quiescing)</em> - 一個短暫的狀態，會等候任何未完成的操作完成，不會阻擋新開放的交易群組建立。一旦所有在群組中的交易完成，交易群組便會進入到最終狀態。 * <em>同步中 (Syncing)</em> - 所有在交易群組中的資料會被寫任到穩定的儲存空間，這個程序會依序修改其他也需同樣寫入到穩定儲存空間的資料，如 Metadata 與空間對應表。同步的程多會牽涉多個循環，首先是同步所有更改的資料區塊，也是最大的部份，接著是 Metadata，這可能會需要多個循環來完成。由於要配置空間供資料區塊使用會產生新的 Metadata，同步中狀態在到達循環完成而不再需要分配任何額外空間的狀態前無法結束。同步中狀態也是完成 <em>synctask</em> 的地方，Synctask 是指管理操作，如：建立或摧毀快照與資料集，會修改 uberblock，也會在此時完成。同步狀態完成後，其他處於狀態中狀態的交易群組便會進入同步中狀態。 所有管理功能如快照 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-snapshot"><code>Snapshot</code></a>) 會作為交易群組的一部份寫入。當 synctask 建立之後，便會加入到目前開放的交易群組中，然後該群組會盡快的進入同步中狀態來減少管理指令的延遲。</td>
</tr>
<tr>
<td>Adaptive Replacement Cache (ARC)</td>
<td>ZFS 使用了自適應替換快取 (Adaptive Replacement Cache, ARC)，而不是傳統的最近最少使用 (Least Recently Used, LRU) 快取，LRU 快取在快取中是一個簡單的項目清單，會依每個物件最近使用的時間來排序，新項會加入到清單的最上方，當快取額滿了便會去除清單最下方的項目來空出空間給較常使用的物件。ARC 結合了四種快取清單，最近最常使用 (Most Recently Used, MRU) 及最常使用 (Most Frequently Used, MFU) 物件加上兩個清單各自的幽靈清單 (Ghost list)，這些幽靈清單會追蹤最近被去除的物件來避免又被加回到快取，避免過去只有偶爾被使用的物件加入清單可以增加快取的命中率。同時使用 MRU 及 MFU 的另外一個優點是掃描一個完整檔案系統可以去除在 MRU 或 LRU 快取中的所有資料，有利於這些才剛存取的內容。使用 ZFS 也有 MFU 可只追蹤最常使用的物件並保留最常被存取的資料區塊快取。</td>
</tr>
<tr>
<td>L2ARC</td>
<td>L2ARC 是 ZFS 快取系統的第二層，主要的 ARC 會儲存在 RAM 當中，但因為 RAM 可用的空間量通常有限，因此 ZFS 也可以使用 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-vdev-cache">快取 vdev (Cache vdev)</a>。固態磁碟 (Solid State Disk, SSD) 常被拿來此處作為快取裝置，因為比起傳統旋轉碟片的磁碟，固態磁碟有較快的速度與較低的延遲。L2ARC 是選用的，但使用可以明顯增進那些已使用 SSD 快取的檔案讀取速度，無須從一般磁碟讀取。L2ARC 也同樣可以加速去重複 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-deduplication">Deduplication</a>)，因為 DDT 並不適合放在 RAM，但適合放在 L2ARC，比起要從磁碟讀取，可以加快不少速度。為了避免 SSD 因寫入次速過多而過早耗損，加入到快取裝置的資料速率會被限制，直到快取用盡 (去除第一個資料區塊來騰出空間) 之前，寫入到 L2ARC 的資料速率會限制在寫入限制 (Write limit) 與加速限制 (Boost limit) 的總合，之後則會限制為寫入限制，可以控制這兩個速度限制的 <a href="https://www.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> 數值分別為 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-advanced-tuning-l2arc_write_max"><code>vfs.zfs.l2arc_write_max</code></a> 控制每秒有多少數位元組可寫入到快取，而 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-advanced-tuning-l2arc_write_boost"><code>vfs.zfs.l2arc_write_boost</code></a> 可在 &ldquo;渦輪預熱階段&rdquo; (即寫入加速) 時增加寫入限制。</td>
</tr>
<tr>
<td>ZIL</td>
<td>ZIL 會使用比主要儲存池還更快的儲存裝置來加速同步寫入動作 (Synchronous transaction)，如 SSD。當應用程式請求做一個同步的寫入時 (保証資料會安全的儲存到磁碟，而不是先快取稍後再寫入)，資料會先寫入到速度較快的 ZIL 儲存空間，之後再一併寫入到一般的磁碟。這可大量的減少延遲並增進效能。ZIL 只會有利於使用像資料庫這類的同步工作，一般非同步的寫入像複製檔案，則完全不會用到 ZIL。</td>
</tr>
<tr>
<td>寫入時複製 (Copy-On-Write)</td>
<td>不像傳統的檔案系統，在 ZFS，當資料要被覆寫時，不會直接覆寫舊資料所在的位置，而是將新資料會寫入到另一個資料區塊，只在資料寫入完成後才會更新 Metadata 指向新的位置。因此，在發生寫入中斷 (在寫入檔案的過程中系統當機或電源中斷) 時，原來檔案的完整內容並不會遺失，只會放棄未寫入完成的新資料，這也意謂著 ZFS 在發生預期之外的關機後不需要做 <a href="https://www.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a>。</td>
</tr>
<tr>
<td>資料集 (Dataset)</td>
<td><em>資料集 (Dataset)</em> 是 ZFS 檔案系統、磁碟區、快照或複本的通用術語。每個資料集都有獨一無二的名稱使用 <em>poolname/path@snapshot</em> 格式。儲存池的根部技術上來說也算一個資料集，子資料集會採用像目錄一樣的層級來命名，例如 <em>mypool/home</em>，home 資料集是 <em>mypool</em> 的子資料集並且會繼承其屬性。這可以在往後繼續擴展成 <em>mypool/home/user</em>，這個孫資料集會繼承其父及祖父的屬性。在子資料集的屬性可以覆蓋預設繼承自父及祖父的屬性。資料集及其子資料級的管理權限可以委託 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-zfs-allow">Delegate</a>) 給他人。</td>
</tr>
<tr>
<td>檔案系統 (File system)</td>
<td>ZFS 資料集最常被當做檔案系統使用。如同大多數其他的檔案系統，ZFS 檔案系統會被掛載在系統目錄層級的某一處且內含各自擁有權限、旗標及 Metadata 的檔案與目錄。</td>
</tr>
<tr>
<td>磁碟區 (Volume)</td>
<td>除了一般的檔案系統資料集之外，ZFS 也可以建立磁碟區 (Volume)，磁碟區是資料區塊裝置。磁碟區有許多與資料集相似的功能，包含複製時寫入、快照、複本以及資料校驗。要在 ZFS 的頂層執行其他檔案系統格式時使用磁碟區非常有用，例如 UFS 虛擬化或匯出 iSCSI 延伸磁區 (Extent)。</td>
</tr>
<tr>
<td>快照 (Snapshot)</td>
<td>ZFS 的寫入時複製 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-cow">Copy-On-Write</a>, COW) 設計可以使用任意的名稱做到幾乎即時、一致的快照。在製做資料集的快照或父資料集遞迴快照 (會包含其所有子資料集) 之後，新的資料會寫入到資的資料區塊，但不會回收舊的資料區塊為可用空間，快照中會使用原版本的檔案系統，而快照之後所做的變更則會儲存在目前的檔案系統，因此不會重複使用額外的空間。當新的資料寫入到目前的檔案系統，便會配置新的資料區塊來儲存這些資料。快照表面大小 (Apparent size) 會隨著在目前檔案系統停止使用的資料區塊而成長，但僅限於快照。可以用唯讀的方式掛載這些快照來復原先前版本的檔案，也可以還原 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-zfs-snapshot">Rollback</a>) 目前的檔案系統到指定的快照，來還原任何在快照之後所做的變更。每個在儲存池中的資料區塊都會有一個參考記數器，可以用來持續追蹤有多少快照、複本、資料集或是磁碟區使用這個資料區塊，當刪除檔案與快照參照的計數變會滅少，直到沒有任何東西參考這個資料區塊才會被回收為可用空間。快照也可使用 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-zfs-snapshot">hold</a> 來標記，檔標記為 hold 時，任何嘗試要刪除該快照的動作便會回傳 <code>EBUSY</code> 的錯誤，每個快照可以標記多個不同唯一名稱的 hold，而 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-zfs-snapshot">release</a> 指令則可以移除 hold，這樣才可刪除快照。在磁碟區上快可以製作快照，但只能用來複製或還原，無法獨立掛載。</td>
</tr>
<tr>
<td>複本 (Clone)</td>
<td>快照也可以做複本，複本是可寫入版本的快照，讓檔案系統可分支成為新的資料集。如同快照，複本一開始不會消耗任何額外空間，隨著新資料寫入到複本會配置新的資料區塊，複本的表面大小 (Apparent size) 才會成長，當在複本檔案系統或磁碟區的資料區塊被覆寫時，在先前資料區塊的參考計數則會減少。建立複本所使用的快照無法被刪除，因為複本會相依該快照，快照為父，複本為子。複本可以被提升 (<em>promoted</em>)、反轉相依關係，來讓複本成為父，之前的父變為子，這個操作不需要額外的空間。由於反轉了父與子使用的空間量，所以可能會影響既有的配額 (Quota) 與保留空間 (Reservation)。</td>
</tr>
<tr>
<td>校驗碼 (Checksum)</td>
<td>配置每個資料區塊快的同時也會做資料校驗，資料校驗用的演算法是依資料集屬性而有所不同的，請參考 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-zfs-set"><code>set</code></a>。每個資料區塊會在讀取的過成便完成校驗，讓 ZFS 可以偵測到隱藏的損壞，若資料不符合預期的校驗碼，ZFS 會嘗試從任何可用的備援來還原資料，例如鏡像 (Mirror) 或 RAID-Z。要檢驗所有資料的校驗碼可以使用清潔 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-scrub"><code>Scrub</code></a>)，資料校驗的演算法有：* <code>fletcher2</code> * <code>fletcher4</code> * <code>sha256</code> <code>fletcher</code> 演算法最快，而 <code>sha256</code> 雖較消耗效能，但其有強大的密碼雜湊與較低的衝突率。也可關閉資料校驗，但並不建議。</td>
</tr>
<tr>
<td>壓縮 (Compression)</td>
<td>每個資料集都有壓縮 (Compression) 屬性，預設是關閉的，這個屬性可以設定使用以下幾個壓縮演算法的其中一個來壓縮寫入到資料集的新資料。壓縮除了減少空間使用量外，常也會增加讀取與寫入的吞吐量，因為會減少讀取與寫入的資料區塊。* <em>LZ4</em> - ZFS 儲存池版本 5000 (功能旗標) 後所增加，LZ4 現在是建議的壓縮演算法，在處理可壓縮的資料時 LZ4 壓縮比 LZJB 快將近 50%，在處理不可壓縮的資料時快將近三倍，LZ4 解壓縮也比 LZJB 將近 80%。在現代的 CPU 上，LZ4 經常平均可用 500 MB/s 的速度壓縮，而解壓縮可到達 1.5 GB/s (每個 CPU 核心)。* <em>LZJB</em> - 預設的壓縮演算法。由 Jeff Bonwick 所開發 (ZFS 的創始人之一)。LZJB 與 GZIP 相比，可以較低的 CPU 提供較佳的壓縮功能。在未來預設的壓縮演算法將會更換為 LZ4。* <em>GZIP</em> - 在 ZFS 可用的熱門串流壓縮演算法。使用 GZIP 主要的優點之一便是可設定壓縮層級。當設定 <code>compress</code> 屬性，管理者可以選擇壓縮層級範圍從最低的壓縮層級 <code>gzip1</code> 到最高的壓縮層級 <code>gzip9</code>。這讓管理者可以控制要使用多少 CPU 來節省磁碟空間。* <em>ZLE</em> - 零長度編號是一個特殊的壓縮演算法，它只會壓縮連續的零。這種壓縮演算法只在資料集中含有大量為零的資料區塊時有用。</td>
</tr>
<tr>
<td>備份數 (Copies)</td>
<td>當設定大於 1 的數值時，<code>copies</code> 屬性會指示 ZFS 備份每個在檔案系統 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-filesystem">File System</a>) 或磁碟區 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-volume">Volume</a>) 的資料區塊數份。在重要的資料集上設定這個屬性可以做額外的備援以在資料校驗碼不相符時可做復原。在沒有做備援的儲存池上，備份功能提供只是一種資料的備援方式，備份功能可以復原單一壞軌或其他情況的次要損壞，但無法復原儲存池中整個磁碟損壞所損失的資料。</td>
</tr>
<tr>
<td>去重複 (Deduplication)</td>
<td>校驗碼讓在寫入時可以偵測重複資料區塊，使用去重複，可以增加既有、完全相同的資料區塊參考數來節省儲存空間。要偵測重複的資料區塊需要在記憶體中儲存去重複資料表 (Deduplication table, DDT)，這個資料表中會有唯一的校驗碼清單、這些資料區塊的所在位置以及參考數。當寫入新資料時，便會計算校驗碼然後比對清單中是否有符合的既有資料區塊已在清單。去重複使用了 SHA256 校驗碼演算法來提供一個安全的加密雜湊，去重複功能是可以調校的，若 <code>dedup</code> 設為 <code>on</code> 只要符合校驗碼便會認為資料完全相同，若 <code>dedup</code> 設為 <code>verify</code> 則會一個一個位元檢查兩個資料區塊的資料來確保資料真的完全相同，若資料不同便會註記與雜湊衝突並會分別儲存兩個資料區塊。由於 DDT 須要儲存每個唯一資料區塊的雜湊，所以會消耗大量的記憶體，一般的經驗法則是每 1 TB 的去重複資料需要使用 5-6 GB 的記憶體。由於要有足夠的 RAM 來儲存整個 DDT 在實務上並不實際，導致在每個新資料區塊寫入前需要從磁碟來讀取 DDT 會對效能有很大的影響，去重複功能可以使用 L2ARC 儲存 DDT 以在快速的系統記憶體及較慢的磁碟之間取得一個平衡點。也可以考慮使用壓縮功能來取代此功能，因為壓縮也能節省相近的空間使用量而不需要大量額外的記憶體。</td>
</tr>
<tr>
<td>清潔 (Scrub)</td>
<td>ZFS 有 <code>scrub</code> 來替代 <a href="https://www.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a> 來做一致性的檢查。<code>scrub</code> 會讀取所有儲存在儲存池中的資料區塊並且根據儲存在 Metadata 中已知良好的校驗碼來檢驗這些資料區塊的校驗碼，定期檢查儲存池中儲存的所有資料可以確保實際使用這些資料前已將所有損壞的資料區塊復原。在不正常的關閉之後並不需要做清潔動作，但建議每三個月至少執行一次。在正常使用讀取時便會檢查每個資料區塊的校驗碼，但清潔動作可以確保那些不常用的資料也會被檢查以避免隱藏的損壞，如此便能增進資料的安全性，特別是對用來保存資料的儲存裝置。<code>scrub</code> 可以使用 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-advanced-tuning-scrub_delay"><code>vfs.zfs.scrub_delay</code></a> 調整相對優先權來避免清潔動作降低儲存池上其他工作的效率。</td>
</tr>
<tr>
<td>資料集配額 (Dataset Quota)</td>
<td>除了配額及空間保留外，ZFS 提供非常快速且準確的資料集、使用者及群組空間的計算功能，這可讓管理者調整空間配置的方式且可為重要的檔案系統保留空間。ZFS supports different types of quotas: the dataset quota, the <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-refquota">reference quota (refquota)</a>, the <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-userquota">user quota</a>, and the <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-groupquota">group quota</a>.配額會限制資料集及後裔包含資料集的快照、子資料集及子資料集的快照能使用的空間量。磁碟區上無法設定配額，因為 <code>volsize</code> 屬性已經被用來做內定的配額。</td>
</tr>
<tr>
<td>參考配額 (Reference Quota)</td>
<td>參考配額可以設定一個硬性限制 (Hard limit) 來限制資料集能使用的空間量，而這個硬性限制只包含了資料集參考的空間，並不含其後裔所使用的空間，如：檔案系統或快照。</td>
</tr>
<tr>
<td>使用者配額 (User Quota)</td>
<td>使用者配額在用來限制特定使用者能使用的空間量時非常有用。</td>
</tr>
<tr>
<td>群組配額 (Group Quota)</td>
<td>群組配額可以限制特定群組能使用的空間量。</td>
</tr>
<tr>
<td>資料集保留空間 (Dataset Reservation)</td>
<td><code>reservation</code> 屬性可以確保對特定資料集及其後裔最小可用的空間量，若在 <strong>storage/home/bob</strong> 設定 10 GB 的保留空間且其他資料集嘗試使用所有剩餘的空間時，會保留至少 10 GB 的空間供這個資料集使用。若要製作 <strong>storage/home/bob</strong> 的快照，該快照所使用的空間也會被列入保留空間計算。 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-refreservation"><code>refreservation</code></a> 屬性也以類似的方式運作，但是他 <em>不包含</em> 後裔，例如：快照。不管那一種保留空間在許多情境皆很有用，例如：要規劃與測試磁碟空間配置在新系統上的適應性，或是確保有足夠的空間供稽查日誌或系統還原程序及檔案使用。</td>
</tr>
<tr>
<td>參考保留空間 (Reference Reservation)</td>
<td><code>refreservation</code> 屬性可以確保對特定資料集 <em>不包含</em> 其後裔最小可用的空間，這代表若在 <strong>storage/home/bob</strong> 設定 10 GB 的保留空間且其他資料集嘗試使用所有剩餘的空間時，會保留至少 10 GB 的空間供這個資料集使用。於正常 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-reservation">reservation</a> 不同的是，由快照及後裔資料集所使用的空間並不會列入保留空間計算。例如，若要製作一個 <strong>storage/home/bob</strong> 的快照，在 <code>refreservation</code> 空間之外必須要有足夠的空間才能成功完成這項操作，主資料集的後裔並不會列入 <code>refreservation</code> 空間額計算，所以也不會佔用保留空間。</td>
</tr>
<tr>
<td>修復 (Resilver)</td>
<td>當有磁碟故障且被更換後，新的磁碟必須回存先前所遺失的資料，會使用分散在其他磁碟上的奇偶校驗資訊來計算並寫入遺失的資料到新的磁碟機的這個程序稱作 <em>修復 (Resilvering)</em>。</td>
</tr>
<tr>
<td>上線 (Online)</td>
<td>一個儲存池或 vdev 處於線上 (<code>Online</code>) 狀態時代表所有該裝置的成員均已連結且正常運作。個別裝置處於線上 (<code>Online</code>) 狀態時代表功能正常。</td>
</tr>
<tr>
<td>離線 (Offline)</td>
<td>若有足夠的備援可避免儲存池或 vdev 進入故障 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-faulted">Faulted</a>) 狀態，個別裝置若可由管理者設為離線 (<code>Offline</code>) 狀態，管理者可以選擇要設定那一個磁碟為離線來準備更換或是讓其更容易辨識。</td>
</tr>
<tr>
<td>降級 (Degraded)</td>
<td>一個儲存池或 vdev 處於降級 (<code>Degraded</code>) 狀態代表其有一個或多個磁碟已斷線或故障，此時儲存池仍可以使用，但只要再有其他的裝置故障，儲存池會無法復原。重新連線缺少的裝置或更換故障的磁碟，並在新裝置完成修復 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-resilver">Resilver</a>) 程序可讓儲存池返回線上 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-online">Online</a>) 狀態。</td>
</tr>
<tr>
<td>故障 (Faulted)</td>
<td>一個儲存池或 vdev 處於故障 (<code>Faulted</code>) 狀態代表無法運作，會無法存取在該裝置上的資料。當在 vdev 中缺少或故障的裝置數超過備援的層級，儲存池或 vdev 會進入故障 (<code>Faulted</code>) 狀態。若缺少的裝置可以重新連結上，儲存池便會返回線上 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-online">Online</a>) 狀態。若沒有足夠的備援可補償故障的磁碟數量便會遺失儲存池中的內容且只能從備份還原。</td>
</tr>
</tbody>
</table>
<h2 id="gentoo-on-zfshttpswikigentooorgwikiuserali3nxinstalling_gentoo_linux_efistub_on_zfs"><a href="https://wiki.gentoo.org/wiki/User:Ali3nx/Installing_Gentoo_Linux_EFISTUB_On_ZFS">Gentoo on ZFS</a><a hidden class="anchor" aria-hidden="true" href="#gentoo-on-zfshttpswikigentooorgwikiuserali3nxinstalling_gentoo_linux_efistub_on_zfs">#</a></h2>
<h3 id="备份httpswwwyafamoepostbackup-your-gentoo-system"><a href="https://www.yafa.moe/post/backup-your-gentoo-system/">备份</a><a hidden class="anchor" aria-hidden="true" href="#备份httpswwwyafamoepostbackup-your-gentoo-system">#</a></h3>
<h4 id="初始化硬盘">初始化硬盘<a hidden class="anchor" aria-hidden="true" href="#初始化硬盘">#</a></h4>
<p>这里的初始化硬盘是为了将原来的数据全部清除并且重新建立LUKS和文件系统。出于安全的考虑，备份不应该直接在硬盘上分区创建文件系统后备份在上面，应该做一层加密再去创建文件系统和备份。</p>
<p>将硬盘插入需要备份的电脑上</p>
<p>查看新增的设备</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fdisk -l
Disk /dev/sda: 232.9 GiB, <span style="color:#ae81ff">250055122432</span> bytes, <span style="color:#ae81ff">488388911</span> sectors
Disk model: 00AAJS-00B4A0
Units: sectors of <span style="color:#ae81ff">1</span> * 512 <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span> bytes
Sector size <span style="color:#f92672">(</span>logical/physical<span style="color:#f92672">)</span>: <span style="color:#ae81ff">512</span> bytes / <span style="color:#ae81ff">512</span> bytes
I/O size <span style="color:#f92672">(</span>minimum/optimal<span style="color:#f92672">)</span>: <span style="color:#ae81ff">512</span> bytes / <span style="color:#ae81ff">512</span> bytes
Disklabel type: dos
Disk identifier: 0x80f01a9c

Device     Boot Start       End   Sectors   Size Id Type
/dev/sda1        <span style="color:#ae81ff">2048</span> <span style="color:#ae81ff">488388910</span> <span style="color:#ae81ff">488386863</span> 232.9G <span style="color:#ae81ff">83</span> Linux
</code></pre></div><p>这里可以看到新添加的磁盘，上面是有以前的东西，这里为了安全起见用随机数据覆盖掉这个分区。 这里会清除可能存在的任何没有加密的旧数据，如果遭受攻击这会让攻击者更难确定数据位置，这一步会很慢（取决于你的接口速度和硬盘速率）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>/dev/urandom of<span style="color:#f92672">=</span>/dev/sda bs<span style="color:#f92672">=</span>1M status<span style="color:#f92672">=</span>progress <span style="color:#f92672">&amp;&amp;</span> sync
</code></pre></div><p>完成之后，我们需要重新对这个硬盘进行分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo fdisk /dev/sda

Welcome to fdisk <span style="color:#f92672">(</span>util-linux 2.35.2<span style="color:#f92672">)</span>.
Changes will remain in memory only, <span style="color:#66d9ef">until</span> you decide to write them.
Be careful before using the write command.


Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>: n
Partition type
   p   primary <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> primary, <span style="color:#ae81ff">0</span> extended, <span style="color:#ae81ff">4</span> free<span style="color:#f92672">)</span>
   e   extended <span style="color:#f92672">(</span>container <span style="color:#66d9ef">for</span> logical partitions<span style="color:#f92672">)</span>
Select <span style="color:#f92672">(</span>default p<span style="color:#f92672">)</span>:

Using default response p.
Partition number <span style="color:#f92672">(</span>1-4, default 1<span style="color:#f92672">)</span>:
First sector <span style="color:#f92672">(</span>2048-488388910, default 2048<span style="color:#f92672">)</span>:
Last sector, +/-sectors or +/-size<span style="color:#f92672">{</span>K,M,G,T,P<span style="color:#f92672">}</span> <span style="color:#f92672">(</span>2048-488388910, default 488388910<span style="color:#f92672">)</span>:

Created a new partition <span style="color:#ae81ff">1</span> of type <span style="color:#e6db74">&#39;Linux&#39;</span> and of size 232.9 GiB.

Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>: w
The partition table has been altered.
Calling ioctl<span style="color:#f92672">()</span> to re-read partition table.
Syncing disks.
</code></pre></div><p>这样就创建了一个分区，接下来我们要在这个分区上创建LUKS</p>
<h4 id="创建-luks">创建 LUKS<a hidden class="anchor" aria-hidden="true" href="#创建-luks">#</a></h4>
<p>我们这里可以使用<code>cryptsetup</code>这个命令来初始化我们的LUKS分区</p>
<p>如果你没有这个命令可以运行这条命令进行安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ emerge -av cryptsetup
</code></pre></div><p>然后初始化分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo cryptsetup luksFormat /dev/sda1
WARNING!
<span style="color:#f92672">========</span>
This will overwrite data on /dev/sda1 irrevocably.

Are you sure? <span style="color:#f92672">(</span>Type <span style="color:#e6db74">&#39;yes&#39;</span> in capital letters<span style="color:#f92672">)</span>: YES
Enter passphrase <span style="color:#66d9ef">for</span> /dev/sda1:
Verify passphrase:
</code></pre></div><p>这里会提示这个操作将会将这个分区里面的内容全部删掉，输入大写的YES确认，然后输入两次密码，注意密码是没有回显的。</p>
<h4 id="打开-luks-和创建文件系统">打开 LUKS 和创建文件系统<a hidden class="anchor" aria-hidden="true" href="#打开-luks-和创建文件系统">#</a></h4>
<p>现在是LUKS已经做好了，但是我们还需要在上面格式化分区才能够挂载使用，我们首先要打开LUKS分区：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo cryptsetup luksOpen /dev/sda1 backup
Password:
Enter passphrase <span style="color:#66d9ef">for</span> /dev/sda1:
</code></pre></div><p>我这里是想打开这个LUKS卷，为了区分和其他的我给这个名字叫做backup，然后会提示你输入LUKS的密码，正确输入之后就可以在<code>/dev/mappaer</code>下面看到一个<code>backup</code>的设备了</p>
<p>现在对这个分区进行格式化，这次用的是ext4的分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo mkfs.ext4 -v /dev/mapper/backup
</code></pre></div><h4 id="创建挂载点和挂载">创建挂载点和挂载<a hidden class="anchor" aria-hidden="true" href="#创建挂载点和挂载">#</a></h4>
<p>在完成了分区初始化之后我们还需要创建一个挂载点用于挂载这个备份的分区:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo mkdir -pv /backup
</code></pre></div><p>挂载分区:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo mount -v /dev/mapper/backup /backup
</code></pre></div><h4 id="备份系统">备份系统<a hidden class="anchor" aria-hidden="true" href="#备份系统">#</a></h4>
<p>下载就可以备份系统了，这次使用的是<code>rsync</code>工具来进行备份系统：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo rsync -aAXv --exclude<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;/dev/*&#34;</span>,<span style="color:#e6db74">&#34;/proc/*&#34;</span>,<span style="color:#e6db74">&#34;/sys/*&#34;</span>,<span style="color:#e6db74">&#34;/tmp/*&#34;</span>,<span style="color:#e6db74">&#34;/run/*&#34;</span>,<span style="color:#e6db74">&#34;/mnt/*&#34;</span>,<span style="color:#e6db74">&#34;/media/*&#34;</span>,<span style="color:#e6db74">&#34;/lost+found&#34;</span>,<span style="color:#e6db74">&#34;/backup/*&#34;</span>,<span style="color:#e6db74">&#34;/swapfile&#34;</span><span style="color:#f92672">}</span> / /backup
</code></pre></div><p>这里使用的<code>-aAXv</code>选项的意思是：文件将会以归档模式传输，保留符号设备，文件权限，修改时间，ACL和扩展属性，并且将备份的过程打印在屏幕上。</p>
<p><code>--exclude</code>就是排除特定的文件类似于<code>/dev</code>、<code>/proc</code>之类的，<code>/backup</code>是我们的备份分区不需要再去搞一份防止出现奇奇怪怪的后果。</p>
<p>这会耗费很多时间可以休息一下做其他的事情。</p>
<p>等待这个备份完成之后我们就可以卸载这块硬盘进行保存了。</p>
<p>卸载挂载点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ umount /backup
</code></pre></div><p>关闭LUKS分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cryptsetup luksClose backup
</code></pre></div><h3 id="迁移到-zfshttpswwwyafamoepostgentoo-on-zfs"><a href="https://www.yafa.moe/post/gentoo-on-zfs/">迁移到 ZFS</a><a hidden class="anchor" aria-hidden="true" href="#迁移到-zfshttpswwwyafamoepostgentoo-on-zfs">#</a></h3>
<h4 id="分区">分区<a hidden class="anchor" aria-hidden="true" href="#分区">#</a></h4>
<p>首先我需要把之前的分区全部干掉，然后创建如下表的分区：</p>
<table>
<thead>
<tr>
<th>分区</th>
<th>文件系统</th>
<th>大小</th>
</tr>
</thead>
<tbody>
<tr>
<td>/dev/nvme0n1p1</td>
<td>fat32</td>
<td>128M</td>
</tr>
<tr>
<td>/dev/nvme0n1p2</td>
<td>swap</td>
<td>64G</td>
</tr>
<tr>
<td>/dev/nvme0n1p3</td>
<td>ZFS</td>
<td>ALL</td>
</tr>
</tbody>
</table>
<p>直接在系统里面丢swapfile是不合理的，最好是有个单独的分区给swap。</p>
<h5 id="初始化分区">初始化分区<a hidden class="anchor" aria-hidden="true" href="#初始化分区">#</a></h5>
<p>创建完成分区之后我们还需要对分区进行初始化：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkfs.vfat -F32 /dev/nvme0n1p1
$ mkswap /dev/nvme0n1p2
</code></pre></div><h5 id="创建-pool">创建 pool<a hidden class="anchor" aria-hidden="true" href="#创建-pool">#</a></h5>
<p>这里需要注意一点是像是我们之前分区的<code>/dev/nvme0n</code>这种设备或者是<code>/dev/sda</code>这样的，如果插拔U盘之类的可能盘序会发生变化，但是ZFS池是不会意识到这个变化的，这样就会产生zfs池不可用的问题，我们需要一些方法来获取到磁盘的id并以此来创建我们的zfs池。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -l /dev/disk/by-id
lrwxrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">13</span> Feb <span style="color:#ae81ff">13</span> 12:29 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM -&gt; ../../nvme0n1
lrwxrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">15</span> Feb <span style="color:#ae81ff">13</span> 12:32 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part1 -&gt; ../../nvme0n1p1
lrwxrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">15</span> Feb <span style="color:#ae81ff">13</span> 12:29 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part2 -&gt; ../../nvme0n1p2
KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part3 -&gt; ../../nvme0n1p3
...
</code></pre></div><p>这里的<code>KXG50PNV2T04_KIOXIA_Y9IS103FTHDM</code>就是我们的硬盘，<code>nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part1</code>就是我们创建作为未来的<code>/boot</code>分区。</p>
<p>当我们创建zfs池的时候尽可能选择用这种id的方式去创建。现在我们创建一个加密的zpool：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zpool create -f -o ashift<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span> -o cachefile<span style="color:#f92672">=</span>/etc/zfs/zpool.cache -O compression<span style="color:#f92672">=</span>lz4 -O xattr<span style="color:#f92672">=</span>sa -O relatime<span style="color:#f92672">=</span>on -O acltype<span style="color:#f92672">=</span>posixacl -O dedup<span style="color:#f92672">=</span>off -O encryption<span style="color:#f92672">=</span>on -O keyformat<span style="color:#f92672">=</span>passphrase -m none -R /mnt/gentoo rock /dev/disk/by-id/nvme-eui.000000000000001000080d0200600f01-part3
</code></pre></div><p><a href="https://openzfs.github.io/openzfs-docs/man/7/zpoolprops.7.html">zpoolprops</a></p>
<ul>
<li><code>ashift=ashift</code>: Pool sector size exponent, to the power of <strong>2</strong> (internally referred to as <strong>ashift</strong>). The typical case for setting this property is when performance is important and the underlying disks use 4KiB sectors but report 512B sectors to the OS (for compatibility reasons); in that case, set <strong>ashift</strong>=<strong>12</strong> (which is <strong>1&laquo;12</strong> = <strong>4096</strong>).</li>
<li><code>cachefile=path|none</code>: Controls the location of where the pool configuration is cached. Setting this property caches the pool configuration in a different location that can later be imported with <code>zpool import -c</code>.</li>
</ul>
<p>根据提示输入密码（注意密码不会有回显，并不是键盘坏了）。</p>
<p>这条命令创建了一个名为 <code>rock</code>的zfs池 使用的压缩算法为<code>lz4</code>。</p>
<p>如果说你想创建一个不带加密的zpool可以去掉<code>-O encryption=on -O keyformat=passphrase</code>这两个选项。</p>
<h5 id="创建-datasets">创建 datasets<a hidden class="anchor" aria-hidden="true" href="#创建-datasets">#</a></h5>
<p>接下来我们要创建自己的rootfs，并且在上面打开加密功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs create -o mountpoint<span style="color:#f92672">=</span>none -o canmount<span style="color:#f92672">=</span>off rock/os
$ zfs create -o mountpoint<span style="color:#f92672">=</span>/ rock/os/gentoo
</code></pre></div><h4 id="安装系统">安装系统<a hidden class="anchor" aria-hidden="true" href="#安装系统">#</a></h4>
<p>这次安装系统的话，是打算直接从硬盘恢复的，首先插上备份好的硬盘：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fdisk -l
........
Disk /dev/sdc: 232.88 GiB, <span style="color:#ae81ff">250055122432</span> bytes, <span style="color:#ae81ff">488388911</span> sectors
Disk model: 00AAJS-00B4A0
Units: sectors of <span style="color:#ae81ff">1</span> * 512 <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span> bytes
Sector size <span style="color:#f92672">(</span>logical/physical<span style="color:#f92672">)</span>: <span style="color:#ae81ff">512</span> bytes / <span style="color:#ae81ff">512</span> bytes
I/O size <span style="color:#f92672">(</span>minimum/optimal<span style="color:#f92672">)</span>: <span style="color:#ae81ff">4096</span> bytes / <span style="color:#ae81ff">33553920</span> bytes
Disklabel type: dos
Disk identifier: 0x80f01a9c

Device     Boot Start       End   Sectors   Size Id Type
/dev/sdc1        <span style="color:#ae81ff">2048</span> <span style="color:#ae81ff">488388910</span> <span style="color:#ae81ff">488386863</span> 232.9G <span style="color:#ae81ff">83</span> Linux
</code></pre></div><p>这里看到我们的备份硬盘。我们要创建一个目录用来挂载这个分区：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir -pv /backup
</code></pre></div><p>打开LUKS分区：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cryptsetup luksOpen /dev/sdc1 backup
Enter passphrase <span style="color:#66d9ef">for</span> /dev/sdc1:
</code></pre></div><p>输入之前设置的密码。挂载分区：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mount -v /dev/mapper/backup /backup
</code></pre></div><p>还有一个分区我们要注意一下就是<code>/boot</code>分区，创建boot分区的挂载点：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir -pv /mnt/gentoo/boot
</code></pre></div><p>挂载分区：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mount -v /dev/nvme0n1p1 /mnt/gentoo/boot
</code></pre></div><p>将所有文件同步到zfs的dataset里面：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ rsync -aAXv --exclude<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;/dev/*&#34;</span>,<span style="color:#e6db74">&#34;/proc/*&#34;</span>,<span style="color:#e6db74">&#34;/sys/*&#34;</span>,<span style="color:#e6db74">&#34;/tmp/*&#34;</span>,<span style="color:#e6db74">&#34;/run/*&#34;</span>,<span style="color:#e6db74">&#34;/mnt/*&#34;</span>,<span style="color:#e6db74">&#34;/media/*&#34;</span>,<span style="color:#e6db74">&#34;/lost+found&#34;</span>,<span style="color:#e6db74">&#34;/backup/*&#34;</span>,<span style="color:#e6db74">&#34;/swapfile&#34;</span><span style="color:#f92672">}</span> /backup/ /mnt/gentoo
</code></pre></div><p>这个复制需要一定的时间，耐心等待完成，期间不要断开硬盘或者是拔掉电源。</p>
<h4 id="chroot">chroot<a hidden class="anchor" aria-hidden="true" href="#chroot">#</a></h4>
<p>等到复制原来的系统完成之后我们就需要进入chroot环境，然后完成其他的必要配置了。</p>
<p>拷贝ZFS池缓存文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir -pv /mnt/gentoo/etc/zfs
$ cp -v  /etc/zfs/zpool.cache /mnt/gentoo/etc/zfs
</code></pre></div><p>拷贝网络的DNS：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cp --dereference /etc/resolv.conf /mnt/gentoo/etc/
</code></pre></div><p>挂载必要的文件系统：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mount --types proc /proc /mnt/gentoo/proc
$ mount --rbind /sys /mnt/gentoo/sys
$ mount --make-rslave /mnt/gentoo/sys
$ mount --rbind /dev /mnt/gentoo/dev
$ mount --make-rslave /mnt/gentoo/dev
</code></pre></div><p>我们不是在官方的Livecd下面还需要执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ test -L /dev/shm <span style="color:#f92672">&amp;&amp;</span> rm /dev/shm <span style="color:#f92672">&amp;&amp;</span> mkdir /dev/shm
$ mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm
$ chmod <span style="color:#ae81ff">1777</span> /dev/shm
</code></pre></div><p>进入chroot：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ chroot /mnt/gentoo /bin/bash
$ source /etc/profile
$ export PS1<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;(chroot) </span>$PS1<span style="color:#e6db74">&#34;</span>
</code></pre></div><h4 id="zfs-安装和配置">ZFS 安装和配置<a hidden class="anchor" aria-hidden="true" href="#zfs-安装和配置">#</a></h4>
<p>首先是要给原来的系统安装上ZFS的支持，确保内核打开了Zlib的支持：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">General Architecture Dependent Options ---&gt;
  GCC plug ins  ---&gt;  
    <span style="color:#f92672">[</span> <span style="color:#f92672">]</span>   Randomize layout of sensitive kernel structures 
Cryptographic API ---&gt;
  &lt;*&gt; Deflate compression algorithm
Security options  ---&gt; 
  <span style="color:#f92672">[</span> <span style="color:#f92672">]</span> Harden common str/mem functions against buffer overflows
</code></pre></div><p>我们还需要调整portage让ZFS包接收测试分支的包：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo <span style="color:#e6db74">&#34;sys-fs/zfs-kmod ~amd64&#34;</span> &gt;&gt; /etc/portage/package.accept_keywords/zfs-kmod
$ echo <span style="color:#e6db74">&#34;sys-fs/zfs ~amd64&#34;</span> &gt;&gt; /etc/portage/package.accept_keywords/zfs
</code></pre></div><p>如果你想要使用实时的包可以:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo <span style="color:#e6db74">&#34;=sys-fs/zfs-kmod-9999 **&#34;</span> &gt;&gt; /etc/portage/package.accept_keywords/zfs-kmod
$ echo <span style="color:#e6db74">&#34;=sys-fs/zfs-9999 **&#34;</span> &gt;&gt; /etc/portage/package.accept_keywords/zfs
</code></pre></div><p>但是不推荐用最新的，要到处找patch。</p>
<p>安装ZFS：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ emerge -av zfs
</code></pre></div><p>有一个很重要的点，每次更新内核或者是编译内核之后最好是重新构建一下模块，否则有可能遇到zpool无法正常初始化的问题：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ emerge -va @module-rebuild
</code></pre></div><p>将zfs加入到开机启动项和对应的启动级别：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ systemctl enable zfs.target
$ systemctl enable zfs-import-cache
$ systemctl enable zfs-mount
$ systemctl enable zfs-import.target
</code></pre></div><p>生成和验证<code>zfs hostid</code>文件，这个文件是用于<code>genkernel</code>生成<code>initramfs</code>和zfs导入池的时候验证完整性时候需要的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zgenhostid
$ file /etc/hostid
</code></pre></div><h4 id="bootload-fstab-and-initramfs">Bootload fstab and Initramfs<a hidden class="anchor" aria-hidden="true" href="#bootload-fstab-and-initramfs">#</a></h4>
<h5 id="grub">GRUB<a hidden class="anchor" aria-hidden="true" href="#grub">#</a></h5>
<p>修改grub的配置文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">GRUB_CMDLINE_LINUX<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dozfs root=ZFS=rock/os/gentoo&#34;</span>
</code></pre></div><p>安装<code>bootload</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ grub-install --target<span style="color:#f92672">=</span>x86_64-efi --efi-directory<span style="color:#f92672">=</span>/boot --bootloader-id<span style="color:#f92672">=</span>Gentoo
</code></pre></div><p>生成配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ grub-mkconfig -o /boot/grub/grub.cfg
</code></pre></div><h5 id="fstab">fstab<a hidden class="anchor" aria-hidden="true" href="#fstab">#</a></h5>
<p>挂载的工作这次交给zfs来去完成，我们这里还需要修改一下fstab</p>
<p>首先查看分区的id：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ blkid
/dev/nvme0n1p1: UUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;129F-3405&#34;</span> BLOCK_SIZE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;512&#34;</span> TYPE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;vfat&#34;</span> PARTUUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;537bd932-cc1f-5643-a297-feebaeb6a5ea&#34;</span>
/dev/nvme0n1p2: LABEL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rock&#34;</span> UUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;7999529021869478878&#34;</span> UUID_SUB<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;11607083434113154920&#34;</span> BLOCK_SIZE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;4096&#34;</span> TYPE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zfs_member&#34;</span> PARTUUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;d68d6b86-a407-4141-a1a7-1379cbe1e049&#34;</span>
</code></pre></div><p>可以看到我们的<code>/boot</code>分分区UUID是<code>129F-3405</code>，现在可以修改<code>/etc/fstab</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ nano -w /etc/fstab
</code></pre></div><p>内容如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># /dev/nvme0n1p1</span>
/dev/nvme0n1p1      	/boot     	vfat      	rw,relatime,fmask<span style="color:#f92672">=</span>0022,dmask<span style="color:#f92672">=</span>0022,codepage<span style="color:#f92672">=</span>437,iocharset<span style="color:#f92672">=</span>iso8859-1,shortname<span style="color:#f92672">=</span>mixed,errors<span style="color:#f92672">=</span>remount-ro	<span style="color:#ae81ff">0</span> <span style="color:#ae81ff">2</span>
</code></pre></div><h5 id="initramfs">initramfs<a hidden class="anchor" aria-hidden="true" href="#initramfs">#</a></h5>
<p>重新生成<code>initramfs</code>，之前的<code>initramfs</code>没有zfs的支持这次要加上，为了保证工作正常还需要将<code>genkrenel</code>切换到testing分支</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo <span style="color:#e6db74">&#34;=sys-kernel/genkernel-9999 **&#34;</span> &gt; /etc/portage/package.accept_keywords/genkernel
</code></pre></div><p>更新<code>genkernel</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ emerge -av genkernel
</code></pre></div><p>重新生成<code>initramfs</code>文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ genkernel initramfs --zfs --compress-initramfs
</code></pre></div><h4 id="重启">重启<a hidden class="anchor" aria-hidden="true" href="#重启">#</a></h4>
<p>在重启验证之前我们需要先做一些清理工作</p>
<p>首先退出chroot环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ exit
</code></pre></div><p>卸载备份分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ umount -R /backup
</code></pre></div><p>关闭<code>backup</code>卷</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cryptsetup luksClose backup
</code></pre></div><p>然后就可以重启啦</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ reboot
</code></pre></div><p>重启之后第一次可能还是没办法正常进入系统，需要进入到shell里面导入一下zpool</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zpool import -f rock
</code></pre></div><p>设置一下分区挂载点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs set mountpoint<span style="color:#f92672">=</span>/ rock/os/gentoo
</code></pre></div><p>然后再重启一下就可以正常进入系统了。</p>
<h3 id="使用zfs备份httpswwwyafamoepostuse-zfs-backup-system"><a href="https://www.yafa.moe/post/use-zfs-backup-system/">使用ZFS备份</a><a hidden class="anchor" aria-hidden="true" href="#使用zfs备份httpswwwyafamoepostuse-zfs-backup-system">#</a></h3>
<h4 id="创建备份zfs池">创建备份ZFS池<a hidden class="anchor" aria-hidden="true" href="#创建备份zfs池">#</a></h4>
<p>首先进入livecd，查看设备：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fdisk -l
Disk /dev/nvme0n1: 1.86 TiB, <span style="color:#ae81ff">2048408248320</span> bytes, <span style="color:#ae81ff">4000797360</span> sectors
...

Disk /dev/sda: 233.76 GiB, <span style="color:#ae81ff">251000193024</span> bytes, <span style="color:#ae81ff">490234752</span> sectors
...

Disk /dev/sdc: 57.81 GiB, <span style="color:#ae81ff">62075699200</span> bytes, <span style="color:#ae81ff">121241600</span> sectors
...
</code></pre></div><p>这里的设备分别为：</p>
<table>
<thead>
<tr>
<th>物理位置</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>/dev/nvme0n1</td>
<td>系统盘</td>
</tr>
<tr>
<td>/dev/sda</td>
<td>备份盘</td>
</tr>
<tr>
<td>/dev/sdc</td>
<td>启动盘</td>
</tr>
</tbody>
</table>
<p>首先在备份盘上创建一个分区（分配所有空间到这个分区上）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fdisk /dev/sda
Welcome to fdisk <span style="color:#f92672">(</span>util-linux 2.36<span style="color:#f92672">)</span>.
Changes will remain in memory only, <span style="color:#66d9ef">until</span> you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table.
Created a new DOS disklabel with disk identifier 0x108318f9.

Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>: n
Partition type
   p   primary <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> primary, <span style="color:#ae81ff">0</span> extended, <span style="color:#ae81ff">4</span> free<span style="color:#f92672">)</span>
   e   extended <span style="color:#f92672">(</span>container <span style="color:#66d9ef">for</span> logical partitions<span style="color:#f92672">)</span>
Select <span style="color:#f92672">(</span>default p<span style="color:#f92672">)</span>:

Using default response p.
Partition number <span style="color:#f92672">(</span>1-4, default 1<span style="color:#f92672">)</span>:
First sector <span style="color:#f92672">(</span>2048-490234751, default 2048<span style="color:#f92672">)</span>:
Last sector, +/-sectors or +/-size<span style="color:#f92672">{</span>K,M,G,T,P<span style="color:#f92672">}</span> <span style="color:#f92672">(</span>2048-490234751, default 490234751<span style="color:#f92672">)</span>:

Created a new partition <span style="color:#ae81ff">1</span> of type <span style="color:#e6db74">&#39;Linux&#39;</span> and of size 233.8 GiB.

Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>: w
The partition table has been altered.
Calling ioctl<span style="color:#f92672">()</span> to re-read partition table.
Syncing disks.
</code></pre></div><p>查看硬盘ID</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -l /dev/disk/by-id
...
lrwxrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">10</span> Feb <span style="color:#ae81ff">27</span> 14:53 usb-ACASIS_MAC3E_000000000001-0:0-part1 -&gt; ../../sda1
...
</code></pre></div><p><code>usb-ACASIS_MAC3E_000000000001-0:0-part1</code>这里就是我们所需要的硬盘ID，我们使用这个来创建备份池子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zpool create -f -o ashift<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span> -o cachefile<span style="color:#f92672">=</span>/etc/zfs/zpool.cache -O compression<span style="color:#f92672">=</span>lz4 -O xattr<span style="color:#f92672">=</span>sa -O relatime<span style="color:#f92672">=</span>on -O acltype<span style="color:#f92672">=</span>posixacl -O dedup<span style="color:#f92672">=</span>off -m none -R /mnt/backup backup /dev/disk/by-id/usb-ACASIS_MAC3E_000000000001-0:0-part1
</code></pre></div><p>备份池也可以加密。</p>
<h4 id="创建快照">创建快照<a hidden class="anchor" aria-hidden="true" href="#创建快照">#</a></h4>
<p>首先导入原来的<code>zpool</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zpool import -f rock
</code></pre></div><p>给之前的系统创建一个快照：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo zfs snapshot rock/os/gentoo@2021-02-27-0000-01-install
</code></pre></div><p>查看</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs list -r -t snapshot -o name,creation rock/os/gentoo
rock/os/gentoo@2021-02-27-0000-01-install  Sat Feb <span style="color:#ae81ff">27</span> 14:16 <span style="color:#ae81ff">2021</span>
</code></pre></div><h4 id="发送快照">发送快照<a hidden class="anchor" aria-hidden="true" href="#发送快照">#</a></h4>
<p>我们需要打开原来的<code>rock/os/gentoo</code>数据集</p>
<p>但是首先要设置一下挂载点：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs set mountpoint<span style="color:#f92672">=</span>/mnt/gentoo rock/os/gentoo
</code></pre></div><p>打开<code>rock/os/gentoo</code>数据集</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs mount -l -a
</code></pre></div><p>发送快照到<code>backup/os/gentoo</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs send rock/os/gentoo@2021-02-27-0000-01-install |  zfs recv backup/2021-02-27-0000-01-backup
</code></pre></div><p>这个会花很长的时间，取决于你使用的接口速度，可以通过这条命令查看io情况：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zpool iostat <span style="color:#ae81ff">2</span> 
</code></pre></div><p>这条命令是查看所有的<code>zpool</code>io情况，2秒刷新一次。</p>
<h4 id="备份boot分区">备份<code>/boot</code>分区<a hidden class="anchor" aria-hidden="true" href="#备份boot分区">#</a></h4>
<p>设置挂载点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs set mountpoint<span style="color:#f92672">=</span>/mnt/backup backup/2021-02-27-0000-01-backup
</code></pre></div><p>备份</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir -pv /mnt/boot
$ mount -v /dev/nvme0n1p1 /mnt/boot
$ cp -rv /mnt/boot/* /mnt/backup/boot/
</code></pre></div><h4 id="恢复快照">恢复快照<a hidden class="anchor" aria-hidden="true" href="#恢复快照">#</a></h4>
<p>卸除挂载：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs umount backup/2021-02-27-0000-01-backup
</code></pre></div><p>现在就可以恢复快照了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs send backup/2021-02-27-0000-01-backup | zfs recv -F  -x encryption rock/os/gentoo
</code></pre></div><h4 id="定期备份">定期备份<a hidden class="anchor" aria-hidden="true" href="#定期备份">#</a></h4>
<p>在Gentoo的Portage Tree中提供了一个<code>sys-fs/zfs-auto-snapshot</code>的包，这个包可以帮我们创建一个定时任务周期性的备份我们的ZFS</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge -av sys-fs/zfs-auto-snapshot
</code></pre></div><p>可以根据需要配置备份的周期：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo zfs set com.sun:auto-snapshot:daily<span style="color:#f92672">=</span>true rock/os/gentoo
$ sudo zfs set com.sun:auto-snapshot:weekly<span style="color:#f92672">=</span>true rock/os/gentoo
</code></pre></div><h3 id="问题排查">问题排查<a hidden class="anchor" aria-hidden="true" href="#问题排查">#</a></h3>
<h4 id="grub-救援">grub 救援<a hidden class="anchor" aria-hidden="true" href="#grub-救援">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">grub rescue&gt; set prefix<span style="color:#f92672">=(</span>hd0,1<span style="color:#f92672">)</span>/boot/grub
grub rescue&gt; set root<span style="color:#f92672">=(</span>hd0,1<span style="color:#f92672">)</span>
grub rescue&gt; insmod normal
grub rescue&gt; normal
grub rescue&gt; insmod linux
grub rescue&gt; linux /boot/vmlinuz-3.13.0-29-generic dozfs root<span style="color:#f92672">=</span>ZFS<span style="color:#f92672">=</span>rock/os/gentoo
grub rescue&gt; initrd /boot/initrd.img-3.13.0-29-generic
grub rescue&gt; boot
</code></pre></div><h4 id="通过-livecd-修复">通过 livecd 修复<a hidden class="anchor" aria-hidden="true" href="#通过-livecd-修复">#</a></h4>
<p><strong>导入 zpool</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zpool import -f rock
$ zfs set mountpoint<span style="color:#f92672">=</span>/mnt/gentoo rock/os/gentoo
</code></pre></div><p><strong>挂载 dataset</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs mount -la
</code></pre></div><p><strong>挂载 boot 分区</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mount /dev/nvme0n1p1 /mnt/gentoo/boot/
</code></pre></div><p><strong>挂载必要的文件系统</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mount --types proc /proc /mnt/gentoo/proc
$ mount --rbind /sys /mnt/gentoo/sys
$ mount --make-rslave /mnt/gentoo/sys
$ mount --rbind /dev /mnt/gentoo/dev
$ mount --make-rslave /mnt/gentoo/dev
<span style="color:#75715e"># 我们不是在官方的Livecd下面还需要执行：</span>
$ test -L /dev/shm <span style="color:#f92672">&amp;&amp;</span> rm /dev/shm <span style="color:#f92672">&amp;&amp;</span> mkdir /dev/shm
$ mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm
$ chmod <span style="color:#ae81ff">1777</span> /dev/shm
</code></pre></div><p><strong>进入 chroot</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ chroot /mnt/gentoo /bin/bash
$ source /etc/profile
$ export PS1<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;(chroot) </span>$PS1<span style="color:#e6db74">&#34;</span>
</code></pre></div><p><strong>退出 chroot</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ exit 
</code></pre></div><p><strong>卸除挂载</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ umount -R /mnt/gentoo
</code></pre></div><p><strong>改回 rootfs 挂载点</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs set mountpoint<span style="color:#f92672">=</span>/ rock/os/gentoo
</code></pre></div><p><strong>重启</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ reboot
</code></pre></div><h2 id="lukshttpslinuxcnarticle-9640-1html"><a href="https://linux.cn/article-9640-1.html">LUKS</a><a hidden class="anchor" aria-hidden="true" href="#lukshttpslinuxcnarticle-9640-1html">#</a></h2>
<p>数据的安全，保密性在现在的生活中显得越来越重要。随着数字化的时代的来临，越来越多的数据被数字化，特别是更多有关于我们隐私的数据在不断生成，甚至还有我们需要离线保存的密钥等。而且通常我们使用磁盘，USB 闪存，SD  卡等存储介质进行存储，即便我们已经离线存储，仍然不能保证该存储介质不会丢失，如果丢失那么对于我们来说有可能是灾难性的事件。因此对这些离线存储的重要数据，再次进行进行加密是非常有必要的，本文将告诉你如何加密你的移动存储介质。</p>
<p>在此之前先介绍一下 LUKS：</p>
<blockquote>
<p>LUKS （Linux Unified Key Setup）是 Linux 硬盘加密的标准。  通过提供标准的磁盘格式，它不仅可以促进发行版之间的兼容性，还可以提供对多个用户密码的安全管理。 与现有解决方案相比，LUKS  将所有必要的设置信息存储在分区信息首部中，使用户能够无缝传输或迁移其数据。</p>
</blockquote>
<h3 id="内核配置可选">内核配置（可选）<a hidden class="anchor" aria-hidden="true" href="#内核配置可选">#</a></h3>
<p>通常来说，大部分发行版的内核都已经配置了相关的加密部分，因此非 gentoo 用户可以跳过此部分。</p>
<p>配置 device mapper 和 crypt target：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Enable loadable module support
    Device Drivers ---&gt;
        <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Multiple devices driver support <span style="color:#f92672">(</span>RAID and LVM<span style="color:#f92672">)</span> ---&gt;
            &lt;*&gt; Device mapper support
            &lt;*&gt;   Crypt target support
</code></pre></div><p>配置加密 API：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Cryptographic API ---&gt;
        &lt;*&gt; XTS support
        &lt;*&gt; SHA224 and SHA256 digest algorithm
        &lt;*&gt; AES cipher algorithms
        &lt;*&gt; AES cipher algorithms <span style="color:#f92672">(</span>x86_64<span style="color:#f92672">)</span>
        &lt;*&gt; User-space interface <span style="color:#66d9ef">for</span> hash algorithms
        &lt;*&gt; User-space interface <span style="color:#66d9ef">for</span> symmetric key cipher algorithms
</code></pre></div><p>编译新内核并配置应用，然后重启：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># make -j9 &amp;&amp; make modules_install &amp;&amp; make install</span>
</code></pre></div><h3 id="安装软件-1">安装软件<a hidden class="anchor" aria-hidden="true" href="#安装软件-1">#</a></h3>
<p>通常的发行版已经预装了该软件包，可以直接使用，下面是 Gentoo 的安装方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-fs/cryptsetup</span>
</code></pre></div><h3 id="创建加密分区">创建加密分区<a hidden class="anchor" aria-hidden="true" href="#创建加密分区">#</a></h3>
<p>注意，该操作会清空你选择分区或设备上的所有数据，请谨慎操作，输入大写的 <code>YES</code> 确认</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cryptsetup -s 512 luksFormat /dev/sdd</span>

WARNING!
<span style="color:#f92672">========</span>
This will overwrite data on /dev/sdd irrevocably.

Are you sure? <span style="color:#f92672">(</span>Type uppercase yes<span style="color:#f92672">)</span>: YES
Enter passphrase: 
Verify passphrase:
</code></pre></div><h3 id="利用密钥文件加密分区">利用密钥文件加密分区<a hidden class="anchor" aria-hidden="true" href="#利用密钥文件加密分区">#</a></h3>
<p>除了密码之外，还可以选择使用密钥文件解密你的硬盘，也就是相当于一个密钥，当然可以也可以只使用密钥文件或者同时使用密码与密钥文件。</p>
<h4 id="生成随机密钥文件">生成随机密钥文件<a hidden class="anchor" aria-hidden="true" href="#生成随机密钥文件">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># dd if=/dev/urandom of=/root/enc.key bs=1 count=4096</span>
</code></pre></div><h4 id="添加密钥文件作为密码之一">添加密钥文件作为密码之一<a hidden class="anchor" aria-hidden="true" href="#添加密钥文件作为密码之一">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cryptsetup luksAddKey  /dev/sdd /root/enc.key</span>
Enter any existing passphrase:
</code></pre></div><h3 id="移除解密密码">移除解密密码<a hidden class="anchor" aria-hidden="true" href="#移除解密密码">#</a></h3>
<p>移除普通密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cryptsetup luksRemoveKey /dev/sdd</span>
Enter LUKS passphrase to be deleted: ...
</code></pre></div><p>移除 key file 密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cryptsetup luksRemoveKey -d /root/enc.key /dev/sdd</span>
</code></pre></div><p><strong>注意</strong>：千万不要将所有密码移除，至少需要留有一个密码访问设备，移除操作不可撤销</p>
<h3 id="解密与挂载">解密与挂载<a hidden class="anchor" aria-hidden="true" href="#解密与挂载">#</a></h3>
<h4 id="密码解密">密码解密<a hidden class="anchor" aria-hidden="true" href="#密码解密">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cryptsetup luksOpen /dev/sdd myusb</span>
Enter passphrase <span style="color:#66d9ef">for</span> /dev/sdd:
</code></pre></div><h4 id="key-file-解密">key file 解密<a hidden class="anchor" aria-hidden="true" href="#key-file-解密">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cryptsetup luksOpen -d /root/enc.key /dev/sdd myusb</span>
</code></pre></div><h4 id="创建文件系统">创建文件系统<a hidden class="anchor" aria-hidden="true" href="#创建文件系统">#</a></h4>
<p>在挂载使用之前，我们仍然需要对设备创建文件系统才可以使用，可以选择任何你喜欢的文件系统，例如 <code>btrfs</code>，<code>ext4</code>，<code>vfat</code>，<code>ntfs</code> 等</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkfs.ext4 /dev/mapper/myusb</span>
mke2fs 1.43.6 <span style="color:#f92672">(</span>29-Aug-2017<span style="color:#f92672">)</span>
Creating filesystem with <span style="color:#ae81ff">488448</span> 4k blocks and <span style="color:#ae81ff">122160</span> inodes
Filesystem UUID: 995e172a-2bc6-432c-a60f-2d4d7093e748
Superblock backups stored on blocks:
32768, 98304, 163840, 229376, <span style="color:#ae81ff">294912</span>
Allocating group tables: <span style="color:#66d9ef">done</span>
Writing inode tables: <span style="color:#66d9ef">done</span>
Creating journal <span style="color:#f92672">(</span><span style="color:#ae81ff">8192</span> blocks<span style="color:#f92672">)</span>: <span style="color:#66d9ef">done</span>
Writing superblocks and filesystem accounting information: <span style="color:#66d9ef">done</span>
</code></pre></div><h4 id="挂载">挂载<a hidden class="anchor" aria-hidden="true" href="#挂载">#</a></h4>
<p>现在可以像正常分区一样挂载我们的加密分区设备了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mount /dev/mapper/myusb /mnt/</span>
<span style="color:#75715e"># df -h</span>
/dev/mapper/myusb  1.9G  5.7M  1.7G   1% /mnt
</code></pre></div><h4 id="卸载挂载点并关闭加密分区">卸载挂载点并关闭加密分区<a hidden class="anchor" aria-hidden="true" href="#卸载挂载点并关闭加密分区">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># umount /mnt</span>
<span style="color:#75715e"># cryptsetup luksClose myusb</span>
</code></pre></div><h3 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h3>
<p>在完成整个步骤以后，您现在需要做的就是妥善保管您的加密存储，可采用同样的方式加密多个设备进行备份，因为谁也不能保证这移动设备会不会在什么时候丢掉。</p>
<h2 id="双显卡笔记本独显直通httpswwwcodeplayerorgbloge58f8ce698bee58da1e7ac94e8aeb0e69cace78bace698bee79bb4e9809ahtml"><a href="https://www.codeplayer.org/Blog/%E5%8F%8C%E6%98%BE%E5%8D%A1%E7%AC%94%E8%AE%B0%E6%9C%AC%E7%8B%AC%E6%98%BE%E7%9B%B4%E9%80%9A.html">双显卡笔记本独显直通</a><a hidden class="anchor" aria-hidden="true" href="#双显卡笔记本独显直通httpswwwcodeplayerorgbloge58f8ce698bee58da1e7ac94e8aeb0e69cace78bace698bee79bb4e9809ahtml">#</a></h2>
<h3 id="介绍">介绍<a hidden class="anchor" aria-hidden="true" href="#介绍">#</a></h3>
<p>双显卡笔记本中直通独显（dGPU）到 win10 虚拟机。</p>
<p>环境：</p>
<ul>
<li>联想 Legion R7000P 2020 笔记本</li>
<li>RTX2060 笔记本显卡</li>
<li>libvirt+qemu</li>
<li>Host: Gentoo Linux</li>
<li>Guest: Windows 10 LTSC 2019</li>
</ul>
<h3 id="muxed">MUXed<a hidden class="anchor" aria-hidden="true" href="#muxed">#</a></h3>
<p>MUXed 结构的笔记本才容易实现独立显卡直通，Legion R7000P 应该就是 MUXed 的。关于什么是 MUXed 的，可以看下图的解释。</p>
<p><img loading="lazy" src="/Distributions/muxed.jpg" alt=""  />
</p>
<p>关于如何检测笔记本是否是 MUXed 的，目前没有什么好的办法。有一种说法是运行 lspci，查找有关 Intel HD Graphics/AMD GPU 和 NVIDIA 的设备：</p>
<ul>
<li>如果独显设备名以 3D Controller 开头，那你的电脑就是第二种 MUXless（核显直连显示器）。</li>
<li>如果独显设备名以 VGA Controller 开头，并且有一个 HD Graphics/AMD GPU 核显，那你的电脑是第三种 MUXed（核显、独显切换）。</li>
</ul>
<h3 id="启用-iommu-和-vfio-模块">启用 IOMMU 和 vfio 模块<a hidden class="anchor" aria-hidden="true" href="#启用-iommu-和-vfio-模块">#</a></h3>
<h4 id="iommu">IOMMU<a hidden class="anchor" aria-hidden="true" href="#iommu">#</a></h4>
<ul>
<li>intel CPU：添加内核参数 <code>intel_iommu=on iommu=pt</code> ，BIOS 开启 VT-d</li>
<li>amd CPU：添加内核参数 <code>iommu=pt</code> ，BIOS 开启 AMD-Vi</li>
</ul>
<h4 id="vfio">vfio<a hidden class="anchor" aria-hidden="true" href="#vfio">#</a></h4>
<p>添加模块 <code>vfio_pci vfio vfio_iommu_type1 vfio_virqfd</code> 到 initramfs 中。如果是像我一样使用 dracut 生成 initramfs，则在 <code>/etc/dracut.conf</code> 中添加配置 <code>add_drivers+=&quot; vfio_pci vfio vfio_iommu_type1 vfio_virqfd &quot;</code> ，之后重新生成 initramfs。</p>
<h3 id="隔离-gpu">隔离 GPU<a hidden class="anchor" aria-hidden="true" href="#隔离-gpu">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>shopt -s nullglob
<span style="color:#66d9ef">for</span> g in <span style="color:#e6db74">`</span>find /sys/kernel/iommu_groups/* -maxdepth <span style="color:#ae81ff">0</span> -type d | sort -V<span style="color:#e6db74">`</span>; <span style="color:#66d9ef">do</span>
    echo <span style="color:#e6db74">&#34;IOMMU Group </span><span style="color:#e6db74">${</span>g###*/<span style="color:#e6db74">}</span><span style="color:#e6db74">:&#34;</span>
    <span style="color:#66d9ef">for</span> d in $g/devices/*; <span style="color:#66d9ef">do</span>
        echo -e <span style="color:#e6db74">&#34;\t</span><span style="color:#66d9ef">$(</span>lspci -nns <span style="color:#e6db74">${</span>d###*/<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#66d9ef">done</span>;
<span style="color:#66d9ef">done</span>;
</code></pre></div><p>运行上述脚本，查看显卡所在的 IOMMU Group，并得到显卡相关设备的 device id。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">IOMMU Group 10:
        01:00.0 VGA compatible controller <span style="color:#f92672">[</span>0300<span style="color:#f92672">]</span>: NVIDIA Corporation TU106M <span style="color:#f92672">[</span>GeForce RTX <span style="color:#ae81ff">2060</span> Mobile<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>10de:1f15<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>rev a1<span style="color:#f92672">)</span>
        01:00.1 Audio device <span style="color:#f92672">[</span>0403<span style="color:#f92672">]</span>: NVIDIA Corporation TU106 High Definition Audio Controller <span style="color:#f92672">[</span>10de:10f9<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>rev a1<span style="color:#f92672">)</span>
        01:00.2 USB controller <span style="color:#f92672">[</span>0c03<span style="color:#f92672">]</span>: NVIDIA Corporation TU106 USB 3.1 Host Controller <span style="color:#f92672">[</span>10de:1ada<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>rev a1<span style="color:#f92672">)</span>
        01:00.3 Serial bus controller <span style="color:#f92672">[</span>0c80<span style="color:#f92672">]</span>: NVIDIA Corporation TU106 USB Type-C UCSI Controller <span style="color:#f92672">[</span>10de:1adb<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>rev a1<span style="color:#f92672">)</span>
</code></pre></div><p>如上所见，device id 分别为 <code>10de:1f15</code> 、 <code>10de:10f9</code> 、 <code>10de:1ada</code> 、 <code>10de:1adb</code> 。再将以上 deivce id 作为参数添加到内核参数或 <code>/etc/modprobe.d/vfio.conf</code> 中。</p>
<ul>
<li>内核参数：vfio-pci.ids=10de:1f15,10de:10f9,10de:1ada,10de:1adb</li>
<li><code>/etc/modprobe.d/vfio.conf</code> ：options vfio-pci ids=10de:1f15,10de:10f9,10de:1ada,10de:1adb</li>
</ul>
<p>dracut 必须将 device id 添加到内核参数中，并且添加参数 <code>rd.driver.pre=vfio_pci</code> 。</p>
<p>最后重启电脑。开机后通过命令 <code>lspci -k</code> 确认上述 device id 对应的设备在使用 vfio-pci 驱动。如果有各别设备没有使用 vfio-pci 驱动，则可以通过手动 unbind 和 bind 驱动的方式加载 vfio-pci 驱动。比如如果 0000:01:00.2 仍在使用 xhci_hcd 驱动，则：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># run as root</span>
echo -n <span style="color:#e6db74">&#34;0000:01:00.2&#34;</span> &gt; /sys/bus/pci/drivers/xhci_hcd/unbind
echo -n <span style="color:#e6db74">&#34;0000:01:00.2&#34;</span> &gt; /sys/bus/pci/drivers/vfio-pci/bind
</code></pre></div><h3 id="创建虚拟机">创建虚拟机<a hidden class="anchor" aria-hidden="true" href="#创建虚拟机">#</a></h3>
<p>首先使用 libvirt 创建一个非显卡直通的虚拟机，如果你有多余的显示器和键鼠，也可以直接创建显卡直通的虚拟机。这里我们假设没有多余的设备，并且之后使用 RDP 连接虚拟机。</p>
<p>首先下载<a href="https://msdn.itellyou.cn/">windows 10 LTSC 2019</a>和 <a href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso">virtio windows驱动</a>镜像。</p>
<p>创建虚拟机：</p>
<ul>
<li><code>Overview</code> ：Firmware 选择 UEFI x86_64:/usr/share/edk2-ovmf/OVMF_CODE.fd</li>
<li><code>CPUs</code> ：选择 Topology，Manually set CPU topology，Sockets 设为 1，Cores 按需要来，我设为 4，Threads 设置为 2。这样一共就分配了 4 核 8 线程的 CPU</li>
<li><code>Memory</code> ：内存我设置为 32G</li>
<li><code>SATA Disk</code> ：Disk Bus 选择 Virtio，可以最小化磁盘性能损耗</li>
<li><code>NIC</code> ：Device model 也选择 virtio</li>
<li>之后再添加一个 <code>Stroage</code> ，选择 Select custom storage 并选中之前下载的 virtio windows 驱动镜像，然后 Device type 选择 CDROM device</li>
<li>最后在 <code>Boot Options</code> 中选中需要启动的设备</li>
</ul>
<p>开始安装，在 windows 安装进行到选择硬盘的时候，通过之前加载的 virtio win 驱动的 CDROM，安装 virtio 的磁盘和网络驱动。具体参考可见视频 <a href="https://www.bilibili.com/video/BV1dQ4y1o78R">https://www.bilibili.com/video/BV1dQ4y1o78R</a> 的 29 分 35 秒。安装完毕进入 windows，开启远程桌面并记下 IP，之后通过 RDP 连接虚拟机。</p>
<h3 id="配置和优化-remotefx">配置和优化 RemoteFX<a hidden class="anchor" aria-hidden="true" href="#配置和优化-remotefx">#</a></h3>
<h4 id="配置-remotefx">配置 RemoteFX<a hidden class="anchor" aria-hidden="true" href="#配置-remotefx">#</a></h4>
<ol>
<li>通过 <code>Win+R</code> 运行 <code>gpedit.msc</code></li>
<li>定位到 <code>计算机配置</code> -&gt; <code>管理模板</code> -&gt; <code>Windows组件</code> -&gt; <code>远程桌面服务</code> -&gt; <code>远程桌面会话主机</code> -&gt; <code>远程会话环境</code>
<ul>
<li>开启 <code>对 RemoteApp 使用高级 RemoteFX 图形</code></li>
<li>（可选）开启 <code>配置 RemoteFX 自适应图形的图像质量</code> ，设置为高</li>
<li>开启 <code>为专门针对 Windows Server 2008 R2 SP1 设计的 RemoteFX 客户端启动 RemoteFX 编码</code></li>
<li>开启 <code>配置 RemoteFX 数据的压缩</code> ，并设置为不需使用 RDP 压缩算法
<ul>
<li>连接压缩会导致编码和解码时产生额外的延迟</li>
</ul>
</li>
</ul>
</li>
<li>定位到 <code>计算机配置</code> -&gt; <code>管理模板</code> -&gt; <code>Windows组件</code> -&gt; <code>远程桌面服务</code> -&gt; <code>远程桌面会话主机</code> -&gt; <code>远程会话环境</code> -&gt; <code>RemoteFX for Windows Server 2008 R2</code>
<ul>
<li>开启 <code>配置RemoteFX</code></li>
<li>（可选）开启 <code>使用RemoteFX时优化视觉体验</code> ，并都设置为最高</li>
</ul>
</li>
</ol>
<h4 id="解除-30-ish-fps-限制">解除 30-ish fps 限制<a hidden class="anchor" aria-hidden="true" href="#解除-30-ish-fps-限制">#</a></h4>
<ol>
<li>启动注册表编辑器</li>
<li>定位并单击以下注册表子键： <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations</code></li>
<li>在 <code>编辑</code> 菜单中选择 <code>新建</code> ，然后再选择 <code>DWORD（32位）值</code></li>
<li>输入 <code>DWMFRAMEINTERVAL</code> 并回车</li>
<li>右键 <code>DWMFRAMEINTERVAL</code> ，选择 <code>修改</code></li>
<li>选择十进制，并输入 15。该设置将最大帧率设置为每秒 60 帧 (FPS)。</li>
</ol>
<h3 id="显卡直通">显卡直通<a hidden class="anchor" aria-hidden="true" href="#显卡直通">#</a></h3>
<p>先关闭虚拟机。首先我们需要确认 host 和 guest 中的 GPU 硬件 ID 一致的，然而 Legion R7000P 中两者不一致，准确的来说是其中的 Sub ID 部分不一致，所以需要手动修改一下。首先通过命令 <code>lspci -nnk | egrep -A3 &quot;VGA|3D&quot;</code> 查看显卡的 Vendor ID 和 Device ID。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ lspci -nnk | egrep -A3 <span style="color:#e6db74">&#34;VGA|3D&#34;</span>
01:00.0 VGA compatible controller <span style="color:#f92672">[</span>0300<span style="color:#f92672">]</span>: NVIDIA Corporation TU106M <span style="color:#f92672">[</span>GeForce RTX <span style="color:#ae81ff">2060</span> Mobile<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>10de:1f15<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>rev a1<span style="color:#f92672">)</span>
        Subsystem: Lenovo TU106M <span style="color:#f92672">[</span>GeForce RTX <span style="color:#ae81ff">2060</span> Mobile<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>17aa:3a43<span style="color:#f92672">]</span>
        Kernel driver in use: vfio-pci
        Kernel modules: nouveau
--
06:00.0 VGA compatible controller <span style="color:#f92672">[</span>0300<span style="color:#f92672">]</span>: Advanced Micro Devices, Inc. <span style="color:#f92672">[</span>AMD/ATI<span style="color:#f92672">]</span> Renoir <span style="color:#f92672">[</span>1002:1636<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>rev c6<span style="color:#f92672">)</span>
        Subsystem: Lenovo Renoir <span style="color:#f92672">[</span>17aa:3a47<span style="color:#f92672">]</span>
        Kernel driver in use: amdgpu
        Kernel modules: amdgpu
</code></pre></div><p>其中 NVIDIA 独显的 Vendor ID 为 10de，Device ID 为 1f15。再用命令 <code>grep &quot;PCI_SUBSYS_ID=&quot; /sys/bus/pci/devices/0000:01:00.0/uevent</code> 查看 Sub Vendor ID 和 Sub Device ID。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ grep <span style="color:#e6db74">&#34;PCI_SUBSYS_ID=&#34;</span> /sys/bus/pci/devices/0000:01:00.0/uevent
PCI_SUBSYS_ID<span style="color:#f92672">=</span>17AA:3A47
</code></pre></div><p>其中 Sub Vendor ID 为 17AA，Sub Device ID 为 3A47。将 17AA 和 3A47 转换为十进制 6058 和 14919，并在虚拟机的 XML 中添加配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;domain</span> <span style="color:#a6e22e">xmlns:qemu=</span><span style="color:#e6db74">&#34;http://libvirt.org/schemas/domain/qemu/1.0&#34;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;kvm&#34;</span><span style="color:#f92672">&gt;</span>
  ...
  <span style="color:#f92672">&lt;qemu:commandline&gt;</span>
    <span style="color:#f92672">&lt;qemu:arg</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#39;-set&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;qemu:arg</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#39;device.hostdev0.x-pci-sub-vendor-id=6058&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;qemu:arg</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#39;-set&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;qemu:arg</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#39;device.hostdev0.x-pci-sub-device-id=14919&#39;</span><span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/qemu:commandline&gt;</span>
<span style="color:#f92672">&lt;/domain&gt;</span>
</code></pre></div><p>注意 XML 的第一行一定要添加 <code>xmlns:qemu=&quot;http://libvirt.org/schemas/domain/qemu/1.0&quot;</code> ，否则后面的配置无法成功添加。</p>
<p>在 libvirt 中添加硬件，选择 PCI Host Device，然后将 <code>0000:01:00.0 NVIDIA Corporation GeForce RTX 2060 Mobile</code> 和 <code>0000:01:00.1 NVIDIA Corporation High Definition Audio Controller</code> 等都添加进去。</p>
<p>最后再在 libvirt 中删除虚拟机的 <code>Display Spice</code> 和 <code>Video QXL</code> ，在 <code>CPUs</code> 中取消 Copy host CPU configuration 并将 Model 选择为 host passthrough。如果你需要直通鼠标和键盘，也可以在这个时候添加。</p>
<h3 id="创建网桥">创建网桥<a hidden class="anchor" aria-hidden="true" href="#创建网桥">#</a></h3>
<p>有线网卡的网桥创建起来较为简单，这里就不详细介绍了，有需要的可以查看我上一篇<a href="https://www.codeplayer.org/Blog/%E8%BD%AF%E8%B7%AF%E7%94%B1%E8%99%9A%E6%8B%9F%E6%9C%BA.html">软路由虚拟机</a>的 BLOG。因为是笔记本，所以这里主要介绍无线网卡的桥接方法。</p>
<p>先开启 proxy_arp 和 ip_forward，修改配置文件 <code>/etc/sysctl.conf</code> ，添加下述配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">net.ipv4.ip_forward <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
net.ipv4.conf.all.proxy_arp <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</code></pre></div><p>再点击 libvirt 菜单栏上的 <code>Edit</code> -&gt; <code>Connection Details</code> ，假设 host 的 ip 为 192.168.3.12，无线网卡为 wlp4s0，新建一个 Network， <code>Name</code> 设置为 proxyArp， <code>Mode</code> 选择 Routed， <code>Forward to</code> 选择 Physical device， <code>Device</code> 设置为 wlp4s0， IPv4 的 <code>Network</code> 设置为 192.168.3.100/28，完成创建。</p>
<p>然后修改 win10 虚拟机的 <code>NIC</code> 配置，将 <code>Network source</code> 改为 Virtual network &lsquo;proxyArp&rsquo;: Route to wlp4s0，最后重新启动虚拟机与物理机。</p>
<h3 id="远程连接">远程连接<a hidden class="anchor" aria-hidden="true" href="#远程连接">#</a></h3>
<p>重新启动虚拟机后，使用 RDP 连接到虚拟机中。到 nvidia 官网下载驱动，并进行安装。如果安装过程中并未出现问题，则至此显卡直通配置完成。另外如果不外接显示器的话，windows 的分辨率似乎会被限制在 640x480，不知道会不会对游戏有影响，所以有条件还是买一个 HDMI 欺骗器接到独显连接的显示接口上。</p>
<p>远程连接方式一共有三种，分别可以适用于不同的情况。</p>
<h4 id="rdp">RDP<a hidden class="anchor" aria-hidden="true" href="#rdp">#</a></h4>
<p>简单使用方法：</p>
<ul>
<li>确保使用 FreeRDP 2.0</li>
<li>获取 windows 虚拟机 IP，比如 192.168.3.108</li>
<li>xfreerdp /v:192.168.3.108:3389 /w:1600 /h:900 /bpp:32 +clipboard +fonts /gdi:hw /rfx /rfx-mode:video /sound:sys:pulse +menu-anims +window-drag</li>
</ul>
<p>对于使用 xfreedp 的 RemoteFX 连接的一些问题：</p>
<ul>
<li>只有窗口化的游戏可以运行，全屏将会触发 d3d11 0x087A0001 不能设置分辨率等问题。媒体播放器不受其影响。
<ul>
<li>作为解决方案，使用无边框模式游戏，或其他等效方案</li>
<li>windows 客户端似乎没有该问题</li>
</ul>
</li>
<li>由于 RDSH/RDVH 连接不支持“相对”鼠标，鼠标会乱跑
<ul>
<li>重定向 XBOX 手柄或 USB 摇杆可能会解决这个问题？</li>
<li>使用 Synergy (v1) 并启用相对鼠标模式</li>
<li>通过 RDP RemoteFX 运行 3D 游戏鼠标不稳定</li>
</ul>
</li>
</ul>
<h4 id="looking-glass">Looking glass<a hidden class="anchor" aria-hidden="true" href="#looking-glass">#</a></h4>
<p>Looking glass 的优点是低延迟，其并不是通过网络与虚拟机通信，而是直接使用一块共享内存。缺点是只能本地连接，而且似乎需要外接一个显示设备（或 HDMI 欺骗器）才能让键盘、鼠标正常工作，并且似乎不能使用 spice 套娃远程操作 looking glass。</p>
<h5 id="安装-client">安装 client<a hidden class="anchor" aria-hidden="true" href="#安装-client">#</a></h5>
<p>首先在 host 系统上安装 looking glass client，在 gentoo 上可以通过如下步骤直接安装我打包的 looking glass。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo eselect repository enable gig
$ sudo emerge --sync gig
$ sudo emerge -avt looking-glass
</code></pre></div><h5 id="计算内存大小">计算内存大小<a hidden class="anchor" aria-hidden="true" href="#计算内存大小">#</a></h5>
<p>通过以下公式，根据你期望的最大分辨率来计算内存大小。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">width x height x <span style="color:#ae81ff">4</span> x 2 <span style="color:#f92672">=</span> total bytes

total bytes / <span style="color:#ae81ff">1024</span> / 1024 <span style="color:#f92672">=</span> total megabytes + <span style="color:#ae81ff">10</span>
</code></pre></div><p>比如，我想要最大使用 4K 分辨率（3840x2160）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ae81ff">3840</span> x <span style="color:#ae81ff">2160</span> x <span style="color:#ae81ff">4</span> x 2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">66355200</span> bytes

<span style="color:#ae81ff">66355200</span> / <span style="color:#ae81ff">1024</span> / 1024 <span style="color:#f92672">=</span> 63.28 MB + 10 <span style="color:#f92672">=</span> 73.28
</code></pre></div><p>最后要注意内存的大小要上向取整到最接近的 2 的幂，在上面的例子中则应为 128。</p>
<h5 id="配置-libvirt">配置 libvirt<a hidden class="anchor" aria-hidden="true" href="#配置-libvirt">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">...
<span style="color:#f92672">&lt;devices&gt;</span>
    ...
  <span style="color:#f92672">&lt;shmem</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;looking-glass&#39;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;ivshmem-plain&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;size</span> <span style="color:#a6e22e">unit=</span><span style="color:#e6db74">&#39;M&#39;</span><span style="color:#f92672">&gt;</span>128<span style="color:#f92672">&lt;/size&gt;</span>
  <span style="color:#f92672">&lt;/shmem&gt;</span>
<span style="color:#f92672">&lt;/devices&gt;</span>
...
</code></pre></div><p>将以上内容添加到虚拟机的 XML 配置中，其中 128 即为上面计算出来的大小。</p>
<p>如果想要通过 spice 实现键盘和鼠标输入与剪贴板共享，则必须添加 spice 设备。</p>
<ul>
<li>
<p>在 libvirt 中，选择 <code>Add Hardware</code> ，然后再选择 <code>Graphics</code> ，使用默认的 spice 配置即可，最后完成添加</p>
</li>
<li>
<p>选择 <code>Video</code> 设备，然后在 <code>Model</code> 栏中输入 none，注意必须要完成这一步，否则可能会造成虚拟机不使用直通的显卡渲染</p>
</li>
<li>
<p>如果有 <code>tablet</code> 设备，则删除</p>
</li>
<li>
<p>如果没有 <code>Mouse</code> 设备，则添加一个</p>
</li>
<li>
<p>如果没有 <code>Keyboard</code> 设备，则添加一个</p>
<ul>
<li>这里使用 Virtio 的键盘可以更好的提高性能，然而 PS/2 的键盘没办法删掉，不知道被哪个设备依赖了，所以就使用 PS/2 的键盘了</li>
</ul>
</li>
<li>
<p>还有如果使用 Virtio 的键盘，则需要通过上面加载的 virtio windows 驱动 的 CDROM，以安装驱动</p>
</li>
</ul>
<h5 id="创建共享内存文件">创建共享内存文件<a hidden class="anchor" aria-hidden="true" href="#创建共享内存文件">#</a></h5>
<p>新建文件 <code>/etc/tmpfiles.d/10-looking-glass.conf</code> ，其内容为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#Type Path               Mode UID  GID Age Argument</span>
f /dev/shm/looking-glass <span style="color:#ae81ff">0660</span> user kvm -
</code></pre></div><p>将其中的 user，改为你自己的用户名。最后使用命令 <code>systemd-tmpfiles --create /etc/tmpfiles.d/10-looking-glass.conf</code> 创建共享内存文件，无需等待下次重启。</p>
<h5 id="安装-host">安装 host<a hidden class="anchor" aria-hidden="true" href="#安装-host">#</a></h5>
<p>首先需要在 windows 中安装 IVSHMEM 驱动，windows 不会自己安装 IVSHMEM 设备，相反它只会为该设备安装一个假驱动。先下载需要安装的驱动程序，https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/upstream-virtio/ ，注意必须下载 0.1.161 或更高的版本，最后将其解压。</p>
<p>安装 IVSHMEM 驱动需要打开 <code>设备管理器</code> ，然后在 <code>系统设备</code> 下，找到 <code>PCI标准内存控制器</code> ，然后选择 <code>更新驱动程序</code> ，再选择手动更新，选择我们之前下载并解压好的驱动目录，然后安装驱动即可。</p>
<p>host 需要在 windows 虚拟机中安装，先下载与 client 版本对应的 host 安装文件：https://looking-glass.io/downloads 。下载完成后解压、安装即可，完成后重启虚拟机，然后通过 log 文件查看其是否正常启动，log 在开始菜单里就有。</p>
<p>最后再安装一下 spice guest tools， <a href="https://www.spice-space.org/download.html#windows-binaries">https://www.spice-space.org/download.html#windows-binaries</a> ，以更好的支持鼠标与剪贴板共享。</p>
<h5 id="配置-client">配置 client<a hidden class="anchor" aria-hidden="true" href="#配置-client">#</a></h5>
<p>我使用的配置如下，将配置文件放在 <code>~/.looking-glass-client.ini</code> 或 <code>/etc/looking-glass-client.ini</code> ：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[app]</span>
<span style="color:#a6e22e">renderer</span><span style="color:#f92672">=</span><span style="color:#e6db74">egl</span>
<span style="color:#a6e22e">shmFile</span><span style="color:#f92672">=</span><span style="color:#e6db74">/dev/shm/looking-glass</span>

<span style="color:#66d9ef">[win]</span>
<span style="color:#a6e22e">borderless</span><span style="color:#f92672">=</span><span style="color:#e6db74">yes</span>
<span style="color:#a6e22e">fullScreen</span><span style="color:#f92672">=</span><span style="color:#e6db74">yes</span>
<span style="color:#a6e22e">size</span><span style="color:#f92672">=</span><span style="color:#e6db74">1920x1080</span>

<span style="color:#66d9ef">[input]</span>
<span style="color:#a6e22e">grabKeyboard</span><span style="color:#f92672">=</span><span style="color:#e6db74">yes</span>
<span style="color:#a6e22e">escapeKey</span><span style="color:#f92672">=</span><span style="color:#e6db74">97</span>

<span style="color:#66d9ef">[spice]</span>
<span style="color:#a6e22e">captureOnStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">yes</span>
</code></pre></div><p>由于我的笔记本没有 ScrLk 按键，所以将 escape 键设置为了 右 Ctrl 按键。</p>
<p>至此 looking glass 配置完成，运行命令 looking-glass-client 连接到虚拟机。</p>
<h5 id="配置-scream">配置 Scream<a hidden class="anchor" aria-hidden="true" href="#配置-scream">#</a></h5>
<p>由于 looking glass 不支持传递音频，所以我们还需要使用 Scream 将 VM 的音频传递给 host。</p>
<p>首先，编辑 windows 虚拟机的 XML，添加以下部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">...
<span style="color:#f92672">&lt;devices&gt;</span>
    ...
  <span style="color:#f92672">&lt;shmem</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;scream-ivshmem&#39;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;ivshmem-plain&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;size</span> <span style="color:#a6e22e">unit=</span><span style="color:#e6db74">&#39;M&#39;</span><span style="color:#f92672">&gt;</span>2<span style="color:#f92672">&lt;/size&gt;</span>
  <span style="color:#f92672">&lt;/shmem&gt;</span>
<span style="color:#f92672">&lt;/devices&gt;</span>
...
</code></pre></div><p>然后再如 looking glass 一样，添加配置文件 <code>/etc/tmpfiles.d/11-scream-ivshmem.conf</code> ，并运行命令 <code>systemd-tmpfiles --create /etc/tmpfiles.d/11-scream-ivshmem.conf</code> 。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">f   /dev/shm/scream-ivshmem <span style="color:#ae81ff">0660</span>    user    kvm -
</code></pre></div><p>如果没有安装 IVSHMEM 驱动，则需要安装一下，跟上面一样。然后下载 scream 的 windows 驱动，地址： <a href="https://github.com/duncanthrax/scream/releases">https://github.com/duncanthrax/scream/releases</a> ，解压并进行安装。</p>
<p>再以管理员权限在 CMD 中运行 <code>REG ADD HKLM\SYSTEM\CurrentControlSet\Services\Scream\Options /v UseIVSHMEM /t REG_DWORD /d 2</code> 。</p>
<p>在 Linux 物理机中安装 scream，然后创建配置文件 <code>~/.config/systemd/user/scream-ivshmem-pulse.service</code> ：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Scream IVSHMEM pulse receiver</span>
<span style="color:#a6e22e">After</span><span style="color:#f92672">=</span><span style="color:#e6db74">pulseaudio.service</span>
<span style="color:#a6e22e">Wants</span><span style="color:#f92672">=</span><span style="color:#e6db74">pulseaudio.service</span>

<span style="color:#66d9ef">[Service]</span>
<span style="color:#a6e22e">Type</span><span style="color:#f92672">=</span><span style="color:#e6db74">simple</span>
<span style="color:#a6e22e">ExecStartPre</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/bin/truncate -s 0 /dev/shm/scream-ivshmem</span>
<span style="color:#a6e22e">ExecStartPre</span><span style="color:#f92672">=</span><span style="color:#e6db74">/bin/dd if=/dev/zero of=/dev/shm/scream-ivshmem bs=1M count=2</span>
<span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/bin/scream -m /dev/shm/scream-ivshmem</span>

<span style="color:#66d9ef">[Install]</span>
<span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">default.target</span>
</code></pre></div><p>最后运行以下命令即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo systemctl start --user scream-ivshmem-pulse
$ sudo systemctl enable --user scream-ivshmem-pulse
</code></pre></div><p>这样就配置完成了，在 looing glass 里就可以听到声音了。</p>
<h4 id="steam-远程畅玩流式传输">steam 远程畅玩（流式传输）<a hidden class="anchor" aria-hidden="true" href="#steam-远程畅玩流式传输">#</a></h4>
<p>因为 RDP 的限制，像 steam 家庭串流或 Geforce Experience 的方式对游戏来说更为推荐。</p>
<p>如果不想每次串流游戏都输入密码解锁屏幕，则可以通过 RDP 以管理员权限运行 cmd，然后运行以下命令，也可以将其保存为脚本，方便以后使用。注意运行完该命令会立马断开 RDP。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">@powershell -NoProfile -ExecutionPolicy unrestricted -Command <span style="color:#e6db74">&#34;$sessionid=((quser $env:USERNAME | select -Skip 1) -split &#39;\s+&#39;)[2]; tscon $sessionid /dest:console&#34;</span> 2&gt; UnlockErrors.log
</code></pre></div><h3 id="benchmark">benchmark<a hidden class="anchor" aria-hidden="true" href="#benchmark">#</a></h3>
<p>简单运行了一下 3dmark 的 Time Spy，做虚拟机的图形性能测试。测试了以下几种情况：</p>
<ul>
<li>win10 + 物理机直接运行，3dmark 得分 6900</li>
<li>win10 + 虚拟机显卡直通 + 外接显示器，3dmark 得分 6000</li>
<li>win10 + 虚拟机显卡直通 + steam 串流，3dmark 得分 5600</li>
<li>win10 + 虚拟机显卡直通 + looking glass，3dmark 得分 5000，并且在加载的时候，画面延迟近 10 秒</li>
</ul>
<p>由此可见，想要玩游戏，还是最好外接显示器，或者起码使用 steam 串流吧，个人感觉 looking glass 的性能甚至可能没有 RDP 高，但 RDP 无法运行 3dmark，所以无法比较测试。另外这几种情况中，CPU 得分的差距更大，但一般游戏也不会占用过多 CPU 资源，所以这里并没有记录。</p>
<p>PS：win10 + 虚拟机显卡直通 + looking glass + HDMI 欺骗器，3dmark 得分也是 5600，looking glass 的性能有待进一步测试。</p>
<h3 id="参考链接">参考链接<a hidden class="anchor" aria-hidden="true" href="#参考链接">#</a></h3>
<ol>
<li>PCI passthrough via OVMF <a href="https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF">https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF</a></li>
<li>[GUIDE] Optimus laptop dGPU passthrough <a href="https://gist.github.com/Misairu-G/616f7b2756c488148b7309addc940b28">https://gist.github.com/Misairu-G/616f7b2756c488148b7309addc940b28</a></li>
<li>Vendor ID &amp; Device ID <a href="https://github.com/marcosscriven/ovmf-with-vbios-patch/issues/2">https://github.com/marcosscriven/ovmf-with-vbios-patch/issues/2</a></li>
<li>笔记本 Optimus MUXless 下的 Intel 和 NVIDIA 虚拟机显卡直通 <a href="https://lantian.pub/article/modify-computer/laptop-intel-nvidia-optimus-passthrough.lantian/">https://lantian.pub/article/modify-computer/laptop-intel-nvidia-optimus-passthrough.lantian/</a></li>
<li>ledis 的单显卡直通教程 <a href="https://github.com/ledisthebest/LEDs-single-gpu-passthrough/blob/main/README-cn.md">https://github.com/ledisthebest/LEDs-single-gpu-passthrough/blob/main/README-cn.md</a></li>
<li>Looking glass Installation <a href="https://looking-glass.io/docs/676/install">https://looking-glass.io/docs/676/install</a></li>
<li>Bridging Network Connections with Proxy ARP <a href="https://wiki.debian.org/BridgeNetworkConnectionsProxyArp">https://wiki.debian.org/BridgeNetworkConnectionsProxyArp</a></li>
<li>setup kvm on a wireless interface on a laptop machine <a href="https://unix.stackexchange.com/questions/159191/setup-kvm-on-a-wireless-interface-on-a-laptop-machine">https://unix.stackexchange.com/questions/159191/setup-kvm-on-a-wireless-interface-on-a-laptop-machine</a></li>
<li>桥接无线网卡 <a href="https://blog.lilydjwg.me/2020/5/19/bridged-wireless-network.215330.html">https://blog.lilydjwg.me/2020/5/19/bridged-wireless-network.215330.html</a></li>
</ol>
<h3 id="附录xml-配置">附录：XML 配置<a hidden class="anchor" aria-hidden="true" href="#附录xml-配置">#</a></h3>
<p>最后附上我的虚拟机的 XML 配置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;domain</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;kvm&#39;</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#a6e22e">xmlns:qemu=</span><span style="color:#e6db74">&#39;http://libvirt.org/schemas/domain/qemu/1.0&#39;</span><span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;name&gt;</span>win10<span style="color:#f92672">&lt;/name&gt;</span>
  <span style="color:#f92672">&lt;uuid&gt;</span>d5da831a-c1eb-4668-a864-0731557d80a0<span style="color:#f92672">&lt;/uuid&gt;</span>
  <span style="color:#f92672">&lt;metadata&gt;</span>
    <span style="color:#f92672">&lt;libosinfo:libosinfo</span> <span style="color:#a6e22e">xmlns:libosinfo=</span><span style="color:#e6db74">&#34;http://libosinfo.org/xmlns/libvirt/domain/1.0&#34;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;libosinfo:os</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;http://microsoft.com/win/10&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/libosinfo:libosinfo&gt;</span>
  <span style="color:#f92672">&lt;/metadata&gt;</span>
  <span style="color:#f92672">&lt;memory</span> <span style="color:#a6e22e">unit=</span><span style="color:#e6db74">&#39;KiB&#39;</span><span style="color:#f92672">&gt;</span>33554432<span style="color:#f92672">&lt;/memory&gt;</span>
  <span style="color:#f92672">&lt;currentMemory</span> <span style="color:#a6e22e">unit=</span><span style="color:#e6db74">&#39;KiB&#39;</span><span style="color:#f92672">&gt;</span>33554432<span style="color:#f92672">&lt;/currentMemory&gt;</span>
  <span style="color:#f92672">&lt;vcpu</span> <span style="color:#a6e22e">placement=</span><span style="color:#e6db74">&#39;static&#39;</span><span style="color:#f92672">&gt;</span>8<span style="color:#f92672">&lt;/vcpu&gt;</span>
  <span style="color:#f92672">&lt;resource&gt;</span>
    <span style="color:#f92672">&lt;partition&gt;</span>/machine<span style="color:#f92672">&lt;/partition&gt;</span>
  <span style="color:#f92672">&lt;/resource&gt;</span>
  <span style="color:#f92672">&lt;os&gt;</span>
    <span style="color:#f92672">&lt;type</span> <span style="color:#a6e22e">arch=</span><span style="color:#e6db74">&#39;x86_64&#39;</span> <span style="color:#a6e22e">machine=</span><span style="color:#e6db74">&#39;pc-q35-6.0&#39;</span><span style="color:#f92672">&gt;</span>hvm<span style="color:#f92672">&lt;/type&gt;</span>
    <span style="color:#f92672">&lt;loader</span> <span style="color:#a6e22e">readonly=</span><span style="color:#e6db74">&#39;yes&#39;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pflash&#39;</span><span style="color:#f92672">&gt;</span>/usr/share/edk2-ovmf/OVMF_CODE.fd<span style="color:#f92672">&lt;/loader&gt;</span>
    <span style="color:#f92672">&lt;nvram&gt;</span>/var/lib/libvirt/qemu/nvram/win10_VARS.fd<span style="color:#f92672">&lt;/nvram&gt;</span>
    <span style="color:#f92672">&lt;bootmenu</span> <span style="color:#a6e22e">enable=</span><span style="color:#e6db74">&#39;no&#39;</span><span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/os&gt;</span>
  <span style="color:#f92672">&lt;features&gt;</span>
    <span style="color:#f92672">&lt;acpi/&gt;</span>
    <span style="color:#f92672">&lt;apic/&gt;</span>
    <span style="color:#f92672">&lt;hyperv&gt;</span>
      <span style="color:#f92672">&lt;relaxed</span> <span style="color:#a6e22e">state=</span><span style="color:#e6db74">&#39;on&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;vapic</span> <span style="color:#a6e22e">state=</span><span style="color:#e6db74">&#39;on&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;spinlocks</span> <span style="color:#a6e22e">state=</span><span style="color:#e6db74">&#39;on&#39;</span> <span style="color:#a6e22e">retries=</span><span style="color:#e6db74">&#39;8191&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/hyperv&gt;</span>
    <span style="color:#f92672">&lt;vmport</span> <span style="color:#a6e22e">state=</span><span style="color:#e6db74">&#39;off&#39;</span><span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/features&gt;</span>
  <span style="color:#f92672">&lt;cpu</span> <span style="color:#a6e22e">mode=</span><span style="color:#e6db74">&#39;host-passthrough&#39;</span> <span style="color:#a6e22e">check=</span><span style="color:#e6db74">&#39;partial&#39;</span> <span style="color:#a6e22e">migratable=</span><span style="color:#e6db74">&#39;on&#39;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;topology</span> <span style="color:#a6e22e">sockets=</span><span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#a6e22e">dies=</span><span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#a6e22e">cores=</span><span style="color:#e6db74">&#39;4&#39;</span> <span style="color:#a6e22e">threads=</span><span style="color:#e6db74">&#39;2&#39;</span><span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/cpu&gt;</span>
  <span style="color:#f92672">&lt;clock</span> <span style="color:#a6e22e">offset=</span><span style="color:#e6db74">&#39;localtime&#39;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;timer</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;rtc&#39;</span> <span style="color:#a6e22e">tickpolicy=</span><span style="color:#e6db74">&#39;catchup&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;timer</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pit&#39;</span> <span style="color:#a6e22e">tickpolicy=</span><span style="color:#e6db74">&#39;delay&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;timer</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;hpet&#39;</span> <span style="color:#a6e22e">present=</span><span style="color:#e6db74">&#39;no&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;timer</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;hypervclock&#39;</span> <span style="color:#a6e22e">present=</span><span style="color:#e6db74">&#39;yes&#39;</span><span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/clock&gt;</span>
  <span style="color:#f92672">&lt;on_poweroff&gt;</span>destroy<span style="color:#f92672">&lt;/on_poweroff&gt;</span>
  <span style="color:#f92672">&lt;on_reboot&gt;</span>restart<span style="color:#f92672">&lt;/on_reboot&gt;</span>
  <span style="color:#f92672">&lt;on_crash&gt;</span>destroy<span style="color:#f92672">&lt;/on_crash&gt;</span>
  <span style="color:#f92672">&lt;pm&gt;</span>
    <span style="color:#f92672">&lt;suspend-to-mem</span> <span style="color:#a6e22e">enabled=</span><span style="color:#e6db74">&#39;no&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;suspend-to-disk</span> <span style="color:#a6e22e">enabled=</span><span style="color:#e6db74">&#39;no&#39;</span><span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/pm&gt;</span>
  <span style="color:#f92672">&lt;devices&gt;</span>
    <span style="color:#f92672">&lt;emulator&gt;</span>/usr/bin/qemu-system-x86_64<span style="color:#f92672">&lt;/emulator&gt;</span>
    <span style="color:#f92672">&lt;disk</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;file&#39;</span> <span style="color:#a6e22e">device=</span><span style="color:#e6db74">&#39;disk&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;driver</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;qemu&#39;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;qcow2&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;source</span> <span style="color:#a6e22e">file=</span><span style="color:#e6db74">&#39;/var/lib/libvirt/images/win10.qcow2&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;3&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;backingStore/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">dev=</span><span style="color:#e6db74">&#39;vda&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;virtio&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;boot</span> <span style="color:#a6e22e">order=</span><span style="color:#e6db74">&#39;1&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;virtio-disk0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x04&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/disk&gt;</span>
    <span style="color:#f92672">&lt;disk</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;file&#39;</span> <span style="color:#a6e22e">device=</span><span style="color:#e6db74">&#39;cdrom&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;driver</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;qemu&#39;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;raw&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;source</span> <span style="color:#a6e22e">file=</span><span style="color:#e6db74">&#39;/home/petrus/Downloads/iso/cn_windows_10_enterprise_ltsc_2019_x64_dvd_9c09ff24.iso&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;2&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;backingStore/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">dev=</span><span style="color:#e6db74">&#39;sdb&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;sata&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;readonly/&gt;</span>
      <span style="color:#f92672">&lt;boot</span> <span style="color:#a6e22e">order=</span><span style="color:#e6db74">&#39;2&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;sata0-0-1&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;drive&#39;</span> <span style="color:#a6e22e">controller=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">target=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">unit=</span><span style="color:#e6db74">&#39;1&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/disk&gt;</span>
    <span style="color:#f92672">&lt;disk</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;file&#39;</span> <span style="color:#a6e22e">device=</span><span style="color:#e6db74">&#39;cdrom&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;driver</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;qemu&#39;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;raw&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;source</span> <span style="color:#a6e22e">file=</span><span style="color:#e6db74">&#39;/home/petrus/Downloads/iso/virtio-win-0.1.185.iso&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;1&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;backingStore/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">dev=</span><span style="color:#e6db74">&#39;sdc&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;sata&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;readonly/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;sata0-0-2&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;drive&#39;</span> <span style="color:#a6e22e">controller=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">target=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">unit=</span><span style="color:#e6db74">&#39;2&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/disk&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;usb&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;qemu-xhci&#39;</span> <span style="color:#a6e22e">ports=</span><span style="color:#e6db74">&#39;15&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;usb&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x02&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;sata&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;0&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;ide&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x1f&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x2&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-root&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie.0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">chassis=</span><span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0x10&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pci.1&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x02&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span> <span style="color:#a6e22e">multifunction=</span><span style="color:#e6db74">&#39;on&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;2&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">chassis=</span><span style="color:#e6db74">&#39;2&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0x11&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pci.2&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x02&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x1&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;3&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">chassis=</span><span style="color:#e6db74">&#39;3&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0x12&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pci.3&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x02&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x2&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;4&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">chassis=</span><span style="color:#e6db74">&#39;4&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0x13&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pci.4&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x02&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x3&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;5&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">chassis=</span><span style="color:#e6db74">&#39;5&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0x14&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pci.5&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x02&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x4&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;6&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">chassis=</span><span style="color:#e6db74">&#39;6&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0x15&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pci.6&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x02&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x5&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;7&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">chassis=</span><span style="color:#e6db74">&#39;7&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0x8&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pci.7&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x01&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span> <span style="color:#a6e22e">multifunction=</span><span style="color:#e6db74">&#39;on&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;8&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">chassis=</span><span style="color:#e6db74">&#39;8&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0x9&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pci.8&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x01&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x1&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;9&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">chassis=</span><span style="color:#e6db74">&#39;9&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0xa&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pci.9&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x01&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x2&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;10&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">chassis=</span><span style="color:#e6db74">&#39;10&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0xb&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pci.10&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x01&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x3&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;11&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-to-pci-bridge&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie-pci-bridge&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pci.11&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x0a&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;12&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pcie-root-port&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">chassis=</span><span style="color:#e6db74">&#39;12&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0xc&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;pci.12&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x01&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x4&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;controller</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;virtio-serial&#39;</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">&#39;0&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;virtio-serial0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x03&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/controller&gt;</span>
    <span style="color:#f92672">&lt;interface</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;network&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;mac</span> <span style="color:#a6e22e">address=</span><span style="color:#e6db74">&#39;52:54:00:9c:b1:61&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;source</span> <span style="color:#a6e22e">network=</span><span style="color:#e6db74">&#39;proxyArp&#39;</span> <span style="color:#a6e22e">portid=</span><span style="color:#e6db74">&#39;dea4d995-d8d9-408d-ac30-ac45bfd5627e&#39;</span> <span style="color:#a6e22e">bridge=</span><span style="color:#e6db74">&#39;virbr1&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">dev=</span><span style="color:#e6db74">&#39;vnet0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;virtio&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;net0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x01&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/interface&gt;</span>
    <span style="color:#f92672">&lt;serial</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pty&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;source</span> <span style="color:#a6e22e">path=</span><span style="color:#e6db74">&#39;/dev/pts/0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;isa-serial&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0&#39;</span><span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;isa-serial&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;/target&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;serial0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/serial&gt;</span>
    <span style="color:#f92672">&lt;console</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pty&#39;</span> <span style="color:#a6e22e">tty=</span><span style="color:#e6db74">&#39;/dev/pts/0&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;source</span> <span style="color:#a6e22e">path=</span><span style="color:#e6db74">&#39;/dev/pts/0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;serial&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;serial0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/console&gt;</span>
    <span style="color:#f92672">&lt;channel</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;spicevmc&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;virtio&#39;</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;com.redhat.spice.0&#39;</span> <span style="color:#a6e22e">state=</span><span style="color:#e6db74">&#39;connected&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;channel0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;virtio-serial&#39;</span> <span style="color:#a6e22e">controller=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;1&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/channel&gt;</span>
    <span style="color:#f92672">&lt;input</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;mouse&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;ps2&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;input0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/input&gt;</span>
    <span style="color:#f92672">&lt;input</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;keyboard&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;ps2&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;input1&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/input&gt;</span>
    <span style="color:#f92672">&lt;graphics</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;spice&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;5900&#39;</span> <span style="color:#a6e22e">autoport=</span><span style="color:#e6db74">&#39;yes&#39;</span> <span style="color:#a6e22e">listen=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;listen</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;address&#39;</span> <span style="color:#a6e22e">address=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;image</span> <span style="color:#a6e22e">compression=</span><span style="color:#e6db74">&#39;off&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;gl</span> <span style="color:#a6e22e">enable=</span><span style="color:#e6db74">&#39;no&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/graphics&gt;</span>
    <span style="color:#f92672">&lt;sound</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;ich9&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;sound0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x1b&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/sound&gt;</span>
    <span style="color:#f92672">&lt;audio</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;spice&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;video&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;none&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;video0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/video&gt;</span>
    <span style="color:#f92672">&lt;hostdev</span> <span style="color:#a6e22e">mode=</span><span style="color:#e6db74">&#39;subsystem&#39;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">managed=</span><span style="color:#e6db74">&#39;yes&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;driver</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;vfio&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;source&gt;</span>
        <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x01&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;/source&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;hostdev0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x06&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/hostdev&gt;</span>
    <span style="color:#f92672">&lt;hostdev</span> <span style="color:#a6e22e">mode=</span><span style="color:#e6db74">&#39;subsystem&#39;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">managed=</span><span style="color:#e6db74">&#39;yes&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;driver</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;vfio&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;source&gt;</span>
        <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x01&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x1&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;/source&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;hostdev1&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x07&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/hostdev&gt;</span>
    <span style="color:#f92672">&lt;hostdev</span> <span style="color:#a6e22e">mode=</span><span style="color:#e6db74">&#39;subsystem&#39;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">managed=</span><span style="color:#e6db74">&#39;yes&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;driver</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;vfio&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;source&gt;</span>
        <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x01&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x2&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;/source&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;hostdev2&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x08&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/hostdev&gt;</span>
    <span style="color:#f92672">&lt;hostdev</span> <span style="color:#a6e22e">mode=</span><span style="color:#e6db74">&#39;subsystem&#39;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">managed=</span><span style="color:#e6db74">&#39;yes&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;driver</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;vfio&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;source&gt;</span>
        <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x01&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x3&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;/source&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;hostdev3&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x09&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/hostdev&gt;</span>
    <span style="color:#f92672">&lt;redirdev</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;usb&#39;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;spicevmc&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;redir0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;usb&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;2&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/redirdev&gt;</span>
    <span style="color:#f92672">&lt;redirdev</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;usb&#39;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;spicevmc&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;redir1&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;usb&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#39;3&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/redirdev&gt;</span>
    <span style="color:#f92672">&lt;memballoon</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;virtio&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;balloon0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x05&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x00&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/memballoon&gt;</span>
    <span style="color:#f92672">&lt;shmem</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;looking-glass&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;ivshmem-plain&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;size</span> <span style="color:#a6e22e">unit=</span><span style="color:#e6db74">&#39;M&#39;</span><span style="color:#f92672">&gt;</span>128<span style="color:#f92672">&lt;/size&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;shmem0&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x0b&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x01&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/shmem&gt;</span>
    <span style="color:#f92672">&lt;shmem</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;scream-ivshmem&#39;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;ivshmem-plain&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;size</span> <span style="color:#a6e22e">unit=</span><span style="color:#e6db74">&#39;M&#39;</span><span style="color:#f92672">&gt;</span>2<span style="color:#f92672">&lt;/size&gt;</span>
      <span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;shmem1&#39;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;pci&#39;</span> <span style="color:#a6e22e">domain=</span><span style="color:#e6db74">&#39;0x0000&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0x0b&#39;</span> <span style="color:#a6e22e">slot=</span><span style="color:#e6db74">&#39;0x02&#39;</span> <span style="color:#a6e22e">function=</span><span style="color:#e6db74">&#39;0x0&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/shmem&gt;</span>
  <span style="color:#f92672">&lt;/devices&gt;</span>
  <span style="color:#f92672">&lt;seclabel</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;dynamic&#39;</span> <span style="color:#a6e22e">model=</span><span style="color:#e6db74">&#39;dac&#39;</span> <span style="color:#a6e22e">relabel=</span><span style="color:#e6db74">&#39;yes&#39;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;label&gt;</span>+77:+77<span style="color:#f92672">&lt;/label&gt;</span>
    <span style="color:#f92672">&lt;imagelabel&gt;</span>+77:+77<span style="color:#f92672">&lt;/imagelabel&gt;</span>
  <span style="color:#f92672">&lt;/seclabel&gt;</span>
  <span style="color:#f92672">&lt;qemu:commandline&gt;</span>
    <span style="color:#f92672">&lt;qemu:arg</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#39;-set&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;qemu:arg</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#39;device.hostdev0.x-pci-sub-vendor-id=6058&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;qemu:arg</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#39;-set&#39;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;qemu:arg</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#39;device.hostdev0.x-pci-sub-device-id=14919&#39;</span><span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/qemu:commandline&gt;</span>
<span style="color:#f92672">&lt;/domain&gt;</span>
</code></pre></div><h2 id="apps">Apps<a hidden class="anchor" aria-hidden="true" href="#apps">#</a></h2>
<h3 id="中文字体httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle4b8ade69687e5ad97e4bd93"><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93">中文字体</a><a hidden class="anchor" aria-hidden="true" href="#中文字体httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle4b8ade69687e5ad97e4bd93">#</a></h3>
<p>在应用之前，最好先安装好中文字体和 <a href="https://www.reddit.com/r/Gentoo/comments/i26kj3/some_emojis_are_not_displayed_on_my_chrome/">emojis</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge media-fonts/noto-cjk media-fonts/noto-emoji</span>
<span style="color:#75715e"># eselect fontconfig list</span>
<span style="color:#75715e"># eselect fontconfig enable 70-noto-cjk.conf</span>
</code></pre></div><p>也可以将字体文件复制到目录 <code>~/.local/share/fonts/</code> 下，然后执行 <code>fc-cache -f -v</code> 创建字体缓存。</p>
<h4 id="改善字体渲染效果httpszhuanlanzhihucomp343934880"><a href="https://zhuanlan.zhihu.com/p/343934880">改善字体渲染效果</a><a hidden class="anchor" aria-hidden="true" href="#改善字体渲染效果httpszhuanlanzhihucomp343934880">#</a></h4>
<ul>
<li>
<p>安装字体：下载<a href="https://github.com/be5invis/Sarasa-Gothic">更纱黑体</a></p>
<p>TUNA (CN): <a href="https://mirrors.tuna.tsinghua.edu.cn/github-release/be5invis/Sarasa-Gothic">https://mirrors.tuna.tsinghua.edu.cn/github-release/be5invis/Sarasa-Gothic</a></p>
<p>NJU (CN): <a href="https://mirror.nju.edu.cn/github-release/be5invis/Sarasa-Gothic">https://mirror.nju.edu.cn/github-release/be5invis/Sarasa-Gothic</a></p>
</li>
<li>
<p>调整系统字体：系统设置 -&gt; 字体</p>
<p>在系统字体设置那将那些默认的noto sans字体改为更纱黑体即可，前三个最好相应调大一个等级。等距字体可以使用等距更纱黑体，也可以使用你喜欢的等距字体。</p>
<p><img loading="lazy" src="/Distributions/v2-7bde73db7d1a88d0e9bf3123879d99ca_r.jpg" alt=""  />
</p>
</li>
<li>
<p>调整系统缩放：系统设置 -&gt; 显示和监控 -&gt; 显示配置 -&gt; 缩放显示</p>
<p>默认是100%，可以调整到110～120之间，具体数值根据自己效果设定</p>
</li>
<li>
<p>调整字体DPI：系统设置 -&gt; 字体 -&gt; 勾选“固定字体DPI”并调整DPI的值</p>
<p>默认是96，同样也可以调整到110~120之间，具体数值根据自己效果设定</p>
</li>
<li>
<p>调整字体展示优先级：将下述内容保存为 ~/.fonts.conf文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span style="color:#75715e">&lt;!DOCTYPE fontconfig SYSTEM &#34;fonts.dtd&#34;&gt;</span>
<span style="color:#f92672">&lt;fontconfig&gt;</span>
  <span style="color:#f92672">&lt;alias&gt;</span>
    <span style="color:#f92672">&lt;family&gt;</span>sans-serif<span style="color:#f92672">&lt;/family&gt;</span>
    <span style="color:#f92672">&lt;prefer&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Gothic SC<span style="color:#f92672">&lt;/family&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Gothic TC<span style="color:#f92672">&lt;/family&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Gothic J<span style="color:#f92672">&lt;/family&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Gothic K<span style="color:#f92672">&lt;/family&gt;</span>
    <span style="color:#f92672">&lt;/prefer&gt;</span>
  <span style="color:#f92672">&lt;/alias&gt;</span>
  <span style="color:#f92672">&lt;alias&gt;</span>
    <span style="color:#f92672">&lt;family&gt;</span>monospace<span style="color:#f92672">&lt;/family&gt;</span>
    <span style="color:#f92672">&lt;prefer&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Mono SC<span style="color:#f92672">&lt;/family&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Mono TC<span style="color:#f92672">&lt;/family&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Mono J<span style="color:#f92672">&lt;/family&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Mono K<span style="color:#f92672">&lt;/family&gt;</span>
    <span style="color:#f92672">&lt;/prefer&gt;</span>
  <span style="color:#f92672">&lt;/alias&gt;</span>
<span style="color:#f92672">&lt;/fontconfig&gt;</span>
</code></pre></div></li>
</ul>
<p>调整完之后注销重新登入</p>
<h3 id="输入法httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle8be93e585a5e6b395"><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E8%BE%93%E5%85%A5%E6%B3%95">输入法</a><a hidden class="anchor" aria-hidden="true" href="#输入法httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle8be93e585a5e6b395">#</a></h3>
<p>作为中文用户，肯定需要款输入法，我推荐使用 fcitx （还有一款叫 ibus）。目前稳定维护的 fcitx 版本是 5 ，但是官方仓库 <code>::gentoo</code> 目前只有 4 （也能用，就是不怎么维护了）。</p>
<h4 id="官方仓库-fcitx4">官方仓库 fcitx4<a hidden class="anchor" aria-hidden="true" href="#官方仓库-fcitx4">#</a></h4>
<p><strong>重要</strong>：先配置下 fcitx4 开启对 gtk2 的支持以避免有些程序无法使用（gtk3 默认开启了）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;app-i18n/fcitx gtk2&#39; &gt;&gt; /etc/portage/package.use/fcitx</span>
</code></pre></div><p>然后安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-i18n/fcitx:4 app-i18n/fcitx-configtool:4 app-i18n/fcitx-qt5:4 app-i18n/fcitx-libpinyin:4</span>
</code></pre></div><p>其中：</p>
<ul>
<li>app-i18n/fcitx 是 fcitx 的主程序</li>
<li>app-i18n/fcitx-configtool 是它的配置工具</li>
<li>app-i18n/fcitx-qt5 用于支持在 qt 程序上使用它</li>
<li>app-i18n/fcitx-libpinyin 是一个输入法</li>
</ul>
<h4 id="额外仓库-fcitx5">额外仓库 fcitx5<a hidden class="anchor" aria-hidden="true" href="#额外仓库-fcitx5">#</a></h4>
<p>为使用最新的 fcitx5，这里需要使用额外的仓库 ，因为官方仓库目前（2021-11-23）没有。提供 fcitx5 的 Gentoo 仓库（Overlay）推荐 <a href="https://github.com/gentoo-mirror/gentoo-zh">gentoo-zh</a> 。具体方法为：</p>
<ul>
<li>
<p>先安装添加额外的仓库必要的工具</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-eselect/eselect-repository</span>
</code></pre></div></li>
<li>
<p>然后启用仓库，启用过程中，可能会因为网络原因导致比较慢，请耐心等待</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect repository enable gentoo-zh</span>
</code></pre></div></li>
<li>
<p>更新以获取下仓库内容。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge dev-vcs/git</span>
<span style="color:#75715e"># emerge --sync gentoo-zh</span>
</code></pre></div><p>如果一直卡在这里，那说明当前网络访问 github.com 不流畅。这时候有一种方法是：访问 <a href="https://fastgit.org">https://fastgit.org</a> （我不对该网站做任何保证），　修改 <code>/etc/portage/repos.conf/eselect-repo.conf</code> 文件，替换对应链接的域名为上述网站内指定值，并再次同步。</p>
</li>
<li>
<p>添加 portage 配置用于安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /etc/portage/package.mask/</span>
<span style="color:#75715e"># nano /etc/portage/package.mask/gentoo-zh</span>
*/*::gentoo-zh

<span style="color:#75715e"># mkdir -p /etc/portage/package.unmask/</span>
<span style="color:#75715e"># nano /etc/portage/package.unmask/fcitx5</span>
app-i18n/fcitx5-meta::gentoo-zh
app-i18n/fcitx5::gentoo-zh
app-i18n/fcitx5-configtool::gentoo-zh
app-i18n/fcitx5-chinese-addons::gentoo-zh
app-i18n/fcitx5-gtk::gentoo-zh
app-i18n/fcitx5-qt::gentoo-zh
app-i18n/libime::gentoo-zh
x11-libs/xcb-imdkit::gentoo-zh

<span style="color:#75715e"># mkdir -p /etc/portage/package.accept_keywords</span>
<span style="color:#75715e"># nano /etc/portage/package.accept_keywords/fcitx5</span>
app-i18n/fcitx5-meta ~amd64
app-i18n/fcitx5 ~amd64
app-i18n/fcitx5-configtool ~amd64
app-i18n/fcitx5-chinese-addons ~amd64
app-i18n/fcitx5-gtk ~amd64
app-i18n/fcitx5-qt ~amd64
app-i18n/libime ~amd64
x11-libs/xcb-imdkit ~amd64
</code></pre></div></li>
<li>
<p>之后安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-i18n/fcitx5-meta</span>
</code></pre></div><p>或者</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># EGIT_OVERRIDE_REPO_FCITX_LIBIME=https://hub.fastgit.org/fcitx/libime.git EGIT_OVERRIDE_REPO_KPU_KENLM=https://hub.fastgit.org/kpu/kenlm.git emerge app-i18n/fcitx5-meta</span>
</code></pre></div><p>这里安装了 fcitx 的元包，它会自动依赖安装 fcitx5 主体、 RIME 输入法、配置工具等，这个仓库也会默认安装上 fcitx5-chinese-addons ，里面包含有中文输入法。</p>
<p>如果安装的时候长时间停止在校验 manifest，尝试用 eclean 清除  distfiles 和 packages。可能原因是混合使用了 gentoo（官方） 和 gentoo-zh（overlay）。</p>
</li>
<li>
<p>最后安装<a href="https://github.com/felixonmars/fcitx5-pinyin-zhwiki">肥猫百万大词库</a>：</p>
<p>Download latest version of &ldquo;zhwiki.dict&rdquo; from <a href="https://github.com/felixonmars/fcitx5-pinyin-zhwiki/releases">https://github.com/felixonmars/fcitx5-pinyin-zhwiki/releases</a></p>
<p>Copy into <code>~/.local/share/fcitx5/pinyin/dictionaries/</code> (create the folder if it does not exist)</p>
</li>
</ul>
<p><strong>提示</strong>：</p>
<ul>
<li>
<p>当使用非官方的 Fcitx5 时，因为没有镜像收录，所以源码需从 Github 下载，这时可能遇到因网络问题导致无法下载的情况（可以从 <code>/var/log/emerge-fetch.log</code> 文件查看源码包下载情况），如果遇到这种情况那么请自行通过各种途径下载好对应的 <code>.tar.gz</code> 格式（或类似）软件包，然后移动到 <code>/var/cache/distfiles/</code> 目录下。</p>
</li>
<li>
<p>软件包需更名为对应的包名加完整的版本号（执行上述 <code>emerge &lt;包名&gt;</code> 命令后可以看到完整的版本号），比如当显示的包名为 <code>app-i18n/fcitx-gtk-5.0.8:5::gentoo-zh</code> 那么就更名下载的源码包为 <code>fcitx-gtk-5.0.8.tar.gz</code> （ <code>/</code> 符号后以及 <code>:</code> 符号前的内容），以此类推。</p>
</li>
<li>
<p>或者，在 emerge-fetch.log 可以看到下载链接和类似如下的行</p>
<pre tabindex="0"><code>Saving to: ‘/var/cache/distfiles/fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2.__download__’
</code></pre><p>通过下载链接下载文件后，改名为删除 <code>.__download__</code> 剩余部分，如 <code>fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2</code>，然后删除对应的 <code>/var/cache/distfiles/fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2.__download__</code> 缓存文件，并把重命名的文件移动到 <code>/var/cache/distfiles/</code>。</p>
</li>
</ul>
<h5 id="拥抱fcitx5httpsblogcoelacanthusmoepoststechwelcome-to-fcitx5"><a href="https://blog.coelacanthus.moe/posts/tech/welcome-to-fcitx5/">拥抱Fcitx5</a><a hidden class="anchor" aria-hidden="true" href="#拥抱fcitx5httpsblogcoelacanthusmoepoststechwelcome-to-fcitx5">#</a></h5>
<p><strong>起因</strong></p>
<p>2015年12月，<del>计科杀手</del> csslayer 创建了<a href="https://github.com/fcitx/fcitx5">fcitx/fcitx5</a>代码库，独自开始了对 Fcitx5 的开发。</p>
<p>如今五年过去了，Fcitx5 也日渐成熟。（个人感觉算法上相当不错</p>
<p>今年年初，我从 <code>fcitx-rime</code> 换到 <code>fcitx5-rime</code> ，感觉并不明显 <del>（毕竟对于 Rime 用户来说从4到5最大的变化是界面</del></p>
<p>然后，<del>在 Arch Linux CN 众多群友的诱惑下,</del> 我决定尝试一下 Fcitx5 自带的拼音输入法。</p>
<p>首次使用的体验是相当的棒的，Fcitx5 在默认配置下表现良好，云拼音也有百度，Google，Google CN 三种可选<del>尽管我不怎么用云拼音</del>，整句输入也是相当的棒，还有输入预测功能。</p>
<p>但这并不是让我抛弃我在 Rime 积攒下的词库投靠<del>老K输入法</del>Fcitx5自带拼音的理由……真正的原因是最近发生的几件事……</p>
<ul>
<li>
<p>首先是非常好的反馈体验，开发者老K对待用户非常友好，而且生产力十足</p>
</li>
<li>
<p>然后是 Felix 爬了维基百科制作了<a href="https://github.com/felixonmars/fcitx5-pinyin-zhwiki">肥猫百万大词库</a>，随后大佬 outloudvi 制作了<a href="https://github.com/outloudvi/fcitx5-pinyin-moegirl">萌娘百科词库</a>，Fcitx5 的日用词库基本满足（AUR 上皆有打包，且在 Arch CN 源有打包</p>
</li>
<li>
<p>肥猫大词库中的<a href="https://github.com/felixonmars/fcitx5-pinyin-zhwiki/issues/6">一个讨论</a>促使Fcitx5引入了一项新功能——根据前缀生成候选项，效果如图：</p>
<p><img loading="lazy" src="/Distributions/fcitx5-prefix-input.webp" alt=""  />
 这个功能我觉得对于长词输入是很棒的</p>
</li>
<li>
<p>添加了类似搜狗U模式的拆字模式，效果如图：</p>
<p><img loading="lazy" src="/Distributions/fcitx5-chaizi.webp" alt=""  />
</p>
</li>
<li>
<p>还有一件事是 Fcitx5 可以使用 <code>fcitx</code>, <code>fcitx5</code>, <code>ibus</code> 的输入法模块（感觉黑科技</p>
</li>
<li>
<p>我从 rime 移植过来一份<a href="https://github.com/CoelacanthusHex/dotfiles/blob/master/fcitx5/.local/share/fcitx5/pinyin/symbolic.dict.txt">符号表</a>，这样输入就方便了很多</p>
</li>
</ul>
<p><strong>优势</strong></p>
<ul>
<li>上述几条个人认为皆为优势</li>
<li><code>fcitx5-rime</code> 支持加载动态库形式的 Rime 插件，在设置中填写插件名称即可使用，注意 octagram 插件名称与文件名并不一样（<code>fcitx-rime</code> 无此支持，<code>ibus-rime</code> 有此支持但是似乎配置文件有点问题（喜讯：Arch 官方仓库中的 <code>librime</code> 已经打包了 lua 和 octagram（即语料库）插件</li>
<li>自带一套 LaTeX 简易输入表（虽然只能输入一小部分特殊字符</li>
<li>笔画过滤: 参见 <a href="https://wiki.archlinux.org/index.php?title=Fcitx5_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E4%BD%BF%E7%94%A8%E7%AC%94%E7%94%BB%E8%BF%87%E6%BB%A4">Fcitx5_使用笔画过滤</a></li>
<li>以词定字</li>
<li>查看选中文字的 Unicode 编码：选中文字，然后使用快捷键 ctrl + alt + shift + u 可以查看选中文字的编码</li>
<li>更好的支持（Fcitx4 已经停止支持</li>
</ul>
<p><strong>关于设置</strong></p>
<p>推荐以下设置：</p>
<ul>
<li>预测看个人喜好</li>
<li>启用颜文字</li>
<li>云拼音根据需要来，但是不推荐 Google 后端，原因显然</li>
<li>preedit 也就是单行显示自己选择</li>
<li>安装肥猫百万大词库（墙裂推荐</li>
<li>Lua 插件！！！自带日期和时间，另外<a href="https://github.com/glaumar/fcitx5-lua-scripts">推荐几个</a>，内含进制转换、简易计算器和密码生成器</li>
</ul>
<p><strong>主题美化</strong></p>
<p>有以下几种选择：</p>
<ul>
<li>
<p><code>kimpanel</code>(KDE)/<code>gnome-shell-extension-kimpanel</code>(Gnome) （同时这也应该是目前 Wayland 下唯一的方案）</p>
</li>
<li>
<p><a href="https://github.com/hosxy/Fcitx5-Material-Color">Material Color 主题</a>，有多种颜色以及单行双行两种模式，Arch 官方源有打包</p>
<p><img loading="lazy" src="/Distributions/Fcitx5-Material-Color-No-Preedit.webp" alt=""  />
</p>
</li>
<li>
<p><a href="https://github.com/hosxy/fcitx5-dark-transparent">黑色透明主题</a></p>
<p><img loading="lazy" src="/Distributions/fcitx5-skin-dark-transparent.webp" alt=""  />
</p>
</li>
<li>
<p><a href="https://github.com/evansan/fcitx5-dark">黑色主题</a></p>
<p><img loading="lazy" src="/Distributions/fcitx5-skin-dark.webp" alt=""  />
</p>
</li>
<li>
<p><a href="https://github.com/hosxy/Fcitx5-Materia-EXP">Materia EXP 主题</a>，系统使用暗色主题的用户请谨慎使用</p>
<p><img loading="lazy" src="/Distributions/Fcitx5-Materia-EXP.webp" alt=""  />
</p>
</li>
<li>
<p><a href="https://github.com/weearc/fcitx5-skin-simple-blue">Simple Blue 主题</a></p>
<p><img loading="lazy" src="/Distributions/fcitx5-skin-simple-blue.webp" alt=""  />
</p>
</li>
<li>
<p><a href="https://github.com/escape0707/fcitx5-adwaita-dark">Adwaita-dark</a>，推荐 Gnome 用户使用</p>
<p><img loading="lazy" src="/Distributions/fcitx5-skin-adwaita-dark.webp" alt=""  />
</p>
</li>
<li>
<p>经典的<a href="https://github.com/hrko99/fcitx-skin-material">Material 主题</a>，这个主题同时支持4和5 <del>我都没注意这个主题更新了 fcitx5 支持</del>（fcitx5 版本有人<a href="https://aur.archlinux.org/packages/fcitx5-skin-material/">在 AUR 上打了包</a>，包名：<code>fcitx5-skin-material</code></p>
</li>
<li>
<p><a href="https://github.com/btstream/fcitx5-skin-base16-material-darker">base16 material darker 主题</a></p>
</li>
<li>
<p>自制主题 <del>（顺便写份主题文档吧</del></p>
</li>
</ul>
<p>以上主题在 AUR 皆有打包(似乎目前已有主题在 AUR 上都有打包了</p>
<h5 id="fcitx5皮肤制作httpsbbsdeepinorgphonezhpost223810"><a href="https://bbs.deepin.org/phone/zh/post/223810">fcitx5皮肤制作</a><a hidden class="anchor" aria-hidden="true" href="#fcitx5皮肤制作httpsbbsdeepinorgphonezhpost223810">#</a></h5>
<p>这次是 fcitx5 是用搜狗皮肤（无法实现动态）！</p>
<p><strong>下载仓库</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ git clone https://github.com/fkxxyz/ssfconv.git
$ cd ssfconv
</code></pre></div><p><strong>下载皮肤</strong></p>
<p>先从<a href="https://pinyin.sogou.com/skins/">搜狗输入法的皮肤官网</a>下载自己喜欢的皮肤，得到ssf格式的文件，例如 【雨欣】蒲公英的思念.ssf</p>
<p><strong>转换皮肤</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./ssfconv -t fcitx5 【雨欣】蒲公英的思念.ssf 【雨欣】蒲公英的思念
</code></pre></div><p><strong>复制到用户皮肤目录</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir -p ~/.local/share/fcitx5/themes/
$ cp -r 【雨欣】蒲公英的思念 ~/.local/share/fcitx5/themes/
</code></pre></div><p><strong>使用该皮肤</strong></p>
<p>用下面这条命令可以看到该皮肤的名称：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ grep Name ~/.local/share/fcitx5/themes/【雨欣】蒲公英的思念/theme.conf
</code></pre></div><p>直接修改配置文件 <code>~/.config/fcitx5/conf/classicui.conf</code>，将 Theme 的值改成这个皮肤的名称即可。</p>
<h5 id="fcitx5rime的畅快体验httpszhuanlanzhihucomp287774005"><a href="https://zhuanlan.zhihu.com/p/287774005">fcitx(5)+rime的畅快体验</a><a hidden class="anchor" aria-hidden="true" href="#fcitx5rime的畅快体验httpszhuanlanzhihucomp287774005">#</a></h5>
<ul>
<li>
<p>下载词库转换工具：<a href="https://github.com/studyzy/imewlconverter">imewlconverter</a></p>
</li>
<li>
<p>安装 dotnet-runtime</p>
</li>
<li>
<p>寻找词库文件</p>
<ul>
<li>比如从搜狗词库中寻找：<a href="https://pinyin.sogou.com/dict/">搜狗细胞词库词库下载词典_输入法字典</a></li>
<li>或者从qq词库中寻找：<a href="http://cdict.qq.pinyin.cn/v1/">QQ输入法-词库平台</a></li>
</ul>
</li>
<li>
<p>转换词库文件：以“网络工程词库.scel”为例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ dotnet ImeWlConverterCmd.dll -ct:pinyin -os:linux -i:scel ./网络工程词库.scel -o:rime ./network.txt
</code></pre></div><ul>
<li>-i:scel对应搜狗的词库文件后缀，如果你要转换qq的词库文件把这里改成qcel</li>
<li>-o:rime ./network.txt表示按照rime输入法词库文件格式转换，转换出的文件在当前目录下，且名字为network.txt</li>
</ul>
</li>
<li>
<p>转换完成之后将这个文件拷贝到你的用户资料目录下：</p>
<ul>
<li>fcitx4: ~/.config/fcitx/rime</li>
<li>fcitx5:~/.local/share/fcixt5/rime</li>
</ul>
<p>文件以luna_pinyin.xxx.dict.yaml的格式命名，如luna_pinyin.network.dict.yaml，之后重启fcitx(5)即可</p>
</li>
</ul>
<p><a href="https://www.jianguoyun.com/p/DbMBwGIQ1-KSCRiqiNoD">dict.7z </a>是我的词库文件，拿去解压到你的用户资料目录下即可使用。</p>
<h4 id="环境配置httpswikiarchlinuxorgtitlefcitxset_environment_variables_for_im_modules"><a href="https://wiki.archlinux.org/title/fcitx#Set_environment_variables_for_IM_modules">环境配置</a><a hidden class="anchor" aria-hidden="true" href="#环境配置httpswikiarchlinuxorgtitlefcitxset_environment_variables_for_im_modules">#</a></h4>
<p>无论选择哪个版本、哪个仓库，安装完成后，均执行此配置，这里另开一个终端，以普通用户编辑 <code>~/.pam_environment</code> 文件（这里为普通用户的家目录下，不存在则创建一个），然后添加以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">GTK_IM_MODULE DEFAULT<span style="color:#f92672">=</span>fcitx
QT_IM_MODULE  DEFAULT<span style="color:#f92672">=</span>fcitx
XMODIFIERS    DEFAULT<span style="color:#f92672">=</span><span style="color:#ae81ff">\@</span>im<span style="color:#f92672">=</span>fcitx
SDL_IM_MODULE DEFAULT<span style="color:#f92672">=</span>fcitx
</code></pre></div><p>之后，登出 KDE Plasma，后重新登陆，此时只需做最后的配置，以安装的为 <code>fcitx:5</code> 为例，</p>
<ol>
<li>右击托盘区输入法图标，选择 <code>Configure</code></li>
<li>点击右下角 <code>Add Input Method</code></li>
<li>search 框下输入 <code>Pinyin</code></li>
<li>选中 Pinyin 后点击右下角的 <code>Add</code></li>
<li><code>Apply</code> 后退出界面</li>
<li>右击托盘区输入法图标，选择 <code>Restart</code></li>
</ol>
<h4 id="rimehttpszhuanlanzhihucomp114296129"><a href="https://zhuanlan.zhihu.com/p/114296129">Rime</a><a hidden class="anchor" aria-hidden="true" href="#rimehttpszhuanlanzhihucomp114296129">#</a></h4>
<p>安装 rime 输入法引擎</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># fcitx4</span>
$ sudo emerge app-i18n/fcitx-rime
<span style="color:#75715e"># fcitx5</span>
$ sudo emerge app-i18n/fcitx5-rime
</code></pre></div><p>下载 <a href="https://github.com/fkxxyz/rime-cloverpinyin/wiki/linux">rime-cloverpinyin</a> 最新版本（如clover.schema-build-1.1.4.zip）输入方案（配置方案），解压到用户资料夹：</p>
<ul>
<li>fcitx：~/.config/fcitx/rime</li>
<li>fcitx5：~/.local/share/fcitx5/rime</li>
</ul>
<p>在用户资料夹下创建 default.custom.yaml ，内容为</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">patch:
  <span style="color:#e6db74">&#34;menu/page_size&#34;</span>: <span style="color:#ae81ff">8</span>
  schema_list:
    - schema: clover
</code></pre></div><p>其中 8 表示打字的时候输入面板的每一页的候选词数目，可以设置成 1~9 任意数字。</p>
<p>写好该文件之后，点击右下角托盘图标右键菜单，点“重新部署”，然后再点右键，在方案列表里面应该就有“ 🍀️四叶草拼音输入法”的选项了。</p>
<p>更多访问 <a href="https://rime.im/">Rime 官网</a>。</p>
<h3 id="kde-system-settings">KDE System Settings<a hidden class="anchor" aria-hidden="true" href="#kde-system-settings">#</a></h3>
<p>Appearance</p>
<ul>
<li>Global Theme: Breeze</li>
</ul>
<p>Workspace Behavior</p>
<ul>
<li>General Behavior
<ul>
<li>Clicking files or folders: Selects them</li>
</ul>
</li>
<li>Screen Locking
<ul>
<li>Lock screen automatically: 10 minutes</li>
</ul>
</li>
</ul>
<p>Startup and Shutdown</p>
<ul>
<li>Login Screen
<ul>
<li>Breeze</li>
</ul>
</li>
</ul>
<p>Regional Settings</p>
<ul>
<li>Date &amp; Time
<ul>
<li>Set date and time automatically</li>
</ul>
</li>
</ul>
<p>Connections</p>
<ul>
<li>IPv4
<ul>
<li>Method: Automatic (Only addresses)</li>
<li>DNS Servers: 114.114.114.114</li>
</ul>
</li>
</ul>
<p>Settings</p>
<ul>
<li>Proxy
<ul>
<li>Use manually specified proxy configuration</li>
</ul>
</li>
</ul>
<p>Display Configuration</p>
<ul>
<li>
<p>Night Color</p>
<ul>
<li>
<p>Activate Night Color</p>
</li>
<li>
<p>Sunset to sunrise at manual location</p>
<p>Beijin: 39.90403 116.40753</p>
</li>
</ul>
</li>
</ul>
<h3 id="bluetoothhttpswikigentooorgwikibluetooth"><a href="https://wiki.gentoo.org/wiki/Bluetooth">Bluetooth</a><a hidden class="anchor" aria-hidden="true" href="#bluetoothhttpswikigentooorgwikibluetooth">#</a></h3>
<p>蓝牙默认是无法使用的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># systemctl enable bluetooth</span>
</code></pre></div><h3 id="首选编辑器">首选编辑器<a hidden class="anchor" aria-hidden="true" href="#首选编辑器">#</a></h3>
<p>Gentoo Linux 默认安装的编辑器为 <code>nano</code> ，这是一个初始设置下就很适合新手的编辑器，如果你有其它的要求，比如想使用 <code>vim</code> 或者 <code>emacs</code> ，可以先安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -vj app-editors/vim</span>
<span style="color:#75715e"># emerge -vj app-editors/emacs</span>
</code></pre></div><p>列出当前存在的编辑器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect editor list</span>
</code></pre></div><p>根据所需要的编辑器对应的序号，设置默认</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect editor set 「序号」</span>
<span style="color:#75715e"># . /etc/profile</span>
</code></pre></div><h3 id="mutt">mutt<a hidden class="anchor" aria-hidden="true" href="#mutt">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge net-mail/fetchmail mail-filter/procmail mail-client/mutt mail-mta/msmtp</span>
</code></pre></div><h3 id="mpv">mpv<a hidden class="anchor" aria-hidden="true" href="#mpv">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge media-video/mpv</span>
</code></pre></div><h3 id="spotify">spotify<a hidden class="anchor" aria-hidden="true" href="#spotify">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge media-sound/spotify</span>
</code></pre></div><h3 id="youtube-dl">youtube-dl<a hidden class="anchor" aria-hidden="true" href="#youtube-dl">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge dev-python/pip</span>
...
</code></pre></div><h3 id="aria2">aria2<a hidden class="anchor" aria-hidden="true" href="#aria2">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;net-misc/aria2 bittorrent&#39; &gt; /etc/portage/package.use/aria2</span>
<span style="color:#75715e"># emerge net-misc/aria2</span>
</code></pre></div><h3 id="typora">Typora<a hidden class="anchor" aria-hidden="true" href="#typora">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;=app-editors/typora-0.11.18::gentoo-zh=&#39; &gt; /etc/portage/package.unmask/typora</span>
<span style="color:#75715e"># echo &#39;=app-editors/typora-0.11.18::gentoo-zh ~amd64&#39; &gt; /etc/portage/package.accept_keywords/typora</span>
<span style="color:#75715e"># cp -av /opt/typora/share/icons/hicolor/* /usr/share/icons/hicolor/</span>
</code></pre></div><h3 id="zsh">zsh<a hidden class="anchor" aria-hidden="true" href="#zsh">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-shells/zsh</span>
$ chsh
Password: 
Changing the login shell <span style="color:#66d9ef">for</span> kurome
Enter the new value, or press ENTER <span style="color:#66d9ef">for</span> the default
        Login Shell <span style="color:#f92672">[</span>/bin/bash<span style="color:#f92672">]</span>: /bin/zsh
</code></pre></div><h3 id="clash">Clash<a hidden class="anchor" aria-hidden="true" href="#clash">#</a></h3>
<p>clash 需要 root 执行，编写一个 service 就可以了。</p>
<p>cfw 无法设置 port，总是重置为 0。</p>
<h3 id="browsers">Browsers<a hidden class="anchor" aria-hidden="true" href="#browsers">#</a></h3>
<p>关于浏览器的选择有很多，比如</p>
<ul>
<li>www-client/google-chrome （chrome 的官方二进制包）</li>
<li>www-client/google-chrome-beta （chrome 的官方二进制包， beta 分支）</li>
<li>www-client/chromium （chromium 源码包，需编译，时间很久很久）</li>
<li>www-client/firefox-bin （火狐官方二进制包，国际版）</li>
<li>www-client/firefox （火狐源码包，需编译，时间很久）</li>
<li>www-client/microsoft-edge-beta （Edge 官方二进制包， beta 分支）</li>
<li>等</li>
</ul>
<p>可以自行选择安装。命令依旧是 <code>emerge &lt;包名&gt;</code> 。安装个别浏览器时，可能会因为许可问题导致无法安装，如何解决看下文的 <a href="#Licenses">软件的许可</a> 一节。</p>
<p>其它的应用自行发掘。这里有推荐应用列表：</p>
<ul>
<li><a href="https://wiki.gentoo.org/wiki/Recommended_applications">https://wiki.gentoo.org/wiki/Recommended_applications</a></li>
<li><a href="https://wiki.archlinux.org/title/List_of_applications">https://wiki.archlinux.org/title/List_of_applications</a></li>
</ul>
<p>至此，桌面配置告一段落。</p>
<h3 id="kio-extrashttpswikigentooorgwikimtp"><a href="https://wiki.gentoo.org/wiki/MTP">kio-extras</a><a hidden class="anchor" aria-hidden="true" href="#kio-extrashttpswikigentooorgwikimtp">#</a></h3>
<p>(only for kde)</p>
<p><strong>MTP</strong> (<strong>M</strong>edia <strong>T</strong>ransfer <strong>P</strong>rotocol) is a protocol to allow the transfer of files to external devices. It is provided by several programs, most of them depending on <a href="https://wiki.gentoo.org/wiki/FUSE">FUSE</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;kde-apps/kio-extras mtp&#39; &gt; /etc/portage/package.use/kio-extras</span>
<span style="color:#75715e"># emerge --ask kde-apps/kio-extras</span>
</code></pre></div><h3 id="gwenview">Gwenview<a hidden class="anchor" aria-hidden="true" href="#gwenview">#</a></h3>
<p>KDE app，看图。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge kde-apps/gwenview</span>
</code></pre></div><h3 id="okular">Okular<a hidden class="anchor" aria-hidden="true" href="#okular">#</a></h3>
<p>KDE app，PDF 阅读。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge kde-apps/okular</span>
</code></pre></div><h3 id="ktimer">KTimer<a hidden class="anchor" aria-hidden="true" href="#ktimer">#</a></h3>
<p>KDE app，类似于 cronie，只不过是GUI。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge kde-apps/ktimer</span>
</code></pre></div><h3 id="kclock">KClock<a hidden class="anchor" aria-hidden="true" href="#kclock">#</a></h3>
<p>KDE app，一个时钟。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect repository enable guru</span>
<span style="color:#75715e"># emerge --sync guru</span>
<span style="color:#75715e"># echo &#39;*/*::guru&#39; &gt; /etc/portage/package.mask/guru</span>
<span style="color:#75715e"># echo &#39;=kde-apps/kclock-21.12::guru&#39; &gt; /etc/portage/package.unmask/kclock</span>
<span style="color:#75715e"># echo &#39;=kde-apps/kclock-21.12::guru ~amd64&#39; &gt; /etc/portage/package.accept_keywords/kclock</span>
<span style="color:#75715e"># echo &#39;=kde-frameworks/kirigami-addons-0.2::guru&#39; &gt;&gt; /etc/portage/package.unmask/kclock</span>
<span style="color:#75715e"># echo &#39;=kde-frameworks/kirigami-addons-0.2::guru ~amd64&#39; &gt;&gt; /etc/portage/package.accept_keywords/kcloc</span>
<span style="color:#75715e"># emerge kde-apps/kclock</span>
</code></pre></div><h3 id="rsibreakhttpsuserbasekdeorgrsibreakzh-cn"><a href="https://userbase.kde.org/RSIBreak/zh-cn">RSIBreak</a><a hidden class="anchor" aria-hidden="true" href="#rsibreakhttpsuserbasekdeorgrsibreakzh-cn">#</a></h3>
<p>番茄钟</p>
<h3 id="libreoffice">LibreOffice<a hidden class="anchor" aria-hidden="true" href="#libreoffice">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-office/libreoffice-bin</span>
</code></pre></div><h3 id="flameshot">Flameshot<a hidden class="anchor" aria-hidden="true" href="#flameshot">#</a></h3>
<p>很棒的截图软件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge media-gfx/flameshot
</code></pre></div><h4 id="spectacle">Spectacle<a hidden class="anchor" aria-hidden="true" href="#spectacle">#</a></h4>
<p>KDE app，用的不是很习惯。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge kde-apps/spectacle</span>
</code></pre></div><h3 id="keepassxchttpskeepassxcorg"><a href="https://keepassxc.org/">KeePassXC</a><a hidden class="anchor" aria-hidden="true" href="#keepassxchttpskeepassxcorg">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-admin/keepassxc</span>
</code></pre></div><h3 id="ppsspp">PPSSPP<a hidden class="anchor" aria-hidden="true" href="#ppsspp">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#34;games-emulation/ppsspp ~amd64&#34; &gt;&gt; /etc/portage/package.accept_keywords/ppsspp</span>
<span style="color:#75715e"># emerge games-emulation/ppsspp</span>
</code></pre></div><h3 id="papirus-icon-themehttpsgithubcompapirusdevelopmentteampapirus-icon-theme"><a href="https://github.com/PapirusDevelopmentTeam/papirus-icon-theme">papirus-icon-theme</a><a hidden class="anchor" aria-hidden="true" href="#papirus-icon-themehttpsgithubcompapirusdevelopmentteampapirus-icon-theme">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge -a papirus-icon-theme
</code></pre></div><h3 id="vulkanhttpswikigentooorgwikivulkan"><a href="https://wiki.gentoo.org/wiki/Vulkan">Vulkan</a><a hidden class="anchor" aria-hidden="true" href="#vulkanhttpswikigentooorgwikivulkan">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask media-libs/vulkan-loader</span>
</code></pre></div><h3 id="tree">tree<a hidden class="anchor" aria-hidden="true" href="#tree">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-text/tree</span>
</code></pre></div><h3 id="qemu">qemu<a hidden class="anchor" aria-hidden="true" href="#qemu">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;QEMU_SOFTMMU_TARGETS=&#34;x86_64&#34;&#39; &gt;&gt; /etc/portage/make.conf</span>
<span style="color:#75715e"># echo &#39;QEMU_USER_TARGETS=&#34;x86_64&#34;&#39; &gt;&gt; /etc/portage/make.conf</span>
<span style="color:#75715e"># emerge app-emulation/qemu net-fs/samba</span>
<span style="color:#75715e"># gpasswd -a kurome kvm</span>
</code></pre></div><p><a href="https://www.dedoimedo.com/computers/kvm-permission-denied.html">Could not access KVM kernel module: Permission denied</a></p>
<h3 id="dockerhttpswikigentooorgwikidocker"><a href="https://wiki.gentoo.org/wiki/Docker">Docker</a><a hidden class="anchor" aria-hidden="true" href="#dockerhttpswikigentooorgwikidocker">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask --verbose app-emulation/docker</span>
<span style="color:#75715e"># systemctl enable docker.service</span>
<span style="color:#75715e"># systemctl start docker.service</span>
<span style="color:#75715e"># usermod -aG docker &lt;username&gt;</span>
<span style="color:#75715e"># docker run --rm hello-world</span>
</code></pre></div><h3 id="lsusbhttpswikigentooorgwikiusbutils"><a href="https://wiki.gentoo.org/wiki/Usbutils">lsusb</a><a hidden class="anchor" aria-hidden="true" href="#lsusbhttpswikigentooorgwikiusbutils">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-apps/usbutils</span>
</code></pre></div><h3 id="p7ziphttpswikigentooorgwikip7zip"><a href="https://wiki.gentoo.org/wiki/P7zip">p7zip</a><a hidden class="anchor" aria-hidden="true" href="#p7ziphttpswikigentooorgwikip7zip">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-arch/p7zip</span>
</code></pre></div><p><strong>Important</strong>: The 7-zip archive format does <strong>not</strong> store standard Unix file permissions such as owner/group or extended file attributes. Those who desire to use 7-zip as a long-term backup or archiving solution should wrap files in a tar archive before compressing with <strong>7z</strong>. Use the following command to archive directories of files, preserving Unix file permissions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ tar cf - &lt;directory&gt; | 7za a -si &lt;directory&gt;.tar.7z
</code></pre></div><p>To extract:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ 7za x -so &lt;directory&gt;.tar.7z | tar xf -
</code></pre></div><h4 id="ziphttpswwwtecmintcomunzip-extract-zip-files-to-specific-directory-in-linux"><a href="https://www.tecmint.com/unzip-extract-zip-files-to-specific-directory-in-linux/">zip</a><a hidden class="anchor" aria-hidden="true" href="#ziphttpswwwtecmintcomunzip-extract-zip-files-to-specific-directory-in-linux">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-arch/zip</span>
</code></pre></div><h4 id="arkhttpsappskdeorgark"><a href="https://apps.kde.org/ark/">Ark</a><a hidden class="anchor" aria-hidden="true" href="#arkhttpsappskdeorgark">#</a></h4>
<p>File archiver by KDE</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge kde-apps/ark</span>
</code></pre></div><h3 id="adb-and-fastboothttpswikigentooorgwikiandroidadb"><a href="https://wiki.gentoo.org/wiki/Android/adb">ADB and Fastboot</a><a hidden class="anchor" aria-hidden="true" href="#adb-and-fastboothttpswikigentooorgwikiandroidadb">#</a></h3>
<p>Fastboot is included with ADB inside the <a href="https://packages.gentoo.org/packages/dev-util/android-tools">dev-util/android-tools</a> package::</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask dev-util/android-tools</span>
</code></pre></div><p>To run adb without root privileges then the unprivileged user account must be added to the plugdev group:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># groupmod -a plugdev -U kurome</span>
</code></pre></div><p><strong>no permissions (missing udev rules? user is in the plugdev group)</strong></p>
<p>需<a href="https://wiki.archlinux.org/title/Android_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E6%B7%BB%E5%8A%A0_udev_%E8%A7%84%E5%88%99">添加 udev 规则</a>：使用下面的模板，并用你的 [VENDOR ID] 和 [PRODUCT ID] 替换里面的值。 然后把这些规则复制到 <code>/etc/udev/rules.d/51-android.rules</code>：</p>
<pre tabindex="0"><code>SUBSYSTEM==&quot;usb&quot;, ATTR{idVendor}==&quot;[VENDOR ID]&quot;, MODE=&quot;0666&quot;, GROUP=&quot;adbusers&quot;
SUBSYSTEM==&quot;usb&quot;,ATTR{idVendor}==&quot;[VENDOR ID]&quot;,ATTR{idProduct}==&quot;[PRODUCT ID]&quot;,SYMLINK+=&quot;android_adb&quot;
SUBSYSTEM==&quot;usb&quot;,ATTR{idVendor}==&quot;[VENDOR ID]&quot;,ATTR{idProduct}==&quot;[PRODUCT ID]&quot;,SYMLINK+=&quot;android_fastboot&quot;
</code></pre><p>再加载刚定义的规则，运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># udevadm control --reload-rules</span>
</code></pre></div><p>确保你是 adbusers user group 的成员，以访问 adb 设备。</p>
<p><strong>adb: device unauthorized.</strong></p>
<p>请打开手机同意 USB 调试。</p>
<h4 id="file-transfer">File transfer<a hidden class="anchor" aria-hidden="true" href="#file-transfer">#</a></h4>
<p><strong>Push a file</strong></p>
<pre tabindex="0"><code>$ adb push mypicture.png /sdcard/on/device
</code></pre><p><strong>Push a folder</strong></p>
<pre tabindex="0"><code>$ adb push myfolder /sdcard/on/device
</code></pre><p><strong>Push all files in a folder</strong></p>
<pre tabindex="0"><code>$ adb push myfolder/ /sdcard/on/device
</code></pre><p><strong>Pull a file</strong></p>
<pre tabindex="0"><code>$ adb pull /sdcard/on/device/mypicture.png
</code></pre><p><strong>Pull a folder</strong></p>
<pre tabindex="0"><code>$ adb pull /sdcard/on/device /home/̩$(whoami)/android-folder/
</code></pre><h3 id="flatpakhttpsflatpakorgsetupgentoo"><a href="https://flatpak.org/setup/Gentoo">Flatpak</a><a hidden class="anchor" aria-hidden="true" href="#flatpakhttpsflatpakorgsetupgentoo">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cat &gt;&gt; /etc/portage/package.accept_keywords/flatpak</span>
sys-apps/flatpak ~amd64
acct-user/flatpak ~amd64
acct-group/flatpak ~amd64
dev-util/ostree ~amd64
<span style="color:#75715e"># emerge sys-apps/flatpak</span>
<span style="color:#75715e"># flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo</span>
<span style="color:#75715e"># flatpak remote-modify flathub --url=https://mirror.sjtu.edu.cn/flathub</span>
</code></pre></div><h3 id="neofetchhttpszhuanlanzhihucomp69777438"><a href="https://zhuanlan.zhihu.com/p/69777438">neofetch</a><a hidden class="anchor" aria-hidden="true" href="#neofetchhttpszhuanlanzhihucomp69777438">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge app-misc/neofetch
</code></pre></div><h4 id="使用自定义图像">使用自定义图像<a hidden class="anchor" aria-hidden="true" href="#使用自定义图像">#</a></h4>
<p>默认情况下，Neofetch 将显示你的操作系统 logo 以及系统信息。当然，你可以根据需要更改图像。</p>
<p>要显示图像，Linux 系统应该安装以下依赖项：</p>
<ol>
<li>w3m-img（用于显示图像。w3m-img 有时与 w3m 包捆绑在一起），</li>
<li>Imagemagick（用于创建缩略图），</li>
</ol>
<p>大多数 Linux 发行版的默认仓库中都提供了 w3m-img 和 ImageMagick 包。因此，你可以使用你的发行版的默认包管理器来安装它们。</p>
<p>现在，运行以下命令以使用自定义图像显示系统信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ neofetch --w3m /home/sk/Pictures/image.png
</code></pre></div><p>或者，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ neofetch --w3m --source /home/sk/Pictures/image.png
</code></pre></div><p>或者，你可以指向包含以下图像的目录。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ neofetch --w3m &lt;path-to-directory&gt;
</code></pre></div><h4 id="配置-neofetch">配置 Neofetch<a hidden class="anchor" aria-hidden="true" href="#配置-neofetch">#</a></h4>
<p>当我们第一次运行 Neofetch 时，它默认会为每个用户在 <code>$HOME/.config/neofetch/config.conf</code> 中创建一个配置文件。你可以调整此文件来告诉 neofetch 该显示、删除和/或修改哪些详细信息。</p>
<p>还可以在不同版本中保留此配置文件。这意味着你只需根据自己的喜好自定义一次，并在升级到更新版本后使用相同的设置。你甚至可以将此文件共享给你的朋友和同事，使他拥有与你相同的设置。</p>
<h3 id="cpuid2cpuflags">cpuid2cpuflags<a hidden class="anchor" aria-hidden="true" href="#cpuid2cpuflags">#</a></h3>
<p>检测cpu指令集</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge app-portage/cpuid2cpuflags
$ sudo cpuid2cpuflags 
</code></pre></div><p>安装完成之后使用该指令并将输出值作为CPU_FLAGS_X86的值输入到make.conf中</p>
<h3 id="flaggie">flaggie<a hidden class="anchor" aria-hidden="true" href="#flaggie">#</a></h3>
<p>安装flaggie来更加方便的管理单个包的USE变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge app-portage/flaggie
</code></pre></div><p>用法：比如添加a包的b特性</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># flaggie a +b</span>
</code></pre></div><p>去掉c包的d特性</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># flaggie c -d</span>
</code></pre></div><h3 id="dwmhttpszhuanlanzhihucomp346719806"><a href="https://zhuanlan.zhihu.com/p/346719806">dwm</a><a hidden class="anchor" aria-hidden="true" href="#dwmhttpszhuanlanzhihucomp346719806">#</a></h3>
<p>长时间日常使用动态窗口管理器之后发现，相比与传统的DE型桌面，这种WM型窗口管理方式确实能很大程度上提高工作效率。</p>
<h4 id="de和wm的区别">DE和WM的区别<a hidden class="anchor" aria-hidden="true" href="#de和wm的区别">#</a></h4>
<p>首先说明一下我即将提到的东西是什么。</p>
<ul>
<li>DE：Desktop Environment</li>
<li>WM：Window Manager</li>
</ul>
<p>桌面环境是一个相对完整的概念，一般情况下DE包含WM，比如Gnome3的默认WM是Mutter，KDE5的默认WM是KWin。主流的桌面环境都提供了大量自带的桌面组件来构成其完整的桌面体验。</p>
<p>窗口管理器只是管理出现在你的桌面上的各种窗口的组件，具体的管理内容包含比如：窗口堆叠方式，窗口移动规则等。大多数人接触到的是堆叠式窗口管理器，一个窗口可以叠放在其他窗口之上，调整窗口的主要方式是鼠标。我即将介绍的dwm（Dynamic Window Manager）属于动态窗口管理器，可以自定义不同窗口的出现规则如平铺或者堆叠，主要的调整窗口的方式是键盘。</p>
<p>大多数窗口管理器只提供管理窗口的逻辑和人机交互的处理，并不自带其他组件如程序启动器、终端等软件，因此只运行一个窗口管理器理论上是要比运行一个完整的桌面环境更加节约资源，也有更好的可伸缩性。</p>
<p>实际上WM这个概念是应用了奥卡姆剃刀原理，把那些看似有点用但实际上多余的功能全部剔除，只留下你真正需要的和最常用的功能并加以强化，Less is More.</p>
<h4 id="dwm与其他wm的区别">dwm与其他wm的区别<a hidden class="anchor" aria-hidden="true" href="#dwm与其他wm的区别">#</a></h4>
<p>前面已经说明了dwm与堆叠式窗口管理器的区别，下面说明一下dwm与其他平铺&amp;动态窗口管理器的区别。</p>
<p>dwm使用C语言编写，使用修改源代码的方式来进行配置。说到源代码可能有些同学就有点害怕，其实修改源代码也很简单，因为有现成的例子可以复(bai)用(piao)嘛！通过直接修改源代码理论上可以确保你的dwm能满足你所有的需求，同时也没有多余的，你不需要的功能。</p>
<p>相比之下，另外一个相当流行的动态窗口管理器i3wm也是使用C语言编写，但是通过修改其配置文件来配置，这相当于i3wm向你暴露可以被配置的接口来满足你的需求，但是这样的配置方式缺点在于你不能向其添加你需要的需求，只能向上游提交issue来完成enhancement。</p>
<p>具有和dwm相似配置能力的窗口管理器是xmonad，它也是通过直接修改源代码的方式来调整配置，但是因为使用haskell编写的所以需要安装相当多的依赖，此外其运行效率也不及dwm。</p>
<h4 id="通用的wm配置">通用的wm配置<a hidden class="anchor" aria-hidden="true" href="#通用的wm配置">#</a></h4>
<p>因为一个可独立运行的窗口管理器默认不携带任何多余的软件，所以为了满足日常使用需要进行一定程度的自定义配置，下面给出一下通用的配置：</p>
<p><strong>常用软件的推荐</strong></p>
<p>用半角逗号分隔的同类别软件顺序表示推荐等级</p>
<ul>
<li>终端：<a href="https://sw.kovidgoyal.net/kitty/">kitty</a>, alacritty, termite（前两个有GPU加速）</li>
<li>护眼：redshift-gtk</li>
<li>程序启动器：dmenu, rofi</li>
<li>Shell：fish, zsh</li>
<li>壁纸设置器：feh, nitrogen</li>
<li>音乐播放器：<a href="https://zhuanlan.zhihu.com/p/351064855">mpd&amp;ncmpcpp</a>（基于终端）, deadbeaf-git</li>
<li>特效合成器：picom-jonaburg-git, picom</li>
<li>文件管理器：thunar, nemo</li>
<li>电源管理器：xfce4-power-manager</li>
<li>截图工具：flameshot, scrot</li>
<li>主题设置器：lxappearance&amp;qt5ct&amp;xsettingsd</li>
<li>输入法：fcitx5</li>
<li>科学上网工具：qv2ray</li>
<li>剪切板管理器：copyq</li>
<li>云同步工具：nutstore（坚果云）, dropbox</li>
<li>通知管理器：dunst</li>
<li>锁屏管理器：betterlockscreen, xautolock（用于自动锁屏）</li>
<li>pdf 阅读器：zathura（vim风格）, atril（没有gnome依赖的evince）</li>
<li>文本编辑器：nvim, doom emacs(可选)，(vs)code</li>
<li>屏幕亮度调节器：light</li>
</ul>
<p><strong>关于平铺还是浮动</strong></p>
<p>个人建议多数窗口平铺，以下窗口默认浮动：</p>
<p>virtualbox, lxappearance, qq, gpick, qalculator, slickpicker</p>
<p><strong>关于GTK主题和QT主题</strong></p>
<p>我建议让QT程序使用GTK主题，除上文提到的qt5ct再安装qt5-styleplugins</p>
<p>在qt5ct中设置风格为gtk2</p>
<h4 id="dwm安装">dwm安装<a hidden class="anchor" aria-hidden="true" href="#dwm安装">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ wget https://dl.suckless.org/dwm/dwm-6.2.tar.gz
$ tar xpvf dwm-6.2.tar.gz
$ mv dwm-6.2 ~/.dwm
</code></pre></div><h4 id="dwm配置httpszhuanlanzhihucomp183861786"><a href="https://zhuanlan.zhihu.com/p/183861786">dwm配置</a><a hidden class="anchor" aria-hidden="true" href="#dwm配置httpszhuanlanzhihucomp183861786">#</a></h4>
<p>配置dwm主要需要修改的文件是config.def.h，主要的配置方式是使用被人写好的patch加必要时候的手动修改。dwm的patch都在其<a href="https://dwm.suckless.org/patches/">官方网站</a></p>
<p>具体过程是这样的：</p>
<ol>
<li>找到你需要的patch并下载</li>
<li>将其移动到~/.dwm目录下</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ patch &lt; dwm*.diff
</code></pre></div><p>之后会输出这个patch过程的详细情况，一般情况不会出现问题</p>
<p>需要注意的是要一个一个来</p>
<p>出现问题之后需要对照如：config.def.h.rej, dwm.c.rej等后缀为rej的文件来手动修改对应的没有rej后缀的源文件</p>
<p>打开之后rej文件中行首标有+的行是需要添加的行，标有-的行是需要删除的行</p>
<p>所有更改都修改完毕之后重新编译安装，执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ rm -f ./config.h <span style="color:#f92672">&amp;&amp;</span> sudo make clean install
</code></pre></div><p>不要忘记添加dwm.desktop文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo vim /usr/share/xsessions/dwm.desktop

<span style="color:#f92672">[</span>Desktop Entry<span style="color:#f92672">]</span>
Encoding<span style="color:#f92672">=</span>UTF-8
Name<span style="color:#f92672">=</span>Dwm
Comment<span style="color:#f92672">=</span>Dynamic window manager
Exec<span style="color:#f92672">=</span>dwm
Icon<span style="color:#f92672">=</span>dwm
Type<span style="color:#f92672">=</span>XSession
</code></pre></div><p>下面是我自己打完patch之后的配置：</p>
<p><a href="https://github.com/ayamir/dwm-dotfiles">https://github.com/ayamir/dwm-dotfilesgithub.com/ayamir/dwm-dotfiles</a></p>
<p>新手可以直接使用我的配置，相对比较完整，使用说明我已经写好了，基本上实现了i3wm上提供的功能。</p>
<h3 id="crossover">Crossover<a hidden class="anchor" aria-hidden="true" href="#crossover">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano /etc/portage/package.accept_keywords/crossover</span>
app-emulation/crossover-bin ~amd64
<span style="color:#75715e"># nano /etc/portage/package.use/crossover</span>
sys-libs/ncurses -gpm
<span style="color:#75715e"># USE=&#34;abi_x86_32 abi_x86_64&#34; emerge app-emulation/crossover-bin</span>
</code></pre></div><p>作为环境变量的USE设定特点是，本次安装的所有软件都启用该 USE，区别在 make.conf 中使整个系统都启用该 USE 和在 package.use 中为一个一个的包设置同一个 USE（这种情况每次运行只会提示一个包，特别麻烦）。</p>
<p><a href="https://unix.stackexchange.com/a/90024"><strong>Using ABI_X86 in Gentoo</strong></a></p>
<p><code>ABI_X86</code> is a <a href="http://devmanual.gentoo.org/general-concepts/use-flags/#use_expand-and-arch-use-flags"><code>USE_EXPAND</code></a> variable; setting <code>ABI_X86=&quot;32 64&quot;</code> or <code>USE=&quot;abi_x86_32 abi_x86_64&quot;</code> are equivalent.</p>
<h3 id="recommended-applicationshttpswikigentooorgwikirecommended_applications-gentoo"><a href="https://wiki.gentoo.org/wiki/Recommended_applications">Recommended applications</a>: Gentoo<a hidden class="anchor" aria-hidden="true" href="#recommended-applicationshttpswikigentooorgwikirecommended_applications-gentoo">#</a></h3>
<h3 id="list-of-applicationshttpswikiarchlinuxorgtitlelist_of_applications-arch"><a href="https://wiki.archlinux.org/title/List_of_applications">List of applications</a>: Arch<a hidden class="anchor" aria-hidden="true" href="#list-of-applicationshttpswikiarchlinuxorgtitlelist_of_applications-arch">#</a></h3>
<h2 id="tips">Tips<a hidden class="anchor" aria-hidden="true" href="#tips">#</a></h2>
<h3 id="petrusz">Petrus.Z<a hidden class="anchor" aria-hidden="true" href="#petrusz">#</a></h3>
<h4 id="portagehttpswwwcodeplayerorgwikigentooportagehtml"><a href="https://www.codeplayer.org/Wiki/Gentoo/Portage.html">Portage</a><a hidden class="anchor" aria-hidden="true" href="#portagehttpswwwcodeplayerorgwikigentooportagehtml">#</a></h4>
<h5 id="command">command<a hidden class="anchor" aria-hidden="true" href="#command">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>euse -E use-flags	<span style="color:#75715e">#设置允许use flag（修改/etc/make.conf中的USE）</span>
euse -D use-flags	<span style="color:#75715e">#设置禁止use flag（修改/etc/make.conf中的USE）</span>
euse -i use-flag	<span style="color:#75715e">#查询use flag描述</span>

eix RegExp	<span style="color:#75715e">#搜索软件包</span>
eix -I	<span style="color:#75715e">#列出系统中已安装的软件包</span>
eix --installed-with-use <span style="color:#e6db74">`</span>use<span style="color:#e6db74">`</span>	<span style="color:#75715e">#显示哪些已安装的包有`use` flag</span>

equery files <span style="color:#e6db74">`</span>PackageName<span style="color:#e6db74">`</span>	<span style="color:#75715e">#列出已安装包的文件</span>
equery belongs <span style="color:#e6db74">`</span>FileName<span style="color:#e6db74">`</span>	<span style="color:#75715e">#查询已安装的指定文件属于哪个包</span>
equery hasuse <span style="color:#e6db74">`</span>use<span style="color:#e6db74">`</span>	<span style="color:#75715e">#查询哪些已安装的包有use flag</span>
equery uses <span style="color:#e6db74">`</span>PackageName<span style="color:#e6db74">`</span>	<span style="color:#75715e">#显示packege有哪些use</span>

ebuild xxx.ebuild digest	<span style="color:#75715e">#生成摘要文件</span>
ebuild /var/db/pkg/xxx/xxx.ebuild config	<span style="color:#75715e">#初始化配置</span>

equery d package	<span style="color:#75715e">#查看依赖package的软件</span>
equery g package	<span style="color:#75715e">#查看package的依赖</span>

qdepends package	<span style="color:#75715e"># 查询package的依赖</span>
qdepends -rv package	<span style="color:#75715e">#输出类似ebuild中或与shell兼容并格式化的依赖</span>
qdepends -Q package	<span style="color:#75715e"># 查询哪些包依赖package</span>
qlist package	<span style="color:#75715e"># 查看package的所有文件列表</span>
qfile file	<span style="color:#75715e"># 查看file被哪个package拥有</span>
qcheck package	<span style="color:#75715e"># 检查package完整性</span>
qgrep -l package	<span style="color:#75715e"># 查找提及package名称的ebuild</span>
qgrep -JN package	<span style="color:#75715e"># -J限制仅查找已安装的包，-N将打印atom而不是文件名</span>
qlop -um        <span style="color:#75715e"># 查看merge和unmerge log</span>
qlop -rt        <span style="color:#75715e"># 查看那当前emerge还有运行了多长时间</span>
qmanifest
qtegrity

genlop -c         <span style="color:#75715e">#查看当前正在merge的package的编译时间</span>
genlop -t package	<span style="color:#75715e">#查看package的编译时间</span>
genlop -u         <span style="color:#75715e">#查看安装与删除的package历史</span>

e-file

eread
elogv
eclean
epkginfo
</code></pre></div><h5 id="apply-patches">apply patches<a hidden class="anchor" aria-hidden="true" href="#apply-patches">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#1.create dir for patches</span>
mkdir -p /etc/portage/patches/&lt;package_class&gt;/&lt;package_name&gt;-&lt;package_version&gt;
<span style="color:#75715e">#2.put patches at dir which just created above</span>
<span style="color:#75715e">#3.test patches</span>
cd <span style="color:#66d9ef">$(</span>portageq get_repo_path / gentoo<span style="color:#66d9ef">)</span>/&lt;package_class&gt;/&lt;package_name&gt;
ebuild &lt;package_name&gt;-&lt;package_version&gt;.ebuild clean prepare
<span style="color:#75715e">#4.With the message &#34;User patches applied.&#34; all is good and the package needs to be re-emerged as normally.</span>
</code></pre></div><h4 id="kernelhttpswwwcodeplayerorgwikigentookernelhtml"><a href="https://www.codeplayer.org/Wiki/Gentoo/kernel.html">Kernel</a><a hidden class="anchor" aria-hidden="true" href="#kernelhttpswwwcodeplayerorgwikigentookernelhtml">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#1.select the kernel will use</span>
eselect kernel list
eselect kernel set &lt;No.&gt;
<span style="color:#75715e">#2.configure the kernel with old config (and diff with previous config)</span>
zcat /proc/config.gz &gt; /usr/src/linux/.config
diff .config ../linux-x.xx.x-gentoo/.config
make silentoldconfig/syncconfig/oldconfig
<span style="color:#75715e">#3.compile&amp;install kernel/modules</span>
make -j9
make install
<span style="color:#75715e"># compile&amp;install out-of-tree module(s)</span>
make modules_prepare
emerge --ask @module-rebuild
<span style="color:#75715e"># install initramfs</span>
genkernel --install initramfs
<span style="color:#75715e">#4.clean up old kernel files</span>
eclean-kernel
grub-mkconfig -o /boot/grub/grub.cfg
</code></pre></div><h4 id="upgradegentoohttpswwwcodeplayerorgwikigentooupgradegentoohtml"><a href="https://www.codeplayer.org/Wiki/Gentoo/UpgradeGentoo.html">UpgradeGentoo</a><a hidden class="anchor" aria-hidden="true" href="#upgradegentoohttpswwwcodeplayerorgwikigentooupgradegentoohtml">#</a></h4>
<h5 id="how-to-upgrade-gentoo">How to upgrade gentoo<a hidden class="anchor" aria-hidden="true" href="#how-to-upgrade-gentoo">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#1.sync portage tree to lastest</span>
emerge-websync
emerge --sync
<span style="color:#75715e">#2.upgrade the system</span>
emerge -avutDN --with-bdeps<span style="color:#f92672">=</span>y @world <span style="color:#75715e"># -a = --ask, -v = --vebose, -u = --update, -t == --tree, -D = --deep, -N = --newuse</span>
emerge -a @smart-live-rebuild
<span style="color:#75715e">#3.may be need to update the new config file</span>
dispatch-conf <span style="color:#75715e"># or etc-update</span>
<span style="color:#75715e">#4.clean the unused package</span>
emerge -ac <span style="color:#75715e"># -c = --depclean</span>
<span style="color:#75715e">#5.rebuild dependency library</span>
emerge @preserved-rebuild
revdep-rebuild
emerge -a @module-rebuild
<span style="color:#75715e">#6.clean old distfiles</span>
eclean -d distfiles <span style="color:#75715e"># or eclean-dist -d</span>
</code></pre></div><h5 id="how-to-upgrade-python-local-package">How to upgrade python local package<a hidden class="anchor" aria-hidden="true" href="#how-to-upgrade-python-local-package">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 通过脚本维护local-python-world列表</span>

<span style="color:#75715e"># 安装或删除&lt;package&gt;</span>
pip_user install &lt;package&gt;
pip_user uninstall &lt;package&gt;

<span style="color:#75715e"># 将所有local python package升级</span>
pip_upgrade
</code></pre></div><h3 id="使用-gnu-stow-管理你的點文件httpfarseerfcmeusing-gnu-stow-to-manage-your-dotfileshtml"><a href="http://farseerfc.me/using-gnu-stow-to-manage-your-dotfiles.html#">使用 GNU stow 管理你的點文件</a><a hidden class="anchor" aria-hidden="true" href="#使用-gnu-stow-管理你的點文件httpfarseerfcmeusing-gnu-stow-to-manage-your-dotfileshtml">#</a></h3>
<p>我昨天偶然間發現一些我覺得值得分享的經驗，就是那種「爲毛我沒有早點知道這個？」那一類的。 我將在這篇文章中介紹如何使用 GNU Stow 管理你的 GNU/Linux 系統中位於用戶家目錄裏的各種配置文件 （通常又叫「點文件(dotfiles)」比如 .bashrc）。</p>
<p>這件事的困難之處在於，如果能用版本管理系統(VCS, Version Control System)比如 Git, Mercurial(hg), Bazaar(bzr) 管理點文件的話會非常方便，但是這些點文件大部分都位於家目錄的頂級目錄下， 在這個位置不太適合初始化一個版本管理倉庫。這些年下來我試過很多程序，設計目的在於解決這個問題， 幫你把這些配置文件安置在某個下級目錄中，然後安裝或者鏈接這些文件到它們應該在的位置。 嘗試下來這些程序沒有一個真正能打動我。它們要麼有很多依賴（比如 Ruby 和一大坨庫）， 要麼需要我記住如何用它，考慮到同步配置這種不算經常使用的場合，要記住用法真的挺難。</p>
<p>最近我在用 GNU Stow 來管理我從源代碼在本地編譯安裝到 <code>/usr/local/</code>中的一些程序。 基本上說，在這種常見用法下，是你把這些本地編譯的包配置安裝到 <code>/usr/local/stow/${PKGNAME}-{PKGVERSION}</code> 這樣的位置，然後在 <code>/usr/local/stow/</code>目錄中執行 <code># stow ${PKGNAME}-${PKGVERSION}</code> ，然後它就會爲程序所有的文件創建符號鏈接放在 <code>/usr/local</code> 中合適的地方。然後當你想用 Stow 卸載這個程序的時候，就不必再考慮會留下什麼垃圾文件， 或者找不到安裝時用的 Makefile 了。這種安裝方式下也可以非常容易地切換一個程序的不同版本 （比如我想嘗試不同配置選項下的 <a href="https://dwm.suckless.org/">dwm</a> 或者 <a href="https://st.suckless.org/">st</a> 的時候）。</p>
<p>前段時間在我掃郵件列表的時候，看到某個帖子中某人在說使用 Stow 管理安裝他的點文件。 當時我沒特別在意這個帖子，但是大概我大腦潛意識把它歸檔保存爲今後閱讀了。 昨天我想起來試試這種用法，試過後我不得不說，這比那些專門設計用來做這任務的點文件管理器要方便太多了， 雖然表面上看起來這種用法沒那麼顯而易見。</p>
<p>方法很簡單。我建了個 <code>${HOME}/dotfiles</code> 文件夾，然後在裏面爲我想管理的每個程序配置都 創建一個子文件夾。然後我把這些程序的配置從原本的家目錄移動到這每一個對應的子文件夾中， 並保持它們在家目錄中的文件夾結構。比如，如果某個文件原本應該位於家目錄的頂層文件夾裏， 那它現在應該放在這個程序名子目錄的頂層文件夾。如果某個配置文件通常應該位於默認的 <code>${XDG_CONFIG_HOME}/${PKGNAME}</code> 位置 (<code> ${HOME}/.config/${PKGNAME}</code> )， 那麼現在它應該放在 <code>${HOME}/dotfiles/${PKGNAME}/.config/${PKGNAME}</code> ，如此類推。然後在那個 dotfiles 文件夾裏面，直接運行 <code>$ stow $PKGNAME</code> 命令， Stow 就會爲你自動創建這些配置文件的符號鏈接到合適的位置。接下來就很容易爲這個 dotfiles 目錄初始化版本管理倉庫，從而記錄你對這些配置文件做的修改（並且這也可以極度簡化在不同電腦之間 共享配置，這也是我想要這麼做的主要原因）。</p>
<p>舉個例子，比如說你想管理 Bash, VIM, Uzbl 這三個程序的配置文件。Bash 會在家目錄的頂層文件夾 放幾個文件； VIM 通常會有在頂層文件夾的 .vimrc 文件和 .vim 目錄；然後 Uzbl 的配置位於 <code>${XDG_CONFIG_HOME}/uzbl</code> 以及 <code>${XDG_DATA_HOME}/uzbl</code> 。於是在遷移配置前，你的家目錄的文件夾結構應該看起來像這樣：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">home/
    brandon/
        .config/
            uzbl/
                <span style="color:#f92672">[</span>...some files<span style="color:#f92672">]</span>
        .local/
            share/
                uzbl/
                    <span style="color:#f92672">[</span>...some files<span style="color:#f92672">]</span>
        .vim/
            <span style="color:#f92672">[</span>...some files<span style="color:#f92672">]</span>
        .bashrc
        .bash_profile
        .bash_logout
        .vimrc
</code></pre></div><p>然後遷移配置的方式是，應該建一個 dotfiles 子目錄，然後像這樣移動所有配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">home/
    /brandon/
        .config/
        .local/
            .share/
        dotfiles/
            bash/
                .bashrc
                .bash_profile
                .bash_logout
            uzbl/
                .config/
                    uzbl/
                        <span style="color:#f92672">[</span>...some files<span style="color:#f92672">]</span>
                .local/
                    share/
                        uzbl/
                            <span style="color:#f92672">[</span>...some files<span style="color:#f92672">]</span>
            vim/
                .vim/
                    <span style="color:#f92672">[</span>...some files<span style="color:#f92672">]</span>
                .vimrc
</code></pre></div><p>然後執行以下命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd ~/dotfiles
$ stow bash
$ stow uzbl
$ stow vim
</code></pre></div><p>然後，瞬間，所有你的配置文件（的符號鏈接）就安安穩穩地放入了它們該在的地方，無論原本這些目錄結構 有多麼錯綜複雜，這樣安排之後的 dotfiles 文件夾內的目錄結構立刻整理得有條有理， 並且可以很容易地轉換成版本控制倉庫。非常有用的一點是，如果你有多臺電腦，可能這些電腦並沒有 安裝完全一樣的軟件集，那麼你可以手選一些你需要的軟件配置來安裝。在你的 dotfiles 文件夾中總是 可以找到所有的配置文件，但是如果你不需要某個程序的某份配置，那你就不對它執行 stow 命令，它就不會擾亂你的家目錄。</p>
<p>嗯，以上就是整個用法介紹。希望能有別人覺得這個用法有用！我知道對我來說這個非常有幫助。</p>
<h3 id="freeing-disk-spacehttpswikigentooorgwikiknowledge_basefreeing_disk_space"><a href="https://wiki.gentoo.org/wiki/Knowledge_Base:Freeing_disk_space">Freeing disk space</a><a hidden class="anchor" aria-hidden="true" href="#freeing-disk-spacehttpswikigentooorgwikiknowledge_basefreeing_disk_space">#</a></h3>
<h3 id="how-to-change--set-the-default-crontab-editorhttpswwwservernoobscomchange-set-the-default-crontab-editortextif20you20want20to20change20your20default20crontabin20general2c20you20use20this20command3a20export20editor3d2fusr2fbin2fnano"><a href="https://www.servernoobs.com/change-set-the-default-crontab-editor/#:~:text=If%20you%20want%20to%20change%20your%20default%20crontab,in%20general%2C%20you%20use%20this%20command%3A%20export%20EDITOR%3D%2Fusr%2Fbin%2Fnano.">How to Change &amp; Set the Default crontab Editor</a><a hidden class="anchor" aria-hidden="true" href="#how-to-change--set-the-default-crontab-editorhttpswwwservernoobscomchange-set-the-default-crontab-editortextif20you20want20to20change20your20default20crontabin20general2c20you20use20this20command3a20export20editor3d2fusr2fbin2fnano">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ EDITOR<span style="color:#f92672">=</span>nano crontab -e
</code></pre></div><h3 id="how-to-update-dolphin-file-manager-in-real-timehttpsaskubuntucomquestions311303how-to-update-dolphin-file-manager-in-real-time"><a href="https://askubuntu.com/questions/311303/how-to-update-dolphin-file-manager-in-real-time">How to update dolphin file manager in real time</a><a hidden class="anchor" aria-hidden="true" href="#how-to-update-dolphin-file-manager-in-real-timehttpsaskubuntucomquestions311303how-to-update-dolphin-file-manager-in-real-time">#</a></h3>
<p>The way in order to refresh Dolphin is to press F5. However, this would be manual.</p>
<p>In order to continuously refresh, an automatic solution, create a bash script that runs on boot. This bash script should press F5 every five seconds if Dolphin is open. Create a file named <code>dolphin-update</code> in <code>/usr/local/bin</code> with the following contents:</p>
<pre tabindex="0"><code>#!/bin/bash
while true; do
    PID=$(pgrep &quot;dolphin&quot;)
    if [ &quot;$?&quot; -ne &quot;0&quot; ]; then
        xdotool key 'F5'
    fi
    sleep 5
done
</code></pre><p>You may need to first create it as root and then change the owner to your user:</p>
<pre tabindex="0"><code>sudo chown username:username /usr/local/bin/dolphin-update 
</code></pre><p>Ensure that it has executable permissions:</p>
<pre tabindex="0"><code>chmod +x /usr/local/bin/dolphin-update
</code></pre><p>Now we need that to run on boot. To do that run <code>sudo crontab -e</code> and add the following line to the end of the file:</p>
<pre tabindex="0"><code>@reboot /usr/local/bin/dolphin-update
</code></pre><p>This script will run on boot.</p>
<p>You should now have a continuously refreshing Dolphin!</p>
<p>There are some caveats to this script.</p>
<ul>
<li>If you open Dolphin, go to another application where F5 triggers something, (eg Chromium refreshes the page), the script will still run and be a constant annoyance. <strong>Solution:</strong> Close Dolphin when not actively using it.</li>
<li>As a <code>cron</code> job is used, if your computer crashes, the script will not run on boot. However this is a problem with <code>cron</code> not the script.</li>
</ul>
<p>What the script means, line by line:</p>
<ul>
<li><code>#!/bin/bash</code> - shebang to run with bash</li>
<li><code>while true; do</code> - run continuously</li>
<li><code>PID=$(pgrep &quot;dolphin&quot;)</code> - find the process ID of a <code>dolphin</code> instance. This is purely there to check whether there is even a instance of Dolphin running.</li>
<li><code>if [ &quot;$?&quot; -ne &quot;0&quot; ]; then</code> - check the result of whether there is a Dolphin instance running. If there is, then &hellip;</li>
<li><code>xdotool key 'F5'</code> - press F5</li>
<li><code>fi</code> - end the <code>if</code> block</li>
<li><code>sleep 5</code> - wait 5 seconds before repeating the process</li>
<li><code>done</code> - end the while block</li>
</ul>
<h3 id="how-do-i-convert-a-png-into-a-icohttpssuperusercomquestions227736how-do-i-convert-a-png-into-a-ico1012535"><a href="https://superuser.com/questions/227736/how-do-i-convert-a-png-into-a-ico/1012535">How do I convert a .PNG into a .ICO?</a><a hidden class="anchor" aria-hidden="true" href="#how-do-i-convert-a-png-into-a-icohttpssuperusercomquestions227736how-do-i-convert-a-png-into-a-ico1012535">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ffmpeg -i img.png img.ico
$ ffmpeg -i img.png -vf scale<span style="color:#f92672">=</span>32:32 img.ico
</code></pre></div><h3 id="crop-a-photo-to-fit-a-circle-using-ffmpeghttpsstackoverflowcomquestions63997289can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg"><a href="https://stackoverflow.com/questions/63997289/can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg">Crop a photo to fit a circle using ffmpeg</a><a hidden class="anchor" aria-hidden="true" href="#crop-a-photo-to-fit-a-circle-using-ffmpeghttpsstackoverflowcomquestions63997289can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ffmpeg -i avatar.png -i mask.png -filter_complex <span style="color:#e6db74">&#34;[0]scale=400:400[ava];[1]alphaextract[alfa];[ava][alfa]alphamerge&#34;</span> output.png
</code></pre></div><p>scale=400:400 是 mask.png 的大小。</p>
<p>mask.png is just a circle, example:</p>
<p><img loading="lazy" src="/Distributions/EMKmn.png" alt=""  />
</p>
<h3 id="path-to-kde-picture-of-the-dayhttpsaskubuntucomquestions1197417where-is-bings-picture-of-the-day-stored-on-my-system"><a href="https://askubuntu.com/questions/1197417/where-is-bings-picture-of-the-day-stored-on-my-system">Path to KDE Picture of the Day</a><a hidden class="anchor" aria-hidden="true" href="#path-to-kde-picture-of-the-dayhttpsaskubuntucomquestions1197417where-is-bings-picture-of-the-day-stored-on-my-system">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd $HOME/.cache/plasma_engine_potd
$ file *
apod:             JPEG image data, JFIF standard 1.01, resolution <span style="color:#f92672">(</span>DPI<span style="color:#f92672">)</span>, density 96x96, segment length 16, comment: <span style="color:#e6db74">&#34;Description: Adobe ImageReady&#34;</span>, baseline, precision 8, 960x634, components <span style="color:#ae81ff">3</span>
bing:             JPEG image data, JFIF standard 1.01, resolution <span style="color:#f92672">(</span>DPI<span style="color:#f92672">)</span>, density 96x96, segment length 16, baseline, precision 8, 1920x1080, components <span style="color:#ae81ff">3</span>
unsplash:1065976: JPEG image data, JFIF standard 1.01, resolution <span style="color:#f92672">(</span>DPI<span style="color:#f92672">)</span>, density 72x72, segment length 16, baseline, precision 8, 3840x2160, components <span style="color:#ae81ff">3</span>
</code></pre></div><h3 id="baloohttpscommunitykdeorgbaloo"><a href="https://community.kde.org/Baloo">Baloo</a><a hidden class="anchor" aria-hidden="true" href="#baloohttpscommunitykdeorgbaloo">#</a></h3>
<p>Baloo is the file indexing and file search framework for KDE Plasma, with a focus on providing a very small memory footprint along with with extremely fast searching.</p>
<p><strong>Indexing limitations</strong></p>
<p>Baloo uses the file metadata extractors in <a href="https://invent.kde.org/frameworks/kfilemetadata">KFileMetadata</a> to get information about each file it indexes. This means for a file&rsquo;s content to be indexed</p>
<ul>
<li>the file must have a recognizable MIME type</li>
<li>KDE must have an extractor for that MIME type</li>
</ul>
<p>Other limitations:</p>
<ul>
<li>Baloo doesn&rsquo;t index text files (those whose MIME type is detected as &ldquo;text/<em>something</em>&quot;) over 10 MB (<a href="https://invent.kde.org/frameworks/baloo/-/blob/master/src/file/extractor/app.cpp#L143">source</a>).</li>
<li>The KFileMetadata extractor for text attempts to convert text to Unicode. If the file uses another encoding, such as iso-8859-1, any file contents after the first character that is invalid in Unicode will not be indexed. You may find the <code>-i</code> option to the <code>file</code> command-line utility useful; it tries to infer the character set of a file, e.g. file -i <em>path/to/myfile.txt</em>.</li>
</ul>
<p><strong>Using Baloo</strong></p>
<p>Baloo is not an application, but a daemon to index files. Applications can use the Baloo framework to provide file search results. For example, <a href="https://community.kde.org/Dolphin">Dolphin</a>&rsquo;s Content search can use Baloo.</p>
<p>KDE System Settings &gt; File Search provides an <a href="http://vhanda.in/blog/2014/04/desktop-search-configuration/">intentionally limited number of settings</a>. You can make additional adjustments in <a href="https://community.kde.org/Baloo/Configuration">Baloo&rsquo;s configuration file</a>.</p>
<p><strong>balooctl</strong></p>
<p><code>balooctl</code> is a CLI command to perform certain operations on Baloo. Enter <code>balooctl --help</code> in a terminal app such as <a href="http://userbase.kde.org/Konsole">userbase:Konsole</a> to list its available subcommands.</p>
<h4 id="baloo-file-extractor-crashes-on-every-boothttpsforumsgentooorgviewtopic-t-1096234-start-0html"><a href="https://forums.gentoo.org/viewtopic-t-1096234-start-0.html">Baloo File Extractor Crashes on every boot</a><a hidden class="anchor" aria-hidden="true" href="#baloo-file-extractor-crashes-on-every-boothttpsforumsgentooorgviewtopic-t-1096234-start-0html">#</a></h4>
<p>I find Baloo fragile and a nuisance. Sometimes it works OK on my amd64 and ~amd64 machines, other times not. If you are not interested in file indexing, you can disable it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ balooctl disable
</code></pre></div><p>这个不好用，菊苣（巨巨、大佬）们都推荐关闭。</p>
<h3 id="内核升级一般步骤httpsblogsoymilkfun20201117linuxgentoogentookernelupdate"><a href="https://blog.soymilk.fun/2020/11/17/Linux/Gentoo/GentooKernelUpdate/">内核升级一般步骤</a><a hidden class="anchor" aria-hidden="true" href="#内核升级一般步骤httpsblogsoymilkfun20201117linuxgentoogentookernelupdate">#</a></h3>
<h4 id="升级内核">升级内核<a hidden class="anchor" aria-hidden="true" href="#升级内核">#</a></h4>
<p>建议在<code>make.conf</code>中添加<code>USE='symlink'</code>，然后更新系统。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge --ask --verbose --update --deep --newuse @world
</code></pre></div><h4 id="configuration">Configuration<a hidden class="anchor" aria-hidden="true" href="#configuration">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo make menuconfig
</code></pre></div><h4 id="build">Build<a hidden class="anchor" aria-hidden="true" href="#build">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo make -j4
</code></pre></div><h4 id="install">Install<a hidden class="anchor" aria-hidden="true" href="#install">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo make modules_install
$ sudo make install
</code></pre></div><h4 id="bootloader">BootLoader<a hidden class="anchor" aria-hidden="true" href="#bootloader">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo grub-mkconfig -o /boot/grub/grub.cfg
</code></pre></div><p>重启以应用新的内核。</p>
<h4 id="clean">Clean<a hidden class="anchor" aria-hidden="true" href="#clean">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo eclean-kernel -n <span style="color:#ae81ff">1</span>
</code></pre></div><p>仅保留当前内核。</p>
<h2 id="questions">Questions<a hidden class="anchor" aria-hidden="true" href="#questions">#</a></h2>
<h3 id="problem-with-transparencies-and-windowing-ghosting-outhttpsforumgarudalinuxorgtproblem-with-transparencies-and-windowing-ghosting-out9568"><a href="https://forum.garudalinux.org/t/problem-with-transparencies-and-windowing-ghosting-out/9568">Problem with transparencies and windowing ghosting out</a><a hidden class="anchor" aria-hidden="true" href="#problem-with-transparencies-and-windowing-ghosting-outhttpsforumgarudalinuxorgtproblem-with-transparencies-and-windowing-ghosting-out9568">#</a></h3>
<p>Anyhow, I now applied the &ldquo;force smoothest animations&rdquo; in the KDE compositor settings and it seems to have done the trick!Telegram not launching from the browser xdg-open</p>
<h3 id="telegram-not-launching-from-the-browser-xdg-openhttpswwwredditcomrmanjarolinuxcommentsk76cphtelegram_not_launching_from_the_browser_xdgopen"><a href="https://www.reddit.com/r/ManjaroLinux/comments/k76cph/telegram_not_launching_from_the_browser_xdgopen/">Telegram not launching from the browser xdg-open</a><a hidden class="anchor" aria-hidden="true" href="#telegram-not-launching-from-the-browser-xdg-openhttpswwwredditcomrmanjarolinuxcommentsk76cphtelegram_not_launching_from_the_browser_xdgopen">#</a></h3>
<p>I am receiving the following message:</p>
<pre tabindex="0"><code>Unable to create io-slave. klauncher said: Unknown protocol 'tg'.
</code></pre><p>Hey!
So it’s easy to solve</p>
<ol>
<li>Open the folder <code>\~/.local/share/applications</code></li>
<li>find some files about telegram desktop, like an example, my is <code>userapp-Telegram Desktop-FXJ6T0.desktop</code></li>
<li>Add the line at the end of file <code>MimeType=application/x-xdg-protocol-tg;x-scheme-handler/tg;</code></li>
<li>Reload your browser (maybe do not need…)</li>
<li>Enjoy!</li>
</ol>
<p>我的该目录下有两个与telegram相关的desktop文件，都改了之后就行了。</p>
<h3 id="how-to-reset-kde--display-settings-after-a-move-to-a-new-machinehttpsaskubuntucomquestions299241how-to-reset-kde-display-settings-after-a-move-to-a-new-machine"><a href="https://askubuntu.com/questions/299241/how-to-reset-kde-display-settings-after-a-move-to-a-new-machine">How to reset KDE / display settings after a move to a new machine</a><a hidden class="anchor" aria-hidden="true" href="#how-to-reset-kde--display-settings-after-a-move-to-a-new-machinehttpsaskubuntucomquestions299241how-to-reset-kde-display-settings-after-a-move-to-a-new-machine">#</a></h3>
<p>I had to remove <code>.local/share/kscreen</code> on plasma5</p>
<h3 id="how-can-i-reset-my-display-settings-through-terminalhttpsaskubuntucomquestions749333how-can-i-reset-my-display-settings-through-terminal"><a href="https://askubuntu.com/questions/749333/how-can-i-reset-my-display-settings-through-terminal">How can I reset my display settings through terminal?</a><a hidden class="anchor" aria-hidden="true" href="#how-can-i-reset-my-display-settings-through-terminalhttpsaskubuntucomquestions749333how-can-i-reset-my-display-settings-through-terminal">#</a></h3>
<p>Removing <code>~/.config/monitors.xml</code> should do it:</p>
<p>cfw 在gentoo下用不了，设置端口总为0；</p>
<p>clash 在gentoo下需要root权限，最好用 systemd service 运行。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://sakamotokurome.github.io/tags/unix/">Unix</a></li>
      <li><a href="https://sakamotokurome.github.io/tags/linux/">Linux</a></li>
      <li><a href="https://sakamotokurome.github.io/tags/gentoo/">Gentoo</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://sakamotokurome.github.io/posts/gentooinstallation/">
    <span class="title">Next Page »</span>
    <br>
    <span>Gentoo Installation</span>
  </a>
</nav>

  </footer>
</article>

<div class="disqus-container">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    this.page.identifier = '2a4f17';
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "sakamotokurome" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://sakamotokurome.github.io/">Sakamoto Kurome</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>
