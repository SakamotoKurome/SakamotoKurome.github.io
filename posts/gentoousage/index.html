<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Gentoo Usage | Sakamoto Kurome</title><meta name=keywords content="Unix,Linux,Gentoo"><meta name=description content="Portage介绍 欢迎使用 Portage Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具"><meta name=author content="Sakamoto Kurome"><link rel=canonical href=https://sakamotokurome.github.io/posts/gentoousage/><link crossorigin=anonymous href=/assets/css/stylesheet.min.06402d745029223a9231706eea1dd82e107754f4ad625acbe7fd336a5e59566c.css integrity="sha256-BkAtdFApIjqSMXBu6h3YLhB3VPStYlrL5/0zal5ZVmw=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://sakamotokurome.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://sakamotokurome.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sakamotokurome.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://sakamotokurome.github.io/apple-touch-icon.png><link rel=mask-icon href=https://sakamotokurome.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.111.3"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=stylesheet href=https://sakamotokurome.github.io/custom.css><meta name=google-site-verification content="i2r403EffR8m-KBf7EHi6AYg7tfnMshaXTAynoYPnpE"><script async src="https://www.googletagmanager.com/gtag/js?id=G-K2Y212LPQ2"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-K2Y212LPQ2",{anonymize_ip:!1})}</script><meta property="og:title" content="Gentoo Usage"><meta property="og:description" content="Portage介绍 欢迎使用 Portage Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具"><meta property="og:type" content="article"><meta property="og:url" content="https://sakamotokurome.github.io/posts/gentoousage/"><meta property="og:image" content="https://sakamotokurome.github.io/Covers/pikrepo.jpg.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-21T15:39:24+08:00"><meta property="article:modified_time" content="2022-03-21T15:39:24+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sakamotokurome.github.io/Covers/pikrepo.jpg.webp"><meta name=twitter:title content="Gentoo Usage"><meta name=twitter:description content="Portage介绍 欢迎使用 Portage Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://sakamotokurome.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Gentoo Usage","item":"https://sakamotokurome.github.io/posts/gentoousage/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Gentoo Usage","name":"Gentoo Usage","description":"Portage介绍 欢迎使用 Portage Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具","keywords":["Unix","Linux","Gentoo"],"articleBody":"Portage介绍 欢迎使用 Portage Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具。\nPortage 是用 Python 和 Bash 两种语言编写的。因为它们都是脚本语言所以用户可以直接阅读它的代码。\n大多数用户通过 emerge 使用 Portage。本章的内容不是复述 emerge 的 man page。要了解 emerge 的所有可用选项，请查阅 emerge 的 man page（emerge 中文手册）：\n# man emerge Gentoo 软件仓库 查询 Portage 的信息\n# emerge --info Ebuild 当 Gentoo 的文档介绍某个软件包的时候，这意味着 Gentoo 的用户们可以在 Gentoo 的软件仓库里找到它。ebuild 是一种包含了所有 Portage 维护软件（比如安装，搜索，查询等等）所需信息的文件，而 Gentoo 的软件仓库是它们的一个集合。这些 ebuild 文件默认储存在 /var/db/repos/gentoo。\nPortage 对于软件的行为都是基于本地的 ebuild。为了能收到新的软件包，安全更新等等，时常更新本地 ebuild 是一件很重要的事情。\n更新 Gentoo 软件仓库 Gentoo 的软件仓库通常使用 rsync 进行同步，rsync 是一个快速的文件增量传输工具。要使用它很简单，Portage 的命令行前端 emerge 提供了一个调用 rsync 的方法：\n# emerge --sync 有时防火墙会干扰 rsync 与镜像的连接。这时，我们可以使用 emerge-webrsync 来自动下载和安装 Portage 树的快照版本：\n# emerge-webrsync 使用 emerge-webrsync 的另一个好处是可以只安装由 Gentoo release engineering 团队的 GPG 密钥签名过的快照。与此有关的详细信息可以在 fetching validated Gentoo repository snapshots 找到\n维护软件 搜索软件 有很多方法可以在 Gentoo 的软件仓库寻找软件。其中之一是使用 emerge 本身。在默认情况下 emerge –search 会返回所有符合搜索条件的包名。\n举个例子，找出所有名字里含有 “pdf” 的包：\n# emerge -s \u003c包名\u003e # emerge --search pdf 如果要根据描述进行搜索，可以使用 --searchdesc （或 -S）选项:\n# emerge --searchdesc pdf 需要注意的是它会输出很多信息。不过由于都有很清楚的标识，我们就不再赘述它们的意思了。\n安装软件 当你找到了软件包的名字，安装它只需要简单得使用 emerge。举个例子，如果要安装 gnumeric：\n# emerge \u003c包名\u003e # emerge --ask app-office/gnumeric 由于很多软件依赖其它的软件，在安装该软件的同时很可能还会安装它的一些以来。不要担心，Portage 可以很好地处理依赖关系。如果要知道 Portage 会安装什么软件，可以在命令中加入 -p/--pretend选项。举个例子：\n# emerge --pretend gnumeric 在安装软件期间，Portage将从Internet下载必要的源代码（如果需要），并将其默认存储在 /var/cache/distfiles/ 中。 之后，它将解压缩，编译和安装包。 要让Portage仅下载源代码而不安装软件，请添加-f/--fetchonly选项到emerge命令：\n# emerge --fetchonly gnumeric 恢复上一次失败的 emerge\n# emerge -r 其它常用的选项有\n-1/--oneshot 一般用在安装软件包时，不将该包添加到 world 集中\n-O/--nodeps 不计算依赖关系，只操作指定的包（安装时可能会因为依赖不满足而导致安装失败）\n-j/--jobs 设置 Portage 同时执行的最大任务数，如果未设置数量，那么 Portage 不会限制最大的任务数。如果要将该选项添加到默认选项下，那么建议配合 -l/--load-average 使用， -l/--load-average 用于配置 emerge 的负载阈值，当当前负载到达设定值后， emerge 将不再开启新任务，以避免负载过高，这在 CPU 不够强悍或者内存不宽裕的机器上很需要。比如在一个 8 核 16 线程 16G 内存的机器上，可以设置成 -j -l 12 ，这样的设定使 portage 的并行任务数不由硬性规定的数目来限制，而是通过动态负载来进行限制。\n--keep-going 它会在安装出错时，跳过安装失败的包，并重新计算依赖后继续安装剩余包\n-n/--noreplace 不重复安装已经安装的包（默认会忽略掉 USE 的改动以及升级的查询，除非对应加上 -D/-U 和 -u 选项）\n-t/--tree 显示给定包的安装依赖树\n--autounmask 类\n这是一组在新装软件包时便于解除安装限制的选项。之前有介绍，在 Portage 安装软件的过程中，可能会因为 USE/License/Keywords 等因素导致无法直接安装，需要配置后再进行，而这组选项可以自动化这个过程。个人建议的相关选项组合为 --autounmask --autounmask-keep-masks --autounmask-write=n ，此组合不会完全自动写入配置到系统下，但是提示了如何配置，方便手动写入，既简化了处理限制的流程，又能保证掌握每次安装包时的改动。\n查找已安装软件的文档 许多软件包中包含有自己的文档，有些时候，doc的USE标记决定了软件包中的自带文档是否会被安装。您可以通过 emerge -vp category/包名命令来检查是否存在doc USE 标志：\n# emerge -vp media-libs/alsa-lib These are the packages that would be merged, in order: Calculating dependencies... done! [ebuild R ] media-libs/alsa-lib-1.1.3::gentoo USE=\"python -alisp -debug -doc\" ABI_X86=\"(64) -32 (-x32)\" PYTHON_TARGETS=\"python2_7\" 0 KiB 最好的启用 doc USE 的方式是在 /etc/portage/package.use里对想要启用的包单独启用，这样你就能只获得你想要的软件文档。了解更多信息请阅读 USE flags chapter。\n当一个软件包安装结束后，它的文档通常会存放在/usr/share/doc/目录下的，以软件包名命名的子目录中：\n$ ls -l /usr/share/doc/alsa-lib-1.1.3 total 16 -rw-r--r-- 1 root root 3098 Mar 9 15:36 asoundrc.txt.bz2 -rw-r--r-- 1 root root 672 Mar 9 15:36 ChangeLog.bz2 -rw-r--r-- 1 root root 1083 Mar 9 15:36 NOTES.bz2 -rw-r--r-- 1 root root 220 Mar 9 15:36 TODO.bz2 列出已安装文档文件的更可靠方法是使用 equery 的 --filter 选项。 equery 用于查询Portage的数据库，并作为 app-portage/gentoolkit 包的一部分：\n$ equery files --filter=doc alsa-lib * Searching for alsa-lib in media-libs ... * Contents of media-libs/alsa-lib-1.1.3: /usr/share/doc/alsa-lib-1.1.3/ChangeLog.bz2 /usr/share/doc/alsa-lib-1.1.3/NOTES.bz2 /usr/share/doc/alsa-lib-1.1.3/TODO.bz2 /usr/share/doc/alsa-lib-1.1.3/asoundrc.txt.bz2 --filter 选项可与其他规则一起使用，以查看许多其他类型文件的安装位置。可以在 equery 的手册中查看其他功能: man 1 equery。\n卸载软件 当您想把一个软件包从系统中移除的时候，使用 emerge –unmerge命令。命令执行完成后，Portage将会移除此软件包安装到您系统中的所有文件，除了那些在安装软件后您修改过的配置文件。保留这些修改过的配置文件是为了便于您今后再次使用它。\n# emerge --unmerge gnumeric # emerge -C \u003c包名\u003e 当您从系统中移除一个软件包时，之前那些为了满足其依赖关系而被自动安装的软件包将会被保留在系统中。要使Portage找到现在可以删除的所有依赖项，可以使用 --depclean 功能。\n自动清理系统下的软件包\n# emerge --ask --depclean # emerge -ac 默认选项 emerge 支持配置一组默认选项，用于在每次运行 emerge 时采用。这个储存默认选项的变量名为 EMERGE_DEFAULT_OPTS ，在 /etc/portage/make.conf 文件下设置。\n这里一组比较推荐的默认选项配置为\nEMERGE_DEFAULT_OPTS=\"--autounmask --autounmask-keep-masks --autounmask-write=n --keep-going -v -j -l 12\" 其中的 12 请根据实际情况修改，如果配置了上文的 binhost ，那么对应选项也添加进入。\nUnderstanding Portage’s Formatted and Colored Output Output from portage is compactly formatted to indicate a plethora of information.\nEmerge “Pretend” Output\nN = new (not yet installed) S = new SLOT installation (side-by-side versions) U = updating (to another version) D = downgrading (best version seems lower) R = replacing (re-merging same version) F = fetch restricted (must be manually downloaded) f = fetch (already downloaded) B = blocked by an already installed package USE Flags\nAn unmarked USE flag is unchanged and enabled. - A dash preceding a USE flag (yellow, green or blue) shows that it is disabled. % A percent symbol following a USE flag indicates that it is new for this package. Identical to yellow output. ***** An asterisk following a USE flag indicates that its meaning/scope has been updated. Identical to green output. () Parentheses around a USE flag indicate that it is currently masked by your profile. This is usually because the USE flag can not be supported on the given platform (for example, the win32codecs on amd64 with non-binary packages) or is irrelevant (for example, sse is available on all amd64 CPU’s, so there’s no point being able to disable it in a 64-bit environment). Color Output\nPortage returns information to you using both symbols and colors. While the combination makes for a pretty output it also may appear confusing on first glance. Note that the color information is not required, so it repeats the symbolic output.\nred - The USE flag is enabled and has not changed. yellow - The USE flag has been added since the package was last installed. green - The USE flag has changed since the last time the package was installed, as the asterisk after it indicates. blue - The USE flag is disabled, as the dash before it indicates. Example\nIf you run the command\n# emerge --update --verbose --deep --newuse world you might get something similar to\n[ebuild R ] sys-kernel/linux-headers-2.6.11-r2 USE=\"-gcc64%\" 36,470 kB [ebuild U ] sys-process/psmisc-22.2 USE=\"X* ipv6 nls (-selinux)\" 238 kB In this example the sys-kernel/linux-headers package would be reinstalled as indicated by the “R” at the beginning of the line. The sys-process/psmisc package is being updated, as shown by the “U” at the beginning of the line.\nThe gcc64 USE flag is colored yellow and followed by “%” showing that that option has been added since the package was last installed. The “-” shows that it will be disabled during this update. The X USE flag will be green and followed by “*” because that USE flag has changed since the last time the package was installed, as the asterisk after it indicates. No “-” shows that it will be enabled during this update. The ipv6 and nls USE flags would appear red since they are enabled (No “-”) and have not changed (No “*****”). The selinux USE flag will be blue because the flag is disabled, as the dash before it indicates. The parentheses also show that it is an unavailable or irrelevant option. 更新系统 要保持您的系统在最佳状态（更不用说安装那些最新的安全更新），您需要定期的更新您的系统。由于Portage只能检查本地已有文件，因此您首先应该更新您的Portage树。当您的Portage树更新后，您可以用 emerge –update @world命令来更新系统。在下一个例子里，我们还会使用 --ask 选项来控制Portage显示它要更新的软件包列表， 并让您决定是否继续更新。\n# emerge --update --ask @world Portage将搜索已安装的程序的新版本。 然而，它只会验证明确安装的应用程序（在 /var/lib/portage/world 列出的应用程序）的版本，却不会检查它们的依赖项。若要更新这些包的依赖项，请添加 --deep 选项：\n# emerge --update --deep @world 但是，这并不意味着会更新所有的软件包：某些系统上的软件包，会在编译和构建软件的过程中需要，但是一旦安装完软件，就不再需要这些依赖项。 Portage 称这些依赖为“构建依赖”。 若要在更新时包含这些构建依赖，请添加 --with-bdeps=y 选项：\n# emerge --update --deep --with-bdeps=y @world 因为有时那些没有明确安装的包（但作为其他软件包的依赖而装入系统中）会推出安全更新，所以推荐偶尔运行一下这个命令。\n每当您改变了系统中任何的 USE 标记后，最好加入 --newuse 选项。这样 Portage 将会验证这个 USE 标记变动后，是否需要安装新的软件包或者将现有的软件包重新编译。\n# emerge --update --deep --with-bdeps=y --newuse @world Meta软件包\nGentoo中的一些软件包并没有包含任何实际的内容，而只是用来安装一系列软件包的集合。例如，kde-plasma/plasma-meta 包就是一个包含了一系列与Plasma相关的互相依赖的软件包的集合，您可以通过安装它来在系统中搭建起一个完整的KDE Plasma 桌面环境。\n如果您试图从系统中移除一个这样的软件包的集合体，只是单纯地使用 emerge –unmerge 命令并不能完成您的要求，原因在于这些包的依赖关系仍然保留在系统中。\n不用担心，Portage也提供了移除孤立依赖的软件包的功能，但由于软件包间的依赖关系是动态的，您首先需要充分地更新您的整个系统，包括更改USE标记设定而导致的变化。在这之后您可以运行emerge –depclean来移除那些完全没有被其他包依赖的软件包。移除之后你需要重新编译那些曾经与刚刚移除的这些包动态连接过的应用程序，因为实际上这些程序不需要那些包。\n所有这些可以用以下三个命令来实现：\n# emerge --update --deep --newuse @world # emerge --depclean # revdep-rebuild 关于配置文件的更新 有时候在更新了某些软件包后你会发现出现了一个类似如下的提示信息：\n* IMPORTANT: 2 config files in '/etc' need updating. * See the CONFIGURATION FILES and CONFIGURATION FILES UPDATE TOOLS * sections of the emerge man page to learn how to update config files. 一般出现这种情况的直接原因是你通过归属于一个软件包的文件修改了其默认配置，导致新安装的文件与现存文件不符，于是 Portage 出于保护现存文件的目的，将新文件重命名为了对应目录下的 ._cfgxxxx_\u003c原名\u003e 文件，这是一个很常见的情况。\n而每当出现这种情况后，需要做的操作就是人工介入，判断一下保留哪个文件，还是将两个文件合并。而自带用于进行此操作的对应命令有 dispatch-conf 与 etc-update 。\n以 dispatch-conf 为例，root 权限下执行后，它会逐个文件列出改动，然后提示你进行操作，比如按 z 保留旧的配置文件，按 u 使用新安装的配置文件替换旧的，等等。\n改变桌面环境/ Change Profile 首先修改 /var/lib/portage/world 文件，这个文件记录了用户主动安装的软件，换句话说，整个系统的构建就是围绕这 world 来创建的。将这个文件中不再需要的包删除，比方说 KDE 的软件和一些后续可以再安装，而目前保留可能造成构建麻烦的软件，比方说 htop，megasync，telegram-desktop，fcitx5 之类的，尽量减少到保留必须的就可以了，比方说内核，zfs 之类的。另外可以使用 emerge --deselect xxxx 命令清理 world 。\n然后是修改或是删除暂时不需要的 USE 配置文件。这里需要强调一下，world 文件是我们手动安装的软件，这些软件用 /etc/portage/package.use/ 定义了其他附带安装的软件包和组。里面不再需要的包，就需要精简，甚至是删除。\n其次使用 eselect profile 修改配置文件到需要的 Profile 。\n再次就是运行 emerge --sync; emerge --depclean 来清理系统。一般情况下，这个步骤会删除数百个包，耐心等它完成。\n最后就是一些收尾工作，清理结束后，运行一些小工具来解决一些新老软件依赖的问题，运行下面的命令一波清：\n# emerge -avj @preserved-rebuild; perl-cleaner --all; emerge --sync; emerge -avujDN --with-bdeps=y --autounmask-write=y @world 运行以后看看会不会有什么 Block 之类的包，或者循环依赖的包，手动删除下；还有时候解决不了看看是不是 USE 没有清理干净，多试几次就会清理干净，更新没有任何报错就可以开始后续的操作了。\n这个时候一般会来一次全系统重构。命令如下：\n# emerge -ej --keep-going @world 清理 /home// 下的各种配置文件，安装新的桌面环境。\nLicenses 从Portage版本2.1.7开始，可以根据其授权协议接受或拒绝安装软件。 portage 树中的所有包在其ebuild中包含一个LICENSE选项。 运行emerge –search package/category 将显示软件包的许可证。\nImportant：ebuild 中 的 LICENSE 变量仅是为 Gentoo 开发人员和用户准备的一份指南。它既不是法律声明，也不保证其真实性。因此不要过度依赖它，您需要深入检查软件包的本身，以及您使用的所有文件。\n默认情况下，Portage允许自由软件基金会，开源计划或遵循自由软件定义明确批准的许可。\n控制允许的许可证的变量称为ACCEPT_LICENSE，可以在/etc/portage/make.conf文件中设置。 在下一个示例中，将显示他的默认值：\nACCEPT_LICENSE=\"-* @FREE\" 使用此配置，可以安装具有自由软件或文档许可证的软件包。非自由软件将无法安装。\n可以在ACCEPT_LICENSE中全局设置 ACCEPT_LICENSE，或者在/etc/portage/package.license 文进行配置。\n举个例子，要允许www-client/google-chrome 包的google-chrome的授权协议， 把下面的内容添加到 /etc/portage/package.license:\n\u003c类\u003e/\u003c名\u003e \u003c许可名称\u003e www-client/google-chrome google-chrome # 亦可指定版本，比如对 20210818 及以上版本的 sys-kernel/linux-firmware 进行配置 \u003e=sys-kernel/linux-firmware-20210818 linux-fw-redistributable no-source-code 这允许安装www-client/google-chrome 程序包，但禁止安装www-plugins/chrome-binary-plugins 程序包，即使它具有相同的 授权协议。\n重要：授权协议存储在 /var/db/repos/gentoo/licenses/ ，授权协议组在/var/db/repos/gentoo/profiles/license_groups 里面。CAPITAL字母中每行的第一个条目是许可证组的名称，之后的每个条目都是单独的许可证。\n在 ACCEPT_LICENSE 变量中定义的许可证组前缀为@ 符号。一种可能的设置（以前的Portage默认设置），是允许除“最终用户许可协议（EULA）”以外所有的许可证，“最终用户许可协议（EULA）”中的许可证需要阅读并签署接受协议。要完成此操作，请接受所有许可证（使用*），然后删除EULA组中的许可证，如下所示：\nACCEPT_LICENSE=\"* -@EULA\" 请注意，此设置也将接受非自由软件和文档。\nMasking \u0026 Unmasking packages package.mask中指定的软件将会不被安装（可以将其看成黑名单），当新版本的软件出现一些问题的时候（或者是不兼容）可以在这个文件中添加对应的记录。\n/etc/portage/package.unmask 文件的作用将会覆盖package.mask的效果（安装白名单）。\n屏蔽特定的包版本 如果它不存在，请创建/etc/portage/package.mask 文件：\n# echo \"\u003ex11-drivers/ati-drivers-12.6_beta_pre897\" \u003e\u003e /etc/portage/package.mask 或者，创建/etc/portage/package.mask/ 目录：\n# mkdir -p /etc/portage/package.mask/ # echo \"\u003ex11-drivers/ati-drivers-12.6_beta_pre897\" \u003e /etc/portage/package.mask/ati-drivers 从 ebuild 存储库中屏蔽包 创建一个文件以从名为“larry”的 ebuild 存储库中屏蔽名称为www-client/firefox 的包\n# echo \"www-client/firefox::larry\" \u003e /etc/portage/package.mask/firefox 屏蔽 overlay 所有的包\n常规操作都是enable repository 后把所有包都mask 掉，要用的时候单独一个个开，加上 autounmask 也不用自己写。\n*/*::overlay_name ACCEPT_KEYWORDS ACCEPT_KEYWORDS 变量告诉包管理器哪个 ebuild 的 KEYWORDS 允许接受。\n变量在哪里设置？ 这个变量通常通过 Gentoo 的 profile 设置。但是可以在用户的 /etc/portage/make.conf 文件里进行覆盖，以及在 /etc/portage/package.accept_keywords 文件/目录下的每个包里或者甚至在命令行中进行覆盖。\nImportant：通过命令行覆盖 ACCEPT_KEYWORDS 变量通常被认为是个坏主意，因为设置不会被包管理器保存而且可能导致不必要的行为。\n稳定与不稳定的 keywords 在绝大多数的 profile 中 ACCEPT_KEYWORDS 变量的默认值即系统架构本身，例如 ACCEPT_KEYWORDS=\"amd64\" 或者 ACCEPT_KEYWORDS=\"arm\"。在此情况下，包管理器只接受那些KEYWORDS 变量包含此架构的 ebuild。如果用户希望能够安装那些还未被认为适合生产环境使用的 ebuild，可以在架构前添加 ~ 前缀，例如：\n# nano -w /etc/portage/make.conf ACCEPT_KEYWORDS=\"~amd64\" 由于ACCEPT_KEYWORDS变量是增量的，在添加测试关键字 (~amd64)的时候，不应当指定稳定的关键字(amd64)。\n如果不是进行系统全局设置，那么可以在 /etc/portage/package.accept_keywords 文件或目录中对每个包进行单独设置：\n\u003c类\u003e/\u003c名\u003e [可选的关键字配置] # games games-fps/doomsday ~amd64 # 亦可指定版本，比如对 21.04.3 及以上版本的 kde-apps-meta 进行配置 \u003e=kde-apps/kde-apps-meta-21.04.3 除了 ACCEPT_KEYWORDS 的通常值以外， package.accept_keywords 还支持三个特殊值：\n* — 如果包在任何系统架构是稳定的，那么它可见 ~* — 如果包在任何系统架构是测试的，那么它可见 ** — 这个包总是可见的 (KEYWORDS 被完全忽略) 最后一个选项对于版本经常改变的包 （当前 svn/git/mercurial/… 版本的包， 他们通过 live ebuild 来支持，并且没有 KEYWORDS 变量。\n当Portage报错的时候 简介 正如我们之前指出的那样，Portage是一个非常强大并支持许多特性的软件包管理工具，而这是其他类似工具所欠缺的。为了理解这一点，我们为您粗略地解释一些Portage的面貌。\n通过使用Portage，一个软件的不同版本可以共存于一个系统中。其他发行版倾向于直接在软件包名字中包含版本号（例如freetype 和 freetype2），Gentoo的Portage使用一种我们称之为SLO的技术来实现这种并存。一个ebuild为它自身的版本声明了一个确切的SLOT。具有不同SLOT的同一软件的Ebuild可以共存于同一个系统中。例如，上例中那个freetype包就拥有不同的ebuilds，里面分别有 SLOT=“1” 和SLOT=“2\"的标志\n有一些不同的软件包提供了类似的功能。比如metalogd，sysklogd和syslog-ng都是系统日志记录工具。那些依赖于“系统日志记录工具”的程序并不能随便的依赖于其中之一，比如metalogd。因为其他的系统日志工具可能也是很好的选择。好在Portage允许使用虚拟包：每一个系统日志记录工具都可以提供virtual/logger包，因此应用程序们可以设定成仅仅依赖于virtual/syslog即可。\nPortage树中的软件可以存在于不同的分支中。您的系统默认只会接受那些Gentoo认为稳定的软件包。绝大多数新提交的软件会被添加到测试分支里。这意味着在此软件被标示为稳定版前需要进行更多的测试。尽管您可以看到那些软件的ebuilds已经加入Portage数据库，在它们未被加入稳定分支前Portage将不会安装它们。\n有些软件只能在某几个体系结构上使用。或者在其他体系结构中还不能运行，或者仍需要对其进行更多的测试，或者将软件提交到Portage树中的开发者还不能确定这个软件能否运行于其他体系结构。\n每一个Gentoo安装都依附于一个确定的profile，此文件里除了其他信息外还包含了一个正常工作的系统需要的软件包的列表。\n被阻挡的包 Portage关于被阻挡的包的警告(使用 –pretend参数)\n[blocks B ] mail-mta/ssmtp (is blocking mail-mta/postfix-2.2.2-r1) Portage关于被阻挡的包的警告(不使用 –pretend参数)\n!!! Error: the mail-mta/postfix package conflicts with another package. !!! both can't be installed on the same system together. !!! Please use 'emerge --pretend' to determine blockers. Ebuilds文件中包含了特定的字段，里面为Portage提供了此软件的各种依赖关系的信息。总计有两种可能的依赖关系：一种是编译依赖，在 DEPEND 区域进行声明;另一种是“运行时”依赖，在 RDEPEND 区域中进行声明。如果上述两种依赖关系中任何一个明确指明某个实体或者虚拟包（译注：可能已安装和正要安装）与要安装的包不相容的时候，就会阻挡软件的安装。\n虽然Portage的最新版本足够聪明，可以在没有用户干预的情况下解决轻微的问题，但偶尔也需要手动解决此类问题。\n为了使安装得以继续进行，您可以选择不安装这个软件包，或者先将发生冲突的包卸载。例如，在我们给出的这个例子中，您可以选择不安装postfix，或者先卸载ssmtp。\n你也可能会遇到某些特定版本的包被屏蔽的情况，比如","wordCount":"49983","inLanguage":"en","image":"https://sakamotokurome.github.io/Covers/pikrepo.jpg.webp","datePublished":"2022-03-21T15:39:24+08:00","dateModified":"2022-03-21T15:39:24+08:00","author":{"@type":"Person","name":"Sakamoto Kurome"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sakamotokurome.github.io/posts/gentoousage/"},"publisher":{"@type":"Organization","name":"Sakamoto Kurome","logo":{"@type":"ImageObject","url":"https://sakamotokurome.github.io/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://sakamotokurome.github.io/ accesskey=h title="Sakamoto Kurome (Alt + H)">Sakamoto Kurome</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://sakamotokurome.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://sakamotokurome.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://sakamotokurome.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Gentoo Usage</h1><div class=post-meta><span title='2022-03-21 15:39:24 +0800 +0800'>March 21, 2022</span>&nbsp;·&nbsp;100 min&nbsp;·&nbsp;Sakamoto Kurome</div></header><figure class=entry-cover><img loading=lazy src=https://sakamotokurome.github.io/Covers/pikrepo.jpg.webp alt="Gentoo Logo"><p>Gentoo Usage</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#portage%e4%bb%8b%e7%bb%8dhttpswikigentooorgwikihandbookamd64workingportage aria-label=Portage介绍><a href=https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/Portage>Portage介绍</a></a><ul><li><a href=#%e6%ac%a2%e8%bf%8e%e4%bd%bf%e7%94%a8-portage aria-label="欢迎使用 Portage">欢迎使用 Portage</a></li><li><a href=#gentoo-%e8%bd%af%e4%bb%b6%e4%bb%93%e5%ba%93 aria-label="Gentoo 软件仓库">Gentoo 软件仓库</a><ul><li><a href=#ebuild aria-label=Ebuild>Ebuild</a></li><li><a href=#%e6%9b%b4%e6%96%b0-gentoo-%e8%bd%af%e4%bb%b6%e4%bb%93%e5%ba%93 aria-label="更新 Gentoo 软件仓库">更新 Gentoo 软件仓库</a></li></ul></li><li><a href=#%e7%bb%b4%e6%8a%a4%e8%bd%af%e4%bb%b6 aria-label=维护软件>维护软件</a><ul><li><a href=#%e6%90%9c%e7%b4%a2%e8%bd%af%e4%bb%b6 aria-label=搜索软件>搜索软件</a></li><li><a href=#%e5%ae%89%e8%a3%85%e8%bd%af%e4%bb%b6 aria-label=安装软件>安装软件</a></li><li><a href=#%e6%9f%a5%e6%89%be%e5%b7%b2%e5%ae%89%e8%a3%85%e8%bd%af%e4%bb%b6%e7%9a%84%e6%96%87%e6%a1%a3 aria-label=查找已安装软件的文档>查找已安装软件的文档</a></li><li><a href=#%e5%8d%b8%e8%bd%bd%e8%bd%af%e4%bb%b6 aria-label=卸载软件>卸载软件</a></li><li><a href=#%e9%bb%98%e8%ae%a4%e9%80%89%e9%a1%b9 aria-label=默认选项>默认选项</a></li><li><a href=#understanding-portages-formatted-and-colored-outputhttpwikigentooksiezycplhowto_use_portage_correctlyhtm aria-label="Understanding Portage&amp;rsquo;s Formatted and Colored Output"><strong><a href=http://wikigentoo.ksiezyc.pl/HOWTO_Use_Portage_Correctly.htm>Understanding Portage&rsquo;s Formatted and Colored Output</a></strong></a></li></ul></li><li><a href=#%e6%9b%b4%e6%96%b0%e7%b3%bb%e7%bb%9f aria-label=更新系统>更新系统</a><ul><li><a href=#%e5%85%b3%e4%ba%8e%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e7%9a%84%e6%9b%b4%e6%96%b0 aria-label=关于配置文件的更新>关于配置文件的更新</a></li><li><a href=#%e6%94%b9%e5%8f%98%e6%a1%8c%e9%9d%a2%e7%8e%af%e5%a2%83httpslitterhougelangleylifeblog20210609gentoo-maintain-02-change-profile aria-label="改变桌面环境/ Change Profile"><a href=https://litterhougelangley.life/blog/2021/06/09/gentoo-maintain-02/>改变桌面环境</a>/ Change Profile</a></li></ul></li><li><a href=#licenses aria-label=Licenses>Licenses</a></li><li><a href=#masking--unmasking-packages aria-label="Masking &amp;amp; Unmasking packages">Masking & Unmasking packages</a><ul><li><a href=#%e5%b1%8f%e8%94%bd%e7%89%b9%e5%ae%9a%e7%9a%84%e5%8c%85%e7%89%88%e6%9c%ac aria-label=屏蔽特定的包版本>屏蔽特定的包版本</a></li><li><a href=#%e4%bb%8e-ebuild-%e5%ad%98%e5%82%a8%e5%ba%93%e4%b8%ad%e5%b1%8f%e8%94%bd%e5%8c%85 aria-label="从 ebuild 存储库中屏蔽包">从 ebuild 存储库中屏蔽包</a></li></ul></li><li><a href=#accept_keywordshttpswikigentooorgwikiaccept_keywordszh-cn aria-label=ACCEPT_KEYWORDS><a href=https://wiki.gentoo.org/wiki/ACCEPT_KEYWORDS/zh-cn>ACCEPT_KEYWORDS</a></a><ul><li><a href=#%e5%8f%98%e9%87%8f%e5%9c%a8%e5%93%aa%e9%87%8c%e8%ae%be%e7%bd%ae aria-label=变量在哪里设置？>变量在哪里设置？</a></li><li><a href=#%e7%a8%b3%e5%ae%9a%e4%b8%8e%e4%b8%8d%e7%a8%b3%e5%ae%9a%e7%9a%84-keywords aria-label="稳定与不稳定的 keywords">稳定与不稳定的 keywords</a></li></ul></li><li><a href=#%e5%bd%93portage%e6%8a%a5%e9%94%99%e7%9a%84%e6%97%b6%e5%80%99 aria-label=当Portage报错的时候>当Portage报错的时候</a><ul><li><a href=#%e7%ae%80%e4%bb%8b aria-label=简介>简介</a></li><li><a href=#%e8%a2%ab%e9%98%bb%e6%8c%a1%e7%9a%84%e5%8c%85 aria-label=被阻挡的包>被阻挡的包</a></li><li><a href=#%e8%a2%ab%e5%b1%8f%e8%94%bd%e7%9a%84%e5%8c%85 aria-label=被屏蔽的包>被屏蔽的包</a></li><li><a href=#use%e5%bf%85%e8%a6%81%e7%9a%84%e6%9b%b4%e6%94%b9 aria-label=USE必要的更改>USE必要的更改</a></li><li><a href=#%e7%bc%ba%e5%a4%b1%e4%be%9d%e8%b5%96 aria-label=缺失依赖>缺失依赖</a></li><li><a href=#%e6%84%8f%e6%8c%87%e4%b8%8d%e6%98%8e%e7%9a%84%e8%bd%af%e4%bb%b6%e5%8c%85 aria-label=意指不明的软件包>意指不明的软件包</a></li><li><a href=#%e5%be%aa%e7%8e%af%e4%be%9d%e8%b5%96 aria-label=循环依赖>循环依赖</a></li><li><a href=#%e4%b8%8b%e8%bd%bd%e5%a4%b1%e8%b4%a5 aria-label=下载失败>下载失败</a></li><li><a href=#%e7%b3%bb%e7%bb%9fprofile%e4%bf%9d%e6%8a%a4 aria-label=系统Profile保护>系统Profile保护</a></li><li><a href=#digest%e9%aa%8c%e8%af%81%e5%a4%b1%e8%b4%a5 aria-label=Digest验证失败>Digest验证失败</a></li></ul></li><li><a href=#%e5%85%b6%e4%bb%96%e5%b7%a5%e5%85%b7 aria-label=其他工具>其他工具</a><ul><li><a href=#app-portageeixhttpspackagesgentooorgpackagesapp-portageeix aria-label=app-portage/eix><a href=https://packages.gentoo.org/packages/app-portage/eix>app-portage/eix</a></a></li><li><a href=#app-portagegentoolkithttpspackagesgentooorgpackagesapp-portagegentoolkit aria-label=app-portage/gentoolkit><a href=https://packages.gentoo.org/packages/app-portage/gentoolkit>app-portage/gentoolkit</a></a><ul><li><a href=#ecleanhttpswikigentooorgwikiecleanzh-cn aria-label=eclean><a href=https://wiki.gentoo.org/wiki/Eclean/zh-cn>eclean</a></a></li></ul></li><li><a href=#app-portageportage-utilshttpspackagesgentooorgpackagesapp-portageportage-utils aria-label=app-portage/portage-utils><a href=https://packages.gentoo.org/packages/app-portage/portage-utils>app-portage/portage-utils</a></a></li><li><a href=#app-portagepflhttpspackagesgentooorgpackagesapp-portagepfl aria-label=app-portage/pfl><a href=https://packages.gentoo.org/packages/app-portage/pfl>app-portage/pfl</a></a></li><li><a href=#%e5%a4%9a%e7%89%88%e6%9c%ac%e7%ae%a1%e7%90%86 aria-label=多版本管理>多版本管理</a></li></ul></li><li><a href=#%e4%b8%ba-portage-%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8%e8%ae%be%e7%bd%ae%e4%bb%a3%e7%90%86httpsbitbilinetset-proxy-for-gentoo-portagehtml aria-label="为 Portage 包管理器设置代理"><a href=https://bitbili.net/set-proxy-for-gentoo-portage.html>为 Portage 包管理器设置代理</a></a><ul><li><a href=#gentoo-%e7%9a%84%e9%bb%98%e8%ae%a4%e8%ae%be%e7%bd%ae aria-label="Gentoo 的默认设置">Gentoo 的默认设置</a></li><li><a href=#%e6%8c%81%e4%b9%85%e6%80%a7%e5%9c%b0%e4%bf%ae%e6%94%b9%e4%bb%a3%e7%90%86 aria-label=持久性地修改代理>持久性地修改代理</a><ul><li><a href=#%e9%80%9a%e7%94%a8%e9%85%8d%e7%bd%ae aria-label=通用配置>通用配置</a></li><li><a href=#%e5%8d%95%e7%8b%ac%e9%85%8d%e7%bd%ae-git-%e6%8a%93%e5%8f%96 aria-label="单独配置 git 抓取">单独配置 git 抓取</a></li></ul></li><li><a href=#%e4%b8%b4%e6%97%b6%e6%b7%bb%e5%8a%a0%e4%bb%a3%e7%90%86 aria-label=临时添加代理>临时添加代理</a><ul><li><a href=#%e6%8e%a8%e8%8d%90proxychains aria-label=推荐：ProxyChains>推荐：ProxyChains</a></li><li><a href=#%e4%b8%b4%e6%97%b6%e6%8c%87%e5%ae%9a%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f aria-label=临时指定环境变量>临时指定环境变量</a></li></ul></li></ul></li><li><a href=#projectportagesynchttpswikigentooorgwikiprojectportagesync aria-label=Project:Portage/Sync><a href=https://wiki.gentoo.org/wiki/Project:Portage/Sync>Project:Portage/Sync</a></a><ul><li><a href=#general-help aria-label="General help">General help</a><ul><li><a href=#migration aria-label=Migration>Migration</a></li><li><a href=#operation aria-label=Operation>Operation</a></li><li><a href=#examples aria-label=Examples>Examples</a></li></ul></li></ul></li></ul></li><li><a href=#use%e6%a0%87%e8%ae%b0httpswikigentooorgwikihandbookamd64workinguse aria-label=USE标记><a href=https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/USE>USE标记</a></a><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%afuse%e6%a0%87%e5%bf%97 aria-label=什么是USE标志>什么是USE标志</a><ul><li><a href=#use%e6%a0%87%e5%bf%97%e7%9a%84%e6%8c%87%e5%af%bc%e6%80%9d%e6%83%b3 aria-label=USE标志的指导思想>USE标志的指导思想</a></li><li><a href=#use%e6%a0%87%e5%bf%97%e7%9a%84%e8%ae%be%e5%ae%9a aria-label=USE标志的设定>USE标志的设定</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8use%e6%a0%87%e5%bf%97 aria-label=使用USE标志>使用USE标志</a><ul><li><a href=#%e5%a3%b0%e6%98%8e%e6%b0%b8%e4%b9%85use%e6%a0%87%e5%bf%97 aria-label=声明永久USE标志>声明永久USE标志</a></li><li><a href=#%e4%b8%ba%e5%8d%95%e4%b8%aa%e5%8c%85%e5%a3%b0%e6%98%8euse%e6%a0%87%e5%bf%97 aria-label=为单个包声明USE标志>为单个包声明USE标志</a></li><li><a href=#%e5%a3%b0%e6%98%8e%e4%b8%b4%e6%97%b6use%e6%a0%87%e5%bf%97 aria-label=声明临时USE标志>声明临时USE标志</a></li><li><a href=#%e4%bc%98%e5%85%88%e7%ba%a7 aria-label=优先级>优先级</a></li><li><a href=#%e5%9c%a8%e6%95%b4%e4%b8%aa%e7%b3%bb%e7%bb%9f%e4%b8%8a%e5%ba%94%e7%94%a8%e6%96%b0%e7%9a%84use%e6%a0%87%e5%bf%97 aria-label=在整个系统上应用新的USE标志>在整个系统上应用新的USE标志</a></li></ul></li><li><a href=#%e8%bd%af%e4%bb%b6%e5%8c%85%e7%89%b9%e6%9c%89%e7%9a%84use%e6%a0%87%e5%bf%97 aria-label=软件包特有的USE标志>软件包特有的USE标志</a></li><li><a href=#%e6%bb%a1%e8%b6%b3-required_use aria-label="满足 REQUIRED_USE">满足 REQUIRED_USE</a></li></ul></li><li><a href=#portage%e5%8a%9f%e8%83%bd%e7%89%b9%e6%80%a7httpswikigentooorgwikihandbookamd64workingfeatures aria-label=Portage功能特性><a href=https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/Features>Portage功能特性</a></a><ul><li><a href=#portage%e7%89%b9%e6%80%a7 aria-label=Portage特性>Portage特性</a></li><li><a href=#%e5%88%86%e5%b8%83%e5%bc%8f%e7%bc%96%e8%af%91 aria-label=分布式编译>分布式编译</a><ul><li><a href=#%e4%bd%bf%e7%94%a8distcc aria-label=使用distcc>使用distcc</a></li><li><a href=#%e5%ae%89%e8%a3%85-distcc aria-label="安装 distcc">安装 distcc</a></li><li><a href=#%e6%bf%80%e6%b4%bbportage%e7%9a%84distcc%e6%94%af%e6%8c%81 aria-label=激活Portage的distcc支持>激活Portage的distcc支持</a></li></ul></li><li><a href=#%e7%bc%93%e5%86%b2%e7%bc%96%e8%af%91%e7%bb%93%e6%9e%9c aria-label=缓冲编译结果>缓冲编译结果</a><ul><li><a href=#%e5%85%b3%e4%ba%8eccache aria-label=关于ccache>关于ccache</a></li><li><a href=#%e5%ae%89%e8%a3%85-ccache aria-label="安装 ccache">安装 ccache</a></li><li><a href=#%e6%bf%80%e6%b4%bbportage-ccache-%e6%94%af%e6%8c%81 aria-label="激活Portage ccache 支持">激活Portage ccache 支持</a></li><li><a href=#%e9%9d%9eportage%e7%bc%96%e8%af%91%e4%b8%ad%e4%bd%bf%e7%94%a8ccache aria-label=非Portage编译中使用ccache>非Portage编译中使用ccache</a></li></ul></li><li><a href=#%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%8c%85%e6%94%af%e6%8c%81 aria-label=二进制包支持>二进制包支持</a><ul><li><a href=#%e5%88%9b%e5%bb%ba%e9%a2%84%e7%bc%96%e8%af%91%e5%8c%85 aria-label=创建预编译包>创建预编译包</a></li><li><a href=#%e5%ae%89%e8%a3%85%e9%a2%84%e7%bc%96%e8%af%91%e5%8c%85 aria-label=安装预编译包>安装预编译包</a></li><li><a href=#%e5%b0%86%e9%a2%84%e6%9e%84%e5%bb%ba%e7%9a%84%e8%bd%af%e4%bb%b6%e5%8c%85%e5%88%86%e5%8f%91%e7%bb%99%e4%bb%96%e4%ba%ba aria-label=将预构建的软件包分发给他人>将预构建的软件包分发给他人</a></li></ul></li><li><a href=#%e4%b8%8b%e8%bd%bd%e6%96%87%e4%bb%b6 aria-label=下载文件>下载文件</a><ul><li><a href=#%e5%b9%b6%e8%a1%8c%e4%b8%8b%e8%bd%bd aria-label=并行下载>并行下载</a></li><li><a href=#%e9%aa%8c%e8%af%81%e6%ba%90%e6%96%87%e4%bb%b6 aria-label=验证源文件>验证源文件</a></li></ul></li></ul></li><li><a href=#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8fhttpswikigentooorgwikihandbookamd64workingenvvar aria-label=环境变量><a href=https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/EnvVar>环境变量</a></a><ul><li><a href=#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f aria-label=环境变量>环境变量</a><ul><li><a href=#%e7%ae%80%e4%bb%8b-1 aria-label=简介>简介</a></li><li><a href=#%e9%87%8d%e8%a6%81%e7%9a%84%e4%be%8b%e5%ad%90 aria-label=重要的例子>重要的例子</a></li></ul></li><li><a href=#%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f%e7%9a%84%e5%ae%9a%e4%b9%89 aria-label=全局变量的定义>全局变量的定义</a><ul><li><a href=#envd%e7%9b%ae%e5%bd%95 aria-label=env.d目录>env.d目录</a></li><li><a href=#env-update aria-label=env-update>env-update</a></li></ul></li><li><a href=#%e6%9c%ac%e5%9c%b0%e5%8f%98%e9%87%8f%e7%9a%84%e5%ae%9a%e4%b9%89 aria-label=本地变量的定义>本地变量的定义</a><ul><li><a href=#%e7%89%b9%e5%ae%9a%e7%94%a8%e6%88%b7 aria-label=特定用户>特定用户</a></li><li><a href=#%e7%89%b9%e5%ae%9a%e4%bc%9a%e8%af%9d aria-label=特定会话>特定会话</a></li></ul></li></ul></li><li><a href=#ebuild-1 aria-label=ebuild>ebuild</a><ul><li><a href=#gentoo-development-guide-chinesehttpsblogsoymilkfungentoo-development-guide-chinese aria-label="Gentoo Development Guide Chinese"><a href=https://blog.soymilk.fun/Gentoo-Development-Guide-Chinese/>Gentoo Development Guide Chinese</a></a></li><li><a href=#ebuild-%e7%bc%96%e5%86%99%e5%9f%ba%e6%9c%ac%e6%8c%87%e5%8d%97httpswikigentooorgwikibasic_guide_to_write_gentoo_ebuilds aria-label="Ebuild 编写基本指南"><a href=https://wiki.gentoo.org/wiki/Basic_guide_to_write_Gentoo_Ebuilds>Ebuild 编写基本指南</a></a><ul><li><a href=#%e5%a6%82%e4%bd%95%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa-ebuild aria-label="如何创建一个 ebuild">如何创建一个 ebuild</a></li><li><a href=#%e7%bb%99%e5%ae%9a%e6%ba%90%e5%8e%8b%e7%bc%a9%e5%8c%85%e7%a4%ba%e4%be%8b aria-label=给定源压缩包示例>给定源压缩包示例</a></li><li><a href=#%e6%89%93%e8%a1%a5%e4%b8%81 aria-label=打补丁>打补丁</a></li></ul></li><li><a href=#%e5%88%9d%e6%8e%a2-ebuildhttpssegmentfaultcoma1190000003819421 aria-label="初探 ebuild"><a href=https://segmentfault.com/a/1190000003819421>初探 ebuild</a></a><ul><li><a href=#ebuild-%e5%9c%a8%e5%93%aa%e9%87%8c aria-label="ebuild 在哪里？">ebuild 在哪里？</a></li><li><a href=#%e5%bb%ba%e7%ab%8b%e8%87%aa%e5%b7%b1%e7%9a%84-overlay aria-label="建立自己的 Overlay">建立自己的 Overlay</a></li><li><a href=#hello-world aria-label="Hello World!">Hello World!</a></li><li><a href=#emerge-%e4%b8%8e-ebuild-%e6%9c%89%e4%bb%80%e4%b9%88%e8%81%94%e7%b3%bb aria-label="emerge 与 ebuild 有什么联系？">emerge 与 ebuild 有什么联系？</a></li></ul></li><li><a href=#slothttpswikitankywoocomlinuxgentoohtmlslot aria-label=SLOT><a href=https://wiki.tankywoo.com/linux/gentoo.html#slot>SLOT</a></a><ul><li><a href=#%e7%9c%9f%e5%ae%9e%e7%9a%84-hello-world aria-label="真实的 Hello World！">真实的 Hello World！</a></li></ul></li></ul></li><li><a href=#ebuild-repositoryhttpswikigentooorgwikiebuild_repository aria-label="ebuild repository"><a href=https://wiki.gentoo.org/wiki/Ebuild_repository>ebuild repository</a></a><ul><li><a href=#the-gentoo-ebuild-repository aria-label="The Gentoo ebuild repository">The Gentoo ebuild repository</a></li><li><a href=#repositories-in-general aria-label="Repositories in general">Repositories in general</a><ul><li><a href=#priorities aria-label=Priorities>Priorities</a></li></ul></li><li><a href=#repository-synchronization aria-label="Repository synchronization">Repository synchronization</a></li><li><a href=#repository-management-tools aria-label="Repository management tools">Repository management tools</a><ul><li><a href=#eselect-repository aria-label=eselect-repository>eselect-repository</a></li><li><a href=#layman aria-label=Layman>Layman</a></li></ul></li><li><a href=#usage aria-label=Usage>Usage</a><ul><li><a href=#emerging-a-duplicate-package aria-label="Emerging a duplicate package">Emerging a duplicate package</a></li></ul></li><li><a href=#best-practices aria-label="Best practices">Best practices</a><ul><li><a href=#cache-generation aria-label="Cache generation">Cache generation</a></li><li><a href=#masking-enabled-ebuild-repositories aria-label="Masking enabled ebuild repositories">Masking enabled ebuild repositories</a></li></ul></li></ul></li><li><a href=#gentoo-on-zfshttpswikigentooorgwikiuserali3nxinstalling_gentoo_linux_efistub_on_zfs aria-label="Gentoo on ZFS"><a href=https://wiki.gentoo.org/wiki/User:Ali3nx/Installing_Gentoo_Linux_EFISTUB_On_ZFS>Gentoo on ZFS</a></a><ul><li><a href=#%e5%a4%87%e4%bb%bdhttpswwwyafamoepostbackup-your-gentoo-system aria-label=备份><a href=https://www.yafa.moe/post/backup-your-gentoo-system/>备份</a></a><ul><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e7%a1%ac%e7%9b%98 aria-label=初始化硬盘>初始化硬盘</a></li><li><a href=#%e5%88%9b%e5%bb%ba-luks aria-label="创建 LUKS">创建 LUKS</a></li><li><a href=#%e6%89%93%e5%bc%80-luks-%e5%92%8c%e5%88%9b%e5%bb%ba%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f aria-label="打开 LUKS 和创建文件系统">打开 LUKS 和创建文件系统</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e6%8c%82%e8%bd%bd%e7%82%b9%e5%92%8c%e6%8c%82%e8%bd%bd aria-label=创建挂载点和挂载>创建挂载点和挂载</a></li><li><a href=#%e5%a4%87%e4%bb%bd%e7%b3%bb%e7%bb%9f aria-label=备份系统>备份系统</a></li></ul></li><li><a href=#%e8%bf%81%e7%a7%bb%e5%88%b0-zfshttpswwwyafamoepostgentoo-on-zfs aria-label="迁移到 ZFS"><a href=https://www.yafa.moe/post/gentoo-on-zfs/>迁移到 ZFS</a></a><ul><li><a href=#%e5%88%86%e5%8c%ba aria-label=分区>分区</a><ul><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e5%88%86%e5%8c%ba aria-label=初始化分区>初始化分区</a></li><li><a href=#%e5%88%9b%e5%bb%ba-pool aria-label="创建 pool">创建 pool</a></li><li><a href=#%e5%88%9b%e5%bb%ba-datasets aria-label="创建 datasets">创建 datasets</a></li></ul></li><li><a href=#%e5%ae%89%e8%a3%85%e7%b3%bb%e7%bb%9f aria-label=安装系统>安装系统</a></li><li><a href=#chroot aria-label=chroot>chroot</a></li><li><a href=#zfs-%e5%ae%89%e8%a3%85%e5%92%8c%e9%85%8d%e7%bd%ae aria-label="ZFS 安装和配置">ZFS 安装和配置</a></li><li><a href=#bootload-fstab-and-initramfs aria-label="Bootload fstab and Initramfs">Bootload fstab and Initramfs</a><ul><li><a href=#grub aria-label=GRUB>GRUB</a></li><li><a href=#fstab aria-label=fstab>fstab</a></li><li><a href=#initramfs aria-label=initramfs>initramfs</a></li></ul></li><li><a href=#%e9%87%8d%e5%90%af aria-label=重启>重启</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8zfs%e5%a4%87%e4%bb%bdhttpswwwyafamoepostuse-zfs-backup-system aria-label=使用ZFS备份><a href=https://www.yafa.moe/post/use-zfs-backup-system/>使用ZFS备份</a></a><ul><li><a href=#%e5%88%9b%e5%bb%ba%e5%a4%87%e4%bb%bdzfs%e6%b1%a0 aria-label=创建备份ZFS池>创建备份ZFS池</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e5%bf%ab%e7%85%a7 aria-label=创建快照>创建快照</a></li><li><a href=#%e5%8f%91%e9%80%81%e5%bf%ab%e7%85%a7 aria-label=发送快照>发送快照</a></li><li><a href=#%e5%a4%87%e4%bb%bdboot%e5%88%86%e5%8c%ba aria-label=备份/boot分区>备份<code>/boot</code>分区</a></li><li><a href=#%e6%81%a2%e5%a4%8d%e5%bf%ab%e7%85%a7 aria-label=恢复快照>恢复快照</a></li><li><a href=#%e5%ae%9a%e6%9c%9f%e5%a4%87%e4%bb%bd aria-label=定期备份>定期备份</a></li></ul></li><li><a href=#%e9%97%ae%e9%a2%98%e6%8e%92%e6%9f%a5 aria-label=问题排查>问题排查</a><ul><li><a href=#grub-%e6%95%91%e6%8f%b4 aria-label="grub 救援">grub 救援</a></li><li><a href=#%e9%80%9a%e8%bf%87-livecd-%e4%bf%ae%e5%a4%8d aria-label="通过 livecd 修复">通过 livecd 修复</a></li></ul></li></ul></li><li><a href=#lukshttpslinuxcnarticle-9640-1html aria-label=LUKS><a href=https://linux.cn/article-9640-1.html>LUKS</a></a><ul><li><a href=#%e5%86%85%e6%a0%b8%e9%85%8d%e7%bd%ae%e5%8f%af%e9%80%89 aria-label=内核配置（可选）>内核配置（可选）</a></li><li><a href=#%e5%ae%89%e8%a3%85%e8%bd%af%e4%bb%b6-1 aria-label=安装软件>安装软件</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e5%8a%a0%e5%af%86%e5%88%86%e5%8c%ba aria-label=创建加密分区>创建加密分区</a></li><li><a href=#%e5%88%a9%e7%94%a8%e5%af%86%e9%92%a5%e6%96%87%e4%bb%b6%e5%8a%a0%e5%af%86%e5%88%86%e5%8c%ba aria-label=利用密钥文件加密分区>利用密钥文件加密分区</a><ul><li><a href=#%e7%94%9f%e6%88%90%e9%9a%8f%e6%9c%ba%e5%af%86%e9%92%a5%e6%96%87%e4%bb%b6 aria-label=生成随机密钥文件>生成随机密钥文件</a></li><li><a href=#%e6%b7%bb%e5%8a%a0%e5%af%86%e9%92%a5%e6%96%87%e4%bb%b6%e4%bd%9c%e4%b8%ba%e5%af%86%e7%a0%81%e4%b9%8b%e4%b8%80 aria-label=添加密钥文件作为密码之一>添加密钥文件作为密码之一</a></li></ul></li><li><a href=#%e7%a7%bb%e9%99%a4%e8%a7%a3%e5%af%86%e5%af%86%e7%a0%81 aria-label=移除解密密码>移除解密密码</a></li><li><a href=#%e8%a7%a3%e5%af%86%e4%b8%8e%e6%8c%82%e8%bd%bd aria-label=解密与挂载>解密与挂载</a><ul><li><a href=#%e5%af%86%e7%a0%81%e8%a7%a3%e5%af%86 aria-label=密码解密>密码解密</a></li><li><a href=#key-file-%e8%a7%a3%e5%af%86 aria-label="key file 解密">key file 解密</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f aria-label=创建文件系统>创建文件系统</a></li><li><a href=#%e6%8c%82%e8%bd%bd aria-label=挂载>挂载</a></li><li><a href=#%e5%8d%b8%e8%bd%bd%e6%8c%82%e8%bd%bd%e7%82%b9%e5%b9%b6%e5%85%b3%e9%97%ad%e5%8a%a0%e5%af%86%e5%88%86%e5%8c%ba aria-label=卸载挂载点并关闭加密分区>卸载挂载点并关闭加密分区</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li></ul></li><li><a href=#%e5%8f%8c%e6%98%be%e5%8d%a1%e7%ac%94%e8%ae%b0%e6%9c%ac%e7%8b%ac%e6%98%be%e7%9b%b4%e9%80%9ahttpswwwcodeplayerorgbloge58f8ce698bee58da1e7ac94e8aeb0e69cace78bace698bee79bb4e9809ahtml aria-label=双显卡笔记本独显直通><a href=https://www.codeplayer.org/Blog/%E5%8F%8C%E6%98%BE%E5%8D%A1%E7%AC%94%E8%AE%B0%E6%9C%AC%E7%8B%AC%E6%98%BE%E7%9B%B4%E9%80%9A.html>双显卡笔记本独显直通</a></a><ul><li><a href=#%e4%bb%8b%e7%bb%8d aria-label=介绍>介绍</a></li><li><a href=#muxed aria-label=MUXed>MUXed</a></li><li><a href=#%e5%90%af%e7%94%a8-iommu-%e5%92%8c-vfio-%e6%a8%a1%e5%9d%97 aria-label="启用 IOMMU 和 vfio 模块">启用 IOMMU 和 vfio 模块</a><ul><li><a href=#iommu aria-label=IOMMU>IOMMU</a></li><li><a href=#vfio aria-label=vfio>vfio</a></li></ul></li><li><a href=#%e9%9a%94%e7%a6%bb-gpu aria-label="隔离 GPU">隔离 GPU</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba aria-label=创建虚拟机>创建虚拟机</a></li><li><a href=#%e9%85%8d%e7%bd%ae%e5%92%8c%e4%bc%98%e5%8c%96-remotefx aria-label="配置和优化 RemoteFX">配置和优化 RemoteFX</a><ul><li><a href=#%e9%85%8d%e7%bd%ae-remotefx aria-label="配置 RemoteFX">配置 RemoteFX</a></li><li><a href=#%e8%a7%a3%e9%99%a4-30-ish-fps-%e9%99%90%e5%88%b6 aria-label="解除 30-ish fps 限制">解除 30-ish fps 限制</a></li></ul></li><li><a href=#%e6%98%be%e5%8d%a1%e7%9b%b4%e9%80%9a aria-label=显卡直通>显卡直通</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e7%bd%91%e6%a1%a5 aria-label=创建网桥>创建网桥</a></li><li><a href=#%e8%bf%9c%e7%a8%8b%e8%bf%9e%e6%8e%a5 aria-label=远程连接>远程连接</a><ul><li><a href=#rdp aria-label=RDP>RDP</a></li><li><a href=#looking-glass aria-label="Looking glass">Looking glass</a><ul><li><a href=#%e5%ae%89%e8%a3%85-client aria-label="安装 client">安装 client</a></li><li><a href=#%e8%ae%a1%e7%ae%97%e5%86%85%e5%ad%98%e5%a4%a7%e5%b0%8f aria-label=计算内存大小>计算内存大小</a></li><li><a href=#%e9%85%8d%e7%bd%ae-libvirt aria-label="配置 libvirt">配置 libvirt</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e5%85%b1%e4%ba%ab%e5%86%85%e5%ad%98%e6%96%87%e4%bb%b6 aria-label=创建共享内存文件>创建共享内存文件</a></li><li><a href=#%e5%ae%89%e8%a3%85-host aria-label="安装 host">安装 host</a></li><li><a href=#%e9%85%8d%e7%bd%ae-client aria-label="配置 client">配置 client</a></li><li><a href=#%e9%85%8d%e7%bd%ae-scream aria-label="配置 Scream">配置 Scream</a></li></ul></li><li><a href=#steam-%e8%bf%9c%e7%a8%8b%e7%95%85%e7%8e%a9%e6%b5%81%e5%bc%8f%e4%bc%a0%e8%be%93 aria-label="steam 远程畅玩（流式传输）">steam 远程畅玩（流式传输）</a></li></ul></li><li><a href=#benchmark aria-label=benchmark>benchmark</a></li><li><a href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5 aria-label=参考链接>参考链接</a></li><li><a href=#%e9%99%84%e5%bd%95xml-%e9%85%8d%e7%bd%ae aria-label="附录：XML 配置">附录：XML 配置</a></li></ul></li><li><a href=#apps aria-label=Apps>Apps</a><ul><li><a href=#%e4%b8%ad%e6%96%87%e5%ad%97%e4%bd%93httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle4b8ade69687e5ad97e4bd93 aria-label=中文字体><a href=https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93>中文字体</a></a><ul><li><a href=#%e6%94%b9%e5%96%84%e5%ad%97%e4%bd%93%e6%b8%b2%e6%9f%93%e6%95%88%e6%9e%9chttpszhuanlanzhihucomp343934880 aria-label=改善字体渲染效果><a href=https://zhuanlan.zhihu.com/p/343934880>改善字体渲染效果</a></a></li></ul></li><li><a href=#%e8%be%93%e5%85%a5%e6%b3%95httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle8be93e585a5e6b395 aria-label=输入法><a href=https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E8%BE%93%E5%85%A5%E6%B3%95>输入法</a></a><ul><li><a href=#%e5%ae%98%e6%96%b9%e4%bb%93%e5%ba%93-fcitx4 aria-label="官方仓库 fcitx4">官方仓库 fcitx4</a></li><li><a href=#%e9%a2%9d%e5%a4%96%e4%bb%93%e5%ba%93-fcitx5 aria-label="额外仓库 fcitx5">额外仓库 fcitx5</a><ul><li><a href=#%e6%8b%a5%e6%8a%b1fcitx5httpsblogcoelacanthusmoepoststechwelcome-to-fcitx5 aria-label=拥抱Fcitx5><a href=https://blog.coelacanthus.moe/posts/tech/welcome-to-fcitx5/>拥抱Fcitx5</a></a></li><li><a href=#fcitx5%e7%9a%ae%e8%82%a4%e5%88%b6%e4%bd%9chttpsbbsdeepinorgphonezhpost223810 aria-label=fcitx5皮肤制作><a href=https://bbs.deepin.org/phone/zh/post/223810>fcitx5皮肤制作</a></a></li><li><a href=#fcitx5rime%e7%9a%84%e7%95%85%e5%bf%ab%e4%bd%93%e9%aa%8chttpszhuanlanzhihucomp287774005 aria-label=fcitx(5)+rime的畅快体验><a href=https://zhuanlan.zhihu.com/p/287774005>fcitx(5)+rime的畅快体验</a></a></li></ul></li><li><a href=#%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%aehttpswikiarchlinuxorgtitlefcitxset_environment_variables_for_im_modules aria-label=环境配置><a href=https://wiki.archlinux.org/title/fcitx#Set_environment_variables_for_IM_modules>环境配置</a></a></li><li><a href=#rimehttpszhuanlanzhihucomp114296129 aria-label=Rime><a href=https://zhuanlan.zhihu.com/p/114296129>Rime</a></a></li></ul></li><li><a href=#kde-system-settings aria-label="KDE System Settings">KDE System Settings</a></li><li><a href=#bluetoothhttpswikigentooorgwikibluetooth aria-label=Bluetooth><a href=https://wiki.gentoo.org/wiki/Bluetooth>Bluetooth</a></a></li><li><a href=#%e9%a6%96%e9%80%89%e7%bc%96%e8%be%91%e5%99%a8 aria-label=首选编辑器>首选编辑器</a></li><li><a href=#mutt aria-label=mutt>mutt</a></li><li><a href=#mpv aria-label=mpv>mpv</a></li><li><a href=#spotify aria-label=spotify>spotify</a></li><li><a href=#youtube-dl aria-label=youtube-dl>youtube-dl</a></li><li><a href=#aria2 aria-label=aria2>aria2</a></li><li><a href=#typora aria-label=Typora>Typora</a></li><li><a href=#zsh aria-label=zsh>zsh</a></li><li><a href=#clash aria-label=Clash>Clash</a></li><li><a href=#browsers aria-label=Browsers>Browsers</a></li><li><a href=#kio-extrashttpswikigentooorgwikimtp aria-label=kio-extras><a href=https://wiki.gentoo.org/wiki/MTP>kio-extras</a></a></li><li><a href=#gwenview aria-label=Gwenview>Gwenview</a></li><li><a href=#okular aria-label=Okular>Okular</a></li><li><a href=#ktimer aria-label=KTimer>KTimer</a></li><li><a href=#kclock aria-label=KClock>KClock</a></li><li><a href=#rsibreakhttpsuserbasekdeorgrsibreakzh-cn aria-label=RSIBreak><a href=https://userbase.kde.org/RSIBreak/zh-cn>RSIBreak</a></a></li><li><a href=#libreoffice aria-label=LibreOffice>LibreOffice</a></li><li><a href=#flameshot aria-label=Flameshot>Flameshot</a><ul><li><a href=#spectacle aria-label=Spectacle>Spectacle</a></li></ul></li><li><a href=#keepassxchttpskeepassxcorg aria-label=KeePassXC><a href=https://keepassxc.org/>KeePassXC</a></a></li><li><a href=#ppsspp aria-label=PPSSPP>PPSSPP</a></li><li><a href=#papirus-icon-themehttpsgithubcompapirusdevelopmentteampapirus-icon-theme aria-label=papirus-icon-theme><a href=https://github.com/PapirusDevelopmentTeam/papirus-icon-theme>papirus-icon-theme</a></a></li><li><a href=#vulkanhttpswikigentooorgwikivulkan aria-label=Vulkan><a href=https://wiki.gentoo.org/wiki/Vulkan>Vulkan</a></a></li><li><a href=#tree aria-label=tree>tree</a></li><li><a href=#qemu aria-label=qemu>qemu</a></li><li><a href=#dockerhttpswikigentooorgwikidocker aria-label=Docker><a href=https://wiki.gentoo.org/wiki/Docker>Docker</a></a></li><li><a href=#lsusbhttpswikigentooorgwikiusbutils aria-label=lsusb><a href=https://wiki.gentoo.org/wiki/Usbutils>lsusb</a></a></li><li><a href=#p7ziphttpswikigentooorgwikip7zip aria-label=p7zip><a href=https://wiki.gentoo.org/wiki/P7zip>p7zip</a></a><ul><li><a href=#ziphttpswwwtecmintcomunzip-extract-zip-files-to-specific-directory-in-linux aria-label=zip><a href=https://www.tecmint.com/unzip-extract-zip-files-to-specific-directory-in-linux/>zip</a></a></li><li><a href=#arkhttpsappskdeorgark aria-label=Ark><a href=https://apps.kde.org/ark/>Ark</a></a></li></ul></li><li><a href=#adb-and-fastboothttpswikigentooorgwikiandroidadb aria-label="ADB and Fastboot"><a href=https://wiki.gentoo.org/wiki/Android/adb>ADB and Fastboot</a></a><ul><li><a href=#file-transfer aria-label="File transfer">File transfer</a></li></ul></li><li><a href=#flatpakhttpsflatpakorgsetupgentoo aria-label=Flatpak><a href=https://flatpak.org/setup/Gentoo>Flatpak</a></a></li><li><a href=#neofetchhttpszhuanlanzhihucomp69777438 aria-label=neofetch><a href=https://zhuanlan.zhihu.com/p/69777438>neofetch</a></a><ul><li><a href=#%e4%bd%bf%e7%94%a8%e8%87%aa%e5%ae%9a%e4%b9%89%e5%9b%be%e5%83%8f aria-label=使用自定义图像>使用自定义图像</a></li><li><a href=#%e9%85%8d%e7%bd%ae-neofetch aria-label="配置 Neofetch">配置 Neofetch</a></li></ul></li><li><a href=#flaggie aria-label=flaggie>flaggie</a></li><li><a href=#crossover aria-label=Crossover>Crossover</a></li><li><a href=#bottles aria-label=Bottles>Bottles</a></li><li><a href=#deja-dup aria-label=deja-dup>deja-dup</a></li></ul></li><li><a href=#dotfileshttpsdotfilesgithubio aria-label=dotfiles><a href=https://dotfiles.github.io/>dotfiles</a></a><ul><li><a href=#general-purpose-dotfiles-utilities aria-label="General-purpose dotfiles utilities">General-purpose dotfiles utilities</a></li><li><a href=#%e4%bd%bf%e7%94%a8-gnu-stow-%e7%ae%a1%e7%90%86%e4%bd%a0%e7%9a%84%e9%bb%9e%e6%96%87%e4%bb%b6httpfarseerfcmeusing-gnu-stow-to-manage-your-dotfileshtml aria-label="使用 GNU stow 管理你的點文件"><a href=http://farseerfc.me/using-gnu-stow-to-manage-your-dotfiles.html#>使用 GNU stow 管理你的點文件</a></a></li><li><a href=#chezmoihttpslinuxcnarticle-12109-1html aria-label=Chezmoi><a href=https://linux.cn/article-12109-1.html>Chezmoi</a></a><ul><li><a href=#%e7%82%b9%e6%96%87%e4%bb%b6%e7%ae%a1%e7%90%86%e7%9a%84%e5%8e%86%e5%8f%b2 aria-label=点文件管理的历史>点文件管理的历史</a><ul><li><a href=#%e5%ae%89%e8%a3%85%e9%97%ae%e9%a2%98 aria-label=安装问题>安装问题</a></li><li><a href=#%e6%9c%ba%e5%af%86%e4%bf%a1%e6%81%af%e9%97%ae%e9%a2%98 aria-label=机密信息问题>机密信息问题</a></li><li><a href=#%e5%a4%9a%e8%ae%be%e5%a4%87%e9%85%8d%e7%bd%ae%e9%97%ae%e9%a2%98 aria-label=多设备配置问题>多设备配置问题</a></li></ul></li><li><a href=#chezmoi-%e6%98%af%e5%a6%82%e4%bd%95%e5%b9%b2%e7%9a%84 aria-label="Chezmoi 是如何干的">Chezmoi 是如何干的</a><ul><li><a href=#chezmoi-%e5%85%a5%e9%97%a8 aria-label="Chezmoi 入门">Chezmoi 入门</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e5%8f%98%e9%87%8f%e5%92%8c%e6%a8%a1%e6%9d%bf aria-label=使用变量和模板>使用变量和模板</a></li><li><a href=#%e8%ae%a9%e6%9c%ba%e5%af%86%e4%bf%a1%e6%81%af%e4%bf%9d%e6%8c%81%e6%9c%ba%e5%af%86 aria-label=让机密信息保持机密>让机密信息保持机密</a></li></ul></li></ul></li></ul></li><li><a href=#tips aria-label=Tips>Tips</a><ul><li><a href=#petrusz aria-label=Petrus.Z>Petrus.Z</a><ul><li><a href=#portagehttpswwwcodeplayerorgwikigentooportagehtml aria-label=Portage><a href=https://www.codeplayer.org/Wiki/Gentoo/Portage.html>Portage</a></a><ul><li><a href=#command aria-label=command>command</a></li><li><a href=#apply-patches aria-label="apply patches">apply patches</a></li></ul></li><li><a href=#kernelhttpswwwcodeplayerorgwikigentookernelhtml aria-label=Kernel><a href=https://www.codeplayer.org/Wiki/Gentoo/kernel.html>Kernel</a></a></li><li><a href=#upgradegentoohttpswwwcodeplayerorgwikigentooupgradegentoohtml aria-label=UpgradeGentoo><a href=https://www.codeplayer.org/Wiki/Gentoo/UpgradeGentoo.html>UpgradeGentoo</a></a><ul><li><a href=#how-to-upgrade-gentoo aria-label="How to upgrade gentoo">How to upgrade gentoo</a></li><li><a href=#how-to-upgrade-python-local-package aria-label="How to upgrade python local package">How to upgrade python local package</a></li></ul></li></ul></li><li><a href=#freeing-disk-spacehttpswikigentooorgwikiknowledge_basefreeing_disk_space aria-label="Freeing disk space"><a href=https://wiki.gentoo.org/wiki/Knowledge_Base:Freeing_disk_space>Freeing disk space</a></a></li><li><a href=#how-to-change--set-the-default-crontab-editorhttpswwwservernoobscomchange-set-the-default-crontab-editortextif20you20want20to20change20your20default20crontabin20general2c20you20use20this20command3a20export20editor3d2fusr2fbin2fnano aria-label="How to Change &amp;amp; Set the Default crontab Editor"><a href="https://www.servernoobs.com/change-set-the-default-crontab-editor/#:~:text=If%20you%20want%20to%20change%20your%20default%20crontab,in%20general%2C%20you%20use%20this%20command%3A%20export%20EDITOR%3D%2Fusr%2Fbin%2Fnano.">How to Change & Set the Default crontab Editor</a></a></li><li><a href=#how-to-update-dolphin-file-manager-in-real-timehttpsaskubuntucomquestions311303how-to-update-dolphin-file-manager-in-real-time aria-label="How to update dolphin file manager in real time"><a href=https://askubuntu.com/questions/311303/how-to-update-dolphin-file-manager-in-real-time>How to update dolphin file manager in real time</a></a></li><li><a href=#how-do-i-convert-a-png-into-a-icohttpssuperusercomquestions227736how-do-i-convert-a-png-into-a-ico1012535 aria-label="How do I convert a .PNG into a .ICO?"><a href=https://superuser.com/questions/227736/how-do-i-convert-a-png-into-a-ico/1012535>How do I convert a .PNG into a .ICO?</a></a></li><li><a href=#crop-a-photo-to-fit-a-circle-using-ffmpeghttpsstackoverflowcomquestions63997289can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg aria-label="Crop a photo to fit a circle using ffmpeg"><a href=https://stackoverflow.com/questions/63997289/can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg>Crop a photo to fit a circle using ffmpeg</a></a></li><li><a href=#path-to-kde-picture-of-the-dayhttpsaskubuntucomquestions1197417where-is-bings-picture-of-the-day-stored-on-my-system aria-label="Path to KDE Picture of the Day"><a href=https://askubuntu.com/questions/1197417/where-is-bings-picture-of-the-day-stored-on-my-system>Path to KDE Picture of the Day</a></a></li><li><a href=#baloohttpscommunitykdeorgbaloo aria-label=Baloo><a href=https://community.kde.org/Baloo>Baloo</a></a><ul><li><a href=#baloo-file-extractor-crashes-on-every-boothttpsforumsgentooorgviewtopic-t-1096234-start-0html aria-label="Baloo File Extractor Crashes on every boot"><a href=https://forums.gentoo.org/viewtopic-t-1096234-start-0.html>Baloo File Extractor Crashes on every boot</a></a></li><li><a href=#kde-baloo-%e5%b4%a9%e6%ba%83%e9%97%ae%e9%a2%98%e4%b8%8e%e8%b0%83%e6%95%b4httpsimbearchildcyouarchives202204kde-baloo-crash aria-label="KDE Baloo 崩溃问题与调整"><a href=https://imbearchild.cyou/archives/2022/04/kde-baloo-crash/>KDE Baloo 崩溃问题与调整</a></a></li></ul></li><li><a href=#%e5%86%85%e6%a0%b8%e5%8d%87%e7%ba%a7%e4%b8%80%e8%88%ac%e6%ad%a5%e9%aa%a4httpsblogsoymilkfun20201117linuxgentoogentookernelupdate aria-label=内核升级一般步骤><a href=https://blog.soymilk.fun/2020/11/17/Linux/Gentoo/GentooKernelUpdate/>内核升级一般步骤</a></a><ul><li><a href=#%e5%8d%87%e7%ba%a7%e5%86%85%e6%a0%b8 aria-label=升级内核>升级内核</a></li><li><a href=#configuration aria-label=Configuration>Configuration</a></li><li><a href=#build aria-label=Build>Build</a></li><li><a href=#install aria-label=Install>Install</a></li><li><a href=#bootloader aria-label=BootLoader>BootLoader</a></li><li><a href=#clean aria-label=Clean>Clean</a></li></ul></li></ul></li><li><a href=#questions aria-label=Questions>Questions</a><ul><li><a href=#problem-with-transparencies-and-windowing-ghosting-outhttpsforumgarudalinuxorgtproblem-with-transparencies-and-windowing-ghosting-out9568 aria-label="Problem with transparencies and windowing ghosting out"><a href=https://forum.garudalinux.org/t/problem-with-transparencies-and-windowing-ghosting-out/9568>Problem with transparencies and windowing ghosting out</a></a></li><li><a href=#telegram-not-launching-from-the-browser-xdg-openhttpswwwredditcomrmanjarolinuxcommentsk76cphtelegram_not_launching_from_the_browser_xdgopen aria-label="Telegram not launching from the browser xdg-open"><a href=https://www.reddit.com/r/ManjaroLinux/comments/k76cph/telegram_not_launching_from_the_browser_xdgopen/>Telegram not launching from the browser xdg-open</a></a></li><li><a href=#how-to-reset-kde--display-settings-after-a-move-to-a-new-machinehttpsaskubuntucomquestions299241how-to-reset-kde-display-settings-after-a-move-to-a-new-machine aria-label="How to reset KDE / display settings after a move to a new machine"><a href=https://askubuntu.com/questions/299241/how-to-reset-kde-display-settings-after-a-move-to-a-new-machine>How to reset KDE / display settings after a move to a new machine</a></a></li><li><a href=#how-can-i-reset-my-display-settings-through-terminalhttpsaskubuntucomquestions749333how-can-i-reset-my-display-settings-through-terminal aria-label="How can I reset my display settings through terminal?"><a href=https://askubuntu.com/questions/749333/how-can-i-reset-my-display-settings-through-terminal>How can I reset my display settings through terminal?</a></a></li></ul></li></ul></div></details></div><div class=post-content><h2 id=portage介绍httpswikigentooorgwikihandbookamd64workingportage><a href=https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/Portage>Portage介绍</a><a hidden class=anchor aria-hidden=true href=#portage介绍httpswikigentooorgwikihandbookamd64workingportage>#</a></h2><h3 id=欢迎使用-portage>欢迎使用 Portage<a hidden class=anchor aria-hidden=true href=#欢迎使用-portage>#</a></h3><p>Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具。</p><p>Portage 是用 <a href=https://www.python.org/>Python</a> 和 <a href=https://www.gnu.org/software/bash>Bash</a> 两种语言编写的。因为它们都是脚本语言所以用户可以直接阅读它的代码。</p><p>大多数用户通过 <strong>emerge</strong> 使用 Portage。本章的内容不是复述 emerge 的 man page。要了解 emerge 的所有可用选项，请查阅 emerge 的 man page（<a href=http://www.jinbuguo.com/pkgmanager/gentoo/emerge.html>emerge 中文手册</a>）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># man emerge</span>
</span></span></code></pre></div><h3 id=gentoo-软件仓库>Gentoo 软件仓库<a hidden class=anchor aria-hidden=true href=#gentoo-软件仓库>#</a></h3><p>查询 Portage 的信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --info</span>
</span></span></code></pre></div><h4 id=ebuild>Ebuild<a hidden class=anchor aria-hidden=true href=#ebuild>#</a></h4><p>当 Gentoo 的文档介绍某个软件包的时候，这意味着 Gentoo 的用户们可以在 Gentoo 的软件仓库里找到它。ebuild 是一种包含了所有 Portage 维护软件（比如安装，搜索，查询等等）所需信息的文件，而 Gentoo 的软件仓库是它们的一个集合。这些 ebuild 文件默认储存在 <code>/var/db/repos/gentoo</code>。</p><p>Portage 对于软件的行为都是基于本地的 ebuild。为了能收到新的软件包，安全更新等等，时常更新本地 ebuild 是一件很重要的事情。</p><h4 id=更新-gentoo-软件仓库>更新 Gentoo 软件仓库<a hidden class=anchor aria-hidden=true href=#更新-gentoo-软件仓库>#</a></h4><p>Gentoo 的软件仓库通常使用 <strong>rsync</strong> 进行同步，rsync 是一个快速的文件增量传输工具。要使用它很简单，Portage 的命令行前端 <strong>emerge</strong> 提供了一个调用 <strong>rsync</strong> 的方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --sync</span>
</span></span></code></pre></div><p>有时防火墙会干扰 <strong>rsync</strong> 与镜像的连接。这时，我们可以使用 <strong>emerge-webrsync</strong> 来自动下载和安装 Portage 树的快照版本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge-webrsync</span>
</span></span></code></pre></div><p>使用 <strong>emerge-webrsync</strong> 的另一个好处是可以只安装由 Gentoo release engineering 团队的 GPG 密钥签名过的快照。与此有关的详细信息可以在 <a href=https://wiki.gentoo.org/wiki/Handbook:Parts/Working/Features#Validated_Gentoo_repository_snapshots>fetching validated Gentoo repository snapshots</a> 找到</p><h3 id=维护软件>维护软件<a hidden class=anchor aria-hidden=true href=#维护软件>#</a></h3><h4 id=搜索软件>搜索软件<a hidden class=anchor aria-hidden=true href=#搜索软件>#</a></h4><p>有很多方法可以在 Gentoo 的软件仓库寻找软件。其中之一是使用 <strong>emerge</strong> 本身。在默认情况下 <strong>emerge &ndash;search</strong> 会返回所有符合搜索条件的包名。</p><p>举个例子，找出所有名字里含有 “pdf” 的包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge -s &lt;包名&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge --search pdf</span>
</span></span></code></pre></div><p>如果要根据描述进行搜索，可以使用 <code>--searchdesc</code> （或 <code>-S</code>）选项:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --searchdesc pdf</span>
</span></span></code></pre></div><p>需要注意的是它会输出很多信息。不过由于都有很清楚的标识，我们就不再赘述它们的意思了。</p><h4 id=安装软件>安装软件<a hidden class=anchor aria-hidden=true href=#安装软件>#</a></h4><p>当你找到了软件包的名字，安装它只需要简单得使用 <strong>emerge</strong>。举个例子，如果要安装 gnumeric：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge &lt;包名&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge --ask app-office/gnumeric</span>
</span></span></code></pre></div><p>由于很多软件依赖其它的软件，在安装该软件的同时很可能还会安装它的一些以来。不要担心，Portage 可以很好地处理依赖关系。如果要知道 Portage 会安装什么软件，可以在命令中加入 <code>-p/--pretend</code>选项。举个例子：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --pretend gnumeric</span>
</span></span></code></pre></div><p>在安装软件期间，Portage将从Internet下载必要的源代码（如果需要），并将其默认存储在 <code>/var/cache/distfiles/</code> 中。 之后，它将解压缩，编译和安装包。 要让Portage仅下载源代码而不安装软件，请添加<code>-f/--fetchonly</code>选项到emerge命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --fetchonly gnumeric</span>
</span></span></code></pre></div><p>恢复上一次失败的 emerge</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge -r</span>
</span></span></code></pre></div><p>其它常用的选项有</p><ul><li><p><code>-1/--oneshot</code> 一般用在安装软件包时，不将该包添加到 world 集中</p></li><li><p><code>-O/--nodeps</code> 不计算依赖关系，只操作指定的包（安装时可能会因为依赖不满足而导致安装失败）</p></li><li><p><code>-j/--jobs</code> 设置 Portage 同时执行的最大任务数，如果未设置数量，那么 Portage 不会限制最大的任务数。如果要将该选项添加到默认选项下，那么建议配合 <code>-l/--load-average</code> 使用， <code>-l/--load-average</code> 用于配置 emerge 的负载阈值，当当前负载到达设定值后， emerge 将不再开启新任务，以避免负载过高，这在 CPU 不够强悍或者内存不宽裕的机器上很需要。比如在一个 8 核 16 线程 16G 内存的机器上，可以设置成 <code>-j -l 12</code> ，这样的设定使 portage 的并行任务数不由硬性规定的数目来限制，而是通过动态负载来进行限制。</p></li><li><p><code>--keep-going</code> 它会在安装出错时，跳过安装失败的包，并重新计算依赖后继续安装剩余包</p></li><li><p><code>-n/--noreplace</code> 不重复安装已经安装的包（默认会忽略掉 USE 的改动以及升级的查询，除非对应加上 <code>-D/-U</code> 和 <code>-u</code> 选项）</p></li><li><p><code>-t/--tree</code> 显示给定包的安装依赖树</p></li><li><p><code>--autounmask</code> 类</p><p>这是一组在新装软件包时便于解除安装限制的选项。之前有介绍，在 Portage 安装软件的过程中，可能会因为 USE/License/Keywords 等因素导致无法直接安装，需要配置后再进行，而这组选项可以自动化这个过程。个人建议的相关选项组合为 <code>--autounmask --autounmask-keep-masks --autounmask-write=n</code> ，此组合不会完全自动写入配置到系统下，但是提示了如何配置，方便手动写入，既简化了处理限制的流程，又能保证掌握每次安装包时的改动。</p></li></ul><h4 id=查找已安装软件的文档>查找已安装软件的文档<a hidden class=anchor aria-hidden=true href=#查找已安装软件的文档>#</a></h4><p>许多软件包中包含有自己的文档，有些时候，<code>doc</code>的USE标记决定了软件包中的自带文档是否会被安装。您可以通过 <strong>emerge -vp category/包名</strong>命令来检查是否存在<code>doc</code> USE 标志：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge -vp media-libs/alsa-lib</span>
</span></span><span style=display:flex><span>These are the packages that would be merged, in order:
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>Calculating dependencies... <span style=color:#66d9ef>done</span>!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ebuild   R    <span style=color:#f92672>]</span> media-libs/alsa-lib-1.1.3::gentoo  USE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;python -alisp -debug -doc&#34;</span> ABI_X86<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;(64) -32 (-x32)&#34;</span> PYTHON_TARGETS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;python2_7&#34;</span> <span style=color:#ae81ff>0</span> KiB
</span></span></code></pre></div><p>最好的启用 <code>doc</code> USE 的方式是在 /etc/portage/package.use里对想要启用的包单独启用，这样你就能只获得你想要的软件文档。了解更多信息请阅读 <a href=https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/USE/zh-cn>USE flags chapter</a>。</p><p>当一个软件包安装结束后，它的文档通常会存放在/usr/share/doc/目录下的，以软件包名命名的子目录中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -l /usr/share/doc/alsa-lib-1.1.3
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>3098</span> Mar  <span style=color:#ae81ff>9</span> 15:36 asoundrc.txt.bz2
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>672</span> Mar  <span style=color:#ae81ff>9</span> 15:36 ChangeLog.bz2
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>1083</span> Mar  <span style=color:#ae81ff>9</span> 15:36 NOTES.bz2
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>220</span> Mar  <span style=color:#ae81ff>9</span> 15:36 TODO.bz2
</span></span></code></pre></div><p>列出已安装文档文件的更可靠方法是使用 <strong>equery</strong> 的 <code>--filter</code> 选项。 <strong>equery</strong> 用于查询Portage的数据库，并作为 <a href=https://packages.gentoo.org/packages/app-portage/gentoolkit>app-portage/gentoolkit</a> 包的一部分：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ equery files --filter<span style=color:#f92672>=</span>doc alsa-lib
</span></span><span style=display:flex><span> * Searching <span style=color:#66d9ef>for</span> alsa-lib in media-libs ...
</span></span><span style=display:flex><span> * Contents of media-libs/alsa-lib-1.1.3:
</span></span><span style=display:flex><span>/usr/share/doc/alsa-lib-1.1.3/ChangeLog.bz2
</span></span><span style=display:flex><span>/usr/share/doc/alsa-lib-1.1.3/NOTES.bz2
</span></span><span style=display:flex><span>/usr/share/doc/alsa-lib-1.1.3/TODO.bz2
</span></span><span style=display:flex><span>/usr/share/doc/alsa-lib-1.1.3/asoundrc.txt.bz2
</span></span></code></pre></div><p><code>--filter</code> 选项可与其他规则一起使用，以查看许多其他类型文件的安装位置。可以在 <strong>equery</strong> 的手册中查看其他功能: <strong>man 1 equery</strong>。</p><h4 id=卸载软件>卸载软件<a hidden class=anchor aria-hidden=true href=#卸载软件>#</a></h4><p>当您想把一个软件包从系统中移除的时候，使用 <strong>emerge &ndash;unmerge</strong>命令。命令执行完成后，Portage将会移除此软件包安装到您系统中的所有文件，除了那些在安装软件后您修改过的配置文件。保留这些修改过的配置文件是为了便于您今后再次使用它。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --unmerge gnumeric</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge -C &lt;包名&gt;</span>
</span></span></code></pre></div><p>当您从系统中移除一个软件包时，之前那些为了满足其依赖关系而被自动安装的软件包将会被保留在系统中。要使Portage找到现在可以删除的所有依赖项，可以使用 <code>--depclean</code> 功能。</p><p>自动清理系统下的软件包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --ask --depclean</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge -ac</span>
</span></span></code></pre></div><h4 id=默认选项>默认选项<a hidden class=anchor aria-hidden=true href=#默认选项>#</a></h4><p>emerge 支持配置一组默认选项，用于在每次运行 emerge 时采用。这个储存默认选项的变量名为 <code>EMERGE_DEFAULT_OPTS</code> ，在 <code>/etc/portage/make.conf</code> 文件下设置。</p><p>这里一组比较推荐的默认选项配置为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>EMERGE_DEFAULT_OPTS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;--autounmask --autounmask-keep-masks --autounmask-write=n --keep-going -v -j -l 12&#34;</span>
</span></span></code></pre></div><p>其中的 12 请根据实际情况修改，如果配置了上文的 binhost ，那么对应选项也添加进入。</p><h4 id=understanding-portages-formatted-and-colored-outputhttpwikigentooksiezycplhowto_use_portage_correctlyhtm><strong><a href=http://wikigentoo.ksiezyc.pl/HOWTO_Use_Portage_Correctly.htm>Understanding Portage&rsquo;s Formatted and Colored Output</a></strong><a hidden class=anchor aria-hidden=true href=#understanding-portages-formatted-and-colored-outputhttpwikigentooksiezycplhowto_use_portage_correctlyhtm>#</a></h4><p>Output from portage is compactly formatted to indicate a plethora of information.</p><p><strong>Emerge &ldquo;Pretend&rdquo; Output</strong></p><ul><li>N = new (not yet installed)</li><li>S = new SLOT installation (side-by-side versions)</li><li>U = updating (to another version)</li><li>D = downgrading (best version seems lower)</li><li>R = replacing (re-merging same version)</li><li>F = fetch restricted (must be manually downloaded)</li><li>f = fetch (already downloaded)</li><li>B = blocked by an already installed package</li></ul><p><strong>USE Flags</strong></p><ul><li>An unmarked USE flag is unchanged and enabled.</li><li><strong>-</strong> A dash preceding a USE flag (<strong>yellow</strong>, <strong>green</strong> or <strong>blue</strong>) shows that it is disabled.</li><li><strong>%</strong> A percent symbol following a USE flag indicates that it is new for this package. Identical to yellow output.</li><li>***** An asterisk following a USE flag indicates that its meaning/scope has been updated. Identical to green output.</li><li><strong>()</strong> Parentheses around a USE flag indicate that it is currently masked by your profile. This is usually because the USE flag can not be supported on the given platform (for example, the <strong>win32codecs</strong> on <strong>amd64</strong> with non-binary packages) or is irrelevant (for example, <strong>sse</strong> is available on all <strong>amd64</strong> CPU&rsquo;s, so there&rsquo;s no point being able to disable it in a 64-bit environment).</li></ul><p><strong>Color Output</strong></p><p>Portage returns information to you using both symbols and colors. While the combination makes for a pretty output it also may appear confusing on first glance. Note that the color information is not required, so it repeats the symbolic output.</p><ul><li><strong>red</strong> - The USE flag is enabled and has not changed.</li><li><strong>yellow</strong> - The USE flag has been added since the package was last installed.</li><li><strong>green</strong> - The USE flag has changed since the last time the package was installed, as the asterisk after it indicates.</li><li><strong>blue</strong> - The USE flag is disabled, as the dash before it indicates.</li></ul><p><strong>Example</strong></p><p>If you run the command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --update --verbose --deep --newuse world</span>
</span></span></code></pre></div><p>you might get something similar to</p><pre tabindex=0><code>[ebuild   R    ] sys-kernel/linux-headers-2.6.11-r2  USE=&#34;-gcc64%&#34; 36,470 kB 
[ebuild    U   ] sys-process/psmisc-22.2  USE=&#34;X* ipv6 nls (-selinux)&#34; 238 kB
</code></pre><p>In this example the <strong>sys-kernel/linux-headers</strong> package would be reinstalled as indicated by the &ldquo;R&rdquo; at the beginning of the line. The <strong>sys-process/psmisc</strong> package is being updated, as shown by the &ldquo;U&rdquo; at the beginning of the line.</p><ul><li>The <strong>gcc64</strong> USE flag is colored <strong>yellow</strong> and followed by &ldquo;<strong>%</strong>&rdquo; showing that that option has been added since the package was last installed. The &ldquo;<strong>-</strong>&rdquo; shows that it will be disabled during this update.</li><li>The <strong>X</strong> USE flag will be <strong>green</strong> and followed by &ldquo;*<strong><strong>&rdquo; because that USE flag has changed since the last time the package was installed, as the asterisk after it indicates. No &ldquo;</strong>-</strong>&rdquo; shows that it will be enabled during this update.</li><li>The <strong>ipv6</strong> and <strong>nls</strong> USE flags would appear <strong>red</strong> since they are enabled (No &ldquo;<strong>-</strong>&rdquo;) and have not changed (No &ldquo;*****&rdquo;).</li><li>The <strong>selinux</strong> USE flag will be <strong>blue</strong> because the flag is disabled, as the dash before it indicates. The parentheses also show that it is an unavailable or irrelevant option.</li></ul><h3 id=更新系统>更新系统<a hidden class=anchor aria-hidden=true href=#更新系统>#</a></h3><p>要保持您的系统在最佳状态（更不用说安装那些最新的安全更新），您需要定期的更新您的系统。由于Portage只能检查本地已有文件，因此您首先应该更新您的Portage树。当您的Portage树更新后，您可以用 <strong>emerge &ndash;update @world</strong>命令来更新系统。在下一个例子里，我们还会使用 <code>--ask</code> 选项来控制Portage显示它要更新的软件包列表， 并让您决定是否继续更新。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --update --ask @world</span>
</span></span></code></pre></div><p>Portage将搜索已安装的程序的新版本。 然而，它只会验证明确安装的应用程序（在 /var/lib/portage/world 列出的应用程序）的版本，却不会检查它们的依赖项。若要更新这些包的依赖项，请添加 <code>--deep</code> 选项：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --update --deep @world</span>
</span></span></code></pre></div><p>但是，这并不意味着会更新所有的软件包：某些系统上的软件包，会在编译和构建软件的过程中需要，但是一旦安装完软件，就不再需要这些依赖项。 Portage 称这些依赖为“构建依赖”。 若要在更新时包含这些构建依赖，请添加 <code>--with-bdeps=y</code> 选项：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --update --deep --with-bdeps=y @world</span>
</span></span></code></pre></div><p>因为有时那些没有明确安装的包（但作为其他软件包的依赖而装入系统中）会推出安全更新，所以推荐偶尔运行一下这个命令。</p><p>每当您改变了系统中任何的 USE 标记后，最好加入 <code>--newuse</code> 选项。这样 Portage 将会验证这个 USE 标记变动后，是否需要安装新的软件包或者将现有的软件包重新编译。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --update --deep --with-bdeps=y --newuse @world</span>
</span></span></code></pre></div><p><strong>Meta软件包</strong></p><p>Gentoo中的一些软件包并没有包含任何实际的内容，而只是用来安装一系列软件包的集合。例如，<a href=https://packages.gentoo.org/packages/kde-plasma/plasma-meta>kde-plasma/plasma-meta</a> 包就是一个包含了一系列与Plasma相关的互相依赖的软件包的集合，您可以通过安装它来在系统中搭建起一个完整的KDE Plasma 桌面环境。</p><p>如果您试图从系统中移除一个这样的软件包的集合体，只是单纯地使用 <strong>emerge &ndash;unmerge</strong> 命令并不能完成您的要求，原因在于这些包的依赖关系仍然保留在系统中。</p><p>不用担心，Portage也提供了移除孤立依赖的软件包的功能，但由于软件包间的依赖关系是动态的，您首先需要充分地更新您的整个系统，包括更改USE标记设定而导致的变化。在这之后您可以运行<strong>emerge &ndash;depclean</strong>来移除那些完全没有被其他包依赖的软件包。移除之后你需要重新编译那些曾经与刚刚移除的这些包动态连接过的应用程序，因为实际上这些程序不需要那些包。</p><p>所有这些可以用以下三个命令来实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --update --deep --newuse @world</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge --depclean</span>
</span></span><span style=display:flex><span><span style=color:#75715e># revdep-rebuild</span>
</span></span></code></pre></div><h4 id=关于配置文件的更新>关于配置文件的更新<a hidden class=anchor aria-hidden=true href=#关于配置文件的更新>#</a></h4><p>有时候在更新了某些软件包后你会发现出现了一个类似如下的提示信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>* IMPORTANT: <span style=color:#ae81ff>2</span> config files in <span style=color:#e6db74>&#39;/etc&#39;</span> need updating.
</span></span><span style=display:flex><span>* See the CONFIGURATION FILES and CONFIGURATION FILES UPDATE TOOLS
</span></span><span style=display:flex><span>* sections of the emerge man page to learn how to update config files.
</span></span></code></pre></div><p>一般出现这种情况的直接原因是你通过归属于一个软件包的文件修改了其默认配置，导致新安装的文件与现存文件不符，于是 Portage 出于保护现存文件的目的，将新文件重命名为了对应目录下的 <code>._cfgxxxx_&lt;原名></code> 文件，这是一个很常见的情况。</p><p>而每当出现这种情况后，需要做的操作就是人工介入，判断一下保留哪个文件，还是将两个文件合并。而自带用于进行此操作的对应命令有 <code>dispatch-conf</code> 与 <code>etc-update</code> 。</p><p>以 <code>dispatch-conf</code> 为例，root 权限下执行后，它会逐个文件列出改动，然后提示你进行操作，比如按 z 保留旧的配置文件，按 u 使用新安装的配置文件替换旧的，等等。</p><h4 id=改变桌面环境httpslitterhougelangleylifeblog20210609gentoo-maintain-02-change-profile><a href=https://litterhougelangley.life/blog/2021/06/09/gentoo-maintain-02/>改变桌面环境</a>/ Change Profile<a hidden class=anchor aria-hidden=true href=#改变桌面环境httpslitterhougelangleylifeblog20210609gentoo-maintain-02-change-profile>#</a></h4><ul><li><p>首先修改 <code>/var/lib/portage/world</code> 文件，这个文件记录了用户主动安装的软件，换句话说，整个系统的构建就是围绕这 world 来创建的。将这个文件中不再需要的包删除，比方说 KDE 的软件和一些后续可以再安装，而目前保留可能造成构建麻烦的软件，比方说 htop，megasync，telegram-desktop，fcitx5 之类的，尽量减少到保留必须的就可以了，比方说内核，zfs 之类的。另外可以使用 <code>emerge --deselect xxxx</code> 命令清理 world 。</p></li><li><p>然后是修改或是删除暂时不需要的 USE 配置文件。这里需要强调一下，world 文件是我们手动安装的软件，这些软件用 <code>/etc/portage/package.use/</code> 定义了其他附带安装的软件包和组。里面不再需要的包，就需要精简，甚至是删除。</p></li><li><p>其次使用 eselect profile 修改配置文件到需要的 Profile 。</p></li><li><p>再次就是运行 <code>emerge --sync; emerge --depclean</code> 来清理系统。一般情况下，这个步骤会删除数百个包，耐心等它完成。</p></li><li><p>最后就是一些收尾工作，清理结束后，运行一些小工具来解决一些新老软件依赖的问题，运行下面的命令一波清：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge -avj @preserved-rebuild; perl-cleaner --all; emerge --sync; emerge -avujDN --with-bdeps=y --autounmask-write=y @world</span>
</span></span></code></pre></div><p>运行以后看看会不会有什么 Block 之类的包，或者循环依赖的包，手动删除下；还有时候解决不了看看是不是 USE 没有清理干净，多试几次就会清理干净，更新没有任何报错就可以开始后续的操作了。</p></li><li><p>这个时候一般会来一次全系统重构。命令如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge -ej --keep-going @world</span>
</span></span></code></pre></div></li><li><p>清理 <code>/home/&lt;user>/</code> 下的各种配置文件，安装新的桌面环境。</p></li></ul><h3 id=licenses>Licenses<a hidden class=anchor aria-hidden=true href=#licenses>#</a></h3><p>从Portage版本2.1.7开始，可以根据其授权协议接受或拒绝安装软件。 portage 树中的所有包在其ebuild中包含一个LICENSE选项。 运行<strong>emerge &ndash;search package/category</strong> 将显示软件包的许可证。</p><p><strong>Important</strong>：ebuild 中 的 LICENSE 变量仅是为 Gentoo 开发人员和用户准备的一份指南。它既不是法律声明，也不保证其真实性。因此不要过度依赖它，您需要深入检查软件包的本身，以及您使用的所有文件。</p><p>默认情况下，Portage允许<a href=https://www.gnu.org/licenses/license-list.html>自由软件基金会</a>，<a href=https://opensource.org/licenses>开源计划</a>或遵循<a href=https://www.gnu.org/philosophy/free-sw.html>自由软件定义</a>明确批准的许可。</p><p>控制允许的许可证的变量称为ACCEPT_LICENSE，可以在<code>/etc/portage/make.conf</code>文件中设置。 在下一个示例中，将显示他的默认值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ACCEPT_LICENSE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-* @FREE&#34;</span>
</span></span></code></pre></div><p>使用此配置，可以安装具有自由软件或文档许可证的软件包。非自由软件将无法安装。</p><p>可以在ACCEPT_LICENSE中全局设置 ACCEPT_LICENSE，或者在<code>/etc/portage/package.license</code> 文进行配置。</p><p>举个例子，要允许<a href=https://packages.gentoo.org/packages/www-client/google-chrome>www-client/google-chrome</a> 包的google-chrome的授权协议， 把下面的内容添加到 <code>/etc/portage/package.license</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&lt;类&gt;/&lt;名&gt; &lt;许可名称&gt;
</span></span><span style=display:flex><span>www-client/google-chrome google-chrome
</span></span><span style=display:flex><span><span style=color:#75715e># 亦可指定版本，比如对 20210818 及以上版本的 sys-kernel/linux-firmware 进行配置</span>
</span></span><span style=display:flex><span>&gt;<span style=color:#f92672>=</span>sys-kernel/linux-firmware-20210818 linux-fw-redistributable no-source-code
</span></span></code></pre></div><p>这允许安装<a href=https://packages.gentoo.org/packages/www-client/google-chrome>www-client/google-chrome</a> 程序包，但禁止安装<a href=https://packages.gentoo.org/packages/www-plugins/chrome-binary-plugins>www-plugins/chrome-binary-plugins</a> 程序包，即使它具有相同的 授权协议。</p><p><strong>重要</strong>：授权协议存储在 /var/db/repos/gentoo/licenses/ ，授权协议组在/var/db/repos/gentoo/profiles/license_groups 里面。<em>CAPITAL</em>字母中每行的第一个条目是许可证组的名称，之后的每个条目都是单独的许可证。</p><p>在 ACCEPT_LICENSE 变量中定义的许可证组前缀为<code>@</code> 符号。一种可能的设置（以前的Portage默认设置），是允许除“最终用户许可协议（EULA）”以外所有的许可证，“最终用户许可协议（EULA）”中的许可证需要阅读并签署接受协议。要完成此操作，请接受所有许可证（使用<code>*</code>），然后删除EULA组中的许可证，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ACCEPT_LICENSE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* -@EULA&#34;</span>
</span></span></code></pre></div><p>请注意，此设置也将接受非自由软件和文档。</p><h3 id=masking--unmasking-packages>Masking & Unmasking packages<a hidden class=anchor aria-hidden=true href=#masking--unmasking-packages>#</a></h3><p>package.mask中指定的软件将会不被安装（可以将其看成黑名单），当新版本的软件出现一些问题的时候（或者是不兼容）可以在这个文件中添加对应的记录。</p><p><strong><code>/etc/portage/package.unmask</code></strong> 文件的作用将会覆盖package.mask的效果（安装白名单）。</p><h4 id=屏蔽特定的包版本>屏蔽特定的包版本<a hidden class=anchor aria-hidden=true href=#屏蔽特定的包版本>#</a></h4><p>如果它不存在，请创建/etc/portage/package.mask <em>文件</em>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># echo &#34;&gt;x11-drivers/ati-drivers-12.6_beta_pre897&#34; &gt;&gt; /etc/portage/package.mask</span>
</span></span></code></pre></div><p>或者，创建/etc/portage/package.mask/ <em>目录</em>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># mkdir -p /etc/portage/package.mask/</span>
</span></span><span style=display:flex><span><span style=color:#75715e># echo &#34;&gt;x11-drivers/ati-drivers-12.6_beta_pre897&#34; &gt; /etc/portage/package.mask/ati-drivers</span>
</span></span></code></pre></div><h4 id=从-ebuild-存储库中屏蔽包>从 ebuild 存储库中屏蔽包<a hidden class=anchor aria-hidden=true href=#从-ebuild-存储库中屏蔽包>#</a></h4><p>创建一个文件以从名为“larry”的 ebuild 存储库中屏蔽名称为<a href=https://packages.gentoo.org/packages/www-client/firefox>www-client/firefox </a>的包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># echo &#34;www-client/firefox::larry&#34; &gt; /etc/portage/package.mask/firefox</span>
</span></span></code></pre></div><p><strong><a href=https://forums.gentoo.org/viewtopic-p-7518568.html>屏蔽 overlay 所有的包</a></strong></p><p>常规操作都是enable repository 后把所有包都mask 掉，要用的时候单独一个个开，加上 autounmask 也不用自己写。</p><pre tabindex=0><code>*/*::overlay_name
</code></pre><h3 id=accept_keywordshttpswikigentooorgwikiaccept_keywordszh-cn><a href=https://wiki.gentoo.org/wiki/ACCEPT_KEYWORDS/zh-cn>ACCEPT_KEYWORDS</a><a hidden class=anchor aria-hidden=true href=#accept_keywordshttpswikigentooorgwikiaccept_keywordszh-cn>#</a></h3><p>ACCEPT_KEYWORDS 变量告诉包管理器哪个 ebuild 的 <a href=https://wiki.gentoo.org/wiki/KEYWORDS>KEYWORDS</a> 允许接受。</p><h4 id=变量在哪里设置>变量在哪里设置？<a hidden class=anchor aria-hidden=true href=#变量在哪里设置>#</a></h4><p>这个变量通常通过 Gentoo 的 <a href=https://wiki.gentoo.org/wiki/Profile_(Portage)>profile</a> 设置。但是可以在用户的 <a href=https://wiki.gentoo.org/wiki//etc/portage/make.conf>/etc/portage/make.conf</a> 文件里进行覆盖，以及在 <a href=https://wiki.gentoo.org/wiki//etc/portage/package.accept_keywords>/etc/portage/package.accept_keywords</a> 文件/目录下的每个包里或者甚至在命令行中进行覆盖。</p><p><strong>Important</strong>：通过命令行覆盖 ACCEPT_KEYWORDS 变量通常被认为是个坏主意，因为设置不会被包管理器保存而且可能导致不必要的行为。</p><h4 id=稳定与不稳定的-keywords>稳定与不稳定的 keywords<a hidden class=anchor aria-hidden=true href=#稳定与不稳定的-keywords>#</a></h4><p>在绝大多数的 profile 中 ACCEPT_KEYWORDS 变量的默认值即系统架构本身，例如 <code>ACCEPT_KEYWORDS="amd64"</code> 或者 <code>ACCEPT_KEYWORDS="arm"</code>。在此情况下，包管理器只接受那些KEYWORDS 变量包含此架构的 ebuild。如果用户希望能够安装那些还未被认为适合生产环境使用的 ebuild，可以在架构前添加 <code>~</code> 前缀，例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># nano -w /etc/portage/make.conf</span>
</span></span><span style=display:flex><span>ACCEPT_KEYWORDS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;~amd64&#34;</span>
</span></span></code></pre></div><p>由于ACCEPT_KEYWORDS变量是增量的，在添加测试关键字 (<code>~amd64</code>)的时候，不应当指定稳定的关键字(<code>amd64</code>)。</p><p>如果不是进行系统全局设置，那么可以在 <code>/etc/portage/package.accept_keywords</code> 文件或目录中对每个包进行单独设置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&lt;类&gt;/&lt;名&gt; <span style=color:#f92672>[</span>可选的关键字配置<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># games</span>
</span></span><span style=display:flex><span>games-fps/doomsday ~amd64
</span></span><span style=display:flex><span><span style=color:#75715e># 亦可指定版本，比如对 21.04.3 及以上版本的 kde-apps-meta 进行配置</span>
</span></span><span style=display:flex><span>&gt;<span style=color:#f92672>=</span>kde-apps/kde-apps-meta-21.04.3
</span></span></code></pre></div><p>除了 ACCEPT_KEYWORDS 的通常值以外， package.accept_keywords 还支持三个特殊值：</p><ul><li><code>*</code> — 如果包在任何系统架构是稳定的，那么它可见</li><li><code>~*</code> — 如果包在任何系统架构是测试的，那么它可见</li><li><code>**</code> — 这个包总是可见的 (KEYWORDS 被完全忽略)</li></ul><p>最后一个选项对于版本经常改变的包 （当前 svn/git/mercurial/… 版本的包， 他们通过 live ebuild 来支持，并且没有 KEYWORDS 变量。</p><h3 id=当portage报错的时候>当Portage报错的时候<a hidden class=anchor aria-hidden=true href=#当portage报错的时候>#</a></h3><h4 id=简介>简介<a hidden class=anchor aria-hidden=true href=#简介>#</a></h4><p>正如我们之前指出的那样，Portage是一个非常强大并支持许多特性的软件包管理工具，而这是其他类似工具所欠缺的。为了理解这一点，我们为您粗略地解释一些Portage的面貌。</p><p>通过使用Portage，一个软件的不同版本可以共存于一个系统中。其他发行版倾向于直接在软件包名字中包含版本号（例如freetype 和 freetype2），Gentoo的Portage使用一种我们称之为<em>SLO的技术来实现这种并存。一个ebuild为它自身的版本声明了一个确切的SLOT。具有不同SLOT的同一软件的Ebuild可以共存于同一个系统中。例如，上例中那个freetype包就拥有不同的ebuilds，里面分别有 SLOT=&ldquo;1&rdquo; 和SLOT=&ldquo;2"的标志</em></p><p>有一些不同的软件包提供了类似的功能。比如metalogd，sysklogd和syslog-ng都是系统日志记录工具。那些依赖于“系统日志记录工具”的程序并不能随便的依赖于其中之一，比如metalogd。因为其他的系统日志工具可能也是很好的选择。好在Portage允许使用虚拟包：每一个系统日志记录工具都可以提供<a href=https://packages.gentoo.org/packages/virtual/logger>virtual/logger</a>包，因此应用程序们可以设定成仅仅依赖于virtual/syslog即可。</p><p>Portage树中的软件可以存在于不同的分支中。您的系统默认只会接受那些Gentoo认为稳定的软件包。绝大多数新提交的软件会被添加到测试分支里。这意味着在此软件被标示为稳定版前需要进行更多的测试。尽管您可以看到那些软件的ebuilds已经加入Portage数据库，在它们未被加入稳定分支前Portage将不会安装它们。</p><p>有些软件只能在某几个体系结构上使用。或者在其他体系结构中还不能运行，或者仍需要对其进行更多的测试，或者将软件提交到Portage树中的开发者还不能确定这个软件能否运行于其他体系结构。</p><p>每一个Gentoo安装都依附于一个确定的profile，此文件里除了其他信息外还包含了一个正常工作的系统需要的软件包的列表。</p><h4 id=被阻挡的包>被阻挡的包<a hidden class=anchor aria-hidden=true href=#被阻挡的包>#</a></h4><p>Portage关于被阻挡的包的警告(使用 &ndash;pretend参数)</p><pre tabindex=0><code>[blocks B     ] mail-mta/ssmtp (is blocking mail-mta/postfix-2.2.2-r1)
</code></pre><p>Portage关于被阻挡的包的警告(不使用 &ndash;pretend参数)</p><pre tabindex=0><code>!!! Error: the mail-mta/postfix package conflicts with another package.
!!!        both can&#39;t be installed on the same system together.
!!!        Please use &#39;emerge --pretend&#39; to determine blockers.
</code></pre><p>Ebuilds文件中包含了特定的字段，里面为Portage提供了此软件的各种依赖关系的信息。总计有两种可能的依赖关系：一种是编译依赖，在 DEPEND 区域进行声明;另一种是“运行时”依赖，在 RDEPEND 区域中进行声明。如果上述两种依赖关系中任何一个明确指明某个实体或者虚拟包（译注：可能已安装和正要安装）与要安装的包不相容的时候，就会阻挡软件的安装。</p><p>虽然Portage的最新版本足够聪明，可以在没有用户干预的情况下解决轻微的问题，但偶尔也需要手动解决此类问题。</p><p>为了使安装得以继续进行，您可以选择不安装这个软件包，或者先将发生冲突的包卸载。例如，在我们给出的这个例子中，您可以选择不安装postfix，或者先卸载ssmtp。</p><p>你也可能会遇到某些特定版本的包被屏蔽的情况，比如<code>&lt;media-video/mplayer-1.0_rc1-r2</code>。在这种情况下，升级到一个更新的版本就能解决问题。</p><p>也有可能两个需要安装的包互相阻挡。这种少见的情况下，您应该明确自己为什么需要同时安装它们。绝大多数时候您只需要安装它们之中的一个就可以了。如果不是这样，请您到 <a href=https://bugs.gentoo.org/>Gentoo&rsquo;s bugtracking system</a> 中提交一个bug。</p><h4 id=被屏蔽的包>被屏蔽的包<a hidden class=anchor aria-hidden=true href=#被屏蔽的包>#</a></h4><p>Portage关于被阻挡的包的警告</p><pre tabindex=0><code>!!! all ebuilds that could satisfy &#34;bootsplash&#34; have been masked.
</code></pre><p>PPortage关于被屏蔽的包的警告——原因</p><pre tabindex=0><code>!!! possible candidates are:
  
- gnome-base/gnome-2.8.0_pre1 (masked by: ~x86 keyword)
- lm-sensors/lm-sensors-2.8.7 (masked by: -sparc keyword)
- sys-libs/glibc-2.3.4.20040808 (masked by: -* keyword)
- dev-util/cvsd-1.0.2 (masked by: missing keyword)
- games-fps/unreal-tournament-451 (masked by: package.mask)
- sys-libs/glibc-2.3.2-r11 (masked by: profile)
- net-im/skype-2.1.0.81 (masked by: skype-eula license(s))
</code></pre><p>当您想安装一个对于您系统不可用的软件包。您会收到类似这样的屏蔽错误提示。您应该试着安装那些对于您系统可用的程序或者等待那些不可用的包被置为可用的。通常一个软件包被屏蔽的原因在于：</p><table><thead><tr><th style=text-align:left>Reason for mask</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>~arch keyword</td><td style=text-align:left>这个软件没有经过充分的测试，不能进入稳定分支，请等待一段时间后在尝试使用它。</td></tr><tr><td style=text-align:left>-arch keyword or -* keyword</td><td style=text-align:left>这个软件不能工作在您机器的体系结构中。如果您确信它能工作那么请到我们的bugzilla网站提交一个bug报告。</td></tr><tr><td style=text-align:left>missing keyword</td><td style=text-align:left>这个软件还没有在您机器的体系结构中进行过测试。您可以咨询相应体系结构移植小组是否能对它进行测试，或者您自己为他们进行这样的测试并将您得到的结论提交到我们的bugzilla网站。</td></tr><tr><td style=text-align:left>package.mask</td><td style=text-align:left>这个软件被认为是损坏的，不稳定的或者有更严重的问题，它被故意标识为“不应使用”。</td></tr><tr><td style=text-align:left>profile</td><td style=text-align:left>这个软件不适用于您的profile。安装这样的应用软件可能会破坏您的系统，或者只是不能与您使用的profile相兼容。</td></tr><tr><td style=text-align:left>license</td><td style=text-align:left>这个包的许可证的ACCEPT_LICENSE值不正确。 通过设置许可证或正确的许可证组来允许其许可证:/etc/portage/make.conf或 /etc/portage/package.license</td></tr></tbody></table><h4 id=use必要的更改>USE必要的更改<a hidden class=anchor aria-hidden=true href=#use必要的更改>#</a></h4><p>Portage 提示 USE 标志需要进行更改</p><pre tabindex=0><code>The following USE changes are necessary to proceed:
#required by app-text/happypackage-2.0, required by happypackage (argument)
&gt;=app-text/feelings-1.0.0 test
</code></pre><p>如果未使用<code>--autounmask</code>参数，则错误消息也可能显示如下：</p><pre tabindex=0><code>emerge: there are no ebuilds built with USE flags to satisfy &#34;app-text/feelings[test]&#34;.
!!! One of the following packages is required to complete your request:
- app-text/feelings-1.0.0 (Change USE: +test)
(dependency required by &#34;app-text/happypackage-2.0&#34; [ebuild])
(dependency required by &#34;happypackage&#34; [argument])
</code></pre><p>当请求安装包时，发生这种警告或错误，这不仅取决于另一个包，而且还要求该包使用特定的USE标志（或一组USE标志）构建。 在给定的示例中，包应用文本/感觉需要使用 USE=&ldquo;test"构建，但此系统上未设置此USE标志。</p><p>要解决这个问题， 到/etc/portage/make.conf编辑里面的USE标志, 或者去/etc/portage/package.use设置一个特殊的包.</p><h4 id=缺失依赖>缺失依赖<a hidden class=anchor aria-hidden=true href=#缺失依赖>#</a></h4><p>Portage提示依赖性不满足</p><pre tabindex=0><code>emerge: there are no ebuilds to satisfy &#34;&gt;=sys-devel/gcc-3.4.2-r4&#34;.
  
!!! Problem with ebuild sys-devel/gcc-3.4.2-r2
!!! Possibly a DEPEND/*DEPEND problem.
</code></pre><p>这表示您正尝试安装的应用程序依赖于您的系统不可用的另外一些软件包。请到bugzilla查看是否有此问题的记录，如果没有查找到相关信息的话请提交一个报告。除非您的系统混用了不同分支，否则这类问题不应该发生，若发生了那就是一个bug。</p><h4 id=意指不明的软件包>意指不明的软件包<a hidden class=anchor aria-hidden=true href=#意指不明的软件包>#</a></h4><p>Portage对于意指不明的Ebuild名称的警告</p><pre tabindex=0><code>[ Results for search key : listen ]
[ Applications found : 2 ]
  
*  dev-tinyos/listen [ Masked ]
      Latest version available: 1.1.15
      Latest version installed: [ Not Installed ]
      Size of files: 10,032 kB
      Homepage:      http://www.tinyos.net/
      Description:   Raw listen for TinyOS
      License:       BSD
  
*  media-sound/listen [ Masked ]
      Latest version available: 0.6.3
      Latest version installed: [ Not Installed ]
      Size of files: 859 kB
      Homepage:      http://www.listen-project.org
      Description:   A Music player and management for GNOME
      License:       GPL-2
  
!!! The short ebuild name &#34;listen&#34; is ambiguous. Please specify
!!! one of the above fully-qualified ebuild names instead.
</code></pre><p>您要安装的应用程序对应有多个同名的包。您需要同时指定类别的名称。Portage会列出所有可供选择的名称匹配的包。</p><h4 id=循环依赖>循环依赖<a hidden class=anchor aria-hidden=true href=#循环依赖>#</a></h4><p>Portage关于循环依赖问题的警告</p><pre tabindex=0><code>!!! Error: circular dependencies: 
  
ebuild / net-print/cups-1.1.15-r2 depends on ebuild / app-text/ghostscript-7.05.3-r1
ebuild / app-text/ghostscript-7.05.3-r1 depends on ebuild / net-print/cups-1.1.15-r2
</code></pre><p>两个（或多个）您想安装的包由于循环依赖而不能安装。这很可能源于Portage树中的bug。请等一段时间后重新sync再尝试安装。您也可以去 <a href=https://bugs.gentoo.org/>Bugzilla</a> 看看是否已经有此问题的报告，或者提交一个关于它的报告。</p><p>当然，最后它也会有类似如下提示的解决方案</p><pre tabindex=0><code>It might be possible to break this cycle
by applying the following change:
</code></pre><h4 id=下载失败>下载失败<a hidden class=anchor aria-hidden=true href=#下载失败>#</a></h4><p>Portage关于下载失败的警告</p><pre tabindex=0><code>!!! Fetch failed for sys-libs/ncurses-5.4-r5, continuing...
(...)
!!! Some fetch errors were encountered.  Please see above for details.
</code></pre><p>当Portage下载指定软件的源代码失败时，它会尝试继续安装其它（若适用）的应用程序。源代码下载失败可能源于镜像服务器没有正确同步，也可能因为ebuild文件给出了错误的下载地址。那些保存源代码的服务器也可能因为某些原因宕机。</p><p>一小时后重试一次，看看问题是否仍然存在。</p><h4 id=系统profile保护>系统Profile保护<a hidden class=anchor aria-hidden=true href=#系统profile保护>#</a></h4><p>Portage关于profile中保护的包的警告</p><pre tabindex=0><code>!!! Trying to unmerge package(s) in system profile. &#39;sys-apps/portage&#39;
!!! This could be damaging to your system.
</code></pre><p>您要求移除系统核心软件包中的一个。它是您的profile中所列出的必需的软件，因此不能从系统中移除。</p><h4 id=digest验证失败>Digest验证失败<a hidden class=anchor aria-hidden=true href=#digest验证失败>#</a></h4><p>Digest验证失败</p><pre tabindex=0><code>&gt;&gt;&gt; checking ebuild checksums
!!! Digest verification failed:
</code></pre><p>这是Portage树中出现了错误的迹象，通常是由于将ebuild提交到Gentoo ebuild存储库时出错造成的。</p><p>当digest校验失败的时候，请不要尝试自己去为此软件包重新产生digest。使用<strong>ebuild foo manifest</strong> 并不能修复问题，反而很可能会使问题变得更糟。</p><p>取而代之的应该是等待一至两个小时以便让软件仓库安定下来。一般来说错误很有可能马上就会被注意到，但是修复程序可能需要一点时间来逐步扫描rsync镜像。当您等待的时候，到<a href=https://bugs.gentoo.org/>Bugzilla</a>或者<a href=ircs://irc.libera.chat/#gentoo>#gentoo</a> (<a href=https://web.libera.chat/#gentoo>webchat</a>) (IRC)看看是否已经有人报告了这个问题。如果没有，那就为那个损坏的ebuild提交一个bug报告吧。</p><p>修复错误后，重新同步Gentoo ebuild仓库以获取修复的digest。</p><p><strong>重要</strong>：值得注意的是：不要每天多次同步<a href=https://gitweb.gentoo.org/repo/gentoo.git/>Gentoo ebuild repository</a> 仓库。正如（当您运行<strong>emerge &ndash;sync</strong>时）Gentoo官方网络礼节策略所指出的那样，那些短时间内过于频繁进行多次sync的用户将会被更新服务器软封禁一段时间，一再不遵守这一政策的滥用者可能会被硬封禁。除非绝对必要，否则通常最好等待24小时再进行同步，因为这样您不会使Gentoo的rsync镜像服务器过载而影响其他用户的正常使用。</p><h3 id=其他工具>其他工具<a hidden class=anchor aria-hidden=true href=#其他工具>#</a></h3><p>单纯 Portage 自带的工具对于日常管理其会显得有些吃力，这里推荐几个比较有用的软件用于辅助管理 Portage。</p><h4 id=app-portageeixhttpspackagesgentooorgpackagesapp-portageeix><a href=https://packages.gentoo.org/packages/app-portage/eix>app-portage/eix</a><a hidden class=anchor aria-hidden=true href=#app-portageeixhttpspackagesgentooorgpackagesapp-portageeix>#</a></h4><p>这个可以说是非常有用的软件，主要用于查询 Portage 数据库，其优势在于更快的速度、更人性化的显示格式以及更方便的查询模式。</p><p>使用前需执行 <code>eix-update</code> 以更新 eix 数据库，安装它之后，可以使用 <code>eix-sync</code> 命令来更新 Portage 数据库，更新完毕后会自动更新 eix 数据库，并显示更新前后的软件包对比情况。</p><p>使用 eix 查询所需软件，最基本的命令为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eix &lt;包名匹配字符串&gt;</span>
</span></span></code></pre></div><p>也可只查询已安装的包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eix -I &lt;包名匹配字符串&gt;</span>
</span></span></code></pre></div><p>也可查询属于一个特定分类下的所有包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eix -C &lt;类名&gt;</span>
</span></span></code></pre></div><p>等等，执行 <code>man eix</code> 查看更多用法。</p><h4 id=app-portagegentoolkithttpspackagesgentooorgpackagesapp-portagegentoolkit><a href=https://packages.gentoo.org/packages/app-portage/gentoolkit>app-portage/gentoolkit</a><a hidden class=anchor aria-hidden=true href=#app-portagegentoolkithttpspackagesgentooorgpackagesapp-portagegentoolkit>#</a></h4><p>包含了 Gentoo 的一些管理脚本，常用的命令有用于查询依赖关系，文件归属，软件包内容的 <code>equery</code> ，以及用于清理 distfile 的 <code>eclean-dist</code> 。比如</p><p>可以查询依赖 vim-core 的软件包（仅根据 ebuild 文件内容查询）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># equery d vim-core</span>
</span></span></code></pre></div><p>可以查询 vim 下属的依赖关系图</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># equery g vim</span>
</span></span></code></pre></div><p>可以查询 vim 安装了哪些文件到系统下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># equery f vim</span>
</span></span></code></pre></div><p>可以查询这个文件属于哪个包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># equery b /usr/bin/vim</span>
</span></span></code></pre></div><h5 id=ecleanhttpswikigentooorgwikiecleanzh-cn><a href=https://wiki.gentoo.org/wiki/Eclean/zh-cn>eclean</a><a hidden class=anchor aria-hidden=true href=#ecleanhttpswikigentooorgwikiecleanzh-cn>#</a></h5><p><strong>eclean</strong> 是一个清理仓库源文件和二进制包的工具。它是 <a href=https://packages.gentoo.org/packages/app-portage/gentoolkit>app-portage/gentoolkit</a> 包的一部分，并由 <a href=https://wiki.gentoo.org/wiki/Project:Portage-Tools>Portage-Tools</a> 项目维护。</p><p><strong>安装</strong></p><p>安装 <strong>eclean</strong>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --ask app-portage/gentoolkit</span>
</span></span></code></pre></div><p><strong>附注</strong>：关于 <a href=https://packages.gentoo.org/packages/app-portage/gentoolkit>app-portage/gentoolkit</a> 包中其他工具的信息请参看 <a href=https://wiki.gentoo.org/wiki/Gentoolkit>Gentoolkit article</a>。</p><p><strong>使用</strong></p><p>默认情况下，源文件存储在 /var/db/repos/gentoo/distfiles 目录下， 二进制包存储在 /var/db/repos/gentoo/packages 目录下；可以通过修改 /etc/portage/make.conf 中的 <a href=https://wiki.gentoo.org/wiki/DISTDIR>DISTDIR</a> 和 PKGDIR 变量更改对应的存储位置。如果不定期清理，这两个目录可能会悄然无声地变得非常巨大；这就是创建<strong>eclean</strong>的原因。</p><p>使用 <strong>eclean &ndash;help</strong> 来查看全部的命令简介、参数列表和使用介绍：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eclean --help</span>
</span></span></code></pre></div><p>通过 <code>distfiles</code> 参数清理源文件存放目录：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eclean distfiles</span>
</span></span></code></pre></div><p>或者使用更简短的命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eclean-dist</span>
</span></span></code></pre></div><p>使用下面的命令清理二进制包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eclean packages</span>
</span></span></code></pre></div><p>或者使用更简短的命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eclean-pkg</span>
</span></span></code></pre></div><p><strong>选项</strong></p><p>默认情况下，当前存储库中的任何ebuild相对应的源文件和二进制包都不会被删除。这样，只要程序包仍在当前存储库树中，系统管理员就可以轻松地降级程序包或安装以前删除的程序包。</p><p>举个例子，比如包 foo-1.0 和 foo-1.1 都在存储库中。在从 foo-1.0 升级到 foo-1.1 之后，运行 <strong>elcean distfiles</strong>，两个版本的源文件依然被保留，因此如果 foo-1.1 出现问题，用户可以很方便的重新安装 foo-1.0，而不必重新下载。</p><p>另一个可能的情况是安装之前删除的包。假设系统安装了 foo 包（任一版本）。在（不经意地）删除了这个包并运行了 <strong>eclean disfiles</strong> 之后，foo 的源文件依然被保留，可以重新安装而无需再次下载。</p><p>对二进制包同样的例子也一样适用。</p><p>为节省更多磁盘空间，请添加<code>--deep</code>选项：这将删除与某些当前安装的软件包（版本无关紧要）不对应的每个源文件或二进制软件包。请注意，这种方式当用户需要降级安装某个包或者重新安装之前删除的包的时候都必须重新下载。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eclean --deep distfiles</span>
</span></span><span style=display:flex><span><span style=color:#75715e># eclean --deep packages</span>
</span></span></code></pre></div><p>一个替代方案是，同时使用 <code>--deep</code> 和 <code>--package-names</code> 选项：对于某些非当前安装的包（不管版本号是什么）的每个源文件或者二进制包都会被删除。这种方式当用户需重新安装之前删除的包的时候都必须重新下载，但是要降级安装某个包则不需要。</p><p>更多细节请参阅 eclean(1) man page：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># man 1 eclean</span>
</span></span></code></pre></div><h4 id=app-portageportage-utilshttpspackagesgentooorgpackagesapp-portageportage-utils><a href=https://packages.gentoo.org/packages/app-portage/portage-utils>app-portage/portage-utils</a><a hidden class=anchor aria-hidden=true href=#app-portageportage-utilshttpspackagesgentooorgpackagesapp-portageportage-utils>#</a></h4><p>包含了 Portage 的帮助工具，与上面 gentoolkit 的功能有重合，他们具有互补性，常用的命令有用于分析 emerge 日志的 <code>qlop</code> 。它是用 C 写的，速度更快。</p><h4 id=app-portagepflhttpspackagesgentooorgpackagesapp-portagepfl><a href=https://packages.gentoo.org/packages/app-portage/pfl>app-portage/pfl</a><a hidden class=anchor aria-hidden=true href=#app-portagepflhttpspackagesgentooorgpackagesapp-portagepfl>#</a></h4><p>Portage File List，可用于在线查询文件所归属的包，命令为 <code>e-file &lt;文件名></code> 。</p><h4 id=多版本管理>多版本管理<a hidden class=anchor aria-hidden=true href=#多版本管理>#</a></h4><p>Gentoo Linux 支持同一软件多版本同时存在于系统上，这归功于 Portage 系统的 slotting 机制。当你执行命令 <code>eix dev-lang/python</code> 会发现它有好多行可用版本，最前圆括号内的内容即对应的 slot 名，不同 slot 下的版本可同时安装到系统上（ slot 名内 <code>/</code> 符号后的内容表示其 sub-slot，同 slot 但不同 sub-slot 的版本无法共存）。比如，<code>sys-devel/gcc</code> , <code>sys-devel/clang</code> , <code>dev-lang/lua</code> 等等都支持多版本共存。</p><p>对于一些多版本共存的工具， Gentoo Linux 准备了对应的 <code>eselect</code> 命令以方便用户选择使用。其会在对应的 <code>$PATH</code> 目录下创建一个指向当前选定版本命令的软链接。比如，列出当前所有已经安装的 lua 版本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eselect lua list</span>
</span></span></code></pre></div><p>设定了系统下用户交互环境的默认 lua 版本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eselect lua set {序号}</span>
</span></span></code></pre></div><p>其它的类似，执行 <code>eselect help</code> 以查看当前所有支持的模块。不是所有的多版本共存的包都会有 eselect 模块，它们并不存在强制的依赖关系。执行 <code>eix -I2</code> 可以显示当前系统下安装的可多版本共存的包。</p><h3 id=为-portage-包管理器设置代理httpsbitbilinetset-proxy-for-gentoo-portagehtml><a href=https://bitbili.net/set-proxy-for-gentoo-portage.html>为 Portage 包管理器设置代理</a><a hidden class=anchor aria-hidden=true href=#为-portage-包管理器设置代理httpsbitbilinetset-proxy-for-gentoo-portagehtml>#</a></h3><p>开门见山，本文介绍在 Gentoo Linux 下如何正确地对其包管理器 Portage 设置代理，即日常使用的 emerge 命令。这里介绍软件下载安装时需要的配置；对于同步 Portage 树，则是部分适用。</p><h4 id=gentoo-的默认设置>Gentoo 的默认设置<a hidden class=anchor aria-hidden=true href=#gentoo-的默认设置>#</a></h4><ul><li>代理： 无</li><li>工具： 默认使用 <code>wget</code> 作为下载工具，但对于绝大部分的 live 包，会有针对的 eclass 使用对应的版本控制工具从远程仓库抓取，这里仅以 <code>git</code> 为例。</li></ul><p>live 包：即版本号带 <code>9999*</code> 的这些包；用于匹配 live ebuild 文件名的正则表达式为 <code>9999*(-r[0-9]{1,3})?.ebuild$</code> ，可还是有一些包使用了这种版本命名规则却并非真正的 live 包，比如 <code>openjfx/openjfx-8.999.ebuild</code> ；这里不会通过版本号来判断是否需要配置 git 参数，所以并不影响，仅作介绍。</p><h4 id=持久性地修改代理>持久性地修改代理<a hidden class=anchor aria-hidden=true href=#持久性地修改代理>#</a></h4><h5 id=通用配置>通用配置<a hidden class=anchor aria-hidden=true href=#通用配置>#</a></h5><p><code>$ man make.conf</code> 可以看到里面有说明如何配置代理，但是过于简要，这边详细说明。</p><p>对于一般情况，在 <code>/etc/portage/make.conf</code> 文件下配置如下三个变量，就完全足够：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>http_proxy<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[protocol://][user[:password]@]proxyhost[:port]&#34;</span>
</span></span><span style=display:flex><span>https_proxy<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[protocol://][user[:password]@]proxyhost[:port]&#34;</span>
</span></span><span style=display:flex><span>ftp_proxy<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[protocol://][user[:password]@]proxyhost[:port]&#34;</span>
</span></span></code></pre></div><p>这些变量会在 emerge 命令运行时，传递给预配置的 <code>FETCHCOMMAND</code> 即 <code>wget</code> 命令。但，该命令有一个问题是不支持 socks 协议；所以，对于不同的协议需要有不同的代理服务，这样子很麻烦。</p><p>修改以支持 socks 协议有一个应变的方法，即修改默认的获取命令为 <code>curl</code> ，同样是在 <code>/etc/portage/make.conf</code> 文件下配置变量，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>FETCHCOMMAND<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;curl --retry 3 --connect-timeout 60 --ftp-pasv -Lfo \&#34;\${DISTDIR}/\${FILE}\&#34; \&#34;\${URI}\&#34;&#34;</span>
</span></span><span style=display:flex><span>RESUMECOMMAND<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;curl -C - --retry 3 --connect-timeout 60 --ftp-pasv -Lfo \&#34;\${DISTDIR}/\${FILE}\&#34; \&#34;\${URI}\&#34;&#34;</span>
</span></span></code></pre></div><p>其中 <code>RESUMECOMMAND</code> 是用于恢复意外中断的下载命令，保存后即完成修改，此时，就可以给不同协议配置同样的 socks 类协议的代理服务，均可生效。如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>https_proxy<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;socks5h://127.0.0.1:1080&#34;</span>
</span></span></code></pre></div><h5 id=单独配置-git-抓取>单独配置 git 抓取<a hidden class=anchor aria-hidden=true href=#单独配置-git-抓取>#</a></h5><p>对于 live 包，它们目前大多数直接使用 <code>git</code> 命令从远程仓库抓取。其它版本控制工具（目前支持的大致有 bzr, cvs, darcs, mercurial, subversion）同理，请自行修改后套用；当然也有直接使用 <code>wget|curl</code> 下载 live 包的情况，那么这种情况如上「一」述。</p><p><code>git</code> 命令支持 socks 协议，并且除了能吃上述配置的环境变量外，</p><p>配置 <code>https_proxy</code> 时也配好 <code>http_proxy</code> ，否则可能出现 SSL_ERROR_SYSCALL 错误。</p><p>还能独立于其它包单独配置 git 自身的代理，方法有两种：</p><ol><li><p>git 能配置针对整个 Linux 系统的参数，运行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git config --system http.proxy <span style=color:#e6db74>&#39;[protocol://][user[:password]@]proxyhost[:port]&#39;</span>
</span></span></code></pre></div><p>此命令会将配置写入到 <code>/etc/gitconfig</code> 文件内，并生效于系统级别，会被用户/项目级别的配置覆盖。</p></li><li><p>通过 Portage 的全局 <a href=https://wiki.gentoo.org/wiki//etc/portage/bashrc>bashrc</a> 文件 <code>/etc/portage/bashrc</code> 来配置临时的 git 代理</p><p>这种方式会对系统配置造成最少的干扰，只略微繁琐一点，需要将下述脚本代码写入上述的 bashrc 文件内：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>${</span>EBUILD_PHASE<span style=color:#e6db74>}</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;unpack&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#e6db74>${</span>INHERITED<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span>~ git<span style=color:#ae81ff>\-</span>r3 <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  git config --global http.proxy <span style=color:#e6db74>&#39;[protocol://][user[:password]@]proxyhost[:port]&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><p>这个 bashrc 只被 Portage 引用，会在进入每一个安装阶段时被导入。目前，Portage 下抓取 git 项目是通过 <code>git-r3.eclass</code> 实现，该 eclass 定义了 git 项目是在 src_unpack 阶段被更新，所以这里只需要在此阶段时设置即可。且，因为该目录不是被抓取包的 git 目录，所以只能设置用户级别的配置以生效，配置文件会被存放于 Portage 安装过程中沙盒的家目录下，即对应 <em>安装软件临时目录</em> （这个目录是 Portage 在编译/安装软件过程中临时建立的，会在成功安装软件后被删除，所以不用担心会有文件残留。具体位置是可以自定义的，详情看 make.conf(5) 手册下 PORTAGE_TMPDIR 条目）下的 <code>homedir/</code> 目录。</p></li></ol><h4 id=临时添加代理>临时添加代理<a hidden class=anchor aria-hidden=true href=#临时添加代理>#</a></h4><p>对于需要临时添加代理以使用的情况，目前我知道两种方式：</p><h5 id=推荐proxychains>推荐：ProxyChains<a hidden class=anchor aria-hidden=true href=#推荐proxychains>#</a></h5><p><a href=https://github.com/haad/proxychains>ProxyChains</a> is a UNIX program, that hooks network-related libc functions in dynamically linked programs via a preloaded DLL and redirects the connections through SOCKS4a/5 or HTTP proxies.</p><p>使用 <a href=https://packages.gentoo.org/packages/net-misc/proxychains><strong>net-misc/proxychains</strong></a> 软件适用所有下载方式。</p><p>配置文件可以放在 <code>~/.proxychains/proxychains.conf</code>，也可以放在 <code>/etc/proxychains.conf</code>，但是放在 etc 下更好，因为有时候要通过sudo安装软件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge net-misc/proxychains</span>
</span></span><span style=display:flex><span><span style=color:#75715e># vi /etc/proxychains.conf</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>socks5 127.0.0.1 <span style=color:#ae81ff>7891</span>
</span></span></code></pre></div><p>配置好代理列表后，通过如下命令使用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># proxychains -q emerge [&lt;args&gt;...]</span>
</span></span></code></pre></div><h5 id=临时指定环境变量>临时指定环境变量<a hidden class=anchor aria-hidden=true href=#临时指定环境变量>#</a></h5><p>{ftp,http,https}_proxy 的方式，适用性同持久性配置。</p><p>即如下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># export http_proxy=&#34;...&#34; https_...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge [&lt;args&gt;...]</span>
</span></span></code></pre></div><p>或</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># http_proxy=&#34;...&#34; https_... emerge [&lt;args&gt;...]</span>
</span></span></code></pre></div><h3 id=projectportagesynchttpswikigentooorgwikiprojectportagesync><a href=https://wiki.gentoo.org/wiki/Project:Portage/Sync>Project:Portage/Sync</a><a hidden class=anchor aria-hidden=true href=#projectportagesynchttpswikigentooorgwikiprojectportagesync>#</a></h3><p>The new plug-in sync system is the next step in that migration. Using PORTDIR and PORTDIR_OVERLAY in make.conf could only list <em>where</em> the repository was location. Users could not specify other important attributes about that repository. The repos.conf style configuration allows for settings to be added on a per sync-type basis. Along with this new expandability and the plug-in sync system, it will be much easier to change to new repository syncing methods.</p><h4 id=general-help>General help<a hidden class=anchor aria-hidden=true href=#general-help>#</a></h4><p><strong>Note</strong>: While Portage can handle repos.conf as either a file or a directory of files. The preferred method is to be used as a <em><strong>directory</strong></em>. Other tools like <strong>layman</strong> and <strong>mirrorselect</strong> require and expect it to be a directory. Layman creates and manages its own layman.conf file to register installed overlays with Portage. <strong>mirrorselect</strong> looks for repos.conf/gentoo.conf file in order to modify the <code>sync-uri</code> parameter for the gentoo repository.</p><h5 id=migration>Migration<a hidden class=anchor aria-hidden=true href=#migration>#</a></h5><p><strong>Portage configuration</strong></p><p>If the /etc/portage/repos.conf directory does not exist:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># mkdir /etc/portage/repos.conf</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cp /usr/share/portage/config/repos.conf /etc/portage/repos.conf/gentoo.conf</span>
</span></span></code></pre></div><p>Then edit the file for your installation and desired settings, continue as needed with the remaining migration instructions. Edit all repos.conf/*.conf files, add the auto-sync option to each defined repository.</p><p>For sync-type, edit it to one of the installed supported types.</p><p>Current supported sync types include:</p><ol><li><code>rsync</code></li><li><code>git</code></li><li><code>svn</code></li><li><code>webrsync</code> or <code>websync</code> (equivalent to running <strong>emerge-webrsync</strong> separately).</li><li><code>cvs</code></li><li><code>laymansync</code> (if installed by <a href=https://wiki.gentoo.org/wiki/Layman>Layman</a>)</li></ol><p><a href=https://forums.gentoo.org/viewtopic-t-1072466-start-0.html>Example</a> local overlay sync-able from a git backup:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># nano -w /etc/portage/repos.conf/gentoo.conf</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEFAULT<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>main-repo <span style=color:#f92672>=</span> gentoo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>gentoo<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>location <span style=color:#f92672>=</span> /var/db/repos/gentoo
</span></span><span style=display:flex><span>sync-type <span style=color:#f92672>=</span> git
</span></span><span style=display:flex><span>sync-uri <span style=color:#f92672>=</span> https://github.com/gentoo-mirror/gentoo.git
</span></span><span style=display:flex><span>auto-sync <span style=color:#f92672>=</span> yes
</span></span><span style=display:flex><span>priority <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000</span>
</span></span></code></pre></div><p>The above overlay can be synced with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emaint sync -r gentoo</span>
</span></span></code></pre></div><h5 id=operation>Operation<a hidden class=anchor aria-hidden=true href=#operation>#</a></h5><p>Primary control of all sync operations has been moved from <strong>emerge</strong> to <strong>emaint</strong>. <strong>emerge &ndash;sync</strong> now runs the emaint sync module with the <code>--auto</code> option. This <code>--auto</code> option performs a sync on only those repositories with the auto-sync setting set to <code>yes</code> or <code>true</code>. If the auto-sync option is <em>not</em> set to <code>yes</code> or is absent, then <strong>emerge &ndash;sync</strong> may not sync any repositories.</p><p><strong>Note</strong>: As a result of the default auto-sync = True/Yes setting, commands like <strong>eix-sync</strong>, <strong>esync -l</strong>, <strong>emerge &ndash;sync && layman -S</strong> will cause many repositories to be synced multiple times in a row. Please adjust configuration files or scripts as necessary for the new operation.</p><p><strong>Warning</strong>: Due to the above default. For any repositories (repos) that you EXPLICITLY do <em><strong>not</strong></em> want to be synced. You MUST set <code>auto-sync = no</code></p><h5 id=examples>Examples<a hidden class=anchor aria-hidden=true href=#examples>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emaint sync -a</span>
</span></span></code></pre></div><p>Equivalent to <strong>emerge &ndash;sync</strong>. Sync all repositories where <code>auto-sync = true</code> is set.</p><p><strong>Note</strong>: Due to the default <code>auto-sync = true</code> setting, this command will sync all repositories that do not have <code>auto-sync = no</code> explicitly set.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emaint sync -r foo</span>
</span></span></code></pre></div><p>Sync the foo repo (ignores auto-sync setting):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emaint sync --allrepos</span>
</span></span></code></pre></div><p>Sync all repositories with a valid sync-type and sync-url defined. (ignores auto-sync setting)</p><h2 id=use标记httpswikigentooorgwikihandbookamd64workinguse><a href=https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/USE>USE标记</a><a hidden class=anchor aria-hidden=true href=#use标记httpswikigentooorgwikihandbookamd64workinguse>#</a></h2><h3 id=什么是use标志>什么是USE标志<a hidden class=anchor aria-hidden=true href=#什么是use标志>#</a></h3><h4 id=use标志的指导思想>USE标志的指导思想<a hidden class=anchor aria-hidden=true href=#use标志的指导思想>#</a></h4><p>你在安装gentoo（或者是其他发行版，甚至于其他特定操作系统）的时候，你要依据你工作的环境做出选择。服务器跟工作站的组织结构不同，游戏机跟3D工作站也会不一样。</p><p>不单只是选择你想要安装的包时如此，选择某一个包需要的特性时同样如此。如果你不需要OpenGL，为什么还要花费时间安装OpenGL并在其他包中加入对OpenGL的支持？如果你不用KDE，而且软件包没有KDE也能完美运行，为什么还要在编译这些包的时候加入KDE支持？</p><p>为了帮用户判断什么需要安装或激活，什么不需要；我们希望用户能用简单的方式设定他们自己的环境。这能促使用户判断他真正需要的东西，并让Portage做出有用的决定的过程变得简单。</p><h4 id=use标志的设定>USE标志的设定<a hidden class=anchor aria-hidden=true href=#use标志的设定>#</a></h4><p>我们来具体看看USE标志。每一个标志都是代表对某特定概念的支持和依赖关系信息的关键字。如果你设定了某个USE标志，Portage会明白他们需要支持所选关键字。当然这同时也改变了这个包的依赖关系信息。</p><p>让我们看一个特殊示例：关键字 <code>kde</code> 。如果你的 USE 变量里面没有这个关键字，所有具有可选KDE支持的包在编译时都 <em>不会</em> 编译KDE支持。所有具有可选KDE依赖关系的包在安装时都 <em>不会</em> （做为一个依赖关系而）安装KDE库。如果你设定了kde关键字，这些包在安装时都 <em>会</em> 编译KDE支持，而且KDE库也 <em>会</em> （作为一个依赖关系而）被安装。</p><p>通过正确设定关键字，你会得到一个根据你的需要而定制的系统。</p><h3 id=使用use标志>使用USE标志<a hidden class=anchor aria-hidden=true href=#使用use标志>#</a></h3><h4 id=声明永久use标志>声明永久USE标志<a hidden class=anchor aria-hidden=true href=#声明永久use标志>#</a></h4><p>就像前面提到的，所有USE标志都声明在 USE 变量里面。为了让用户能方便地查找和选择USE标志，我们提供了一份默认的USE设定。这些设定是我们觉得Gentoo用户通常都要用到的USE标志的集合。这个默认设置在make.defaults 文件──你的profile声明。</p><p>你的系统使用的profile是符号链接 <code>/etc/portage/make.profile</code> 所指向的目录。每个profile叠加于某个更大的profile之上，最终的结果是这些profile的并集。初始profile是base profile( <code>/var/db/repos/gentoo/profiles/base</code>)。</p><p>要查看当前正在使用的USE标志（全部），请使用 <strong>emerge &ndash;info</strong>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --info | grep ^USE</span>
</span></span><span style=display:flex><span>USE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;a52 aac acpi alsa branding cairo cdr dbus dts ...&#34;</span>
</span></span></code></pre></div><p>就像你看到的那样，这个变量已经包括了非常多的关键字。不要通过修改make.defaults 文件里的 USE 变量来满足你的需要：在升级Portage的时候，这个文件将会被覆盖。</p><p>要改变这个默认设置，你需要在 USE 变量里添加或移去关键字。这是通过在<code>/etc/portage/make.conf</code>里定义USE全局变量来实现的。在这个变量里，添加你需要的额外的USE标志，或者移去你不需要的USE标志。后者可通过在标记前面加个负号 (<code>-</code>).前缀来实现。</p><p>例如，要移除对 KDE 和 QT 的支持，并添加对 LDAP 的支持，可以在<code>/etc/portage/make.conf</code>里声明USE如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>USE</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-kde -qt4 -qt5 ldap&#34;</span>
</span></span></code></pre></div><h4 id=为单个包声明use标志>为单个包声明USE标志<a hidden class=anchor aria-hidden=true href=#为单个包声明use标志>#</a></h4><p>如果你不是想为整个系统声明USE标志，而是想要为一个（或者几个）程序声明USE标志，你需要编辑<code>/etc/portage/package.use</code>文件。package.use 通常是一个文件，不过它也可以是一个充满子文件的目录；请看下面的提示和 <strong>man 5 portage</strong> 以获得更多如何使用这个约定的信息。下面的例子假设 package.use 是一个文件。</p><p>比如说，如果你不想全局的启用 Blu-ray 支持，你只想把它应用到 VLC 包，你可以这样做：</p><pre tabindex=0><code>&lt;类&gt;/&lt;名&gt; &lt;USE&gt;
media-video/vlc bluray
</code></pre><p><strong>Tip</strong>：如果 package.use 是一个已经存在的“目录”（而不是一个单文件），只需简单地在 package.use/ 目录下创建文件，就可以修改软件包的本地USE标记。虽然任何文件命名规范都行，但是更明智的做法是统一命名方案。</p><p>有一种规范是简单地使用包名作为子文件的标题。比如说，可以用如下方式为 <a href=https://packages.gentoo.org/packages/media-video/vlc>media-video/vlc</a> 软件包在本地设置 <code>bluray</code> USE 标记。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># echo &#34;media-video/vlc bluray&#34; &gt;&gt; /etc/portage/package.use/vlc</span>
</span></span></code></pre></div><p>你当然也可以直接为某一个程序禁用USE标志。比如说，禁用PHP的bzip2支持（但通过make.conf中的USE标志为其他包提供支持）：</p><pre tabindex=0><code>dev-lang/php -bzip2
</code></pre><p><code>-*</code> 代表去除该匹配的包的所有已经添加的以及默认的 USE</p><pre tabindex=0><code>&gt;=kde-apps/kde-apps-meta-21.04.3 -* admin
</code></pre><p>Portage 有一个 USE Expand 功能，即把指定变量的值扩展成 USE，这些指定的变量被设置在 Portage 数据库路径下的 <code>profiles/base/make.defaults</code> 文件的 USE_EXPAND 变量中。这个功能很实用，简化了配置值，还能进行归类，更便于管理。上文有一个 <a href=https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E6%98%BE%E5%8D%A1%E7%9A%84%E9%85%8D%E7%BD%AE>显卡的配置</a> 其实就是一个 USE_EXPAND 值。其它会使用到它的地方不多，但也有，比如配置全局的本地化配置，就可以在 make.conf 文件下配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>L10N<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;zh-CN zh-TW zh en-GB-oxendict en&#34;</span>
</span></span></code></pre></div><p>这样，那么以后当有包支持上述的本地化配置时，就会自动添加。</p><p>其它比如可以对 qemu 这个虚拟机添加额外的模拟平台， 可以往 <code>/etc/portage/package.use/qemu</code> 文件写</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>app-emulation/qemu QEMU_SOFTMMU_TARGETS: aarch x86_64
</span></span></code></pre></div><p>以支持 arm64 及 x86_64 平台。等等</p><h4 id=声明临时use标志>声明临时USE标志<a hidden class=anchor aria-hidden=true href=#声明临时use标志>#</a></h4><p>有时，你只想暂时改变一个USE设置。你可以仅仅把USE 变量声明成一个环境变量，而不必两次修改/etc/portage/make.conf 。但是要记住，当你重新emerge或者升级这个程序的时候（不管是单独地还是作为系统升级的一部分），你的修改会被重置。</p><p>下面的例子我们将在安装 SeaMonkey 的时候临时从 USE 变量中移去<code>pulseaudio</code> 值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># USE=&#34;-pulseaudio&#34; emerge www-client/seamonkey</span>
</span></span></code></pre></div><h4 id=优先级>优先级<a hidden class=anchor aria-hidden=true href=#优先级>#</a></h4><p>当然，USE设置有一定的优先级。按优先级排序（第一优先级最低）：</p><ol><li>make.defaults 里面的USE默认设定</li><li>用户在/etc/portage/make.conf里面的USE默认设定</li><li>用户在 /etc/portage/package.use里面的USE默认设定</li><li>用户作为环境变量的USE设定</li></ol><p>运行 <strong>emerge &ndash;info</strong>可以看到Portage识别的最终的USE设定。它会列出Portage使用的所有相关变量（包括 USE 变量）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --info</span>
</span></span></code></pre></div><h4 id=在整个系统上应用新的use标志>在整个系统上应用新的USE标志<a hidden class=anchor aria-hidden=true href=#在整个系统上应用新的use标志>#</a></h4><p>如果你已经修改了你的USE标志，而且你想用新的USE标志更新你的系统，可以使用<strong>emerge</strong>的 <code>--newuse</code>选项：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --update --deep --newuse @world</span>
</span></span></code></pre></div><p>然后运行Portage的depclean来移除已经安装到你的"旧"系统里但是在新USE标志中被废除的条件依赖关系。</p><p><strong>警告</strong>：运行<strong>emerge &ndash;depclean</strong>是一项危险的操作，必须小心。请反复检查要删除的包的列表里确定没有你仍然需要的包。下面这个例子里，我们添加了 <code>-p</code> 选项──来只列出这些包而不删除他们：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge -p --depclean</span>
</span></span></code></pre></div><p>depclean完成之后， <strong>emerge</strong>会针对可能是已经删除的软件包提供的共享对象动态链接的应用程序提示重新构建。此操作完成前，为了防止破坏应用程序，Portage 将会保存必要的库。它存储着需要在 <code>preserved-rebuild</code> 设置的重建内容。若要重建必要的包，请运行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge @preserved-rebuild</span>
</span></span></code></pre></div><p>这些都完成之后，你的系统就已经应用上了新的USE标志的设定。</p><h3 id=软件包特有的use标志>软件包特有的USE标志<a hidden class=anchor aria-hidden=true href=#软件包特有的use标志>#</a></h3><p>查看可用USE标志。</p><p>让我们以seamonkey来作例子，看看它接收什么USE标志。我们可以以<code>--pretend</code>和 <code>--verbose</code>为选项执行 <strong>emerge</strong>来查看：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --pretend --verbose www-client/seamonkey</span>
</span></span><span style=display:flex><span>These are the packages that would be merged, in order:
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>Calculating dependencies... <span style=color:#66d9ef>done</span>!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ebuild  N     <span style=color:#f92672>]</span> www-client/seamonkey-2.48_beta1::gentoo  USE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;calendar chatzilla crypt dbus gmp-autoupdate ipc jemalloc pulseaudio roaming skia startup-notification -custom-cflags -custom-optimization -debug -gtk3 -jack -minimal (-neon) (-selinux) (-system-cairo) -system-harfbuzz -system-icu -system-jpeg -system-libevent -system-libvpx -system-sqlite {-test} -wifi&#34;</span> L10N<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-ca -cs -de -en-GB -es-AR -es-ES -fi -fr -gl -hu -it -ja -lt -nb -nl -pl -pt-PT -ru -sk -sv -tr -uk -zh-CN -zh-TW&#34;</span> 216,860 KiB
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>Total: <span style=color:#ae81ff>1</span> package <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> new<span style=color:#f92672>)</span>, Size of downloads: 216,860 KiB
</span></span></code></pre></div><p><strong>emerge</strong> 并不是做这件事的唯一工具。事实上，我们有一个专门的包信息工具叫<strong>equery</strong>，它属于<a href=https://packages.gentoo.org/packages/app-portage/gentoolkit>app-portage/gentoolkit</a>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --ask app-portage/gentoolkit</span>
</span></span></code></pre></div><p>现在以为参数执行 <strong>equery</strong> 来查看指定包的USE标志。例如：gnumeric包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># equery --nocolor uses =gnumeric-1.12.31</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> Legend : U - final flag setting <span style=color:#66d9ef>for</span> installation<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>        : I - package is installed with flag     <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> Colors : set, unset                             <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> * Found these USE flags <span style=color:#66d9ef>for</span> app-office/gnumeric-1.12.31:
</span></span><span style=display:flex><span> U I
</span></span><span style=display:flex><span> + + introspection            : Add support <span style=color:#66d9ef>for</span> GObject based introspection
</span></span><span style=display:flex><span> - - libgda                   : Enable database support through gnome-extra/libgda.
</span></span><span style=display:flex><span> - - perl                     : Enable perl plugin loader.
</span></span><span style=display:flex><span> + + python                   : Enable python plugin loader.
</span></span><span style=display:flex><span> + + python_targets_python2_7 : Build with Python 2.7
</span></span></code></pre></div><h3 id=满足-required_use>满足 REQUIRED_USE<a hidden class=anchor aria-hidden=true href=#满足-required_use>#</a></h3><p>一些 ebuild 需要或禁止 USE 标志的某些组合才能正常工作。 这通过放置在 REQUIRED_USE ，用一组条件来表示。此条件确保所有功能和依赖性都已完成，并且构建将成功并按预期执行。 如果任何一个不符合，emerge 会提醒你，并要求你解决这个问题。</p><p>下面是 REQUIRED_USE 的一个例子：</p><table><thead><tr><th style=text-align:left>示例</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:left><code>REQUIRED_USE="foo? ( bar )"</code></td><td style=text-align:left>如果设定 <code>foo</code>，则必须设定 <code>bar</code>。</td></tr><tr><td style=text-align:left><code>REQUIRED_USE="foo? ( !bar )"</code></td><td style=text-align:left>如果设定 <code>foo</code>，则不得设定 <code>bar</code>。</td></tr><tr><td style=text-align:left>`REQUIRED_USE=&ldquo;foo? (</td><td style=text-align:left></td></tr><tr><td style=text-align:left><code>REQUIRED_USE="^^ ( foo bar baz )"</code></td><td style=text-align:left>必须在 <code>foo</code>、<code>bar</code> 或 <code>baz</code> 中设定一个。</td></tr><tr><td style=text-align:left>`REQUIRED_USE=&rdquo;</td><td style=text-align:left></td></tr><tr><td style=text-align:left><code>REQUIRED_USE="?? ( foo bar baz )"</code></td><td style=text-align:left></td></tr></tbody></table><h2 id=portage功能特性httpswikigentooorgwikihandbookamd64workingfeatures><a href=https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/Features>Portage功能特性</a><a hidden class=anchor aria-hidden=true href=#portage功能特性httpswikigentooorgwikihandbookamd64workingfeatures>#</a></h2><h3 id=portage特性>Portage特性<a hidden class=anchor aria-hidden=true href=#portage特性>#</a></h3><p>Portage有几个附加的特性，它们能够令您的Gentoo之旅更加愉快。这些特性中的大多数依赖于某些能够提高性能、可靠性、安全性等的软件工具。</p><p>为了打开或者关闭某一Portage特性您需要编辑 <code>/etc/portage/make.conf</code>中的 FEATURES变量，这个变量包含不同的特性关键字，用空格分开。在一些情况下您可能还需要额外的安装被这个特性所依赖的工具。</p><p>并不是所有Portage所支持的特性都在这里列出。完整的概述，请查阅make.conf手册页：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># man make.conf</span>
</span></span></code></pre></div><p>查看 FEATURES 的默认设置，运行<strong>emerge &ndash;info</strong>并且查找FEATURES变量或者用<strong>grep</strong> 显示它：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --info | grep ^FEATURES=</span>
</span></span></code></pre></div><h3 id=分布式编译>分布式编译<a hidden class=anchor aria-hidden=true href=#分布式编译>#</a></h3><h4 id=使用distcc>使用distcc<a hidden class=anchor aria-hidden=true href=#使用distcc>#</a></h4><p><strong>distcc</strong> 是一个分布式编译程序，可以把编译任务分配给同一网络中的不同机器，这些机器的配置不必完全相同。distcc客户端发送所有必须的信息给所有可利用的distcc服务器（运行distccd的机器）。这样它们每一个都能为客户端编译一部分源码。所获得的效果就是更短的编译时间。</p><p>您可以在Gentoo Distcc文档里找到更多的关于<a href=https://wiki.gentoo.org/wiki/Distcc>Distcc</a>的信息（包括如何让它在Gentoo上工作）。</p><h4 id=安装-distcc>安装 distcc<a hidden class=anchor aria-hidden=true href=#安装-distcc>#</a></h4><p>Distcc使用一个图形化监视器来监视您的机器发送出去的编译工作。请把 <code>USE=gnome</code> 或 <code>USE=gtk</code>放进您的USE设置中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># merge --ask sys-devel/distcc</span>
</span></span></code></pre></div><h4 id=激活portage的distcc支持>激活Portage的distcc支持<a hidden class=anchor aria-hidden=true href=#激活portage的distcc支持>#</a></h4><p>将 <code>distcc</code> 添加到<code>/etc/portage/make.conf</code>中的 <code>FEATURES &lt;/ var></code>变量中。 接下来，编辑MAKEOPTS变量，并增加系统允许的并行构建的数量。 一个已知的方法是填写 <code>-jN</code> 其中<code>N</code> 是运行distccd（包括当前主机）的CPU数量+1（或者核心数+1），但这只是一个建议。</p><p>现在运行 <strong>distcc-config</strong>并输入已有的DistCC服务器。作为一个简单例子，我们假设已有的DistCC服务器是192.168.1.102（当前主机）、192.168.1.103和192.168.1.104（两个远端服务器）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># distcc-config --set-hosts &#34;192.168.1.102 192.168.1.103 192.168.1.104&#34;</span>
</span></span></code></pre></div><p>当然，也不要忘了运行distccd系统服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># rc-update add distccd default</span>
</span></span><span style=display:flex><span><span style=color:#75715e># /etc/init.d/distccd start</span>
</span></span></code></pre></div><h3 id=缓冲编译结果>缓冲编译结果<a hidden class=anchor aria-hidden=true href=#缓冲编译结果>#</a></h3><h4 id=关于ccache>关于ccache<a hidden class=anchor aria-hidden=true href=#关于ccache>#</a></h4><p><strong>ccache</strong>是一个快速编译器缓存。 无论何时编译应用程序，它都将缓存中间结果，以便每当重新编译相同的程序时，编译时间大大减少。 第一次运行ccache时，它会比正常编译慢得多。 但是后续的重新编译应该更快。 ccache只有在相同的应用程序将被重新编译多次（或相同应用程序的升级频繁发生）时才有用; 因此它通常只对软件开发人员有用。</p><p>如果您对ccache的工作机制有兴趣，请访问<a href=https://ccache.samba.org/>homepage</a>主页.</p><p><strong>警告</strong>：已知ccache会导致大量的编译失败。 有时ccache会保留旧代码对象或损坏的文件，这可能导致无法破损的源码。 如果发生这种情况（例如"File not recognized: File truncated"出现在构建日志中），请尝试重新编译ccache导致错误的应用程序 。添加<code>FEATURES="-ccache"</code> 到/etc/portage/make.conf或者</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># FEATURES=&#34;-ccache&#34; emerge &lt;category/package&gt;</span>
</span></span></code></pre></div><h4 id=安装-ccache>安装 ccache<a hidden class=anchor aria-hidden=true href=#安装-ccache>#</a></h4><p>要安装ccache，只需要：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --ask dev-util/ccache</span>
</span></span></code></pre></div><h4 id=激活portage-ccache-支持>激活Portage ccache 支持<a hidden class=anchor aria-hidden=true href=#激活portage-ccache-支持>#</a></h4><p>打开 <code>/etc/portage/make.conf</code>并添加<code>ccache</code>到FEATURES变量:</p><pre tabindex=0><code>FEATURES=&#34;ccache&#34;
CCACHE_SIZE=&#34;2G&#34;
</code></pre><p>要检查ccache是否运行，只需让它提供给您它的统计数据。因为Portage使用一个不同的ccache主目录，您需要设定CCACHE_DIR变量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># CCACHE_DIR=&#34;/var/tmp/ccache&#34; ccache -s</span>
</span></span></code></pre></div><p><code>/var/tmp/ccache/</code>是Portage的默认ccache主目录；为了修改这个设置，您可以设定<code>/etc/portage/make.conf</code>中的CCACHE_DIR参数。</p><p>不过，如果您运行 <strong>ccache</strong> ，它使用的默认目录是<code>${HOME}/.ccache/</code>。这就是为什么当您查询（Portage）ccache统计数据的时候您需要设定 CCACHE_DIR参数的原因。</p><h4 id=非portage编译中使用ccache>非Portage编译中使用ccache<a hidden class=anchor aria-hidden=true href=#非portage编译中使用ccache>#</a></h4><p>如果您需要在非Portage编译中使用ccache，添加 <code>/usr/lib/ccache/bin/</code>到您 PATH参数里靠前的位置（在/usr/bin之前）。这一点可以通过编辑在您用户主目录中的<code>~/.bash_profile</code>文件来实现。使用<code>~/.bash_profile</code>是定义 PATH参数的一个方式</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/usr/lib/ccache/bin:</span><span style=color:#e6db74>${</span>PATH<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><h3 id=二进制包支持>二进制包支持<a hidden class=anchor aria-hidden=true href=#二进制包支持>#</a></h3><h4 id=创建预编译包>创建预编译包<a hidden class=anchor aria-hidden=true href=#创建预编译包>#</a></h4><p>Portage 也支持安装预编译软件包。尽管 Gentoo 本身并不提供预编译包，但 Portage 依然能够处理预编译包。</p><p>如果某个包已经被安装在您的系统上，您可以用 <strong>quickpkg</strong> 来创建预编译包。也可以用带有 <code>--buildpkg</code> 或 <code>--buildpkgonly</code> 选项的 emerge 命令。</p><p>如果您希望 Portage 为您所安装的每一个软件包创建预编译软件包，那么请在 FEATURES 中添加 <code>buildpkg</code> 变量。</p><p>预编译包的更多扩展支持可以用 catalyst 得到。关于catalyst的更多信息请参阅 <a href=https://wiki.gentoo.org/wiki/Project:Catalyst/FAQ>Catalyst FAQ</a>。</p><h4 id=安装预编译包>安装预编译包<a hidden class=anchor aria-hidden=true href=#安装预编译包>#</a></h4><p>尽管Gentoo并不提供，但是您可以自己建立一个“中心仓库”来存放预编译包。如果您希望使用这个仓库，您需要设定PORTAGE_BINHOST参数使Portage能够知道它。例如，如果预编译包在 ftp://buildhost/gentoo 上：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># nano -w /etc/portage/make.conf</span>
</span></span><span style=display:flex><span>PORTAGE_BINHOST<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ftp://buildhost/gentoo&#34;</span>
</span></span></code></pre></div><p>当您需要安装预编译包的时候，在emerge命令后的 <code>--getbinpkg</code>选项旁加入 <code>--usepkg</code> 选项。前者让emerge命令从预定的服务器上下载预编译包，后者让emerge首先试图安装预编译包，如果预编译包不存在，那么才下载并编译源码。</p><p>例如：用预编译包安装gnumeric</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --usepkg --getbinpkg gnumeric</span>
</span></span></code></pre></div><p>关于emerge的预编译包的更多信息请参阅emerge手册页:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># man emerge</span>
</span></span></code></pre></div><h4 id=将预构建的软件包分发给他人>将预构建的软件包分发给他人<a hidden class=anchor aria-hidden=true href=#将预构建的软件包分发给他人>#</a></h4><p>如果预构建的软件要分发给其他人，请确保这样做是被允许的。 检查上游软件包的分发要求。 例如，对于在GNU GPL协议下发布的软件，源代码必须与二进制文件一起提供。</p><p>如果构建的二进制程序不可分发，则Ebuild可以在其RESTRICT 变量中定义 <code>bindist</code>限制。 有时，此限制取决于一个或多个USE标志。</p><p>默认情况下，Portage将不会屏蔽任何包，因为有限制。 这可以通过在<code>/etc/portage/make.conf</code>中设置ACCEPT_RESTRICT变量来全局更改。 例如，要掩盖具有<code>bindist</code> 限制的软件包，请将以下行添加到make.conf：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ACCEPT_RESTRICT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;* -bindist&#34;</span>
</span></span></code></pre></div><p>还可以通过将ACCEPT_RESTRICT选项用于<strong>emerge</strong>命令，来覆盖<code>--accept-restrict</code> 变量。 例如， <code>--accept-restrict=-bindist</code>将临时屏蔽带有<code>bindist</code> 限制的包。</p><p>还可以考虑在分发包时设置ACCEPT_LICENSE变量。 请参阅 <a href=https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/Portage/zh-cn#Licenses>授权许可</a>。</p><p><strong>重要</strong>：每个 <em>用户</em>完全有责任遵守软件许可条款和每个用户国家的法律。 ebuilds（RESTRICT或LICENSE）定义的元数据变量可以为禁止预编译文件分发提供指导。但是Portage的输出或Gentoo开发人员的回答 <em>不是</em> 法律声明，不应该依赖他们。 谨慎遵守您的当地的法律。</p><h3 id=下载文件>下载文件<a hidden class=anchor aria-hidden=true href=#下载文件>#</a></h3><h4 id=并行下载>并行下载<a hidden class=anchor aria-hidden=true href=#并行下载>#</a></h4><p>Portage 通常是以root 用户运行的， <code>FEATURES="userfetch"</code>可以让Portage在下载源码包的时候弃用 root 权限，并以 portage:portage 的用户/组权限运行。这是一个小小的安全性的提高方法。</p><p>如果在 FEATURES 设置了 <code>userfetch</code>，请确保在 root 权限下，使用 <strong>chown</strong> 命令更改在 /var/db/repos/gentoo 下所有文件的所有者：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># chown --recursive --verbose portage:portage /var/db/repos/gentoo</span>
</span></span></code></pre></div><h4 id=验证源文件>验证源文件<a hidden class=anchor aria-hidden=true href=#验证源文件>#</a></h4><p>要重新验证完整性并(可能)重新下载当前所有安装的软件包以前删除或损坏的 distfiles，请运行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --ask --fetchonly --emptytree @world</span>
</span></span></code></pre></div><h2 id=环境变量httpswikigentooorgwikihandbookamd64workingenvvar><a href=https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/EnvVar>环境变量</a><a hidden class=anchor aria-hidden=true href=#环境变量httpswikigentooorgwikihandbookamd64workingenvvar>#</a></h2><h3 id=环境变量>环境变量<a hidden class=anchor aria-hidden=true href=#环境变量>#</a></h3><h4 id=简介-1>简介<a hidden class=anchor aria-hidden=true href=#简介-1>#</a></h4><p>环境变量是一个具有特定名字的对象，它包含了一个或者多个应用程序所将使用到的信息。通过使用环境变量，你可以很容易的修改一个牵涉到一个或多个应用程序的配置信息。</p><h4 id=重要的例子>重要的例子<a hidden class=anchor aria-hidden=true href=#重要的例子>#</a></h4><p>下表展示了一些Linux系统使用的变量并说明了它们的用处。在表格后面将列举一些变量例值。</p><table><thead><tr><th style=text-align:left>Variable</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>PATH</td><td style=text-align:left>这个变量包含了一系列由冒号分隔开的目录，系统就从这些目录里寻找可执行文件。如果你输入的可执行文件（例如 <strong>ls</strong>, <strong>rc-update</strong>或者 <strong>emerge</strong>）不在这些目录中，系统就无法执行它（除非你输入这个命令的完整路径，如/bin/ls）。</td></tr><tr><td style=text-align:left>ROOTPATH</td><td style=text-align:left>这个变量的功能和 PATH相同，但它只罗列出超级用户（root）键入命令时所需检查的目录。</td></tr><tr><td style=text-align:left>LDPATH</td><td style=text-align:left>这个变量包含了一系列用冒号隔开的目录，动态链接器将在这些目录里查找库文件。</td></tr><tr><td style=text-align:left>MANPATH</td><td style=text-align:left>这个变量包含了一系列用冒号隔开的目录，命令 man 会在这些目录里搜索man页面。</td></tr><tr><td style=text-align:left>INFODIR</td><td style=text-align:left>这个变量包含了一系列用冒号隔开的目录，命令 info 将在这些目录里搜索info页面。</td></tr><tr><td style=text-align:left>PAGER</td><td style=text-align:left>这个变量包含了浏览文件内容的程序的路径，比如(<strong>less</strong> 或者 <strong>more</strong>)</td></tr><tr><td style=text-align:left>EDITOR</td><td style=text-align:left>这个变量包含了修改文件内容的程序（文件编辑器）的路径(比如 <strong>nano</strong> 或 <strong>vi</strong>).</td></tr><tr><td style=text-align:left>KDEDIRS</td><td style=text-align:left>这个变量包含了一系列用冒号隔开的目录，里面放的是KDE相关的资料。</td></tr><tr><td style=text-align:left>CONFIG_PROTECT</td><td style=text-align:left>这个变量包含了一系列用空格隔开的目录，它们在更新的时候会被Portage保护起来。</td></tr><tr><td style=text-align:left>CONFIG_PROTECT_MASK</td><td style=text-align:left>这个变量包含了一系列用空格隔开的目录，它们在更新的时候不会被Portage保护起来。</td></tr></tbody></table><p>下面你可以找到所有这些变量定义的范例：</p><pre tabindex=0><code>PATH=&#34;/bin:/usr/bin:/usr/local/bin:/opt/bin:/usr/games/bin&#34;
ROOTPATH=&#34;/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin&#34;
LDPATH=&#34;/lib:/usr/lib:/usr/local/lib:/usr/lib/gcc-lib/i686-pc-linux-gnu/3.2.3&#34;
MANPATH=&#34;/usr/share/man:/usr/local/share/man&#34;
INFODIR=&#34;/usr/share/info:/usr/local/share/info&#34;
PAGER=&#34;/usr/bin/less&#34;
EDITOR=&#34;/usr/bin/vim&#34;
KDEDIRS=&#34;/usr&#34;
CONFIG_PROTECT=&#34;/usr/X11R6/lib/X11/xkb /opt/tomcat/conf \
                /usr/kde/3.1/share/config /usr/share/texmf/tex/generic/config/ \
                /usr/share/texmf/tex/platex/config/ /usr/share/config&#34;
CONFIG_PROTECT_MASK=&#34;/etc/gconf&#34;
</code></pre><h3 id=全局变量的定义>全局变量的定义<a hidden class=anchor aria-hidden=true href=#全局变量的定义>#</a></h3><h4 id=envd目录>env.d目录<a hidden class=anchor aria-hidden=true href=#envd目录>#</a></h4><p>Gentoo采用了/etc/env.d/目录来集中定义全局变量。在这个目录里，你会发现很多类似 00basic, 05gcc等等这样的文件，它们包含了文件名中提到的应用程序需要的变量。</p><p>举个例子，当你安装 <strong>gcc</strong>时，一个名为 05gcc 的文件就会被ebuild所创建，里面包含了如下一些变量：</p><pre tabindex=0><code>PATH=&#34;/usr/i686-pc-linux-gnu/gcc-bin/3.2&#34;
ROOTPATH=&#34;/usr/i686-pc-linux-gnu/gcc-bin/3.2&#34;
MANPATH=&#34;/usr/share/gcc-data/i686-pc-linux-gnu/3.2/man&#34;
INFOPATH=&#34;/usr/share/gcc-data/i686-pc-linux-gnu/3.2/info&#34;
CC=&#34;gcc&#34;
CXX=&#34;g++&#34;
LDPATH=&#34;/usr/lib/gcc-lib/i686-pc-linux-gnu/3.2.3&#34;
</code></pre><p>其他的发行版会让你到/etc/profile或者其他地方修改和添加这些变量的定义。而Gentoo为用户（还有为Portage）提供了更加便捷的方式来维护和管理环境变量，以后你不再需要把精力放在那些众多的包含环境变量的文件身上了。</p><p>比如，当你更新完<strong>gcc</strong> 的时候， /etc/env.d/05gcc也会被同时更新，而不需要你手工来完成。</p><p>这不仅对Portage有益，作为用户，你也是受益者。有时候你需要设置某个系统范围的环境变量。我们拿http_proxy变量来做例子，为了避免http_proxy 搞乱，你只要新建一个文件/etc/env.d/99local然后添加你的定义：</p><pre tabindex=0><code>http_proxy=&#34;proxy.server.com:8080&#34;
</code></pre><p>通过使用同一个文件来定义你所有的变量，你对如何定义自己的变量有了个大概的了解。</p><h4 id=env-update>env-update<a hidden class=anchor aria-hidden=true href=#env-update>#</a></h4><p>/etc/env.d/ 中的好几个文件都定义了PATH变量。这并没有错：当你运行<strong>env-update</strong>的时候，它会在更新环境变量之前把这些定义都追加到PATH里，因此对于软件包（或者用户）来说将会很容易地设置他们自己的环境变量，而不影响到现有变量的值。</p><p><strong>env-update</strong> 脚本会根据 /etc/env.d/ 里文件的字母顺序来附加变量的值。这些文件名必须要以两位数字开头。</p><pre tabindex=0><code>00basic        99kde-env       99local
     +-------------+----------------+-------------+
PATH=&#34;/bin:/usr/bin:/usr/kde/3.2/bin:/usr/local/bin&#34;
</code></pre><p>变量并不总是被串联起来，只有下列变量才会被串联： ADA_INCLUDE_PATH, ADA_OBJECTS_PATH, CLASSPATH, KDEDIRS, PATH, LDPATH, MANPATH, INFODIR, INFOPATH, ROOTPATH, CONFIG_PROTECT, CONFIG_PROTECT_MASK, PRELINK_PATH, PRELINK_PATH_MASK, PKG_CONFIG_PATH,和PYTHONPATH。对于( /etc/env.d/) 里的文件中按照字母顺序排列后）其他所有变量，最新定义的值才会被使用到。</p><p>可以通过将变量名添加到 COLON_SEPARATED or SPACE_SEPARATED （也在 /etc/env.d/ 文件）。</p><p>当你运行 <strong>env-update</strong>的时候，它会在文件/etc/profile.env 里（会被/etc/profile使用）创建所有的环境变量。它也会从变量 LDPATH 中获取信息用来建立/etc/ld.so.conf。这些完成以后，它将运行 <strong>ldconfig</strong>来重建动态链接器需要的文件/etc/ld.so.cache。</p><p>如果你想在运行<strong>env-update</strong>后立即看到效果，执行下面的命令来更新你的环境。自己安装过Gentoo的用户可能已经记住了这个安装指南中提到过的命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># env-update &amp;&amp; source /etc/profile</span>
</span></span></code></pre></div><p><strong>附注</strong>：上面的命令只会更新你当前终端里的环境变量、新控制台以及它们的子程序。因此，假如你正在X11里工作，你要么在每一个你打开的终端里输入<strong>source /etc/profile</strong> ，要么重新启动X，这样所有新的终端才能引用到新的变量。如果你使用了登录管理器，登陆成root然后输入 /etc/init.d/xdm 。如果不是这样，你需要注销然后重新登录回X这样才能产生使用新变量值的子程序。</p><p><strong>重要</strong>：你在定义其他变量时不能使用shell变量。这意味着这样的定义 <code>FOO="$BAR"</code>（此处$BAR 是另外一个变量）是不允许的。</p><h3 id=本地变量的定义>本地变量的定义<a hidden class=anchor aria-hidden=true href=#本地变量的定义>#</a></h3><h4 id=特定用户>特定用户<a hidden class=anchor aria-hidden=true href=#特定用户>#</a></h4><p>你并不是一直都想定义全局变量。比如你想把/home/my_user/bin和当前目录（你当前所在的目录）添加到PATH 变量中，但又不想让其他用户的PATH变量中也有这个。如果你想定义一个本地变量，可以使用 ~/.bashrc 或者~/.bash_profile:</p><pre tabindex=0><code>PATH=&#34;${PATH}:/home/my_user/bin:&#34;
</code></pre><p>当你重新登录的时候，你的PATH变量将被更新。</p><h4 id=特定会话>特定会话<a hidden class=anchor aria-hidden=true href=#特定会话>#</a></h4><p>有时候甚至需要更加严格的定义。你可能要使用一个你临时创建的目录里面的程序，而又不想输入它的路径或者为此短时间内内修改 ~/.bashrc。</p><p>在这种情况下，你只需要在当前会话中使用<strong>export</strong>来定义 PATH 变量。只要你不注销，PATH变量将保持这个临时的设置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># export PATH=&#34;${PATH}:/home/my_user/tmp/usr/bin&#34;</span>
</span></span></code></pre></div><h2 id=ebuild-1>ebuild<a hidden class=anchor aria-hidden=true href=#ebuild-1>#</a></h2><h3 id=gentoo-development-guide-chinesehttpsblogsoymilkfungentoo-development-guide-chinese><a href=https://blog.soymilk.fun/Gentoo-Development-Guide-Chinese/>Gentoo Development Guide Chinese</a><a hidden class=anchor aria-hidden=true href=#gentoo-development-guide-chinesehttpsblogsoymilkfungentoo-development-guide-chinese>#</a></h3><h3 id=ebuild-编写基本指南httpswikigentooorgwikibasic_guide_to_write_gentoo_ebuilds><a href=https://wiki.gentoo.org/wiki/Basic_guide_to_write_Gentoo_Ebuilds>Ebuild 编写基本指南</a><a hidden class=anchor aria-hidden=true href=#ebuild-编写基本指南httpswikigentooorgwikibasic_guide_to_write_gentoo_ebuilds>#</a></h3><p>一个 ebuild 文件是一个文本文件，供 Gentoo 包管理器使用，它标识一个特定的软件包以及 Gentoo 包管理器应该如何处理它。它使用一个 <a href=https://en.wikipedia.org/wiki/Bash_(Unix_shell)>bash</a> 类似语法风格，并通过 <a href=https://wiki.gentoo.org/wiki/EAPI>EAPI</a> 版本进行标准化。</p><p>Gentoo Linux 使用 ebuild 作为单个软件的包管理格式。这些 ebuild 包含相关软件的元数据（软件的名称和版本、软件使用的许可证和主页）、依赖信息（构建时和运行时依赖）以及有关如何处理的说明使用软件（配置、构建、安装、测试&mldr;）。</p><p>Gentoo 中 ebuild 的默认位置是 <a href=https://wiki.gentoo.org/wiki//var/db/repos/gentoo><code>/var/db/repos/gentoo</code></a>/，该位置由<a href=https://wiki.gentoo.org/wiki/Repos.conf>repos.conf</a>文件确定。自定义ebuild建议放在<a href=https://wiki.gentoo.org/wiki/Custom_repository>自定义库</a>中，比如<code>/var/db/repos/larry</code>。</p><p><strong>ebuild</strong> 也是运行各种 <a href=https://devmanual.gentoo.org/ebuild-writing/functions/>ebuild 函数</a> 的 <a href=https://wiki.gentoo.org/wiki/Portage>Portage</a> 命令。通过运行以下命令在本地找到相关信息：</p><pre tabindex=0><code># man 1 ebuild
# man 5 ebuild
</code></pre><p><strong>实时 ebuild</strong></p><p>如果源代码是从修订控制系统 (VCS) 获取的，那么此 ebuild 就是“实时 ebuild”。它们往往（但不一定）具有版本号 9999，以便可以轻松将其与基于上游版本的普通 ebuild 区分开来。</p><p>如果 ebuild 有一个变量 <code>PROPERTIES</code>，其中的值是“live”，那么它就是“实时的”。如果一个 ebuild 继承了一个 VCS eclass（例如 git-r3、mercurial、darcs），它将是实时的，因为这些 eclass 中有一行 <code>PROPERTIES+="live"</code>。</p><p>在 packages.gentoo.org 站点中，实时 ebuild 具有标志 L 。在 eix 的输出中，它用 <code>*l</code> 标记。</p><h4 id=如何创建一个-ebuild>如何创建一个 ebuild<a hidden class=anchor aria-hidden=true href=#如何创建一个-ebuild>#</a></h4><p><a href=https://wiki.gentoo.org/wiki/Vim>vim</a> 的用户自动获取基本骨架（由 <a href=https://packages.gentoo.org/packages/app-vim/gentoo-syntax>app-vim/gentoo-syntax</a> 提供）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># vim ./foobar.ebuild</span>
</span></span></code></pre></div><p>模板</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Copyright 1999-2022 Gentoo Authors</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Distributed under the terms of the GNU General Public License v2</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>EAPI<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>DESCRIPTION<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>HOMEPAGE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>SRC_URI<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>LICENSE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>SLOT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>KEYWORDS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;~amd64 ~x86&#34;</span>
</span></span><span style=display:flex><span>IUSE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>DEPEND<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>RDEPEND<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>DEPEND<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>BDEPEND<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span></code></pre></div><p>GNU Emacs 或 XEmacs 用户可以使用类似的工具（分别由 <a href=https://packages.gentoo.org/packages/app-emacs/ebuild-mode>app-emacs/ebuild-mode</a> 或 <a href=https://packages.gentoo.org/packages/app-xemacs/ebuild-mode>app-xemacs/ebuild-mode</a> 提供）。</p><p>其他编辑器的用户从 skel.ebuild 手动复制：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cp /var/db/repos/gentoo/skel.ebuild ./foobar.ebuild</span>
</span></span></code></pre></div><p>应该知道新包的基本信息，并将其添加到 <a href=https://devmanual.gentoo.org/ebuild-writing/variables/index.html#ebuild-defined-variables>ebuild-defined variables</a>。</p><h4 id=给定源压缩包示例>给定源压缩包示例<a hidden class=anchor aria-hidden=true href=#给定源压缩包示例>#</a></h4><p>为 <a href=https://github.com/chaos/scrub>Scrub</a> 创建一个 ebuild：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># mkdir -p /var/db/repos/larry/app-misc/scrub</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cd $_</span>
</span></span><span style=display:flex><span><span style=color:#75715e># vim ./scrub-2.6.1.ebuild</span>
</span></span></code></pre></div><p>模板</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Copyright 1999-2022 Gentoo Authors</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Distributed under the terms of the GNU General Public License v2</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>EAPI<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>DESCRIPTION<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Some words here&#34;</span>
</span></span><span style=display:flex><span>HOMEPAGE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://github.com/chaos/scrub&#34;</span>
</span></span><span style=display:flex><span>SRC_URI<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://github.com/chaos/scrub/releases/download/2.6.1/scrub-2.6.1.tar.gz&#34;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>LICENSE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;GPL-2&#34;</span>
</span></span><span style=display:flex><span>SLOT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>KEYWORDS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;~amd64 ~x86&#34;</span>
</span></span><span style=display:flex><span>IUSE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>DEPEND<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>RDEPEND<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>DEPEND<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>BDEPEND<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span></code></pre></div><p>允许在SRC_URI中使用<a href=https://devmanual.gentoo.org/ebuild-writing/variables/><code>${PN}</code> variable</a>，但不建议。虽然它可能会缩小这条线，但一些 <a href=https://projects.gentoo.org/qa/policy-guide/ebuild-format.html#pg0103>reasoning why not to use it</a>也值得考虑。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SRC_URI<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://github.com/chaos/</span><span style=color:#e6db74>${</span>PN<span style=color:#e6db74>}</span><span style=color:#e6db74>/releases/download/</span><span style=color:#e6db74>${</span>PV<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>P<span style=color:#e6db74>}</span><span style=color:#e6db74>.tar.gz&#34;</span>
</span></span></code></pre></div><p>可以使用<a href=https://dev.gentoo.org/~zmedico/portage/doc/man/ebuild.1.html>ebuild</a>命令来测试它:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ebuild ./scrub-2.6.1.ebuild clean unpack</span>
</span></span></code></pre></div><p>这应该下载并解压源压缩包。在极少数情况下，包应该可以工作，并且不需要在 ebuild 中进一步调整。</p><h4 id=打补丁>打补丁<a hidden class=anchor aria-hidden=true href=#打补丁>#</a></h4><p>如果源代码需要打补丁，可以从 <a href=https://wiki.gentoo.org/wiki/Patches>patches</a>文章中解释的解压源代码创建补丁。</p><p>补丁将被列在一个名为PATCHES的数组中，正如<a href=https://devmanual.gentoo.org/ebuild-writing/functions/src_prepare/epatch/index.html>devmanual</a>中所解释的那样。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PATCHES<span style=color:#f92672>=(</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>FILESDIR<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>/<span style=color:#e6db74>${</span>P<span style=color:#e6db74>}</span>-foo.patch
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>FILESDIR<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>/<span style=color:#e6db74>${</span>P<span style=color:#e6db74>}</span>-bar.patch
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>src_prepare<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    default
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=初探-ebuildhttpssegmentfaultcoma1190000003819421><a href=https://segmentfault.com/a/1190000003819421>初探 ebuild</a><a hidden class=anchor aria-hidden=true href=#初探-ebuildhttpssegmentfaultcoma1190000003819421>#</a></h3><p>2015-10-05</p><p>无论你使用过多少/多久其他的 Linux 发行版，初次接触 Gentoo 时，极有可能会觉得它在软件包的安装方面很神奇。若要在 Gentoo 中安装一个软件包，通常要定义如何进行软件源代码包的下载、解包、打补丁、编译、安装以及合并。为了实现对软件包进行细微的定制，还需要定义一些有用的元数据（即 USE 旗标）、补丁文件以及一些操控软件包编译与安装的过程。Gentoo 是通过 GNU Bash shell 脚本来定义这一切，这种脚本就是所谓的 ebuild 文件。</p><h4 id=ebuild-在哪里>ebuild 在哪里？<a hidden class=anchor aria-hidden=true href=#ebuild-在哪里>#</a></h4><p>我们在安装 Gentoo 时，一个必须的步骤是下载一个 Portage 树的镜像包，解包后通常安置于 <code>/var/db/repos/gentoo</code> 目录，之后每次执行 <code>emerge --sync</code> 时，便会根据官方远程网站上的 Portage 树来更新你本地的 Portage 树。</p><p>粗枝大叶的看，Portage 树有四层结点。根结点便是 <code>/var/db/repos/gentoo</code> 目录，第 2 层结点是软件包所属分类目录，第 3 层结点是软件包的名称目录，叶子结点则是 ebuild 文件以及其他辅助性文件或目录。以 <code>gnome-shell-3.12.2.ebuild</code> 文件为例，它在 Portage 树中的完整路径是 <code>/var/db/repos/gentoo/gnome-base/gnome-shell/gnome-shell-41.1.ebuild</code>。</p><p>对于我们期望的软件包，如果 Portage 树未提供针对它的 ebuild 文件，那么我们需要自己动手丰衣足食。一般是不建议将我们所写的 ebuild 文件放在 Portage 树中的，因为它们可能会在 <code>emerge --sync</code> 期间被冲刷（比如被官方的同名文件替换）。</p><p>Portage 树支持一种被称为 Overlay 的技术。简单来说，就是我们可以另行建立一棵新的 Portage 树，这棵树的规模虽然比官方的 Portage 树小很多，但是 Portage 树的管理系统可以将这可新的 Portage 树与官方 Portage 树『合并』。如果新的 Portage 树中某些结点与官方的 Portage 树存在重叠，那么 Portage 树的管理系统会以前者覆盖后者，因此我们新建的 Portage 树通常被直呼为『Overlay』。</p><h4 id=建立自己的-overlay>建立自己的 Overlay<a hidden class=anchor aria-hidden=true href=#建立自己的-overlay>#</a></h4><p>在 <code>/var/db/repos/</code> 目录中创建自己的 Overlay：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># mkdir -p /var/db/repos/localrepo/{metadata,profiles}</span>
</span></span><span style=display:flex><span><span style=color:#75715e># chown -R portage:portage /var/db/repos/localrepo</span>
</span></span></code></pre></div><p>在该 <code>/var/db/repos/localrepo/profiles/</code> 内添加 <code>repo_name</code> 文件。我们可以在这份文件中设置 Overlay 名称，只需将 Overlay 名称写入该文件即可。例如，我将我的 Overlay 命名为 <code>localrepo</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># echo &#39;localrepo&#39; &gt; /var/db/repos/localrepo/profiles/repo_name</span>
</span></span></code></pre></div><p>为了让我们的 Overlay 能够被 Portage 管理系统所接受，需要在 <code>/var/db/repos/localrepo/metadata/layout.conf</code> 内添加：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>masters</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>gentoo</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>auto-sync</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>false</span>
</span></span></code></pre></div><p>需要将 Overlay 路径告知 Portage 管理系统，即在 <code>/etc/portage/repos.conf/localrepo.conf</code> 文件中添加以下代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[localrepo]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>location</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/var/db/repos/localrepo</span>
</span></span></code></pre></div><p>今后，就在这个 Overlay 中学习 ebuild 文件的编写。</p><h4 id=hello-world>Hello World!<a hidden class=anchor aria-hidden=true href=#hello-world>#</a></h4><p>下面通过写一个非常简单的 ebuild 文件来获取一些直观的认识。假设在 <code>app-misc</code> 这个分类中有一个名为 <code>hello-world</code> 的软件包，现在我们要为这个软件包的 1.0 版的安装写一份 ebuild 文件。</p><blockquote><p>注意：软件包的分类名并不是随意的，它必须要与 <code>/var/db/repos/gentoo</code> 中的某个子目录名一致。</p></blockquote><p>首先在 Overlay 中建立软件包所在的分支：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># mkdir -p /var/db/repos/localrepo/app-misc/hello-world</span>
</span></span></code></pre></div><p>可从 <code>/var/db/repos/gentoo/header.txt</code> 文件中获得 ebuild 文件默认的文件头，即：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span><span style=color:#75715e># Copyright 2021 Gentoo Authors</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Distributed under the terms of the GNU General Public License v2</span>
</span></span></code></pre></div><p>只不过是一些 Bash 脚本注释形式的文件描述信息而已，但它们是必须的。可以直接将 <code>/var/db/repos/gentoo/header.txt</code> 文件复制为 <code>hello-world-1.0.ebuild</code> 文件，这样便可获得一个含有上述内容的空 ebuild 文件。ebuild 文件的名称必须符合 Portage 所认可的格式，即：<code>软件包名称-版本号.ebuild</code>。这一点很重要。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cp /var/db/repos/gentoo/header.txt /var/db/repos/localrepo/app-misc/hello-world/hello-world-1.0.ebuild</span>
</span></span></code></pre></div><p>下面，为这份 ebuild 文件增加以下内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SLOT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span></code></pre></div><p>这样，我们便建立了一份最为简单的 ebuild 文件。接下来就是在这份文件上签个字……也就是为之生成一份签名文件，表示这个 ebuild 的是我们做的，出了事我们负责。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cd /var/db/repos/localrepo/app-misc/hello-world</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ebuild ./hello-world-1.0.ebuild manifest</span>
</span></span></code></pre></div><p>若签名成功，会在 ebuild 文件同一目录中生成一份名为 <code>Manifest</code> 的文件。将来发布这份 ebuild 文件时，需要将数字签名文件一起发出，这样他人便可以验证这份 ebuild 是不是我们做的。因为非常有可能我们在向朋友们发送 ebuild 文件的过程中会被坏人拦截，然后篡改 ebuild 文件。由于 ebuild 是可被系统执行的脚本，因此很有可能变成『病毒』。因此，ebuild 文件的数字签名非常有必要。不过，这里为了简单起见，没有涉及如何用自己的密钥实现对 ebuild 的签名，所得 <code>Manifest</code> 文件仅仅是为了让 ebuild 能够被 Portage 管理系统所认可。</p><p>下面，继续向这份 ebuild 加入一些内容，使之变为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#75715e># Copyright 2021 Gentoo Authors</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Distributed under the terms of the GNU General Public License v2</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#a6e22e>EAPI</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;7&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SLOT</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>DESCRIPTION</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;A classical example to use when starting on something new.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>HOMEPAGE</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://wiki.gentoo.org/index.php?title=Basic_guide_to_write_Gentoo_Ebuilds&#34;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#a6e22e>LICENSE</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;MIT&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>KEYWORDS</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;~alpha ~amd64 ~arm ~hppa ~ia64 ~ppc ~ppc64 ~s390 ~sh ~sparc ~x86&#34;</span>
</span></span></code></pre></div><p>基本上就是在原来那份最简单的 ebuild 文件的基础上增加了几个变量：</p><ul><li><code>EAPI</code>：Portage 系统已经为我们编写了许多有用的 Bash 函数，将 <code>EAPI</code> 的值设为 <code>7</code> 表示我们要用目前最新的 Bash 函数。这个变量必须要在 ebuild 文件头之后进行设定。</li><li><code>DESCRIPTION</code>：这个变量存储了 <code>hello-world</code> 这个软件包的简介信息。</li><li><code>HOMEPAGE</code>：定义了 <code>hello-world</code> 这个软件包的项目主页。</li><li><code>LICENSE</code>：定义了 <code>hello-world</code> 这个软件包所使用的许可证，例如 LGPL，GPL V2，GPL V3，MIT 等。</li><li><code>KEYWORDS</code>：如果你期望 <code>hello-world</code> 这个软件包能够安装在你的机器上，那么 <code>KEYWORDS</code> 变量的值必须要包含你在 <code>/etc/make.conf</code> 中所设定的 <code>ACCEPT_KEYWORDS</code> 值。</li></ul><p>一旦改动了 ebuild 文件内容，那么必须重新生成 <code>Manifest</code> 文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ebuild ./hello-world-1.0.ebuild manifest</span>
</span></span></code></pre></div><p>现在，便可以使用 <code>emerge</code> 命令安装这个目前依然是子虚乌有的软件包了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge -a hello-world</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>These are the packages that would be merged, in order:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Calculating dependencies... <span style=color:#66d9ef>done</span>!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ebuild  N    ~<span style=color:#f92672>]</span> app-misc/hello-world-1.0::localrepo  <span style=color:#ae81ff>0</span> KiB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Total: <span style=color:#ae81ff>1</span> package <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> new<span style=color:#f92672>)</span>, Size of downloads: <span style=color:#ae81ff>0</span> KiB
</span></span></code></pre></div><p>虽然到现在为止，还是什么也没有做出来，但是看着 <code>emerge</code> 神奇的发现了我写的 <code>ebuild</code>，心底还是蔓生了一些幸福。</p><h4 id=emerge-与-ebuild-有什么联系>emerge 与 ebuild 有什么联系？<a hidden class=anchor aria-hidden=true href=#emerge-与-ebuild-有什么联系>#</a></h4><p>简单的说，就是 <code>emerge</code> 这个 Python 脚本会调用 <code>ebuild.sh</code> 这个 Bash 脚本，让后者去执行 ebuild 文件定义的软件包的下载、编译及安装过程。</p><p><img loading=lazy src=/Distributions/2056857414-5611b125e4a99_fix732.png alt></p><p><code>ebuild.sh</code> 所操控的软件包安装过程是在一个沙箱（Sandbox）中进行的。这一过程结束后，<code>emerge</code> 脚本需要将沙箱中的成果转移到真实世界，即 <code>/</code> 目录。</p><h3 id=slothttpswikitankywoocomlinuxgentoohtmlslot><a href=https://wiki.tankywoo.com/linux/gentoo.html#slot>SLOT</a><a hidden class=anchor aria-hidden=true href=#slothttpswikitankywoocomlinuxgentoohtmlslot>#</a></h3><p>SLOT, 即「槽」, 和具体某个包相关的概念, 是Gentoo实现多版本共存的基础。</p><p><code>0</code> 是默认的slot名, 表示没有使用slot;</p><p>slot名是空字符串表示彻底禁止使用slot;</p><p>带有slot的包, 包名后面会有<code>:</code>冒号分隔, 并带上slot, 如:</p><pre tabindex=0><code>dev-python/dnspython-1.12.0-r200:py2
dev-python/dnspython-1.12.0-r300:py3
</code></pre><p>表示dnspython这个包分别有py2和py3两个slot。</p><p>相关的一些命令:</p><p><code>eix</code> 可以直接查看包的所有slot:</p><pre tabindex=0><code>$ eix dnspython
* dev-python/dnspython
     Available versions:
     (py2)  1.12.0-r200
     (py3)  1.12.0-r300
       {examples test PYTHON_TARGETS=&#34;python2_7 python3_3 python3_4&#34;}
     Homepage:            http://www.dnspython.org/ https://pypi.python.org/pypi/dnspython
     Description:         DNS toolkit for Python
</code></pre><p><code>equery list -p</code>:</p><pre tabindex=0><code>$ equery l -po dnspython
 * Searching for dnspython ...
[-P-] [  ] dev-python/dnspython-1.12.0-r200:py2
[-P-] [  ] dev-python/dnspython-1.12.0-r300:py3
[-P-] [ ~] dev-python/dnspython-1.12.0-r301:py3
</code></pre><p><code>equery keywords</code>:</p><pre tabindex=0><code>$ equery keywords dnspython
Keywords for dev-python/dnspython:
            |                                 | u     |
            | a a   a         n   p r     s   | n     |
            | l m   r h i m m i   p i s   p   | u s   | r
            | p d a m p a 6 i o p c s 3   a x | s l   | e
            | h 6 r 6 p 6 8 p s p 6 c 9 s r 8 | e o   | p
            | a 4 m 4 a 4 k s 2 c 4 v 0 h c 6 | d t   | o
------------+---------------------------------+-------+-------
1.12.0-r200 | + + + ~ + + o o o + + o ~ ~ + + | o py2 | gentoo
------------+---------------------------------+-------+-------
1.12.0-r300 | + + + ~ + + o o o + + o ~ ~ + + | o py3 | gentoo
1.12.0-r301 | ~ ~ ~ ~ ~ ~ o o o ~ ~ o ~ ~ ~ ~ | o     | gentoo
</code></pre><h4 id=真实的-hello-world>真实的 Hello World！<a hidden class=anchor aria-hidden=true href=#真实的-hello-world>#</a></h4><p>在一个遥远的地方，真的存在着 hello-world 的源码包。我们只要通过 ebuild 文件将这个源码包的位置告诉 <code>ebuild.sh</code> 脚本，<code>ebuild.sh</code> 便会不远万里将其擒来。所以，我们需要在 <code>hello-world-1.0.ebuild</code> 文件中添加以下内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>SRC_URI</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://gitlab.com/alogim/gentoo-basic-ebuild/-/raw/master/update1/hello-world-1.0.tar.gz?inline=false&#34;</span>
</span></span></code></pre></div><p><code>SRC_URI</code> 这个变量便是存储源码包的下载地址的。</p><p>在重新生成 <code>Manifest</code> 时，<code>ebuild.sh</code> 便会自动将源码包下载到 <code>/var/cache/distfiles/</code> 目录，并为这个源码包也生成一个数字签名存储在 <code>Manifest</code> 文件中。</p><p>既然有了 <code>hello-world</code> 的源码包，那么下一步就该思考如何在 ebuild 文件中定义这个源码包的编译过程了。不过，解开刚才下载的 <code>hello-world-1.0.tar.gz</code> 包看一下，发现包里只有一份 Bash 脚本 <code>hello-world</code>，其内容为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Hello world!&#34;</span>
</span></span></code></pre></div><p>所以，这个源码包就没必要编译了，直接安装到系统中即可。从而，我们在 ebuild 文件中获得了第一次编写 ebuild 函数的机会。在现有的 <code>hello-world-1.0.ebuile</code> 的文件中继续添加以下内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>src_install<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    dobin hello-world
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>src_install</code> 是 <code>ebuild.sh</code> 脚本能够识别并执行的函数名。也就是说，从 <code>ebuild.sh</code> 脚本的角度来看，你若想让我替你将软件包安装至系统中，那么你必须得按照我的习惯来。我的习惯就是在你提供给我的 ebuild 文件中寻找 <code>src_install</code> 这个函数，如果有这个函数，我就执行它，否则我就什么也不做。这就是 <code>ebuild.sh</code> 与 ebuild 文件之间达成的一个约定。</p><p>现在我们在 ebuild 文件中向 <code>ebuild.sh</code> 提供了 <code>src_install</code> 这个函数。这个函数只包含一条命令：<code>dobin hello-world</code> 。这个命令的意思是为 <code>hello-world</code> 这个脚本设置可执行权限，然后将其安装至系统默认的可执行文件目录中，即 <code>/usr/bin</code> 目录。</p><p><code>src_install</code> 只是 <code>ebuild.sh</code> 与 ebuild 文件之间众多约定函数中的一个而已，并且这些约定函数是顺次被 <code>ebuild.sh</code> 执行的，如下图所示：</p><p><img loading=lazy src=/Distributions/4012241762-5611b1511041c_fix732.png alt></p><p>这里存在一个问题，<code>hello-world</code> 这个 Bash 脚本是包含在 <code>hello-world-1.0.tar.gz</code> 这个包内的，而我们只在 <code>hello-world-1.0.ebuild</code> 文件中定义了 <code>src_install</code> 函数，那么 <code>hello-world-1.0.tar.gz</code> 何时被解包的呢？这个问题的答案是，Portage 管理系统中已经为这些约定的函数定义了默认行为。比如，用于为源码包解包的 <code>src_unpack</code> 函数，其默认的定义是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>src_unpack<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>A<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        unpack <span style=color:#e6db74>${</span>A<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>如果在 ebuild 文件中没有重新定义 <code>src_unpack</code> 函数，那么 <code>ebuild.sh</code> 便会按照上面图示的管线调用默认的 <code>src_unpack</code> 函数。所以 <code>hello-world</code> 脚本得以从 <code>hello-world-1.0.tar.gz</code> 中解出。</p><p>对现在的 <code>hello-world-1.0.ebuild</code> 再次生成 <code>Manifest</code>，然后就可以用它将 <code>hello-world</code> 脚本安装至 <code>/usr/bin</code> 目录中了。</p><p>这就是我们用自己写的 ebuild 安装的第一个『软件包』。</p><h2 id=ebuild-repositoryhttpswikigentooorgwikiebuild_repository><a href=https://wiki.gentoo.org/wiki/Ebuild_repository>ebuild repository</a><a hidden class=anchor aria-hidden=true href=#ebuild-repositoryhttpswikigentooorgwikiebuild_repository>#</a></h2><p>An <strong>ebuild repository</strong>, colloquially known as an <strong>overlay</strong>, is a structure of directories and files used to add and extend software packages for a Gentoo-based system.</p><p>Ebuild repositories contain ebuilds, eclasses, and other types of descriptive metadata files. These files inform the package manager of software available for installation, news items, and profile targets. An ebuild repository should conform to one or more <a href=https://wiki.gentoo.org/wiki/EAPI>Ebuild APIs</a> as detailed in Gentoo&rsquo;s <a href=https://wiki.gentoo.org/wiki/Package_Manager_Specification>Package Manager Specification</a>.</p><p>The <em><strong><a href=https://wiki.gentoo.org/wiki/Ebuild_repository#The_Gentoo_ebuild_repository>Gentoo ebuild repository</a></strong></em>, as Gentoo&rsquo;s primary and &ldquo;official&rdquo; repository, is the source for all the information needed to build and install Gentoo packages, contained in <a href=https://wiki.gentoo.org/wiki/Ebuild>ebuilds</a>.</p><p>Administrators of Gentoo systems can add additional ebuild repositories by using various utilities and methods described below.</p><h3 id=the-gentoo-ebuild-repository>The Gentoo ebuild repository<a hidden class=anchor aria-hidden=true href=#the-gentoo-ebuild-repository>#</a></h3><p>The <em>Gentoo ebuild repository</em> will sometimes be called by shorter, or even colloquial, names, such as the <em><strong>Gentoo repository</strong></em>, the <em><strong>Gentoo repo</strong></em>, <em><strong>::gentoo</strong></em>, <em><strong>gentoo.git</strong></em>, or occasionally just the &ldquo;<em><strong>repo</strong></em>&rdquo;. It was historically known within the Gentoo community as the <em>Portage tree</em>, <em>rsync tree</em>, or sometimes just &ldquo;<em>the tree</em>&rdquo;.</p><h3 id=repositories-in-general>Repositories in general<a hidden class=anchor aria-hidden=true href=#repositories-in-general>#</a></h3><p>Repositories are handled through <a href=https://wiki.gentoo.org/wiki//etc/portage/repos.conf>/etc/portage/repos.conf</a> (which, like many other Portage configuration locations, can be a file or a directory), and the <a href=https://wiki.gentoo.org/wiki/Eselect/Repository><strong>eselect repository</strong></a> is is a tool to manage this configuration.</p><p>Repository definitions inside /etc/portage/repos.conf also inform Portage if and how the repository can be updated. With it, calling <strong>emaint sync &ndash;auto</strong> will automatically update the enabled repositories as well.</p><p>A deprecated, yet still supported method is to use the PORTDIR_OVERLAY variable inside /etc/portage/make.conf. This variable can point to one or more additional locations on the file system where additional repositories are available. The use of the <a href=https://wiki.gentoo.org/wiki//etc/portage/repos.conf>/etc/portage/repos.conf</a>/ directory is highly preferred.</p><p>For more information, see <a href=https://wiki.gentoo.org/wiki//etc/portage/repos.conf>/etc/portage/repos.conf</a> and the <a href=https://wiki.gentoo.org/wiki/Project:Portage/Sync#Operation>Portage/Sync article</a>.</p><h4 id=priorities>Priorities<a hidden class=anchor aria-hidden=true href=#priorities>#</a></h4><p>Ebuilds from repositories with higher priority numbers (for example <code>60</code>) will take precedence over ebuilds from repositories with lower priorities (such as <code>50</code>).</p><p>The list of ebuild repositories with their priorities can be obtained through the output of the following commands (look for the &ldquo;Repositories&rdquo; string):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --info --verbose</span>
</span></span><span style=display:flex><span><span style=color:#75715e># portageq repos_config /</span>
</span></span></code></pre></div><p>The Gentoo ebuild repository will have a priority of <code>-1000</code> which means that all other repositories generally take precedence if they are assigned a higher priority. This is the default behaviour, because ebuild repositories are designed to &ldquo;lay over&rdquo; or &ldquo;on top&rdquo; of the Gentoo repository. To set the priority of other repositories, manually edit the relevant repos.conf section and set <strong>priority =</strong> to the desired value. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># nano -w /etc/portage/repos.conf/eselect-repo.conf</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>guru<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>location <span style=color:#f92672>=</span> /var/db/repos/guru
</span></span><span style=display:flex><span>sync-type <span style=color:#f92672>=</span> git
</span></span><span style=display:flex><span>sync-uri <span style=color:#f92672>=</span> https://github.com/gentoo-mirror/guru.git
</span></span><span style=display:flex><span>priority <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>
</span></span></code></pre></div><p>Repositories that do not have a priority set default to 0.</p><h3 id=repository-synchronization>Repository synchronization<a hidden class=anchor aria-hidden=true href=#repository-synchronization>#</a></h3><p>Repository synchronization is generally managed with the <strong>emaint sync</strong> command. See the <a href=https://wiki.gentoo.org/wiki/Project:Portage/Sync#Operation>Portage sync</a> article, and <strong>man emaint</strong> for information on how to use the portage synchronization commands.</p><p>The <strong>emerge &ndash;sync</strong> command is now only a compatibility command, calling the emaint module. <strong>eix-sync</strong> is a wrapper using <strong>emerge &ndash;sync</strong>, followed by <strong>eix-update</strong>. For further details see the <a href=https://wiki.gentoo.org/wiki/Eix>Eix</a> article and <strong>man eix</strong>.</p><p>The <a href=https://wiki.gentoo.org/wiki/Portage#emerge-webrsync>emerge-webrsync</a> tool can be used to download and install the daily Gentoo Repository snapshot. This may help with firewall restrictions.</p><h3 id=repository-management-tools>Repository management tools<a hidden class=anchor aria-hidden=true href=#repository-management-tools>#</a></h3><h4 id=eselect-repository>eselect-repository<a hidden class=anchor aria-hidden=true href=#eselect-repository>#</a></h4><p><a href=https://wiki.gentoo.org/wiki/Eselect/Repository><strong>eselect repository</strong></a> maintains /etc/portage/repos.conf entries for Portage to access and synchronize.</p><h4 id=layman>Layman<a hidden class=anchor aria-hidden=true href=#layman>#</a></h4><p><a href=https://wiki.gentoo.org/wiki/Eselect/Repository><strong>eselect repository</strong></a> supersedes layman for most uses.</p><h3 id=usage>Usage<a hidden class=anchor aria-hidden=true href=#usage>#</a></h3><h4 id=emerging-a-duplicate-package>Emerging a duplicate package<a hidden class=anchor aria-hidden=true href=#emerging-a-duplicate-package>#</a></h4><p>When working with ebuild repositories it is possible to encounter a situation where multiple versions of the same package are available from different ebuild repositories. Instruct <a href=https://wiki.gentoo.org/wiki/Portage>Portage</a> to install a specific package from a specific ebuild repository with the <code>::</code> <a href=https://wiki.gentoo.org/wiki/Version_specifier#By_ebuild_repository>version specifier</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --ask category/atom::repository-name</span>
</span></span></code></pre></div><p>The same notation can be used for different emerge instructions, including uninstalling a package through <code>--depclean</code>.</p><h3 id=best-practices>Best practices<a hidden class=anchor aria-hidden=true href=#best-practices>#</a></h3><h4 id=cache-generation>Cache generation<a hidden class=anchor aria-hidden=true href=#cache-generation>#</a></h4><p>When large ebuild repositories are installed, Portage may take a long time to perform operations like dependency resolution. This is because ebuild repositories do not usually contain a metadata cache.</p><p>Generate a local metadata cache by running <strong>emerge &ndash;regen</strong> after syncing the ebuild repositories:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emaint sync --allrepos</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ( ulimit -n 4096 &amp;&amp; emerge --regen )</span>
</span></span></code></pre></div><p>Be careful, because <strong>emerge &ndash;regen</strong> takes a lot of time and it&rsquo;s not recommended for rsync users as rsync updates the cache using server-side caches (most of users of portage are rsync users). Rsync users should simply run <strong>emerge &ndash;sync</strong> (or <strong>eix-sync</strong>) to regenerate the cache. It&rsquo;s probably only users of very large ebuild repositories should try <strong>emerge &ndash;regen</strong>.</p><h4 id=masking-enabled-ebuild-repositories>Masking enabled ebuild repositories<a hidden class=anchor aria-hidden=true href=#masking-enabled-ebuild-repositories>#</a></h4><p>When using <em>large</em> ebuild repositories or those with <em>unknown/low quality code</em>, it is best practice to hard mask the whole ebuild repository and only accept specific ebuilds on a case-by-case basis. For example, for an overlay named &ldquo;repository-foobar&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># nano -w /etc/portage/package.mask/repository-foobar</span>
</span></span><span style=display:flex><span>*/*::repository-foobar
</span></span></code></pre></div><p>Then add the specific package(s) from the repository-foobar overlay so that they will be available visible to Portage for installation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># nano -w /etc/portage/package.unmask/bar</span>
</span></span><span style=display:flex><span>foo-category/bar::repository-name
</span></span></code></pre></div><p>After the above unmask the package named &ldquo;foo-category/bar&rdquo; should be available and none of the other packages from the repository-foobar overlay will be available, which is by design.</p><h2 id=gentoo-on-zfshttpswikigentooorgwikiuserali3nxinstalling_gentoo_linux_efistub_on_zfs><a href=https://wiki.gentoo.org/wiki/User:Ali3nx/Installing_Gentoo_Linux_EFISTUB_On_ZFS>Gentoo on ZFS</a><a hidden class=anchor aria-hidden=true href=#gentoo-on-zfshttpswikigentooorgwikiuserali3nxinstalling_gentoo_linux_efistub_on_zfs>#</a></h2><h3 id=备份httpswwwyafamoepostbackup-your-gentoo-system><a href=https://www.yafa.moe/post/backup-your-gentoo-system/>备份</a><a hidden class=anchor aria-hidden=true href=#备份httpswwwyafamoepostbackup-your-gentoo-system>#</a></h3><h4 id=初始化硬盘>初始化硬盘<a hidden class=anchor aria-hidden=true href=#初始化硬盘>#</a></h4><p>这里的初始化硬盘是为了将原来的数据全部清除并且重新建立LUKS和文件系统。出于安全的考虑，备份不应该直接在硬盘上分区创建文件系统后备份在上面，应该做一层加密再去创建文件系统和备份。</p><p>将硬盘插入需要备份的电脑上</p><p>查看新增的设备</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ fdisk -l
</span></span><span style=display:flex><span>Disk /dev/sda: 232.9 GiB, <span style=color:#ae81ff>250055122432</span> bytes, <span style=color:#ae81ff>488388911</span> sectors
</span></span><span style=display:flex><span>Disk model: 00AAJS-00B4A0
</span></span><span style=display:flex><span>Units: sectors of <span style=color:#ae81ff>1</span> * 512 <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span> bytes
</span></span><span style=display:flex><span>Sector size <span style=color:#f92672>(</span>logical/physical<span style=color:#f92672>)</span>: <span style=color:#ae81ff>512</span> bytes / <span style=color:#ae81ff>512</span> bytes
</span></span><span style=display:flex><span>I/O size <span style=color:#f92672>(</span>minimum/optimal<span style=color:#f92672>)</span>: <span style=color:#ae81ff>512</span> bytes / <span style=color:#ae81ff>512</span> bytes
</span></span><span style=display:flex><span>Disklabel type: dos
</span></span><span style=display:flex><span>Disk identifier: 0x80f01a9c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Device     Boot Start       End   Sectors   Size Id Type
</span></span><span style=display:flex><span>/dev/sda1        <span style=color:#ae81ff>2048</span> <span style=color:#ae81ff>488388910</span> <span style=color:#ae81ff>488386863</span> 232.9G <span style=color:#ae81ff>83</span> Linux
</span></span></code></pre></div><p>这里可以看到新添加的磁盘，上面是有以前的东西，这里为了安全起见用随机数据覆盖掉这个分区。 这里会清除可能存在的任何没有加密的旧数据，如果遭受攻击这会让攻击者更难确定数据位置，这一步会很慢（取决于你的接口速度和硬盘速率）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/urandom of<span style=color:#f92672>=</span>/dev/sda bs<span style=color:#f92672>=</span>1M status<span style=color:#f92672>=</span>progress <span style=color:#f92672>&amp;&amp;</span> sync
</span></span></code></pre></div><p>完成之后，我们需要重新对这个硬盘进行分区</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo fdisk /dev/sda
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Welcome to fdisk <span style=color:#f92672>(</span>util-linux 2.35.2<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>Changes will remain in memory only, <span style=color:#66d9ef>until</span> you decide to write them.
</span></span><span style=display:flex><span>Be careful before using the write command.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Command <span style=color:#f92672>(</span>m <span style=color:#66d9ef>for</span> help<span style=color:#f92672>)</span>: n
</span></span><span style=display:flex><span>Partition type
</span></span><span style=display:flex><span>   p   primary <span style=color:#f92672>(</span><span style=color:#ae81ff>0</span> primary, <span style=color:#ae81ff>0</span> extended, <span style=color:#ae81ff>4</span> free<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   e   extended <span style=color:#f92672>(</span>container <span style=color:#66d9ef>for</span> logical partitions<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Select <span style=color:#f92672>(</span>default p<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Using default response p.
</span></span><span style=display:flex><span>Partition number <span style=color:#f92672>(</span>1-4, default 1<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>First sector <span style=color:#f92672>(</span>2048-488388910, default 2048<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>Last sector, +/-sectors or +/-size<span style=color:#f92672>{</span>K,M,G,T,P<span style=color:#f92672>}</span> <span style=color:#f92672>(</span>2048-488388910, default 488388910<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Created a new partition <span style=color:#ae81ff>1</span> of type <span style=color:#e6db74>&#39;Linux&#39;</span> and of size 232.9 GiB.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Command <span style=color:#f92672>(</span>m <span style=color:#66d9ef>for</span> help<span style=color:#f92672>)</span>: w
</span></span><span style=display:flex><span>The partition table has been altered.
</span></span><span style=display:flex><span>Calling ioctl<span style=color:#f92672>()</span> to re-read partition table.
</span></span><span style=display:flex><span>Syncing disks.
</span></span></code></pre></div><p>这样就创建了一个分区，接下来我们要在这个分区上创建LUKS</p><h4 id=创建-luks>创建 LUKS<a hidden class=anchor aria-hidden=true href=#创建-luks>#</a></h4><p>我们这里可以使用<code>cryptsetup</code>这个命令来初始化我们的LUKS分区</p><p>如果你没有这个命令可以运行这条命令进行安装：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ emerge -av cryptsetup
</span></span></code></pre></div><p>然后初始化分区</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo cryptsetup luksFormat /dev/sda1
</span></span><span style=display:flex><span>WARNING!
</span></span><span style=display:flex><span><span style=color:#f92672>========</span>
</span></span><span style=display:flex><span>This will overwrite data on /dev/sda1 irrevocably.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Are you sure? <span style=color:#f92672>(</span>Type <span style=color:#e6db74>&#39;yes&#39;</span> in capital letters<span style=color:#f92672>)</span>: YES
</span></span><span style=display:flex><span>Enter passphrase <span style=color:#66d9ef>for</span> /dev/sda1:
</span></span><span style=display:flex><span>Verify passphrase:
</span></span></code></pre></div><p>这里会提示这个操作将会将这个分区里面的内容全部删掉，输入大写的YES确认，然后输入两次密码，注意密码是没有回显的。</p><h4 id=打开-luks-和创建文件系统>打开 LUKS 和创建文件系统<a hidden class=anchor aria-hidden=true href=#打开-luks-和创建文件系统>#</a></h4><p>现在是LUKS已经做好了，但是我们还需要在上面格式化分区才能够挂载使用，我们首先要打开LUKS分区：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo cryptsetup luksOpen /dev/sda1 backup
</span></span><span style=display:flex><span>Password:
</span></span><span style=display:flex><span>Enter passphrase <span style=color:#66d9ef>for</span> /dev/sda1:
</span></span></code></pre></div><p>我这里是想打开这个LUKS卷，为了区分和其他的我给这个名字叫做backup，然后会提示你输入LUKS的密码，正确输入之后就可以在<code>/dev/mappaer</code>下面看到一个<code>backup</code>的设备了</p><p>现在对这个分区进行格式化，这次用的是ext4的分区</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo mkfs.ext4 -v /dev/mapper/backup
</span></span></code></pre></div><h4 id=创建挂载点和挂载>创建挂载点和挂载<a hidden class=anchor aria-hidden=true href=#创建挂载点和挂载>#</a></h4><p>在完成了分区初始化之后我们还需要创建一个挂载点用于挂载这个备份的分区:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo mkdir -pv /backup
</span></span></code></pre></div><p>挂载分区:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo mount -v /dev/mapper/backup /backup
</span></span></code></pre></div><h4 id=备份系统>备份系统<a hidden class=anchor aria-hidden=true href=#备份系统>#</a></h4><p>下载就可以备份系统了，这次使用的是<code>rsync</code>工具来进行备份系统：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo rsync -aAXv --exclude<span style=color:#f92672>={</span><span style=color:#e6db74>&#34;/dev/*&#34;</span>,<span style=color:#e6db74>&#34;/proc/*&#34;</span>,<span style=color:#e6db74>&#34;/sys/*&#34;</span>,<span style=color:#e6db74>&#34;/tmp/*&#34;</span>,<span style=color:#e6db74>&#34;/run/*&#34;</span>,<span style=color:#e6db74>&#34;/mnt/*&#34;</span>,<span style=color:#e6db74>&#34;/media/*&#34;</span>,<span style=color:#e6db74>&#34;/lost+found&#34;</span>,<span style=color:#e6db74>&#34;/backup/*&#34;</span>,<span style=color:#e6db74>&#34;/swapfile&#34;</span><span style=color:#f92672>}</span> / /backup
</span></span></code></pre></div><p>这里使用的<code>-aAXv</code>选项的意思是：文件将会以归档模式传输，保留符号设备，文件权限，修改时间，ACL和扩展属性，并且将备份的过程打印在屏幕上。</p><p><code>--exclude</code>就是排除特定的文件类似于<code>/dev</code>、<code>/proc</code>之类的，<code>/backup</code>是我们的备份分区不需要再去搞一份防止出现奇奇怪怪的后果。</p><p>这会耗费很多时间可以休息一下做其他的事情。</p><p>等待这个备份完成之后我们就可以卸载这块硬盘进行保存了。</p><p>卸载挂载点</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ umount /backup
</span></span></code></pre></div><p>关闭LUKS分区</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cryptsetup luksClose backup
</span></span></code></pre></div><h3 id=迁移到-zfshttpswwwyafamoepostgentoo-on-zfs><a href=https://www.yafa.moe/post/gentoo-on-zfs/>迁移到 ZFS</a><a hidden class=anchor aria-hidden=true href=#迁移到-zfshttpswwwyafamoepostgentoo-on-zfs>#</a></h3><h4 id=分区>分区<a hidden class=anchor aria-hidden=true href=#分区>#</a></h4><p>首先我需要把之前的分区全部干掉，然后创建如下表的分区：</p><table><thead><tr><th>分区</th><th>文件系统</th><th>大小</th></tr></thead><tbody><tr><td>/dev/nvme0n1p1</td><td>fat32</td><td>128M</td></tr><tr><td>/dev/nvme0n1p2</td><td>swap</td><td>64G</td></tr><tr><td>/dev/nvme0n1p3</td><td>ZFS</td><td>ALL</td></tr></tbody></table><p>直接在系统里面丢swapfile是不合理的，最好是有个单独的分区给swap。</p><h5 id=初始化分区>初始化分区<a hidden class=anchor aria-hidden=true href=#初始化分区>#</a></h5><p>创建完成分区之后我们还需要对分区进行初始化：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkfs.vfat -F32 /dev/nvme0n1p1
</span></span><span style=display:flex><span>$ mkswap /dev/nvme0n1p2
</span></span></code></pre></div><h5 id=创建-pool>创建 pool<a hidden class=anchor aria-hidden=true href=#创建-pool>#</a></h5><p>这里需要注意一点是像是我们之前分区的<code>/dev/nvme0n</code>这种设备或者是<code>/dev/sda</code>这样的，如果插拔U盘之类的可能盘序会发生变化，但是ZFS池是不会意识到这个变化的，这样就会产生zfs池不可用的问题，我们需要一些方法来获取到磁盘的id并以此来创建我们的zfs池。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -l /dev/disk/by-id
</span></span><span style=display:flex><span>lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>13</span> Feb <span style=color:#ae81ff>13</span> 12:29 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM -&gt; ../../nvme0n1
</span></span><span style=display:flex><span>lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>15</span> Feb <span style=color:#ae81ff>13</span> 12:32 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part1 -&gt; ../../nvme0n1p1
</span></span><span style=display:flex><span>lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>15</span> Feb <span style=color:#ae81ff>13</span> 12:29 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part2 -&gt; ../../nvme0n1p2
</span></span><span style=display:flex><span>KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part3 -&gt; ../../nvme0n1p3
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>这里的<code>KXG50PNV2T04_KIOXIA_Y9IS103FTHDM</code>就是我们的硬盘，<code>nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part1</code>就是我们创建作为未来的<code>/boot</code>分区。</p><p>当我们创建zfs池的时候尽可能选择用这种id的方式去创建。现在我们创建一个加密的zpool：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zpool create -f -o ashift<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span> -o cachefile<span style=color:#f92672>=</span>/etc/zfs/zpool.cache -O compression<span style=color:#f92672>=</span>lz4 -O xattr<span style=color:#f92672>=</span>sa -O relatime<span style=color:#f92672>=</span>on -O acltype<span style=color:#f92672>=</span>posixacl -O dedup<span style=color:#f92672>=</span>off -O encryption<span style=color:#f92672>=</span>on -O keyformat<span style=color:#f92672>=</span>passphrase -m none -R /mnt/gentoo rock /dev/disk/by-id/nvme-eui.000000000000001000080d0200600f01-part3
</span></span></code></pre></div><p><a href=https://openzfs.github.io/openzfs-docs/man/7/zpoolprops.7.html>zpoolprops</a></p><ul><li><code>ashift=ashift</code>: Pool sector size exponent, to the power of <strong>2</strong> (internally referred to as <strong>ashift</strong>). The typical case for setting this property is when performance is important and the underlying disks use 4KiB sectors but report 512B sectors to the OS (for compatibility reasons); in that case, set <strong>ashift</strong>=<strong>12</strong> (which is <strong>1&#171;12</strong> = <strong>4096</strong>).</li><li><code>cachefile=path|none</code>: Controls the location of where the pool configuration is cached. Setting this property caches the pool configuration in a different location that can later be imported with <code>zpool import -c</code>.</li></ul><p>根据提示输入密码（注意密码不会有回显，并不是键盘坏了）。</p><p>这条命令创建了一个名为 <code>rock</code>的zfs池 使用的压缩算法为<code>lz4</code>。</p><p>如果说你想创建一个不带加密的zpool可以去掉<code>-O encryption=on -O keyformat=passphrase</code>这两个选项。</p><h5 id=创建-datasets>创建 datasets<a hidden class=anchor aria-hidden=true href=#创建-datasets>#</a></h5><p>接下来我们要创建自己的rootfs，并且在上面打开加密功能：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zfs create -o mountpoint<span style=color:#f92672>=</span>none -o canmount<span style=color:#f92672>=</span>off rock/os
</span></span><span style=display:flex><span>$ zfs create -o mountpoint<span style=color:#f92672>=</span>/ rock/os/gentoo
</span></span></code></pre></div><h4 id=安装系统>安装系统<a hidden class=anchor aria-hidden=true href=#安装系统>#</a></h4><p>这次安装系统的话，是打算直接从硬盘恢复的，首先插上备份好的硬盘：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ fdisk -l
</span></span><span style=display:flex><span>........
</span></span><span style=display:flex><span>Disk /dev/sdc: 232.88 GiB, <span style=color:#ae81ff>250055122432</span> bytes, <span style=color:#ae81ff>488388911</span> sectors
</span></span><span style=display:flex><span>Disk model: 00AAJS-00B4A0
</span></span><span style=display:flex><span>Units: sectors of <span style=color:#ae81ff>1</span> * 512 <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span> bytes
</span></span><span style=display:flex><span>Sector size <span style=color:#f92672>(</span>logical/physical<span style=color:#f92672>)</span>: <span style=color:#ae81ff>512</span> bytes / <span style=color:#ae81ff>512</span> bytes
</span></span><span style=display:flex><span>I/O size <span style=color:#f92672>(</span>minimum/optimal<span style=color:#f92672>)</span>: <span style=color:#ae81ff>4096</span> bytes / <span style=color:#ae81ff>33553920</span> bytes
</span></span><span style=display:flex><span>Disklabel type: dos
</span></span><span style=display:flex><span>Disk identifier: 0x80f01a9c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Device     Boot Start       End   Sectors   Size Id Type
</span></span><span style=display:flex><span>/dev/sdc1        <span style=color:#ae81ff>2048</span> <span style=color:#ae81ff>488388910</span> <span style=color:#ae81ff>488386863</span> 232.9G <span style=color:#ae81ff>83</span> Linux
</span></span></code></pre></div><p>这里看到我们的备份硬盘。我们要创建一个目录用来挂载这个分区：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir -pv /backup
</span></span></code></pre></div><p>打开LUKS分区：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cryptsetup luksOpen /dev/sdc1 backup
</span></span><span style=display:flex><span>Enter passphrase <span style=color:#66d9ef>for</span> /dev/sdc1:
</span></span></code></pre></div><p>输入之前设置的密码。挂载分区：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mount -v /dev/mapper/backup /backup
</span></span></code></pre></div><p>还有一个分区我们要注意一下就是<code>/boot</code>分区，创建boot分区的挂载点：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir -pv /mnt/gentoo/boot
</span></span></code></pre></div><p>挂载分区：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mount -v /dev/nvme0n1p1 /mnt/gentoo/boot
</span></span></code></pre></div><p>将所有文件同步到zfs的dataset里面：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ rsync -aAXv --exclude<span style=color:#f92672>={</span><span style=color:#e6db74>&#34;/dev/*&#34;</span>,<span style=color:#e6db74>&#34;/proc/*&#34;</span>,<span style=color:#e6db74>&#34;/sys/*&#34;</span>,<span style=color:#e6db74>&#34;/tmp/*&#34;</span>,<span style=color:#e6db74>&#34;/run/*&#34;</span>,<span style=color:#e6db74>&#34;/mnt/*&#34;</span>,<span style=color:#e6db74>&#34;/media/*&#34;</span>,<span style=color:#e6db74>&#34;/lost+found&#34;</span>,<span style=color:#e6db74>&#34;/backup/*&#34;</span>,<span style=color:#e6db74>&#34;/swapfile&#34;</span><span style=color:#f92672>}</span> /backup/ /mnt/gentoo
</span></span></code></pre></div><p>这个复制需要一定的时间，耐心等待完成，期间不要断开硬盘或者是拔掉电源。</p><h4 id=chroot>chroot<a hidden class=anchor aria-hidden=true href=#chroot>#</a></h4><p>等到复制原来的系统完成之后我们就需要进入chroot环境，然后完成其他的必要配置了。</p><p>拷贝ZFS池缓存文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir -pv /mnt/gentoo/etc/zfs
</span></span><span style=display:flex><span>$ cp -v  /etc/zfs/zpool.cache /mnt/gentoo/etc/zfs
</span></span></code></pre></div><p>拷贝网络的DNS：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cp --dereference /etc/resolv.conf /mnt/gentoo/etc/
</span></span></code></pre></div><p>挂载必要的文件系统：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mount --types proc /proc /mnt/gentoo/proc
</span></span><span style=display:flex><span>$ mount --rbind /sys /mnt/gentoo/sys
</span></span><span style=display:flex><span>$ mount --make-rslave /mnt/gentoo/sys
</span></span><span style=display:flex><span>$ mount --rbind /dev /mnt/gentoo/dev
</span></span><span style=display:flex><span>$ mount --make-rslave /mnt/gentoo/dev
</span></span></code></pre></div><p>我们不是在官方的Livecd下面还需要执行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ test -L /dev/shm <span style=color:#f92672>&amp;&amp;</span> rm /dev/shm <span style=color:#f92672>&amp;&amp;</span> mkdir /dev/shm
</span></span><span style=display:flex><span>$ mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm
</span></span><span style=display:flex><span>$ chmod <span style=color:#ae81ff>1777</span> /dev/shm
</span></span></code></pre></div><p>进入chroot：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ chroot /mnt/gentoo /bin/bash
</span></span><span style=display:flex><span>$ source /etc/profile
</span></span><span style=display:flex><span>$ export PS1<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;(chroot) </span>$PS1<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><h4 id=zfs-安装和配置>ZFS 安装和配置<a hidden class=anchor aria-hidden=true href=#zfs-安装和配置>#</a></h4><p>首先是要给原来的系统安装上ZFS的支持，确保内核打开了Zlib的支持：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>General Architecture Dependent Options ---&gt;
</span></span><span style=display:flex><span>  GCC plug ins  ---&gt;  
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span> <span style=color:#f92672>]</span>   Randomize layout of sensitive kernel structures 
</span></span><span style=display:flex><span>Cryptographic API ---&gt;
</span></span><span style=display:flex><span>  &lt;*&gt; Deflate compression algorithm
</span></span><span style=display:flex><span>Security options  ---&gt; 
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span> <span style=color:#f92672>]</span> Harden common str/mem functions against buffer overflows
</span></span></code></pre></div><p>我们还需要调整portage让ZFS包接收测试分支的包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;sys-fs/zfs-kmod ~amd64&#34;</span> &gt;&gt; /etc/portage/package.accept_keywords/zfs-kmod
</span></span><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;sys-fs/zfs ~amd64&#34;</span> &gt;&gt; /etc/portage/package.accept_keywords/zfs
</span></span></code></pre></div><p>如果你想要使用实时的包可以:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;=sys-fs/zfs-kmod-9999 **&#34;</span> &gt;&gt; /etc/portage/package.accept_keywords/zfs-kmod
</span></span><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;=sys-fs/zfs-9999 **&#34;</span> &gt;&gt; /etc/portage/package.accept_keywords/zfs
</span></span></code></pre></div><p>但是不推荐用最新的，要到处找patch。</p><p>安装ZFS：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ emerge -av zfs
</span></span></code></pre></div><p>有一个很重要的点，每次更新内核或者是编译内核之后最好是重新构建一下模块，否则有可能遇到zpool无法正常初始化的问题：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ emerge -va @module-rebuild
</span></span></code></pre></div><p>将zfs加入到开机启动项和对应的启动级别：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ systemctl enable zfs.target
</span></span><span style=display:flex><span>$ systemctl enable zfs-import-cache
</span></span><span style=display:flex><span>$ systemctl enable zfs-mount
</span></span><span style=display:flex><span>$ systemctl enable zfs-import.target
</span></span></code></pre></div><p>生成和验证<code>zfs hostid</code>文件，这个文件是用于<code>genkernel</code>生成<code>initramfs</code>和zfs导入池的时候验证完整性时候需要的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zgenhostid
</span></span><span style=display:flex><span>$ file /etc/hostid
</span></span></code></pre></div><h4 id=bootload-fstab-and-initramfs>Bootload fstab and Initramfs<a hidden class=anchor aria-hidden=true href=#bootload-fstab-and-initramfs>#</a></h4><h5 id=grub>GRUB<a hidden class=anchor aria-hidden=true href=#grub>#</a></h5><p>修改grub的配置文件，内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>GRUB_CMDLINE_LINUX<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;dozfs root=ZFS=rock/os/gentoo&#34;</span>
</span></span></code></pre></div><p>安装<code>bootload</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ grub-install --target<span style=color:#f92672>=</span>x86_64-efi --efi-directory<span style=color:#f92672>=</span>/boot --bootloader-id<span style=color:#f92672>=</span>Gentoo
</span></span></code></pre></div><p>生成配置文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><h5 id=fstab>fstab<a hidden class=anchor aria-hidden=true href=#fstab>#</a></h5><p>挂载的工作这次交给zfs来去完成，我们这里还需要修改一下fstab</p><p>首先查看分区的id：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ blkid
</span></span><span style=display:flex><span>/dev/nvme0n1p1: UUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;129F-3405&#34;</span> BLOCK_SIZE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;512&#34;</span> TYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;vfat&#34;</span> PARTUUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;537bd932-cc1f-5643-a297-feebaeb6a5ea&#34;</span>
</span></span><span style=display:flex><span>/dev/nvme0n1p2: LABEL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;rock&#34;</span> UUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;7999529021869478878&#34;</span> UUID_SUB<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;11607083434113154920&#34;</span> BLOCK_SIZE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;4096&#34;</span> TYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;zfs_member&#34;</span> PARTUUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;d68d6b86-a407-4141-a1a7-1379cbe1e049&#34;</span>
</span></span></code></pre></div><p>可以看到我们的<code>/boot</code>分分区UUID是<code>129F-3405</code>，现在可以修改<code>/etc/fstab</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nano -w /etc/fstab
</span></span></code></pre></div><p>内容如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># /dev/nvme0n1p1</span>
</span></span><span style=display:flex><span>/dev/nvme0n1p1      	/boot     	vfat      	rw,relatime,fmask<span style=color:#f92672>=</span>0022,dmask<span style=color:#f92672>=</span>0022,codepage<span style=color:#f92672>=</span>437,iocharset<span style=color:#f92672>=</span>iso8859-1,shortname<span style=color:#f92672>=</span>mixed,errors<span style=color:#f92672>=</span>remount-ro	<span style=color:#ae81ff>0</span> <span style=color:#ae81ff>2</span>
</span></span></code></pre></div><h5 id=initramfs>initramfs<a hidden class=anchor aria-hidden=true href=#initramfs>#</a></h5><p>重新生成<code>initramfs</code>，之前的<code>initramfs</code>没有zfs的支持这次要加上，为了保证工作正常还需要将<code>genkrenel</code>切换到testing分支</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;=sys-kernel/genkernel-9999 **&#34;</span> &gt; /etc/portage/package.accept_keywords/genkernel
</span></span></code></pre></div><p>更新<code>genkernel</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ emerge -av genkernel
</span></span></code></pre></div><p>重新生成<code>initramfs</code>文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ genkernel initramfs --zfs --compress-initramfs
</span></span></code></pre></div><h4 id=重启>重启<a hidden class=anchor aria-hidden=true href=#重启>#</a></h4><p>在重启验证之前我们需要先做一些清理工作</p><p>首先退出chroot环境</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ exit
</span></span></code></pre></div><p>卸载备份分区</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ umount -R /backup
</span></span></code></pre></div><p>关闭<code>backup</code>卷</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cryptsetup luksClose backup
</span></span></code></pre></div><p>然后就可以重启啦</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ reboot
</span></span></code></pre></div><p>重启之后第一次可能还是没办法正常进入系统，需要进入到shell里面导入一下zpool</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zpool import -f rock
</span></span></code></pre></div><p>设置一下分区挂载点</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zfs set mountpoint<span style=color:#f92672>=</span>/ rock/os/gentoo
</span></span></code></pre></div><p>然后再重启一下就可以正常进入系统了。</p><h3 id=使用zfs备份httpswwwyafamoepostuse-zfs-backup-system><a href=https://www.yafa.moe/post/use-zfs-backup-system/>使用ZFS备份</a><a hidden class=anchor aria-hidden=true href=#使用zfs备份httpswwwyafamoepostuse-zfs-backup-system>#</a></h3><h4 id=创建备份zfs池>创建备份ZFS池<a hidden class=anchor aria-hidden=true href=#创建备份zfs池>#</a></h4><p>首先进入livecd，查看设备：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ fdisk -l
</span></span><span style=display:flex><span>Disk /dev/nvme0n1: 1.86 TiB, <span style=color:#ae81ff>2048408248320</span> bytes, <span style=color:#ae81ff>4000797360</span> sectors
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Disk /dev/sda: 233.76 GiB, <span style=color:#ae81ff>251000193024</span> bytes, <span style=color:#ae81ff>490234752</span> sectors
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Disk /dev/sdc: 57.81 GiB, <span style=color:#ae81ff>62075699200</span> bytes, <span style=color:#ae81ff>121241600</span> sectors
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>这里的设备分别为：</p><table><thead><tr><th>物理位置</th><th>说明</th></tr></thead><tbody><tr><td>/dev/nvme0n1</td><td>系统盘</td></tr><tr><td>/dev/sda</td><td>备份盘</td></tr><tr><td>/dev/sdc</td><td>启动盘</td></tr></tbody></table><p>首先在备份盘上创建一个分区（分配所有空间到这个分区上）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ fdisk /dev/sda
</span></span><span style=display:flex><span>Welcome to fdisk <span style=color:#f92672>(</span>util-linux 2.36<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>Changes will remain in memory only, <span style=color:#66d9ef>until</span> you decide to write them.
</span></span><span style=display:flex><span>Be careful before using the write command.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Device does not contain a recognized partition table.
</span></span><span style=display:flex><span>Created a new DOS disklabel with disk identifier 0x108318f9.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Command <span style=color:#f92672>(</span>m <span style=color:#66d9ef>for</span> help<span style=color:#f92672>)</span>: n
</span></span><span style=display:flex><span>Partition type
</span></span><span style=display:flex><span>   p   primary <span style=color:#f92672>(</span><span style=color:#ae81ff>0</span> primary, <span style=color:#ae81ff>0</span> extended, <span style=color:#ae81ff>4</span> free<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   e   extended <span style=color:#f92672>(</span>container <span style=color:#66d9ef>for</span> logical partitions<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Select <span style=color:#f92672>(</span>default p<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Using default response p.
</span></span><span style=display:flex><span>Partition number <span style=color:#f92672>(</span>1-4, default 1<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>First sector <span style=color:#f92672>(</span>2048-490234751, default 2048<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>Last sector, +/-sectors or +/-size<span style=color:#f92672>{</span>K,M,G,T,P<span style=color:#f92672>}</span> <span style=color:#f92672>(</span>2048-490234751, default 490234751<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Created a new partition <span style=color:#ae81ff>1</span> of type <span style=color:#e6db74>&#39;Linux&#39;</span> and of size 233.8 GiB.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Command <span style=color:#f92672>(</span>m <span style=color:#66d9ef>for</span> help<span style=color:#f92672>)</span>: w
</span></span><span style=display:flex><span>The partition table has been altered.
</span></span><span style=display:flex><span>Calling ioctl<span style=color:#f92672>()</span> to re-read partition table.
</span></span><span style=display:flex><span>Syncing disks.
</span></span></code></pre></div><p>查看硬盘ID</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -l /dev/disk/by-id
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>10</span> Feb <span style=color:#ae81ff>27</span> 14:53 usb-ACASIS_MAC3E_000000000001-0:0-part1 -&gt; ../../sda1
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p><code>usb-ACASIS_MAC3E_000000000001-0:0-part1</code>这里就是我们所需要的硬盘ID，我们使用这个来创建备份池子：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zpool create -f -o ashift<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span> -o cachefile<span style=color:#f92672>=</span>/etc/zfs/zpool.cache -O compression<span style=color:#f92672>=</span>lz4 -O xattr<span style=color:#f92672>=</span>sa -O relatime<span style=color:#f92672>=</span>on -O acltype<span style=color:#f92672>=</span>posixacl -O dedup<span style=color:#f92672>=</span>off -m none -R /mnt/backup backup /dev/disk/by-id/usb-ACASIS_MAC3E_000000000001-0:0-part1
</span></span></code></pre></div><p>备份池也可以加密。</p><h4 id=创建快照>创建快照<a hidden class=anchor aria-hidden=true href=#创建快照>#</a></h4><p>首先导入原来的<code>zpool</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zpool import -f rock
</span></span></code></pre></div><p>给之前的系统创建一个快照：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo zfs snapshot rock/os/gentoo@2021-02-27-0000-01-install
</span></span></code></pre></div><p>查看</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zfs list -r -t snapshot -o name,creation rock/os/gentoo
</span></span><span style=display:flex><span>rock/os/gentoo@2021-02-27-0000-01-install  Sat Feb <span style=color:#ae81ff>27</span> 14:16 <span style=color:#ae81ff>2021</span>
</span></span></code></pre></div><h4 id=发送快照>发送快照<a hidden class=anchor aria-hidden=true href=#发送快照>#</a></h4><p>我们需要打开原来的<code>rock/os/gentoo</code>数据集</p><p>但是首先要设置一下挂载点：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zfs set mountpoint<span style=color:#f92672>=</span>/mnt/gentoo rock/os/gentoo
</span></span></code></pre></div><p>打开<code>rock/os/gentoo</code>数据集</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zfs mount -l -a
</span></span></code></pre></div><p>发送快照到<code>backup/os/gentoo</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zfs send rock/os/gentoo@2021-02-27-0000-01-install |  zfs recv backup/2021-02-27-0000-01-backup
</span></span></code></pre></div><p>这个会花很长的时间，取决于你使用的接口速度，可以通过这条命令查看io情况：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zpool iostat <span style=color:#ae81ff>2</span> 
</span></span></code></pre></div><p>这条命令是查看所有的<code>zpool</code>io情况，2秒刷新一次。</p><h4 id=备份boot分区>备份<code>/boot</code>分区<a hidden class=anchor aria-hidden=true href=#备份boot分区>#</a></h4><p>设置挂载点</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zfs set mountpoint<span style=color:#f92672>=</span>/mnt/backup backup/2021-02-27-0000-01-backup
</span></span></code></pre></div><p>备份</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir -pv /mnt/boot
</span></span><span style=display:flex><span>$ mount -v /dev/nvme0n1p1 /mnt/boot
</span></span><span style=display:flex><span>$ cp -rv /mnt/boot/* /mnt/backup/boot/
</span></span></code></pre></div><h4 id=恢复快照>恢复快照<a hidden class=anchor aria-hidden=true href=#恢复快照>#</a></h4><p>卸除挂载：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zfs umount backup/2021-02-27-0000-01-backup
</span></span></code></pre></div><p>现在就可以恢复快照了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zfs send backup/2021-02-27-0000-01-backup | zfs recv -F  -x encryption rock/os/gentoo
</span></span></code></pre></div><h4 id=定期备份>定期备份<a hidden class=anchor aria-hidden=true href=#定期备份>#</a></h4><p>在Gentoo的Portage Tree中提供了一个<code>sys-fs/zfs-auto-snapshot</code>的包，这个包可以帮我们创建一个定时任务周期性的备份我们的ZFS</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo emerge -av sys-fs/zfs-auto-snapshot
</span></span></code></pre></div><p>可以根据需要配置备份的周期：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo zfs set com.sun:auto-snapshot:daily<span style=color:#f92672>=</span>true rock/os/gentoo
</span></span><span style=display:flex><span>$ sudo zfs set com.sun:auto-snapshot:weekly<span style=color:#f92672>=</span>true rock/os/gentoo
</span></span></code></pre></div><h3 id=问题排查>问题排查<a hidden class=anchor aria-hidden=true href=#问题排查>#</a></h3><h4 id=grub-救援>grub 救援<a hidden class=anchor aria-hidden=true href=#grub-救援>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grub rescue&gt; set prefix<span style=color:#f92672>=(</span>hd0,1<span style=color:#f92672>)</span>/boot/grub
</span></span><span style=display:flex><span>grub rescue&gt; set root<span style=color:#f92672>=(</span>hd0,1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>grub rescue&gt; insmod normal
</span></span><span style=display:flex><span>grub rescue&gt; normal
</span></span><span style=display:flex><span>grub rescue&gt; insmod linux
</span></span><span style=display:flex><span>grub rescue&gt; linux /boot/vmlinuz-3.13.0-29-generic dozfs root<span style=color:#f92672>=</span>ZFS<span style=color:#f92672>=</span>rock/os/gentoo
</span></span><span style=display:flex><span>grub rescue&gt; initrd /boot/initrd.img-3.13.0-29-generic
</span></span><span style=display:flex><span>grub rescue&gt; boot
</span></span></code></pre></div><h4 id=通过-livecd-修复>通过 livecd 修复<a hidden class=anchor aria-hidden=true href=#通过-livecd-修复>#</a></h4><p><strong>导入 zpool</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zpool import -f rock
</span></span><span style=display:flex><span>$ zfs set mountpoint<span style=color:#f92672>=</span>/mnt/gentoo rock/os/gentoo
</span></span></code></pre></div><p><strong>挂载 dataset</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zfs mount -la
</span></span></code></pre></div><p><strong>挂载 boot 分区</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mount /dev/nvme0n1p1 /mnt/gentoo/boot/
</span></span></code></pre></div><p><strong>挂载必要的文件系统</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mount --types proc /proc /mnt/gentoo/proc
</span></span><span style=display:flex><span>$ mount --rbind /sys /mnt/gentoo/sys
</span></span><span style=display:flex><span>$ mount --make-rslave /mnt/gentoo/sys
</span></span><span style=display:flex><span>$ mount --rbind /dev /mnt/gentoo/dev
</span></span><span style=display:flex><span>$ mount --make-rslave /mnt/gentoo/dev
</span></span><span style=display:flex><span><span style=color:#75715e># 我们不是在官方的Livecd下面还需要执行：</span>
</span></span><span style=display:flex><span>$ test -L /dev/shm <span style=color:#f92672>&amp;&amp;</span> rm /dev/shm <span style=color:#f92672>&amp;&amp;</span> mkdir /dev/shm
</span></span><span style=display:flex><span>$ mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm
</span></span><span style=display:flex><span>$ chmod <span style=color:#ae81ff>1777</span> /dev/shm
</span></span></code></pre></div><p><strong>进入 chroot</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ chroot /mnt/gentoo /bin/bash
</span></span><span style=display:flex><span>$ source /etc/profile
</span></span><span style=display:flex><span>$ export PS1<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;(chroot) </span>$PS1<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p><strong>退出 chroot</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ exit 
</span></span></code></pre></div><p><strong>卸除挂载</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ umount -R /mnt/gentoo
</span></span></code></pre></div><p><strong>改回 rootfs 挂载点</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ zfs set mountpoint<span style=color:#f92672>=</span>/ rock/os/gentoo
</span></span></code></pre></div><p><strong>重启</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ reboot
</span></span></code></pre></div><h2 id=lukshttpslinuxcnarticle-9640-1html><a href=https://linux.cn/article-9640-1.html>LUKS</a><a hidden class=anchor aria-hidden=true href=#lukshttpslinuxcnarticle-9640-1html>#</a></h2><p>数据的安全，保密性在现在的生活中显得越来越重要。随着数字化的时代的来临，越来越多的数据被数字化，特别是更多有关于我们隐私的数据在不断生成，甚至还有我们需要离线保存的密钥等。而且通常我们使用磁盘，USB 闪存，SD 卡等存储介质进行存储，即便我们已经离线存储，仍然不能保证该存储介质不会丢失，如果丢失那么对于我们来说有可能是灾难性的事件。因此对这些离线存储的重要数据，再次进行进行加密是非常有必要的，本文将告诉你如何加密你的移动存储介质。</p><p>在此之前先介绍一下 LUKS：</p><blockquote><p>LUKS （Linux Unified Key Setup）是 Linux 硬盘加密的标准。 通过提供标准的磁盘格式，它不仅可以促进发行版之间的兼容性，还可以提供对多个用户密码的安全管理。 与现有解决方案相比，LUKS 将所有必要的设置信息存储在分区信息首部中，使用户能够无缝传输或迁移其数据。</p></blockquote><h3 id=内核配置可选>内核配置（可选）<a hidden class=anchor aria-hidden=true href=#内核配置可选>#</a></h3><p>通常来说，大部分发行版的内核都已经配置了相关的加密部分，因此非 gentoo 用户可以跳过此部分。</p><p>配置 device mapper 和 crypt target：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>    <span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Enable loadable module support
</span></span><span style=display:flex><span>    Device Drivers ---&gt;
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Multiple devices driver support <span style=color:#f92672>(</span>RAID and LVM<span style=color:#f92672>)</span> ---&gt;
</span></span><span style=display:flex><span>            &lt;*&gt; Device mapper support
</span></span><span style=display:flex><span>            &lt;*&gt;   Crypt target support
</span></span></code></pre></div><p>配置加密 API：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>    <span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Cryptographic API ---&gt;
</span></span><span style=display:flex><span>        &lt;*&gt; XTS support
</span></span><span style=display:flex><span>        &lt;*&gt; SHA224 and SHA256 digest algorithm
</span></span><span style=display:flex><span>        &lt;*&gt; AES cipher algorithms
</span></span><span style=display:flex><span>        &lt;*&gt; AES cipher algorithms <span style=color:#f92672>(</span>x86_64<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        &lt;*&gt; User-space interface <span style=color:#66d9ef>for</span> hash algorithms
</span></span><span style=display:flex><span>        &lt;*&gt; User-space interface <span style=color:#66d9ef>for</span> symmetric key cipher algorithms
</span></span></code></pre></div><p>编译新内核并配置应用，然后重启：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># make -j9 &amp;&amp; make modules_install &amp;&amp; make install</span>
</span></span></code></pre></div><h3 id=安装软件-1>安装软件<a hidden class=anchor aria-hidden=true href=#安装软件-1>#</a></h3><p>通常的发行版已经预装了该软件包，可以直接使用，下面是 Gentoo 的安装方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --ask sys-fs/cryptsetup</span>
</span></span></code></pre></div><h3 id=创建加密分区>创建加密分区<a hidden class=anchor aria-hidden=true href=#创建加密分区>#</a></h3><p>注意，该操作会清空你选择分区或设备上的所有数据，请谨慎操作，输入大写的 <code>YES</code> 确认</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cryptsetup -s 512 luksFormat /dev/sdd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WARNING!
</span></span><span style=display:flex><span><span style=color:#f92672>========</span>
</span></span><span style=display:flex><span>This will overwrite data on /dev/sdd irrevocably.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Are you sure? <span style=color:#f92672>(</span>Type uppercase yes<span style=color:#f92672>)</span>: YES
</span></span><span style=display:flex><span>Enter passphrase: 
</span></span><span style=display:flex><span>Verify passphrase:
</span></span></code></pre></div><h3 id=利用密钥文件加密分区>利用密钥文件加密分区<a hidden class=anchor aria-hidden=true href=#利用密钥文件加密分区>#</a></h3><p>除了密码之外，还可以选择使用密钥文件解密你的硬盘，也就是相当于一个密钥，当然可以也可以只使用密钥文件或者同时使用密码与密钥文件。</p><h4 id=生成随机密钥文件>生成随机密钥文件<a hidden class=anchor aria-hidden=true href=#生成随机密钥文件>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># dd if=/dev/urandom of=/root/enc.key bs=1 count=4096</span>
</span></span></code></pre></div><h4 id=添加密钥文件作为密码之一>添加密钥文件作为密码之一<a hidden class=anchor aria-hidden=true href=#添加密钥文件作为密码之一>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cryptsetup luksAddKey  /dev/sdd /root/enc.key</span>
</span></span><span style=display:flex><span>Enter any existing passphrase:
</span></span></code></pre></div><h3 id=移除解密密码>移除解密密码<a hidden class=anchor aria-hidden=true href=#移除解密密码>#</a></h3><p>移除普通密码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cryptsetup luksRemoveKey /dev/sdd</span>
</span></span><span style=display:flex><span>Enter LUKS passphrase to be deleted: ...
</span></span></code></pre></div><p>移除 key file 密码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cryptsetup luksRemoveKey -d /root/enc.key /dev/sdd</span>
</span></span></code></pre></div><p><strong>注意</strong>：千万不要将所有密码移除，至少需要留有一个密码访问设备，移除操作不可撤销</p><h3 id=解密与挂载>解密与挂载<a hidden class=anchor aria-hidden=true href=#解密与挂载>#</a></h3><h4 id=密码解密>密码解密<a hidden class=anchor aria-hidden=true href=#密码解密>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cryptsetup luksOpen /dev/sdd myusb</span>
</span></span><span style=display:flex><span>Enter passphrase <span style=color:#66d9ef>for</span> /dev/sdd:
</span></span></code></pre></div><h4 id=key-file-解密>key file 解密<a hidden class=anchor aria-hidden=true href=#key-file-解密>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cryptsetup luksOpen -d /root/enc.key /dev/sdd myusb</span>
</span></span></code></pre></div><h4 id=创建文件系统>创建文件系统<a hidden class=anchor aria-hidden=true href=#创建文件系统>#</a></h4><p>在挂载使用之前，我们仍然需要对设备创建文件系统才可以使用，可以选择任何你喜欢的文件系统，例如 <code>btrfs</code>，<code>ext4</code>，<code>vfat</code>，<code>ntfs</code> 等</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># mkfs.ext4 /dev/mapper/myusb</span>
</span></span><span style=display:flex><span>mke2fs 1.43.6 <span style=color:#f92672>(</span>29-Aug-2017<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Creating filesystem with <span style=color:#ae81ff>488448</span> 4k blocks and <span style=color:#ae81ff>122160</span> inodes
</span></span><span style=display:flex><span>Filesystem UUID: 995e172a-2bc6-432c-a60f-2d4d7093e748
</span></span><span style=display:flex><span>Superblock backups stored on blocks:
</span></span><span style=display:flex><span>32768, 98304, 163840, 229376, <span style=color:#ae81ff>294912</span>
</span></span><span style=display:flex><span>Allocating group tables: <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Writing inode tables: <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Creating journal <span style=color:#f92672>(</span><span style=color:#ae81ff>8192</span> blocks<span style=color:#f92672>)</span>: <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Writing superblocks and filesystem accounting information: <span style=color:#66d9ef>done</span>
</span></span></code></pre></div><h4 id=挂载>挂载<a hidden class=anchor aria-hidden=true href=#挂载>#</a></h4><p>现在可以像正常分区一样挂载我们的加密分区设备了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># mount /dev/mapper/myusb /mnt/</span>
</span></span><span style=display:flex><span><span style=color:#75715e># df -h</span>
</span></span><span style=display:flex><span>/dev/mapper/myusb  1.9G  5.7M  1.7G   1% /mnt
</span></span></code></pre></div><h4 id=卸载挂载点并关闭加密分区>卸载挂载点并关闭加密分区<a hidden class=anchor aria-hidden=true href=#卸载挂载点并关闭加密分区>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># umount /mnt</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cryptsetup luksClose myusb</span>
</span></span></code></pre></div><h3 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h3><p>在完成整个步骤以后，您现在需要做的就是妥善保管您的加密存储，可采用同样的方式加密多个设备进行备份，因为谁也不能保证这移动设备会不会在什么时候丢掉。</p><h2 id=双显卡笔记本独显直通httpswwwcodeplayerorgbloge58f8ce698bee58da1e7ac94e8aeb0e69cace78bace698bee79bb4e9809ahtml><a href=https://www.codeplayer.org/Blog/%E5%8F%8C%E6%98%BE%E5%8D%A1%E7%AC%94%E8%AE%B0%E6%9C%AC%E7%8B%AC%E6%98%BE%E7%9B%B4%E9%80%9A.html>双显卡笔记本独显直通</a><a hidden class=anchor aria-hidden=true href=#双显卡笔记本独显直通httpswwwcodeplayerorgbloge58f8ce698bee58da1e7ac94e8aeb0e69cace78bace698bee79bb4e9809ahtml>#</a></h2><h3 id=介绍>介绍<a hidden class=anchor aria-hidden=true href=#介绍>#</a></h3><p>双显卡笔记本中直通独显（dGPU）到 win10 虚拟机。</p><p>环境：</p><ul><li>联想 Legion R7000P 2020 笔记本</li><li>RTX2060 笔记本显卡</li><li>libvirt+qemu</li><li>Host: Gentoo Linux</li><li>Guest: Windows 10 LTSC 2019</li></ul><h3 id=muxed>MUXed<a hidden class=anchor aria-hidden=true href=#muxed>#</a></h3><p>MUXed 结构的笔记本才容易实现独立显卡直通，Legion R7000P 应该就是 MUXed 的。关于什么是 MUXed 的，可以看下图的解释。</p><p><img loading=lazy src=/Distributions/muxed.jpg alt></p><p>关于如何检测笔记本是否是 MUXed 的，目前没有什么好的办法。有一种说法是运行 lspci，查找有关 Intel HD Graphics/AMD GPU 和 NVIDIA 的设备：</p><ul><li>如果独显设备名以 3D Controller 开头，那你的电脑就是第二种 MUXless（核显直连显示器）。</li><li>如果独显设备名以 VGA Controller 开头，并且有一个 HD Graphics/AMD GPU 核显，那你的电脑是第三种 MUXed（核显、独显切换）。</li></ul><h3 id=启用-iommu-和-vfio-模块>启用 IOMMU 和 vfio 模块<a hidden class=anchor aria-hidden=true href=#启用-iommu-和-vfio-模块>#</a></h3><h4 id=iommu>IOMMU<a hidden class=anchor aria-hidden=true href=#iommu>#</a></h4><ul><li>intel CPU：添加内核参数 <code>intel_iommu=on iommu=pt</code> ，BIOS 开启 VT-d</li><li>amd CPU：添加内核参数 <code>iommu=pt</code> ，BIOS 开启 AMD-Vi</li></ul><h4 id=vfio>vfio<a hidden class=anchor aria-hidden=true href=#vfio>#</a></h4><p>添加模块 <code>vfio_pci vfio vfio_iommu_type1 vfio_virqfd</code> 到 initramfs 中。如果是像我一样使用 dracut 生成 initramfs，则在 <code>/etc/dracut.conf</code> 中添加配置 <code>add_drivers+=" vfio_pci vfio vfio_iommu_type1 vfio_virqfd "</code> ，之后重新生成 initramfs。</p><h3 id=隔离-gpu>隔离 GPU<a hidden class=anchor aria-hidden=true href=#隔离-gpu>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>shopt -s nullglob
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> g in <span style=color:#e6db74>`</span>find /sys/kernel/iommu_groups/* -maxdepth <span style=color:#ae81ff>0</span> -type d | sort -V<span style=color:#e6db74>`</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;IOMMU Group </span><span style=color:#e6db74>${</span>g###*/<span style=color:#e6db74>}</span><span style=color:#e6db74>:&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> d in $g/devices/*; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        echo -e <span style=color:#e6db74>&#34;\t</span><span style=color:#66d9ef>$(</span>lspci -nns <span style=color:#e6db74>${</span>d###*/<span style=color:#e6db74>}</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>;
</span></span></code></pre></div><p>运行上述脚本，查看显卡所在的 IOMMU Group，并得到显卡相关设备的 device id。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>IOMMU Group 10:
</span></span><span style=display:flex><span>        01:00.0 VGA compatible controller <span style=color:#f92672>[</span>0300<span style=color:#f92672>]</span>: NVIDIA Corporation TU106M <span style=color:#f92672>[</span>GeForce RTX <span style=color:#ae81ff>2060</span> Mobile<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>10de:1f15<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>rev a1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        01:00.1 Audio device <span style=color:#f92672>[</span>0403<span style=color:#f92672>]</span>: NVIDIA Corporation TU106 High Definition Audio Controller <span style=color:#f92672>[</span>10de:10f9<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>rev a1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        01:00.2 USB controller <span style=color:#f92672>[</span>0c03<span style=color:#f92672>]</span>: NVIDIA Corporation TU106 USB 3.1 Host Controller <span style=color:#f92672>[</span>10de:1ada<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>rev a1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        01:00.3 Serial bus controller <span style=color:#f92672>[</span>0c80<span style=color:#f92672>]</span>: NVIDIA Corporation TU106 USB Type-C UCSI Controller <span style=color:#f92672>[</span>10de:1adb<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>rev a1<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>如上所见，device id 分别为 <code>10de:1f15</code> 、 <code>10de:10f9</code> 、 <code>10de:1ada</code> 、 <code>10de:1adb</code> 。再将以上 deivce id 作为参数添加到内核参数或 <code>/etc/modprobe.d/vfio.conf</code> 中。</p><ul><li>内核参数：vfio-pci.ids=10de:1f15,10de:10f9,10de:1ada,10de:1adb</li><li><code>/etc/modprobe.d/vfio.conf</code> ：options vfio-pci ids=10de:1f15,10de:10f9,10de:1ada,10de:1adb</li></ul><p>dracut 必须将 device id 添加到内核参数中，并且添加参数 <code>rd.driver.pre=vfio_pci</code> 。</p><p>最后重启电脑。开机后通过命令 <code>lspci -k</code> 确认上述 device id 对应的设备在使用 vfio-pci 驱动。如果有各别设备没有使用 vfio-pci 驱动，则可以通过手动 unbind 和 bind 驱动的方式加载 vfio-pci 驱动。比如如果 0000:01:00.2 仍在使用 xhci_hcd 驱动，则：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># run as root</span>
</span></span><span style=display:flex><span>echo -n <span style=color:#e6db74>&#34;0000:01:00.2&#34;</span> &gt; /sys/bus/pci/drivers/xhci_hcd/unbind
</span></span><span style=display:flex><span>echo -n <span style=color:#e6db74>&#34;0000:01:00.2&#34;</span> &gt; /sys/bus/pci/drivers/vfio-pci/bind
</span></span></code></pre></div><h3 id=创建虚拟机>创建虚拟机<a hidden class=anchor aria-hidden=true href=#创建虚拟机>#</a></h3><p>首先使用 libvirt 创建一个非显卡直通的虚拟机，如果你有多余的显示器和键鼠，也可以直接创建显卡直通的虚拟机。这里我们假设没有多余的设备，并且之后使用 RDP 连接虚拟机。</p><p>首先下载<a href=https://msdn.itellyou.cn/>windows 10 LTSC 2019</a>和 <a href=https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso>virtio windows驱动</a>镜像。</p><p>创建虚拟机：</p><ul><li><code>Overview</code> ：Firmware 选择 UEFI x86_64:/usr/share/edk2-ovmf/OVMF_CODE.fd</li><li><code>CPUs</code> ：选择 Topology，Manually set CPU topology，Sockets 设为 1，Cores 按需要来，我设为 4，Threads 设置为 2。这样一共就分配了 4 核 8 线程的 CPU</li><li><code>Memory</code> ：内存我设置为 32G</li><li><code>SATA Disk</code> ：Disk Bus 选择 Virtio，可以最小化磁盘性能损耗</li><li><code>NIC</code> ：Device model 也选择 virtio</li><li>之后再添加一个 <code>Stroage</code> ，选择 Select custom storage 并选中之前下载的 virtio windows 驱动镜像，然后 Device type 选择 CDROM device</li><li>最后在 <code>Boot Options</code> 中选中需要启动的设备</li></ul><p>开始安装，在 windows 安装进行到选择硬盘的时候，通过之前加载的 virtio win 驱动的 CDROM，安装 virtio 的磁盘和网络驱动。具体参考可见视频 <a href=https://www.bilibili.com/video/BV1dQ4y1o78R>https://www.bilibili.com/video/BV1dQ4y1o78R</a> 的 29 分 35 秒。安装完毕进入 windows，开启远程桌面并记下 IP，之后通过 RDP 连接虚拟机。</p><h3 id=配置和优化-remotefx>配置和优化 RemoteFX<a hidden class=anchor aria-hidden=true href=#配置和优化-remotefx>#</a></h3><h4 id=配置-remotefx>配置 RemoteFX<a hidden class=anchor aria-hidden=true href=#配置-remotefx>#</a></h4><ol><li>通过 <code>Win+R</code> 运行 <code>gpedit.msc</code></li><li>定位到 <code>计算机配置</code> -> <code>管理模板</code> -> <code>Windows组件</code> -> <code>远程桌面服务</code> -> <code>远程桌面会话主机</code> -> <code>远程会话环境</code><ul><li>开启 <code>对 RemoteApp 使用高级 RemoteFX 图形</code></li><li>（可选）开启 <code>配置 RemoteFX 自适应图形的图像质量</code> ，设置为高</li><li>开启 <code>为专门针对 Windows Server 2008 R2 SP1 设计的 RemoteFX 客户端启动 RemoteFX 编码</code></li><li>开启 <code>配置 RemoteFX 数据的压缩</code> ，并设置为不需使用 RDP 压缩算法<ul><li>连接压缩会导致编码和解码时产生额外的延迟</li></ul></li></ul></li><li>定位到 <code>计算机配置</code> -> <code>管理模板</code> -> <code>Windows组件</code> -> <code>远程桌面服务</code> -> <code>远程桌面会话主机</code> -> <code>远程会话环境</code> -> <code>RemoteFX for Windows Server 2008 R2</code><ul><li>开启 <code>配置RemoteFX</code></li><li>（可选）开启 <code>使用RemoteFX时优化视觉体验</code> ，并都设置为最高</li></ul></li></ol><h4 id=解除-30-ish-fps-限制>解除 30-ish fps 限制<a hidden class=anchor aria-hidden=true href=#解除-30-ish-fps-限制>#</a></h4><ol><li>启动注册表编辑器</li><li>定位并单击以下注册表子键： <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations</code></li><li>在 <code>编辑</code> 菜单中选择 <code>新建</code> ，然后再选择 <code>DWORD（32位）值</code></li><li>输入 <code>DWMFRAMEINTERVAL</code> 并回车</li><li>右键 <code>DWMFRAMEINTERVAL</code> ，选择 <code>修改</code></li><li>选择十进制，并输入 15。该设置将最大帧率设置为每秒 60 帧 (FPS)。</li></ol><h3 id=显卡直通>显卡直通<a hidden class=anchor aria-hidden=true href=#显卡直通>#</a></h3><p>先关闭虚拟机。首先我们需要确认 host 和 guest 中的 GPU 硬件 ID 一致的，然而 Legion R7000P 中两者不一致，准确的来说是其中的 Sub ID 部分不一致，所以需要手动修改一下。首先通过命令 <code>lspci -nnk | egrep -A3 "VGA|3D"</code> 查看显卡的 Vendor ID 和 Device ID。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ lspci -nnk | egrep -A3 <span style=color:#e6db74>&#34;VGA|3D&#34;</span>
</span></span><span style=display:flex><span>01:00.0 VGA compatible controller <span style=color:#f92672>[</span>0300<span style=color:#f92672>]</span>: NVIDIA Corporation TU106M <span style=color:#f92672>[</span>GeForce RTX <span style=color:#ae81ff>2060</span> Mobile<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>10de:1f15<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>rev a1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        Subsystem: Lenovo TU106M <span style=color:#f92672>[</span>GeForce RTX <span style=color:#ae81ff>2060</span> Mobile<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>17aa:3a43<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>        Kernel driver in use: vfio-pci
</span></span><span style=display:flex><span>        Kernel modules: nouveau
</span></span><span style=display:flex><span>--
</span></span><span style=display:flex><span>06:00.0 VGA compatible controller <span style=color:#f92672>[</span>0300<span style=color:#f92672>]</span>: Advanced Micro Devices, Inc. <span style=color:#f92672>[</span>AMD/ATI<span style=color:#f92672>]</span> Renoir <span style=color:#f92672>[</span>1002:1636<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>rev c6<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        Subsystem: Lenovo Renoir <span style=color:#f92672>[</span>17aa:3a47<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>        Kernel driver in use: amdgpu
</span></span><span style=display:flex><span>        Kernel modules: amdgpu
</span></span></code></pre></div><p>其中 NVIDIA 独显的 Vendor ID 为 10de，Device ID 为 1f15。再用命令 <code>grep "PCI_SUBSYS_ID=" /sys/bus/pci/devices/0000:01:00.0/uevent</code> 查看 Sub Vendor ID 和 Sub Device ID。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ grep <span style=color:#e6db74>&#34;PCI_SUBSYS_ID=&#34;</span> /sys/bus/pci/devices/0000:01:00.0/uevent
</span></span><span style=display:flex><span>PCI_SUBSYS_ID<span style=color:#f92672>=</span>17AA:3A47
</span></span></code></pre></div><p>其中 Sub Vendor ID 为 17AA，Sub Device ID 为 3A47。将 17AA 和 3A47 转换为十进制 6058 和 14919，并在虚拟机的 XML 中添加配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;domain</span> <span style=color:#a6e22e>xmlns:qemu=</span><span style=color:#e6db74>&#34;http://libvirt.org/schemas/domain/qemu/1.0&#34;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;kvm&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;qemu:commandline&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;qemu:arg</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#39;-set&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;qemu:arg</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#39;device.hostdev0.x-pci-sub-vendor-id=6058&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;qemu:arg</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#39;-set&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;qemu:arg</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#39;device.hostdev0.x-pci-sub-device-id=14919&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/qemu:commandline&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/domain&gt;</span>
</span></span></code></pre></div><p>注意 XML 的第一行一定要添加 <code>xmlns:qemu="http://libvirt.org/schemas/domain/qemu/1.0"</code> ，否则后面的配置无法成功添加。</p><p>在 libvirt 中添加硬件，选择 PCI Host Device，然后将 <code>0000:01:00.0 NVIDIA Corporation GeForce RTX 2060 Mobile</code> 和 <code>0000:01:00.1 NVIDIA Corporation High Definition Audio Controller</code> 等都添加进去。</p><p>最后再在 libvirt 中删除虚拟机的 <code>Display Spice</code> 和 <code>Video QXL</code> ，在 <code>CPUs</code> 中取消 Copy host CPU configuration 并将 Model 选择为 host passthrough。如果你需要直通鼠标和键盘，也可以在这个时候添加。</p><h3 id=创建网桥>创建网桥<a hidden class=anchor aria-hidden=true href=#创建网桥>#</a></h3><p>有线网卡的网桥创建起来较为简单，这里就不详细介绍了，有需要的可以查看我上一篇<a href=https://www.codeplayer.org/Blog/%E8%BD%AF%E8%B7%AF%E7%94%B1%E8%99%9A%E6%8B%9F%E6%9C%BA.html>软路由虚拟机</a>的 BLOG。因为是笔记本，所以这里主要介绍无线网卡的桥接方法。</p><p>先开启 proxy_arp 和 ip_forward，修改配置文件 <code>/etc/sysctl.conf</code> ，添加下述配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>net.ipv4.ip_forward <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>net.ipv4.conf.all.proxy_arp <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>再点击 libvirt 菜单栏上的 <code>Edit</code> -> <code>Connection Details</code> ，假设 host 的 ip 为 192.168.3.12，无线网卡为 wlp4s0，新建一个 Network， <code>Name</code> 设置为 proxyArp， <code>Mode</code> 选择 Routed， <code>Forward to</code> 选择 Physical device， <code>Device</code> 设置为 wlp4s0， IPv4 的 <code>Network</code> 设置为 192.168.3.100/28，完成创建。</p><p>然后修改 win10 虚拟机的 <code>NIC</code> 配置，将 <code>Network source</code> 改为 Virtual network &lsquo;proxyArp&rsquo;: Route to wlp4s0，最后重新启动虚拟机与物理机。</p><h3 id=远程连接>远程连接<a hidden class=anchor aria-hidden=true href=#远程连接>#</a></h3><p>重新启动虚拟机后，使用 RDP 连接到虚拟机中。到 nvidia 官网下载驱动，并进行安装。如果安装过程中并未出现问题，则至此显卡直通配置完成。另外如果不外接显示器的话，windows 的分辨率似乎会被限制在 640x480，不知道会不会对游戏有影响，所以有条件还是买一个 HDMI 欺骗器接到独显连接的显示接口上。</p><p>远程连接方式一共有三种，分别可以适用于不同的情况。</p><h4 id=rdp>RDP<a hidden class=anchor aria-hidden=true href=#rdp>#</a></h4><p>简单使用方法：</p><ul><li>确保使用 FreeRDP 2.0</li><li>获取 windows 虚拟机 IP，比如 192.168.3.108</li><li>xfreerdp /v:192.168.3.108:3389 /w:1600 /h:900 /bpp:32 +clipboard +fonts /gdi:hw /rfx /rfx-mode:video /sound:sys:pulse +menu-anims +window-drag</li></ul><p>对于使用 xfreedp 的 RemoteFX 连接的一些问题：</p><ul><li>只有窗口化的游戏可以运行，全屏将会触发 d3d11 0x087A0001 不能设置分辨率等问题。媒体播放器不受其影响。<ul><li>作为解决方案，使用无边框模式游戏，或其他等效方案</li><li>windows 客户端似乎没有该问题</li></ul></li><li>由于 RDSH/RDVH 连接不支持“相对”鼠标，鼠标会乱跑<ul><li>重定向 XBOX 手柄或 USB 摇杆可能会解决这个问题？</li><li>使用 Synergy (v1) 并启用相对鼠标模式</li><li>通过 RDP RemoteFX 运行 3D 游戏鼠标不稳定</li></ul></li></ul><h4 id=looking-glass>Looking glass<a hidden class=anchor aria-hidden=true href=#looking-glass>#</a></h4><p>Looking glass 的优点是低延迟，其并不是通过网络与虚拟机通信，而是直接使用一块共享内存。缺点是只能本地连接，而且似乎需要外接一个显示设备（或 HDMI 欺骗器）才能让键盘、鼠标正常工作，并且似乎不能使用 spice 套娃远程操作 looking glass。</p><h5 id=安装-client>安装 client<a hidden class=anchor aria-hidden=true href=#安装-client>#</a></h5><p>首先在 host 系统上安装 looking glass client，在 gentoo 上可以通过如下步骤直接安装我打包的 looking glass。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo eselect repository enable gig
</span></span><span style=display:flex><span>$ sudo emerge --sync gig
</span></span><span style=display:flex><span>$ sudo emerge -avt looking-glass
</span></span></code></pre></div><h5 id=计算内存大小>计算内存大小<a hidden class=anchor aria-hidden=true href=#计算内存大小>#</a></h5><p>通过以下公式，根据你期望的最大分辨率来计算内存大小。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>width x height x <span style=color:#ae81ff>4</span> x 2 <span style=color:#f92672>=</span> total bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>total bytes / <span style=color:#ae81ff>1024</span> / 1024 <span style=color:#f92672>=</span> total megabytes + <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><p>比如，我想要最大使用 4K 分辨率（3840x2160）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ae81ff>3840</span> x <span style=color:#ae81ff>2160</span> x <span style=color:#ae81ff>4</span> x 2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>66355200</span> bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>66355200</span> / <span style=color:#ae81ff>1024</span> / 1024 <span style=color:#f92672>=</span> 63.28 MB + 10 <span style=color:#f92672>=</span> 73.28
</span></span></code></pre></div><p>最后要注意内存的大小要上向取整到最接近的 2 的幂，在上面的例子中则应为 128。</p><h5 id=配置-libvirt>配置 libvirt<a hidden class=anchor aria-hidden=true href=#配置-libvirt>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;devices&gt;</span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;shmem</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;looking-glass&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;ivshmem-plain&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;size</span> <span style=color:#a6e22e>unit=</span><span style=color:#e6db74>&#39;M&#39;</span><span style=color:#f92672>&gt;</span>128<span style=color:#f92672>&lt;/size&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/shmem&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/devices&gt;</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>将以上内容添加到虚拟机的 XML 配置中，其中 128 即为上面计算出来的大小。</p><p>如果想要通过 spice 实现键盘和鼠标输入与剪贴板共享，则必须添加 spice 设备。</p><ul><li><p>在 libvirt 中，选择 <code>Add Hardware</code> ，然后再选择 <code>Graphics</code> ，使用默认的 spice 配置即可，最后完成添加</p></li><li><p>选择 <code>Video</code> 设备，然后在 <code>Model</code> 栏中输入 none，注意必须要完成这一步，否则可能会造成虚拟机不使用直通的显卡渲染</p></li><li><p>如果有 <code>tablet</code> 设备，则删除</p></li><li><p>如果没有 <code>Mouse</code> 设备，则添加一个</p></li><li><p>如果没有 <code>Keyboard</code> 设备，则添加一个</p><ul><li>这里使用 Virtio 的键盘可以更好的提高性能，然而 PS/2 的键盘没办法删掉，不知道被哪个设备依赖了，所以就使用 PS/2 的键盘了</li></ul></li><li><p>还有如果使用 Virtio 的键盘，则需要通过上面加载的 virtio windows 驱动 的 CDROM，以安装驱动</p></li></ul><h5 id=创建共享内存文件>创建共享内存文件<a hidden class=anchor aria-hidden=true href=#创建共享内存文件>#</a></h5><p>新建文件 <code>/etc/tmpfiles.d/10-looking-glass.conf</code> ，其内容为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Type Path               Mode UID  GID Age Argument</span>
</span></span><span style=display:flex><span>f /dev/shm/looking-glass <span style=color:#ae81ff>0660</span> user kvm -
</span></span></code></pre></div><p>将其中的 user，改为你自己的用户名。最后使用命令 <code>systemd-tmpfiles --create /etc/tmpfiles.d/10-looking-glass.conf</code> 创建共享内存文件，无需等待下次重启。</p><h5 id=安装-host>安装 host<a hidden class=anchor aria-hidden=true href=#安装-host>#</a></h5><p>首先需要在 windows 中安装 IVSHMEM 驱动，windows 不会自己安装 IVSHMEM 设备，相反它只会为该设备安装一个假驱动。先下载需要安装的驱动程序，https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/upstream-virtio/ ，注意必须下载 0.1.161 或更高的版本，最后将其解压。</p><p>安装 IVSHMEM 驱动需要打开 <code>设备管理器</code> ，然后在 <code>系统设备</code> 下，找到 <code>PCI标准内存控制器</code> ，然后选择 <code>更新驱动程序</code> ，再选择手动更新，选择我们之前下载并解压好的驱动目录，然后安装驱动即可。</p><p>host 需要在 windows 虚拟机中安装，先下载与 client 版本对应的 host 安装文件：https://looking-glass.io/downloads 。下载完成后解压、安装即可，完成后重启虚拟机，然后通过 log 文件查看其是否正常启动，log 在开始菜单里就有。</p><p>最后再安装一下 spice guest tools， <a href=https://www.spice-space.org/download.html#windows-binaries>https://www.spice-space.org/download.html#windows-binaries</a> ，以更好的支持鼠标与剪贴板共享。</p><h5 id=配置-client>配置 client<a hidden class=anchor aria-hidden=true href=#配置-client>#</a></h5><p>我使用的配置如下，将配置文件放在 <code>~/.looking-glass-client.ini</code> 或 <code>/etc/looking-glass-client.ini</code> ：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[app]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>renderer</span><span style=color:#f92672>=</span><span style=color:#e6db74>egl</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>shmFile</span><span style=color:#f92672>=</span><span style=color:#e6db74>/dev/shm/looking-glass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[win]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>borderless</span><span style=color:#f92672>=</span><span style=color:#e6db74>yes</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fullScreen</span><span style=color:#f92672>=</span><span style=color:#e6db74>yes</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>size</span><span style=color:#f92672>=</span><span style=color:#e6db74>1920x1080</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[input]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>grabKeyboard</span><span style=color:#f92672>=</span><span style=color:#e6db74>yes</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>escapeKey</span><span style=color:#f92672>=</span><span style=color:#e6db74>97</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[spice]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>captureOnStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>yes</span>
</span></span></code></pre></div><p>由于我的笔记本没有 ScrLk 按键，所以将 escape 键设置为了 右 Ctrl 按键。</p><p>至此 looking glass 配置完成，运行命令 looking-glass-client 连接到虚拟机。</p><h5 id=配置-scream>配置 Scream<a hidden class=anchor aria-hidden=true href=#配置-scream>#</a></h5><p>由于 looking glass 不支持传递音频，所以我们还需要使用 Scream 将 VM 的音频传递给 host。</p><p>首先，编辑 windows 虚拟机的 XML，添加以下部分：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;devices&gt;</span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;shmem</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;scream-ivshmem&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;ivshmem-plain&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;size</span> <span style=color:#a6e22e>unit=</span><span style=color:#e6db74>&#39;M&#39;</span><span style=color:#f92672>&gt;</span>2<span style=color:#f92672>&lt;/size&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/shmem&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/devices&gt;</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>然后再如 looking glass 一样，添加配置文件 <code>/etc/tmpfiles.d/11-scream-ivshmem.conf</code> ，并运行命令 <code>systemd-tmpfiles --create /etc/tmpfiles.d/11-scream-ivshmem.conf</code> 。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>f   /dev/shm/scream-ivshmem <span style=color:#ae81ff>0660</span>    user    kvm -
</span></span></code></pre></div><p>如果没有安装 IVSHMEM 驱动，则需要安装一下，跟上面一样。然后下载 scream 的 windows 驱动，地址： <a href=https://github.com/duncanthrax/scream/releases>https://github.com/duncanthrax/scream/releases</a> ，解压并进行安装。</p><p>再以管理员权限在 CMD 中运行 <code>REG ADD HKLM\SYSTEM\CurrentControlSet\Services\Scream\Options /v UseIVSHMEM /t REG_DWORD /d 2</code> 。</p><p>在 Linux 物理机中安装 scream，然后创建配置文件 <code>~/.config/systemd/user/scream-ivshmem-pulse.service</code> ：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>Scream IVSHMEM pulse receiver</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>pulseaudio.service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span><span style=color:#f92672>=</span><span style=color:#e6db74>pulseaudio.service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span><span style=color:#f92672>=</span><span style=color:#e6db74>simple</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/bin/truncate -s 0 /dev/shm/scream-ivshmem</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span><span style=color:#f92672>=</span><span style=color:#e6db74>/bin/dd if=/dev/zero of=/dev/shm/scream-ivshmem bs=1M count=2</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/bin/scream -m /dev/shm/scream-ivshmem</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>default.target</span>
</span></span></code></pre></div><p>最后运行以下命令即可：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo systemctl start --user scream-ivshmem-pulse
</span></span><span style=display:flex><span>$ sudo systemctl enable --user scream-ivshmem-pulse
</span></span></code></pre></div><p>这样就配置完成了，在 looing glass 里就可以听到声音了。</p><h4 id=steam-远程畅玩流式传输>steam 远程畅玩（流式传输）<a hidden class=anchor aria-hidden=true href=#steam-远程畅玩流式传输>#</a></h4><p>因为 RDP 的限制，像 steam 家庭串流或 Geforce Experience 的方式对游戏来说更为推荐。</p><p>如果不想每次串流游戏都输入密码解锁屏幕，则可以通过 RDP 以管理员权限运行 cmd，然后运行以下命令，也可以将其保存为脚本，方便以后使用。注意运行完该命令会立马断开 RDP。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>@powershell -NoProfile -ExecutionPolicy unrestricted -Command <span style=color:#e6db74>&#34;</span>$sessionid<span style=color:#e6db74>=((quser </span>$env:USERNAME<span style=color:#e6db74> | select -Skip 1) -split &#39;\s+&#39;)[2]; tscon </span>$sessionid<span style=color:#e6db74> /dest:console&#34;</span> <span style=color:#ae81ff>2</span>&gt; UnlockErrors.log
</span></span></code></pre></div><h3 id=benchmark>benchmark<a hidden class=anchor aria-hidden=true href=#benchmark>#</a></h3><p>简单运行了一下 3dmark 的 Time Spy，做虚拟机的图形性能测试。测试了以下几种情况：</p><ul><li>win10 + 物理机直接运行，3dmark 得分 6900</li><li>win10 + 虚拟机显卡直通 + 外接显示器，3dmark 得分 6000</li><li>win10 + 虚拟机显卡直通 + steam 串流，3dmark 得分 5600</li><li>win10 + 虚拟机显卡直通 + looking glass，3dmark 得分 5000，并且在加载的时候，画面延迟近 10 秒</li></ul><p>由此可见，想要玩游戏，还是最好外接显示器，或者起码使用 steam 串流吧，个人感觉 looking glass 的性能甚至可能没有 RDP 高，但 RDP 无法运行 3dmark，所以无法比较测试。另外这几种情况中，CPU 得分的差距更大，但一般游戏也不会占用过多 CPU 资源，所以这里并没有记录。</p><p>PS：win10 + 虚拟机显卡直通 + looking glass + HDMI 欺骗器，3dmark 得分也是 5600，looking glass 的性能有待进一步测试。</p><h3 id=参考链接>参考链接<a hidden class=anchor aria-hidden=true href=#参考链接>#</a></h3><ol><li>PCI passthrough via OVMF <a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF>https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF</a></li><li>[GUIDE] Optimus laptop dGPU passthrough <a href=https://gist.github.com/Misairu-G/616f7b2756c488148b7309addc940b28>https://gist.github.com/Misairu-G/616f7b2756c488148b7309addc940b28</a></li><li>Vendor ID & Device ID <a href=https://github.com/marcosscriven/ovmf-with-vbios-patch/issues/2>https://github.com/marcosscriven/ovmf-with-vbios-patch/issues/2</a></li><li>笔记本 Optimus MUXless 下的 Intel 和 NVIDIA 虚拟机显卡直通 <a href=https://lantian.pub/article/modify-computer/laptop-intel-nvidia-optimus-passthrough.lantian/>https://lantian.pub/article/modify-computer/laptop-intel-nvidia-optimus-passthrough.lantian/</a></li><li>ledis 的单显卡直通教程 <a href=https://github.com/ledisthebest/LEDs-single-gpu-passthrough/blob/main/README-cn.md>https://github.com/ledisthebest/LEDs-single-gpu-passthrough/blob/main/README-cn.md</a></li><li>Looking glass Installation <a href=https://looking-glass.io/docs/676/install>https://looking-glass.io/docs/676/install</a></li><li>Bridging Network Connections with Proxy ARP <a href=https://wiki.debian.org/BridgeNetworkConnectionsProxyArp>https://wiki.debian.org/BridgeNetworkConnectionsProxyArp</a></li><li>setup kvm on a wireless interface on a laptop machine <a href=https://unix.stackexchange.com/questions/159191/setup-kvm-on-a-wireless-interface-on-a-laptop-machine>https://unix.stackexchange.com/questions/159191/setup-kvm-on-a-wireless-interface-on-a-laptop-machine</a></li><li>桥接无线网卡 <a href=https://blog.lilydjwg.me/2020/5/19/bridged-wireless-network.215330.html>https://blog.lilydjwg.me/2020/5/19/bridged-wireless-network.215330.html</a></li></ol><h3 id=附录xml-配置>附录：XML 配置<a hidden class=anchor aria-hidden=true href=#附录xml-配置>#</a></h3><p>最后附上我的虚拟机的 XML 配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;domain</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;kvm&#39;</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#a6e22e>xmlns:qemu=</span><span style=color:#e6db74>&#39;http://libvirt.org/schemas/domain/qemu/1.0&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;name&gt;</span>win10<span style=color:#f92672>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;uuid&gt;</span>d5da831a-c1eb-4668-a864-0731557d80a0<span style=color:#f92672>&lt;/uuid&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;metadata&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;libosinfo:libosinfo</span> <span style=color:#a6e22e>xmlns:libosinfo=</span><span style=color:#e6db74>&#34;http://libosinfo.org/xmlns/libvirt/domain/1.0&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;libosinfo:os</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;http://microsoft.com/win/10&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/libosinfo:libosinfo&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/metadata&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;memory</span> <span style=color:#a6e22e>unit=</span><span style=color:#e6db74>&#39;KiB&#39;</span><span style=color:#f92672>&gt;</span>33554432<span style=color:#f92672>&lt;/memory&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;currentMemory</span> <span style=color:#a6e22e>unit=</span><span style=color:#e6db74>&#39;KiB&#39;</span><span style=color:#f92672>&gt;</span>33554432<span style=color:#f92672>&lt;/currentMemory&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;vcpu</span> <span style=color:#a6e22e>placement=</span><span style=color:#e6db74>&#39;static&#39;</span><span style=color:#f92672>&gt;</span>8<span style=color:#f92672>&lt;/vcpu&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;resource&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;partition&gt;</span>/machine<span style=color:#f92672>&lt;/partition&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/resource&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;os&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;type</span> <span style=color:#a6e22e>arch=</span><span style=color:#e6db74>&#39;x86_64&#39;</span> <span style=color:#a6e22e>machine=</span><span style=color:#e6db74>&#39;pc-q35-6.0&#39;</span><span style=color:#f92672>&gt;</span>hvm<span style=color:#f92672>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;loader</span> <span style=color:#a6e22e>readonly=</span><span style=color:#e6db74>&#39;yes&#39;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pflash&#39;</span><span style=color:#f92672>&gt;</span>/usr/share/edk2-ovmf/OVMF_CODE.fd<span style=color:#f92672>&lt;/loader&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;nvram&gt;</span>/var/lib/libvirt/qemu/nvram/win10_VARS.fd<span style=color:#f92672>&lt;/nvram&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;bootmenu</span> <span style=color:#a6e22e>enable=</span><span style=color:#e6db74>&#39;no&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/os&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;features&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;acpi/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;apic/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;hyperv&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;relaxed</span> <span style=color:#a6e22e>state=</span><span style=color:#e6db74>&#39;on&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;vapic</span> <span style=color:#a6e22e>state=</span><span style=color:#e6db74>&#39;on&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;spinlocks</span> <span style=color:#a6e22e>state=</span><span style=color:#e6db74>&#39;on&#39;</span> <span style=color:#a6e22e>retries=</span><span style=color:#e6db74>&#39;8191&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/hyperv&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;vmport</span> <span style=color:#a6e22e>state=</span><span style=color:#e6db74>&#39;off&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/features&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;cpu</span> <span style=color:#a6e22e>mode=</span><span style=color:#e6db74>&#39;host-passthrough&#39;</span> <span style=color:#a6e22e>check=</span><span style=color:#e6db74>&#39;partial&#39;</span> <span style=color:#a6e22e>migratable=</span><span style=color:#e6db74>&#39;on&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;topology</span> <span style=color:#a6e22e>sockets=</span><span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#a6e22e>dies=</span><span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#a6e22e>cores=</span><span style=color:#e6db74>&#39;4&#39;</span> <span style=color:#a6e22e>threads=</span><span style=color:#e6db74>&#39;2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/cpu&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;clock</span> <span style=color:#a6e22e>offset=</span><span style=color:#e6db74>&#39;localtime&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;timer</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;rtc&#39;</span> <span style=color:#a6e22e>tickpolicy=</span><span style=color:#e6db74>&#39;catchup&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;timer</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pit&#39;</span> <span style=color:#a6e22e>tickpolicy=</span><span style=color:#e6db74>&#39;delay&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;timer</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;hpet&#39;</span> <span style=color:#a6e22e>present=</span><span style=color:#e6db74>&#39;no&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;timer</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;hypervclock&#39;</span> <span style=color:#a6e22e>present=</span><span style=color:#e6db74>&#39;yes&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/clock&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;on_poweroff&gt;</span>destroy<span style=color:#f92672>&lt;/on_poweroff&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;on_reboot&gt;</span>restart<span style=color:#f92672>&lt;/on_reboot&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;on_crash&gt;</span>destroy<span style=color:#f92672>&lt;/on_crash&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;pm&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;suspend-to-mem</span> <span style=color:#a6e22e>enabled=</span><span style=color:#e6db74>&#39;no&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;suspend-to-disk</span> <span style=color:#a6e22e>enabled=</span><span style=color:#e6db74>&#39;no&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/pm&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;devices&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;emulator&gt;</span>/usr/bin/qemu-system-x86_64<span style=color:#f92672>&lt;/emulator&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;disk</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;file&#39;</span> <span style=color:#a6e22e>device=</span><span style=color:#e6db74>&#39;disk&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;driver</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;qemu&#39;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;qcow2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;source</span> <span style=color:#a6e22e>file=</span><span style=color:#e6db74>&#39;/var/lib/libvirt/images/win10.qcow2&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;3&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;backingStore/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>dev=</span><span style=color:#e6db74>&#39;vda&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;virtio&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;boot</span> <span style=color:#a6e22e>order=</span><span style=color:#e6db74>&#39;1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;virtio-disk0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x04&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/disk&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;disk</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;file&#39;</span> <span style=color:#a6e22e>device=</span><span style=color:#e6db74>&#39;cdrom&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;driver</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;qemu&#39;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;raw&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;source</span> <span style=color:#a6e22e>file=</span><span style=color:#e6db74>&#39;/home/petrus/Downloads/iso/cn_windows_10_enterprise_ltsc_2019_x64_dvd_9c09ff24.iso&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;backingStore/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>dev=</span><span style=color:#e6db74>&#39;sdb&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;sata&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;readonly/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;boot</span> <span style=color:#a6e22e>order=</span><span style=color:#e6db74>&#39;2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;sata0-0-1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;drive&#39;</span> <span style=color:#a6e22e>controller=</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>target=</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>unit=</span><span style=color:#e6db74>&#39;1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/disk&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;disk</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;file&#39;</span> <span style=color:#a6e22e>device=</span><span style=color:#e6db74>&#39;cdrom&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;driver</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;qemu&#39;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;raw&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;source</span> <span style=color:#a6e22e>file=</span><span style=color:#e6db74>&#39;/home/petrus/Downloads/iso/virtio-win-0.1.185.iso&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;backingStore/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>dev=</span><span style=color:#e6db74>&#39;sdc&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;sata&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;readonly/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;sata0-0-2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;drive&#39;</span> <span style=color:#a6e22e>controller=</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>target=</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>unit=</span><span style=color:#e6db74>&#39;2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/disk&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;usb&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;qemu-xhci&#39;</span> <span style=color:#a6e22e>ports=</span><span style=color:#e6db74>&#39;15&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;usb&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x02&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;sata&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;0&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;ide&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x1f&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-root&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie.0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>chassis=</span><span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0x10&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pci.1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x02&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span> <span style=color:#a6e22e>multifunction=</span><span style=color:#e6db74>&#39;on&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;2&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>chassis=</span><span style=color:#e6db74>&#39;2&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0x11&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pci.2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x02&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;3&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>chassis=</span><span style=color:#e6db74>&#39;3&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0x12&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pci.3&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x02&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;4&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>chassis=</span><span style=color:#e6db74>&#39;4&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0x13&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pci.4&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x02&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x3&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;5&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>chassis=</span><span style=color:#e6db74>&#39;5&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0x14&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pci.5&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x02&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x4&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;6&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>chassis=</span><span style=color:#e6db74>&#39;6&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0x15&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pci.6&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x02&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x5&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;7&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>chassis=</span><span style=color:#e6db74>&#39;7&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0x8&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pci.7&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x01&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span> <span style=color:#a6e22e>multifunction=</span><span style=color:#e6db74>&#39;on&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;8&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>chassis=</span><span style=color:#e6db74>&#39;8&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0x9&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pci.8&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x01&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;9&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>chassis=</span><span style=color:#e6db74>&#39;9&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0xa&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pci.9&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x01&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;10&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>chassis=</span><span style=color:#e6db74>&#39;10&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0xb&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pci.10&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x01&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x3&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;11&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-to-pci-bridge&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie-pci-bridge&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pci.11&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x0a&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;12&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pcie-root-port&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>chassis=</span><span style=color:#e6db74>&#39;12&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0xc&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;pci.12&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x01&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x4&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;controller</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;virtio-serial&#39;</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#39;0&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;virtio-serial0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x03&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/controller&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;interface</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;network&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;mac</span> <span style=color:#a6e22e>address=</span><span style=color:#e6db74>&#39;52:54:00:9c:b1:61&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;source</span> <span style=color:#a6e22e>network=</span><span style=color:#e6db74>&#39;proxyArp&#39;</span> <span style=color:#a6e22e>portid=</span><span style=color:#e6db74>&#39;dea4d995-d8d9-408d-ac30-ac45bfd5627e&#39;</span> <span style=color:#a6e22e>bridge=</span><span style=color:#e6db74>&#39;virbr1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>dev=</span><span style=color:#e6db74>&#39;vnet0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;virtio&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;net0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x01&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/interface&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;serial</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pty&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;source</span> <span style=color:#a6e22e>path=</span><span style=color:#e6db74>&#39;/dev/pts/0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;isa-serial&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;isa-serial&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;/target&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;serial0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/serial&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;console</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pty&#39;</span> <span style=color:#a6e22e>tty=</span><span style=color:#e6db74>&#39;/dev/pts/0&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;source</span> <span style=color:#a6e22e>path=</span><span style=color:#e6db74>&#39;/dev/pts/0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;serial&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;serial0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/console&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;channel</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;spicevmc&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;target</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;virtio&#39;</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;com.redhat.spice.0&#39;</span> <span style=color:#a6e22e>state=</span><span style=color:#e6db74>&#39;connected&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;channel0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;virtio-serial&#39;</span> <span style=color:#a6e22e>controller=</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/channel&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;input</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;mouse&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;ps2&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;input0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/input&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;input</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;keyboard&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;ps2&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;input1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/input&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;graphics</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;spice&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;5900&#39;</span> <span style=color:#a6e22e>autoport=</span><span style=color:#e6db74>&#39;yes&#39;</span> <span style=color:#a6e22e>listen=</span><span style=color:#e6db74>&#39;127.0.0.1&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;listen</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;address&#39;</span> <span style=color:#a6e22e>address=</span><span style=color:#e6db74>&#39;127.0.0.1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;image</span> <span style=color:#a6e22e>compression=</span><span style=color:#e6db74>&#39;off&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;gl</span> <span style=color:#a6e22e>enable=</span><span style=color:#e6db74>&#39;no&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/graphics&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;sound</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;ich9&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;sound0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x1b&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/sound&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;audio</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;spice&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;video&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;none&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;video0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/video&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;hostdev</span> <span style=color:#a6e22e>mode=</span><span style=color:#e6db74>&#39;subsystem&#39;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>managed=</span><span style=color:#e6db74>&#39;yes&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;driver</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;vfio&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;source&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x01&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;/source&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;hostdev0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x06&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/hostdev&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;hostdev</span> <span style=color:#a6e22e>mode=</span><span style=color:#e6db74>&#39;subsystem&#39;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>managed=</span><span style=color:#e6db74>&#39;yes&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;driver</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;vfio&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;source&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x01&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;/source&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;hostdev1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x07&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/hostdev&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;hostdev</span> <span style=color:#a6e22e>mode=</span><span style=color:#e6db74>&#39;subsystem&#39;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>managed=</span><span style=color:#e6db74>&#39;yes&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;driver</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;vfio&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;source&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x01&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;/source&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;hostdev2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x08&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/hostdev&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;hostdev</span> <span style=color:#a6e22e>mode=</span><span style=color:#e6db74>&#39;subsystem&#39;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>managed=</span><span style=color:#e6db74>&#39;yes&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;driver</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;vfio&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;source&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x01&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x3&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;/source&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;hostdev3&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x09&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/hostdev&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;redirdev</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;usb&#39;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;spicevmc&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;redir0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;usb&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/redirdev&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;redirdev</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;usb&#39;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;spicevmc&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;redir1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;usb&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#39;3&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/redirdev&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;memballoon</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;virtio&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;balloon0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x05&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x00&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/memballoon&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;shmem</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;looking-glass&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;ivshmem-plain&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;size</span> <span style=color:#a6e22e>unit=</span><span style=color:#e6db74>&#39;M&#39;</span><span style=color:#f92672>&gt;</span>128<span style=color:#f92672>&lt;/size&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;shmem0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x0b&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x01&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/shmem&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;shmem</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;scream-ivshmem&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;model</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;ivshmem-plain&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;size</span> <span style=color:#a6e22e>unit=</span><span style=color:#e6db74>&#39;M&#39;</span><span style=color:#f92672>&gt;</span>2<span style=color:#f92672>&lt;/size&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;alias</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;shmem1&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;address</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;pci&#39;</span> <span style=color:#a6e22e>domain=</span><span style=color:#e6db74>&#39;0x0000&#39;</span> <span style=color:#a6e22e>bus=</span><span style=color:#e6db74>&#39;0x0b&#39;</span> <span style=color:#a6e22e>slot=</span><span style=color:#e6db74>&#39;0x02&#39;</span> <span style=color:#a6e22e>function=</span><span style=color:#e6db74>&#39;0x0&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/shmem&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/devices&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;seclabel</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#39;dynamic&#39;</span> <span style=color:#a6e22e>model=</span><span style=color:#e6db74>&#39;dac&#39;</span> <span style=color:#a6e22e>relabel=</span><span style=color:#e6db74>&#39;yes&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;label&gt;</span>+77:+77<span style=color:#f92672>&lt;/label&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;imagelabel&gt;</span>+77:+77<span style=color:#f92672>&lt;/imagelabel&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/seclabel&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;qemu:commandline&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;qemu:arg</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#39;-set&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;qemu:arg</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#39;device.hostdev0.x-pci-sub-vendor-id=6058&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;qemu:arg</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#39;-set&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;qemu:arg</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#39;device.hostdev0.x-pci-sub-device-id=14919&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/qemu:commandline&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/domain&gt;</span>
</span></span></code></pre></div><h2 id=apps>Apps<a hidden class=anchor aria-hidden=true href=#apps>#</a></h2><h3 id=中文字体httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle4b8ade69687e5ad97e4bd93><a href=https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93>中文字体</a><a hidden class=anchor aria-hidden=true href=#中文字体httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle4b8ade69687e5ad97e4bd93>#</a></h3><p>在应用之前，最好先安装好中文字体和 <a href=https://www.reddit.com/r/Gentoo/comments/i26kj3/some_emojis_are_not_displayed_on_my_chrome/>emojis</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge media-fonts/noto-cjk media-fonts/noto-emoji</span>
</span></span><span style=display:flex><span><span style=color:#75715e># eselect fontconfig list</span>
</span></span><span style=display:flex><span><span style=color:#75715e># eselect fontconfig enable 70-noto-cjk.conf</span>
</span></span></code></pre></div><p>要在系统范围内（对所有用户有效）<a href=https://wiki.archlinux.org/title/Fonts_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E6%89%8B%E5%8A%A8%E5%AE%89%E8%A3%85%E5%AD%97%E4%BD%93>安装字体</a>，请将文件夹移动到 <code>/usr/share/fonts/</code> 目录。这些文件需要对每个用户而言都是可读的，使用 chmod 来设置合理的权限 (比如，文件至少为 <code>0444</code> ，而目录至少为 <code>0555</code>)。要为单个用户安装字体，请使用 <code>~/.local/share/fonts</code> (<code>~/.fonts/</code> 现在已经过时了)。</p><p>然后更新 fontconfig 的字体缓存：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ fc-cache -vf
</span></span></code></pre></div><h4 id=改善字体渲染效果httpszhuanlanzhihucomp343934880><a href=https://zhuanlan.zhihu.com/p/343934880>改善字体渲染效果</a><a hidden class=anchor aria-hidden=true href=#改善字体渲染效果httpszhuanlanzhihucomp343934880>#</a></h4><ul><li><p>安装字体：改成Sarasa效果和Noto差别很小，倒是换成文泉驿倒是真的字体平滑了许多，模糊边缘也少了点点，但还是有，kde的字体渲染做的真不咋样哦，还是ubuntu的gnome字体渲染最舒服。</p><ul><li><p>下载<a href=https://github.com/be5invis/Sarasa-Gothic>更纱黑体(Sarasa Gothic)</a></p><p>TUNA (CN): <a href=https://mirrors.tuna.tsinghua.edu.cn/github-release/be5invis/Sarasa-Gothic>https://mirrors.tuna.tsinghua.edu.cn/github-release/be5invis/Sarasa-Gothic</a></p><p>NJU (CN): <a href=https://mirror.nju.edu.cn/github-release/be5invis/Sarasa-Gothic>https://mirror.nju.edu.cn/github-release/be5invis/Sarasa-Gothic</a></p></li><li><p><a href=http://wenq.org/wqy2/index.cgi?FontGuide#_2>文泉驿正黑</a>/<a href=http://wenq.org/wqy2/index.cgi?FontGuide#_5>文泉驿微米黑</a>：开源的文泉驿正黑矢量字体是不错的选择，当然现在流行的是微米黑</p></li></ul></li><li><p>调整系统字体：系统设置 -> 字体</p><p>在系统字体设置那将那些默认的noto sans字体改为更纱黑体即可，前三个最好相应调大一个等级。等距字体可以使用等距更纱黑体，也可以使用你喜欢的等距字体。</p><p><img loading=lazy src=/Distributions/v2-7bde73db7d1a88d0e9bf3123879d99ca_r.jpg alt></p></li><li><p>调整系统缩放：系统设置 -> 显示和监控 -> 显示配置 -> 缩放显示</p><p>默认是100%，可以调整到110～120之间，具体数值根据自己效果设定</p></li><li><p>调整字体DPI：系统设置 -> 字体 -> 勾选“固定字体DPI”并调整DPI的值</p><p>默认是96，同样也可以调整到110~120之间，具体数值根据自己效果设定</p></li><li><p>调整字体展示优先级</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE fontconfig SYSTEM &#34;fonts.dtd&#34;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;fontconfig&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;alias&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;family&gt;</span>sans-serif<span style=color:#f92672>&lt;/family&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;prefer&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;family&gt;</span>Sarasa Gothic SC<span style=color:#f92672>&lt;/family&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;family&gt;</span>Sarasa Gothic TC<span style=color:#f92672>&lt;/family&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;family&gt;</span>Sarasa Gothic J<span style=color:#f92672>&lt;/family&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;family&gt;</span>Sarasa Gothic K<span style=color:#f92672>&lt;/family&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/prefer&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/alias&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;alias&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;family&gt;</span>monospace<span style=color:#f92672>&lt;/family&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;prefer&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;family&gt;</span>Sarasa Mono SC<span style=color:#f92672>&lt;/family&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;family&gt;</span>Sarasa Mono TC<span style=color:#f92672>&lt;/family&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;family&gt;</span>Sarasa Mono J<span style=color:#f92672>&lt;/family&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;family&gt;</span>Sarasa Mono K<span style=color:#f92672>&lt;/family&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/prefer&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/alias&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/fontconfig&gt;</span>
</span></span></code></pre></div><p>将上述内容保存为：~/.fonts.conf文件</p></li></ul><p>调整完之后注销重新登入</p><h3 id=输入法httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle8be93e585a5e6b395><a href=https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E8%BE%93%E5%85%A5%E6%B3%95>输入法</a><a hidden class=anchor aria-hidden=true href=#输入法httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle8be93e585a5e6b395>#</a></h3><p>作为中文用户，肯定需要款输入法，我推荐使用 fcitx （还有一款叫 ibus）。目前稳定维护的 fcitx 版本是 5 ，但是官方仓库 <code>::gentoo</code> 目前只有 4 （也能用，就是不怎么维护了）。</p><h4 id=官方仓库-fcitx4>官方仓库 fcitx4<a hidden class=anchor aria-hidden=true href=#官方仓库-fcitx4>#</a></h4><p><strong>重要</strong>：先配置下 fcitx4 开启对 gtk2 的支持以避免有些程序无法使用（gtk3 默认开启了）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># echo &#39;app-i18n/fcitx gtk2&#39; &gt;&gt; /etc/portage/package.use/fcitx</span>
</span></span></code></pre></div><p>然后安装</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge app-i18n/fcitx:4 app-i18n/fcitx-configtool:4 app-i18n/fcitx-qt5:4 app-i18n/fcitx-libpinyin:4</span>
</span></span></code></pre></div><p>其中：</p><ul><li>app-i18n/fcitx 是 fcitx 的主程序</li><li>app-i18n/fcitx-configtool 是它的配置工具</li><li>app-i18n/fcitx-qt5 用于支持在 qt 程序上使用它</li><li>app-i18n/fcitx-libpinyin 是一个输入法</li></ul><h4 id=额外仓库-fcitx5>额外仓库 fcitx5<a hidden class=anchor aria-hidden=true href=#额外仓库-fcitx5>#</a></h4><p>为使用最新的 fcitx5，这里需要使用额外的仓库 ，因为官方仓库目前（2021-11-23）没有。提供 fcitx5 的 Gentoo 仓库（Overlay）推荐 <a href=https://github.com/gentoo-mirror/gentoo-zh>gentoo-zh</a> 。具体方法为：</p><ul><li><p>先安装添加额外的仓库必要的工具</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge app-eselect/eselect-repository</span>
</span></span></code></pre></div></li><li><p>然后启用仓库，启用过程中，可能会因为网络原因导致比较慢，请耐心等待</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eselect repository enable gentoo-zh</span>
</span></span></code></pre></div></li><li><p>更新以获取下仓库内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge dev-vcs/git</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge --sync gentoo-zh</span>
</span></span></code></pre></div><p>如果一直卡在这里，那说明当前网络访问 github.com 不流畅。这时候有一种方法是：访问 <a href=https://fastgit.org>https://fastgit.org</a> （我不对该网站做任何保证），　修改 <code>/etc/portage/repos.conf/eselect-repo.conf</code> 文件，替换对应链接的域名为上述网站内指定值，并再次同步。</p></li><li><p>添加 portage 配置用于安装</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># mkdir -p /etc/portage/package.mask/</span>
</span></span><span style=display:flex><span><span style=color:#75715e># nano /etc/portage/package.mask/gentoo-zh</span>
</span></span><span style=display:flex><span>*/*::gentoo-zh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># mkdir -p /etc/portage/package.unmask/</span>
</span></span><span style=display:flex><span><span style=color:#75715e># nano /etc/portage/package.unmask/fcitx5</span>
</span></span><span style=display:flex><span>app-i18n/fcitx5-meta::gentoo-zh
</span></span><span style=display:flex><span>app-i18n/fcitx5::gentoo-zh
</span></span><span style=display:flex><span>app-i18n/fcitx5-configtool::gentoo-zh
</span></span><span style=display:flex><span>app-i18n/fcitx5-chinese-addons::gentoo-zh
</span></span><span style=display:flex><span>app-i18n/fcitx5-gtk::gentoo-zh
</span></span><span style=display:flex><span>app-i18n/fcitx5-qt::gentoo-zh
</span></span><span style=display:flex><span>app-i18n/libime::gentoo-zh
</span></span><span style=display:flex><span>x11-libs/xcb-imdkit::gentoo-zh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># mkdir -p /etc/portage/package.accept_keywords</span>
</span></span><span style=display:flex><span><span style=color:#75715e># nano /etc/portage/package.accept_keywords/fcitx5</span>
</span></span><span style=display:flex><span>app-i18n/fcitx5-meta ~amd64
</span></span><span style=display:flex><span>app-i18n/fcitx5 ~amd64
</span></span><span style=display:flex><span>app-i18n/fcitx5-configtool ~amd64
</span></span><span style=display:flex><span>app-i18n/fcitx5-chinese-addons ~amd64
</span></span><span style=display:flex><span>app-i18n/fcitx5-gtk ~amd64
</span></span><span style=display:flex><span>app-i18n/fcitx5-qt ~amd64
</span></span><span style=display:flex><span>app-i18n/libime ~amd64
</span></span><span style=display:flex><span>x11-libs/xcb-imdkit ~amd64
</span></span></code></pre></div></li><li><p>之后安装</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge app-i18n/fcitx5-meta</span>
</span></span></code></pre></div><p>或者</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># EGIT_OVERRIDE_REPO_FCITX_LIBIME=https://hub.fastgit.org/fcitx/libime.git EGIT_OVERRIDE_REPO_KPU_KENLM=https://hub.fastgit.org/kpu/kenlm.git emerge app-i18n/fcitx5-meta</span>
</span></span></code></pre></div><p>这里安装了 fcitx 的元包，它会自动依赖安装 fcitx5 主体、 RIME 输入法、配置工具等，这个仓库也会默认安装上 fcitx5-chinese-addons ，里面包含有中文输入法。</p><p>如果安装的时候长时间停止在校验 manifest，尝试用 eclean 清除 distfiles 和 packages。可能原因是混合使用了 gentoo（官方） 和 gentoo-zh（overlay）。</p></li><li><p>最后安装<a href=https://github.com/felixonmars/fcitx5-pinyin-zhwiki>肥猫百万大词库</a>：</p><p>Download latest version of &ldquo;zhwiki.dict&rdquo; from <a href=https://github.com/felixonmars/fcitx5-pinyin-zhwiki/releases>https://github.com/felixonmars/fcitx5-pinyin-zhwiki/releases</a></p><p>Copy into <code>~/.local/share/fcitx5/pinyin/dictionaries/</code> (create the folder if it does not exist)</p></li></ul><p><strong>提示</strong>：</p><ul><li><p>当使用非官方的 Fcitx5 时，因为没有镜像收录，所以源码需从 Github 下载，这时可能遇到因网络问题导致无法下载的情况（可以从 <code>/var/log/emerge-fetch.log</code> 文件查看源码包下载情况），如果遇到这种情况那么请自行通过各种途径下载好对应的 <code>.tar.gz</code> 格式（或类似）软件包，然后移动到 <code>/var/cache/distfiles/</code> 目录下。</p></li><li><p>软件包需更名为对应的包名加完整的版本号（执行上述 <code>emerge &lt;包名></code> 命令后可以看到完整的版本号），比如当显示的包名为 <code>app-i18n/fcitx-gtk-5.0.8:5::gentoo-zh</code> 那么就更名下载的源码包为 <code>fcitx-gtk-5.0.8.tar.gz</code> （ <code>/</code> 符号后以及 <code>:</code> 符号前的内容），以此类推。</p></li><li><p>或者，在 emerge-fetch.log 可以看到下载链接和类似如下的行</p><pre tabindex=0><code>Saving to: ‘/var/cache/distfiles/fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2.__download__’
</code></pre><p>通过下载链接下载文件后，改名为删除 <code>.__download__</code> 剩余部分，如 <code>fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2</code>，然后删除对应的 <code>/var/cache/distfiles/fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2.__download__</code> 缓存文件，并把重命名的文件移动到 <code>/var/cache/distfiles/</code>。</p></li></ul><h5 id=拥抱fcitx5httpsblogcoelacanthusmoepoststechwelcome-to-fcitx5><a href=https://blog.coelacanthus.moe/posts/tech/welcome-to-fcitx5/>拥抱Fcitx5</a><a hidden class=anchor aria-hidden=true href=#拥抱fcitx5httpsblogcoelacanthusmoepoststechwelcome-to-fcitx5>#</a></h5><p><strong>起因</strong></p><p>2015年12月，<del>计科杀手</del> csslayer 创建了<a href=https://github.com/fcitx/fcitx5>fcitx/fcitx5</a>代码库，独自开始了对 Fcitx5 的开发。</p><p>如今五年过去了，Fcitx5 也日渐成熟。（个人感觉算法上相当不错</p><p>今年年初，我从 <code>fcitx-rime</code> 换到 <code>fcitx5-rime</code> ，感觉并不明显 <del>（毕竟对于 Rime 用户来说从4到5最大的变化是界面</del></p><p>然后，<del>在 Arch Linux CN 众多群友的诱惑下,</del> 我决定尝试一下 Fcitx5 自带的拼音输入法。</p><p>首次使用的体验是相当的棒的，Fcitx5 在默认配置下表现良好，云拼音也有百度，Google，Google CN 三种可选<del>尽管我不怎么用云拼音</del>，整句输入也是相当的棒，还有输入预测功能。</p><p>但这并不是让我抛弃我在 Rime 积攒下的词库投靠<del>老K输入法</del>Fcitx5自带拼音的理由……真正的原因是最近发生的几件事……</p><ul><li><p>首先是非常好的反馈体验，开发者老K对待用户非常友好，而且生产力十足</p></li><li><p>然后是 Felix 爬了维基百科制作了<a href=https://github.com/felixonmars/fcitx5-pinyin-zhwiki>肥猫百万大词库</a>，随后大佬 outloudvi 制作了<a href=https://github.com/outloudvi/fcitx5-pinyin-moegirl>萌娘百科词库</a>，Fcitx5 的日用词库基本满足（AUR 上皆有打包，且在 Arch CN 源有打包</p></li><li><p>肥猫大词库中的<a href=https://github.com/felixonmars/fcitx5-pinyin-zhwiki/issues/6>一个讨论</a>促使Fcitx5引入了一项新功能——根据前缀生成候选项，效果如图：</p><p><img loading=lazy src=/Distributions/fcitx5-prefix-input.webp alt>
这个功能我觉得对于长词输入是很棒的</p></li><li><p>添加了类似搜狗U模式的拆字模式，效果如图：</p><p><img loading=lazy src=/Distributions/fcitx5-chaizi.webp alt></p></li><li><p>还有一件事是 Fcitx5 可以使用 <code>fcitx</code>, <code>fcitx5</code>, <code>ibus</code> 的输入法模块（感觉黑科技</p></li><li><p>我从 rime 移植过来一份<a href=https://github.com/CoelacanthusHex/dotfiles/blob/master/fcitx5/.local/share/fcitx5/pinyin/symbolic.dict.txt>符号表</a>，这样输入就方便了很多</p></li></ul><p><strong>优势</strong></p><ul><li>上述几条个人认为皆为优势</li><li><code>fcitx5-rime</code> 支持加载动态库形式的 Rime 插件，在设置中填写插件名称即可使用，注意 octagram 插件名称与文件名并不一样（<code>fcitx-rime</code> 无此支持，<code>ibus-rime</code> 有此支持但是似乎配置文件有点问题（喜讯：Arch 官方仓库中的 <code>librime</code> 已经打包了 lua 和 octagram（即语料库）插件</li><li>自带一套 LaTeX 简易输入表（虽然只能输入一小部分特殊字符</li><li>笔画过滤: 参见 <a href="https://wiki.archlinux.org/index.php?title=Fcitx5_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E4%BD%BF%E7%94%A8%E7%AC%94%E7%94%BB%E8%BF%87%E6%BB%A4">Fcitx5_使用笔画过滤</a></li><li>以词定字</li><li>查看选中文字的 Unicode 编码：选中文字，然后使用快捷键 ctrl + alt + shift + u 可以查看选中文字的编码</li><li>更好的支持（Fcitx4 已经停止支持</li></ul><p><strong>关于设置</strong></p><p>推荐以下设置：</p><ul><li>预测看个人喜好</li><li>启用颜文字</li><li>云拼音根据需要来，但是不推荐 Google 后端，原因显然</li><li>preedit 也就是单行显示自己选择</li><li>安装肥猫百万大词库（墙裂推荐</li><li>Lua 插件！！！自带日期和时间，另外<a href=https://github.com/glaumar/fcitx5-lua-scripts>推荐几个</a>，内含进制转换、简易计算器和密码生成器</li></ul><p><strong>主题美化</strong></p><p>有以下几种选择：</p><ul><li><p><code>kimpanel</code>(KDE)/<code>gnome-shell-extension-kimpanel</code>(Gnome) （同时这也应该是目前 Wayland 下唯一的方案）</p></li><li><p><a href=https://github.com/hosxy/Fcitx5-Material-Color>Material Color 主题</a>，有多种颜色以及单行双行两种模式，Arch 官方源有打包</p><p><img loading=lazy src=/Distributions/Fcitx5-Material-Color-No-Preedit.webp alt></p></li><li><p><a href=https://github.com/hosxy/fcitx5-dark-transparent>黑色透明主题</a></p><p><img loading=lazy src=/Distributions/fcitx5-skin-dark-transparent.webp alt></p></li><li><p><a href=https://github.com/evansan/fcitx5-dark>黑色主题</a></p><p><img loading=lazy src=/Distributions/fcitx5-skin-dark.webp alt></p></li><li><p><a href=https://github.com/hosxy/Fcitx5-Materia-EXP>Materia EXP 主题</a>，系统使用暗色主题的用户请谨慎使用</p><p><img loading=lazy src=/Distributions/Fcitx5-Materia-EXP.webp alt></p></li><li><p><a href=https://github.com/weearc/fcitx5-skin-simple-blue>Simple Blue 主题</a></p><p><img loading=lazy src=/Distributions/fcitx5-skin-simple-blue.webp alt></p></li><li><p><a href=https://github.com/escape0707/fcitx5-adwaita-dark>Adwaita-dark</a>，推荐 Gnome 用户使用</p><p><img loading=lazy src=/Distributions/fcitx5-skin-adwaita-dark.webp alt></p></li><li><p>经典的<a href=https://github.com/hrko99/fcitx-skin-material>Material 主题</a>，这个主题同时支持4和5 <del>我都没注意这个主题更新了 fcitx5 支持</del>（fcitx5 版本有人<a href=https://aur.archlinux.org/packages/fcitx5-skin-material/>在 AUR 上打了包</a>，包名：<code>fcitx5-skin-material</code></p></li><li><p><a href=https://github.com/btstream/fcitx5-skin-base16-material-darker>base16 material darker 主题</a></p></li><li><p>自制主题 <del>（顺便写份主题文档吧</del></p></li></ul><p>以上主题在 AUR 皆有打包(似乎目前已有主题在 AUR 上都有打包了</p><h5 id=fcitx5皮肤制作httpsbbsdeepinorgphonezhpost223810><a href=https://bbs.deepin.org/phone/zh/post/223810>fcitx5皮肤制作</a><a hidden class=anchor aria-hidden=true href=#fcitx5皮肤制作httpsbbsdeepinorgphonezhpost223810>#</a></h5><p>这次是 fcitx5 是用搜狗皮肤（无法实现动态）！</p><p><strong>下载仓库</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git clone https://github.com/fkxxyz/ssfconv.git
</span></span><span style=display:flex><span>$ cd ssfconv
</span></span></code></pre></div><p><strong>下载皮肤</strong></p><p>先从<a href=https://pinyin.sogou.com/skins/>搜狗输入法的皮肤官网</a>下载自己喜欢的皮肤，得到ssf格式的文件，例如 【雨欣】蒲公英的思念.ssf</p><p><strong>转换皮肤</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./ssfconv -t fcitx5 【雨欣】蒲公英的思念.ssf 【雨欣】蒲公英的思念
</span></span></code></pre></div><p><strong>复制到用户皮肤目录</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir -p ~/.local/share/fcitx5/themes/
</span></span><span style=display:flex><span>$ cp -r 【雨欣】蒲公英的思念 ~/.local/share/fcitx5/themes/
</span></span></code></pre></div><p><strong>使用该皮肤</strong></p><p>用下面这条命令可以看到该皮肤的名称：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ grep Name ~/.local/share/fcitx5/themes/【雨欣】蒲公英的思念/theme.conf
</span></span></code></pre></div><p>直接修改配置文件 <code>~/.config/fcitx5/conf/classicui.conf</code>，将 Theme 的值改成这个皮肤的名称即可。</p><h5 id=fcitx5rime的畅快体验httpszhuanlanzhihucomp287774005><a href=https://zhuanlan.zhihu.com/p/287774005>fcitx(5)+rime的畅快体验</a><a hidden class=anchor aria-hidden=true href=#fcitx5rime的畅快体验httpszhuanlanzhihucomp287774005>#</a></h5><ul><li><p>下载词库转换工具：<a href=https://github.com/studyzy/imewlconverter>imewlconverter</a></p></li><li><p>安装 dotnet-runtime</p></li><li><p>寻找词库文件</p><ul><li>比如从搜狗词库中寻找：<a href=https://pinyin.sogou.com/dict/>搜狗细胞词库词库下载词典_输入法字典</a></li><li>或者从qq词库中寻找：<a href=http://cdict.qq.pinyin.cn/v1/>QQ输入法-词库平台</a></li></ul></li><li><p>转换词库文件：以“网络工程词库.scel”为例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ dotnet ImeWlConverterCmd.dll -ct:pinyin -os:linux -i:scel ./网络工程词库.scel -o:rime ./network.txt
</span></span></code></pre></div><ul><li>-i:scel对应搜狗的词库文件后缀，如果你要转换qq的词库文件把这里改成qcel</li><li>-o:rime ./network.txt表示按照rime输入法词库文件格式转换，转换出的文件在当前目录下，且名字为network.txt</li></ul></li><li><p>转换完成之后将这个文件拷贝到你的用户资料目录下：</p><ul><li>fcitx4: ~/.config/fcitx/rime</li><li>fcitx5:~/.local/share/fcixt5/rime</li></ul><p>文件以luna_pinyin.xxx.dict.yaml的格式命名，如luna_pinyin.network.dict.yaml，之后重启fcitx(5)即可</p></li></ul><p><a href=https://www.jianguoyun.com/p/DbMBwGIQ1-KSCRiqiNoD>dict.7z </a>是我的词库文件，拿去解压到你的用户资料目录下即可使用。</p><h4 id=环境配置httpswikiarchlinuxorgtitlefcitxset_environment_variables_for_im_modules><a href=https://wiki.archlinux.org/title/fcitx#Set_environment_variables_for_IM_modules>环境配置</a><a hidden class=anchor aria-hidden=true href=#环境配置httpswikiarchlinuxorgtitlefcitxset_environment_variables_for_im_modules>#</a></h4><p>无论选择哪个版本、哪个仓库，安装完成后，均执行此配置，这里另开一个终端，以普通用户编辑 <code>~/.pam_environment</code> 文件（这里为普通用户的家目录下，不存在则创建一个），然后添加以下内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>GTK_IM_MODULE DEFAULT<span style=color:#f92672>=</span>fcitx
</span></span><span style=display:flex><span>QT_IM_MODULE  DEFAULT<span style=color:#f92672>=</span>fcitx
</span></span><span style=display:flex><span>XMODIFIERS    DEFAULT<span style=color:#f92672>=</span><span style=color:#ae81ff>\@</span>im<span style=color:#f92672>=</span>fcitx
</span></span><span style=display:flex><span>SDL_IM_MODULE DEFAULT<span style=color:#f92672>=</span>fcitx
</span></span></code></pre></div><p>之后，登出 KDE Plasma，后重新登陆，此时只需做最后的配置，以安装的为 <code>fcitx:5</code> 为例，</p><ol><li>右击托盘区输入法图标，选择 <code>Configure</code></li><li>点击右下角 <code>Add Input Method</code></li><li>search 框下输入 <code>Pinyin</code></li><li>选中 Pinyin 后点击右下角的 <code>Add</code></li><li><code>Apply</code> 后退出界面</li><li>右击托盘区输入法图标，选择 <code>Restart</code></li></ol><h4 id=rimehttpszhuanlanzhihucomp114296129><a href=https://zhuanlan.zhihu.com/p/114296129>Rime</a><a hidden class=anchor aria-hidden=true href=#rimehttpszhuanlanzhihucomp114296129>#</a></h4><p>安装 rime 输入法引擎</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># fcitx4</span>
</span></span><span style=display:flex><span>$ sudo emerge app-i18n/fcitx-rime
</span></span><span style=display:flex><span><span style=color:#75715e># fcitx5</span>
</span></span><span style=display:flex><span>$ sudo emerge app-i18n/fcitx5-rime
</span></span></code></pre></div><p>下载 <a href=https://github.com/fkxxyz/rime-cloverpinyin/wiki/linux>rime-cloverpinyin</a> 最新版本（如clover.schema-build-1.1.4.zip）输入方案（配置方案），解压到用户资料夹：</p><ul><li>fcitx：~/.config/fcitx/rime</li><li>fcitx5：~/.local/share/fcitx5/rime</li></ul><p>在用户资料夹下创建 default.custom.yaml ，内容为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>patch:
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;menu/page_size&#34;</span>: <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>  schema_list:
</span></span><span style=display:flex><span>    - schema: clover
</span></span></code></pre></div><p>其中 8 表示打字的时候输入面板的每一页的候选词数目，可以设置成 1~9 任意数字。</p><p>写好该文件之后，点击右下角托盘图标右键菜单，点“重新部署”，然后再点右键，在方案列表里面应该就有“ 🍀️四叶草拼音输入法”的选项了。</p><p>更多访问 <a href=https://rime.im/>Rime 官网</a>。</p><h3 id=kde-system-settings>KDE System Settings<a hidden class=anchor aria-hidden=true href=#kde-system-settings>#</a></h3><p>Appearance</p><ul><li>Global Theme: Breeze</li></ul><p>Workspace Behavior</p><ul><li>General Behavior<ul><li>Clicking files or folders: Selects them</li></ul></li><li>Screen Locking<ul><li>Lock screen automatically: 10 minutes</li></ul></li></ul><p>Startup and Shutdown</p><ul><li>Login Screen<ul><li>Breeze</li></ul></li></ul><p>Regional Settings</p><ul><li>Date & Time<ul><li>Set date and time automatically</li></ul></li></ul><p>Connections</p><ul><li>IPv4<ul><li>Method: Automatic (Only addresses)</li><li>DNS Servers: 114.114.114.114</li></ul></li></ul><p>Settings</p><ul><li>Proxy<ul><li>Use manually specified proxy configuration</li></ul></li></ul><p>Display Configuration</p><ul><li><p>Night Color</p><ul><li><p>Activate Night Color</p></li><li><p>Sunset to sunrise at manual location</p><p>Beijin: 39.90403 116.40753</p></li></ul></li></ul><h3 id=bluetoothhttpswikigentooorgwikibluetooth><a href=https://wiki.gentoo.org/wiki/Bluetooth>Bluetooth</a><a hidden class=anchor aria-hidden=true href=#bluetoothhttpswikigentooorgwikibluetooth>#</a></h3><p>蓝牙默认是无法使用的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># systemctl enable bluetooth</span>
</span></span></code></pre></div><h3 id=首选编辑器>首选编辑器<a hidden class=anchor aria-hidden=true href=#首选编辑器>#</a></h3><p>Gentoo Linux 默认安装的编辑器为 <code>nano</code> ，这是一个初始设置下就很适合新手的编辑器，如果你有其它的要求，比如想使用 <code>vim</code> 或者 <code>emacs</code> ，可以先安装</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge -vj app-editors/vim</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge -vj app-editors/emacs</span>
</span></span></code></pre></div><p>列出当前存在的编辑器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eselect editor list</span>
</span></span></code></pre></div><p>根据所需要的编辑器对应的序号，设置默认</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eselect editor set 「序号」</span>
</span></span><span style=display:flex><span><span style=color:#75715e># . /etc/profile</span>
</span></span></code></pre></div><h3 id=mutt>mutt<a hidden class=anchor aria-hidden=true href=#mutt>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge net-mail/fetchmail mail-filter/procmail mail-client/mutt mail-mta/msmtp</span>
</span></span></code></pre></div><h3 id=mpv>mpv<a hidden class=anchor aria-hidden=true href=#mpv>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge media-video/mpv</span>
</span></span></code></pre></div><h3 id=spotify>spotify<a hidden class=anchor aria-hidden=true href=#spotify>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge media-sound/spotify</span>
</span></span></code></pre></div><h3 id=youtube-dl>youtube-dl<a hidden class=anchor aria-hidden=true href=#youtube-dl>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge dev-python/pip</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=aria2>aria2<a hidden class=anchor aria-hidden=true href=#aria2>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># echo &#39;net-misc/aria2 bittorrent&#39; &gt; /etc/portage/package.use/aria2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge net-misc/aria2</span>
</span></span></code></pre></div><h3 id=typora>Typora<a hidden class=anchor aria-hidden=true href=#typora>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># echo &#39;=app-editors/typora-0.11.18::gentoo-zh=&#39; &gt; /etc/portage/package.unmask/typora</span>
</span></span><span style=display:flex><span><span style=color:#75715e># echo &#39;=app-editors/typora-0.11.18::gentoo-zh ~amd64&#39; &gt; /etc/portage/package.accept_keywords/typora</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cp -av /opt/typora/share/icons/hicolor/* /usr/share/icons/hicolor/</span>
</span></span></code></pre></div><h3 id=zsh>zsh<a hidden class=anchor aria-hidden=true href=#zsh>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge app-shells/zsh</span>
</span></span><span style=display:flex><span>$ chsh
</span></span><span style=display:flex><span>Password: 
</span></span><span style=display:flex><span>Changing the login shell <span style=color:#66d9ef>for</span> kurome
</span></span><span style=display:flex><span>Enter the new value, or press ENTER <span style=color:#66d9ef>for</span> the default
</span></span><span style=display:flex><span>        Login Shell <span style=color:#f92672>[</span>/bin/bash<span style=color:#f92672>]</span>: /bin/zsh
</span></span></code></pre></div><h3 id=clash>Clash<a hidden class=anchor aria-hidden=true href=#clash>#</a></h3><p>clash 需要 root 执行，编写一个 service 就可以了。</p><p>cfw 无法设置 port，总是重置为 0。</p><h3 id=browsers>Browsers<a hidden class=anchor aria-hidden=true href=#browsers>#</a></h3><p>关于浏览器的选择有很多，比如</p><ul><li>www-client/google-chrome （chrome 的官方二进制包）</li><li>www-client/google-chrome-beta （chrome 的官方二进制包， beta 分支）</li><li>www-client/chromium （chromium 源码包，需编译，时间很久很久）</li><li>www-client/firefox-bin （火狐官方二进制包，国际版）</li><li>www-client/firefox （火狐源码包，需编译，时间很久）</li><li>www-client/microsoft-edge-beta （Edge 官方二进制包， beta 分支）</li><li>等</li></ul><p>可以自行选择安装。命令依旧是 <code>emerge &lt;包名></code> 。安装个别浏览器时，可能会因为许可问题导致无法安装，如何解决看下文的 <a href=#Licenses>软件的许可</a> 一节。</p><p>其它的应用自行发掘。这里有推荐应用列表：</p><ul><li><a href=https://wiki.gentoo.org/wiki/Recommended_applications>https://wiki.gentoo.org/wiki/Recommended_applications</a></li><li><a href=https://wiki.archlinux.org/title/List_of_applications>https://wiki.archlinux.org/title/List_of_applications</a></li></ul><p>至此，桌面配置告一段落。</p><h3 id=kio-extrashttpswikigentooorgwikimtp><a href=https://wiki.gentoo.org/wiki/MTP>kio-extras</a><a hidden class=anchor aria-hidden=true href=#kio-extrashttpswikigentooorgwikimtp>#</a></h3><p>(only for kde)</p><p><strong>MTP</strong> (<strong>M</strong>edia <strong>T</strong>ransfer <strong>P</strong>rotocol) is a protocol to allow the transfer of files to external devices. It is provided by several programs, most of them depending on <a href=https://wiki.gentoo.org/wiki/FUSE>FUSE</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># echo &#39;kde-apps/kio-extras mtp&#39; &gt; /etc/portage/package.use/kio-extras</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge --ask kde-apps/kio-extras</span>
</span></span></code></pre></div><h3 id=gwenview>Gwenview<a hidden class=anchor aria-hidden=true href=#gwenview>#</a></h3><p>KDE app，看图。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge kde-apps/gwenview</span>
</span></span></code></pre></div><h3 id=okular>Okular<a hidden class=anchor aria-hidden=true href=#okular>#</a></h3><p>KDE app，PDF 阅读。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge kde-apps/okular</span>
</span></span></code></pre></div><h3 id=ktimer>KTimer<a hidden class=anchor aria-hidden=true href=#ktimer>#</a></h3><p>KDE app，类似于 cronie，只不过是GUI。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge kde-apps/ktimer</span>
</span></span></code></pre></div><h3 id=kclock>KClock<a hidden class=anchor aria-hidden=true href=#kclock>#</a></h3><p>KDE app，一个时钟。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eselect repository enable guru</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge --sync guru</span>
</span></span><span style=display:flex><span><span style=color:#75715e># echo &#39;*/*::guru&#39; &gt; /etc/portage/package.mask/guru</span>
</span></span><span style=display:flex><span><span style=color:#75715e># echo &#39;=kde-apps/kclock-21.12::guru&#39; &gt; /etc/portage/package.unmask/kclock</span>
</span></span><span style=display:flex><span><span style=color:#75715e># echo &#39;=kde-apps/kclock-21.12::guru ~amd64&#39; &gt; /etc/portage/package.accept_keywords/kclock</span>
</span></span><span style=display:flex><span><span style=color:#75715e># echo &#39;=kde-frameworks/kirigami-addons-0.2::guru&#39; &gt;&gt; /etc/portage/package.unmask/kclock</span>
</span></span><span style=display:flex><span><span style=color:#75715e># echo &#39;=kde-frameworks/kirigami-addons-0.2::guru ~amd64&#39; &gt;&gt; /etc/portage/package.accept_keywords/kcloc</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge kde-apps/kclock</span>
</span></span></code></pre></div><h3 id=rsibreakhttpsuserbasekdeorgrsibreakzh-cn><a href=https://userbase.kde.org/RSIBreak/zh-cn>RSIBreak</a><a hidden class=anchor aria-hidden=true href=#rsibreakhttpsuserbasekdeorgrsibreakzh-cn>#</a></h3><p>番茄钟</p><h3 id=libreoffice>LibreOffice<a hidden class=anchor aria-hidden=true href=#libreoffice>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge app-office/libreoffice-bin</span>
</span></span></code></pre></div><h3 id=flameshot>Flameshot<a hidden class=anchor aria-hidden=true href=#flameshot>#</a></h3><p>很棒的截图软件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo emerge media-gfx/flameshot
</span></span></code></pre></div><h4 id=spectacle>Spectacle<a hidden class=anchor aria-hidden=true href=#spectacle>#</a></h4><p>KDE app，用的不是很习惯。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge kde-apps/spectacle</span>
</span></span></code></pre></div><h3 id=keepassxchttpskeepassxcorg><a href=https://keepassxc.org/>KeePassXC</a><a hidden class=anchor aria-hidden=true href=#keepassxchttpskeepassxcorg>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge app-admin/keepassxc</span>
</span></span></code></pre></div><h3 id=ppsspp>PPSSPP<a hidden class=anchor aria-hidden=true href=#ppsspp>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># echo &#34;games-emulation/ppsspp ~amd64&#34; &gt;&gt; /etc/portage/package.accept_keywords/ppsspp</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge games-emulation/ppsspp</span>
</span></span></code></pre></div><h3 id=papirus-icon-themehttpsgithubcompapirusdevelopmentteampapirus-icon-theme><a href=https://github.com/PapirusDevelopmentTeam/papirus-icon-theme>papirus-icon-theme</a><a hidden class=anchor aria-hidden=true href=#papirus-icon-themehttpsgithubcompapirusdevelopmentteampapirus-icon-theme>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo emerge -a papirus-icon-theme
</span></span></code></pre></div><h3 id=vulkanhttpswikigentooorgwikivulkan><a href=https://wiki.gentoo.org/wiki/Vulkan>Vulkan</a><a hidden class=anchor aria-hidden=true href=#vulkanhttpswikigentooorgwikivulkan>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --ask media-libs/vulkan-loader</span>
</span></span></code></pre></div><h3 id=tree>tree<a hidden class=anchor aria-hidden=true href=#tree>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge app-text/tree</span>
</span></span></code></pre></div><h3 id=qemu>qemu<a hidden class=anchor aria-hidden=true href=#qemu>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># echo &#39;QEMU_SOFTMMU_TARGETS=&#34;x86_64&#34;&#39; &gt;&gt; /etc/portage/make.conf</span>
</span></span><span style=display:flex><span><span style=color:#75715e># echo &#39;QEMU_USER_TARGETS=&#34;x86_64&#34;&#39; &gt;&gt; /etc/portage/make.conf</span>
</span></span><span style=display:flex><span><span style=color:#75715e># emerge app-emulation/qemu net-fs/samba</span>
</span></span><span style=display:flex><span><span style=color:#75715e># gpasswd -a kurome kvm</span>
</span></span></code></pre></div><p><a href=https://www.dedoimedo.com/computers/kvm-permission-denied.html>Could not access KVM kernel module: Permission denied</a></p><h3 id=dockerhttpswikigentooorgwikidocker><a href=https://wiki.gentoo.org/wiki/Docker>Docker</a><a hidden class=anchor aria-hidden=true href=#dockerhttpswikigentooorgwikidocker>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --ask --verbose app-emulation/docker</span>
</span></span><span style=display:flex><span><span style=color:#75715e># systemctl enable docker.service</span>
</span></span><span style=display:flex><span><span style=color:#75715e># systemctl start docker.service</span>
</span></span><span style=display:flex><span><span style=color:#75715e># usermod -aG docker &lt;username&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># docker run --rm hello-world</span>
</span></span></code></pre></div><h3 id=lsusbhttpswikigentooorgwikiusbutils><a href=https://wiki.gentoo.org/wiki/Usbutils>lsusb</a><a hidden class=anchor aria-hidden=true href=#lsusbhttpswikigentooorgwikiusbutils>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --ask sys-apps/usbutils</span>
</span></span></code></pre></div><h3 id=p7ziphttpswikigentooorgwikip7zip><a href=https://wiki.gentoo.org/wiki/P7zip>p7zip</a><a hidden class=anchor aria-hidden=true href=#p7ziphttpswikigentooorgwikip7zip>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge app-arch/p7zip</span>
</span></span></code></pre></div><p><strong>Important</strong>: The 7-zip archive format does <strong>not</strong> store standard Unix file permissions such as owner/group or extended file attributes. Those who desire to use 7-zip as a long-term backup or archiving solution should wrap files in a tar archive before compressing with <strong>7z</strong>. Use the following command to archive directories of files, preserving Unix file permissions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tar cf - &lt;directory&gt; | 7za a -si &lt;directory&gt;.tar.7z
</span></span></code></pre></div><p>To extract:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ 7za x -so &lt;directory&gt;.tar.7z | tar xf -
</span></span></code></pre></div><h4 id=ziphttpswwwtecmintcomunzip-extract-zip-files-to-specific-directory-in-linux><a href=https://www.tecmint.com/unzip-extract-zip-files-to-specific-directory-in-linux/>zip</a><a hidden class=anchor aria-hidden=true href=#ziphttpswwwtecmintcomunzip-extract-zip-files-to-specific-directory-in-linux>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge app-arch/zip</span>
</span></span></code></pre></div><h4 id=arkhttpsappskdeorgark><a href=https://apps.kde.org/ark/>Ark</a><a hidden class=anchor aria-hidden=true href=#arkhttpsappskdeorgark>#</a></h4><p>File archiver by KDE</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge kde-apps/ark</span>
</span></span></code></pre></div><h3 id=adb-and-fastboothttpswikigentooorgwikiandroidadb><a href=https://wiki.gentoo.org/wiki/Android/adb>ADB and Fastboot</a><a hidden class=anchor aria-hidden=true href=#adb-and-fastboothttpswikigentooorgwikiandroidadb>#</a></h3><p>Fastboot is included with ADB inside the <a href=https://packages.gentoo.org/packages/dev-util/android-tools>dev-util/android-tools</a> package::</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># emerge --ask dev-util/android-tools</span>
</span></span></code></pre></div><p>To run adb without root privileges then the unprivileged user account must be added to the plugdev group:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># groupmod -a plugdev -U kurome</span>
</span></span></code></pre></div><p><strong>no permissions (missing udev rules? user is in the plugdev group)</strong></p><p>Each Android device has a USB vendor/product ID. An example for HTC Evo is:</p><pre tabindex=0><code>vendor id: 0bb4
product id: 0c8d
</code></pre><p>Plug in your device and execute:</p><pre tabindex=0><code>$ lsusb
</code></pre><p>It should come up something like this:</p><pre tabindex=0><code>Bus 002 Device 006: ID 0bb4:0c8d High Tech Computer Corp.
</code></pre><p>需<a href=https://wiki.archlinux.org/title/Android_Debug_Bridge#Adding_udev_rules>添加 udev 规则</a>：使用下面的模板，并用你的 [VENDOR ID] 和 [PRODUCT ID] 替换里面的值；确保你是 <code>adbusers</code> 用户组的成员，以访问 adb 设备。 然后把这些规则复制到 <code>/etc/udev/rules.d/51-android.rules</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SUBSYSTEM<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;usb&#34;</span>, ATTR<span style=color:#f92672>{</span>idVendor<span style=color:#f92672>}==</span><span style=color:#e6db74>&#34;[VENDOR ID]&#34;</span>, MODE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0666&#34;</span>, GROUP<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;adbusers&#34;</span>
</span></span><span style=display:flex><span>SUBSYSTEM<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;usb&#34;</span>,ATTR<span style=color:#f92672>{</span>idVendor<span style=color:#f92672>}==</span><span style=color:#e6db74>&#34;[VENDOR ID]&#34;</span>,ATTR<span style=color:#f92672>{</span>idProduct<span style=color:#f92672>}==</span><span style=color:#e6db74>&#34;[PRODUCT ID]&#34;</span>,SYMLINK+<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;android_adb&#34;</span>
</span></span><span style=display:flex><span>SUBSYSTEM<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;usb&#34;</span>,ATTR<span style=color:#f92672>{</span>idVendor<span style=color:#f92672>}==</span><span style=color:#e6db74>&#34;[VENDOR ID]&#34;</span>,ATTR<span style=color:#f92672>{</span>idProduct<span style=color:#f92672>}==</span><span style=color:#e6db74>&#34;[PRODUCT ID]&#34;</span>,SYMLINK+<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;android_fastboot&#34;</span>
</span></span></code></pre></div><p>再加载刚定义的规则，运行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># udevadm control --reload-rules</span>
</span></span></code></pre></div><p>If <em>adb</em> still does not detect the device after plugging your device back in, kill and restart the <em>adb</em> server as root and check devices again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># adb kill-server</span>
</span></span><span style=display:flex><span><span style=color:#75715e># adb start-server</span>
</span></span><span style=display:flex><span>$ adb devices
</span></span></code></pre></div><p><strong>adb: device unauthorized.</strong></p><p>请打开手机同意 USB 调试。</p><h4 id=file-transfer>File transfer<a hidden class=anchor aria-hidden=true href=#file-transfer>#</a></h4><p><strong>Push a file</strong></p><pre tabindex=0><code>$ adb push mypicture.png /sdcard/on/device
</code></pre><p><strong>Push a folder</strong></p><pre tabindex=0><code>$ adb push myfolder /sdcard/on/device
</code></pre><p><strong>Push all files in a folder</strong></p><pre tabindex=0><code>$ adb push myfolder/ /sdcard/on/device
</code></pre><p><strong>Pull a file</strong></p><pre tabindex=0><code>$ adb pull /sdcard/on/device/mypicture.png
</code></pre><p><strong>Pull a folder</strong></p><pre tabindex=0><code>$ adb pull /sdcard/on/device /home/̩$(whoami)/android-folder/
</code></pre><h3 id=flatpakhttpsflatpakorgsetupgentoo><a href=https://flatpak.org/setup/Gentoo>Flatpak</a><a hidden class=anchor aria-hidden=true href=#flatpakhttpsflatpakorgsetupgentoo>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cat &gt;&gt; /etc/portage/package.accept_keywords/flatpak</span>
</span></span><span style=display:flex><span>sys-apps/flatpak ~amd64
</span></span><span style=display:flex><span>acct-user/flatpak ~amd64
</span></span><span style=display:flex><span>acct-group/flatpak ~amd64
</span></span><span style=display:flex><span>dev-util/ostree ~amd64
</span></span><span style=display:flex><span><span style=color:#75715e># emerge sys-apps/flatpak</span>
</span></span><span style=display:flex><span><span style=color:#75715e># flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo</span>
</span></span><span style=display:flex><span><span style=color:#75715e># flatpak remote-modify flathub --url=https://mirror.sjtu.edu.cn/flathub</span>
</span></span></code></pre></div><h3 id=neofetchhttpszhuanlanzhihucomp69777438><a href=https://zhuanlan.zhihu.com/p/69777438>neofetch</a><a hidden class=anchor aria-hidden=true href=#neofetchhttpszhuanlanzhihucomp69777438>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo emerge app-misc/neofetch
</span></span></code></pre></div><h4 id=使用自定义图像>使用自定义图像<a hidden class=anchor aria-hidden=true href=#使用自定义图像>#</a></h4><p>默认情况下，Neofetch 将显示你的操作系统 logo 以及系统信息。当然，你可以根据需要更改图像。</p><p>要显示图像，Linux 系统应该安装以下依赖项：</p><ol><li>w3m-img（用于显示图像。w3m-img 有时与 w3m 包捆绑在一起），</li><li>Imagemagick（用于创建缩略图），</li></ol><p>大多数 Linux 发行版的默认仓库中都提供了 w3m-img 和 ImageMagick 包。因此，你可以使用你的发行版的默认包管理器来安装它们。</p><p>现在，运行以下命令以使用自定义图像显示系统信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ neofetch --w3m /home/sk/Pictures/image.png
</span></span></code></pre></div><p>或者，</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ neofetch --w3m --source /home/sk/Pictures/image.png
</span></span></code></pre></div><p>或者，你可以指向包含以下图像的目录。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ neofetch --w3m &lt;path-to-directory&gt;
</span></span></code></pre></div><h4 id=配置-neofetch>配置 Neofetch<a hidden class=anchor aria-hidden=true href=#配置-neofetch>#</a></h4><p>当我们第一次运行 Neofetch 时，它默认会为每个用户在 <code>$HOME/.config/neofetch/config.conf</code> 中创建一个配置文件。你可以调整此文件来告诉 neofetch 该显示、删除和/或修改哪些详细信息。</p><p>还可以在不同版本中保留此配置文件。这意味着你只需根据自己的喜好自定义一次，并在升级到更新版本后使用相同的设置。你甚至可以将此文件共享给你的朋友和同事，使他拥有与你相同的设置。</p><h3 id=flaggie>flaggie<a hidden class=anchor aria-hidden=true href=#flaggie>#</a></h3><p>安装flaggie来更加方便的管理单个包的USE变量</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo emerge app-portage/flaggie
</span></span></code></pre></div><p>用法：比如添加a包的b特性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># flaggie a +b</span>
</span></span></code></pre></div><p>去掉c包的d特性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># flaggie c -d</span>
</span></span></code></pre></div><h3 id=crossover>Crossover<a hidden class=anchor aria-hidden=true href=#crossover>#</a></h3><p><strong>注意</strong>：安装很麻烦，我转用其他方案了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># nano /etc/portage/package.accept_keywords/crossover</span>
</span></span><span style=display:flex><span>app-emulation/crossover-bin ~amd64
</span></span><span style=display:flex><span><span style=color:#75715e># nano /etc/portage/package.use/crossover</span>
</span></span><span style=display:flex><span>sys-libs/ncurses -gpm
</span></span><span style=display:flex><span><span style=color:#75715e># USE=&#34;abi_x86_32 abi_x86_64&#34; emerge app-emulation/crossover-bin</span>
</span></span></code></pre></div><p>作为环境变量的USE设定特点是，本次安装的所有软件都启用该 USE，区别在 make.conf 中使整个系统都启用该 USE 和在 package.use 中为一个一个的包设置同一个 USE（这种情况每次运行只会提示一个包，特别麻烦）。</p><p><a href=https://unix.stackexchange.com/a/90024><strong>Using ABI_X86 in Gentoo</strong></a></p><p><code>ABI_X86</code> is a <a href=http://devmanual.gentoo.org/general-concepts/use-flags/#use_expand-and-arch-use-flags><code>USE_EXPAND</code></a> variable; setting <code>ABI_X86="32 64"</code> or <code>USE="abi_x86_32 abi_x86_64"</code> are equivalent.</p><h3 id=bottles>Bottles<a hidden class=anchor aria-hidden=true href=#bottles>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo flatpak install flathub com.usebottles.bottleses
</span></span></code></pre></div><h3 id=deja-dup>deja-dup<a hidden class=anchor aria-hidden=true href=#deja-dup>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo nano /etc/portage/package.accept_keywords/deja-dup
</span></span><span style=display:flex><span>app-backup/deja-dup ~amd64
</span></span><span style=display:flex><span>$ sudo nano /etc/portage/package.use/deja-dup
</span></span><span style=display:flex><span>gnome-base/gvfs fuse
</span></span><span style=display:flex><span>$ sudo app-backup/deja-dup
</span></span></code></pre></div><h2 id=dotfileshttpsdotfilesgithubio><a href=https://dotfiles.github.io/>dotfiles</a><a hidden class=anchor aria-hidden=true href=#dotfileshttpsdotfilesgithubio>#</a></h2><h3 id=general-purpose-dotfiles-utilities>General-purpose dotfiles utilities<a hidden class=anchor aria-hidden=true href=#general-purpose-dotfiles-utilities>#</a></h3><p>These are programs that help with managing, syncing, and/or installing your dotfiles.</p><ul><li><a href=https://chezmoi.io/>chezmoi</a> (6282 stars) makes it easy to manage your dotfiles across multiple machines, securely. chezmoi is <a href=https://chezmoi.io/install/>easy to install</a>, <a href=https://chezmoi.io/quick-start/>quick to start with</a>, and is <a href=https://www.chezmoi.io/user-guide/setup/>very powerful</a>. You can install chezmoi and your dotfiles with a single command, without needing Python installed, or even git. Read how <a href=https://www.chezmoi.io/comparison-table/>chezmoi compares to other dotfile managers</a>.</li><li><a href=https://github.com/anishathalye/dotbot>Dotbot</a> (5173 stars) is a lightweight standalone tool to bootstrap dotfiles, making it easy to have a “one click” installation/upgrade process for your dotfiles.</li><li><a href=https://yadm.io/>yadm</a> (3239 stars) is a dotfile management tool which supports system-specific alternate files/templating, encryption of private data, custom bootstrap actions, and integration with other git-aware tools like vim-fugitive, tig, git-crypt, etc.</li><li><a href=https://github.com/thoughtbot/rcm>rcm</a> (2742 stars) is a set of well-documented shell scripts that help manage your dotfiles. It is easily installable on macOS with the homebrew package manager, but works on all Unix operating systems.</li><li><a href=https://github.com/rycee/home-manager>Home Manager</a> (2696 stars) by Robert Helgesson is a system built for managing <a href=https://nixos.org/>NixOS</a> user environments using the <a href=https://nixos.org/nix/>Nix</a> package manager and the <a href=https://nixos.org/nixpkgs/>Nixpkgs</a> libraries.</li><li><a href=https://github.com/technicalpickles/homesick>Homesick</a> (2342 stars) by Josh Nichols. Homesick makes it easy to symlink and clone dotfiles repos.</li><li><a href=https://github.com/RichiH/vcsh>vcsh</a> (1947 stars) by Richard “RichiH” Hartmann. <code>vcsh</code> manages all your dotfiles in Git without the need for symlinks. Any number of Git repositories will co-exist in parallel in your <code>$HOME</code> without interfering with each other. Advanced use cases with different branches for different systems are supported by default. An extensive hook system lets you customize your repositories. <code>vcsh</code> includes batch push, pull, and status commands which operate on all your repositories at once.</li><li><a href=https://github.com/andsens/homeshick>Homeshick</a> (1827 stars) by Anders Ingemann is like Homesick but written in bash. Great to combine with <a href=https://web.archive.org/web/20200904205236/https://waiting-for-dev.github.io/blog/2014/05/04/distributable-and-organized-dotfiles-with-homeshick-and-mr/>myrepos</a>.</li><li><a href=https://github.com/freshshell/fresh>fresh</a> (1079 stars) is a tool to source dotfiles from others into your own. It supports shell configuration (aliases, functions, etc.) as well as config files (e.g. <code>ackrc</code> and <code>gitconfig</code>). Think of it as <em>Bundler for your dotfiles</em>.</li><li><a href=https://github.com/deadc0de6/dotdrop>dotdrop</a> (1069 stars) makes the management of dotfiles between different hosts easy. It allows to store your dotfiles on git and automagically deploy different versions on different setups.</li><li><a href=https://github.com/alichtman/shallow-backup>shallow-backup</a> (870 stars) lets you easily create lightweight backups of installed packages, applications, fonts and dotfiles, and automatically push them to a remote Git repository.</li><li><a href=https://github.com/jbernard/dotfiles>dotfiles</a> (539 stars) Dotfile management made easy. Written in Python (available on PyPI) by Jon Bernard.</li><li><a href=https://github.com/ellipsis/ellipsis>Ellipsis</a> (336 stars) is a package manager for dotfiles.</li><li><a href=https://github.com/SuperCuber/dotter>dotter</a> (325 stars) A dotfile manager and templater written in Rust, with Windows/Linux/Mac support.</li><li><a href=https://github.com/dotphiles/dotsync>Dotsync</a> (284 stars) utility for syncing dotfiles between multiple machines from a Git repo or push using rsync.</li><li><a href=https://github.com/philips/ghar>Ghar</a> (268 stars) by Brandon Philip. Ghar is a standalone Python script for managing Git repos symlinked into your home.</li><li><a href=https://github.com/FooSoft/homemaker>Homemaker</a> (223 stars) by Alex Yatskov. Homemaker is a standalone tool written in Golang to manage both common and machine-specific dotfile settings. Homemaker can be configured in TOML, YAML or JSON.</li><li><a href=https://github.com/svetlyak40wt/dotfiler>dotfiler</a> (223 stars) is inspired by homesick and <a href=https://github.com/holman/dotfiles>Zach Holman’s dotfiles</a>, made using principle of KISS.</li><li><a href=https://github.com/pearl-core/pearl>Pearl</a> (186 stars) is a brand new revolutionary package manager that allows to automatically activate dotfiles whenever shells or editors start via a smart hook mechanism. Dotfiles are treated as packages that coexist together seamlessly and can be fully controlled and synced across different systems. There is a wide range of packages already available in the <a href=https://github.com/pearl-hub>Official Pearl Hub</a>.</li><li><a href=https://www.comtrya.dev/>comtrya</a> (155 stars) configuration Management for Localhost / dotfiles.</li><li><a href=https://github.com/kobus-v-schoor/dotgit>dotgit</a> (148 stars) by Kobus van Schoor. A comprehensive and versatile dotfiles manager which helps to synchronize your dotfiles between multiple computers and devices.</li><li><a href=https://github.com/jh3y/kody>kody</a> (130 stars) is a dotfiles runner/manager written with node inspired by Zach Holman’s popular dotfiles.</li><li><a href=https://github.com/justone/dfm>dfm</a> (113 stars) is a utility to manage your dotfiles, lightweight and simple.</li><li><a href=https://www.gnu.org/software/stow/>GNU Stow</a> is a symlink farm manager, useful for automatically (and safely) linking your dotfiles folder into your home directory.</li></ul><h3 id=使用-gnu-stow-管理你的點文件httpfarseerfcmeusing-gnu-stow-to-manage-your-dotfileshtml><a href=http://farseerfc.me/using-gnu-stow-to-manage-your-dotfiles.html#>使用 GNU stow 管理你的點文件</a><a hidden class=anchor aria-hidden=true href=#使用-gnu-stow-管理你的點文件httpfarseerfcmeusing-gnu-stow-to-manage-your-dotfileshtml>#</a></h3><p>我昨天偶然間發現一些我覺得值得分享的經驗，就是那種「爲毛我沒有早點知道這個？」那一類的。 我將在這篇文章中介紹如何使用 GNU Stow 管理你的 GNU/Linux 系統中位於用戶家目錄裏的各種配置文件 （通常又叫「點文件(dotfiles)」比如 .bashrc）。</p><p>這件事的困難之處在於，如果能用版本管理系統(VCS, Version Control System)比如 Git, Mercurial(hg), Bazaar(bzr) 管理點文件的話會非常方便，但是這些點文件大部分都位於家目錄的頂級目錄下， 在這個位置不太適合初始化一個版本管理倉庫。這些年下來我試過很多程序，設計目的在於解決這個問題， 幫你把這些配置文件安置在某個下級目錄中，然後安裝或者鏈接這些文件到它們應該在的位置。 嘗試下來這些程序沒有一個真正能打動我。它們要麼有很多依賴（比如 Ruby 和一大坨庫）， 要麼需要我記住如何用它，考慮到同步配置這種不算經常使用的場合，要記住用法真的挺難。</p><p>最近我在用 GNU Stow 來管理我從源代碼在本地編譯安裝到 <code>/usr/local/</code>中的一些程序。 基本上說，在這種常見用法下，是你把這些本地編譯的包配置安裝到 <code>/usr/local/stow/${PKGNAME}-{PKGVERSION}</code> 這樣的位置，然後在 <code>/usr/local/stow/</code>目錄中執行 <code># stow ${PKGNAME}-${PKGVERSION}</code> ，然後它就會爲程序所有的文件創建符號鏈接放在 <code>/usr/local</code> 中合適的地方。然後當你想用 Stow 卸載這個程序的時候，就不必再考慮會留下什麼垃圾文件， 或者找不到安裝時用的 Makefile 了。這種安裝方式下也可以非常容易地切換一個程序的不同版本 （比如我想嘗試不同配置選項下的 <a href=https://dwm.suckless.org/>dwm</a> 或者 <a href=https://st.suckless.org/>st</a> 的時候）。</p><p>前段時間在我掃郵件列表的時候，看到某個帖子中某人在說使用 Stow 管理安裝他的點文件。 當時我沒特別在意這個帖子，但是大概我大腦潛意識把它歸檔保存爲今後閱讀了。 昨天我想起來試試這種用法，試過後我不得不說，這比那些專門設計用來做這任務的點文件管理器要方便太多了， 雖然表面上看起來這種用法沒那麼顯而易見。</p><p>方法很簡單。我建了個 <code>${HOME}/dotfiles</code> 文件夾，然後在裏面爲我想管理的每個程序配置都 創建一個子文件夾。然後我把這些程序的配置從原本的家目錄移動到這每一個對應的子文件夾中， 並保持它們在家目錄中的文件夾結構。比如，如果某個文件原本應該位於家目錄的頂層文件夾裏， 那它現在應該放在這個程序名子目錄的頂層文件夾。如果某個配置文件通常應該位於默認的 <code>${XDG_CONFIG_HOME}/${PKGNAME}</code> 位置 (<code> ${HOME}/.config/${PKGNAME}</code> )， 那麼現在它應該放在 <code>${HOME}/dotfiles/${PKGNAME}/.config/${PKGNAME}</code> ，如此類推。然後在那個 dotfiles 文件夾裏面，直接運行 <code>$ stow $PKGNAME</code> 命令， Stow 就會爲你自動創建這些配置文件的符號鏈接到合適的位置。接下來就很容易爲這個 dotfiles 目錄初始化版本管理倉庫，從而記錄你對這些配置文件做的修改（並且這也可以極度簡化在不同電腦之間 共享配置，這也是我想要這麼做的主要原因）。</p><p>舉個例子，比如說你想管理 Bash, VIM, Uzbl 這三個程序的配置文件。Bash 會在家目錄的頂層文件夾 放幾個文件； VIM 通常會有在頂層文件夾的 .vimrc 文件和 .vim 目錄；然後 Uzbl 的配置位於 <code>${XDG_CONFIG_HOME}/uzbl</code> 以及 <code>${XDG_DATA_HOME}/uzbl</code> 。於是在遷移配置前，你的家目錄的文件夾結構應該看起來像這樣：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>home/
</span></span><span style=display:flex><span>    brandon/
</span></span><span style=display:flex><span>        .config/
</span></span><span style=display:flex><span>            uzbl/
</span></span><span style=display:flex><span>                <span style=color:#f92672>[</span>...some files<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>        .local/
</span></span><span style=display:flex><span>            share/
</span></span><span style=display:flex><span>                uzbl/
</span></span><span style=display:flex><span>                    <span style=color:#f92672>[</span>...some files<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>        .vim/
</span></span><span style=display:flex><span>            <span style=color:#f92672>[</span>...some files<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>        .bashrc
</span></span><span style=display:flex><span>        .bash_profile
</span></span><span style=display:flex><span>        .bash_logout
</span></span><span style=display:flex><span>        .vimrc
</span></span></code></pre></div><p>然後遷移配置的方式是，應該建一個 dotfiles 子目錄，然後像這樣移動所有配置文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>home/
</span></span><span style=display:flex><span>    /brandon/
</span></span><span style=display:flex><span>        .config/
</span></span><span style=display:flex><span>        .local/
</span></span><span style=display:flex><span>            .share/
</span></span><span style=display:flex><span>        dotfiles/
</span></span><span style=display:flex><span>            bash/
</span></span><span style=display:flex><span>                .bashrc
</span></span><span style=display:flex><span>                .bash_profile
</span></span><span style=display:flex><span>                .bash_logout
</span></span><span style=display:flex><span>            uzbl/
</span></span><span style=display:flex><span>                .config/
</span></span><span style=display:flex><span>                    uzbl/
</span></span><span style=display:flex><span>                        <span style=color:#f92672>[</span>...some files<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>                .local/
</span></span><span style=display:flex><span>                    share/
</span></span><span style=display:flex><span>                        uzbl/
</span></span><span style=display:flex><span>                            <span style=color:#f92672>[</span>...some files<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>            vim/
</span></span><span style=display:flex><span>                .vim/
</span></span><span style=display:flex><span>                    <span style=color:#f92672>[</span>...some files<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>                .vimrc
</span></span></code></pre></div><p>然後執行以下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cd ~/dotfiles
</span></span><span style=display:flex><span>$ stow bash
</span></span><span style=display:flex><span>$ stow uzbl
</span></span><span style=display:flex><span>$ stow vim
</span></span></code></pre></div><p>然後，瞬間，所有你的配置文件（的符號鏈接）就安安穩穩地放入了它們該在的地方，無論原本這些目錄結構 有多麼錯綜複雜，這樣安排之後的 dotfiles 文件夾內的目錄結構立刻整理得有條有理， 並且可以很容易地轉換成版本控制倉庫。非常有用的一點是，如果你有多臺電腦，可能這些電腦並沒有 安裝完全一樣的軟件集，那麼你可以手選一些你需要的軟件配置來安裝。在你的 dotfiles 文件夾中總是 可以找到所有的配置文件，但是如果你不需要某個程序的某份配置，那你就不對它執行 stow 命令，它就不會擾亂你的家目錄。</p><p>嗯，以上就是整個用法介紹。希望能有別人覺得這個用法有用！我知道對我來說這個非常有幫助。</p><h3 id=chezmoihttpslinuxcnarticle-12109-1html><a href=https://linux.cn/article-12109-1.html>Chezmoi</a><a hidden class=anchor aria-hidden=true href=#chezmoihttpslinuxcnarticle-12109-1html>#</a></h3><p>020-04-14 18:36</p><p>在 Linux 中，点文件是隐藏的文本文件，从 Bash、Git 到 i3 或 VSCode 等更复杂的许多应用程序，都用它存储配置设置。</p><p>这些文件大多数都放在 <code>~/.config</code> 目录中或用户主目录中。编辑这些文件使你可以自定义也许没有提供设置菜单的应用程序，并且它们可以跨设备甚至是跨其它 Linux 发行版移植。但是，整个 Linux 发烧友社区的讨论焦点是如何管理这些点文件以及如何共享它们。</p><p>我们将展示一个名为 <a href=https://www.chezmoi.io/>Chezmoi</a> 的工具，该工具与其它工具略有不同。</p><h4 id=点文件管理的历史>点文件管理的历史<a hidden class=anchor aria-hidden=true href=#点文件管理的历史>#</a></h4><p>如果你在 <a href="https://github.com/search?q=dotfiles&amp;type=Repositories">GitHub 上搜索“dotfiles”</a>，那么你将看到有超过 10 万个存储库在解决一个目标：将人们的点文件存储在可共享且可重复的领地中。但是，除了都在使用 Git 之外，它们存储文件的方式各有不同。</p><p>虽然 Git 解决了代码管理问题，也将其转换为配置文件管理，但它并没有解决如何区分发行版、角色（例如家用计算机与工作计算机）、机密信息管理以及按设备配置的问题。</p><p>因此，许多用户决定制定自己的解决方案，多年来，社区已经做出了许多成果。本文将简要介绍已有的一些解决方案。</p><h5 id=安装问题>安装问题<a hidden class=anchor aria-hidden=true href=#安装问题>#</a></h5><p>如果将点文件存储在 Git 存储库中，你肯定希望可以让更改轻松地自动应用到主目录之中，乍一看，最简单的方法是使用符号链接，例如 <code>ln -s ~/.dotfies/bashrc ~/.bashrc</code>。这可以使你的更改在更新存储库时立即就绪。</p><p>符号链接的问题在于管理符号链接可能很麻烦。Stow 和 <a href=https://fedoramagazine.org/managing-dotfiles-rcm/>RCM</a> 可以帮助你管理这些，但是这些并不是非常舒服的解决方案。下载后，需要对私有文件进行适当的修改和设置访问模式。如果你在一个系统上修改了点文件，然后将存储库下载到另一个系统，则可能会发生冲突并需要进行故障排除。</p><p>解决此问题的另一种方法是编写自己的安装脚本。这是最灵活的选项，但要权衡花费更多时间来构建自定义解决方案是否值得。</p><h5 id=机密信息问题>机密信息问题<a hidden class=anchor aria-hidden=true href=#机密信息问题>#</a></h5><p>Git 旨在跟踪更改。如果你在 Git 存储库中存储密码或 API 密钥之类的机密信息，则会比较麻烦，并且需要重写 Git 历史记录以删除该机密信息。如果你的存储库是公开的，那么如果其他人下载了你的存储库，你的机密信息将不再保密。仅这个问题就会阻止许多人与公共世界共享其点文件。</p><h5 id=多设备配置问题>多设备配置问题<a hidden class=anchor aria-hidden=true href=#多设备配置问题>#</a></h5><p>问题不在于如何将配置拉到多个设备，而是当你有多个需要不同配置的设备的问题。大多数人通过使用不同的文件夹或使用不同的复刻fork来处理此问题。这使得难以在不同设备和角色集之间共享配置。</p><h4 id=chezmoi-是如何干的>Chezmoi 是如何干的<a hidden class=anchor aria-hidden=true href=#chezmoi-是如何干的>#</a></h4><p>Chezmoi 是一种考虑了以上问题的用于管理点文件的工具，它不会盲目地从存储库复制或符号链接文件。 Chezmoi 更像是模板引擎，可以根据系统变量、模板、机密信息管理器和 Chezmoi 自己的配置文件来生成你的点文件。</p><h5 id=chezmoi-入门>Chezmoi 入门<a hidden class=anchor aria-hidden=true href=#chezmoi-入门>#</a></h5><p>你可以使用以下命令下载 Chezmoi 的当前版本。</p><pre tabindex=0><code>$ curl -sfL https://git.io/chezmoi | sh
</code></pre><p>让我们继续使用以下方法创建你的存储库：</p><pre tabindex=0><code>$ chezmoi init
</code></pre><p>它将在 <code>~/.local/share/chezmoi/</code> 中创建你的新存储库。你可以使用以下命令轻松地切换到该目录：</p><pre tabindex=0><code>$ chezmoi cd
</code></pre><p>让我们添加第一个文件：</p><pre tabindex=0><code>chezmoi add ~/.bashrc
</code></pre><p>这将你的 <code>.bashrc</code> 文件添加到 chezmoi 存储库。</p><p>注意：如果你的 <code>.bashrc</code> 文件实际上是一个符号链接，则需要添加 <code>-f</code> 标志以跟随它来读取实际文件的内容。</p><p>现在，你可以使用以下命令编辑该文件：</p><pre tabindex=0><code>$ chezmoi edit ~/.bashrc
</code></pre><p>现在让我们添加一个私有文件，这是一个具有 600 或类似权限的文件。我在 <code>.ssh/config</code> 中有一个文件，我想通过使用如下命令添加它：</p><pre tabindex=0><code>$ chezmoi add ~/.ssh/config
</code></pre><p>Chezmoi 使用特殊的前缀来跟踪隐藏文件和私有文件，以解决 Git 的限制。运行以下命令以查看它：</p><pre tabindex=0><code>$ chezmoi cd
</code></pre><p>你可以使用以下方法应用任何更改：</p><pre tabindex=0><code>$ chezmoi apply
</code></pre><p>并使用如下命令检查有什么不同：</p><pre tabindex=0><code>$ chezmoi diff
</code></pre><h5 id=使用变量和模板>使用变量和模板<a hidden class=anchor aria-hidden=true href=#使用变量和模板>#</a></h5><p>要导出 Chezmoi 可以收集的所有数据，请运行：</p><pre tabindex=0><code>$ chezmoi data
</code></pre><p>其中大多数是有关用户名、架构、主机名、操作系统类型和操作系统名称的信息。但是你也可以添加我们自己的变量。</p><p>继续，运行：</p><pre tabindex=0><code>$ chezmoi edit-config
</code></pre><p>然后输入以下内容：</p><pre tabindex=0><code>[data]
         email = &#34;fedorauser@example.com&#34;
         name = &#34;Fedora Mcdora&#34;
</code></pre><p>保存文件，然后再次运行 <code>chezmoi data</code>。你将在底部看到你的电子邮件和姓名已经添加成功。现在，你可以将这些与 Chezmoi 的模板一起使用。运行：</p><pre tabindex=0><code>$ chezmoi add  -T --autotemplate ~/.gitconfig
</code></pre><p>来将你的 <code>.gitconfig</code> 作为模板添加到 Chezmoi 中。如果 Chezmoi 成功地正确推断了模板，你将获得以下信息：</p><pre tabindex=0><code>[user]
         email = &#34;{{ .email }}&#34;
         name = &#34;{{ .name }}&#34;
</code></pre><p>如果没有，则可以将文件更改为这样。</p><p>使用以下方法检查文件：</p><pre tabindex=0><code>$ chezmoi edit ~/.gitconfig
</code></pre><p>然后使用：</p><pre tabindex=0><code>$ chezmoi cat ~/.gitconfig
</code></pre><p>来查看 Chezmoi 为此文件生成什么。我生成的示例如下：</p><pre tabindex=0><code>[root@a6e273a8d010 ~]# chezmoi cat ~/.gitconfig
[user]
    email = &#34;fedorauser@example.com&#34;
    name = &#34;Fedora Mcdora&#34;
[root@a6e273a8d010 ~]#
</code></pre><p>它将在我们的 Chezmoi 配置中生成一个充满变量的文件。你也可以使用变量执行简单的逻辑语句。一个例子是：</p><pre tabindex=0><code>{{- if eq .chezmoi.hostname &#34;fsteel&#34; }}
# 如果主机名为 &#34;fsteel&#34; 才包括此部分
{{- end }}
</code></pre><p>请注意，要使其正常工作，该文件必须是模板。你可以通过查看文件是否在 <code>chezmoi cd</code> 中的文件名后附加 <code>.tmpl</code> 或使用 <code>-T</code> 选项读取文件来进行检查。</p><h5 id=让机密信息保持机密>让机密信息保持机密<a hidden class=anchor aria-hidden=true href=#让机密信息保持机密>#</a></h5><p>要对设置进行故障排除，请使用以下命令。</p><pre tabindex=0><code>$ chezmoi doctor
</code></pre><p>这里重要的是它还向你显示了<a href=https://www.chezmoi.io/docs/how-to/#keep-data-private>所支持的密码管理器</a>。</p><pre tabindex=0><code>[root@a6e273a8d010 ~]# chezmoi doctor
 warning: version dev
      ok: runtime.GOOS linux, runtime.GOARCH amd64
      ok: /root/.local/share/chezmoi (source directory, perm 700)
      ok: /root (destination directory, perm 550)
      ok: /root/.config/chezmoi/chezmoi.toml (configuration file)
      ok: /bin/bash (shell)
      ok: /usr/bin/vi (editor)
 warning: vimdiff (merge command, not found)
      ok: /usr/bin/git (source VCS command, version 2.25.1)
      ok: /usr/bin/gpg (GnuPG, version 2.2.18)
 warning: op (1Password CLI, not found)
 warning: bw (Bitwarden CLI, not found)
 warning: gopass (gopass CLI, not found)
 warning: keepassxc-cli (KeePassXC CLI, not found)
 warning: lpass (LastPass CLI, not found)
 warning: pass (pass CLI, not found)
 warning: vault (Vault CLI, not found)
 [root@a6e273a8d010 ~]#
</code></pre><p>你可以使用这些客户端，也可以使用<a href=https://www.chezmoi.io/docs/how-to/#use-a-generic-tool-to-keep-your-secrets>通用客户端</a>，也可以使用系统的<a href=https://www.chezmoi.io/docs/how-to/#use-a-keyring-to-keep-your-secrets>密钥环</a>。</p><p>对于 GPG，你需要使用以下命令将以下内容添加到配置中：</p><pre tabindex=0><code>$ chezmoi edit-config
[gpg]
   recipient = &#34;&lt;Your GPG keys Recipient&gt;&#34;
</code></pre><p>你可以使用：</p><pre tabindex=0><code>$ chezmoi add --encrypt
</code></pre><p>来添加任何文件，这些文件将在你的源存储库中加密，并且不会以纯文本格式公开。Chezmoi 会在应用时自动将其解密。</p><p>我们也可以在模板中使用它们。例如，存储在 <a href=https://fedoramagazine.org/using-pass-to-manage-your-passwords-on-fedora/>Pass</a> 中的机密令牌。继续，生成你的机密信息。</p><p>在此示例中，它称为 <code>githubtoken</code>：</p><pre tabindex=0><code>rwaltr@fsteel:~] $ pass ls
 Password Store
 └── githubtoken
 [rwaltr@fsteel:~] $
</code></pre><p>接下来，编辑你的模板，例如我们之前创建的 <code>.gitconfig</code> 并添加以下行。</p><pre tabindex=0><code>token = {{ pass &#34;githubtoken&#34; }}
</code></pre><p>然后让我们使用检查：</p><pre tabindex=0><code>[rwaltr@fsteel:~] $ chezmoi cat ~/.gitconfig
 This is Git&#39;s per-user configuration file.
 [user]
           name = Ryan Walter
           email = rwalt@pm.me
           token = mysecrettoken
 [rwaltr@fsteel:~] $
</code></pre><p>现在，你的机密信息已在密码管理器中妥善保护，你的配置可以公开共享而没有任何风险！</p><h2 id=tips>Tips<a hidden class=anchor aria-hidden=true href=#tips>#</a></h2><h3 id=petrusz>Petrus.Z<a hidden class=anchor aria-hidden=true href=#petrusz>#</a></h3><h4 id=portagehttpswwwcodeplayerorgwikigentooportagehtml><a href=https://www.codeplayer.org/Wiki/Gentoo/Portage.html>Portage</a><a hidden class=anchor aria-hidden=true href=#portagehttpswwwcodeplayerorgwikigentooportagehtml>#</a></h4><h5 id=command>command<a hidden class=anchor aria-hidden=true href=#command>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>euse -E use-flags	<span style=color:#75715e>#设置允许use flag（修改/etc/make.conf中的USE）</span>
</span></span><span style=display:flex><span>euse -D use-flags	<span style=color:#75715e>#设置禁止use flag（修改/etc/make.conf中的USE）</span>
</span></span><span style=display:flex><span>euse -i use-flag	<span style=color:#75715e>#查询use flag描述</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>eix RegExp	<span style=color:#75715e>#搜索软件包</span>
</span></span><span style=display:flex><span>eix -I	<span style=color:#75715e>#列出系统中已安装的软件包</span>
</span></span><span style=display:flex><span>eix --installed-with-use <span style=color:#e6db74>`</span>use<span style=color:#e6db74>`</span>	<span style=color:#75715e>#显示哪些已安装的包有`use` flag</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>equery files <span style=color:#e6db74>`</span>PackageName<span style=color:#e6db74>`</span>	<span style=color:#75715e>#列出已安装包的文件</span>
</span></span><span style=display:flex><span>equery belongs <span style=color:#e6db74>`</span>FileName<span style=color:#e6db74>`</span>	<span style=color:#75715e>#查询已安装的指定文件属于哪个包</span>
</span></span><span style=display:flex><span>equery hasuse <span style=color:#e6db74>`</span>use<span style=color:#e6db74>`</span>	<span style=color:#75715e>#查询哪些已安装的包有use flag</span>
</span></span><span style=display:flex><span>equery uses <span style=color:#e6db74>`</span>PackageName<span style=color:#e6db74>`</span>	<span style=color:#75715e>#显示packege有哪些use</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ebuild xxx.ebuild digest	<span style=color:#75715e>#生成摘要文件</span>
</span></span><span style=display:flex><span>ebuild /var/db/pkg/xxx/xxx.ebuild config	<span style=color:#75715e>#初始化配置</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>equery d package	<span style=color:#75715e>#查看依赖package的软件</span>
</span></span><span style=display:flex><span>equery g package	<span style=color:#75715e>#查看package的依赖</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>qdepends package	<span style=color:#75715e># 查询package的依赖</span>
</span></span><span style=display:flex><span>qdepends -rv package	<span style=color:#75715e>#输出类似ebuild中或与shell兼容并格式化的依赖</span>
</span></span><span style=display:flex><span>qdepends -Q package	<span style=color:#75715e># 查询哪些包依赖package</span>
</span></span><span style=display:flex><span>qlist package	<span style=color:#75715e># 查看package的所有文件列表</span>
</span></span><span style=display:flex><span>qfile file	<span style=color:#75715e># 查看file被哪个package拥有</span>
</span></span><span style=display:flex><span>qcheck package	<span style=color:#75715e># 检查package完整性</span>
</span></span><span style=display:flex><span>qgrep -l package	<span style=color:#75715e># 查找提及package名称的ebuild</span>
</span></span><span style=display:flex><span>qgrep -JN package	<span style=color:#75715e># -J限制仅查找已安装的包，-N将打印atom而不是文件名</span>
</span></span><span style=display:flex><span>qlop -um        <span style=color:#75715e># 查看merge和unmerge log</span>
</span></span><span style=display:flex><span>qlop -rt        <span style=color:#75715e># 查看那当前emerge还有运行了多长时间</span>
</span></span><span style=display:flex><span>qmanifest
</span></span><span style=display:flex><span>qtegrity
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>genlop -c         <span style=color:#75715e>#查看当前正在merge的package的编译时间</span>
</span></span><span style=display:flex><span>genlop -t package	<span style=color:#75715e>#查看package的编译时间</span>
</span></span><span style=display:flex><span>genlop -u         <span style=color:#75715e>#查看安装与删除的package历史</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>e-file
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>eread
</span></span><span style=display:flex><span>elogv
</span></span><span style=display:flex><span>eclean
</span></span><span style=display:flex><span>epkginfo
</span></span></code></pre></div><h5 id=apply-patches>apply patches<a hidden class=anchor aria-hidden=true href=#apply-patches>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1.create dir for patches</span>
</span></span><span style=display:flex><span>mkdir -p /etc/portage/patches/&lt;package_class&gt;/&lt;package_name&gt;-&lt;package_version&gt;
</span></span><span style=display:flex><span><span style=color:#75715e>#2.put patches at dir which just created above</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#3.test patches</span>
</span></span><span style=display:flex><span>cd <span style=color:#66d9ef>$(</span>portageq get_repo_path / gentoo<span style=color:#66d9ef>)</span>/&lt;package_class&gt;/&lt;package_name&gt;
</span></span><span style=display:flex><span>ebuild &lt;package_name&gt;-&lt;package_version&gt;.ebuild clean prepare
</span></span><span style=display:flex><span><span style=color:#75715e>#4.With the message &#34;User patches applied.&#34; all is good and the package needs to be re-emerged as normally.</span>
</span></span></code></pre></div><h4 id=kernelhttpswwwcodeplayerorgwikigentookernelhtml><a href=https://www.codeplayer.org/Wiki/Gentoo/kernel.html>Kernel</a><a hidden class=anchor aria-hidden=true href=#kernelhttpswwwcodeplayerorgwikigentookernelhtml>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1.select the kernel will use</span>
</span></span><span style=display:flex><span>eselect kernel list
</span></span><span style=display:flex><span>eselect kernel set &lt;No.&gt;
</span></span><span style=display:flex><span><span style=color:#75715e>#2.configure the kernel with old config (and diff with previous config)</span>
</span></span><span style=display:flex><span>zcat /proc/config.gz &gt; /usr/src/linux/.config
</span></span><span style=display:flex><span>diff .config ../linux-x.xx.x-gentoo/.config
</span></span><span style=display:flex><span>make silentoldconfig/syncconfig/oldconfig
</span></span><span style=display:flex><span><span style=color:#75715e>#3.compile&amp;install kernel/modules</span>
</span></span><span style=display:flex><span>make -j9
</span></span><span style=display:flex><span>make install
</span></span><span style=display:flex><span><span style=color:#75715e># compile&amp;install out-of-tree module(s)</span>
</span></span><span style=display:flex><span>make modules_prepare
</span></span><span style=display:flex><span>emerge --ask @module-rebuild
</span></span><span style=display:flex><span><span style=color:#75715e># install initramfs</span>
</span></span><span style=display:flex><span>genkernel --install initramfs
</span></span><span style=display:flex><span><span style=color:#75715e>#4.clean up old kernel files</span>
</span></span><span style=display:flex><span>eclean-kernel
</span></span><span style=display:flex><span>grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><h4 id=upgradegentoohttpswwwcodeplayerorgwikigentooupgradegentoohtml><a href=https://www.codeplayer.org/Wiki/Gentoo/UpgradeGentoo.html>UpgradeGentoo</a><a hidden class=anchor aria-hidden=true href=#upgradegentoohttpswwwcodeplayerorgwikigentooupgradegentoohtml>#</a></h4><h5 id=how-to-upgrade-gentoo>How to upgrade gentoo<a hidden class=anchor aria-hidden=true href=#how-to-upgrade-gentoo>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1.sync portage tree to lastest</span>
</span></span><span style=display:flex><span>emerge-websync
</span></span><span style=display:flex><span>emerge --sync
</span></span><span style=display:flex><span><span style=color:#75715e>#2.upgrade the system</span>
</span></span><span style=display:flex><span>emerge -avutDN --with-bdeps<span style=color:#f92672>=</span>y @world <span style=color:#75715e># -a = --ask, -v = --vebose, -u = --update, -t == --tree, -D = --deep, -N = --newuse</span>
</span></span><span style=display:flex><span>emerge -a @smart-live-rebuild
</span></span><span style=display:flex><span><span style=color:#75715e>#3.may be need to update the new config file</span>
</span></span><span style=display:flex><span>dispatch-conf <span style=color:#75715e># or etc-update</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#4.clean the unused package</span>
</span></span><span style=display:flex><span>emerge -ac <span style=color:#75715e># -c = --depclean</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#5.rebuild dependency library</span>
</span></span><span style=display:flex><span>emerge @preserved-rebuild
</span></span><span style=display:flex><span>revdep-rebuild
</span></span><span style=display:flex><span>emerge -a @module-rebuild
</span></span><span style=display:flex><span><span style=color:#75715e>#6.clean old distfiles</span>
</span></span><span style=display:flex><span>eclean -d distfiles <span style=color:#75715e># or eclean-dist -d</span>
</span></span></code></pre></div><h5 id=how-to-upgrade-python-local-package>How to upgrade python local package<a hidden class=anchor aria-hidden=true href=#how-to-upgrade-python-local-package>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 通过脚本维护local-python-world列表</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装或删除&lt;package&gt;</span>
</span></span><span style=display:flex><span>pip_user install &lt;package&gt;
</span></span><span style=display:flex><span>pip_user uninstall &lt;package&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 将所有local python package升级</span>
</span></span><span style=display:flex><span>pip_upgrade
</span></span></code></pre></div><h3 id=freeing-disk-spacehttpswikigentooorgwikiknowledge_basefreeing_disk_space><a href=https://wiki.gentoo.org/wiki/Knowledge_Base:Freeing_disk_space>Freeing disk space</a><a hidden class=anchor aria-hidden=true href=#freeing-disk-spacehttpswikigentooorgwikiknowledge_basefreeing_disk_space>#</a></h3><h3 id=how-to-change--set-the-default-crontab-editorhttpswwwservernoobscomchange-set-the-default-crontab-editortextif20you20want20to20change20your20default20crontabin20general2c20you20use20this20command3a20export20editor3d2fusr2fbin2fnano><a href="https://www.servernoobs.com/change-set-the-default-crontab-editor/#:~:text=If%20you%20want%20to%20change%20your%20default%20crontab,in%20general%2C%20you%20use%20this%20command%3A%20export%20EDITOR%3D%2Fusr%2Fbin%2Fnano.">How to Change & Set the Default crontab Editor</a><a hidden class=anchor aria-hidden=true href=#how-to-change--set-the-default-crontab-editorhttpswwwservernoobscomchange-set-the-default-crontab-editortextif20you20want20to20change20your20default20crontabin20general2c20you20use20this20command3a20export20editor3d2fusr2fbin2fnano>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ EDITOR<span style=color:#f92672>=</span>nano crontab -e
</span></span></code></pre></div><h3 id=how-to-update-dolphin-file-manager-in-real-timehttpsaskubuntucomquestions311303how-to-update-dolphin-file-manager-in-real-time><a href=https://askubuntu.com/questions/311303/how-to-update-dolphin-file-manager-in-real-time>How to update dolphin file manager in real time</a><a hidden class=anchor aria-hidden=true href=#how-to-update-dolphin-file-manager-in-real-timehttpsaskubuntucomquestions311303how-to-update-dolphin-file-manager-in-real-time>#</a></h3><p>The way in order to refresh Dolphin is to press F5. However, this would be manual.</p><p>In order to continuously refresh, an automatic solution, create a bash script that runs on boot. This bash script should press F5 every five seconds if Dolphin is open. Create a file named <code>dolphin-update</code> in <code>/usr/local/bin</code> with the following contents:</p><pre tabindex=0><code>#!/bin/bash
while true; do
    PID=$(pgrep &#34;dolphin&#34;)
    if [ &#34;$?&#34; -ne &#34;0&#34; ]; then
        xdotool key &#39;F5&#39;
    fi
    sleep 5
done
</code></pre><p>You may need to first create it as root and then change the owner to your user:</p><pre tabindex=0><code>sudo chown username:username /usr/local/bin/dolphin-update 
</code></pre><p>Ensure that it has executable permissions:</p><pre tabindex=0><code>chmod +x /usr/local/bin/dolphin-update
</code></pre><p>Now we need that to run on boot. To do that run <code>sudo crontab -e</code> and add the following line to the end of the file:</p><pre tabindex=0><code>@reboot /usr/local/bin/dolphin-update
</code></pre><p>This script will run on boot.</p><p>You should now have a continuously refreshing Dolphin!</p><p>There are some caveats to this script.</p><ul><li>If you open Dolphin, go to another application where F5 triggers something, (eg Chromium refreshes the page), the script will still run and be a constant annoyance. <strong>Solution:</strong> Close Dolphin when not actively using it.</li><li>As a <code>cron</code> job is used, if your computer crashes, the script will not run on boot. However this is a problem with <code>cron</code> not the script.</li></ul><p>What the script means, line by line:</p><ul><li><code>#!/bin/bash</code> - shebang to run with bash</li><li><code>while true; do</code> - run continuously</li><li><code>PID=$(pgrep "dolphin")</code> - find the process ID of a <code>dolphin</code> instance. This is purely there to check whether there is even a instance of Dolphin running.</li><li><code>if [ "$?" -ne "0" ]; then</code> - check the result of whether there is a Dolphin instance running. If there is, then &mldr;</li><li><code>xdotool key 'F5'</code> - press F5</li><li><code>fi</code> - end the <code>if</code> block</li><li><code>sleep 5</code> - wait 5 seconds before repeating the process</li><li><code>done</code> - end the while block</li></ul><h3 id=how-do-i-convert-a-png-into-a-icohttpssuperusercomquestions227736how-do-i-convert-a-png-into-a-ico1012535><a href=https://superuser.com/questions/227736/how-do-i-convert-a-png-into-a-ico/1012535>How do I convert a .PNG into a .ICO?</a><a hidden class=anchor aria-hidden=true href=#how-do-i-convert-a-png-into-a-icohttpssuperusercomquestions227736how-do-i-convert-a-png-into-a-ico1012535>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ffmpeg -i img.png img.ico
</span></span><span style=display:flex><span>$ ffmpeg -i img.png -vf scale<span style=color:#f92672>=</span>32:32 img.ico
</span></span></code></pre></div><h3 id=crop-a-photo-to-fit-a-circle-using-ffmpeghttpsstackoverflowcomquestions63997289can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg><a href=https://stackoverflow.com/questions/63997289/can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg>Crop a photo to fit a circle using ffmpeg</a><a hidden class=anchor aria-hidden=true href=#crop-a-photo-to-fit-a-circle-using-ffmpeghttpsstackoverflowcomquestions63997289can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ffmpeg -i avatar.png -i mask.png -filter_complex <span style=color:#e6db74>&#34;[0]scale=400:400[ava];[1]alphaextract[alfa];[ava][alfa]alphamerge&#34;</span> output.png
</span></span></code></pre></div><p>scale=400:400 是 mask.png 的大小。</p><p>mask.png is just a circle, example:</p><p><img loading=lazy src=/Distributions/EMKmn.png alt></p><h3 id=path-to-kde-picture-of-the-dayhttpsaskubuntucomquestions1197417where-is-bings-picture-of-the-day-stored-on-my-system><a href=https://askubuntu.com/questions/1197417/where-is-bings-picture-of-the-day-stored-on-my-system>Path to KDE Picture of the Day</a><a hidden class=anchor aria-hidden=true href=#path-to-kde-picture-of-the-dayhttpsaskubuntucomquestions1197417where-is-bings-picture-of-the-day-stored-on-my-system>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cd $HOME/.cache/plasma_engine_potd
</span></span><span style=display:flex><span>$ file *
</span></span><span style=display:flex><span>apod:             JPEG image data, JFIF standard 1.01, resolution <span style=color:#f92672>(</span>DPI<span style=color:#f92672>)</span>, density 96x96, segment length 16, comment: <span style=color:#e6db74>&#34;Description: Adobe ImageReady&#34;</span>, baseline, precision 8, 960x634, components <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>bing:             JPEG image data, JFIF standard 1.01, resolution <span style=color:#f92672>(</span>DPI<span style=color:#f92672>)</span>, density 96x96, segment length 16, baseline, precision 8, 1920x1080, components <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>unsplash:1065976: JPEG image data, JFIF standard 1.01, resolution <span style=color:#f92672>(</span>DPI<span style=color:#f92672>)</span>, density 72x72, segment length 16, baseline, precision 8, 3840x2160, components <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><h3 id=baloohttpscommunitykdeorgbaloo><a href=https://community.kde.org/Baloo>Baloo</a><a hidden class=anchor aria-hidden=true href=#baloohttpscommunitykdeorgbaloo>#</a></h3><p>Baloo is the file indexing and file search framework for KDE Plasma, with a focus on providing a very small memory footprint along with with extremely fast searching.</p><p><strong>Indexing limitations</strong></p><p>Baloo uses the file metadata extractors in <a href=https://invent.kde.org/frameworks/kfilemetadata>KFileMetadata</a> to get information about each file it indexes. This means for a file&rsquo;s content to be indexed</p><ul><li>the file must have a recognizable MIME type</li><li>KDE must have an extractor for that MIME type</li></ul><p>Other limitations:</p><ul><li>Baloo doesn&rsquo;t index text files (those whose MIME type is detected as &ldquo;text/<em>something</em>&rdquo;) over 10 MB (<a href=https://invent.kde.org/frameworks/baloo/-/blob/master/src/file/extractor/app.cpp#L143>source</a>).</li><li>The KFileMetadata extractor for text attempts to convert text to Unicode. If the file uses another encoding, such as iso-8859-1, any file contents after the first character that is invalid in Unicode will not be indexed. You may find the <code>-i</code> option to the <code>file</code> command-line utility useful; it tries to infer the character set of a file, e.g. file -i <em>path/to/myfile.txt</em>.</li></ul><p><strong>Using Baloo</strong></p><p>Baloo is not an application, but a daemon to index files. Applications can use the Baloo framework to provide file search results. For example, <a href=https://community.kde.org/Dolphin>Dolphin</a>&rsquo;s Content search can use Baloo.</p><p>KDE System Settings > File Search provides an <a href=http://vhanda.in/blog/2014/04/desktop-search-configuration/>intentionally limited number of settings</a>. You can make additional adjustments in <a href=https://community.kde.org/Baloo/Configuration>Baloo&rsquo;s configuration file</a>.</p><p><strong>balooctl</strong></p><p><code>balooctl</code> is a CLI command to perform certain operations on Baloo. Enter <code>balooctl --help</code> in a terminal app such as <a href=http://userbase.kde.org/Konsole>userbase:Konsole</a> to list its available subcommands.</p><h4 id=baloo-file-extractor-crashes-on-every-boothttpsforumsgentooorgviewtopic-t-1096234-start-0html><a href=https://forums.gentoo.org/viewtopic-t-1096234-start-0.html>Baloo File Extractor Crashes on every boot</a><a hidden class=anchor aria-hidden=true href=#baloo-file-extractor-crashes-on-every-boothttpsforumsgentooorgviewtopic-t-1096234-start-0html>#</a></h4><p>I find Baloo fragile and a nuisance. Sometimes it works OK on my amd64 and ~amd64 machines, other times not. If you are not interested in file indexing, you can disable it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ balooctl disable
</span></span></code></pre></div><p>这个不好用，菊苣（巨巨、大佬）们都推荐关闭。</p><h4 id=kde-baloo-崩溃问题与调整httpsimbearchildcyouarchives202204kde-baloo-crash><a href=https://imbearchild.cyou/archives/2022/04/kde-baloo-crash/>KDE Baloo 崩溃问题与调整</a><a hidden class=anchor aria-hidden=true href=#kde-baloo-崩溃问题与调整httpsimbearchildcyouarchives202204kde-baloo-crash>#</a></h4><p>Baloo 是 KDE Plasma 的文件索引和文件搜索框架，专注于提供非常小的内存占用以及极快的搜索。KDE 的 Dolphin 和 KRunner 都会调用 Baloo 进行文件搜索。 但是在一些用户的电脑上 Baloo 会崩溃，究其原因，是 Baloo 尝试索引一些奇奇怪怪的文件夹与文件内容所致。解决这个问题也很简单，方法有三。</p><ul><li>其一是只让 Baloo 索引指定的文件夹，比如 <code>~/文档</code> 或 <code>~/音乐</code> ，索引整个家目录是完全不科学的。在 KDE 的搜索页面即可修改。“未索引”即代表不会索引，“已索引”就是在索引范围内。</li><li>其二是只索引文件名称，把“同时索引文件内容”给取消勾选。</li><li>其三就是直接关闭 Baloo 的索引功能，把“启用文件搜索”给取消勾选（只是取消索引）。</li></ul><p>前两种措施采取一个应该就可以解决崩溃问题。 不推荐用户强行卸载 Baloo 相关包，或者直接砍掉相关服务，因为 Dolphin 的 KDE 的搜索都会依赖 Baloo，直接砍掉的话这些功能会异常。</p><p>更多相关信息参见 KDE 社区维基：<a href=https://community.kde.org/Baloo>Baloo</a></p><h3 id=内核升级一般步骤httpsblogsoymilkfun20201117linuxgentoogentookernelupdate><a href=https://blog.soymilk.fun/2020/11/17/Linux/Gentoo/GentooKernelUpdate/>内核升级一般步骤</a><a hidden class=anchor aria-hidden=true href=#内核升级一般步骤httpsblogsoymilkfun20201117linuxgentoogentookernelupdate>#</a></h3><h4 id=升级内核>升级内核<a hidden class=anchor aria-hidden=true href=#升级内核>#</a></h4><p>建议在<code>make.conf</code>中添加<code>USE='symlink'</code>，然后更新系统。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo emerge --ask --verbose --update --deep --newuse @world
</span></span></code></pre></div><h4 id=configuration>Configuration<a hidden class=anchor aria-hidden=true href=#configuration>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo make menuconfig
</span></span></code></pre></div><h4 id=build>Build<a hidden class=anchor aria-hidden=true href=#build>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo make -j4
</span></span></code></pre></div><h4 id=install>Install<a hidden class=anchor aria-hidden=true href=#install>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo make modules_install
</span></span><span style=display:flex><span>$ sudo make install
</span></span></code></pre></div><h4 id=bootloader>BootLoader<a hidden class=anchor aria-hidden=true href=#bootloader>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p>重启以应用新的内核。</p><h4 id=clean>Clean<a hidden class=anchor aria-hidden=true href=#clean>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo eclean-kernel -n <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>仅保留当前内核。</p><h2 id=questions>Questions<a hidden class=anchor aria-hidden=true href=#questions>#</a></h2><h3 id=problem-with-transparencies-and-windowing-ghosting-outhttpsforumgarudalinuxorgtproblem-with-transparencies-and-windowing-ghosting-out9568><a href=https://forum.garudalinux.org/t/problem-with-transparencies-and-windowing-ghosting-out/9568>Problem with transparencies and windowing ghosting out</a><a hidden class=anchor aria-hidden=true href=#problem-with-transparencies-and-windowing-ghosting-outhttpsforumgarudalinuxorgtproblem-with-transparencies-and-windowing-ghosting-out9568>#</a></h3><p>Anyhow, I now applied the &ldquo;force smoothest animations&rdquo; in the KDE compositor settings and it seems to have done the trick!Telegram not launching from the browser xdg-open</p><h3 id=telegram-not-launching-from-the-browser-xdg-openhttpswwwredditcomrmanjarolinuxcommentsk76cphtelegram_not_launching_from_the_browser_xdgopen><a href=https://www.reddit.com/r/ManjaroLinux/comments/k76cph/telegram_not_launching_from_the_browser_xdgopen/>Telegram not launching from the browser xdg-open</a><a hidden class=anchor aria-hidden=true href=#telegram-not-launching-from-the-browser-xdg-openhttpswwwredditcomrmanjarolinuxcommentsk76cphtelegram_not_launching_from_the_browser_xdgopen>#</a></h3><p>I am receiving the following message:</p><pre tabindex=0><code>Unable to create io-slave. klauncher said: Unknown protocol &#39;tg&#39;.
</code></pre><p>Hey!
So it’s easy to solve</p><ol><li>Open the folder <code>\~/.local/share/applications</code></li><li>find some files about telegram desktop, like an example, my is <code>userapp-Telegram Desktop-FXJ6T0.desktop</code></li><li>Add the line at the end of file <code>MimeType=application/x-xdg-protocol-tg;x-scheme-handler/tg;</code></li><li>Reload your browser (maybe do not need…)</li><li>Enjoy!</li></ol><p>我的该目录下有两个与telegram相关的desktop文件，都改了之后就行了。</p><h3 id=how-to-reset-kde--display-settings-after-a-move-to-a-new-machinehttpsaskubuntucomquestions299241how-to-reset-kde-display-settings-after-a-move-to-a-new-machine><a href=https://askubuntu.com/questions/299241/how-to-reset-kde-display-settings-after-a-move-to-a-new-machine>How to reset KDE / display settings after a move to a new machine</a><a hidden class=anchor aria-hidden=true href=#how-to-reset-kde--display-settings-after-a-move-to-a-new-machinehttpsaskubuntucomquestions299241how-to-reset-kde-display-settings-after-a-move-to-a-new-machine>#</a></h3><p>I had to remove <code>.local/share/kscreen</code> on plasma5</p><h3 id=how-can-i-reset-my-display-settings-through-terminalhttpsaskubuntucomquestions749333how-can-i-reset-my-display-settings-through-terminal><a href=https://askubuntu.com/questions/749333/how-can-i-reset-my-display-settings-through-terminal>How can I reset my display settings through terminal?</a><a hidden class=anchor aria-hidden=true href=#how-can-i-reset-my-display-settings-through-terminalhttpsaskubuntucomquestions749333how-can-i-reset-my-display-settings-through-terminal>#</a></h3><p>Removing <code>~/.config/monitors.xml</code> should do it:</p><p>cfw 在gentoo下用不了，设置端口总为0；</p><p>clash 在gentoo下需要root权限，最好用 systemd service 运行。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://sakamotokurome.github.io/tags/unix/>Unix</a></li><li><a href=https://sakamotokurome.github.io/tags/linux/>Linux</a></li><li><a href=https://sakamotokurome.github.io/tags/gentoo/>Gentoo</a></li></ul><nav class=paginav><a class=prev href=https://sakamotokurome.github.io/posts/archlinux/><span class=title>« Prev Page</span><br><span>ArchLinux</span></a>
<a class=next href=https://sakamotokurome.github.io/posts/gentooinstallation/><span class=title>Next Page »</span><br><span>Gentoo Installation</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://sakamotokurome.github.io/>Sakamoto Kurome</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>