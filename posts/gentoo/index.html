<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Gentoo | Sakamoto Kurome</title>
<meta name="keywords" content="Unix, Linux, Gentoo" />
<meta name="description" content="Gentoo-zh 群推荐安装教程： https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html https://www.yafa.moe/post/install-gentoo-on-mac/ https://litterhougelangley.life/blog/2021/05/21/gentoo/ https://blog.bugsur.xyz/gentoo-handbook-installation/ 群内如果要贴长文本，可以使用网络粘贴板： &lt;输出命令&gt; | curl -F &#34;c=@-&#34; &#34;https://fars.ee/&#34; 并且将输出里的 url: http://far.se/xxxx 这行贴出来。使用的时候">
<meta name="author" content="Sakamoto Kurome">
<link rel="canonical" href="https://sakamotokurome.github.io/posts/gentoo/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css" integrity="sha256-yIlj/i15RiAA/Q&#43;xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://sakamotokurome.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://sakamotokurome.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://sakamotokurome.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://sakamotokurome.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://sakamotokurome.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.90.0" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>

<link rel="stylesheet" href="https://sakamotokurome.github.io/custom.css">
<meta name="google-site-verification" content="i2r403EffR8m-KBf7EHi6AYg7tfnMshaXTAynoYPnpE" />
<script async src="https://www.googletagmanager.com/gtag/js?id=G-K2Y212LPQ2"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-K2Y212LPQ2', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="Gentoo" />
<meta property="og:description" content="Gentoo-zh 群推荐安装教程： https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html https://www.yafa.moe/post/install-gentoo-on-mac/ https://litterhougelangley.life/blog/2021/05/21/gentoo/ https://blog.bugsur.xyz/gentoo-handbook-installation/ 群内如果要贴长文本，可以使用网络粘贴板： &lt;输出命令&gt; | curl -F &#34;c=@-&#34; &#34;https://fars.ee/&#34; 并且将输出里的 url: http://far.se/xxxx 这行贴出来。使用的时候" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sakamotokurome.github.io/posts/gentoo/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-08T17:03:39&#43;08:00" />
<meta property="article:modified_time" content="2022-03-08T17:03:39&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Gentoo"/>
<meta name="twitter:description" content="Gentoo-zh 群推荐安装教程： https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html https://www.yafa.moe/post/install-gentoo-on-mac/ https://litterhougelangley.life/blog/2021/05/21/gentoo/ https://blog.bugsur.xyz/gentoo-handbook-installation/ 群内如果要贴长文本，可以使用网络粘贴板： &lt;输出命令&gt; | curl -F &#34;c=@-&#34; &#34;https://fars.ee/&#34; 并且将输出里的 url: http://far.se/xxxx 这行贴出来。使用的时候"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://sakamotokurome.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Gentoo",
      "item": "https://sakamotokurome.github.io/posts/gentoo/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Gentoo",
  "name": "Gentoo",
  "description": "Gentoo-zh 群推荐安装教程： https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html https://www.yafa.moe/post/install-gentoo-on-mac/ https://litterhougelangley.life/blog/2021/05/21/gentoo/ https://blog.bugsur.xyz/gentoo-handbook-installation/ 群内如果要贴长文本，可以使用网络粘贴板： \u0026lt;输出命令\u0026gt; | curl -F \u0026#34;c=@-\u0026#34; \u0026#34;https://fars.ee/\u0026#34; 并且将输出里的 url: http://far.se/xxxx 这行贴出来。使用的时候",
  "keywords": [
    "Unix", "Linux", "Gentoo"
  ],
  "articleBody": "Gentoo-zh 群推荐安装教程：\n https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html https://www.yafa.moe/post/install-gentoo-on-mac/ https://litterhougelangley.life/blog/2021/05/21/gentoo/ https://blog.bugsur.xyz/gentoo-handbook-installation/  群内如果要贴长文本，可以使用网络粘贴板：\n | curl -F \"c=@-\" \"https://fars.ee/\" 并且将输出里的 url: http://far.se/xxxx 这行贴出来。使用的时候可以 curl http://far.se/xxxx | less 查看\nQEMU/Linux guest Configuration Host To create a disk image for the virtual machine, run:\n$ qemu-img create -f qcow2 Gentoo-VM.img 30G Download a minimal Gentoo LiveCD from here.\nSince QEMU requires a lot of options, it would be a good idea to put them into a shell script, e.g.:\n$ vim start_Gentoo_VM.sh #!/bin/bash DISKIMG=$HOME/VirtualMachine/Gentoo-VM.img exec qemu-system-x86_64 -enable-kvm \\  -bios /usr/share/edk2-ovmf/OVMF_CODE.fd \\  -cpu host \\  -drive file=${DISKIMG},if=virtio \\  -netdev user,id=vmnic,hostname=Gentoo-VM,hostfwd=tcp::10022-:22 \\  -device virtio-net,netdev=vmnic \\  -device virtio-rng-pci \\  -m 4G \\  -smp 2 \\  -monitor stdio \\  -vga std \\  -audiodev pa,id=snd0 -device ich9-intel-hda -device hda-output,audiodev=snd0 \\  -name \"Gentoo VM\" \\  $@ $ chmod u+x start_Gentoo_VM.sh Change the path to your disk image Gentoo-VM.img in the script. You can add more options when calling the script. To boot the disk image, run:\n$ ./start_Gentoo_VM.sh -boot d -cdrom $HOME/Downloads/install-amd64-minimal-20211107T170547Z.iso Install the guest per the Gentoo Handbook. See the guest section for optimum support. After the installation start the script without the additional options.\nUsing UEFI with QEMU UEFI for x86 QEMU/KVM VMs is called OVMF (Open Virtual Machine Firmware). It comes from EDK2 (EFI Development Kit), which is the UEFI reference implementation.\n$ sudo emerge sys-firmware/edk2-ovmf 检查是否安装，命令为：\n$ equery f sys-firmware/edk2-ovmf | grep OVMF /usr/share/edk2-ovmf/OVMF_CODE.fd /usr/share/edk2-ovmf/OVMF_CODE.secboot.fd /usr/share/edk2-ovmf/OVMF_VARS.fd 要在虚拟机中运行操作系统的映像文件，添加 -bios /usr/share/ovmf/OVMF.fd。该代码调用名为 OVMF.fd 的文件，该文件是 Qemu 的 UEFI 固件。\nqemu-system-x86_64 -bios /usr/share/edk2-ovmf/OVMF_CODE.fd -cdrom ubuntu-21.04-desktop-amd64.iso 这个名为ovmf的包其实就是名为TianoCore的程序。该名称本身代表开放虚拟机固件)。\nQuestions “BdsDxe: failed to load Boot0001”\nsolution: Try hitting F2 to enter the OVMF settings during guest boot and manually pick a new boot drive option.\n介绍 欢迎 首先，欢迎使用Gentoo！您将会进入一个选择自由和性能至上的世界。Gentoo的一切都是为了自由选择。在安装Gentoo时就数次明确表明了这一特点——用户可以自己选择想要编译的一切内容、选择安装Gentoo的方式、选择想用的系统日志程序等等。\nGentoo 是一个快速、现代化的元发行版，它的设计简洁、灵活。Gentoo 围绕自由软件建立，它不会对它的用户隐瞒“引擎盖下的细节”。Gentoo 所使用的软件包维护系统 Portage 是用 Python 编写的，这意味着用户可以轻松地查看和修改它的源代码。 Gentoo 的软件包管理系统使用源代码包（虽然也支持预编译软件包），并通过标准的文本文件配置Gentoo。换句话说，开放无处不在。\n“自由选择”是 Gentoo 运行的关键，这点很重要，大家要理解。我们尽量不强迫用户去做任何他们不喜欢的事情。\n安装步骤 Gentoo的安装可以被分成10个步骤，分别对应后续的章节。执行完每个步骤，都会让系统进入某种确定的状态：\n   步骤 结果     1 用户处于一个准备好安装 Gentoo 的工作环境中。   2 用于安装 Gentoo 的互联网连接已经准备完毕。   3 硬盘已经为 Gentoo 的安装初始化完毕。   4 安装环境已经准备好，用户准备 chroot 到新环境中去。   5 那些在所有Gentoo安装中都相同的核心软件包已经安装完毕。   6 Linux内核已经安装完毕。   7 用户已经创建好大部分的 Gentoo 系统配置文件。   8 必要的系统工具已经安装完毕。   9 合适的启动引导程序 (Bootloader) 已经安装配置完毕。   10 登录系统，你就可以在已经全新安装完毕的 Gentoo Linux 系统中尽情探索了！    选择正确的安装媒介 硬件需求 在开始之前，我们先列出在一台 amd64 的主机上成功安装Gentoo所必须的硬件需求。\n    Minimal CD     CPU Any x86-64 CPU, both AMD64 and Intel 64   Memory 2 GB   Disk space 8 GB (excluding swap space)   Swap space At least 2 GB    使用Gentoo Linux安装光盘 最小化安装CD Gentoo最小化安装CD是一张可引导镜像：包含有完整Gentoo环境的。它允许用户从CD或其它安装媒介引导进入Linux。在引导过程中将检测硬件并加载适当的驱动。这个镜像由Gentoo开发人员维护，能让任何有Internet连接的人来安装Gentoo。\n最小化安装CD叫做 install-amd64-minimal-.iso。\nstage又是什么？ stage3压缩包是一个包含有最小化Gentoo环境的文件，可用来按照本手册介绍继续安装Gentoo。以前的Gentoo手册描述了使用三个 stage tarballs 的其中一个来进行安装。现在Gentoo仍然提供stage1和stage2的压缩包，但是官方安装方法只使用stage3压缩包。如果你对使用stage1或stage2压缩包安装Gentoo感兴趣，请阅读 Gentoo 常见问题中的如何使用stage1或stage2 tarball安装Gentoo?\nStage 文件可以在任意一个Gentoo官方镜像站 的 releases/amd64/autobuilds/ 路径下下载，中国可选择Tsinghua University。\n下载 获得安装媒介 Gentoo Linux使用最小化安装CD做为默认安装媒介，它带有一个非常小的可引导的Gentoo Linux环境。此环境包含所有正确的安装工具。 CD镜像本身可以从官方下载页（推荐）或任意一个镜像站下载。\n在这些镜像站上，最小化安装CD可以通过以下方式找到：\n 进入 releases/ 目录 选择相应的架构, 如 amd64/ 选择 autobuilds/ 目录 对于 amd64 和 x86 平台的用户，请选择 current-install-amd64-minimal/ 目录。  在这个位置，安装媒体文件是那些带有.iso扩展名的文件。比如下面的清单：\n[DIR] hardened/ 05-Dec-2014 01:42 - [ ] install-amd64-minimal-20141204.iso 04-Dec-2014 21:04 208M [ ] install-amd64-minimal-20141204.iso.CONTENTS 04-Dec-2014 21:04 3.0K [ ] install-amd64-minimal-20141204.iso.DIGESTS 04-Dec-2014 21:04 740 [TXT] install-amd64-minimal-20141204.iso.DIGESTS.asc 05-Dec-2014 01:42 1.6K [ ] stage3-amd64-20141204.tar.bz2 04-Dec-2014 21:04 198M [ ] stage3-amd64-20141204.tar.bz2.CONTENTS 04-Dec-2014 21:04 4.6M [ ] stage3-amd64-20141204.tar.bz2.DIGESTS 04-Dec-2014 21:04 720 [TXT] stage3-amd64-20141204.tar.bz2.DIGESTS.asc 05-Dec-2014 01:42 1.5K 在上面的例子中， install-amd64-minimal-20141204.iso文件是最小化安装CD。但可以看到,还有其他相关文件存在:\n .CONTENTS 文件是一个文本文件，它列出了安装媒介中的所有文件。这个文件可用于在下载前确认安装媒介是否包含特定的固件和驱动程序。 .DIGESTS 文件包含了ISO文件的Hash值，有不同的Hash格式／算法。这个文件可以用来验证已下载的ISO文件有没有损坏。 .DIGESTS.asc 文件不仅包含了ISO文件的Hash值（和 .DIGESTS 文件一样），还包含了它的加密签名。这个文件即可用于验证已下载的ISO文件是否损坏，也可验证文件确实是由Gentoo发行工程组（Gentoo Release Engineering Team）发布而没有被篡改。  现在可以先忽略当前位置的其他文件——它们在安装的后续步骤中会被提到。下载 .ISO，另外如果想要验证下载的文件，同时下载ISO文件对应的 .DIGESTS.asc。 .CONTENTS 文件不需要下载，因为安装指南后续不会用到这个文件。 .DIGESTS 这个文件和.DIGESTS.asc 文件包含相同的信息，除此以外后者还包含有上面文件的数字签名。\n校验下载的文件 注：这是一个可选步骤，并不是安装 Gentoo Linux 所必须的。但是，我们仍然推荐这么做，以此来确保下载的文件没有损坏，以及确保下载文件确实由 Gentoo Infrastructure Team提供。\n通过 .DIGESTS 和 .DIGESTS.asc 文件，可以使用合适的工具来校验 ISO 文件的有效性。校验通常有两个步骤：　 首先，验证加密签名，确保安装文件是由Gentoo发行工程组（ Gentoo Release Engineering team ） 提供 如果加密签名是有效的，就验证它的文件校验值 （比如 SHA512,WHIRLPOOL），以此来确认下载的文件没有损坏。  在 Linux 系统上,最常用的验证加密签名的方法就是使用 app-crypt/gnupg 这个软件。安装了这个程序,就可以使用以下命令来验证 .DIGESTS.asc 文件中的数字（GPG）签名。\n首先，下载 数字签名页 中正确的密匙：\n$ gpg --keyserver hkps://keys.gentoo.org --recv-keys 0xBB572E0E2D182910 gpg: requesting key 0xBB572E0E2D182910 from hkp server pool.sks-keyservers.net gpg: key 0xBB572E0E2D182910: \"Gentoo Linux Release Engineering (Automated Weekly Release Key) \" 1 new signature gpg: 3 marginal(s) needed, 1 complete(s) needed, classic trust model gpg: depth: 0 valid: 3 signed: 20 trust: 0-, 0q, 0n, 0m, 0f, 3u gpg: depth: 1 valid: 20 signed: 12 trust: 9-, 0q, 0n, 9m, 2f, 0u gpg: next trustdb check due at 2018-09-15 gpg: Total number processed: 1 gpg: new signatures: 1 下一步验证 .DIGESTS.asc 文件的数字（GPG）签名：\n$ gpg --verify install-amd64-minimal-20141204.iso.DIGESTS.asc gpg: Signature made Fri 05 Dec 2014 02:42:44 AM CET gpg: using RSA key 0xBB572E0E2D182910 gpg: Good signature from \"Gentoo Linux Release Engineering (Automated Weekly Release Key) \" [unknown] gpg: WARNING: This key is not certified with a trusted signature! gpg: There is no indication that the signature belongs to the owner. Primary key fingerprint: 13EB BDBE DE7A 1277 5DFD B1BA BB57 2E0E 2D18 2910 确认数字签名有效后，接下来就是验证校验值，以确保下载的ISO文件没有损坏。 .DIGESTS.asc 文件包含了多个哈希算法，所以验证正确校验和的方法之一是先找到登记在文件 .DIGESTS.asc 中的相应的校验值。例如，获取 SHA512 的校验值：\n$ grep -A 1 -i sha512 install-amd64-minimal-20141204.iso.DIGESTS.asc # SHA512 HASH 364d32c4f8420605f8a9fa3a0fc55864d5b0d1af11aa62b7a4d4699a427e5144b2d918225dfb7c5dec8d3f0fe2cddb7cc306da6f0cef4f01abec33eec74f3024 install-amd64-minimal-20141204.iso -- # SHA512 HASH 0719a8954dc7432750de2e3076c8b843a2c79f5e60defe43fcca8c32ab26681dfb9898b102e211174a895ff4c8c41ddd9e9a00ad6434d36c68d74bd02f19b57f install-amd64-minimal-20141204.iso.CONTENTS 在上面的输出中，显示了两个SHA512校验和：一个用于文件：install-amd64-minimal-20141204.iso，一个用于与之对应的 .CONTENTS 文件。只有第一个校验值有用，因为要用它来和下面计算出来的 SHA512 的校验值进行比较：\n$ sha512sum install-amd64-minimal-20141204.iso 364d32c4f8420605f8a9fa3a0fc55864d5b0d1af11aa62b7a4d4699a427e5144b2d918225dfb7c5dec8d3f0fe2cddb7cc306da6f0cef4f01abec33eec74f3024 install-amd64-minimal-20141204.iso 如果两个校验值匹配，那么表明文件没有损坏，安装可以继续进行。损坏的文件会导致安装出现问题，请重新下载。\n刻录光盘 当然,只是下载一个 ISO 文件是无法开始 Gentoo Linux 的安装的。需要将这个ISO文件刻录成一张用来启动的 CD 光盘，是要将 ISO 文件里的内容而不是 ISO 文件本身刻录到CD光盘上。下面介绍了一些常见的方式——这里可以找到其他更复杂的方式：如何刻录ISO文件。\n在 Linux 系统上，可以通过 cdrecord 命令将ISO文件刻录到CD光盘上，这个命令由 app-cdr/cdrtools 软件包提供。\n将ISO文件刻录到 /dev/sr0 设备的 CD 光碟上（这是系统上的第一个 CD 设备-在必要时将其替换为正确的设备）:\n$ cdrecord dev=/dev/sr0 install-amd64-minimal-20141204.iso 喜欢使用图形化界面的用户可以使用 K3B ，它由 kde-app/k3b 软件包提供。在 K3B 软件中，选择“工具”（Tools）菜单，然后选择“刻录CD镜像”（Burn CD Image）。\n启动 启动安装媒介 安装媒介准备就绪后，就可以启动了。 将安装媒介插入系统中，重启，然后进入主板的固件用户界面。 通常是在开机自检（POST）过程中通过在键盘上按DEL, F1, F10, 或 ESC 进入，“触发”键取决于系统和主板。 如果使用主板的型号作为关键字在互联网搜索引擎进行搜索， 结果应该很容易确定。进入主板的固件菜单后，更改引导顺序，以便在内部磁盘设备之前尝试外部可启动媒介（CD / DVD盘或USB驱动器）。 否则，系统很可能会重新启动到内部磁盘设备，从而忽略外部启动媒介。\n重要：如果想安装使用 UEFI 引导的 Gentoo ，建议立即使用UEFI启动。如果不用 UEFI 来启动，可能就要在最后完成 Gentoo Linux 的安装之前制作一个可以启动的 UEFI U盘（或其他介质）。\n如果启动没有成功，请确保将安装媒介插入系统，然后重新启动。这是会显示一个启动提示符。 此时按Enter键将使用默认的启动选项启动。如果要使用自定义引导选项引导安装媒介，请按照启动选项指定一个内核，然后按Enter键。\n附注：在大多数情况下，默认的Gentoo内核可以像之前提到的那样可以在没有任何指定参数的情况下正常工作，有关启动故障排除和专家选项，请继续执行此部分。否则，只需按Enter并跳转至其他硬件配置.\n在启动提示符下，用户可以按 F1 键显示可用的内核，按 F2 按键显示可用的启动选项。如果在15秒内没做任何选择（既不显示信息，也不选择内核）安装媒介将会从硬盘启动。这样不用将 CD 光盘从光盘驱动器里拿出来，也可以在安装过程中重启和尝试已安装好的环境（这有时在远程安装的时候很有用）。\n提到了指定一个内核。 在最小安装介质上，只提供了两个预定义的内核启动选项。 默认选项叫gentoo。 另一个是“-nofb”变量; 这会禁用内核帧缓冲区支持。\n内核选择\n  gentoo\n默认内核，支持K8 CPU（包括NUMA支持）和EM64T CPU。\n  gentoo-nofb\n与“gentoo”相同，但没有framebuffer支持。\n  memtest86\n测试本地RAM的错误。\n  引导选项可以配合内核进一步调整引导过程的行为。\n硬件选择\n  acpi=on\n这个选项载入对 ACPI 的支持，同时也会让 CD 光盘在启动时运行 acpid 守护进程。在系统需要 ACPI 才能正常工作的情况下才需要设置此选项。超线程（Hyperthreading）的支持不需要此选项。\n  acpi=off\n彻底禁用 ACPI。这个选项在一些较老的系统上比较有用，同样也是使用 APM 功能的必需项。这个选项也会禁用处理器的超线程支持。\n  console=X\n这会启用对一些终端的访问许可。它的第一个参数是设备，默认是 ttyS0， 之后的其它选项请使用逗号分割。默认参数是 9600,8,n,1 。\n  dmraid=X\n这会传递参数给 device-mapper RAID 子系统。需要在参数两端加上括号。\n  doapm\n这会加载对 APM 驱动的支持。这同时需要 acpi=off.\n  dopcmcia\n这会加载对 PCMCIA 和 Cardbus 硬件的支持，并且会使 pcmcia cardmgr 在 CD 启动时被启用. 这只有在从 PCMCIA/Cardbus 设备启动时才需要。\n  doscsi\n这会加载对大部分 SCSI 控制器的支持。当从使用 SCSI 内核子系统的 USB 设备启动时需要这个参数。\n  sda=stroke\n这会允许用户对整块硬盘进行分区，即使是 BIOS 无法控制的大容量硬盘。这个选项只有在使用老的 BIOS 的机器上才需要。注意，请把 “sda” 替换为需要这么做的设备。\n  ide=nodma\n这会强制内核禁用 DMA ，一些 IDE 芯片组和一些 CDROM 的驱动需要这么做才能工作。如果系统无法正常读取 IDE 的 CDROM，可以试试这个选项。这同时也会禁止默认的 hdpram 设置被执行。\n  noapic\n这会禁用一些新主板上的高级程序中断控制器（Advanced Programmable Interrupt Controller，APIC），因为这可能会造成一些旧的硬件无法正常工作。\n  nodetect\n这会禁止 CD 的全部自动检测功能，包括对硬件的检测和 DHCP 探测。 这有助于对启动失败的 CD 或驱动器进行查错。\n  nodhcp\n这会禁用在被发现的网卡上进行 DHCP 探测。这在需要使用固定 IP 的时候很有用。\n  nodmraid\n禁用对 device-mapper RAID 的支持，比如板载的IDE/SATA RAID控制器。\n  nofirewire\n这禁用了对 “火线”（ Firewire ） 模块的加载。该选项只在“火线”（Firewire）造成 CD 无法正常启动时才需要。\n  nogpm\n这禁用对 gpm 控制台的鼠标（gpm console mouse）的支持。\n  nohotplug\n这会禁止在启动时加载对热插拔和冷插拔的脚本。这有助于对启动失败的 CD 或驱动器进行查错。\n  nokeymap\n这会禁用选择键盘映射（只有不是 US 键盘时才需要进行对键盘映射的设置）。\n  nolapic\n这会在单处理器内核里禁用本地APIC。\n  nosata\n这会禁止加载 Serial ATA 模块. 这在 SATA 子系统出错时才需要。\n  nosmp\n这会在支持 SMP 的内核上禁用 SMP（Symmetric Multiprocessing）。这在为排查与 SMP 相关的驱动或内核错误时很有用。\n  nosound\n这会禁止对音频的支持和音量控制。这在音频系统造成问题时很有用。\n  nousb\n这会禁止自动加载的 USB 模块。这在 USB 出现问题时很有用。\n  slowusb\n这会为慢速的USB CDROM 在启动时添加更多额外的中断，就像 IBM BladeCenter 那样。\n  逻辑卷／设备管理\n  dolvm\n这会启用 Linux 的逻辑分区管理器（Logical Volume Management）。\n  其他选项\n  debug\n启用调试代码。这可能会显得乱糟糟的，因为这会向输出大量的数据。\n  docache\n这会把整个 CD 运行环境缓存到内存中，这会使用户可以卸载 /mnt/cdrom 并挂载另外一个 CDROM 。这个选项需要至少两倍于 CD 大小的内存空间。\n  doload=X\n这会使启动时内存盘（initial ramdisk，initrd）加载这之后列出来的模块和它们的依赖。把“X”替换为模块名称，当需要加载多个模块时请用逗号分割。\n  dosshd\n在启动时启用 sshd 服务，这在无人值守安装时很有用。\n  passwd=foo\n这会将等号后的字符设置为 root 用户的密码，当使用“dosshd”参数时需要这么做因为默认的 root 密码是留空的。\n  noload=X\n这会使启动时内存盘（initial ramdisk，initrd）跳过对某些会造成问题的特定模块的加载。使用方法和“doload”相同。\n  nonfs\n禁止在启动时启用 portmap/nfsmount 。\n  nox\n这会使启用X的 LiveCD 不自动启动X，而是使用命令行。\n  scandelay\n这会使 CD 在启动过程中等待十秒来使一些初始化很慢的设备完成初始化。\n  scandelay=X\n这允许用户指定 CD 在启动过程中等待一些初始化很慢的设备完成初始化所需的延迟的时间。把X替换为所需要等待的时间（以秒为单位，只需要填写数字）。\n  附注：启动媒介将先检查no*选项，再检查do*选项，所以那些选项可以按照这个顺序覆盖。\n现在启动安装媒介，选择一个内核（如果默认的 gentoo 的内核不能满足）和引导选项。作为示例，我们引导 gentoo 内核启动，并带有dopcmcia作为内核参数：\nboot: gentoo dopcmcia 接下来迎接用户的是一个引导屏幕和进度条。如果用来安装系统的是一个非US键盘，确保马上按Alt + F1来切换到详细模式并遵照提示。如果在10秒钟内什么都没有选，则接受默认（US键盘）并继续引导过程。一旦引导过程完成，用户将自动以root超级用户身份登录到“Live”Gentoo Linux环境。当前控制台将显示一个root提示符，并且可以通过按Alt + F2、Alt + F3和Alt + F4切换到其他控制台。按Alt + F1返回到启动时的那个。\n额外的硬件配置 当安装媒介启动时，它会尝试检测所有的硬件设备并加载合适的内核模块来支持硬件。在绝大多数的情况下，它工作得很好。然而，在某些情况下它可能没有自动加载系统所需的内核模块。如果 PCI 自动检测错过了一些系统硬件，相应的内核模块就必须手动加载了。\n下面例子手工加载了 8139too 模块（它提供对某些类型的网卡的支持）：\n# modprobe 8139too 推荐：用户账号 如果其他人需要访问安装环境，或者需要以非 root 用户的身份在安装媒介上运行命令（例如出于安全原因使用没有 root 特权的 irssi 聊天），这时就需要创建额外的用户帐户，并将 root 用户密码设为强密码。\n使用 passwd 命令来修改 root 用户密码：\n# passwd New password: (Enter the new password) Re-enter password: (Re-enter the password) 要创建一个用户账户，先输入他们的信息，然后设置密码。用 useradd 和 passwd 命令来完成这些操作。\n在下面的例子中，创建了一个名为“john”的用户。\n# useradd -m -G users john # passwd john New password: (Enter john's password) Re-enter password: (Re-enter john's password) 使用 su 命令可以从 root 用户（当前用户）切换到新建的用户：\n# su - john 在安装时查看文档 TTYs\n要在安装期间查看 Gentoo 安装手册，首先要按照上面的方法创建一个新的用户帐户。然后按 Alt+F2 进入一个新的终端。\n在安装期间， 可以用 links 命令来浏览 Gentoo 安装手册 - 当然，只有在互联网连接可用的时候才行。\n$ links https://wiki.gentoo.org/wiki/Handbook:AMD64/zh-cn 要回到原来的终端，请按 Alt+F1 。\nGNU Screen\nScreen是官方Gentoo安装介质中默认安装的实用程序。对于经验丰富的Linux爱好者来说，使用 screen 分割窗口查看安装说明，而不是上面提到的多个TTY的方法， 这可能更高效。\n推荐：启动SSH服务 如果你通过的是虚拟机安装，或者同一网络下有其它电脑可以使用，那么使用 ssh 连接上本机，通过复制粘贴命令来操作会更加方便，而 LiveCD 环境下的 sshd 配置为，执行，\n# nano /etc/ssh/sshd_config 打开 sshd 配置文件，确保如下两个选项\n PermitRootLogin PasswordAuthentication  前面都没有注释符 # ，后面的值都为 yes ，后按下 Ctrl + X ， y ， Enter 保存退出。之后执行，\n# rc-service sshd start 启用 sshd 服务后，为 LiveCD 环境的 root 用户设置一个密码，如果不想设置复杂密码，可以编辑 /etc/security/passwdqc.conf 文件，将 enforce=everyone 改成 enforce=none 保存后再设置\n# passwd root 之后就可以通过其它电脑/主机连接到此 LiveCD 环境了。\n附注：如果用户登录到系统，他们将看到一个本系统主机密钥需要确认的信息（也就是我们说的密匙指纹）。此行为是典型的并且可以像预期一样与SSH服务器进行初始连接。但是，以后当系统设置好，并有人登录到新安装的系统时，SSH客户端会警告主机密钥已被更改。这是因为现在用户登录 - 对于SSH来讲 - 是一个不同的服务器（即新安装的Gentoo系统，而不是现在正在使用的安装系统环境）。请按照屏幕上的指示，去替换用户端的主机密钥\n网络需要能正常工作，sshd 才能使用。请参照 配置网络 的内容继续安装。\n配置网络 自动网络检测 它能够自动检测到么？\n如果系统接入到一个有DHCP服务器的以太网络，网络配置非常可能会自动设置。这样的话，安装CD所包含的很多网络命令，比如ssh、scp、ping、irssi、wget、links，以及其他的一些, 都可以立即工作。\n识别接口名称 ifconfig命令\nifconfig命令 如果网络已配置，ifconfig命令应该会列出一个或多个网络接口（围绕着lo）。在下面的示例中显示为eth0：\n# ifconfig eth0 Link encap:Ethernet HWaddr 00:50:BA:8F:61:7A inet addr:192.168.0.2 Bcast:192.168.0.255 Mask:255.255.255.0 inet6 addr: fe80::50:ba8f:617a/10 Scope:Link UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:1498792 errors:0 dropped:0 overruns:0 frame:0 TX packets:1284980 errors:0 dropped:0 overruns:0 carrier:0 collisions:1984 txqueuelen:100 RX bytes:485691215 (463.1 Mb) TX bytes:123951388 (118.2 Mb) Interrupt:11 Base address:0xe800 作为预测的网络接口名称控制的结果, 系统的接口名称可以和旧的eth0命名规则很不一样。近期的安装媒介可能显示常规网络接口名字像是eno0、ens1或enp5s0。查看ifconfig输出中找到有你本地网络相关的IP地址的接口。\nTip：如果使用标准的ifconfig命令没有显示出接口，尝试使用带有-a选项的相同的命令。这个选项强制这个工具去显示系统检测到的所有的网络接口，不管他们是up或down状态。如果ifconfig -a没有提供结果，则硬件有错误或者接口驱动没有加载到内核中。这些情况都超过本手册的范围。联系 #gentoo (webchat) 需求支持。\nip命令\n作为ifconfig的一个备选，ip命令可以用来识别接口名称。下面的示例展示了ip addr（由于是另外一个系统，所以显示的信息不同于前一个示例）的输出:\n# ip addr 2: eno1:  mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether e8:40:f2:ac:25:7a brd ff:ff:ff:ff:ff:ff inet 10.0.20.77/22 brd 10.0.23.255 scope global eno1 valid_lft forever preferred_lft forever inet6 fe80::ea40:f2ff:feac:257a/64 scope link valid_lft forever preferred_lft forever 上面的输出读起来可能比另外的更乱一点。在上面的示例中，接口名称直接跟在数字后面；它是eno1。\n在本文档的其余部分，手册中假设要操作的网络接口叫作eth0。\n测试网络 尝试ping你的ISP的DNS服务器（可在/etc/resolv.conf中找到）和选择一个网站。这可确信网络正常工作并且网络包可以到达网络，DNS名称解析能正常工作等等。\necho 'nameserver 114.114.114.114' /etc/resolv.conf ping -c 3 www.gentoo.org 如果这些都工作，则本章节中其余的部分可跳过，直接跳到安装介绍的下一步骤（准备磁盘）。\n自动网络配置 如果网络没有立即工作，一些安装媒介允许用户使用net-setup（针对常规或无线网络），pppoe-setup（针对ADSL用户）或 pptp（针对PPTP用户）。\n如果安装媒介没有包含这些工具，继续手动配置网络。\n 常规以太网用户应该继续默认：使用net-setup ADSL用户应该继续备选：使用PPP PPTP用户应该继续备选：使用PPTP  默认：使用net-setup 如果网络没有自动配置，最简单的方式是运行net-setup脚本来设置：\n# net-setup eth0 net-setup将会询问关于网络环境的一些问题。当所有这些完成后，网络连接就应该工作。以前面的方式测试网络连接。如果测试通过，恭喜！跳过本章节剩余部分并继续准备磁盘。\n如果网络还是不能工作，继续手动配置网络。\n可选：使用PPP 假设需要使用PPPoE连接到互联网，安装CD（任何版本）包含ppp来使这件事变得容易。使用提供的pppoe-setup脚本来配置连接。设置过程中将询问已连接到你的ADSL调制解调器的以太网设备、用户名和密码、DNS服务器的IP地址，以及是否需要一个简单的防火墙。\n# pppoe-setup # pppoe-start 如果还是有什么错误，再次在etc/ppp/pap-secrets或/etc/ppp/chap-secrets中检查用户名和密码都是正确的，并且确保使用了正确的以太网设备。如果以太网设备不存在，则需要加载合适的网络模块。如果是那样，继续手动网络配置将解释如何加载合适的网络模块。\n如果所有事都还，继续准备磁盘。\n可选：使用PPTP 如果需要PPTP支持，使用安装CD提供的pptpclient。但是首先确保配置是正确的。编辑/etc/ppp/pap-secrets或/etc/ppp/chap-secrets让它包含正确的用户名/密码组合：\n# nano -w /etc/ppp/chap-secrets 如果需要，继续调整/etc/ppp/options.pptp：\n# nano -w /etc/ppp/options.pptp 当所有事都已完成，运行pptp（带着一些options.pptp无法设定的选项）来连接到服务器：\n# pptp  现在继续准备磁盘。\n手动配置网络 加载适当的网络模块 安装光盘在启动时，会尝试检测所有硬件设备并加载适当的内核模块（驱动程序）以支持你的硬件。绝大多数情况下，它都做得非常好。尽管如此，在某些情况下它可能还是无法自动载入你所需要的内核模块。\n如果net-setup或pppoe-setup都失败，则可能是网络没有立即被找到。也就是说用户可能需要手动加载合适的内核模块。\n要找出什么内核模块提供网络，使用ls命令：\n# ls /lib/modules/`uname -r`/kernel/drivers/net 如果找到一个针对网络设备的驱动，使用modprobe来加载内核模块。比如，要加载pcnet32模块：\n# modprobe pcnet32 要检查网卡现在是否检测到，使用ifconfig。一个检测到的网卡应该在结果中像这样（再一次，这里的eth0只是一个示例）：\n# ifconfig eth0 eth0 Link encap:Ethernet HWaddr FE:FD:00:00:00:00 BROADCAST NOARP MULTICAST MTU:1500 Metric:1 RX packets:0 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:0 (0.0 b) TX bytes:0 (0.0 b) 不过如果你得到如下错误信息，说明没有检测到网卡：\n# ifconfig eth0 eth0: error fetching interface information: Device not found 系统中可用网络接口命名可以通过/sys文件系统列出。\n# ls /sys/class/net dummy0 eth0 lo sit0 tap0 wlan0 在上面的示例中，找到了6个接口。eth0是最像（有线）以太网络适配器，而wlan0 是无线的。\n假设现在网络已经检测到了，重新尝试net-setup或pppoe-setup（现在应该工作了），但是对于铁杆的人，我们还是要解释如何手动配置网络。\n基于你的网络从下面的章节中选择一个进行设置：\n 使用DHCP 针对自动获取IP 准备无线访问 如果使用无线网络 了解网络术语 解释了关于网络的基础 使用ifconfig和route 解释了如何手动设置网络  使用DHCP DHCP（动态主机配置协议）使自动接受网络信息（IP地址、掩码、广播地址、网关、名称服务器等）变得容易。这只在网络中有DHCP服务器（或者如果ISP提供商提供一个DHCP服务）时有用。要使一个网络接口自动接受信息，使用dhcpcd：\n# dhcpcd eth0 一些网络管理员要求你使用DHCP服务器所提供的主机名和域名。 这种情况下请用：\n# dhcpcd -HD eth0 如果这个工作的话（试着ping一些Internet服务器，像Google的8.8.8.8 或者 Cloudflare的 1.1.1.1 译者注：中国的114.114.114.114），则所有事情都设置好了并可以继续。跳过剩下的章节并继续到准备磁盘。\n准备无线网络链接 附注：可能只有特定的架构支持iw命令。如果这个命令不可用，检查net-wireless/iw包是否可用于当前架构。除非安装net-wireless/iw包，否则iw命令将一直不可用。\n当使用一块无线（802.11）网卡，在继续之前需要先配置无线设置。要查看当前无线网卡的设置，你可以使用iw。运行iw可能会显示如下：\n# iw dev wlp9s0 info Interface wlp9s0 ifindex 3 wdev 0x1 addr 00:00:00:00:00:00 type managed wiphy 0 channel 11 (2462 MHz), width: 20 MHz (no HT), center1: 2462 MHz txpower 30.00 dBm 检查当前连接：\n# iw dev wlp9s0 link Not connected. 或\n# iw dev wlp9s0 link Connected to 00:00:00:00:00:00 (on wlp9s0) SSID: GentooNode freq: 2462 RX: 3279 bytes (25 packets) TX: 1049 bytes (7 packets) signal: -23 dBm tx bitrate: 1.0 MBit/s 附注：一些无线网卡的设备名可能是wlan0或ra0而不是wlp9s0。运行ip link 来识别正确的设备名称。\n对于大多数用户，只需要两个设置来连接，即ESSID（也称无线网络名称）和可选的WEP密钥。\n 首先，确保接口处于活动状态：  # ip link set dev wlp9s0 up  连接到名为“GentooNode”的开放网络：  # iw dev wlp9s0 connect -w GentooNode  设置一个WEP密钥：使用d:前缀：  # iw dev wlp9s0 connect -w GentooNode key 0:d:1234123412341234abcd  用ASCII WEP密钥连接：  # iw dev wlp9s0 connect -w GentooNode key 0:some-password 附注：如果无线网络配置为WPA或WPA2，则需要使用wpa_supplicant。关于为Gentoo Linux配置无线网络的更多信息，请阅读Gentoo手册中的无线网络章节。\n使用iw dev wlp9s0 link确认无线设置。如果无线已经工作，继续按下一章节（了解网络术语）配置IP级别的网络选项或者使用前面描述的net-setup工具。\n网络术语解读 如果以上所做的全部失败，你将不得不手动配置你的网络。这其实一点也不难。不过，你需要熟悉一些网络术语，才能配置好网络令自己满意。读完本节之后，你将了解到什么是网关，子网掩码是作什么用的，广播地址是如何形成的，以及为什么需要名称服务器。\n在网络中，主机通过它们的IP地址（互联网协议地址）来标识。这个地址被看为是由四个0到255的数字来组成。很好，至少在使用IPv4（IP版本4）时。实事上，这样的一个IPv4地址包括32个位（1和0）。让我们来看一个示例：\nIP地址（数字）： 192.168.0.2 IP地址（位）： 11000000 10101000 00000000 00000010 -------- -------- -------- -------- 192 168 0 2 附注：比IPv4更成功的IPv6使用128位（1和0）。在这章节中，我们只关注IPv4地址。\n在所有可访问到的网络里，这样的IP地址跟主机是一一对应的（比如你能够连接到的每台主机必须拥有一个唯一的IP地址）。为了区别一个网络内部和外部的主机，IP地址被分为两个部分：网络部分和主机部分。\n由一堆1后面跟着一堆0的掩码写出了网络的分离。IP映射到1的部分是网络部分，剩下的是主机部分。通常，掩码可以写成IP地址。\nIP地址： 192 168 0 2 11000000 10101000 00000000 00000010 掩码： 11111111 11111111 11111111 00000000 255 255 255 0 +--------------------------+--------+ 网络 主机 换句话说，192.168.0.14是示例网络的一部分，但192.168.1.2不是。\n广播地址是一个拥有相同网络部分，但是主机部分全是1的IP地址。网络上的每一个主机都监听这个IP地址。它的真正用途是用来广播包。\nIP地址： 192 168 0 2 11000000 10101000 00000000 00000010 广播： 11000000 10101000 00000000 11111111 192 168 0 255 +--------------------------+--------+ 网络 主机 了能在互联网上冲浪，网络中的每个主机必须知道哪个主机共享着互联网连接。这个主机叫作网关。它同样是一台常规主机，它有一个常规IP地址（比如192.168.0.1）。\n之前我们说每台主机都有它自己的IP地址。要通过名称来到达这台主机（代替一个IP地址）我们需要一个服务去翻译一个名称（比如dev.gentoo.org）到一个IP地址（64.5.62.82）。这样的服务叫做名称服务。要使用这样的服务，需要在/etc/resolv.conf中定义所需的名称服务器。\n有些情况下，网关同时也是名称服务器。不然的话，需要在这个文件中添加ISP提供的名称服务器。\n总结一下，在继续之前需要下面的信息：\n   网络项目 示例     系统IP地址 192.168.0.2   掩码 255.255.255.0   广播 192.168.0.255   网关 192.168.0.1   名称服务器 195.130.130.5, 195.130.130.133    使用ifconfig和route 设置网络由三步组成：\n 使用ifconfig指派一个IP地址 使用route设置到网关的路由 通过/etc/resolv.conf设置名称服务器的IP完成  要指派一个IP地址，需要IP地址、广播地址和掩码。运行下面的命令，替换${IP_ADDR}为正确的IP地址、${BROADCAST}为正确的广播地址以及${NETMASK}为正确的掩码：\n# ifconfig eth0 ${IP_ADDR} broadcast ${BROADCAST} netmask ${NETMASK} up 用route设置路由。替换${GATEWAY}为正确的网络IP地址：\n# route add default gw ${GATEWAY} 现在打开/etc/resolv.conf：\n# nano -w /etc/resolv.conf 使用下面的模板填入名称服务器。确保替换${NAMESERVER1}和${NAMESERVER2}为合适的名称服务器地址：\nnameserver ${NAMESERVER1} nameserver ${NAMESERVER2} 就是这样。现在通过ping一些互联网服务器（像Google的8.8.8.8 或者 Cloudflare的 1.1.1.1 译者注：中国的114.114.114.114）来测试网络。如果这个工作的话，再次恭喜。继续到准备磁盘。\n准备磁盘 块设备简介 块设备 让我们来好好看看Gentoo Linux以及普通Linux中有关磁盘方面的知识，包括块设备、分区和Linux文件系统。一旦磁盘的来龙去脉都了解了，我们将设置分区和文件系统以进行安装。\n首先，让我们来看看块设备。最著名的块设备可能是代表Linux系统第一块磁盘的/dev/sda。SCSI和SATA磁盘全标为/dev/sd*；甚至IDE磁盘在libata内核框架下也标为/dev/sd*。当使用老设备框架时，第一个IDE磁盘是/dev/hda。\n下表将帮助读者确定系统上找到某种类型的块设备的位置：\n   Type of device Default device handle Editorial notes and considerations     SATA, SAS, SCSI, or USB flash /dev/sda Found on hardware from roughly 2007 until the present, this device handle is perhaps the most commonly used in Linux. These types of devices can be connected via the SATA bus, SCSI, USB bus as block storage. As example, the first partition on the first SATA device is called /dev/sda1.   NVM Express (NVMe) /dev/nvme0n1 The latest in solid state technology, NVMe drives are connected to the PCI Express bus and have the fastest transfer block speeds on the market. Systems from around 2014 and newer may have support for NVMe hardware. The first partition on the first NVMe device is called /dev/nvme0n1p1.   MMC, eMMC, and SD /dev/mmcblk0 embedded MMC devices, SD cards, and other types of memory cards can be useful for data storage. That said, many systems may not permit booting from these types of devices. It is suggested to not use these devices for active Linux installations; rather consider using them to transfer files, which is their design goal. Alternatively they could be useful for short-term backups.    上面的块设备代表磁盘的抽象接口。用户程序可以使用这些块设备来与你的磁盘进行交互，而无需担心驱动器到底是 SATA，SCSI 还是其他什么东西。该程序可以把磁盘当作一系列连续的，可随机访问的 4096 字节块（4K）的存储。\n分区表 虽然理论上可以用一整块磁盘来安装一个Linux系统（比如当创建一个 btrfs RAID时），但是实践中几乎从不这样做。实际上，一块磁盘可以被分成小一些的、更容易管理的块设备。在 amd64 系统里，这被称为分区。有两个标准的分区技术可以被使用：MBR（有时也称为 DOS 磁盘标签）和GPT；这些与两种引导过程类型相关：传统 BIOS 引导和 UEFI 引导。\nGUID 分区表 (GPT)\nGUID 分区表 (GPT)设置（也称为 GPT 磁盘标签）对分区使用 64 位标识符。它用来存储分区信息的空间也远比 MBR 分区表（DOS 磁盘标签）的512字节要大，GPT磁盘它也不对分区的数量作限制。分区的大小限制可以达到 8 ZiB（zebibytes）。\n译者注：\n 1ZiB = 1,024 EiB 1EiB = 1024 PiB 1PiB = 1024 TiB 1TiB = 1024 GiB 1GiB = 1024 MiB 1MiB = 1024 KiB 1KiB = 1024 B  当操作系统和系统固件之间的软件接口是UEFI (相对于BIOS)时，GPT几乎是必选的，因为这里 DOS 磁盘标签会引起很多兼容性问题。\nGPT还利用校验和和冗余。 它携带CRC32校验和以检测报头和分区表中的错误，并在磁盘的末尾有一个备份GPT。 此备份表可用于恢复磁盘开头附近主GPT的损坏。\nImportant：关于 GPT 有一些注意事项：\n 在基于 BIOS 的计算机上使用 GPT 是可行的，但不能与 Microsoft Windows 操作系统进行双重引导。原因是如果 Microsoft Windows 检测到 GPT 分区标签，它将以 UEFI 模式启动。 一些配置为以 BIOS/CSM/legacy 模式启动的有问题的（旧）主板固件在从 GPT 标记的磁盘启动时也可能存在问题。  主引导记录 (MBR) 或 DOS 引导扇区\n主引导记录引导扇区（也称为 DOS 引导扇区或 DOS 磁盘标签）于 1983 年首次在 PC DOS 2.x 中引入。 MBR 使用 32 位标识符作为分区的起始扇区和长度，并支持三种分区类型：主分区、扩展分区和逻辑分区。主分区的信息存储在主引导记录本身——磁盘最开始的一个非常小的（通常是 512 字节）位置。由于空间很小，因此仅支持四个主分区（例如，/dev/sda1 到 /dev/sda4）。\n为了支持更多的分区，可以将 MBR 中的主分区之一标记为扩展分区。然后，该分区可以包含其它逻辑分区（分区内的分区）。\n重要：虽然大多数主板制造商仍然支持，但 MBR 引导扇区及其相关的分区限制被认为是传统的分区方式。除非使用 2010 之前的硬件，否则最好使用 GUID 分区表 对磁盘进行分区。必须继续进行设置类型的读者应了解以下信息：\n 大多数 2010 年后的主板都有接受用 MBR 引导扇区作为传统（受支持但不理想的）引导模式。 由于使用 32 位标识符，MBR 中的分区表无法处理大于 2 TiB 的存储空间。 除非创建扩展分区，否则 MBR 最多支持四个分区。 此设置不提供备份引导扇区，因此如果某些内容覆盖分区表，所有分区信息将丢失。  也就是说，在 AWS 等虚拟化云环境中仍经常使用 MBR 和 BIOS 启动。\n手册作者建议读者安装Gentoo时尽可能使用 [GPT](#使用 GPT for UEFI 对磁盘进行分区) 。\n高级存储 amd64 安装 CD 提供了对逻辑卷管理器 (LVM) 的支持。 LVM 通过增加分区设置提供的灵活性。它允许将分区和磁盘组合到卷组中，并在快速的固态硬盘上为慢速的机械硬盘定义 RAID 组或缓存。下面的安装说明将侧重于\"常规\"分区，如果强烈需要 LVM，请访问 LVM 文章了解更多详情。新手请注意：LVM虽然完全支持 ，但不在本指南的范围内。\n默认分区方案 在本手册的其余部分，我们将讨论和解释两种情况：1) GPT 分区表和 UEFI 引导，以及 2) MBR 分区表和传统 BIOS 引导。虽然可以混合搭配，但这超出了本手册的范围。如上所述，现代设备应该使用 GPT 分区表和 UEFI 引导；作为此规则的一个例外，MBR 和 BIOS 引导依然经常用于虚拟化（云）环境。\n以下分区方案将用作一个简单的示例布局：\n   Partition Filesystem Size Description     /dev/sda1 fat32 (UEFI) or ext4 (BIOS) 256M Boot/EFI system partition   /dev/sda2 (swap) RAM size * 2 Swap partition   /dev/sda3 ext4 Rest of the disk Root partition    如果这些信息已经足够，高级读者可以直接跳转到实际分区操作。\nfdisk 和 parted 都是分区实用程序。 fdisk 是众所周知的，稳定的，推荐用于 MBR 分区布局分区工具。 parted 是最早支持 GPT 分区的 Linux 块设备管理的分区工具之一，并提供了替代方案。此处使用 fdisk 是因为它具有更好的基于文本的用户界面。\n在进行创建分区的指导之前，关于分区方案和常见陷阱我们会先介绍更多的细节。\n设计一个分区方案 多少个分区以及多大？ 分区数量高度依赖于环境。比如，如果有很多个用户，则建议有一个独立的 /home/，以增强安全性及便于备份。如果安装 Gentoo 来做邮件服务器，则 /var/ 应该独立，因为所有的邮件都储存于 /var/。选择一个正确的文件系统将会获得最大化的性能。游戏服务器应该有一个独立的 /opt/，因为大多数游戏服务器都安装在那里。原因也和 /home/ 目录一样：安全和备份。在大多数场景下，应该保持 /usr/ 大一些：不仅是因为它包含多数的应用程序，还因为它通常还托管着 Gentoo ebuild 存储库（默认情况下位于 /var/db/repos/gentoo ），占用大约 650 MiB 的空间。这个磁盘空间的估计值默认不包括 /var/cache/ 下的 binpkgs/ 和 distfiles/ 目录。\n在Gentoo的大多数情况下，/usr和/var应该保持相对较大的容量。/usr 包含系统上的大多数应用程序和Linux内核源（/usr/src 下）。默认情况下，/var 包含 gentoo ebuild存储库（位于/var/db/repos/gentoo），通常会消耗大约650 MiB（这取决于文件系统）的磁盘空间。此空间估计不包括/var/cache/distfiles（source files）和/var/cache/binpkgs（binary packages）目录。\n分区的数量和大小取决于权衡利弊后根据实际情况选择最佳选项。单独的分区或卷具有以下优点：\n 为每个分区或者卷选择性能最好的文件系统。 当一个失控的工具持续向一个分区或卷写文件时，也不至于让整个系统由于无可用空间而无法运行。 如果有必要，可以简化文件系统检查，多个检查可以并行的完成（尽管使用多个磁盘比使用多个分区更多地实现了这一优势）。 可以通过在挂载一些分区或卷时使用只读、nosuid（忽略setuid属性）、noexec（忽略可执行属性）等来增加安全性。  但是，多个分区也有一些缺点：\n 如果配置不正确，系统可能在一个分区上有很多可用空间，而在另一个分区上可用空间很少。 /usr/ 的单独分区可能需要管理员使用 initramfs 引导，以便在其他引导脚本启动之前挂载该分区。由于 initramfs 的生成和维护超出了本手册的范围，我们建议新手不要为 /usr/ 使用单独的分区。 SCSI 和 SATA 也有 15 个分区的限制，除非磁盘使用 GPT 标签。  附注：如果你打算使用 Systemd，/usr/ 必须在启动时可用，作为根文件系统的一部分或通过 initramfs 挂载。\n那么swap空间呢？ 对于swap空间，没有一个完美值。swap空间的目的是当内存（RAM）有压力时为内核提供磁盘存储。一个swap空间允许内核将看过来稍后不会被访问的内存页面移动到磁盘（swap或者page-out）、施放内存。当然，如果那块内存突然要使用到，需要花一些时间（相比较内存，硬盘是非常慢的）将这些页面需要放回到内存中（page-in）。\n如果系统不运行很需要内存的应用程序或系统有足够多的可能内存，则不需要太多的swap空间。不过，swap空间还用来在休眠时储存整个内存。如果一个系统需要休眠，则必须需要大一点的swap空间，通常至少为系统安装的内存数量。\n作为一般规则，建议交换空间大小为内部存储器 (RAM) 的两倍。对于具有多个硬盘的系统，明智的做法是在每个磁盘上创建一个交换分区，以便它们可以用于并行读/写操作。当必须访问交换空间中的数据时，磁盘交换的速度越快，系统运行的速度就越快。在机械和固态磁盘之间进行选择时，最好将交换放在 SSD 上以提高性能。此外，交换文件可以用作交换分区的替代方案；这对于磁盘空间非常有限的系统来说非常有趣。\n什么是 EFI 系统分区 (ESP)？ 在使用由 UEFI 引导（而不是 BIOS）的操作系统上安装 Gentoo 时，创建 EFI 系统分区 (ESP) 很重要。下面的说明包含正确处理此操作所需的关键点。 在 BIOS/Legacy 模式下启动时不需要 EFI 系统分区。\nESP 必须是 FAT 变体（有时在 Linux 系统上显示为 vfat）。官方 [UEFI 规范](http://www.uefi.org/sites/default/files/resources/UEFI 2_5.pdf) 表示 UEFI 固件将识别 FAT12、16 或 32 文件系统，但建议使用 FAT32。分区后，相应地格式化 ESP：\n# mkfs.fat -F 32 /dev/sda1 警告：如果 ESP 没有使用 FAT 变体进行格式化，那么系统的 UEFI 固件将找不到引导加载程序（或 Linux 内核）并且很可能无法引导系统！\n什么是BIOS引导分区？ 只有在 BIOS/Legacy 模式下将 GPT 分区布局与 GRUB2 结合时，才需要 BIOS 引导分区。 **在 EFI/UEFI 模式下引导时不需要它，使用 MBR 表时也不需要它。**它是一个非常小的分区（1 到 2 MB），像 GRUB2 这样的可以在其中放置超出容量的引导加载程序。本指南中不会使用它。\n使用 GPT for UEFI 对磁盘进行分区 以下部分解释了如何使用 fdisk 为 GPT/UEFI 引导安装创建示例分区布局。范例分区布局我们在前面已经提到过了。\n   Partition Description     /dev/sda1 EFI system (and boot) partition   /dev/sda2 Swap partition   /dev/sda3 Root partition    请您根据自己的实际需要来调整您的分区布局。\n查看当前分区布局 fdisk是一个流行的和强大的分区工具。用fdisk向磁盘开火吧！（在我们的例子里，我们使用/dev/sda）:\n# fdisk /dev/sda 使用 p 键来显示磁盘当前的分区配置。\nCommand (m for help):p Disk /dev/sda: 28.89 GiB, 31001149440 bytes, 60549120 sectors Disk model: DataTraveler 2.0 Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: gpt Disk identifier: 21AAD8CF-DB67-0F43-9374-416C7A4E31EA Device Start End Sectors Size Type /dev/sda1 2048 526335 524288 256M EFI System /dev/sda2 526336 2623487 2097152 1G Linux swap /dev/sda3 2623488 19400703 16777216 8G Linux filesystem /dev/sda4 19400704 60549086 41148383 19.6G Linux filesystem 这块特定的磁盘被配置为容纳 2 个 Linux 文件系统（每个都有一个相应的分区列为“Linux”）以及一个交换分区（列为“Linux swap”）。\n创建一个新的磁盘标签/删除所有分区 输入 g 在磁盘上创建一个新的 GPT 磁盘标签；这将删除所有现有分区。\nCommand (m for help):g Created a new GPT disklabel (GUID: 87EA4497-2722-DF43-A954-368E46AE5C5F). 对于现有的 GPT 磁盘标签（参见上面 p 的输出），或者考虑从磁盘中一一删除现有分区。输入 d 来删除一个分区。例如，要删除现有的 /dev/sda1：\nCommand (m for help):d Partition number (1-4): 1 这个分区已经计划被删除了，当您用p键打印分区清单时它将不会被显示了，但此时它还未被实际删除，直到改变被真正保存。这将允许用户在操作错误后中止——此时，输入q并按Enter可以立即防止分区被删除。\n重复敲击 p来打印分区清单，然后敲击 d键和分区号码来删除它。最终，分区表将变得空空如也。\nCommand (m for help):p Disk /dev/sda: 28.89 GiB, 31001149440 bytes, 60549120 sectors Disk model: DataTraveler 2.0 Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: gpt Disk identifier: 87EA4497-2722-DF43-A954-368E46AE5C5F 现在在内存中的分区表已经空了，我们是时候来创建分区了。\n创建 EFI 系统分区 (ESP) 首先创建一个小的 EFI 系统分区，该分区也将挂载为 /boot。输入 n 创建一个新分区，然后输入 1 选择第一个分区。当提示输入第一个扇区时，确保它从 2048（引导加载程序可能需要）开始并输入 Enter。当提示输入最后一个扇区时，输入 +256M 创建一个大小为 256 MB 的分区：\nCommand (m for help):n Partition number (1-128, default 1): 1 First sector (2048-60549086, default 2048): Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-60549086, default 60549086): +256M Created a new partition 1 of type 'Linux filesystem' and of size 256 MiB. 将分区标记为 EFI 系统分区：\nCommand (m for help):t Selected partition 1 Partition type (type L to list all types): 1 Changed type of partition 'Linux filesystem' to 'EFI System'. 创建swap分区 接下来，要创建交换分区，请输入 n 创建一个新分区，然后输入 2 创建第二个分区 /dev/sda2。当提示输入第一个扇区时，输入 Enter。当提示输入最后一个扇区时，输入 +4G（或交换空间所需的任何其他大小）以创建大小为 4GB 的分区。\nCommand (m for help):n Partition number (2-128, default 2): First sector (526336-60549086, default 526336): Last sector, +/-sectors or +/-size{K,M,G,T,P} (526336-60549086, default 60549086): +4G Created a new partition 2 of type 'Linux filesystem' and of size 4 GiB. 完成后，输入t设置分区类型，2选择刚刚创建的分区，然后输入 19 设置分区类型为 “Linux Swap”。\nCommand (m for help):t Partition number (1,2, default 2): 2 Partition type (type L to list all types): 19 Changed type of partition 'Linux filesystem' to 'Linux swap'. 创建根分区 最后，要创建根分区，请输入 n 以创建新分区。然后输入 3 创建第三个分区，/dev/sda3。当提示输入第一个扇区时，按 Enter。当提示输入最后一个扇区时，按 Enter 以创建一个分区，该分区占用磁盘上的其余剩余空间。完成这些步骤后，输入 p 应该会显示一个类似于以下内容的分区表：\nCommand (m for help):p Disk /dev/sda: 28.89 GiB, 31001149440 bytes, 60549120 sectors Disk model: DataTraveler 2.0 Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: gpt Disk identifier: 87EA4497-2722-DF43-A954-368E46AE5C5F Device Start End Sectors Size Type /dev/sda1 2048 526335 524288 256M EFI System /dev/sda2 526336 8914943 8388608 4G Linux swap /dev/sda3 8914944 60549086 51634143 24.6G Linux filesystem 保存分区布局 要保存分区布局并退出 fdisk，请敲击 w。\nCommand (m for help):w 当分区创建完成后，就该在其上部署文件系统了。\n使用 MBR 对磁盘进行分区以用于 BIOS/legacy 启动 下面解释了如何为 MBR/BIOS 传统引导安装创建示例分区布局。前面提到的示例分区布局现在是：\n   Partition Description     /dev/sda1 Boot partition   /dev/sda2 Swap partition   /dev/sda3 Root partition    可以根据个人喜好更改分区布局。\n查看当前分区布局 针对磁盘启动 fdisk（在我们的示例中，我们使用 /dev/sda）：\n# fdisk /dev/sda 输入p显示磁盘的当前分区配置：\nCommand (m for help):p Disk /dev/sda: 28.89 GiB, 31001149440 bytes, 60549120 sectors Disk model: DataTraveler 2.0 Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: gpt Disk identifier: 21AAD8CF-DB67-0F43-9374-416C7A4E31EA Device Start End Sectors Size Type /dev/sda1 2048 526335 524288 256M EFI System /dev/sda2 526336 2623487 2097152 1G Linux swap /dev/sda3 2623488 19400703 16777216 8G Linux filesystem /dev/sda4 19400704 60549086 41148383 19.6G Linux filesystem 直到现在，这个特定的磁盘被配置为使用 GPT 表容纳两个 Linux 文件系统（每个都有一个相应的分区列为 “Linux”）以及一个交换分区（列为 “Linux swap”）。\n创建一个新的磁盘标签/删除所有分区 输入 o 在磁盘上创建一个新的 MBR 磁盘标签（这里也称为 DOS 磁盘标签）；这将删除所有现有分区。\nCommand (m for help):o Created a new DOS disklabel with disk identifier 0xe04e67c4. The device contains 'gpt' signature and it will be removed by a write command. See fdisk(8) man page and --wipe option for more details. 对于现有的 DOS 磁盘标签（参见上面 p 的输出），或者考虑从磁盘中一一删除现有分区。输入 d 删除分区。例如，要删除现有的 /dev/sda1：\nCommand (m for help):d Partition number (1-4): 1 该分区现已计划删除。打印分区列表时将不再显示 (p，但在保存更改之前它不会被删除。如果发生错误，用户可以中止操作 —— 在这种情况下, 立即输入 q 并按 Enter 不会删除分区。\n重复输入 p 打印出一个分区列表，然后输入 d 和分区号来删除它。最终，分区表将为空：\nCommand (m for help):p Disk /dev/sda: 28.89 GiB, 31001149440 bytes, 60549120 sectors Disk model: DataTraveler 2.0 Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0xe04e67c4 现在我们已准备好创建分区。\n创建引导分区 首先，创建一个将挂载到 /boot 的小分区。输入 n 创建一个新分区，然后输入 p 作为主分区，输入 1 选择第一个主分区。当提示输入第一个扇区时，确保它从 2048（引导加载程序可能需要）开始并按 Enter。当提示输入最后一个扇区时，输入 +256M 创建一个大小为 256 MB 的分区：\nCommand (m for help):n Partition type p primary (0 primary, 0 extended, 4 free) e extended (container for logical partitions) Select (default p): p Partition number (1-4, default 1): 1 First sector (2048-60549119, default 2048): Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-60549119, default 60549119): +256M Created a new partition 1 of type 'Linux' and of size 256 MiB. 创建 swap 分区 接下来，要创建交换分区，输入 n 创建一个新分区，然后输入 p，然后输入 2 创建第二个主分区，/dev/sda2。当提示输入第一个扇区时，按 Enter。当提示输入最后一个扇区时，输入 +4G（或交换空间所需的任何其他大小）以创建大小为 4GB 的分区。\nCommand (m for help):n Partition type p primary (1 primary, 0 extended, 3 free) e extended (container for logical partitions) Select (default p): p Partition number (2-4, default 2): 2 First sector (526336-60549119, default 526336): Last sector, +/-sectors or +/-size{K,M,G,T,P} (526336-60549119, default 60549119): +4G Created a new partition 2 of type 'Linux' and of size 4 GiB. 完成后，输入t设置分区类型，输入2选择刚刚创建的分区，然后输入 82 设置分区类型为 “Linux Swap”。\nCommand (m for help):t Partition number (1,2, default 2): 2 Hex code (type L to list all codes): 82  Changed type of partition 'Linux' to 'Linux swap / Solaris'. 创建根分区 最后，要创建根分区，请输入 n 以创建新分区。然后输入 p 和 3 以创建第三个主分区 /dev/sda3。当提示输入第一个扇区时，按 Enter。当提示输入最后一个扇区时，按 Enter 以创建一个分区，该分区占用磁盘上的剩余空间。完成这些步骤后，输入 p 应该会显示一个类似于以下内容的分区表：\nCommand (m for help):p Disk /dev/sda: 28.89 GiB, 31001149440 bytes, 60549120 sectors Disk model: DataTraveler 2.0 Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0xe04e67c4 Device Boot Start End Sectors Size Id Type /dev/sda1 2048 526335 524288 256M 83 Linux /dev/sda2 526336 8914943 8388608 4G 82 Linux swap / Solaris /dev/sda3 8914944 60549119 51634176 24.6G 83 Linux 保存分区布局 要保存分区布局并退出 fdisk，输入 w。\nCommand (m for help):w 现在是时候将文件系统应用在分区上了。\n创建文件系统 介绍 现在分区已经创建，该在上面设置文件系统了。下一章节中描述了 Linux 所支持的众多文件系统。知道使用哪一个文件系统的读者可以继续阅读为分区应用文件系统。剩下的人应该学习可用的文件系统……\n文件系统 有一些可以使用的文件系统。有些在amd64架构上稳定——建议在选择为一个重要分区实验性的选择文件系统前继续阅读。\n  btrfs\n是下一代文件系统，提供了许多高级功能，如快照，通过校验和自我修复、 透明压缩、 子卷和集成 RAID。几个发行版已经开始将它作为一个默认的选项,但它还未为生产工作做好准备。文件系统报告崩溃是常见的。其开发人员敦促人们运行最新的内核版本来解决安全问题,以及老的问题。 这种情况已经很多年了,现在使用它还为时过早。如果出现变更，以及发生了变化，解决错误问题，都很少往旧内核注入补丁。请谨慎使用这个文件系统!\n  ext2\n是经考验证明可靠的Linux文件系统，但是没有元数据日志，这意味这在启动系统时的ext2文件系统的日常检查相当耗时。现在相当一部分的新一代的日志文件系统都可以非常迅速检查一致性，因此比那些非日志文件系统更受欢迎。当你启动系统碰巧遇到文件系统状态不一致时，日志文件系统不会在那里耽搁很长时间。\n  ext3\n是ext2文件系统的带日志版本，提供了元数据日志模式以快速恢复数据。此外还提供了其他增强的日志模式，如完整数据日志模式和有序数据日志模式。它使用了HTree索引，在几乎所有的情况下都能保持高性能。简而言之，ext3是非常好及可靠的文件系统。\n  ext4\n最初创建为ext3的一个分支，EXT4带来了新的功能，性能改进和去除中度更改磁盘格式大小限制。它可以跨越体积高达1的EB并用16 TB最大文件大小。取而代之的是经典的ext2/3位块分配的ext4的使用范围，这对提高大文件的性能，并减少碎片。的Ext4还提供了更为复杂的块分配算法（延迟分配和多嵌段分配）给文件系统驱动更多的方式来优化数据的布局在磁盘上。 EXT4是推荐的通用所有平台的文件系统。\n  f2fs\n这个文件系统最初由三星创建用于NAND闪存，是一种闪存文件系统 从直到2016年第二季度起，这个文件系统仍然被认为不成熟。把Gentoo安装到microSD卡，USB驱动器或其他基于闪存的存储设备时使用它是一个不错的选择。\n  JFS\n是IBM的高性能日志文件系统。JFS是一个轻量级的、快速的和稳定的基于B+树的文件系统，在很多情况下都有很好的表现。\n  ReiserFS\n是基于B+树的文件系统，它有着非常全面的性能，特别时在处理很多小文件的时候，虽然会占用多一点CPU。ReiserFS相比其他文件系统显得受维护的不够。\n  XFS\n是一种带元数据日志的文件系统，它有一个健壮的特性集，并且对可伸缩性进行了优化。XFS似乎对各种各样的硬件问题显得不够宽容。\n  vfat\n也称为FAT32，被支持Linux，但不支持任何权限设置。它主要用于互操作性与其他操作系统（主要是微软的Windows），但也是很有必要的一些系统固件（如UEFI）的支持。\n  NTFS\n这个“新技术”的文件系统是Microsoft Windows的旗舰文件系统。 与上面的vfat类似，它不存储BSD或Linux正常工作所需的权限设置或扩展属性，因此它不能用作根文件系统。 它应该’只’用于与Microsoft Windows系统的互操作性（注意只强调）。\n  为分区应用文件系统 在一个分区或卷上创建一个文件系统，这里有用于每一个可能的分区的工具。 单击下表中的文件系统名称，了解每个文件系统的更多信息：\n   Filesystem Creation command On minimal CD? Package     btrfs mkfs.btrfs Yes sys-fs/btrfs-progs   ext4 mkfs.ext4 Yes sys-fs/e2fsprogs   f2fs mkfs.f2fs Yes sys-fs/f2fs-tools   jfs mkfs.jfs Yes sys-fs/jfsutils   reiserfs mkfs.reiserfs Yes sys-fs/reiserfsprogs   xfs mkfs.xfs Yes sys-fs/xfsprogs   vfat mkfs.vfat Yes sys-fs/dosfstools   NTFS mkfs.ntfs Yes sys-fs/ntfs3g    例如，要将 EFI 系统分区 (/dev/sda1) 设为 FAT32，将根分区 (/dev/sda3) 设为 ext4，如示例分区结构中所用，将使用以下命令：\n# mkfs.vfat -F 32 /dev/sda1 # mkfs.ext4 /dev/sda3 当在一个小的分区（少于8 GiB）上使用 ext2、ext3 或 ext4，则创建文件系统时必须带适当的选项以保留足够的 inode。mke2fs（mkfs.ext2）应用程序使用“字节每inode”设置来计算一个文件系统 inode 的数量。在小分区，建议增加计算出的 inode 数量。\n# mkfs.ext4 -T small /dev/ 这一般将是对于给定的文件系统inode数量的四倍，它的“字节每inode”从16kB每个减少到4kB每个。这个可以在将来通过提供比例进行调整：\n现在在新创建的分区（或逻辑卷）上创建文件系统。\n激活swap分区 mkswap是用来初始化swap分区的命令：\n# mkswap /dev/sda2 要激活swap分区，使用swapon：\n# swapon /dev/sda2 使用上面提到的命令创建和激活swap。\n可选：使用 swapfile $ fallocate -l 15G /swapfile $ chmod 600 /swapfile $ mkswap /swapfile $ swapon /swapfile $ swapon -s 挂载 root 分区 现在分区都已初始化并有文件系统，接下来该挂载那些分区了。使用mount命令，但是不要忘记为每一个创建的分区创建需要的挂载目录。比如示例中我们挂载根分区:\n# mount /dev/sda3 /mnt/gentoo 附注：如果/tmp/需要放在一个独立分区，确保在挂载后变更它的权限：\n# chmod 1777 /mnt/gentoo/tmp 这同样适用于/var/tmp。\n后面的介绍中将挂载proc文件系统（一个内核的虚拟接口）和其它内核伪文件系统。不过我们首先安装Gentoo安装文件。\n安装Gentoo安装文件 安装stage包 设置日期和时间 在安装Gentoo之前，最好确保日期和时间设置正确。 错误配置的时间可能会导致奇怪的结果：基本系统文件应设置精确的时间戳。 事实上，由于几个网站和服务使用加密通信（SSL / TLS），如果系统时间差的离谱，可能无法下载安装文件！\n验证当前时间使用命令date:\n# date Mon Oct 3 13:16:22 PDT 2021 如果显示的日期/时间不正确，请使用下列方法之一进行更新。\n附注：不包括实时时钟（RTC）的主板应配置为自动将系统时钟与时间服务器同步。 这也适用于包含RTC但具有故障电池的系统。\n自动\nGentoo 的官方安装光盘包含 ntpd 命令 (属于包 net-misc/ntp package)。官方光盘包括指向ntp.org时间服务器的配置文件。它可以用于使用时间服务器，使得系统时钟自动同步到UTC时间。使用方法见配置网络 但在某些架构的光盘上可能不可用。\n警告：自动时间同步需要付出一个代价。它将向时间服务器显示系统的IP地址和相关网络信息（在下面的示例中为ntp.org）。有隐私问题的用户应该注意这个“之前”使用下面的方法设置系统时钟。\n# ntpd -q -g 手动\n也可以用date 命令来对系统时钟执行手动设置。使用 MMDDhhmmYYYY 语法 (月, 日, 小时, 分钟 和 年)。\n建议所有Linux系统使用UTC时间。 稍后在安装期间将定义时区。 这将修改时钟的显示为本地时间。\n比如，设置时间到2016年10月3日的13:16：\n# date 100313162021 选择一个stage包 multilib（32和64位）\n选择一个基础压缩包的系统可以在稍后的安装过程节省大量的时间，特别是当它是一次选择正确的配置文件。一个stage包的选择将直接影响未来的系统配置，可以在以后省的头痛。该压缩包 multilib 尽可能使用64位的库，只必要时对32位版本兼容。这对于大多数安装一个很好的选择，因为它在未来的定制提供了极大的灵活性量。那些谁希望自己的系统，能够容易地切换配置,应该下载根据各自的处理器架构 multilib的压缩包选项。\n大多数用户应该不需要使用“高级”tar包选项；它们用于特定的软件或硬件配置。\nno-multilib（纯64位）\n选择一个no-multilib压缩包:no-multilib是在系统的基础上提供了一个完整的64位操作系统环境。这有效地使得切换到multilib的profile是不可能的(不是完全不可能)。这些刚刚开始使用Gentoo的新手不应该选择一个 no-multilib 压缩包，除非\"绝对必要\"。而且应该有很好的理由并做出负责任的选择。\n警告：注意，把一个系统从no-multilib迁移到multilib需要极其丰富的使用Gentoo的知识并熟悉底层的工具链。这一做法甚至可能导致Toolchain developers 这令人不寒而栗。不适合内心柔弱之人,而且也超出了本指南的范围。\n其他 profile 属性说明\n openrc: 带此单词表示，其默认的初始化程序为 openrc systemd: 带此单词表示，其默认的初始化程序为 systemd，而不带该单词所有 profile ，默认初始化程序都是 openrc （即 Gentoo Linux 官方默认） selinux: 带此单词表示，其默认包含 SELinux 相关配置，启用 SELinux hardened: 带此单词表示，其默认包含强化安全性相关的配置  正常使用情况下，推荐如下两个 stage3 进行下载：\n current-stage3-amd64-openrc current-stage3-amd64-systemd  openrc 是 Gentoo Linux 官方维护且默认的初始化程序，而 systemd 则是如今大多数发行版使用的初始化程序，各有优劣，二者均可，自行选择。\n下载stage压缩包 前往挂载根文件系统的 Gentoo 挂载点（类似于 /mnt/gentoo）：\n# cd /mnt/gentoo 根据不同的安装媒介，下载stage压缩包所需的唯一工具是网络浏览器。\n图形化浏览器\n那些使用图形化网页浏览器从主网站下载小节复制stage文件URL也没有问题。 只需选择适当的选项卡，右键单击stage文件的链接，然后复制链接地址（Firefox）或复制链接位置（Chromium）将链接复制到剪贴板，然后 将链接粘贴到命令行中的 wget程序以下载stage tarball：\n# wget  例如\n# wget https://mirrors.bfsu.edu.cn/gentoo/releases/amd64/autobuilds/current-stage3-amd64-systemd/stage3-amd64-systemd-20220315T091810Z.tar.xz # wget https://mirrors.bfsu.edu.cn/gentoo/releases/amd64/autobuilds/current-stage3-amd64-systemd/stage3-amd64-systemd-20220315T091810Z.tar.xz.DIGESTS # cat stage3-amd64-systemd-20220315T091810Z.tar.xz # sha512sum stage3-amd64-systemd-20220315T091810Z.tar.xz 命令行浏览器\n更多传统的读者或是 Gentoo 的“老前辈”，只能命令行工作，可能更喜欢使用非图形化菜单驱动的浏览器 links。 要下载一个 stage，请像下面这样访问Gentoo镜像列表：\n# links https://www.gentoo.org/downloads/mirrors/ 要设置links使用一个HTTP代理，在传入URL上加一个-http-proxy选项：\n# links -http-proxy proxy.server.com:8080 https://www.gentoo.org/downloads/mirrors/ links之外还有一个lynx浏览器。和links类似，它也是一个非图形化的浏览器，但不是自带的。\n# lynx https://www.gentoo.org/downloads/mirrors/ 如果需要定义一个代理，设置http_proxy和/或ftp_proxy变量：\n# export http_proxy=\"http://proxy.server.com:port\" # export ftp_proxy=\"http://proxy.server.com:port\" 在镜像列表中，选择一个附近镜像站。通常HTTP镜像站就足够了，但其他网络协议是可用的。请访问releases/amd64/autobuilds/ 。 那里将显示所有可用stage文件 （可能他们个别小组架构在命名的子目录中存储）。选择一个，然后按 d 下载。\nstage 文件下载完成后，可以验证 stage tarball 的完整性并验证其内容。\n对验证stage文件不感兴趣的用户可以通过按 q 来关闭命令行浏览器，并且可以直接移步到 解压stage压缩包 部分。\n验证\n附注：一些 tarballs 是通过XZ压缩的。在下载以 .tar.xz 结尾的 tarball 时，请确保在下面的命令中调整tarball文件名的 .tar.bz2 。\n与最小安装CD一样，可以使用额外的下载来验证stage文件。 虽然这些步骤可以被跳过，但这些文件是为那些关心他们刚刚下载的文件合法性的用户提供的。\n A .CONTENTS 文件包含stage压缩包内的所有文件的列表。 A .DIGESTS 文件，其中包含用不同的算法校验的stage文件。 A .DIGESTS.asc 像.DIGESTS文件一样, 包含不同的stage文件的校验和，但也加密签名，以确保它是由Gentoo项目提供的。  使用 openssl 并比较,提供的校验输出与.DIGESTS或者.DIGESTS.asc 文件的内容是否一致。\n比如，要验证SHA512校验值：\n# openssl dgst -r -sha512 stage3-amd64--.tar.?(bz2|xz) 使用sha512sum命令的另外一种方式：\n# sha512sum stage3-amd64--.tar.?(bz2|xz) 要验证Whirlpool校验值：\n# openssl dgst -r -whirlpool stage3-amd64--.tar.?(bz2|xz) 该值需要匹配，否则下载的文件可能已损坏（或摘要文件）。比较这些命令的输出与.DIGESTS(.asc)中的值。该值需要匹配，否则下载的文件可能已损坏（或digests文件）。\n就像在ISO文件中，它也可以来验证加密签名的.DIGESTS.asc。使用 gpg 以确保DIGESTS.asc文件校验和未被篡改:\n# gpg --verify stage3-amd64--.tar.?(bz2|xz){.DIGESTS.asc,} 解压stage压缩包 现在，解压下载的stage到系统。我们使用 tar来进行：\n# tar xpvf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner 确保你使用了同样的参数 ( xpf 和 --xattrs-include='*.*')。 x表示解开（Extract），v表示详细信息（Verbose）可以用来查看解压缩时发生了什么（可选参数）， p 表示保留权限（Preserve permissions），还有f 表示我们要解开一个文件，而不是标准输入。最后，--numeric-owner 被用于确保从tarball中提取的文件的用户和组ID与Gentoo发布工程团队预期的保持一致，即使大胆的用户使用的不是Gentoo官方安装媒介。\n现在stage文件已经解压好了，下面我们继续配置编译选项。\n配置编译选项 介绍 为了优化Gentoo，可以设置一些影响Portage的变量，Gentoo官方支持包管理器。 所有这些变量可以设置为环境变量（使用export），但这不是永久的。 为了保留设置，Portage读入/etc/portage/make.conf文件 ，一个用于Portage的配置文件，它有一个预配置好的模板文件在 /usr/share/portage/config/make.globals ，而 make.conf 下的配置会覆盖该模板下对应变量。\n附注：所有可能的变量的注释列表可以在 /mnt/gentoo/usr/share/portage/config/make.conf.example中找到。要成功安装Gentoo，只需要设置下面提到的变量。\n启动编辑器（在本指南中，我们使用 nano）来更改我们将在下面讨论的优化变量。\n# nano -w /mnt/gentoo/etc/portage/make.conf 从make.conf.example文件中可以明显看出文件的结构：注释行以 #开头，其他行使用 VARIABLE=\"value\" 语法定义变量。 接下来选取其中的几个进行讨论。\nCFLAGS 和 CXXFLAGS CFLAGS 和 CXXFLAGS 变量分别定义了GCC C和C ++编译器的优化标志。 尽管这些标志一般在这里默认被定义过，但为了性能最大化，需要分别优化每个程序的这些配置。 原因是因为每个程序都不同。 但是，这是不可管理的，因此这些标志在 make.conf 文件中定义。\n应该在make.conf中定义优化标志，这将使系统的响应速度最快。 不要在此变量中放置实验性的设置; 太多的优化可能会使程序表现不佳（崩溃，甚至更糟，故障）。\n我们不会解释所有可能的优化选项。 要了解它们，请阅读GNU在线手册或gcc信息页面 (info gcc-只适用于可用的Linux系统)。make.conf.example 文件本身也包含了很多例子和信息; 不要忘了读它。\n第一个设置是标志 -march= 和 -mtune= ，指定目标体系结构的名称。 可能用到的选项在make.conf.example文件中有描述（作为注释）。 一个常用的值是“native”，它告诉编译器选择当前系统体系结构（用户正在安装Gentoo时的系统）。(如果你知道自己处理器的代号，就用自己的处理器代号替换这里的native 比如我的是skylake，如果不确定就使用native。一个得到处理器代号的简单办法：使用 CPU-Z 检测）。\n第二个是标志 -O（即大写的字母O，而不是数字零），它指定了gcc优化级别标志。 可能用到级别的是s（对于大小最优化），0（零 - 无优化），1,2或甚至3等更多的优化选项（每个级别具有与前面相同的标志，加上一些额外选项）。 -O2是建议的默认值。 -O3在整个系统范围内使用时会导致问题，因此我们建议您坚持使用-O2。\n另一个普遍使用的优化标记是-pipe（不同编译阶段通信使用管道而不是临时文件）。它对产生的代码没有任何影响，但是会使用更多的内存。在内存不多的系统里，gcc可能会被杀掉。如果是那样的话，就不要用这个标记。\n使用 -fomit-frame-pointer（它将不在寄存器里为不需要帧指针的函数保存帧指针）可能会在调试程序的时候造成严重后果！\n在你定义 CFLAGS和CXXFLAGS的时候，你需要把这些优化标记都合并起来。stage3文件里包含的你解压缩出来的默认值已经足够好了。下面这个例子仅仅是个例子：\n# Compiler flags to set for all languages COMMON_FLAGS=\"-march=native -O2 -pipe\" # Use the same settings for both variables CFLAGS=\"${COMMON_FLAGS}\" CXXFLAGS=\"${COMMON_FLAGS}\" Tip：通过GCC 优化指导这篇文章获取有更多的信息，比如这些优化变量如何影响你的系统，Safe CFLAGS也许是对初学者开始优化系统更实用的一篇文章\nMAKEOPTS 通过使用MAKEOPTS 你可以定义在安装软件的时候同时可以产生并行编译的数目。官方推荐取「内存大小/2G」（free -h）与「CPU 线程数」（nproc）中的较小者。\n警告：使用大量job会显着影响内存消耗。良好的建议是为指定的每项工作至少有2 GiB的RAM（例如，-j6需要至少12个GiB）。要避免内存不足，请降低作业数量以适应可用内存。\n提示：使用并行emerges （--jobs）时，运行的有效作业数量可以呈指数增长（最高使工作数乘以emerge作业数）。通过运行仅限localhost-only distcc配置，可以根据仅限于每个主机的编译器实例的数量来解决此问题。\nMAKEOPTS=\"-j5\" 如果变量未进行设置，那么 portage 会根据当前 CPU 的线程数自动赋予一个值，该自动值等于当前 CPU 线程数。\nmake.conf template # These settings were set by the catalyst build script that automatically # built this stage. # Please consult /usr/share/portage/config/make.conf.example for a more # detailed example. COMMON_FLAGS=\"-march=skylake -O2 -pipe\" CFLAGS=\"${COMMON_FLAGS}\" CXXFLAGS=\"${COMMON_FLAGS}\" FCFLAGS=\"${COMMON_FLAGS}\" FFLAGS=\"${COMMON_FLAGS}\" CHOST=\"x86_64-pc-linux-gnu\" #直接填写即可 CPU_FLAGS_X86=\"aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3\" # CPU指令集，按照自己CPU的实际情况填写，后文会提到 MAKEOPTS=\"-j8\" # 同时编译的线程数 # NOTE: This stage was built with the bindist Use flag enabled PORTDIR=\"/var/db/repos/gentoo\" DISTDIR=\"/var/cache/distfiles\" PKGDIR=\"/var/cache/binpkgs\" # This sets the language of build output to English. # Please keep this setting intact when reporting bugs. LC_MESSAGES=C # Emerge Default Option EMERGE_DEFAULT_OPTS=\"--keep-going --with-bdeps=y --quiet --ask --verbose\" # emerge的默认选项 AUTO_CLEAN=\"yes\" #每次安装完包之后自动清理 # Accept ACCEPT_KEYWORDS=\"~amd64\" # 如果你更喜欢稳定而非最新那这里用amd64 ACCEPT_LICENSE=\"*\" # 接受所有许可证的软件 # Lang L10N=\"en-US zh-CN en zh\" # 语言设置照抄即可 # Harkware VIDEO_CARDS=\"intel i965 nvidia\" # intel集成显卡和nvidia显卡（不使用novueau） ALSA_CARDS=\"hda_intel\" # intel声卡 INPUT_DEVICES=\"libinput synaptics\" # 输入设备 非笔记本去除后面的synaptics #Grub GRUB_PLATFORMS=\"efi-64\" # 设置GRUB版本 照抄即可 # Ccache # FEATURES=\"parallel-fetch ccache\" # 使用ccache来大大提高重新编译时的速度，等后面安装并设置ccache之后取消注释 # CCACHE_DIR=\"/var/cache/ccache\" # ccache使用的目录 # Aria2 # 使用aria2提高下载速度（不设置也无大碍，设置的话一定要注意指令拼写正确） FETCHCOMMAND=\"/usr/bin/aria2c -d \\${DISTDIR} -o \\${FILE} --allow-overwrite=true --max-tries=5 --max-file-not-found=2 --max-concurrent-downloads=5 --connect-timeout=5 --timeout=5 --split=5 --min-split-size=2M --lowest-speed-limit=20K --max-connection-per-server=9 --uri-selector=feedback \\${URI}\" RESUMECOMMAND=\"${FETCHCOMMAND}\" # USE # USE变量是Gentoo最有威力的变量 也是Gentoo吸引我的原因之一 FUCKDE=\"-gnome -gnome-shell -gnome-keyring -nautilus -kde\" # 不打算安装gnome和kde及其相关组件 FUCKSV=\"-bindist -mdev elogind -dhcpcd -oss -grub -plymouth -systemd -consolekit\" # 不使用systemd plymouth consolekit 只使用elogind（旧教程会使用consolekit，事实上elogind是consolekit未来的替代品） SOFTWARE=\"sudo -icu client git chromium openmp minizip udev blkid efi hwdb smack acpi ccache dbus policykit udisks\" # 需要用到的特性 照抄即可 AUDIO=\"alsa jack pulseaudio\" # 对于音频相关软件使用pulseaudio alsa jack特性 NET=\"network networkmanager connection-sharing wifi http2\" # 网络相关 照抄即可 VIDEO=\"X vulkan layers glamor nvidia gallium\" # 图形相关 照抄即可 ELSE=\"cjk emoji\" # 照抄 USE=\"${FUCKDE}${FUCKSV}${SOFTWARE}${AUDIO}${NET}${VIDEO}${ELSE}\" # 定义需要的USE变量 # Mirrors GENTOO_MIRRORS=\"https://mirrors.bfsu.edu.cn/gentoo\" # 设置镜像站为北外镜像站（清华镜像站的影分身，压力小，速度快） # Proxy http_proxy=\"http://127.0.0.1:8889\" # emerge时用到的代理 需要代理时候自行设置 勿照抄 下同 https_proxy=\"http://127.0.0.1:8889\"   make.conf\n  CHOST\n  CPU_FLAGS_X86\n  AUTO_CLEAN: man make.conf wrote\nAUTOCLEAN = [\"yes\" | \"no\"] Automatically cleans the system by removing outdated packages which will not remove functionalities or prevent your system from working. On major ABI changes this may need to be set to off to ensure that the system can be rebuilt using the new libs before the old ones are removed. Downgrading with this option turned off may result in missing symlinks and an inoperable system. Defaults to yes.   ALSA_CARDS:\nALSA_CARDS is used by sys-firmware/alsa-firmware and media-sound/alsa-tools (result of eix -U ALSA_CARDS).\nIf you have an intel hda(according to your lspci output), you don’t need to bother with ALSA_CARDS, because that card doesn’t require anything special. If you still want to set it for the sake of completeness, use ALSA_CARDS=“hda-intel”.\n  INPUT_DEVICES\n  就位，预备，出发 ！ 根据你的喜好更新并保存/mnt/gentoo/etc/portage/make.conf（nano用户可以敲 Ctrl+X）。\n让我们继续 安装Gentoo 基本系统.\n安装Gentoo基础系统 Chrooting 可选：选择镜像站点 分发文件\n为了能更快的下载源代码，这里推荐选择一个快的镜像。Portage 将会在make.conf文件中查找GENTOO_MIRRORS变量，并使用其中所列的镜像。可以通过浏览 Gentoo 镜像列表搜索一个（或一组）最接近系统物理位置（往往那是最快的）的镜像。另外，我们提供一个叫作mirrorselect的好工具，它为用户选择所需镜像提供了一个很好的交换。只需要移动光标选择镜像并按Spacebar选择一个或多个镜像。\n# mirrorselect -i -o  /mnt/gentoo/etc/portage/make.conf 如果因为连接国外网络不畅的原因，导致获取列表失败，这时候也可以直接手动指定一个镜像：\necho 'GENTOO_MIRRORS=\"https://mirrors.tuna.tsinghua.edu.cn/gentoo\"'  /mnt/gentoo/etc/portage/make.conf 官方 ebuild 软件仓库\n选择镜像的第二个重要步骤是通过/etc/portage/repos.conf/gentoo.conf文件来配置 Gentoo的 ebuild 软件仓库。这个文件包含了更新 Portage 数据库（包含 Portage 需要下载和安装软件包所需要的信息的一个 ebuild 和相关文件的集合）所需要的同步信息。\n通过几个简单的步骤就可以完成软件仓库的配置。首先，如果它不存在，则创建repos.conf目录：\n# mkdir --parents /mnt/gentoo/etc/portage/repos.conf 接下来，复制 Portage 提供的 Gentoo 仓库配置文件到这个（新创建的）目录：\n# cp /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf 使用一个文件编辑器或通过使用 cat 命令来看一眼。文件里的内容应该是.ini格式并且看起来像是这样：\n# cat /mnt/gentoo/etc/portage/repos.conf/gentoo.conf [DEFAULT] main-repo = gentoo [gentoo] location = /var/db/repos/gentoo sync-type = rsync sync-uri = rsync://rsync.gentoo.org/gentoo-portage auto-sync = yes sync-rsync-verify-jobs = 1 sync-rsync-verify-metamanifest = yes sync-rsync-verify-max-age = 24 sync-openpgp-key-path = /usr/share/openpgp-keys/gentoo-release.asc sync-openpgp-key-refresh-retry-count = 40 sync-openpgp-key-refresh-retry-overall-timeout = 1200 sync-openpgp-key-refresh-retry-delay-exp-base = 2 sync-openpgp-key-refresh-retry-delay-max = 60 sync-openpgp-key-refresh-retry-delay-mult = 4 上面列出的默认的sync-uri变量值将决定一个基于轮询的镜像位置。这将缓解Gentoo基础设施上带宽的压力并能提供一个由于特定镜像离线的故障安全。除非使用本地私有Portage镜像，否则建议保留默认URI。\nTip：对那些有兴趣的话，可以在Portage项目的同步主题中找到关于Portage的同步API插件的官方规范。\n自定义 ebuild 软件仓库\n同步方式：\n rsync 方式可以使用命令校验本地改动，但本地同步时速度较慢；镜像站同步上游频率正常 git 方式可以使用命令结合人工介入判断以校验本地改动，本地同步时速度快；官方镜像点与原始仓库同步最及时，但国内镜像站同步上游频率低  目前推荐使用 git 方式。为了使得更新更迅速，建议自定义一个靠近自己的镜像站点。方法为先创建一个自定义配置文件 /etc/portage/repos.conf/gentoo.conf ，后根据同步类型进行操作：\n  自定义 rsync 方式同步配置\n[gentoo] location = /var/db/repos/gentoo auto-sync = yes sync-type = rsync sync-uri = rsync://mirrors.bfsu.edu.cn/gentoo-portage # 国内我这里建议可以使用北外的镜像站，其负载小，带宽大，更新迅速。 # 其它国内的镜像站我所知的还有： # TUNA： rsync://mirrors.tuna.tsinghua.edu.cn/gentoo-portage # 163： rsync://mirrors.163.com/gentoo-portage # 中科大： rsync://rsync.mirrors.ustc.edu.cn/gentoo-portage/ Gentoo Linux 官方有一份较为完整的 rsync 镜像列表 。\n  自定义 git 方式同步配置\n[gentoo] location = /var/db/repos/gentoo auto-sync = yes sync-type = git sync-depth = 1 sync-uri = https://mirrors.bfsu.edu.cn/git/gentoo-portage.git # 国内我找到的 git 方式同步镜像只有北外和 TUNA 两家 # TUNA 的地址： https://mirrors.tuna.tsinghua.edu.cn/git/gentoo-portage.git # 但它们的同步上游的频率都很低（截至发文时确认为 11 小时一次） # 所以若使用 git 方式同步，在网络流畅的情况，个人更建议直接同步官方镜像： # https://github.com/gentoo-mirror/gentoo.git sync-git-verify-commit-signature = yes # 设置校验最上层 commit 的签名，默认是不校验的 之后执行：\nemerge -vj dev-vcs/git # 以安装 git 工具，它并不是系统自带的 rm -rf /var/db/repos/gentoo # 删除原有的不支持 git 方式的数据库 emerge --sync # 初始化同步一次数据库   如果你比较疑惑为何在 mirrorselect 时添加了一个镜像地址，此时又添加了，那么在此说明：\n安装 Gentoo Linux 时往 /etc/portage/make.conf 写入的镜像地址，是 distfiles 镜像地址，用于下载安装软件时的软件本体（源代码或者二进制包），也包括了很多其它内容，比如 Portage 数据库的快照（但此快照不适用于日常更新）。\n而此时配置的镜像是用于同步 Portage 系统的数据库，其包含了基础的系统配置文件，安装软件所需的描述文件等等很多基础内容。\n复制DNS信息 在进行新环境之前，还有一件要做的事情就是复制/etc/resolv.conf中的DNS信息。需要完成这个来确保即使进入到新环境后网络仍然可以使用。/etc/resolv.conf包含着当前网络中的DNS服务器。\n要复制这个信息，建议通过cp命令的 --dereference 选项。这可以保障如果/etc/resolv.conf是一个符号链接的话，复制的是那个目标文件而不是这个符号文件自己。否则在新环境中，符号文件将指向一个不存在的文件（因为链接目标非常可能不会在新环境中）。\n# cp --dereference /etc/resolv.conf /mnt/gentoo/etc/ 或者\n# echo 'nameserver 114.114.114.114'  /mnt/gentoo/etc/resolv.conf 挂载必要的文件系统 稍等片刻，Linux 的根目录将变更到新的位置。为了确保新环境正常工作，需要确保一些文件系统可以正常使用。\n需要提供的文件系统是：\n /proc/ 一个pseudo文件系统（看起来像是常规文件，事实上却是实时生成的），由Linux内核暴露的一些环境信息 /sys/ 一个pseudo文件系统，像要被取代的/proc/一样，比/proc/更加有结构 /dev/ 是一个包含全部设备文件的常规文件系统，一部分由Linux设备管理器（通常是udev）管理  /proc/位置将要挂载到/mnt/gentoo/proc/，而其它的两个都是绑定挂载。字面上的意思是，例如/mnt/gentoo/sys/事实上就是/sys/（它只是同一个文件系统的第二个条目点），而/mnt/gentoo/proc/是（可以说是）文件系统的一个新的挂载。\n# mount --types proc /proc /mnt/gentoo/proc # mount --rbind /sys /mnt/gentoo/sys # mount --make-rslave /mnt/gentoo/sys # mount --rbind /dev /mnt/gentoo/dev # mount --make-rslave /mnt/gentoo/dev # mount --bind /run /mnt/gentoo/run # mount --make-slave /mnt/gentoo/run 附注：--make-rslave操作是稍后安装systemd支持时所需要的。\n警告：当使用非Gentoo安装媒介时，比如 Ubuntu，这时可能还不算完。一些发行版将/dev/shm符号链接到/run/shm/，在chroot后将变得不可用。为了让/dev/shm/是一个正常挂载的tmpfs，可以这样修复：\n# test -L /dev/shm \u0026\u0026 rm /dev/shm \u0026\u0026 mkdir /dev/shm # mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm 同时确保设置了权限为1777：\n# chmod 1777 /dev/shm 进入新环境 现在所有的分区已经初始化，并且基础环境已经安装，是时候进入到新的安装环境了。这意思着会话将把根目录（能访问到最顶层的位置）从当前的安装环境（安装CD或其他安装媒介）变为安装系统（叫做初始化分区）。因此叫作 change root 或 chroot。\n完成chroot有三个步骤：\n 使用 chroot 将根目录的位置从 /（在安装媒介里）更改成 /mnt/gentoo/ （在分区里） 使用 source 命令将一些设置（那些在 /etc/profile 中的）重新载入到内存中 更改主提示符来帮助我们记住当前会话在一个 chroot 环境里面。  # chroot /mnt/gentoo /bin/bash # source /etc/profile # export PS1=\"(chroot) ${PS1}\" 从现在开始，所有的动作将立即在新Gentoo Linux环境里生效。当然这离完成还很远，因为安装还剩下很多章节 ！\nTip：如果安装Gentoo时在这一步之后的任何地方中断，那么“应该”可以从这一步“继续”安装。不必再重新给磁盘分区！只需要[挂载 root 分区](#挂载 root 分区) 并运行上述步骤，然后通过复制 DNS 信息 重新进入工作环境。 这也对修复引导程序问题很有用。 更多的信息可以在 chroot 这篇文章中找到。\n挂载 boot 分区 现在已经进入新的环境，必须创建并挂载 boot 分区。 当编译内核并安装引导加载程序时，这将非常重要：\n# mount /dev/sda1 /boot 可以挂载到 /boot/efi/ 分区\n# mkdir -p /boot/efi # mount /dev/sda1 /boot/efi/ 配置Portage 从网站安装 Gentoo ebuild 数据库快照 接下来，是安装 Gentoo ebuild 数据库。这个快照包含一组文件，包括通知 Portage 中有关可用软件的标题（用于安装），系统管理员可以选择哪些配置文件，软件包或 profile 特定新闻 (news) 项目等。\n建议那些使用限制性防火墙的用户使用 emerge-webrsync 命令（它使用 HTTP / FTP 协议下载快照）节省网络带宽。 没有网络或带宽限制的读者可以愉快地跳到下一节。\n这将从Gentoo的一个镜像中获取最新的快照（每天发布）并将其安装到系统上：\n# emerge-webrsync 附注：在这个操作中，emerge-webrsync可能会报找不到 /var/db/repos/gentoo/ 位置。这是预期内的并且不用担心——这个工具将会创建这个位置。\n从现在开始，Portage 可能会提示建议运行某些更新。这是因为在安装了一个新的repository 快照后，Portage 发现了 stage 文件中已经安装的某些软件包有更新的版本。现在可以安全的忽略包的更新；可以延迟到 Gentoo 安装完成之后更新。\n可选：更新Portage ebuild 数据库 注：如果不配置代理的话，这个真的非常慢，非常耗时。\nGentoo 数据库可以更新到最新版本。前面的emerge-webrsync命令将安装一个最近的快照（通常是24小时以内），所以这一步是可选的。\n假设需要最新更新的软件包（1小时以内），可以使用emerge –sync。这个命令将使用rsync协议来更新 Gentoo ebuild 数据库（之前通过emerge-webrsync获得的）到最新状态。\n# emerge --sync 在慢速的终端上，比如一些framebuffer或者串口控制台，建议使用--quiet选项来加速这个进程：\n# emerge --sync --quiet 阅读新闻条目 当同步Portage ebuild 数据库时，Portage 可能会输出类似于下面的信息：\n* IMPORTANT: 2 news items need reading for repository 'gentoo'. * Use eselect news to read news items. 创建新闻条目是为了提供一个通信媒介，通过 Gentoo ebuild 数据库来给用户推送重要的消息。可以使用 eselect news 管理新闻条目。eselect 应用程序是一个Gentoo 特有的应用程序，它允许使用通用管理接口来管理系统。在这里，要用到 eselect 的 news 模块。\n对于news模块，最常用的有三个操作：\n 使用list显示一个可用新闻条目的预览。 使用read来阅读新闻条目。 使用purge将在新闻条目阅读后删除，并且不能再次阅读。  # eselect news list # eselect news read # eselect news read --quiet 可以通过新闻阅读器手册页查看更多关于新闻阅读器的信息：\n# man news.eselect 选择正确的配置文件 配置文件是任何一个Gentoo系统的积木。它不仅指定USE、CFLAGS和其它重要变量的默认值，还会锁定系统的包版本范围。这些设定全是由Gentoo的Portage开发者们来维护。\n使用eselect，你能看到当前系统正在使用什么配置文件，现在来使用profile模块：\n# eselect profile list ... [1] default/linux/amd64/17.1 (stable) [2] default/linux/amd64/17.1/selinux (stable) [3] default/linux/amd64/17.1/hardened (stable) [4] default/linux/amd64/17.1/hardened/selinux (stable) [5] default/linux/amd64/17.1/desktop (stable) [6] default/linux/amd64/17.1/desktop/gnome (stable) [7] default/linux/amd64/17.1/desktop/gnome/systemd (stable) [8] default/linux/amd64/17.1/desktop/plasma (stable) [9] default/linux/amd64/17.1/desktop/plasma/systemd (stable) ... 附注：命令的这个输出只是一个示例，并会随时间演变。\n可以看到，一些架构还会有桌面的子配置文件。\nWarning：升级 profile 不能掉以轻心。 选择初始 profile 时，请确保使用与最初使用的 stage3 “相同的版本”（例如 17.1 ）。 每个新的 profile 版本都通过新闻项目公布，新闻项目中包含了迁移说明。 在切换到较新的 profile 之前，请务必阅读并遵循这些内容。\n在看完框架的可用配置文件amd64之后，用户可以键入以下命令为系统选择一个不同的配置文件，比如选择 plasma/systemd：\n# eselect profile set 9 No-multilib\n若要选择没有 32 位应用和类库的纯 64 位环境，请使用一个 no-multilib 的配置文件：\n# eselect profile list Available profile symlink targets: [1] default/linux/amd64/17.1 * [2] default/linux/default/linux/amd64/17.1/desktop [3] default/linux/default/linux/amd64/17.1/desktop/gnome [4] default/linux/default/linux/amd64/17.1/desktop/kde [5] default/linux/default/linux/amd64/17.1/no-multilib 接下来选择no-multilib配置文件：\n# eselect profile set 5 # eselect profile list Available profile symlink targets: [1] default/linux/default/linux/amd64/17.1 [2] default/linux/default/linux/amd64/17.1/desktop [3] default/linux/default/linux/amd64/17.1/desktop/gnome [4] default/linux/default/linux/amd64/17.1/desktop/kde [5] default/linux/default/linux/amd64/17.1/no-multilib * 附注：developer 子配置文件是专用于Gentoo Linux开发，也就是说不是用于普通用户。\n推荐：安装二进制包 对于虚拟机或其他情况，可以选择是否安装二进制包而不是自己从源码开始编译。\n二进制包的提供是目前 Gentoo 的一种实验性质的方案，它的存在能显著缩短整体安装时间，降低机器负载，但目前对二进制包是不存在文件校验的，所以使用它有些许潜在风险。同时，使用二进制包表示将不会对本机有编译优化。（其它的也有可能导致一些需要编译的包出现编译问题）\n另外，如果本地一些包的 [USE标记](# USE标记) 有变动或者一些包的依赖有了变动，那么对于该包， Portage 目前默认会回退到自行编译安装的状态（也推荐这样），在尽可能安装二进制包的同时，也完全不影响正常的使用。\n如果你决定启用这个尚处于实验状态的方案，那么需创建一个文件：\n$ cat  /etc/portage/binrepos.conf [binhost] priority = 9999 sync-uri = https://mirrors.tuna.tsinghua.edu.cn/gentoo/experimental/amd64/binpkg/default/linux/17.1/x86-64/ sync-uri 可以配置成任意所选镜像地址\n再编辑 /etc/portage/make.conf 文件，设置：\nEMERGE_DEFAULT_OPTS=\"--binpkg-changed-deps=y --binpkg-respect-use=y --getbinpkg=y\" 最终，我的配置为：\n# echo 'EMERGE_DEFAULT_OPTS=\"--binpkg-changed-deps=y --binpkg-respect-use=y --getbinpkg=y --autounmask --autounmask-keep-masks --autounmask-write=n --keep-going -v -a\"'  /etc/portage/make.conf 配置USE变量 USE是Gentoo为用户提供的最具威力的变量之一。很多程序通过它可以选择编译或者不编译某些可选的支持。例如，一些程序可以在编译时加入对 GTK+或是对Qt的支持。其它的程序可以在编译时加入或不加入对于SLL的支持。有些程序甚至可以在编译时加入对framebuffer的支持（svgalib）以取代X11（X服务器）。\n大多数的发行版会使用尽可能多的支持特性编译它们的软件包，这既增加了软件的大小也减慢了启动时间，而这些还没有算上可能会涉及到的大量依赖性问题。Gentoo可以让你自己定义软件编译的选项，而这正是USE要做的事。\n在USE变量里你可以定义关键字，它被用来对应相应的编译选项。例如，ssl将会把SSL支持编译到程序中以支持它。-X会移除其对于X服务器的支持（注意前面的减号）。gnome gtk -kde -qt4 -qt5将会以支持GNOME（和GTK+）但不支持KDE（和Qt）的方式编译软件，使系统为GNOME做完全调整（如果架构支持）。\n默认的USE设置全放在了系统所使用的Gentoo配置文件的make.defaults文件中。Gentoo对它的配置文件们使用了一个（复杂的）继承系统，在这个阶段我们不去深入。最简单的检查当前活动的USE标记的办法是运行emerge –info并选择以USE开头的那一行：\n# emerge --info | grep ^USE USE=\"X acl alsa amd64 berkdb bindist bzip2 cli cracklib crypt cxx dri ...\" 附注：上面的示例被截断了，实际上的USE列表值是非常非常多的。\n可以在系统的 /var/db/repos/gentoo/profiles/use.desc 中找到可用的USE标记的完整描述。\n# less /var/db/repos/gentoo/profiles/use.desc 在less命令中，可以通过使用↑和↓键来滚动，并且可以按q退出。\n作为示例，我们展示一个支持DVD、ALSA,以及CD录制的基于KDE系统的USE设置：\n# nano -w /etc/portage/make.conf USE=\"-gtk -gnome qt5 kde dvd alsa cdr\" 当USE在/etc/portage/make.conf中定义，会从那个默认列表中添加（或者移除，如果USE标记以-号开头的话）。用户想忽略所有默认的USE设置并完全由自己管理的话，应该在make.conf中定义USE以-*开头：\nUSE=\"-* X acl alsa \" 警告：由于仔细选择 USE 标志默认值可能会对某些软件包防止冲突和其它错误，所以尽管可以设置 -*（如上例所示），但不鼓励这样做。\n推荐： 配置 ACCEPT_LICENSE 变量 Gentoo 对所有的软件包都使用包所属的许可证进行标记。这允许用户在安装软件之前根据特定的许可证或许可证组来选择软件。\nImportant：ebuild 中 的 LICENSE 变量仅是为 Gentoo 开发人员和用户准备的一份指南。它既不是法律声明，也不保证其真实性。因此不要过度依赖它，您需要深入检查软件包的本身，以及您使用的所有文件。\nPortage 使用 ACCEPT_LICENSE 变量决定那些包允许对之前接受的许可证不提示用户。同样，也可以在 /etc/portage/package.license 中每个包中设置例外。\n在 Gentoo 仓库中定义的许可证组，由 Gentoo Licenses project 项目管理，有：\n   Group Name Description     @GPL-COMPATIBLE GPL compatible licenses approved by the Free Software Foundation   @FSF-APPROVED Free software licenses approved by the FSF (includes @GPL-COMPATIBLE)   @OSI-APPROVED Licenses approved by the Open Source Initiative   @MISC-FREE Misc licenses that are probably free software, i.e. follow the Free Software Definition but are not approved by either FSF or OSI   @FREE-SOFTWARE Combines @FSF-APPROVED, @OSI-APPROVED and @MISC-FREE   @FSF-APPROVED-OTHER FSF-approved licenses for “free documentation” and “works of practical use besides software and documentation” (including fonts)   @MISC-FREE-DOCS Misc licenses for free documents and other works (including fonts) that follow the free definition but are NOT listed in @FSF-APPROVED-OTHER   @FREE-DOCUMENTS Combines @FSF-APPROVED-OTHER and @MISC-FREE-DOCS   @FREE Metaset of all licenses with the freedom to use, share, modify and share modifications. Combines @FREE-SOFTWARE and @FREE-DOCUMENTS   @BINARY-REDISTRIBUTABLE Licenses that at least permit free redistribution of the software in binary form. Includes @FREE   @EULA License agreements that try to take away your rights. These are more restrictive than “all-rights-reserved” or require explicit approval    Gentoo 在配置文件中提供了有预定义的值，默认接受由自由软件基金会明确批准的许可，开源项目或者遵循自由软件定义，例如：\n# portageq envvar ACCEPT_LICENSE @FREE 可以通过更改 /etc/portage/make.conf 来自定义整个系统，使之接受所有许可：\n# echo 'ACCEPT_LICENSE=\"*\"'  /etc/portage/make.conf 还可以根据需要添加每个软件包的覆盖：\n# nano -w /etc/portage/package.license/kernel app-arch/unrar unRAR sys-kernel/linux-firmware @BINARY-REDISTRIBUTABLE sys-firmware/intel-microcode intel-ucode 更新@world集合 程序的原子指的是由完整类别组成的名称，没有版本和其他的限定符号比如说 net-vpn/openvpn。什么时候会用到原子呢？比如说你要引用一个基于SQLite的数据库 dev-python/axiom 但是这个是和sci-mathematics/axiom 是一个软件包名字这个时候原子就派上用场了。\n可以将多个原子分为一组，从而可以针对整个组来进行操作（比如说重建某个组）。对于这个组有个名字：集合，集合以@作为前缀，其中一些是在Portage里由预先定义的比如说 @system集合包括主要的系统软件包。像是我们安装一个软件包（原子）这个就会记录在 /var/lib/portage/world中 (@world集合包含了@system集合，如果有需要还可以自己定义集合)。将 world 文件复制到其它运行 Gentoo 的电脑上，就可以还原原机器上安装的软件和环境。\n明智的做法是更新系统的 @world set ，以便可以构建系统。\n当系统应用了任何升级，或从 任何profile 构建了stage3 后，应用了变化的 use 标记时，下一步是“必要”的。\n# emerge --ask --verbose --update --deep --newuse @world Tip：如果选择了桌面环境配置文件，则此过程可能大大增加安装过程所需的时间量。 时间紧迫的人可以通过这个“经验法则”工作： 配置文件名称越短，系统的特定属性越少，@world设置的特定性越低，系统将需要的软件包越少。 换一种说法：\n 选择 default/linux/amd64/17.1 将只有很少的包被重装或更新 选择 default/linux/amd64/17.1/desktop/gnome/systemd 将需要安装许多软件包，因为init系统要更改为systemd，并且将安装GNOME桌面环境框架。  可选：使用 OpenRC 作为 init 系统 **本文的后续部分专注于 Systemd 作为默认的 init 系统。**如果读者要安装 GNOME 3.8 及之后版本则必须使用 Systemd。如果需要使用 OpenRC （传统的 Gentoo init 系统），可以阅读官方文档。\n时区 为系统选择时区。在/usr/share/zoneinfo/中查找可用的时区。\n# ls /usr/share/zoneinfo 假设选择的时区是 Asia/Shanghai，生成一个符号链接：\n# ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime 稍后，当系统运行时，我们可以使用timedatectl命令配置时区和相关设置。\n配置 locale Locale 生成 大多数用户只想在他们的系统上使用一或两个地区。对于 root 用户而言，一般使用默认的配置即可。但这里需要添加上自己所需其它语言设置以供普通用户使用。\nLocale 不只是指定用户应该使用与系统进行交互的语言，同时也指定了字符串排序，日期和时间的显示等规则。Locale 是 “区分大小写” 的，必须完全按照描述的方式表示。完整的 locale 可用列表可以在 /usr/share/i18n/SUPPORTED 文件中找到。\n系统支持的 locale 必须在 /etc/locale.gen 文件中定义。\n# _[@可选的变体].  下面的地区是一个示例，展示了同时使用英语（美国）和汉语（中国）及附加字符格式（如UTF-8）。\n# cat  /etc/locale.gen en_US.UTF-8 UTF-8 zh_CN.UTF-8 UTF-8 警告：我们\"强烈\"建议添加至少一个UTF-8格式的地区设置，因为许多应用程序也许需要这样才能正确构建。\n下一步是运行 locale-gen 命令。此命令会生成 /etc/locale.gen 文件中所有指定的地区。\n# locale-gen 要验证当前所选择的 locale 可用，可以运行 locale -a。\nLocale 选择 等完成后，我们就来设定系统级别的 locale 设置。我们又一次使用 eselect 来做这件事，现在使用 locale 模块。\n通过 eselect locale list 可显示可用的目标：\n# eselect locale list Available targets for the LANG variable: [1] C [2] C.utf8 [3] POSIX [4] en_US.utf8 [5] zh_CN.utf8 [6] C.UTF8 * [ ] (free form) 可以使用 eselect locale set  选择正确的 locale：\n# eselect locale set 4 这个还可以通过手动编辑 /etc/env.d/02locale 文件来完成：\nLANG=\"zh_CN.UTF-8\" LC_COLLATE=\"C\" 设定 locale 可以避免在后面安装中，内核和软件汇编时的警告和错误。\n现在重新加载环境：\n# env-update \u0026\u0026 source /etc/profile \u0026\u0026 export PS1=\"(chroot) ${PS1}\" 完整的本地化指南提供了有关 locale 选择过程的其他指导。另一个有意思的文章是为系统启用 UTF-8 的具体信息的 UTF-8 指南。\n配置Linux内核 安装源码 Linux内核是所有发行版的核心。它位于用户程序和系统硬件之间。Gentoo提供给用户一些可选的内核源码。完整的带描述的列表在内核概述页面。\nGentoo Linux 所提供的可用内核源码包都在 sys-kernel 类下。而其中以下两个个版本更通用：\n  sys-kernel/gentoo-sources\n这是最高到内核主线版本的内核源码包，需要自行配置后，再自行编译后安装\n  sys-kernel/gentoo-kernel\n这是最高到内核主线版本的内核源码包，但同时包含了通用的内核配置，可自动编译后安装\n  针对基于amd64 系统的Gentoo，建议使用包sys-kernel/gentoo-sources。\n选择一个合适的内核并使用emerge来安装它。\n# emerge --ask sys-kernel/gentoo-sources 这将在/usr/src/中安装Linux内核源码。如果在选择的内核源代码包上没有启用USE=symlink，它将不会自己创建一个符号链接。\n通常需要维护/usr/src/linux符号链接，这样它就指向与当前运行的内核相对应的源代码。但是，默认情况下不会创建这个符号链接。创建符号链接的一个简单方法是利用eselect的内核模块。\n关于符号链接的目的以及如何管理它的更多信息，请参阅 Kernel/Upgrade。\n首先，列出所有已安装的内核:\n# eselect kernel list Available kernel symlink targets: [1] linux-4.9.16-gentoo 要创建一个名为linux的符号链接，请使用:\n# eselect kernel set 1 # ls -l /usr/src/linux lrwxrwxrwx 1 root root 12 Oct 13 11:04 /usr/src/linux - linux-4.9.16-gentoo 现在是时候来配置和编译内核源代码了。有两种方法：\n 手动配置并生成内核。 一个叫作genkernel的工具用来自动化生成并安装Linux内核。  我们在这里解释做为默认选择的手动配置，它是优化环境的最好方式。\n默认：手动配置 介绍 手动配置内核经常被Linux用户认为是最困难的步骤。事实并非如此——但是当您手动配置几次内核之后，你就不会再觉得它有多么难了：）\n无论如何，有一件事是真实的：当手动配置内核时，了解（硬件）系统是至关重要的。大多数信息可以通过安装包含lspci命令的sys-apps/pciutils来收集：\n# emerge --ask sys-apps/pciutils 附注：在chroot中，可以安全的忽略任何lspci可能抛出的关于pcilib的警告（比如pcilib: cannot open /sys/bus/pci/devices）。\n另一个系统信息来源是运行lsmod来查看安装CD使用什么内核模块，它可能对启用什么提供了一个好的暗示。\n现在进入内核源码目录并执行make menuconfig。这将启动一个菜单驱动的配置屏幕。\n# cd /usr/src/linux # make menuconfig Linux内核配置有很多很多的章节。我们先列出一些必须激活的选项（否则Gentoo将无法工作，或者离开附加的调整将无法正常工作）。我们同时在Gentoo维基上有一个Gentoo内核配置指南可能会在将来有帮助。\n激活必要的选项 如果您使用的是 sys-kernel/gentoo-sources，我们强烈建议您启用Gentoo的配置选项。这些确保可以使用适当的功能所需的最低内核功能：\nGentoo Linux --- Generic Driver Options --- [*] Gentoo Linux support [*] Linux dynamic and persistent device naming (userspace devfs) support [*] Select options required by Portage features Support for init systems, system and service managers --- [*] OpenRC, runit and other script based systems and managers [*] systemd 当然，您在最后两行中的选择取决于您的Init系统（OpenRC与Systemd）的选择。\n如果您使用的是 sys-kernel/vanilla-sources, ，您必须自己找到所需的选项。\n确保引导系统的每一个至关重要的驱动（比如SCSI控制器,等等）是编译进内核而不是作为一个模块，否则系统将无法完全引导。\n接下来选择最正确的CPU类型。同时建议启用MCE功能（如果可用）能在硬件出现问题时通知用户。在一些架构（比如x86_64），这些错误不会打印到 dmesg，但是会到/dev/mcelog。这需要app-admin/mcelog包。\n同时选择Maintain a devtmpfs file system to mount at /dev来让重要的设备文件在引导过程的早期就已就绪(CONFIG_DEVTMPFS and CONFIG_DEVTMPFS_MOUNT):\nDevice Drivers --- Generic Driver Options --- [*] Maintain a devtmpfs filesystem to mount at /dev [*] Automount devtmpfs at /dev, after the kernel mounted the rootfs 验证 SCSI 磁盘支持是否已激活(CONFIG_BLK_DEV_SD):\nDevice Drivers --- SCSI device support ---  SCSI disk support 现在进入File Systems并选择你使用的文件系统。不要作为模块来编译根文件系统所使用的文件系统，否则Gentoo系统将不能挂载这个分区。同时选择Virtual memory和*/proc file system*根据系统的需要选择一个或多个以下选项(CONFIG_EXT2_FS, CONFIG_EXT3_FS, CONFIG_EXT4_FS, CONFIG_MSDOS_FS, CONFIG_VFAT_FS, CONFIG_PROC_FS, and CONFIG_TMPFS):\nFile systems ---  Second extended fs support  The Extended 3 (ext3) filesystem  The Extended 4 (ext4) filesystem  Reiserfs support  JFS filesystem support  XFS filesystem support  Btrfs filesystem support DOS/FAT/NT Filesystems ---  MSDOS fs support  VFAT (Windows-95) fs support Pseudo Filesystems --- [*] /proc file system support [*] Tmpfs virtual memory file system support (former shm fs) 如果使用PPPoE连接到互联网，或者是拨号调制解调器，则启用下面的选项(CONFIG_PPP, CONFIG_PPP_ASYNC, and CONFIG_PPP_SYNC_TTY)：\nDevice Drivers --- Network device support ---  PPP (point-to-point protocol) support  PPP support for async serial ports  PPP support for sync tty ports 这两个压缩选项将是无害的，但是它们一定是不需要的，包括基于以太网的PPP选项也是一样，只有在配置内核模式PPPoE时才会需要。\n不要忘记在内核中包括网（以太网或无线）卡。\n大多数系统会有多核心处理，所以激活“Symmetric multi-processing support”是重要的' (CONFIG_SMP)：\nProcessor type and features --- [*] Symmetric multi-processing support 附注：在多核心系统中，每一个核心计作一个处理器。\n如果使用USB输入设备（比如键盘和鼠标）或其他USB设备，不要忘记启用那些(CONFIG_HID_GENERIC and CONFIG_USB_HID, CONFIG_USB_SUPPORT, CONFIG_USB_XHCI_HCD, CONFIG_USB_EHCI_HCD, CONFIG_USB_OHCI_HCD):：\nDevice Drivers --- HID support --- -*- HID bus support  Generic HID driver [*] Battery level reporting for HID devices USB HID support ---  USB HID transport layer [*] USB support ---  xHCI HCD (USB 3.0) support  EHCI HCD (USB 2.0) support  OHCI HCD (USB 1.1) support 架构特有的内核配置 如果要支持32位程序，请确保选择IA32 Emulation(CONFIG_IA32_EMULATION)。Gentoo 默认会安装一个multilib 系统（混合 32 位/ 64 位计算），所以除非使用了一个 no-multilib 配置文件，否则这个选项是必需的。\nProcessor type and features --- [ ] Machine Check / overheating reporting [ ] Intel MCE Features [ ] AMD MCE Features Processor family (AMD-Opteron/Athlon64) --- ( ) Opteron/Athlon64/Hammer/K8 ( ) Intel P4 / older Netburst based Xeon ( ) Core 2/newer Xeon ( ) Intel Atom ( ) Generic-x86-64 Executable file formats / Emulations --- [*] IA32 Emulation 如果在分区时使用GPT分区标签，则启用对它的支持 (CONFIG_PARTITION_ADVANCED and CONFIG_EFI_PARTITION)：\n-*- Enable the block layer --- Partition Types --- [*] Advanced partition selection [*] EFI GUID Partition support 如果使用UEFI来引导系统，则在内核中启用EFI桩支持和EFI变量 (CONFIG_EFI, CONFIG_EFI_STUB, CONFIG_EFI_MIXED, and CONFIG_EFI_VARS)：\nProcessor type and features --- [*] EFI runtime service support [*] EFI stub support [*] EFI mixed-mode support Firmware Drivers --- EFI (Extensible Firmware Interface) Support ---  EFI Variable Support via sysfs 编译和安装 当配置完成，是时间来编译和安装内核了。退出配置并开始编译过程：\n# make \u0026\u0026 make modules_install 附注：还可以启用并行生成使用make -jX，X是一个生成过程中所允许运行的并行任务的整数。这类似于早期有关/etc/portage/make.conf的中关于MAKEOPTS变量的介绍。\n当内核完成编译，复制内核镜像到/boot/。这由make install命令来处理：\n# make install 这将复制内核镜像到/boot/，一起的还有System.map文件和内核配置文件。\n可选：生成一个initramfs 在某些情况中需要建立一个initramfs (initial ram file system) ——一个基于内存的初始化文件系统，它用于解决如何在真正初始化系统运行前执行用户空间程序。类似的方案还有一种叫 initrd ，两者功能基本一致，实现方式有差异。\n它代表着一种方案，也代表着一个文件。它在一些基础情况下并不是必须的。\n在说明它存在的意义前，先简单说明下 Linux 系统的基本启动流程：\n PC 加电，BIOS/UEFI 自检后载入系统引导程序 引导程序载入内核 内核挂载根目录所对应的分区 内核执行根目录下系统的初始化（init）命令 自此来到了用户空间下  这个基本的流程里面会出现问题，看步骤 3\n 问题一、如果这个根目录的分区无法直接挂载怎么办（被加密了、使用了 RAID、它是一个 NFS，等情况） 问题二、如果这个根目录的分区下的 /usr 又单独分区了，里面没所需文件怎么办（这个文件夹包含了系统的库文件等）  如果上述两种情况都未出现，那么只要把根目录分区所对应的文件系统驱动被编译进内核（而非模块的形式），就可以省略掉 initramfs ；如果出现了任意一种情况，这个时候就需要 initramfs 的参与。\n正如前文所说， initramfs 提供了在真正系统初始化前提前进入用户空间的功能，它其实就是一个简略版的完整系统，通过它，可以把该解密的分区解密，该挂载的内核无法直接挂载的分区（包括模块未加载，额外的分区，需要联网等情况）都挂载好，之后再由根目录下真正的系统初始化程序接管。\n如果没有initramfs的，存在着巨大的风险，系统将无法正常开机，因为这是负责安装的文件系统工具需要驻留在这些文件系统的信息。 initramfs中的一个将在必要的文件拉进它的内核启动之后使用的档案，但控制被移交前转移到初始化工具。在initramfs的脚本，然后将确保分区正确地安装在系统继续启动之前。\nGentoo Linux 提供了一个工具叫 sys-kernel/genkernel 可用于创建 initramfs，其配置文件位于 /etc/genkernel.conf ，里面对每个变量的设置都有详细的说明。 有别于其它的 initramfs 创建工具， genkernel 会单独编译一个独立的 initramfs 环境（而非直接使用当前系统环境），并打包压缩。这会使得其相对于其它的工具（比如 dracut）创建过程更慢。\n# emerge --ask sys-kernel/genkernel # genkernel --install --kernel-config=/path/to/used/kernel.config initramfs 为了在initramfs中启用特定的支持，比如LVM或RAID，要为genkernel添加一个合适的选项。查看genkernel –help以获得更多信息。在下面的示例中，我们启用LVM和软件RAID (mdadm) 的支持：\n# genkernel --lvm --mdadm --install --kernel-config=/path/to/used/kernel.config initramfs initramfs将存储在/boot/。结果文件可以简单的通过列出以initramfs开头的文件来找到：\n# ls /boot/initramfs* 现在继续到内核模块。\n备选：localmodconfig 内核是否真的需要自定义配置？这个问题因人而异，有人想要一份精简的内核，有人只要功能完善即可。我个人建议则是，非嵌入式环境下，对内核体积没要求情况下量力而行即可。内核的配置系统太过庞与复杂，理解所有的配置很难。而纯粹使用通用的配置则会导致模块目录太大，无用的模块太多，也不妥。\nmake localmodconfig 生成了一份完整的内核配置文件。此命令的含义是，以当前系统环境为参考，禁用没有被加载的模块配置。可在纯模块加载的系统环境下，接上你有的设备，开启你需要用到的所有服务，然后执行它。一般用于首次配置内核，使得后续配置更轻松。\n而进一步的配置可以在内核目录下使用 make menuconfig 命令打开一个界面化的配置菜单，根据界面内提示进行。也可以执行 make help 显示帮助信息，以方便根据需要自行选择。\n自定义配置时，建议给该配置文件设定一个自定义版本，以便于区分，配置路径位于:\nGeneral setup --- (-examplename) Local version - append to kernel release 其它的项目本文不会说明，建议查阅 官方内核配置文档 ，其它可查阅的资料有：\n 在界面化的配置菜单界面，选中选项按下 h 后显示的说明 查询硬件设备对应驱动的 Linux-Hardware 站点（英文）： https://linux-hardware.org/index.php?view=search cateee.net 的 Linux 内核驱动数据库（英文）： https://cateee.net/lkddb/web-lkddb/ 金步国针对旧版本内核的配置说明（中文）： http://www.jinbuguo.com/kernel/longterm-linux-kernel-options.html  备选：使用genkernel 如果手动配置看起来太恐怖，建议使用genkernel。它将自动配置并编译内核。\ngenkernel配置内核的工作原理几乎和安装CD配置的内核完全一致。也就是说当使用genkernel建立内核，系统通常将在引导时检测全部硬件，就像安装CD所做的。因为genkernel不需要任何手动内核配置，它对于那些不能轻松的编译他们自动内核的用户来说是一个理想的解决方案。\n现在，我们来看看如何使用genkernel。首先emerge sys-kernel/genkernel这个ebuild：\n# emerge --ask sys-kernel/genkernel 接下来，编辑/etc/fstab文件来使包含有第二个值为/boot/的那条的第一个值指向到正确的设备。如果是按照本手册的分区示例，则这个设备非常像使用ext4文件系统的/dev/sda1。这将使文件中的这一条目看起来像是：\n# nano -w /etc/fstab /dev/sda1\t/boot\text4\tdefaults\t0 2 附注：在Gentoo将来的安装中，还要再配置一次/etc/fstab。现在只需要正确设置/boot来让genkernel应用程序读到相应的配置。\n现在，运行genkernel all来编译内核源码。值得注意的是，使用genkernel编译一个内核将支持几乎全部的硬件，这将使编译过程需要一阵子来完成！\n附注：如果引导分区不是使用ext4作为文件系统，它可能需要使用genkernel –menuconfig all来手动配置内核，并在内核中添加对这个具体文件系统的支持（比如：不是作为一个模块）。LVM2用户可能要作为参数来添加--lvm。\n# genkernel all 一旦genkernel完成，将创建一个内核、全部的模块和初始化内存文件（initramfs）。我们将在文档后面配置引导器的时候使用这个内核和initrd。记下内核和initrd名字作为编辑引导器配置文件的信息。initrd将在后执行硬件检测之后、“真实”系统启动之前立即启动。\n# ls /boot/kernel* /boot/initramfs* 推荐：二进制 因为内核的配置非常复杂，需根据每台机器的环境而定，为了简单与节约时间，可以选择预编译好的，适用范围最广的二进制内核。\n# emerge --ask sys-kernel/gentoo-kernel-bin sys-kernel/gentoo-kernel-bin 是最高到内核主线版本的内核二进制包，其使用的是最通用的内核配置。\n内核模块 配置模块 附注：硬件模块手动列出是可选的。在大多数情况下，udev通常将加载所有被检测为已连接的硬件模块。然而，列出自动检测到的模块是没有什么不良影响的。有时，一些奇特硬件需要帮助来加载其驱动程序。\n在 /etc/modules-load.d/.conf 中各个模块的每一行列出需要自动加载的模块。如果有必要的话，可以在 /etc/modprobe.d/.conf 文件中，为模块设置添加附加选项。\n要查看所有可用模块，运行下面的find命令。不要忘记替换“”为刚刚编译的内核版本：\n# find /lib/modules// -type f -iname '*.o' -or -iname '*.ko' | less 比如，要自动加载3c59x.ko模块（3Com网卡家族的特定驱动），编辑/etc/modules-load.d/network.conf文件并在里面输入模块名字。实际的文件名对 loader 来说无关紧要。\n# mkdir -p /etc/modules-load.d # nano -w /etc/modules-load.d/network.conf 继续到配置系统来安装。\n推荐：安装固件 一些驱动需要先在系统上安装附加的固件才能工作。经常网络接口上会使用，特别是无线网络接口。此外，来自 AMD 、 NVidia 和 Intel 等供应商的现代视频芯片在使用开源驱动程序时，通常也需要外部固件文件。大多数固件都打包在 sys-kernel/linux-firmware 里：\n# emerge --ask sys-kernel/linux-firmware 配置系统 文件系统信息 关于 fstab 在Linux系统下，系统所用到的所有分区都必须在 /etc/fstab文件中指明。这个文件包含了这些分区的挂载点（在系统目录树中的位置）、挂载方法和特殊挂载选项（是否自动挂载，是否某个用户可以挂载它等）。\n创建/etc/fstab文件 /etc/fstab文件使用一种特殊语法格式。每行都包含六个字段。这些字段之间由空白键（空格键，tab键，或者两者混合使用）分隔。每个字段都有自己的含意：\n 第一个字段显示要挂载的特殊 block 设备或远程文件系统。 有几种设备标识符可用于特殊块设备节点，包括设备文件路径，文件系统标签，UUID以及分区标签。 第二个字段是分区挂载点，也就是分区应该挂载到的地方 第三个字段给出分区所用的文件系统 第四个字段给出的是挂载分区时mount命令所用的挂载选项。由于每个文件系统都有自己的挂载选项，我们建议你阅读mount手册（man mount）以获得所有挂载选项的列表。多个挂载选项之间是用逗号分隔的。 第五个字段是给dump使用的，用以决定这个分区是否需要dump。一般情况下，你可以把该字段设为0（零）。 第六个字段是给fsck使用的，用以决定系统非正常关机之后文件系统的检查顺序。根文件系统应该为1，而其它的应该为2（如果不需要文件系统自检的话可以设为0）。  重要：Gentoo 默认提供的 /etc/fstab 不是有效的fstab 文件，它只是提供了几个模板。\n# nano -w /etc/fstab 在文本的其余部分，我们使用默认的块设备 /dev/sd* 文件作为分区。\n分区表和UUIDs\nMBR（BIOS）和GPT都支持“文件系统”标签和“文件系统”的UUID。 这些属性可以在尝试查找和挂载块设备时使用，作为 mount 命令的替代方法，在 /etc/fstab 中定义。文件系统标签和 UUID 由 LABEL 和 UUID 前缀标识，可以使用 blkid 命令查看：\n# blkid 警告：如果分区中的文件系统被擦除，则文件系统标签和UUID值将随后被更改或删除。\n出于唯一性，建议使用 MBR 分区表的读者使用UUID来定义/etc/fstab 中的可挂载卷。\n分区卷标和 UUIDs\n已经使用 GPT 磁盘的用户有一些更稳定的选项可用于在 /etc/fstab 中定义分区。分区卷标和分区 UUID 可以用来标识块设备的单独分区，而不管为分区本身选择了什么文件系统。分区卷标和 UUID 分别由 PARTLABEL 和 PARTUUID 前缀标识，可以通过运行 blkid 命令在终端中很好地查看分区标签：\n# blkid 虽然对于分区表不总是正确的，但使用UUID来标识fstab 中的分区，即使将来文件系统更改，也可以保证在寻找某个卷时引导加载程序不会被混淆。对于经常重新启动并定期添加和删除SATA设备时，在 fstab 中定义分区，使用旧的默认分区文件 (/dev/sd*N非常危险) 。\n块设备文件的命名取决于许多因素，包括磁盘如何以及以什么顺序加载到系统。它们也可能以不同的顺序显示，具体情况取决于在早期启动过程中内核首先检测到哪些设备。 有了这个说明，除非有人打算不断地解决磁盘排序问题，使用默认块设备文件是一个简单和直接的方法。\n让我们来看看如何写下/boot/分区的选项。 这只是一个示例，应根据安装时的具体情况进行修改。 在amd64分区示例中， /boot/ 通常是/dev/sda1 ext4作为文件系统。 它需要在启动期间进行检查，所以我们写下：\n/dev/sda1 /boot ext4 defaults 0 2 有些用户不希望/boot/分区自动挂载，以提高系统的安全性。 他们应该用noauto.代替 defaults。这意味着这些用户将需要在每次他们想要使用它时手动挂载这个分区。\n增加符合你分区方案的规则，为你的光驱（当然，如果你有其他分区或者驱动器，也为它们加上）添加挂载规则。\n下面是/etc/fstab文件的例子（for MBR）：\n/dev/sda1 /boot ext4 defaults,noatime 0 2 /dev/sda2 none swap sw 0 0 /dev/sda3 / ext4 noatime 0 1 /dev/cdrom /mnt/cdrom auto noauto,user 0 0 auto选项可以使mount 猜测文件系统（推荐对于可移动设备采用这个选项，因为它们可能采用很多不同的文件系统），而 user选项使得非root用户可以挂载光驱。\n为了提高性能，大多数用户想要添加 noatime mount选项，这将拥有更快的系统，因为访问时间没有注册（一般不需要这些）。 这也推荐用于固态硬盘（SSD）用户，他们还应该启用discard 安装选项（现在只支持ext4和btrfs），这使得 TRIM命令有效。\n下面是/etc/fstab文件的例子（for GPT）\n# EFI 分区 UUID=\"XXXX-XXXX\" /boot vfat rw,noatime,errors=remount-ro 0 2 # 交换分区 UUID=\"XXXXXXXX-...XXXX\" none swap sw 0 0 # 根分区 UUID=\"XXXXXXXX-...XXXX\" / ext4 defaults,noatime 0 1 仔细检查/etc/fstab文件，保存并退出以继续。\n推荐：genfstab # emerge -av genfstab # genfstab -U /  /etc/fstab 网络信息 主机名 要设置主机名称，创建/编辑 /etc/hostname ，然后直接输入所需的主机名。\n# echo 'SAKAMOTO'  /etc/hostname 当使用 systemd 引导时，存在一个名为hostnamectl的工具，用于编辑/etc/hostname和/etc/machine-info：\n# hostnamectl set-hostname  参考 man hostnamectl 来获得更多选项。\n配置网络 在Gentoo Linux安装时，网络已经配置。然而，这是安装的安装光盘本身的配置，并不是新的系统环境的网络配置。现在你所要设置的是Gentoo系统的永久网络配置。\n附注：更多关于网络配置的详细信息，包括网卡绑定、网桥、802.1Q VLANs和无线网络在内的高级配置会在Gentoo网络配置这一部分介绍。\n使用 systemd-networkd systemd-networkd 在有线网络接口的简单配置上是很有用的。它在默认情况下是禁用的。\n要配置systemd-networkd，在/etc/systemd/network路径下创建一个文件。network请参考systemd.network(5)， 一个简单的DHCP配置如下:\n# nano -w /etc/systemd/network/50-dhcp.network [Match] Name=en* [Network] DHCP=yes 在启动时自动启用网络连接\n# systemctl enable systemd-networkd.service # systemctl start systemd-networkd.service 注意systemd-networkd 默认不会自动更新 resolv.conf ，要 systemd 管理 DNS 设置，替换 resolv.conf 为一个符号连接并启动 systemd-resolved。\n# ln -snf /run/systemd/resolve/resolv.conf /etc/resolv.conf # systemctl enable systemd-resolved.service # systemctl start systemd-resolved.service 推荐：使用 NetworkManager # emerge --ask net-misc/networkmanager # systemctl enable NetworkManager 使用 nmtui 设置：在 IPv4 CONFIGURATION 设置 DNS-servers 为 114.114.114.114，并开启 Ignore automatically obtained DNS parameters。因为它会把路由器ip（192.168.0.1）放在/etc/resolv.conf 第一个，导致ping不通。\nThe hosts file Next inform Linux about the network environment. This is defined in /etc/hosts and helps in resolving host names to IP addresses for hosts that aren’t resolved by the nameserver.\n# This defines the current system and must be set 127.0.0.1 tux.homenetwork tux localhost # Optional definition of extra systems on the network 192.168.0.5 jenny.homenetwork jenny 192.168.0.6 benny.homenetwork benny Save and exit the editor to continue.\nRoot 密码 使用passwd命令设置root密码。\n# passwd root帐户是一个功能强大的帐户，因此请选择一个强密码。 稍后将为日常操作创建其他常规用户帐户。\nReset lost root password\n Append the init=/bin/bash kernel parameter to your boot loader’s boot entry. Your root file system is mounted as read-only now, so remount it as read/write: mount -n -o remount,rw /. Use the passwd command to create a new password for the root user. Reboot by typing reboot -f and do not lose your password again!  Read-only file system\n# mount -o remount,rw / 安装系统工具 系统日志工具 因为有一些工具提供给用户的功能比较类似，它们就没有包含在stage3当中。现在就是你选择安装哪一个的时候了。\n你首先需要决定的就是系统日志工具。Unix和Linux在日志记录功能方面有良好的传统——如果你愿意的话你可以把系统发生的所有事件都记录到日志文件中。这些功能就是通过系统日志工具来完成的。\nsystemd 提供了自己的日志记录工具，名字叫“ journal”。在运行systemd的系统上，可以选择性的地安装单独的 syslog 程序，并且可能需要进行其他配置才能使syslog 守护进程从日志中读取消息。\nGentoo提供了多种系统日志工具可供选择。包括：\n app-admin/sysklogd -提供传统的系统日志记录守护程序。默认日志配置容易学习，这个包是初学者的好选择。 app-admin/syslog-ng -高级系统记录器。 需要额外配置很多东西， 更高级的用户可以根据它的日志潜力选择这个包; 注意额外的配置是任何种类的智能日志记录的必要条件。 app-admin/metalog -一个可以灵活配置的系统日志工具。  Portage内或许还有其他的系统日志工具——我们的可用软件包数量是以天为单位在增加的。\nTip：如果你打算使用sysklogd或者syslog-ng你很可能会随后希望安装并且配置 logrotate ，因为这些系统日志工具并没有提供系统日志文件的滚动功能。\n可选：Cron守护进程 接下来你可以选择cron守护进程。尽管这是可选的并且不是系统所必须的，但是最好能够安装一个。\ncron守护程序执行计划中的命令。 如果某些命令需要定期执行（例如每天，每周或每月），这是非常方便的。\nGentoo提供了几个可选的cron守护进程： sys-process/bcron, sys-process/dcron, sys-process/fcron, and sys-process/cronie。安装这其中一个的方法和安装一个系统日志工具的方法类似。下面的例子使用sys-process/cronie。\n# emerge --ask sys-process/cronie # systemctl enable cronie 如果使用 dcron，则需要执行额外的初始化命令：\n# crontab /etc/crontab 如果使用 fcron，则需要额外的 emerge 步骤：\n# emerge --config sys-process/fcron 可选：文件索引 如果你想索引你的系统文件使得你能够使用locate工具很快定位它们，你需要安装sys-apps/mlocate。\n# emerge --ask sys-apps/mlocate 可选：远程访问 为了能够在安装后远程访问系统，必须将sshd配置为在启动时启动。\n$ systemctl enable sshd 如果需要串行控制台访问(这在远程服务器的情况下是可能的)，则必须配置agetty。\n$ systemctl enable getty@tty1.service 文件系统工具 根据你所使用的文件系统的不同，你需要安装必须的文件系统工具（用于检查文件系统完整性、创建额外的文件系统等）。请注意管理ext2，ext3和ext4文件系统的工具 (sys-fs/e2fsprogs)已经做为系统的一部分被安装了。\n以下的表格列出了特定文件系统所需要安装的工具。\n   Filesystem Package     Ext 4 sys-fs/e2fsprogs   XFS sys-fs/xfsprogs   ReiserFS sys-fs/reiserfsprogs   JFS sys-fs/jfsutils   VFAT (FAT32, …) sys-fs/dosfstools   Btrfs sys-fs/btrfs-progs   ZFS sys-fs/zfs    Tip：获取更多关于Gentoo上文件系统的信息请看filesystem article。\n网络工具 如果不需要任何其它网络工具，请立即继续 配置引导程序。\n安装DHCP客户端 重要：虽然可选，但大多数用户会发现他们需要一个DHCP客户端，用来连接到他们网络上的DHCP服务器。 请借此机会安装DHCP客户端。如果忘记此步骤，则系统可能无法访问网络，从而使之后无法下载DHCP客户端。\n为了使系统能够使用netifrc脚本自动获取一个或多个IP地址，需要安装DHCP客户端。 我们建议使用net-misc/dhcpcd，虽然许多其他DHCP客户端可通过Gentoo数据库下载：\n# emerge --ask net-misc/dhcpcd 关于 dhcpcd 的更多信息可以通过 dhcpcd 文章查询。\n可选：安装PPPoE客户端 如果你需要ppp来连接网络，你需要安装它 net-dialup/ppp 。\n# emerge --ask net-dialup/ppp 推荐：安装无线网络工具 如果系统将连接无线网络,请为开放网络或 WEP 网络安装 net-wireless/iw 包，为 WPA 或 WPA2 网络安装 net-wireless/wpa_supplicant 包。iw 也是一个有用的无线网络扫描的基本诊断工具\n# emerge --ask net-wireless/iw net-wireless/wpa_supplicant 现在继续配置引导启动程序。\n配置引导加载程序 选择引导器 完成配置Linux内核、安装系统工具和编辑配置文件之后，现在是时候去安装Linux安装的最后一个重要的部分：引导器。\n引导器负责在引导过程中启动内核——若没有引导器，系统将不知道按下电源键后将如何进行。\n针对amd64，我们编写了如果在基于BIOS的系统上配置GRUB2或LILO，以及针对UEFI系统的GRUB2或efibootmgr。\n在本手册的这一部分中，描述了 “emerging” 引导加载程序包和 “installing” 引导加载程序到系统磁盘之间的区别。 这里，术语 “emerging” 将用于请求 Portage 使软件包安装于系统。 术语 “installing” 将表示引导加载程序复制文件或物理地修改系统的磁盘驱动器的适当部分，以便在下一次开机时使引导加载程序“激活并准备好操作”。\n默认：GRUB2 默认情况下，Gentoo系统现在主要依赖于GRUB（在sys-boot/grub 包中），它是GRUB Legacy的继任者。无需额外配置，GRUB2就能支持旧的BIOS(“pc”) 系统。 在安装之前加上少量的配置，Grub2可以支持超过一半的平台。 有关详细信息，请参阅位于GRUB2的先决条件。\nEmerge 当使用只支持MBR分区表的旧版BIOS系统时，无需进行其他配置即可安装GRUB：\n# emerge --ask --verbose sys-boot/grub UEFI用户注意：运行上述命令将在出现之前输出启用的GRUB_PLATFORMS 值。 当使用支持UEFI的系统时，用户需要确保启用 GRUB_PLATFORMS=\"efi-64\" 参数（默认情况下是这样）。 如果设置不是这样，则需要在安装GRUB2之前将 GRUB_PLATFORMS=\"efi-64\"添加到/etc/portage/make.conf：\n# echo 'GRUB_PLATFORMS=\"efi-64\"'  /etc/portage/make.conf # emerge --ask sys-boot/grub 如果GRUB2在未先添加GRUB_PLATFORMS=\"efi-64\"到make.conf时就已经emerge过，可以添加这一行（像上面显示那样）然后通过--update --newuse options to emerge:选项来重新计算 world package set ：\n# emerge --ask --update --newuse --verbose sys-boot/grub GRUB2现在已经安装到系统中了，但是还没有激活。\n安装 接下来，通过grub-install命令安装GRUB2所需的文件到/boot/grub/目录。假设第一块磁盘（引导系统的那块）是/dev/sda，将使用下面的一条命令：\n使用BIOS时\n# grub-install /dev/sda 使用UEFI时\n重要：确保EFI系统分区在运行grub-install“之前”已经挂载。它可能会使grub-install安装的GRUB EFI文件（grubx64.efi（到一个错误的目录“并且不会”提供“任何”辨识使用错误目录的信息。\n# grub-install --target=x86_64-efi --efi-directory=/boot 附注：当/boot分区没有格式化成vfat时，必须修改 --efi-directory选项到EFI系统分区。如\n# grub-install --target=x86_64-efi --efi-directory=/boot/efi 重要：如果 grub_install 返回了一个错误，类似 Could not prepare Boot variable: Read-only file system，那么为了成功安装，可能必须需要将 efivars 重新挂载为读写：\n# mount -o remount,rw /sys/firmware/efi/efivars 一些主板制造商（包括虚拟机）似乎只支持EFI系统分区（ESP）中.EFI文件的 /efi/boot/目录。 GRUB安装程序可以使用 --removable选项自动执行此操作。 在运行以下命令之前验证是否已安装ESP。 假设ESP安装在/boot（如前所述），执行：\n# grub-install --target=x86_64-efi --efi-directory=/boot --removable 这将创建UEFI规范定义的默认目录，然后将 grubx64.efi 文件复制到由同一规范定义的“默认”EFI文件位置。\n配置 接下来，基于用户在/etc/default/grub文件和/etc/grub.d中特别配置的脚本文件来生成GRUB2。在大多数场景中，不需要由用户来配置，GRUB2就可以自动检测出哪个内核用于引导（位于/boot/中最高的那一个）以及根文件系统是什么。也可以使用GRUB_CMDLINE_LINUX 变量在/etc/default/grub中附加内核参数。\n要生成最终的GRUB2配置，运行grub-mkconfig命令：\n# grub-mkconfig -o /boot/grub/grub.cfg Generating grub.cfg ... Found linux image: /boot/vmlinuz-4.9.16-gentoo Found initrd image: /boot/initramfs-genkernel-amd64-4.9.16-gentoo done 需要注意至少找到一个Linux镜像在命令的输出中，它们是用来引导系统的。如果使用一个initramfs或用genkernel建立内核，同样会检测到正确的initrd 镜像。如果不是这样，进入到/boot/并使用ls命令检查内容。如果文件确实不存在，回到内核配置和安装的介绍。\nTip：os-prober实用程序可与GRUB2配合使用，以检测所连接驱动器上的其他操作系统。可检测到Windows 7, 8.1, 10,和其他Linux发行版。 那些希望双引导系统的应该出现sys-boot/os-prober包，然后重新运行 grub-mkconfig命令（如上所示）。 如果遇到问题，请务必先阅读GRUB2 文章，然后再向Gentoo社区请求支持。\n使用救急控制台 set 用来修改变量，insmod 用来载入模组以添加功能。\n如果 /boot 在单独分区上（例如在用 UEFI 的时候），适当地进行修改：\n注意： 因为 boot 是一个单独的分区而不是根分区的一部分，你得手动把它的地址写清楚，格式和前面的 prefix 一样。\nset root=(hd0,5) linux (hdX,Y)/vmlinuz-linux root=/dev/sda6 initrd (hdX,Y)/initramfs-linux.img boot 可选：启用休眠唤醒 如果之前有分配交换分区，在这里可以执行如下命令以启用其休眠后唤醒的功能\n# sed -Ei \"/GRUB_CMDLINE_LINUX_DEFAULT/s/^#*(GRUB.*DEFAULT=).*$/\\1\\\"resume=UUID=$(blkid -o value /dev/sdX4 | head -1)\\\"/\" /etc/default/grub 也可以手动修改，打开 /etc/default/grub 文件：\n 找到 GRUB_CMDLINE_LINUX_DEFAULT 变量 去掉其注释标记 (#) 在其双引号内添加上 resume=UUID=，　此 可由命令 blkid -o value /dev/sdX4 | head -1 显示  最后创建配置 ：\n# grub-mkconfig -o /boot/grub/grub.cfg 可选：多系统 如果电脑存在多系统，可以执行如下步骤添加其它系统的引导菜单选项：\n  给 grub 添加 mount 这个 USE 以满足 os-prober 的依赖\n# echo 'sys-boot/grub mount' /etc/portage/package.use/grub   安装 os-prober 工具\n# emerge -vj os-prober 如果你上面进行了启用休眠唤醒可选操作，更新了 grub 配置文件，那么安装完成后可能会有一个关于 Grub 的配置文件更新提示 IMPORTANT: config file '/etc/default/grub' needs updating. 这个暂时不用理会，也可「更新配置文件」\n  配置 grub 以启用 os-prober 功能\n# echo 'GRUB_DISABLE_OS_PROBER=false' /etc/default/grub   之后再次运行一次上述的 grub-mkconfig 命令，该命令会自动识别同一机器上其它的系统，并做成引导菜单选项：\n# grub-mkconfig -o /boot/grub/grub.cfg   备选1：LILO Emerge LILO (the LInuxLOader,) 是Linux引导程序的久经考验的主力。但是它缺少GRUB所拥有的一些特性。LILO仍旧在一些系统上被使用的原因是GRUB无法使用但LILO却可以。当然还因为一些人是先认识了LILO而且对它忠心不二。不管怎样，Gentoo可以支持它们两个启动器。\n安装LILO是一件轻而易举的事，使用emerge就可以了。\n# emerge --ask sys-boot/lilo 配置 要配置LILO，首先要创建 /etc/lilo.conf:\n# nano -w /etc/lilo.conf 在配置文件中，小节（sections）被用于指向可引导的内核。请确保内核文件（与内核版本号一起）和initramfs文件都可以被知晓，因为它们都需要被这个配置文件所引用。\nNote：如果根文件系统是JFS，请在每一个引导条目之后增加 append=\"ro\"因为JFS在它被挂载为可读写之前需要重放它的日志。\nboot=/dev/sda # Install LILO in the MBR prompt # Give the user the chance to select another section timeout=50 # Wait 5 (five) seconds before booting the default section default=gentoo # When the timeout has passed, boot the \"gentoo\" section compact # This drastically reduces load time and keeps the map file smaller; may fail on some systems image=/boot/vmlinuz-4.9.16-gentoo label=gentoo # Name we give to this section read-only # Start with a read-only root. Do not alter! root=/dev/sda3 # Location of the root filesystem image=/boot/vmlinuz-4.9.16-gentoo label=gentoo.rescue # Name we give to this section read-only # Start with a read-only root. Do not alter! root=/dev/sda3 # Location of the root filesystem append=\"init=/bin/bb\" # Launch the Gentoo static rescue shell # The next two lines are for dual booting with a Windows system. # In this example, Windows is hosted on /dev/sda6. other=/dev/sda6 label=windows 附注：如果您使用不同的分区方案或内核文件，请根据需要进行调整。\n如果initramfs是必须的，那么就更改配置文件以便引用这个initramfs文件，并且告诉initramfs根设备的所在位置。\nimage=/boot/vmlinuz-4.9.16-gentoo label=gentoo read-only append=\"root=/dev/sda3\" initrd=/boot/initramfs-genkernel-amd64-4.9.16-gentoo 如果额外的选项需要被传递到内核，使用append语句。例如增加 video 语句来使能framebuffer：\nimage=/boot/vmlinuz-4.9.16-gentoo label=gentoo read-only root=/dev/sda3 append=\"video=uvesafb:mtrr,ywrap,1024x768-32@85\" 使用 genkernel的用户应该了解他们的内核使用与安装CD相同的引导选项。例如，如果对SCSI设备的支持需要被使能，就增加 doscsi到内核选项中。\n现在保存这个文件并退出。\n安装 为了彻底完成，运行 /sbin/lilo，这样 LILO 就会把 /etc/lilo.conf 中的设置应用到系统中（也就是说安装它自己到磁盘上）。要记住每一次一个新内核被安装或者 lilo.conf 文件被改变后，/sbin/lilo 都需要执行一次，以确保在内核文件名发生改变后系统仍然能够被引导起来。\n# /sbin/lilo 备选2：efibootmgr 在基于UEFI的系统上，系统上的UEFI固件（换句话说，主引导加载程序）可以直接操作以查找UEFI引导条目。 这样的系统不需要具有额外的（也称为辅助）引导加载器，如GRUB2，以帮助引导系统。 据说，基于EFI的引导加载程序（如GRUB2）存在的原因是在引导过程中“扩展”UEFI系统的功能。 使用efibootmgr是真正的那些想要采取一个极简主义（虽然更僵硬的）方法来启动他们的系统; 使用GRUB2（见上文）对于大多数用户更容易，因为它在引导UEFI系统时提供了灵活的方法。\n记住sys-boot/efibootmgr应用程序不是一个引导器，它是一个和UEFI固件相互作用并更新它的设置，因为之前安装的Linux内核可以通过额外的选项（如果需要）来引导，或允许多重引导条目。可以通过EFI变量（需要支持EFI变量的内核）来完成这个相互作用。\n一定要阅读通过 EFI stub内核文章“‘再继续。 内核必须具有能够被系统的UEFI固件直接引导的特定选项。 可能需要重新编译内核。 看看**efibootmgr** 文章，这也是一个好主意。\n附注：要重申，efibootmgr 不是引导UEFI系统的要求。Linux内核本身就可以启动即引导，其他内核命令行选项可以内置到Linux内核（有一个内核配置选项）允许用户指定启动参数作为命令行选项，甚至initramfs 可以“内置”到内核。\n那些决定采取这种方法的人必须安装软件：\n# emerge --ask sys-boot/efibootmgr 接下来，创建 /boot/efi/boot/，并复制内核文件到这个位置，并叫作bootx64.efi：\n# mkdir -p /boot/efi/boot # cp /boot/vmlinuz-* /boot/efi/boot/bootx64.efi 接下来，告诉UEFI固件创建一个叫作“Gentoo”的引导条目，它拥有全新编译的EFI stub内核：\n# efibootmgr --create --disk /dev/sda --part 2 --label \"Gentoo\" --loader \"\\efi\\boot\\bootx64.efi\" 如果使用一个内存文件系统（initramfs），为它添加相应的引导选项：\n# efibootmgr -c -d /dev/sda -p 2 -L \"Gentoo\" -l \"\\efi\\boot\\bootx64.efi\" initrd='\\initramfs-genkernel-amd64-4.9.16-gentoo' 附注：UEFI定义强制要求使用\\作为目录分割符。\n完成这些变更后，当系统重新启动时，会有一个叫作“Gentoo”的引导条目。\n备选3: Syslinux Syslinux是 amd64架构的另一种引导加载程序替代方案。 它不仅支持MBR，从版本6.00开始，它开始支持EFI启动。 还支持PXE（网络）引导和鲜为人知的选项。 尽管Syslinux是许多流行的引导加载程序，但它并没有得到手册的支持。 读者可以在Syslinux文章中找到有关新兴然后安装此引导加载程序的信息。\n备选4：systemd-boot systemd-boot, formerly called gummiboot, is a simple UEFI boot manager capable of booting Linux and Windows in EFI mode.\nNote: As of systemd 220, systemd-boot has been included with systemd (accessible via the bootctl command). If sys-apps/systemd has been installed on the system, then sys-boot/systemd-boot does not need to be installed.\nUEFI boot manager The systemd-boot application makes the installation, which only needs to be performed once (unless a new version of systemd-boot needs to be installed), fairly simple. Verify the following:\n  The system is booted with EFI to start with (either from a EFI compatible media, or through any other UEFI boot manager) as it will otherwise fail to install.\n  The EFI variable file system (efivars) is mounted read/write:\n# mount -t efivarfs efivarfs /sys/firmware/efi/efivars   Then perform the install itself:\n# bootctl --path /boot/efi install The installation will install the proper EFI files so that the EFI-capable system will boot the systemd-boot bootloader.\n重启系统 退出chroot环境并unmount全部已持载分区。然后敲入一条有魔力的命令来初始化最终的、真实的测试：reboot。\n# exit # cd # umount -l /mnt/gentoo/dev{/shm,/pts,} # umount -R /mnt/gentoo # reboot 当然，别忘了移除可引导CD，否则可能再次从CD启动，而不是新的Gentoo系统。\n当重启进全新安装的Gentoo环境，继续完成结束Gentoo安装。\n收尾安装工作 用户管理 添加一个日常使用的用户 在Unix/Linux系统中，用root进行工作是一件危险的事情，应该尽量避免。因此我们强烈推荐您为日常使用添加一个普通用户。\n用户所属的组定义了其可以执行的活动。下表中列出了许多您可能希望使用的重要组：\n   Group Description     audio Be able to access the audio devices.   cdrom Be able to directly access optical devices.   floppy Be able to directly access floppy devices.   games Be able to play games.   portage Be able to access portage restricted resources.   usb Be able to access USB devices.   video Be able to access video capturing hardware and doing hardware acceleration.   wheel Be able to use su.    比如，创建一个叫作larry的wheel、users和audio组的成员用户，首先作为root登录（只有root能创建用户）并运行useradd：\nLogin: root Password: (输入root 密码) # useradd -m -G users,wheel,audio -s /bin/bash larry # passwd larry Password: (输入larry的密码) Re-enter password: (重复输入密码) 如果一个用户仍需要以root身份做一些任务，他们可以使用**su -**来临时得到root权限。另一种方式是使用sudo包，如果配置正确的话，非常安全。\nsudo sudo 使普通用户可以以超级权限执行命令\n# emerge app-admin/sudo 打开配置文件，找到 #%wheel 开头的几行设置，根据说明去掉所需配置行的注释符号\n# visudo 磁盘清理 删除tar包 当Gentoo安装完毕并且系统已经重启过，如果所有事情都完成好了，我们现在要从硬盘上删除下载的stage3的tar包。记住它们下载在/目录。\n# rm /stage3-*.tar.xz 下一步该做什么？ 文档 不知道接下来该做什么？现在有许多途径可以探索…Getoo 为用户提供了大量的可能性，因此也已经在 wiki 和其他与 Gentoo 相关的子域名上提供大量的文档（少量没有），可以通过这些文档来进行探索（参见下面的 [Gentoo 在线](#Gentoo 在线)章节）。\n读者一定要看一下 Gentoo 手册的下一章节使用 Gentoo，讲述了如何保障软件是最新的、如何安装额外的软件包、USE 标记的更多细节、OpenRC init 系统，以及与 Gentoo 系统安装后，管理相关的各种其他信息话题。\n除了这本手册，也鼓励读者去探索Gentoo维基的其他角落来寻找更多的、社区提供的文档。Gentoo wiki 组同时提供一个文档概述，其中按照类别列出了一系列的维基文档。比如，它指向的本地化指南能使系统更有家的感觉（特别适用于以英语为第二语言的用户）。\nGentoo 在线 重要：读者应注意，所有在线的 Gentoo 官方网站均受Gentoo的 行为准则约束。活跃于 Gentoo 社区是一种特权，而不是一种权利，用户应该知道行为准则的存在是有原因的。\n除了 Freenode 托管的因特网中继聊天（ internet relay chat IRC）网络和邮件列表之外，大多数Gentoo 网站要求每个站点都有一个帐户，以便提问、展开讨论或上报 Bug。\n论坛 和 IRC\n欢迎每个用户来我们的 Gentoo 论坛 或我们的 Gentoo 的 因特网中继聊天（ internet relay chat IRC）频道。有很多以前发现的新 Gentoo 安装遇到的问题，在获得一些反馈后得以解决，这些问题的经验可以在论坛中轻松地搜索查看。其他用户第一次使用 Gentoo 遇到安装问题的可能性非常令人惊讶。建议用户在 Gentoo 支持频道寻求帮助之前搜索论坛和 wiki。\n邮件列表\n这些是提供给社区成员的一些邮件列表，他们更愿意通过电子邮件请求支持或反馈，而不是在论坛或IRC上创建用户帐户。用户需要按照说明进行操作，以便订阅特定的邮件列表。\nBugs\n有时，在查看 wiki、搜索论坛、在IRC频道或邮件列表中寻求支持之后，并没有问题已知的解决方案。一般来说，这是在 Gentoo 的 Bugzilla 网站 上报告 bug 的信号。\n开发指南\n希望了解更多有关开发 Gentoo 的读者可以查看开发指南。该指南提供了有关编写 ebuild、使用 eclass 的说明，并提供了 Gentoo 开发中许多基本概念的定义。\n结语 Gentoo 是一个健壮、灵活、维护良好的发行版。开发者社区很高兴听到关于如何使Gentoo 成为一个“更好的”发行版的反馈。\n在此提醒，任何关于 “本手册”的反馈应该按照如何改进手册？章节中开头的详细准则。\n我们期待看到我们的用户将如何选择使用Gentoo！\nPortage介绍 欢迎使用 Portage Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具。\nPortage 是用 Python 和 Bash 两种语言编写的。因为它们都是脚本语言所以用户可以直接阅读它的代码。\n大多数用户通过 emerge 使用 Portage。本章的内容不是复述 emerge 的 man page。要了解 emerge 的所有可用选项，请查阅 emerge 的 man page（emerge 中文手册）：\n# man emerge Gentoo 软件仓库 查询 Portage 的信息\n# emerge --info Ebuild 当 Gentoo 的文档介绍某个软件包的时候，这意味着 Gentoo 的用户们可以在 Gentoo 的软件仓库里找到它。ebuild 是一种包含了所有 Portage 维护软件（比如安装，搜索，查询等等）所需信息的文件，而 Gentoo 的软件仓库是它们的一个集合。这些 ebuild 文件默认储存在 /var/db/repos/gentoo。\nPortage 对于软件的行为都是基于本地的 ebuild。为了能收到新的软件包，安全更新等等，时常更新本地 ebuild 是一件很重要的事情。\n更新 Gentoo 软件仓库 Gentoo 的软件仓库通常使用 rsync 进行同步，rsync 是一个快速的文件增量传输工具。要使用它很简单，Portage 的命令行前端 emerge 提供了一个调用 rsync 的方法：\n# emerge --sync 有时防火墙会干扰 rsync 与镜像的连接。这时，我们可以使用 emerge-webrsync 来自动下载和安装 Portage 树的快照版本：\n# emerge-webrsync 使用 emerge-webrsync 的另一个好处是可以只安装由 Gentoo release engineering 团队的 GPG 密钥签名过的快照。与此有关的详细信息可以在 fetching validated Gentoo repository snapshots 找到\n维护软件 搜索软件 有很多方法可以在 Gentoo 的软件仓库寻找软件。其中之一是使用 emerge 本身。在默认情况下 emerge –search 会返回所有符合搜索条件的包名。\n举个例子，找出所有名字里含有 “pdf” 的包：\n# emerge -s  # emerge --search pdf 如果要根据描述进行搜索，可以使用 --searchdesc （或 -S）选项:\n# emerge --searchdesc pdf 需要注意的是它会输出很多信息。不过由于都有很清楚的标识，我们就不再赘述它们的意思了。\n安装软件 当你找到了软件包的名字，安装它只需要简单得使用 emerge。举个例子，如果要安装 gnumeric：\n# emerge  # emerge --ask app-office/gnumeric 由于很多软件依赖其它的软件，在安装该软件的同时很可能还会安装它的一些以来。不要担心，Portage 可以很好地处理依赖关系。如果要知道 Portage 会安装什么软件，可以在命令中加入 -p/--pretend选项。举个例子：\n# emerge --pretend gnumeric 在安装软件期间，Portage将从Internet下载必要的源代码（如果需要），并将其默认存储在 /var/cache/distfiles/ 中。 之后，它将解压缩，编译和安装包。 要让Portage仅下载源代码而不安装软件，请添加-f/--fetchonly选项到emerge命令：\n# emerge --fetchonly gnumeric 恢复上一次失败的 emerge\n# emerge -r 其它常用的选项有\n  -1/--oneshot 一般用在安装软件包时，不将该包添加到 world 集中\n  -O/--nodeps 不计算依赖关系，只操作指定的包（安装时可能会因为依赖不满足而导致安装失败）\n  -j/--jobs 设置 Portage 同时执行的最大任务数，如果未设置数量，那么 Portage 不会限制最大的任务数。如果要将该选项添加到默认选项下，那么建议配合 -l/--load-average 使用， -l/--load-average 用于配置 emerge 的负载阈值，当当前负载到达设定值后， emerge 将不再开启新任务，以避免负载过高，这在 CPU 不够强悍或者内存不宽裕的机器上很需要。比如在一个 8 核 16 线程 16G 内存的机器上，可以设置成 -j -l 12 ，这样的设定使 portage 的并行任务数不由硬性规定的数目来限制，而是通过动态负载来进行限制。\n  --keep-going 它会在安装出错时，跳过安装失败的包，并重新计算依赖后继续安装剩余包\n  -n/--noreplace 不重复安装已经安装的包（默认会忽略掉 USE 的改动以及升级的查询，除非对应加上 -D/-U 和 -u 选项）\n  -t/--tree 显示给定包的安装依赖树\n  --autounmask 类\n这是一组在新装软件包时便于解除安装限制的选项。之前有介绍，在 Portage 安装软件的过程中，可能会因为 USE/License/Keywords 等因素导致无法直接安装，需要配置后再进行，而这组选项可以自动化这个过程。个人建议的相关选项组合为 --autounmask --autounmask-keep-masks --autounmask-write=n ，此组合不会完全自动写入配置到系统下，但是提示了如何配置，方便手动写入，既简化了处理限制的流程，又能保证掌握每次安装包时的改动。\n  查找已安装软件的文档 许多软件包中包含有自己的文档，有些时候，doc的USE标记决定了软件包中的自带文档是否会被安装。您可以通过 emerge -vp category/包名命令来检查是否存在doc USE 标志：\n# emerge -vp media-libs/alsa-lib These are the packages that would be merged, in order: Calculating dependencies... done! [ebuild R ] media-libs/alsa-lib-1.1.3::gentoo USE=\"python -alisp -debug -doc\" ABI_X86=\"(64) -32 (-x32)\" PYTHON_TARGETS=\"python2_7\" 0 KiB 最好的启用 doc USE 的方式是在 /etc/portage/package.use里对想要启用的包单独启用，这样你就能只获得你想要的软件文档。了解更多信息请阅读 USE flags chapter。\n当一个软件包安装结束后，它的文档通常会存放在/usr/share/doc/目录下的，以软件包名命名的子目录中：\n$ ls -l /usr/share/doc/alsa-lib-1.1.3 total 16 -rw-r--r-- 1 root root 3098 Mar 9 15:36 asoundrc.txt.bz2 -rw-r--r-- 1 root root 672 Mar 9 15:36 ChangeLog.bz2 -rw-r--r-- 1 root root 1083 Mar 9 15:36 NOTES.bz2 -rw-r--r-- 1 root root 220 Mar 9 15:36 TODO.bz2 列出已安装文档文件的更可靠方法是使用 equery 的 --filter 选项。 equery 用于查询Portage的数据库，并作为 app-portage/gentoolkit 包的一部分：\n$ equery files --filter=doc alsa-lib * Searching for alsa-lib in media-libs ... * Contents of media-libs/alsa-lib-1.1.3: /usr/share/doc/alsa-lib-1.1.3/ChangeLog.bz2 /usr/share/doc/alsa-lib-1.1.3/NOTES.bz2 /usr/share/doc/alsa-lib-1.1.3/TODO.bz2 /usr/share/doc/alsa-lib-1.1.3/asoundrc.txt.bz2 --filter 选项可与其他规则一起使用，以查看许多其他类型文件的安装位置。可以在 equery 的手册中查看其他功能: man 1 equery。\n卸载软件 当您想把一个软件包从系统中移除的时候，使用 emerge –unmerge命令。命令执行完成后，Portage将会移除此软件包安装到您系统中的所有文件，除了那些在安装软件后您修改过的配置文件。保留这些修改过的配置文件是为了便于您今后再次使用它。\n# emerge --unmerge gnumeric # emerge -C  当您从系统中移除一个软件包时，之前那些为了满足其依赖关系而被自动安装的软件包将会被保留在系统中。要使Portage找到现在可以删除的所有依赖项，可以使用 --depclean 功能。\n自动清理系统下的软件包\n# emerge --ask --depclean # emerge -ac 默认选项 emerge 支持配置一组默认选项，用于在每次运行 emerge 时采用。这个储存默认选项的变量名为 EMERGE_DEFAULT_OPTS ，在 /etc/portage/make.conf 文件下设置。\n这里一组比较推荐的默认选项配置为\nEMERGE_DEFAULT_OPTS=\"--autounmask --autounmask-keep-masks --autounmask-write=n --keep-going -v -j -l 12\" 其中的 12 请根据实际情况修改，如果配置了上文的 binhost ，那么对应选项也添加进入。\nUnderstanding Portage’s Formatted and Colored Output Output from portage is compactly formatted to indicate a plethora of information.\nEmerge “Pretend” Output\n N = new (not yet installed) S = new SLOT installation (side-by-side versions) U = updating (to another version) D = downgrading (best version seems lower) R = replacing (re-merging same version) F = fetch restricted (must be manually downloaded) f = fetch (already downloaded) B = blocked by an already installed package  USE Flags\n An unmarked USE flag is unchanged and enabled. - A dash preceding a USE flag (yellow, green or blue) shows that it is disabled. % A percent symbol following a USE flag indicates that it is new for this package. Identical to yellow output. ***** An asterisk following a USE flag indicates that its meaning/scope has been updated. Identical to green output. () Parentheses around a USE flag indicate that it is currently masked by your profile. This is usually because the USE flag can not be supported on the given platform (for example, the win32codecs on amd64 with non-binary packages) or is irrelevant (for example, sse is available on all amd64 CPU’s, so there’s no point being able to disable it in a 64-bit environment).  Color Output\nPortage returns information to you using both symbols and colors. While the combination makes for a pretty output it also may appear confusing on first glance. Note that the color information is not required, so it repeats the symbolic output.\n red - The USE flag is enabled and has not changed. yellow - The USE flag has been added since the package was last installed. green - The USE flag has changed since the last time the package was installed, as the asterisk after it indicates. blue - The USE flag is disabled, as the dash before it indicates.  Example\nIf you run the command\n# emerge --update --verbose --deep --newuse world you might get something similar to\n[ebuild R ] sys-kernel/linux-headers-2.6.11-r2 USE=\"-gcc64%\" 36,470 kB [ebuild U ] sys-process/psmisc-22.2 USE=\"X* ipv6 nls (-selinux)\" 238 kB In this example the sys-kernel/linux-headers package would be reinstalled as indicated by the “R” at the beginning of the line. The sys-process/psmisc package is being updated, as shown by the “U” at the beginning of the line.\n The gcc64 USE flag is colored yellow and followed by “%” showing that that option has been added since the package was last installed. The “-” shows that it will be disabled during this update. The X USE flag will be green and followed by “*” because that USE flag has changed since the last time the package was installed, as the asterisk after it indicates. No “-” shows that it will be enabled during this update. The ipv6 and nls USE flags would appear red since they are enabled (No “-\") and have not changed (No “*****\"). The selinux USE flag will be blue because the flag is disabled, as the dash before it indicates. The parentheses also show that it is an unavailable or irrelevant option.  更新系统 要保持您的系统在最佳状态（更不用说安装那些最新的安全更新），您需要定期的更新您的系统。由于Portage只能检查本地已有文件，因此您首先应该更新您的Portage树。当您的Portage树更新后，您可以用 emerge –update @world命令来更新系统。在下一个例子里，我们还会使用 --ask 选项来控制Portage显示它要更新的软件包列表， 并让您决定是否继续更新。\n# emerge --update --ask @world Portage将搜索已安装的程序的新版本。 然而，它只会验证明确安装的应用程序（在 /var/lib/portage/world 列出的应用程序）的版本，却不会检查它们的依赖项。若要更新这些包的依赖项，请添加 --deep 选项：\n# emerge --update --deep @world 但是，这并不意味着会更新所有的软件包：某些系统上的软件包，会在编译和构建软件的过程中需要，但是一旦安装完软件，就不再需要这些依赖项。 Portage 称这些依赖为“构建依赖”。 若要在更新时包含这些构建依赖，请添加 --with-bdeps=y 选项：\n# emerge --update --deep --with-bdeps=y @world 因为有时那些没有明确安装的包（但作为其他软件包的依赖而装入系统中）会推出安全更新，所以推荐偶尔运行一下这个命令。\n每当您改变了系统中任何的 USE 标记后，最好加入 --newuse 选项。这样 Portage 将会验证这个 USE 标记变动后，是否需要安装新的软件包或者将现有的软件包重新编译。\n# emerge --update --deep --with-bdeps=y --newuse @world Meta软件包\nGentoo中的一些软件包并没有包含任何实际的内容，而只是用来安装一系列软件包的集合。例如，kde-plasma/plasma-meta 包就是一个包含了一系列与Plasma相关的互相依赖的软件包的集合，您可以通过安装它来在系统中搭建起一个完整的KDE Plasma 桌面环境。\n如果您试图从系统中移除一个这样的软件包的集合体，只是单纯地使用 emerge –unmerge 命令并不能完成您的要求，原因在于这些包的依赖关系仍然保留在系统中。\n不用担心，Portage也提供了移除孤立依赖的软件包的功能，但由于软件包间的依赖关系是动态的，您首先需要充分地更新您的整个系统，包括更改USE标记设定而导致的变化。在这之后您可以运行emerge –depclean来移除那些完全没有被其他包依赖的软件包。移除之后你需要重新编译那些曾经与刚刚移除的这些包动态连接过的应用程序，因为实际上这些程序不需要那些包。\n所有这些可以用以下三个命令来实现：\n# emerge --update --deep --newuse @world # emerge --depclean # revdep-rebuild 关于配置文件的更新 有时候在更新了某些软件包后你会发现出现了一个类似如下的提示信息：\n* IMPORTANT: 2 config files in '/etc' need updating. * See the CONFIGURATION FILES and CONFIGURATION FILES UPDATE TOOLS * sections of the emerge man page to learn how to update config files. 一般出现这种情况的直接原因是你通过归属于一个软件包的文件修改了其默认配置，导致新安装的文件与现存文件不符，于是 Portage 出于保护现存文件的目的，将新文件重命名为了对应目录下的 ._cfgxxxx_ 文件，这是一个很常见的情况。\n而每当出现这种情况后，需要做的操作就是人工介入，判断一下保留哪个文件，还是将两个文件合并。而自带用于进行此操作的对应命令有 dispatch-conf 与 etc-update 。\n以 dispatch-conf 为例，root 权限下执行后，它会逐个文件列出改动，然后提示你进行操作，比如按 z 保留旧的配置文件，按 u 使用新安装的配置文件替换旧的，等等。\n改变桌面环境/ Change Profile   首先修改 /var/lib/portage/world 文件，这个文件记录了用户主动安装的软件，换句话说，整个系统的构建就是围绕这 world 来创建的。将这个文件中不再需要的包删除，比方说 KDE 的软件和一些后续可以再安装，而目前保留可能造成构建麻烦的软件，比方说 htop，megasync，telegram-desktop，fcitx5 之类的，尽量减少到保留必须的就可以了，比方说内核，zfs 之类的。另外可以使用 emerge --deselect xxxx 命令清理 world 。\n  然后是修改或是删除暂时不需要的 USE 配置文件。这里需要强调一下，world 文件是我们手动安装的软件，这些软件用 /etc/portage/package.use/ 定义了其他附带安装的软件包和组。里面不再需要的包，就需要精简，甚至是删除。\n  其次使用 eselect profile 修改配置文件到需要的 Profile 。\n  再次就是运行 emerge --sync; emerge --depclean 来清理系统。一般情况下，这个步骤会删除数百个包，耐心等它完成。\n  最后就是一些收尾工作，清理结束后，运行一些小工具来解决一些新老软件依赖的问题，运行下面的命令一波清：\n# emerge -avj @preserved-rebuild; perl-cleaner --all; emerge --sync; emerge -avujDN --with-bdeps=y --autounmask-write=y @world 运行以后看看会不会有什么 Block 之类的包，或者循环依赖的包，手动删除下；还有时候解决不了看看是不是 USE 没有清理干净，多试几次就会清理干净，更新没有任何报错就可以开始后续的操作了。\n  这个时候一般会来一次全系统重构。命令如下：\n# emerge -ej --keep-going @world   清理 /home// 下的各种配置文件，安装新的桌面环境。\n  Licenses 从Portage版本2.1.7开始，可以根据其授权协议接受或拒绝安装软件。 portage 树中的所有包在其ebuild中包含一个LICENSE选项。 运行emerge –search package/category 将显示软件包的许可证。\nImportant：ebuild 中 的 LICENSE 变量仅是为 Gentoo 开发人员和用户准备的一份指南。它既不是法律声明，也不保证其真实性。因此不要过度依赖它，您需要深入检查软件包的本身，以及您使用的所有文件。\n默认情况下，Portage允许自由软件基金会，开源计划或遵循自由软件定义明确批准的许可。\n控制允许的许可证的变量称为ACCEPT_LICENSE，可以在/etc/portage/make.conf文件中设置。 在下一个示例中，将显示他的默认值：\nACCEPT_LICENSE=\"-* @FREE\" 使用此配置，可以安装具有自由软件或文档许可证的软件包。非自由软件将无法安装。\n可以在ACCEPT_LICENSE中全局设置 ACCEPT_LICENSE，或者在/etc/portage/package.license 文进行配置。\n举个例子，要允许www-client/google-chrome 包的google-chrome的授权协议， 把下面的内容添加到 /etc/portage/package.license:\n/  www-client/google-chrome google-chrome # 亦可指定版本，比如对 20210818 及以上版本的 sys-kernel/linux-firmware 进行配置 =sys-kernel/linux-firmware-20210818 linux-fw-redistributable no-source-code 这允许安装www-client/google-chrome 程序包，但禁止安装www-plugins/chrome-binary-plugins 程序包，即使它具有相同的 授权协议。\n重要：授权协议存储在 /var/db/repos/gentoo/licenses/ ，授权协议组在/var/db/repos/gentoo/profiles/license_groups 里面。CAPITAL字母中每行的第一个条目是许可证组的名称，之后的每个条目都是单独的许可证。\n在 ACCEPT_LICENSE 变量中定义的许可证组前缀为@ 符号。一种可能的设置（以前的Portage默认设置），是允许除“最终用户许可协议（EULA）”以外所有的许可证，“最终用户许可协议（EULA）”中的许可证需要阅读并签署接受协议。要完成此操作，请接受所有许可证（使用*），然后删除EULA组中的许可证，如下所示：\nACCEPT_LICENSE=\"* -@EULA\" 请注意，此设置也将接受非自由软件和文档。\nMasking \u0026 Unmasking packages package.mask中指定的软件将会不被安装（可以将其看成黑名单），当新版本的软件出现一些问题的时候（或者是不兼容）可以在这个文件中添加对应的记录。\n/etc/portage/package.unmask 文件的作用将会覆盖package.mask的效果（安装白名单）。\n屏蔽特定的包版本 如果它不存在，请创建/etc/portage/package.mask 文件：\n# echo \"x11-drivers/ati-drivers-12.6_beta_pre897\"  /etc/portage/package.mask 或者，创建/etc/portage/package.mask/ 目录：\n# mkdir -p /etc/portage/package.mask/ # echo \"x11-drivers/ati-drivers-12.6_beta_pre897\"  /etc/portage/package.mask/ati-drivers 从 ebuild 存储库中屏蔽包 创建一个文件以从名为“larry”的 ebuild 存储库中屏蔽名称为www-client/firefox 的包\n# echo \"www-client/firefox::larry\"  /etc/portage/package.mask/firefox 屏蔽 overlay 所有的包\n常规操作都是enable repository 后把所有包都mask 掉，要用的时候单独一个个开，加上 autounmask 也不用自己写。\n*/*::overlay_name ACCEPT_KEYWORDS ACCEPT_KEYWORDS 变量告诉包管理器哪个 ebuild 的 KEYWORDS 允许接受。\n变量在哪里设置？ 这个变量通常通过 Gentoo 的 profile 设置。但是可以在用户的 /etc/portage/make.conf 文件里进行覆盖，以及在 /etc/portage/package.accept_keywords 文件/目录下的每个包里或者甚至在命令行中进行覆盖。\nImportant：通过命令行覆盖 ACCEPT_KEYWORDS 变量通常被认为是个坏主意，因为设置不会被包管理器保存而且可能导致不必要的行为。\n稳定与不稳定的 keywords 在绝大多数的 profile 中 ACCEPT_KEYWORDS 变量的默认值即系统架构本身，例如 ACCEPT_KEYWORDS=\"amd64\" 或者 ACCEPT_KEYWORDS=\"arm\"。在此情况下，包管理器只接受那些KEYWORDS 变量包含此架构的 ebuild。如果用户希望能够安装那些还未被认为适合生产环境使用的 ebuild，可以在架构前添加 ~ 前缀，例如：\n# nano -w /etc/portage/make.conf ACCEPT_KEYWORDS=\"~amd64\" 由于ACCEPT_KEYWORDS变量是增量的，在添加测试关键字 (~amd64)的时候，不应当指定稳定的关键字(amd64)。\n如果不是进行系统全局设置，那么可以在 /etc/portage/package.accept_keywords 文件或目录中对每个包进行单独设置：\n/ [可选的关键字配置] # games games-fps/doomsday ~amd64 # 亦可指定版本，比如对 21.04.3 及以上版本的 kde-apps-meta 进行配置 =kde-apps/kde-apps-meta-21.04.3 除了 ACCEPT_KEYWORDS 的通常值以外， package.accept_keywords 还支持三个特殊值：\n * — 如果包在任何系统架构是稳定的，那么它可见 ~* — 如果包在任何系统架构是测试的，那么它可见 ** — 这个包总是可见的 (KEYWORDS 被完全忽略)  最后一个选项对于版本经常改变的包 （当前 svn/git/mercurial/… 版本的包， 他们通过 live ebuild 来支持，并且没有 KEYWORDS 变量。\n当Portage报错的时候 简介 正如我们之前指出的那样，Portage是一个非常强大并支持许多特性的软件包管理工具，而这是其他类似工具所欠缺的。为了理解这一点，我们为您粗略地解释一些Portage的面貌。\n通过使用Portage，一个软件的不同版本可以共存于一个系统中。其他发行版倾向于直接在软件包名字中包含版本号（例如freetype 和 freetype2），Gentoo的Portage使用一种我们称之为SLO的技术来实现这种并存。一个ebuild为它自身的版本声明了一个确切的SLOT。具有不同SLOT的同一软件的Ebuild可以共存于同一个系统中。例如，上例中那个freetype包就拥有不同的ebuilds，里面分别有 SLOT=“1” 和SLOT=“2\"的标志\n有一些不同的软件包提供了类似的功能。比如metalogd，sysklogd和syslog-ng都是系统日志记录工具。那些依赖于“系统日志记录工具”的程序并不能随便的依赖于其中之一，比如metalogd。因为其他的系统日志工具可能也是很好的选择。好在Portage允许使用虚拟包：每一个系统日志记录工具都可以提供virtual/logger包，因此应用程序们可以设定成仅仅依赖于virtual/syslog即可。\nPortage树中的软件可以存在于不同的分支中。您的系统默认只会接受那些Gentoo认为稳定的软件包。绝大多数新提交的软件会被添加到测试分支里。这意味着在此软件被标示为稳定版前需要进行更多的测试。尽管您可以看到那些软件的ebuilds已经加入Portage数据库，在它们未被加入稳定分支前Portage将不会安装它们。\n有些软件只能在某几个体系结构上使用。或者在其他体系结构中还不能运行，或者仍需要对其进行更多的测试，或者将软件提交到Portage树中的开发者还不能确定这个软件能否运行于其他体系结构。\n每一个Gentoo安装都依附于一个确定的profile，此文件里除了其他信息外还包含了一个正常工作的系统需要的软件包的列表。\n被阻挡的包 Portage关于被阻挡的包的警告(使用 –pretend参数)\n[blocks B ] mail-mta/ssmtp (is blocking mail-mta/postfix-2.2.2-r1) Portage关于被阻挡的包的警告(不使用 –pretend参数)\n!!! Error: the mail-mta/postfix package conflicts with another package. !!! both can't be installed on the same system together. !!! Please use 'emerge --pretend' to determine blockers. Ebuilds文件中包含了特定的字段，里面为Portage提供了此软件的各种依赖关系的信息。总计有两种可能的依赖关系：一种是编译依赖，在 DEPEND 区域进行声明;另一种是“运行时”依赖，在 RDEPEND 区域中进行声明。如果上述两种依赖关系中任何一个明确指明某个实体或者虚拟包（译注：可能已安装和正要安装）与要安装的包不相容的时候，就会阻挡软件的安装。\n虽然Portage的最新版本足够聪明，可以在没有用户干预的情况下解决轻微的问题，但偶尔也需要手动解决此类问题。\n为了使安装得以继续进行，您可以选择不安装这个软件包，或者先将发生冲突的包卸载。例如，在我们给出的这个例子中，您可以选择不安装postfix，或者先卸载ssmtp。\n你也可能会遇到某些特定版本的包被屏蔽的情况，比如。在这种情况下，升级到一个更新的版本就能解决问题。\n也有可能两个需要安装的包互相阻挡。这种少见的情况下，您应该明确自己为什么需要同时安装它们。绝大多数时候您只需要安装它们之中的一个就可以了。如果不是这样，请您到 Gentoo’s bugtracking system 中提交一个bug。\n被屏蔽的包 Portage关于被阻挡的包的警告\n!!! all ebuilds that could satisfy \"bootsplash\" have been masked. PPortage关于被屏蔽的包的警告——原因\n!!! possible candidates are: - gnome-base/gnome-2.8.0_pre1 (masked by: ~x86 keyword) - lm-sensors/lm-sensors-2.8.7 (masked by: -sparc keyword) - sys-libs/glibc-2.3.4.20040808 (masked by: -* keyword) - dev-util/cvsd-1.0.2 (masked by: missing keyword) - games-fps/unreal-tournament-451 (masked by: package.mask) - sys-libs/glibc-2.3.2-r11 (masked by: profile) - net-im/skype-2.1.0.81 (masked by: skype-eula license(s)) 当您想安装一个对于您系统不可用的软件包。您会收到类似这样的屏蔽错误提示。您应该试着安装那些对于您系统可用的程序或者等待那些不可用的包被置为可用的。通常一个软件包被屏蔽的原因在于：\n   Reason for mask Description     ~arch keyword 这个软件没有经过充分的测试，不能进入稳定分支，请等待一段时间后在尝试使用它。   -arch keyword or -* keyword 这个软件不能工作在您机器的体系结构中。如果您确信它能工作那么请到我们的bugzilla网站提交一个bug报告。   missing keyword 这个软件还没有在您机器的体系结构中进行过测试。您可以咨询相应体系结构移植小组是否能对它进行测试，或者您自己为他们进行这样的测试并将您得到的结论提交到我们的bugzilla网站。   package.mask 这个软件被认为是损坏的，不稳定的或者有更严重的问题，它被故意标识为“不应使用”。   profile 这个软件不适用于您的profile。安装这样的应用软件可能会破坏您的系统，或者只是不能与您使用的profile相兼容。   license 这个包的许可证的ACCEPT_LICENSE值不正确。 通过设置许可证或正确的许可证组来允许其许可证:/etc/portage/make.conf或 /etc/portage/package.license    USE必要的更改 Portage 提示 USE 标志需要进行更改\nThe following USE changes are necessary to proceed: #required by app-text/happypackage-2.0, required by happypackage (argument) =app-text/feelings-1.0.0 test 如果未使用--autounmask参数，则错误消息也可能显示如下：\nemerge: there are no ebuilds built with USE flags to satisfy \"app-text/feelings[test]\". !!! One of the following packages is required to complete your request: - app-text/feelings-1.0.0 (Change USE: +test) (dependency required by \"app-text/happypackage-2.0\" [ebuild]) (dependency required by \"happypackage\" [argument]) 当请求安装包时，发生这种警告或错误，这不仅取决于另一个包，而且还要求该包使用特定的USE标志（或一组USE标志）构建。 在给定的示例中，包应用文本/感觉需要使用 USE=“test\"构建，但此系统上未设置此USE标志。\n要解决这个问题， 到/etc/portage/make.conf编辑里面的USE标志, 或者去/etc/portage/package.use设置一个特殊的包.\n缺失依赖 Portage提示依赖性不满足\nemerge: there are no ebuilds to satisfy \"=sys-devel/gcc-3.4.2-r4\". !!! Problem with ebuild sys-devel/gcc-3.4.2-r2 !!! Possibly a DEPEND/*DEPEND problem. 这表示您正尝试安装的应用程序依赖于您的系统不可用的另外一些软件包。请到bugzilla查看是否有此问题的记录，如果没有查找到相关信息的话请提交一个报告。除非您的系统混用了不同分支，否则这类问题不应该发生，若发生了那就是一个bug。\n意指不明的软件包 Portage对于意指不明的Ebuild名称的警告\n[ Results for search key : listen ] [ Applications found : 2 ] * dev-tinyos/listen [ Masked ] Latest version available: 1.1.15 Latest version installed: [ Not Installed ] Size of files: 10,032 kB Homepage: http://www.tinyos.net/ Description: Raw listen for TinyOS License: BSD * media-sound/listen [ Masked ] Latest version available: 0.6.3 Latest version installed: [ Not Installed ] Size of files: 859 kB Homepage: http://www.listen-project.org Description: A Music player and management for GNOME License: GPL-2 !!! The short ebuild name \"listen\" is ambiguous. Please specify !!! one of the above fully-qualified ebuild names instead. 您要安装的应用程序对应有多个同名的包。您需要同时指定类别的名称。Portage会列出所有可供选择的名称匹配的包。\n循环依赖 Portage关于循环依赖问题的警告\n!!! Error: circular dependencies: ebuild / net-print/cups-1.1.15-r2 depends on ebuild / app-text/ghostscript-7.05.3-r1 ebuild / app-text/ghostscript-7.05.3-r1 depends on ebuild / net-print/cups-1.1.15-r2 两个（或多个）您想安装的包由于循环依赖而不能安装。这很可能源于Portage树中的bug。请等一段时间后重新sync再尝试安装。您也可以去 Bugzilla 看看是否已经有此问题的报告，或者提交一个关于它的报告。\n下载失败 Portage关于下载失败的警告\n!!! Fetch failed for sys-libs/ncurses-5.4-r5, continuing... (...) !!! Some fetch errors were encountered. Please see above for details. 当Portage下载指定软件的源代码失败时，它会尝试继续安装其它（若适用）的应用程序。源代码下载失败可能源于镜像服务器没有正确同步，也可能因为ebuild文件给出了错误的下载地址。那些保存源代码的服务器也可能因为某些原因宕机。\n一小时后重试一次，看看问题是否仍然存在。\n系统Profile保护 Portage关于profile中保护的包的警告\n!!! Trying to unmerge package(s) in system profile. 'sys-apps/portage' !!! This could be damaging to your system. 您要求移除系统核心软件包中的一个。它是您的profile中所列出的必需的软件，因此不能从系统中移除。\nDigest验证失败 Digest验证失败\n checking ebuild checksums !!! Digest verification failed: 这是Portage树中出现了错误的迹象，通常是由于将ebuild提交到Gentoo ebuild存储库时出错造成的。\n当digest校验失败的时候，请不要尝试自己去为此软件包重新产生digest。使用ebuild foo manifest 并不能修复问题，反而很可能会使问题变得更糟。\n取而代之的应该是等待一至两个小时以便让软件仓库安定下来。一般来说错误很有可能马上就会被注意到，但是修复程序可能需要一点时间来逐步扫描rsync镜像。当您等待的时候，到Bugzilla或者#gentoo (webchat) (IRC)看看是否已经有人报告了这个问题。如果没有，那就为那个损坏的ebuild提交一个bug报告吧。\n修复错误后，重新同步Gentoo ebuild仓库以获取修复的digest。\n重要：值得注意的是：不要每天多次同步Gentoo ebuild repository 仓库。正如（当您运行emerge –sync时）Gentoo官方网络礼节策略所指出的那样，那些短时间内过于频繁进行多次sync的用户将会被更新服务器软封禁一段时间，一再不遵守这一政策的滥用者可能会被硬封禁。除非绝对必要，否则通常最好等待24小时再进行同步，因为这样您不会使Gentoo的rsync镜像服务器过载而影响其他用户的正常使用。\n其他工具 单纯 Portage 自带的工具对于日常管理其会显得有些吃力，这里推荐几个比较有用的软件用于辅助管理 Portage。\napp-portage/eix 这个可以说是非常有用的软件，主要用于查询 Portage 数据库，其优势在于更快的速度、更人性化的显示格式以及更方便的查询模式。\n使用前需执行 eix-update 以更新 eix 数据库，安装它之后，可以使用 eix-sync 命令来更新 Portage 数据库，更新完毕后会自动更新 eix 数据库，并显示更新前后的软件包对比情况。\n使用 eix 查询所需软件，最基本的命令为\n# eix  也可只查询已安装的包\n# eix -I  也可查询属于一个特定分类下的所有包\n# eix -C  等等，执行 man eix 查看更多用法。\napp-portage/gentoolkit 包含了 Gentoo 的一些管理脚本，常用的命令有用于查询依赖关系，文件归属，软件包内容的 equery ，以及用于清理 distfile 的 eclean-dist 。比如\n可以查询依赖 vim-core 的软件包（仅根据 ebuild 文件内容查询）\n# equery d vim-core 可以查询 vim 下属的依赖关系图\n# equery g vim 可以查询 vim 安装了哪些文件到系统下\n# equery f vim 可以查询这个文件属于哪个包\n# equery b /usr/bin/vim eclean eclean 是一个清理仓库源文件和二进制包的工具。它是 app-portage/gentoolkit 包的一部分，并由 Portage-Tools 项目维护。\n安装\n安装 eclean：\n# emerge --ask app-portage/gentoolkit 附注：关于 app-portage/gentoolkit 包中其他工具的信息请参看 Gentoolkit article。\n使用\n默认情况下，源文件存储在 /var/db/repos/gentoo/distfiles 目录下， 二进制包存储在 /var/db/repos/gentoo/packages 目录下；可以通过修改 /etc/portage/make.conf 中的 DISTDIR 和 PKGDIR 变量更改对应的存储位置。如果不定期清理，这两个目录可能会悄然无声地变得非常巨大；这就是创建eclean的原因。\n使用 eclean –help 来查看全部的命令简介、参数列表和使用介绍：\n# eclean --help 通过 distfiles 参数清理源文件存放目录：\n# eclean distfiles 或者使用更简短的命令：\n# eclean-dist 使用下面的命令清理二进制包：\n# eclean packages 或者使用更简短的命令：\n# eclean-pkg 选项\n默认情况下，当前存储库中的任何ebuild相对应的源文件和二进制包都不会被删除。这样，只要程序包仍在当前存储库树中，系统管理员就可以轻松地降级程序包或安装以前删除的程序包。\n举个例子，比如包 foo-1.0 和 foo-1.1 都在存储库中。在从 foo-1.0 升级到 foo-1.1 之后，运行 elcean distfiles，两个版本的源文件依然被保留，因此如果 foo-1.1 出现问题，用户可以很方便的重新安装 foo-1.0，而不必重新下载。\n另一个可能的情况是安装之前删除的包。假设系统安装了 foo 包（任一版本）。在（不经意地）删除了这个包并运行了 eclean disfiles 之后，foo 的源文件依然被保留，可以重新安装而无需再次下载。\n对二进制包同样的例子也一样适用。\n为节省更多磁盘空间，请添加--deep选项：这将删除与某些当前安装的软件包（版本无关紧要）不对应的每个源文件或二进制软件包。请注意，这种方式当用户需要降级安装某个包或者重新安装之前删除的包的时候都必须重新下载。\n# eclean --deep distfiles # eclean --deep packages 一个替代方案是，同时使用 --deep 和 --package-names 选项：对于某些非当前安装的包（不管版本号是什么）的每个源文件或者二进制包都会被删除。这种方式当用户需重新安装之前删除的包的时候都必须重新下载，但是要降级安装某个包则不需要。\n更多细节请参阅 eclean(1) man page：\n# man 1 eclean app-portage/portage-utils 包含了 Portage 的帮助工具，与上面 gentoolkit 的功能有重合，他们具有互补性，常用的命令有用于分析 emerge 日志的 qlop 。它是用 C 写的，速度更快。\napp-portage/pfl Portage File List，可用于在线查询文件所归属的包，命令为 e-file  。\n多版本管理 Gentoo Linux 支持同一软件多版本同时存在于系统上，这归功于 Portage 系统的 slotting 机制。当你执行命令 eix dev-lang/python 会发现它有好多行可用版本，最前圆括号内的内容即对应的 slot 名，不同 slot 下的版本可同时安装到系统上（ slot 名内 / 符号后的内容表示其 sub-slot，同 slot 但不同 sub-slot 的版本无法共存）。比如，sys-devel/gcc , sys-devel/clang , dev-lang/lua 等等都支持多版本共存。\n对于一些多版本共存的工具， Gentoo Linux 准备了对应的 eselect 命令以方便用户选择使用。其会在对应的 $PATH 目录下创建一个指向当前选定版本命令的软链接。比如，列出当前所有已经安装的 lua 版本\n# eselect lua list 设定了系统下用户交互环境的默认 lua 版本\n# eselect lua set {序号} 其它的类似，执行 eselect help 以查看当前所有支持的模块。不是所有的多版本共存的包都会有 eselect 模块，它们并不存在强制的依赖关系。执行 eix -I2 可以显示当前系统下安装的可多版本共存的包。\nUSE标记 什么是USE标志 USE标志的指导思想 你在安装gentoo（或者是其他发行版，甚至于其他特定操作系统）的时候，你要依据你工作的环境做出选择。服务器跟工作站的组织结构不同，游戏机跟3D工作站也会不一样。\n不单只是选择你想要安装的包时如此，选择某一个包需要的特性时同样如此。如果你不需要OpenGL，为什么还要花费时间安装OpenGL并在其他包中加入对OpenGL的支持？如果你不用KDE，而且软件包没有KDE也能完美运行，为什么还要在编译这些包的时候加入KDE支持？\n为了帮用户判断什么需要安装或激活，什么不需要；我们希望用户能用简单的方式设定他们自己的环境。这能促使用户判断他真正需要的东西，并让Portage做出有用的决定的过程变得简单。\nUSE标志的设定 我们来具体看看USE标志。每一个标志都是代表对某特定概念的支持和依赖关系信息的关键字。如果你设定了某个USE标志，Portage会明白他们需要支持所选关键字。当然这同时也改变了这个包的依赖关系信息。\n让我们看一个特殊示例：关键字 kde 。如果你的 USE 变量里面没有这个关键字，所有具有可选KDE支持的包在编译时都 不会 编译KDE支持。所有具有可选KDE依赖关系的包在安装时都 不会 （做为一个依赖关系而）安装KDE库。如果你设定了kde关键字，这些包在安装时都 会 编译KDE支持，而且KDE库也 会 （作为一个依赖关系而）被安装。\n通过正确设定关键字，你会得到一个根据你的需要而定制的系统。\n使用USE标志 声明永久USE标志 就像前面提到的，所有USE标志都声明在 USE 变量里面。为了让用户能方便地查找和选择USE标志，我们提供了一份默认的USE设定。这些设定是我们觉得Gentoo用户通常都要用到的USE标志的集合。这个默认设置在make.defaults 文件──你的profile声明。\n你的系统使用的profile是符号链接 /etc/portage/make.profile 所指向的目录。每个profile叠加于某个更大的profile之上，最终的结果是这些profile的并集。初始profile是base profile( /var/db/repos/gentoo/profiles/base)。\n要查看当前正在使用的USE标志（全部），请使用 emerge –info：\n# emerge --info | grep ^USE USE=\"a52 aac acpi alsa branding cairo cdr dbus dts ...\" 就像你看到的那样，这个变量已经包括了非常多的关键字。不要通过修改make.defaults 文件里的 USE 变量来满足你的需要：在升级Portage的时候，这个文件将会被覆盖。\n要改变这个默认设置，你需要在 USE 变量里添加或移去关键字。这是通过在/etc/portage/make.conf里定义USE全局变量来实现的。在这个变量里，添加你需要的额外的USE标志，或者移去你不需要的USE标志。后者可通过在标记前面加个负号 (-).前缀来实现。\n例如，要移除对 KDE 和 QT 的支持，并添加对 LDAP 的支持，可以在/etc/portage/make.conf里声明USE如下：\nUSE=\"-kde -qt4 -qt5 ldap\" 为单个包声明USE标志 如果你不是想为整个系统声明USE标志，而是想要为一个（或者几个）程序声明USE标志，你需要编辑/etc/portage/package.use文件。package.use 通常是一个文件，不过它也可以是一个充满子文件的目录；请看下面的提示和 man 5 portage 以获得更多如何使用这个约定的信息。下面的例子假设 package.use 是一个文件。\n比如说，如果你不想全局的启用 Blu-ray 支持，你只想把它应用到 VLC 包，你可以这样做：\n/  media-video/vlc bluray Tip：如果 package.use 是一个已经存在的“目录”（而不是一个单文件），只需简单地在 package.use/ 目录下创建文件，就可以修改软件包的本地USE标记。虽然任何文件命名规范都行，但是更明智的做法是统一命名方案。\n有一种规范是简单地使用包名作为子文件的标题。比如说，可以用如下方式为 media-video/vlc 软件包在本地设置 bluray USE 标记。\n# echo \"media-video/vlc bluray\"  /etc/portage/package.use/vlc 你当然也可以直接为某一个程序禁用USE标志。比如说，禁用PHP的bzip2支持（但通过make.conf中的USE标志为其他包提供支持）：\ndev-lang/php -bzip2 -* 代表去除该匹配的包的所有已经添加的以及默认的 USE\n=kde-apps/kde-apps-meta-21.04.3 -* admin Portage 有一个 USE Expand 功能，即把指定变量的值扩展成 USE，这些指定的变量被设置在 Portage 数据库路径下的 profiles/base/make.defaults 文件的 USE_EXPAND 变量中。这个功能很实用，简化了配置值，还能进行归类，更便于管理。上文有一个 显卡的配置 其实就是一个 USE_EXPAND 值。其它会使用到它的地方不多，但也有，比如配置全局的本地化配置，就可以在 make.conf 文件下配置\nL10N=\"zh-CN zh-TW zh en-GB-oxendict en\" 这样，那么以后当有包支持上述的本地化配置时，就会自动添加。\n其它比如可以对 qemu 这个虚拟机添加额外的模拟平台， 可以往 /etc/portage/package.use/qemu 文件写\napp-emulation/qemu QEMU_SOFTMMU_TARGETS: aarch x86_64 以支持 arm64 及 x86_64 平台。等等\n声明临时USE标志 有时，你只想暂时改变一个USE设置。你可以仅仅把USE 变量声明成一个环境变量，而不必两次修改/etc/portage/make.conf 。但是要记住，当你重新emerge或者升级这个程序的时候（不管是单独地还是作为系统升级的一部分），你的修改会被重置。\n下面的例子我们将在安装 SeaMonkey 的时候临时从 USE 变量中移去pulseaudio 值。\n# USE=\"-pulseaudio\" emerge www-client/seamonkey 优先级 当然，USE设置有一定的优先级。按优先级排序（第一优先级最低）：\n make.defaults 里面的USE默认设定 用户在/etc/portage/make.conf里面的USE默认设定 用户在 /etc/portage/package.use里面的USE默认设定 用户作为环境变量的USE设定  运行 emerge –info可以看到Portage识别的最终的USE设定。它会列出Portage使用的所有相关变量（包括 USE 变量）。\n# emerge --info 在整个系统上应用新的USE标志 如果你已经修改了你的USE标志，而且你想用新的USE标志更新你的系统，可以使用emerge的 --newuse选项：\n# emerge --update --deep --newuse @world 然后运行Portage的depclean来移除已经安装到你的\"旧\"系统里但是在新USE标志中被废除的条件依赖关系。\n警告：运行emerge –depclean是一项危险的操作，必须小心。请反复检查要删除的包的列表里确定没有你仍然需要的包。下面这个例子里，我们添加了 -p 选项──来只列出这些包而不删除他们：\n# emerge -p --depclean depclean完成之后， emerge会针对可能是已经删除的软件包提供的共享对象动态链接的应用程序提示重新构建。此操作完成前，为了防止破坏应用程序，Portage 将会保存必要的库。它存储着需要在 preserved-rebuild 设置的重建内容。若要重建必要的包，请运行：\n# emerge @preserved-rebuild 这些都完成之后，你的系统就已经应用上了新的USE标志的设定。\n软件包特有的USE标志 查看可用USE标志。\n让我们以seamonkey来作例子，看看它接收什么USE标志。我们可以以--pretend和 --verbose为选项执行 emerge来查看：\n# emerge --pretend --verbose www-client/seamonkey These are the packages that would be merged, in order: Calculating dependencies... done! [ebuild N ] www-client/seamonkey-2.48_beta1::gentoo USE=\"calendar chatzilla crypt dbus gmp-autoupdate ipc jemalloc pulseaudio roaming skia startup-notification -custom-cflags -custom-optimization -debug -gtk3 -jack -minimal (-neon) (-selinux) (-system-cairo) -system-harfbuzz -system-icu -system-jpeg -system-libevent -system-libvpx -system-sqlite {-test} -wifi\" L10N=\"-ca -cs -de -en-GB -es-AR -es-ES -fi -fr -gl -hu -it -ja -lt -nb -nl -pl -pt-PT -ru -sk -sv -tr -uk -zh-CN -zh-TW\" 216,860 KiB Total: 1 package (1 new), Size of downloads: 216,860 KiB emerge 并不是做这件事的唯一工具。事实上，我们有一个专门的包信息工具叫equery，它属于app-portage/gentoolkit。\n# emerge --ask app-portage/gentoolkit 现在以为参数执行 equery 来查看指定包的USE标志。例如：gnumeric包：\n# equery --nocolor uses =gnumeric-1.12.31 [ Legend : U - final flag setting for installation] [ : I - package is installed with flag ] [ Colors : set, unset ] * Found these USE flags for app-office/gnumeric-1.12.31: U I + + introspection : Add support for GObject based introspection - - libgda : Enable database support through gnome-extra/libgda. - - perl : Enable perl plugin loader. + + python : Enable python plugin loader. + + python_targets_python2_7 : Build with Python 2.7 满足 REQUIRED_USE 一些 ebuild 需要或禁止 USE 标志的某些组合才能正常工作。 这通过放置在 REQUIRED_USE ，用一组条件来表示。此条件确保所有功能和依赖性都已完成，并且构建将成功并按预期执行。 如果任何一个不符合，emerge 会提醒你，并要求你解决这个问题。\n下面是 REQUIRED_USE 的一个例子：\n   示例 描述     REQUIRED_USE=\"foo? ( bar )\" 如果设定 foo，则必须设定 bar。   REQUIRED_USE=\"foo? ( !bar )\" 如果设定 foo，则不得设定 bar。   `REQUIRED_USE=“foo? (    REQUIRED_USE=\"^^ ( foo bar baz )\" 必须在 foo、bar 或 baz 中设定一个。   `REQUIRED_USE=”    REQUIRED_USE=\"?? ( foo bar baz )\"     Portage功能特性 Portage特性 Portage有几个附加的特性，它们能够令您的Gentoo之旅更加愉快。这些特性中的大多数依赖于某些能够提高性能、可靠性、安全性等的软件工具。\n为了打开或者关闭某一Portage特性您需要编辑 /etc/portage/make.conf中的 FEATURES变量，这个变量包含不同的特性关键字，用空格分开。在一些情况下您可能还需要额外的安装被这个特性所依赖的工具。\n并不是所有Portage所支持的特性都在这里列出。完整的概述，请查阅make.conf手册页：\n# man make.conf 查看 FEATURES 的默认设置，运行emerge –info并且查找FEATURES变量或者用grep 显示它：\n# emerge --info | grep ^FEATURES= 分布式编译 使用distcc distcc 是一个分布式编译程序，可以把编译任务分配给同一网络中的不同机器，这些机器的配置不必完全相同。distcc客户端发送所有必须的信息给所有可利用的distcc服务器（运行distccd的机器）。这样它们每一个都能为客户端编译一部分源码。所获得的效果就是更短的编译时间。\n您可以在Gentoo Distcc文档里找到更多的关于Distcc的信息（包括如何让它在Gentoo上工作）。\n安装 distcc Distcc使用一个图形化监视器来监视您的机器发送出去的编译工作。请把 USE=gnome 或 USE=gtk放进您的USE设置中。\n# merge --ask sys-devel/distcc 激活Portage的distcc支持 将 distcc 添加到/etc/portage/make.conf中的 FEATURES 变量中。 接下来，编辑MAKEOPTS变量，并增加系统允许的并行构建的数量。 一个已知的方法是填写 -jN 其中N 是运行distccd（包括当前主机）的CPU数量+1（或者核心数+1），但这只是一个建议。\n现在运行 distcc-config并输入已有的DistCC服务器。作为一个简单例子，我们假设已有的DistCC服务器是192.168.1.102（当前主机）、192.168.1.103和192.168.1.104（两个远端服务器）：\n# distcc-config --set-hosts \"192.168.1.102 192.168.1.103 192.168.1.104\" 当然，也不要忘了运行distccd系统服务：\n# rc-update add distccd default # /etc/init.d/distccd start 缓冲编译结果 关于ccache ccache是一个快速编译器缓存。 无论何时编译应用程序，它都将缓存中间结果，以便每当重新编译相同的程序时，编译时间大大减少。 第一次运行ccache时，它会比正常编译慢得多。 但是后续的重新编译应该更快。 ccache只有在相同的应用程序将被重新编译多次（或相同应用程序的升级频繁发生）时才有用; 因此它通常只对软件开发人员有用。\n如果您对ccache的工作机制有兴趣，请访问homepage主页.\n警告：已知ccache会导致大量的编译失败。 有时ccache会保留旧代码对象或损坏的文件，这可能导致无法破损的源码。 如果发生这种情况（例如\"File not recognized: File truncated\"出现在构建日志中），请尝试重新编译ccache导致错误的应用程序 。添加FEATURES=\"-ccache\" 到/etc/portage/make.conf或者\n# FEATURES=\"-ccache\" emerge  安装 ccache 要安装ccache，只需要：\n# emerge --ask dev-util/ccache 激活Portage ccache 支持 打开 /etc/portage/make.conf并添加ccache到FEATURES变量:\nFEATURES=\"ccache\" CCACHE_SIZE=\"2G\" 要检查ccache是否运行，只需让它提供给您它的统计数据。因为Portage使用一个不同的ccache主目录，您需要设定CCACHE_DIR变量：\n# CCACHE_DIR=\"/var/tmp/ccache\" ccache -s /var/tmp/ccache/是Portage的默认ccache主目录；为了修改这个设置，您可以设定/etc/portage/make.conf中的CCACHE_DIR参数。\n不过，如果您运行 ccache ，它使用的默认目录是${HOME}/.ccache/。这就是为什么当您查询（Portage）ccache统计数据的时候您需要设定 CCACHE_DIR参数的原因。\n非Portage编译中使用ccache 如果您需要在非Portage编译中使用ccache，添加 /usr/lib/ccache/bin/到您 PATH参数里靠前的位置（在/usr/bin之前）。这一点可以通过编辑在您用户主目录中的~/.bash_profile文件来实现。使用~/.bash_profile是定义 PATH参数的一个方式\nPATH=\"/usr/lib/ccache/bin:${PATH}\" 二进制包支持 创建预编译包 Portage 也支持安装预编译软件包。尽管 Gentoo 本身并不提供预编译包，但 Portage 依然能够处理预编译包。\n如果某个包已经被安装在您的系统上，您可以用 quickpkg 来创建预编译包。也可以用带有 --buildpkg 或 --buildpkgonly 选项的 emerge 命令。\n如果您希望 Portage 为您所安装的每一个软件包创建预编译软件包，那么请在 FEATURES 中添加 buildpkg 变量。\n预编译包的更多扩展支持可以用 catalyst 得到。关于catalyst的更多信息请参阅 Catalyst FAQ。\n安装预编译包 尽管Gentoo并不提供，但是您可以自己建立一个“中心仓库”来存放预编译包。如果您希望使用这个仓库，您需要设定PORTAGE_BINHOST参数使Portage能够知道它。例如，如果预编译包在 ftp://buildhost/gentoo 上：\n# nano -w /etc/portage/make.conf PORTAGE_BINHOST=\"ftp://buildhost/gentoo\" 当您需要安装预编译包的时候，在emerge命令后的 --getbinpkg选项旁加入 --usepkg 选项。前者让emerge命令从预定的服务器上下载预编译包，后者让emerge首先试图安装预编译包，如果预编译包不存在，那么才下载并编译源码。\n例如：用预编译包安装gnumeric\n# emerge --usepkg --getbinpkg gnumeric 关于emerge的预编译包的更多信息请参阅emerge手册页:\n# man emerge 将预构建的软件包分发给他人 如果预构建的软件要分发给其他人，请确保这样做是被允许的。 检查上游软件包的分发要求。 例如，对于在GNU GPL协议下发布的软件，源代码必须与二进制文件一起提供。\n如果构建的二进制程序不可分发，则Ebuild可以在其RESTRICT 变量中定义 bindist限制。 有时，此限制取决于一个或多个USE标志。\n默认情况下，Portage将不会屏蔽任何包，因为有限制。 这可以通过在/etc/portage/make.conf中设置ACCEPT_RESTRICT变量来全局更改。 例如，要掩盖具有bindist 限制的软件包，请将以下行添加到make.conf：\nACCEPT_RESTRICT=\"* -bindist\" 还可以通过将ACCEPT_RESTRICT选项用于emerge命令，来覆盖--accept-restrict 变量。 例如， --accept-restrict=-bindist将临时屏蔽带有bindist 限制的包。\n还可以考虑在分发包时设置ACCEPT_LICENSE变量。 请参阅 授权许可。\n重要：每个 用户完全有责任遵守软件许可条款和每个用户国家的法律。 ebuilds（RESTRICT或LICENSE）定义的元数据变量可以为禁止预编译文件分发提供指导。但是Portage的输出或Gentoo开发人员的回答 不是 法律声明，不应该依赖他们。 谨慎遵守您的当地的法律。\n下载文件 并行下载 Portage 通常是以root 用户运行的， FEATURES=\"userfetch\"可以让Portage在下载源码包的时候弃用 root 权限，并以 portage:portage 的用户/组权限运行。这是一个小小的安全性的提高方法。\n如果在 FEATURES 设置了 userfetch，请确保在 root 权限下，使用 chown 命令更改在 /var/db/repos/gentoo 下所有文件的所有者：\n# chown --recursive --verbose portage:portage /var/db/repos/gentoo 验证源文件 要重新验证完整性并(可能)重新下载当前所有安装的软件包以前删除或损坏的 distfiles，请运行：\n# emerge --ask --fetchonly --emptytree @world 环境变量 环境变量 简介 环境变量是一个具有特定名字的对象，它包含了一个或者多个应用程序所将使用到的信息。通过使用环境变量，你可以很容易的修改一个牵涉到一个或多个应用程序的配置信息。\n重要的例子 下表展示了一些Linux系统使用的变量并说明了它们的用处。在表格后面将列举一些变量例值。\n   Variable Description     PATH 这个变量包含了一系列由冒号分隔开的目录，系统就从这些目录里寻找可执行文件。如果你输入的可执行文件（例如 ls, rc-update或者 emerge）不在这些目录中，系统就无法执行它（除非你输入这个命令的完整路径，如/bin/ls）。   ROOTPATH 这个变量的功能和 PATH相同，但它只罗列出超级用户（root）键入命令时所需检查的目录。   LDPATH 这个变量包含了一系列用冒号隔开的目录，动态链接器将在这些目录里查找库文件。   MANPATH 这个变量包含了一系列用冒号隔开的目录，命令 man 会在这些目录里搜索man页面。   INFODIR 这个变量包含了一系列用冒号隔开的目录，命令 info 将在这些目录里搜索info页面。   PAGER 这个变量包含了浏览文件内容的程序的路径，比如(less 或者 more)   EDITOR 这个变量包含了修改文件内容的程序（文件编辑器）的路径(比如 nano 或 vi).   KDEDIRS 这个变量包含了一系列用冒号隔开的目录，里面放的是KDE相关的资料。   CONFIG_PROTECT 这个变量包含了一系列用空格隔开的目录，它们在更新的时候会被Portage保护起来。   CONFIG_PROTECT_MASK 这个变量包含了一系列用空格隔开的目录，它们在更新的时候不会被Portage保护起来。    下面你可以找到所有这些变量定义的范例：\nPATH=\"/bin:/usr/bin:/usr/local/bin:/opt/bin:/usr/games/bin\" ROOTPATH=\"/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin\" LDPATH=\"/lib:/usr/lib:/usr/local/lib:/usr/lib/gcc-lib/i686-pc-linux-gnu/3.2.3\" MANPATH=\"/usr/share/man:/usr/local/share/man\" INFODIR=\"/usr/share/info:/usr/local/share/info\" PAGER=\"/usr/bin/less\" EDITOR=\"/usr/bin/vim\" KDEDIRS=\"/usr\" CONFIG_PROTECT=\"/usr/X11R6/lib/X11/xkb /opt/tomcat/conf \\ /usr/kde/3.1/share/config /usr/share/texmf/tex/generic/config/ \\ /usr/share/texmf/tex/platex/config/ /usr/share/config\" CONFIG_PROTECT_MASK=\"/etc/gconf\" 全局变量的定义 env.d目录 Gentoo采用了/etc/env.d/目录来集中定义全局变量。在这个目录里，你会发现很多类似 00basic, 05gcc等等这样的文件，它们包含了文件名中提到的应用程序需要的变量。\n举个例子，当你安装 gcc时，一个名为 05gcc 的文件就会被ebuild所创建，里面包含了如下一些变量：\nPATH=\"/usr/i686-pc-linux-gnu/gcc-bin/3.2\" ROOTPATH=\"/usr/i686-pc-linux-gnu/gcc-bin/3.2\" MANPATH=\"/usr/share/gcc-data/i686-pc-linux-gnu/3.2/man\" INFOPATH=\"/usr/share/gcc-data/i686-pc-linux-gnu/3.2/info\" CC=\"gcc\" CXX=\"g++\" LDPATH=\"/usr/lib/gcc-lib/i686-pc-linux-gnu/3.2.3\" 其他的发行版会让你到/etc/profile或者其他地方修改和添加这些变量的定义。而Gentoo为用户（还有为Portage）提供了更加便捷的方式来维护和管理环境变量，以后你不再需要把精力放在那些众多的包含环境变量的文件身上了。\n比如，当你更新完gcc 的时候， /etc/env.d/05gcc也会被同时更新，而不需要你手工来完成。\n这不仅对Portage有益，作为用户，你也是受益者。有时候你需要设置某个系统范围的环境变量。我们拿http_proxy变量来做例子，为了避免http_proxy 搞乱，你只要新建一个文件/etc/env.d/99local然后添加你的定义：\nhttp_proxy=\"proxy.server.com:8080\" 通过使用同一个文件来定义你所有的变量，你对如何定义自己的变量有了个大概的了解。\nenv-update /etc/env.d/ 中的好几个文件都定义了PATH变量。这并没有错：当你运行env-update的时候，它会在更新环境变量之前把这些定义都追加到PATH里，因此对于软件包（或者用户）来说将会很容易地设置他们自己的环境变量，而不影响到现有变量的值。\nenv-update 脚本会根据 /etc/env.d/ 里文件的字母顺序来附加变量的值。这些文件名必须要以两位数字开头。\n00basic 99kde-env 99local +-------------+----------------+-------------+ PATH=\"/bin:/usr/bin:/usr/kde/3.2/bin:/usr/local/bin\" 变量并不总是被串联起来，只有下列变量才会被串联： ADA_INCLUDE_PATH, ADA_OBJECTS_PATH, CLASSPATH, KDEDIRS, PATH, LDPATH, MANPATH, INFODIR, INFOPATH, ROOTPATH, CONFIG_PROTECT, CONFIG_PROTECT_MASK, PRELINK_PATH, PRELINK_PATH_MASK, PKG_CONFIG_PATH,和PYTHONPATH。对于( /etc/env.d/) 里的文件中按照字母顺序排列后）其他所有变量，最新定义的值才会被使用到。\n可以通过将变量名添加到 COLON_SEPARATED or SPACE_SEPARATED （也在 /etc/env.d/ 文件）。\n当你运行 env-update的时候，它会在文件/etc/profile.env 里（会被/etc/profile使用）创建所有的环境变量。它也会从变量 LDPATH 中获取信息用来建立/etc/ld.so.conf。这些完成以后，它将运行 ldconfig来重建动态链接器需要的文件/etc/ld.so.cache。\n如果你想在运行env-update后立即看到效果，执行下面的命令来更新你的环境。自己安装过Gentoo的用户可能已经记住了这个安装指南中提到过的命令：\n# env-update \u0026\u0026 source /etc/profile 附注：上面的命令只会更新你当前终端里的环境变量、新控制台以及它们的子程序。因此，假如你正在X11里工作，你要么在每一个你打开的终端里输入source /etc/profile ，要么重新启动X，这样所有新的终端才能引用到新的变量。如果你使用了登录管理器，登陆成root然后输入 /etc/init.d/xdm 。如果不是这样，你需要注销然后重新登录回X这样才能产生使用新变量值的子程序。\n重要：你在定义其他变量时不能使用shell变量。这意味着这样的定义 FOO=\"$BAR\"（此处$BAR 是另外一个变量）是不允许的。\n本地变量的定义 特定用户 你并不是一直都想定义全局变量。比如你想把/home/my_user/bin和当前目录（你当前所在的目录）添加到PATH 变量中，但又不想让其他用户的PATH变量中也有这个。如果你想定义一个本地变量，可以使用 ~/.bashrc 或者~/.bash_profile:\nPATH=\"${PATH}:/home/my_user/bin:\" 当你重新登录的时候，你的PATH变量将被更新。\n特定会话 有时候甚至需要更加严格的定义。你可能要使用一个你临时创建的目录里面的程序，而又不想输入它的路径或者为此短时间内内修改 ~/.bashrc。\n在这种情况下，你只需要在当前会话中使用export来定义 PATH 变量。只要你不注销，PATH变量将保持这个临时的设置。\n# export PATH=\"${PATH}:/home/my_user/tmp/usr/bin\" ebuild Gentoo Development Guide Chinese Ebuild 编写基本指南 一个 ebuild 文件是一个文本文件，供 Gentoo 包管理器使用，它标识一个特定的软件包以及 Gentoo 包管理器应该如何处理它。它使用一个 bash 类似语法风格，并通过 EAPI 版本进行标准化。\nGentoo Linux 使用 ebuild 作为单个软件的包管理格式。这些 ebuild 包含相关软件的元数据（软件的名称和版本、软件使用的许可证和主页）、依赖信息（构建时和运行时依赖）以及有关如何处理的说明使用软件（配置、构建、安装、测试…）。\nGentoo 中 ebuild 的默认位置是 /var/db/repos/gentoo/，该位置由repos.conf文件确定。自定义ebuild建议放在自定义库中，比如/var/db/repos/larry。\nebuild 也是运行各种 ebuild 函数 的 Portage 命令。通过运行以下命令在本地找到相关信息：\n# man 1 ebuild # man 5 ebuild 实时 ebuild\n如果源代码是从修订控制系统 (VCS) 获取的，那么此 ebuild 就是“实时 ebuild”。它们往往（但不一定）具有版本号 9999，以便可以轻松将其与基于上游版本的普通 ebuild 区分开来。\n如果 ebuild 有一个变量 PROPERTIES，其中的值是“live”，那么它就是“实时的”。如果一个 ebuild 继承了一个 VCS eclass（例如 git-r3、mercurial、darcs），它将是实时的，因为这些 eclass 中有一行 PROPERTIES+=\"live\"。\n在 packages.gentoo.org 站点中，实时 ebuild 具有标志 L 。在 eix 的输出中，它用 *l 标记。\n如何创建一个 ebuild vim 的用户自动获取基本骨架（由 app-vim/gentoo-syntax 提供）：\n# vim ./foobar.ebuild 模板\n# Copyright 1999-2022 Gentoo Authors # Distributed under the terms of the GNU General Public License v2 EAPI=7 DESCRIPTION=\"\" HOMEPAGE=\"\" SRC_URI=\"\" LICENSE=\"\" SLOT=\"0\" KEYWORDS=\"~amd64 ~x86\" IUSE=\"\" DEPEND=\"\" RDEPEND=\"${DEPEND}\" BDEPEND=\"\" GNU Emacs 或 XEmacs 用户可以使用类似的工具（分别由 app-emacs/ebuild-mode 或 app-xemacs/ebuild-mode 提供）。\n其他编辑器的用户从 skel.ebuild 手动复制：\n# cp /var/db/repos/gentoo/skel.ebuild ./foobar.ebuild 应该知道新包的基本信息，并将其添加到 ebuild-defined variables。\n给定源压缩包示例 为 Scrub 创建一个 ebuild：\n# mkdir -p /var/db/repos/larry/app-misc/scrub # cd $_ # vim ./scrub-2.6.1.ebuild 模板\n# Copyright 1999-2022 Gentoo Authors # Distributed under the terms of the GNU General Public License v2 EAPI=7 DESCRIPTION=\"Some words here\" HOMEPAGE=\"https://github.com/chaos/scrub\" SRC_URI=\"https://github.com/chaos/scrub/releases/download/2.6.1/scrub-2.6.1.tar.gz\" LICENSE=\"GPL-2\" SLOT=\"0\" KEYWORDS=\"~amd64 ~x86\" IUSE=\"\" DEPEND=\"\" RDEPEND=\"${DEPEND}\" BDEPEND=\"\" 允许在SRC_URI中使用${PN} variable，但不建议。虽然它可能会缩小这条线，但一些 reasoning why not to use it也值得考虑。\nSRC_URI=\"https://github.com/chaos/${PN}/releases/download/${PV}/${P}.tar.gz\" 可以使用ebuild命令来测试它:\n# ebuild ./scrub-2.6.1.ebuild clean unpack 这应该下载并解压源压缩包。在极少数情况下，包应该可以工作，并且不需要在 ebuild 中进一步调整。\n打补丁 如果源代码需要打补丁，可以从 patches文章中解释的解压源代码创建补丁。\n补丁将被列在一个名为PATCHES的数组中，正如devmanual中所解释的那样。\nPATCHES=( \"${FILESDIR}\"/${P}-foo.patch \"${FILESDIR}\"/${P}-bar.patch ) src_prepare() { default ... } 初探 ebuild 2015-10-05\n无论你使用过多少/多久其他的 Linux 发行版，初次接触 Gentoo 时，极有可能会觉得它在软件包的安装方面很神奇。若要在 Gentoo 中安装一个软件包，通常要定义如何进行软件源代码包的下载、解包、打补丁、编译、安装以及合并。为了实现对软件包进行细微的定制，还需要定义一些有用的元数据（即 USE 旗标）、补丁文件以及一些操控软件包编译与安装的过程。Gentoo 是通过 GNU Bash shell 脚本来定义这一切，这种脚本就是所谓的 ebuild 文件。\nebuild 在哪里？ 我们在安装 Gentoo 时，一个必须的步骤是下载一个 Portage 树的镜像包，解包后通常安置于 /var/db/repos/gentoo 目录，之后每次执行 emerge --sync 时，便会根据官方远程网站上的 Portage 树来更新你本地的 Portage 树。\n粗枝大叶的看，Portage 树有四层结点。根结点便是 /var/db/repos/gentoo 目录，第 2 层结点是软件包所属分类目录，第 3 层结点是软件包的名称目录，叶子结点则是 ebuild 文件以及其他辅助性文件或目录。以 gnome-shell-3.12.2.ebuild 文件为例，它在 Portage 树中的完整路径是 /var/db/repos/gentoo/gnome-base/gnome-shell/gnome-shell-41.1.ebuild。\n对于我们期望的软件包，如果 Portage 树未提供针对它的 ebuild 文件，那么我们需要自己动手丰衣足食。一般是不建议将我们所写的 ebuild 文件放在 Portage 树中的，因为它们可能会在 emerge --sync 期间被冲刷（比如被官方的同名文件替换）。\nPortage 树支持一种被称为 Overlay 的技术。简单来说，就是我们可以另行建立一棵新的 Portage 树，这棵树的规模虽然比官方的 Portage 树小很多，但是 Portage 树的管理系统可以将这可新的 Portage 树与官方 Portage 树『合并』。如果新的 Portage 树中某些结点与官方的 Portage 树存在重叠，那么 Portage 树的管理系统会以前者覆盖后者，因此我们新建的 Portage 树通常被直呼为『Overlay』。\n建立自己的 Overlay 在 /var/db/repos/ 目录中创建自己的 Overlay：\n# mkdir -p /var/db/repos/localrepo/{metadata,profiles} # chown -R portage:portage /var/db/repos/localrepo 在该 /var/db/repos/localrepo/profiles/ 内添加 repo_name 文件。我们可以在这份文件中设置 Overlay 名称，只需将 Overlay 名称写入该文件即可。例如，我将我的 Overlay 命名为 localrepo：\n# echo 'localrepo'  /var/db/repos/localrepo/profiles/repo_name 为了让我们的 Overlay 能够被 Portage 管理系统所接受，需要在 /var/db/repos/localrepo/metadata/layout.conf 内添加：\nmasters = gentoo auto-sync = false 需要将 Overlay 路径告知 Portage 管理系统，即在 /etc/portage/repos.conf/localrepo.conf 文件中添加以下代码：\n[localrepo] location = /var/db/repos/localrepo 今后，就在这个 Overlay 中学习 ebuild 文件的编写。\nHello World! 下面通过写一个非常简单的 ebuild 文件来获取一些直观的认识。假设在 app-misc 这个分类中有一个名为 hello-world 的软件包，现在我们要为这个软件包的 1.0 版的安装写一份 ebuild 文件。\n 注意：软件包的分类名并不是随意的，它必须要与 /var/db/repos/gentoo 中的某个子目录名一致。\n 首先在 Overlay 中建立软件包所在的分支：\n# mkdir -p /var/db/repos/localrepo/app-misc/hello-world 可从 /var/db/repos/gentoo/header.txt 文件中获得 ebuild 文件默认的文件头，即：\n# Copyright 2021 Gentoo Authors # Distributed under the terms of the GNU General Public License v2 只不过是一些 Bash 脚本注释形式的文件描述信息而已，但它们是必须的。可以直接将 /var/db/repos/gentoo/header.txt 文件复制为 hello-world-1.0.ebuild 文件，这样便可获得一个含有上述内容的空 ebuild 文件。ebuild 文件的名称必须符合 Portage 所认可的格式，即：软件包名称-版本号.ebuild。这一点很重要。\n# cp /var/db/repos/gentoo/header.txt /var/db/repos/localrepo/app-misc/hello-world/hello-world-1.0.ebuild 下面，为这份 ebuild 文件增加以下内容：\nSLOT=\"0\" 这样，我们便建立了一份最为简单的 ebuild 文件。接下来就是在这份文件上签个字……也就是为之生成一份签名文件，表示这个 ebuild 的是我们做的，出了事我们负责。\n# cd /var/db/repos/localrepo/app-misc/hello-world # ebuild ./hello-world-1.0.ebuild manifest 若签名成功，会在 ebuild 文件同一目录中生成一份名为 Manifest 的文件。将来发布这份 ebuild 文件时，需要将数字签名文件一起发出，这样他人便可以验证这份 ebuild 是不是我们做的。因为非常有可能我们在向朋友们发送 ebuild 文件的过程中会被坏人拦截，然后篡改 ebuild 文件。由于 ebuild 是可被系统执行的脚本，因此很有可能变成『病毒』。因此，ebuild 文件的数字签名非常有必要。不过，这里为了简单起见，没有涉及如何用自己的密钥实现对 ebuild 的签名，所得 Manifest 文件仅仅是为了让 ebuild 能够被 Portage 管理系统所认可。\n下面，继续向这份 ebuild 加入一些内容，使之变为：\n# Copyright 2021 Gentoo Authors # Distributed under the terms of the GNU General Public License v2 EAPI=\"7\" SLOT=\"0\" DESCRIPTION=\"A classical example to use when starting on something new.\" HOMEPAGE=\"http://wiki.gentoo.org/index.php?title=Basic_guide_to_write_Gentoo_Ebuilds\" LICENSE=\"MIT\" KEYWORDS=\"~alpha ~amd64 ~arm ~hppa ~ia64 ~ppc ~ppc64 ~s390 ~sh ~sparc ~x86\" 基本上就是在原来那份最简单的 ebuild 文件的基础上增加了几个变量：\n EAPI：Portage 系统已经为我们编写了许多有用的 Bash 函数，将 EAPI 的值设为 7 表示我们要用目前最新的 Bash 函数。这个变量必须要在 ebuild 文件头之后进行设定。 DESCRIPTION：这个变量存储了 hello-world 这个软件包的简介信息。 HOMEPAGE：定义了 hello-world 这个软件包的项目主页。 LICENSE：定义了 hello-world 这个软件包所使用的许可证，例如 LGPL，GPL V2，GPL V3，MIT 等。 KEYWORDS：如果你期望 hello-world 这个软件包能够安装在你的机器上，那么 KEYWORDS 变量的值必须要包含你在 /etc/make.conf 中所设定的 ACCEPT_KEYWORDS 值。  一旦改动了 ebuild 文件内容，那么必须重新生成 Manifest 文件：\n# ebuild ./hello-world-1.0.ebuild manifest 现在，便可以使用 emerge 命令安装这个目前依然是子虚乌有的软件包了。\n# emerge -a hello-world These are the packages that would be merged, in order: Calculating dependencies... done! [ebuild N ~] app-misc/hello-world-1.0::localrepo 0 KiB Total: 1 package (1 new), Size of downloads: 0 KiB 虽然到现在为止，还是什么也没有做出来，但是看着 emerge 神奇的发现了我写的 ebuild，心底还是蔓生了一些幸福。\nemerge 与 ebuild 有什么联系？ 简单的说，就是 emerge 这个 Python 脚本会调用 ebuild.sh 这个 Bash 脚本，让后者去执行 ebuild 文件定义的软件包的下载、编译及安装过程。\nebuild.sh 所操控的软件包安装过程是在一个沙箱（Sandbox）中进行的。这一过程结束后，emerge 脚本需要将沙箱中的成果转移到真实世界，即 / 目录。\nSLOT SLOT, 即「槽」, 和具体某个包相关的概念, 是Gentoo实现多版本共存的基础。\n0 是默认的slot名, 表示没有使用slot;\nslot名是空字符串表示彻底禁止使用slot;\n带有slot的包, 包名后面会有:冒号分隔, 并带上slot, 如:\ndev-python/dnspython-1.12.0-r200:py2 dev-python/dnspython-1.12.0-r300:py3 表示dnspython这个包分别有py2和py3两个slot。\n相关的一些命令:\neix 可以直接查看包的所有slot:\n$ eix dnspython * dev-python/dnspython Available versions: (py2) 1.12.0-r200 (py3) 1.12.0-r300 {examples test PYTHON_TARGETS=\"python2_7 python3_3 python3_4\"} Homepage: http://www.dnspython.org/ https://pypi.python.org/pypi/dnspython Description: DNS toolkit for Python equery list -p:\n$ equery l -po dnspython * Searching for dnspython ... [-P-] [ ] dev-python/dnspython-1.12.0-r200:py2 [-P-] [ ] dev-python/dnspython-1.12.0-r300:py3 [-P-] [ ~] dev-python/dnspython-1.12.0-r301:py3 equery keywords:\n$ equery keywords dnspython Keywords for dev-python/dnspython: | | u | | a a a n p r s | n | | l m r h i m m i p i s p | u s | r | p d a m p a 6 i o p c s 3 a x | s l | e | h 6 r 6 p 6 8 p s p 6 c 9 s r 8 | e o | p | a 4 m 4 a 4 k s 2 c 4 v 0 h c 6 | d t | o ------------+---------------------------------+-------+------- 1.12.0-r200 | + + + ~ + + o o o + + o ~ ~ + + | o py2 | gentoo ------------+---------------------------------+-------+------- 1.12.0-r300 | + + + ~ + + o o o + + o ~ ~ + + | o py3 | gentoo 1.12.0-r301 | ~ ~ ~ ~ ~ ~ o o o ~ ~ o ~ ~ ~ ~ | o | gentoo 真实的 Hello World！ 在一个遥远的地方，真的存在着 hello-world 的源码包。我们只要通过 ebuild 文件将这个源码包的位置告诉 ebuild.sh 脚本，ebuild.sh 便会不远万里将其擒来。所以，我们需要在 hello-world-1.0.ebuild 文件中添加以下内容：\nSRC_URI=\"https://gitlab.com/alogim/gentoo-basic-ebuild/-/raw/master/update1/hello-world-1.0.tar.gz?inline=false\" SRC_URI 这个变量便是存储源码包的下载地址的。\n在重新生成 Manifest 时，ebuild.sh 便会自动将源码包下载到 /var/cache/distfiles/ 目录，并为这个源码包也生成一个数字签名存储在 Manifest 文件中。\n既然有了 hello-world 的源码包，那么下一步就该思考如何在 ebuild 文件中定义这个源码包的编译过程了。不过，解开刚才下载的 hello-world-1.0.tar.gz 包看一下，发现包里只有一份 Bash 脚本 hello-world，其内容为：\n#!/bin/sh  echo \"Hello world!\" 所以，这个源码包就没必要编译了，直接安装到系统中即可。从而，我们在 ebuild 文件中获得了第一次编写 ebuild 函数的机会。在现有的 hello-world-1.0.ebuile 的文件中继续添加以下内容：\nsrc_install() { dobin hello-world } src_install 是 ebuild.sh 脚本能够识别并执行的函数名。也就是说，从 ebuild.sh 脚本的角度来看，你若想让我替你将软件包安装至系统中，那么你必须得按照我的习惯来。我的习惯就是在你提供给我的 ebuild 文件中寻找 src_install 这个函数，如果有这个函数，我就执行它，否则我就什么也不做。这就是 ebuild.sh 与 ebuild 文件之间达成的一个约定。\n现在我们在 ebuild 文件中向 ebuild.sh 提供了 src_install 这个函数。这个函数只包含一条命令：dobin hello-world 。这个命令的意思是为 hello-world 这个脚本设置可执行权限，然后将其安装至系统默认的可执行文件目录中，即 /usr/bin 目录。\nsrc_install 只是 ebuild.sh 与 ebuild 文件之间众多约定函数中的一个而已，并且这些约定函数是顺次被 ebuild.sh 执行的，如下图所示：\n这里存在一个问题，hello-world 这个 Bash 脚本是包含在 hello-world-1.0.tar.gz 这个包内的，而我们只在 hello-world-1.0.ebuild 文件中定义了 src_install 函数，那么 hello-world-1.0.tar.gz 何时被解包的呢？这个问题的答案是，Portage 管理系统中已经为这些约定的函数定义了默认行为。比如，用于为源码包解包的 src_unpack 函数，其默认的定义是：\nsrc_unpack() { if [ \"${A}\" != \"\" ]; then unpack ${A} fi } 如果在 ebuild 文件中没有重新定义 src_unpack 函数，那么 ebuild.sh 便会按照上面图示的管线调用默认的 src_unpack 函数。所以 hello-world 脚本得以从 hello-world-1.0.tar.gz 中解出。\n对现在的 hello-world-1.0.ebuild 再次生成 Manifest，然后就可以用它将 hello-world 脚本安装至 /usr/bin 目录中了。\n这就是我们用自己写的 ebuild 安装的第一个『软件包』。\nebuild repository An ebuild repository, colloquially known as an overlay, is a structure of directories and files used to add and extend software packages for a Gentoo-based system.\nEbuild repositories contain ebuilds, eclasses, and other types of descriptive metadata files. These files inform the package manager of software available for installation, news items, and profile targets. An ebuild repository should conform to one or more Ebuild APIs as detailed in Gentoo’s Package Manager Specification.\nThe Gentoo ebuild repository, as Gentoo’s primary and “official” repository, is the source for all the information needed to build and install Gentoo packages, contained in ebuilds.\nAdministrators of Gentoo systems can add additional ebuild repositories by using various utilities and methods described below.\nThe Gentoo ebuild repository The Gentoo ebuild repository will sometimes be called by shorter, or even colloquial, names, such as the Gentoo repository, the Gentoo repo, ::gentoo, gentoo.git, or occasionally just the “repo”. It was historically known within the Gentoo community as the Portage tree, rsync tree, or sometimes just “the tree”.\nRepositories in general Repositories are handled through /etc/portage/repos.conf (which, like many other Portage configuration locations, can be a file or a directory), and the eselect repository is is a tool to manage this configuration.\nRepository definitions inside /etc/portage/repos.conf also inform Portage if and how the repository can be updated. With it, calling emaint sync –auto will automatically update the enabled repositories as well.\nA deprecated, yet still supported method is to use the PORTDIR_OVERLAY variable inside /etc/portage/make.conf. This variable can point to one or more additional locations on the file system where additional repositories are available. The use of the /etc/portage/repos.conf/ directory is highly preferred.\nFor more information, see /etc/portage/repos.conf and the Portage/Sync article.\nPriorities Ebuilds from repositories with higher priority numbers (for example 60) will take precedence over ebuilds from repositories with lower priorities (such as 50).\nThe list of ebuild repositories with their priorities can be obtained through the output of the following commands (look for the “Repositories” string):\n# emerge --info --verbose # portageq repos_config / The Gentoo ebuild repository will have a priority of -1000 which means that all other repositories generally take precedence if they are assigned a higher priority. This is the default behaviour, because ebuild repositories are designed to “lay over” or “on top” of the Gentoo repository. To set the priority of other repositories, manually edit the relevant repos.conf section and set priority = to the desired value. For example:\n# nano -w /etc/portage/repos.conf/eselect-repo.conf [guru] location = /var/db/repos/guru sync-type = git sync-uri = https://github.com/gentoo-mirror/guru.git priority = 100 Repositories that do not have a priority set default to 0.\nRepository synchronization Repository synchronization is generally managed with the emaint sync command. See the Portage sync article, and man emaint for information on how to use the portage synchronization commands.\nThe emerge –sync command is now only a compatibility command, calling the emaint module. eix-sync is a wrapper using emerge –sync, followed by eix-update. For further details see the Eix article and man eix.\nThe emerge-webrsync tool can be used to download and install the daily Gentoo Repository snapshot. This may help with firewall restrictions.\nRepository management tools eselect-repository eselect repository maintains /etc/portage/repos.conf entries for Portage to access and synchronize.\nLayman eselect repository supersedes layman for most uses.\nUsage Emerging a duplicate package When working with ebuild repositories it is possible to encounter a situation where multiple versions of the same package are available from different ebuild repositories. Instruct Portage to install a specific package from a specific ebuild repository with the :: version specifier:\n# emerge --ask category/atom::repository-name The same notation can be used for different emerge instructions, including uninstalling a package through --depclean.\nBest practices Cache generation When large ebuild repositories are installed, Portage may take a long time to perform operations like dependency resolution. This is because ebuild repositories do not usually contain a metadata cache.\nGenerate a local metadata cache by running emerge –regen after syncing the ebuild repositories:\n# emaint sync --allrepos # ( ulimit -n 4096 \u0026\u0026 emerge --regen ) Be careful, because emerge –regen takes a lot of time and it’s not recommended for rsync users as rsync updates the cache using server-side caches (most of users of portage are rsync users). Rsync users should simply run emerge –sync (or eix-sync) to regenerate the cache. It’s probably only users of very large ebuild repositories should try emerge –regen.\nMasking enabled ebuild repositories When using large ebuild repositories or those with unknown/low quality code, it is best practice to hard mask the whole ebuild repository and only accept specific ebuilds on a case-by-case basis. For example, for an overlay named “repository-foobar”:\n# nano -w /etc/portage/package.mask/repository-foobar */*::repository-foobar Then add the specific package(s) from the repository-foobar overlay so that they will be available visible to Portage for installation:\n# nano -w /etc/portage/package.unmask/bar foo-category/bar::repository-name After the above unmask the package named “foo-category/bar” should be available and none of the other packages from the repository-foobar overlay will be available, which is by design.\nProject:Portage/Sync The new plug-in sync system is the next step in that migration. Using PORTDIR and PORTDIR_OVERLAY in make.conf could only list where the repository was location. Users could not specify other important attributes about that repository. The repos.conf style configuration allows for settings to be added on a per sync-type basis. Along with this new expandability and the plug-in sync system, it will be much easier to change to new repository syncing methods.\nGeneral help Note: While Portage can handle repos.conf as either a file or a directory of files. The preferred method is to be used as a directory. Other tools like layman and mirrorselect require and expect it to be a directory. Layman creates and manages its own layman.conf file to register installed overlays with Portage. mirrorselect looks for repos.conf/gentoo.conf file in order to modify the sync-uri parameter for the gentoo repository.\nMigration Portage configuration\nIf the /etc/portage/repos.conf directory does not exist:\n# mkdir /etc/portage/repos.conf # cp /usr/share/portage/config/repos.conf /etc/portage/repos.conf/gentoo.conf Then edit the file for your installation and desired settings, continue as needed with the remaining migration instructions. Edit all repos.conf/*.conf files, add the auto-sync option to each defined repository.\nFor sync-type, edit it to one of the installed supported types.\nCurrent supported sync types include:\n rsync git svn webrsync or websync (equivalent to running emerge-webrsync separately). cvs laymansync (if installed by Layman)  Example local overlay sync-able from a git backup:\n# nano -w /etc/portage/repos.conf/gentoo.conf [DEFAULT] main-repo = gentoo [gentoo] location = /var/db/repos/gentoo sync-type = git sync-uri = https://github.com/gentoo-mirror/gentoo.git auto-sync = yes priority = 1000 The above overlay can be synced with\n# emaint sync -r gentoo Operation Primary control of all sync operations has been moved from emerge to emaint. emerge –sync now runs the emaint sync module with the --auto option. This --auto option performs a sync on only those repositories with the auto-sync setting set to yes or true. If the auto-sync option is not set to yes or is absent, then emerge –sync may not sync any repositories.\nNote: As a result of the default auto-sync = True/Yes setting, commands like eix-sync, esync -l, emerge –sync \u0026\u0026 layman -S will cause many repositories to be synced multiple times in a row. Please adjust configuration files or scripts as necessary for the new operation.\nWarning: Due to the above default. For any repositories (repos) that you EXPLICITLY do not want to be synced. You MUST set auto-sync = no\nExamples # emaint sync -a Equivalent to emerge –sync. Sync all repositories where auto-sync = true is set.\nNote: Due to the default auto-sync = true setting, this command will sync all repositories that do not have auto-sync = no explicitly set.\n# emaint sync -r foo Sync the foo repo (ignores auto-sync setting):\n# emaint sync --allrepos Sync all repositories with a valid sync-type and sync-url defined. (ignores auto-sync setting)\n显卡驱动 在之前安装 Gentoo Linux 的过程中，二进制内核本身已自带了大多数显卡的内核驱动部分，该部分负责接收用户空间发送的指令及数据，进行处理后传递给显卡。\nmake.conf 对于 X 而言，这里以现代化的 N 卡为例，编辑 /etc/portage/make.conf 文件，双显卡 Intel+NVIDIA 添加以下内容：\n# echo 'VIDEO_CARDS=\"intel i965 iris nvidia\"'  /etc/portage/make.conf  Intel 的一般设为 intel i965 iris， 详细查阅： https://wiki.gentoo.org/wiki/Intel。 N 卡开源驱动一般设为 nouveau， 详细查阅： https://wiki.gentoo.org/wiki/Nouveau。如若你的显卡是较新的 N 卡，开源驱动还未支持，请安装闭源驱动。 N 卡闭源驱动一般设为 nvidia， 详细查阅： https://wiki.gentoo.org/wiki/NVIDIA/nvidia-drivers。 amdgpu 用于给 X 开启 2D 驱动（X 下必须），radeonsi 用于给 OpenGL 的实现 mesa 开启对内核下 amdgpu 驱动的支持（无论 X 还是 Wayland 均需配置），如果 A 卡比较老，则额外添加 radeon 值，详细查阅： https://wiki.gentoo.org/wiki/AMDGPU。 虚拟机下的驱动设置得具体看，比如现在的 VirtualBox 和 VMWare 都用 vmware 驱动，那么就设置值为 vmware，再比如 QEMU 可选使用 virgl 驱动，那么就设置为 virgl。  在这里，还需将之前配置的普通用户 kurome 添加到 video 组下以使用硬件加速功能。执行\n# gpasswd -a kurome video # or # groupmod -a video -U kurome 驱动 Intel # emerge -av xorg-server xf86-video-intel nvidia # emerge -av nvidia-drivers xrandr 禁用 nouveau：\n# cat  /etc/modprobe.d/blacklist.conf blacklist nouveau blacklist lbm-nouveau options nouveau modeset=0 要起作用，需要重启。\nNVIDIA/Optimus 注意：请安装完成桌面环境后再来看这部分。\n一般情况下，intel + nvidia 用混合模式。\nxorg.conf For a laptop with Intel integrated graphics and Nvidia discrete graphics, the following xorg.conf should be sufficient:\n# mkdir -p /etc/X11/xorg.conf.d/ # nano /etc/X11/xorg.conf.d/10-nvidia.conf Section \"ServerLayout\" Identifier \"layout\" Screen 0 \"nvidia\" Inactive \"intel\" EndSection Section \"Device\" Identifier \"nvidia\" Driver \"nvidia\" BusID \"01:00:0\" Option \"RegistryDwords\" \"EnableBrightnessControl=1\" EndSection Section \"Screen\" Identifier \"nvidia\" Device \"nvidia\" Option \"AllowEmptyInitialConfiguration\" EndSection Section \"Device\" Identifier \"intel\" Driver \"modesetting\" EndSection Section \"Screen\" Identifier \"intel\" Device \"intel\" EndSection 有朋友会问，BusID 是否需要根据自己的改一改，我觉得可能不用，我用过 intel + nvidia 的3台笔记本，这个 BusID 都没有变过，还来自不同厂家，小米，Thinkpad，雷蛇。\n也可以通过如下命令确认一下：\n$ lspci | grep -i --color 'vga\\|3d\\|2d' 00:02.0 VGA compatible controller: Intel Corporation UHD Graphics 620 (rev 07) 01:00.0 3D controller: NVIDIA Corporation GM108M [GeForce 930MX] (rev a2) gdm 编辑/usr/share/gdm/greeter/autostart/optimus.desktop 和 /etc/xdg/autostart/optimus.desktop 文件。写入的内容均一样：\n[Desktop Entry] Type=Application Name=Optimus Exec=sh -c \"xrandr --setprovideroutputsource modesetting NVIDIA-0; xrandr --auto\" NoDisplay=true X-GNOME-Autostart-Phase=DisplayServer sddm 编辑 /etc/sddm.conf 文件，内容如下：\n[X11] DisplayCommand=/etc/sddm/scripts/Xsetup 下面创建一个脚本目录：\n# mkdir -p /etc/sddm/scripts 创建启动脚本，cat  /etc/sddm/scripts/Xsetup ，内容如下：\n#!/bin/sh xrandr --setprovideroutputsource modesetting NVIDIA-0 xrandr --auto 最后赋予权限：\n$ chmod u+x /etc/sddm/scripts/Xsetup 无显示管理器 修改 ~/.xinitrc：\n#!/bin/bash xrandr --setprovideroutputsource modesetting NVIDIA-0 xrandr --auto xrdb -merge ~/.Xresources [ -f ~/.xprofile ] \u0026\u0026 source ~/.xprofile exec dbus-launch --exit-with-session startplasma-x11 前两行为必填，后两行为启动X11时同时加载这两个文件。\n编写一个简单脚本：假设名字为 sx.sh\n#!/bin/bash sudo modprobe nvidia_drm nvidia_modeset nvidia \u0026\u0026 startx 授权启动\n$ chmod u+x sx.sh $ ./sx.sh KDE KDE 是一个自由软件社区，其提供了一组应用程序，包括流行的 Plasma 桌面环境。\nGentoo对KDE项目的支持非常好，包括对KDE Frameworks 5，Plasma 5和Applications的全面支持，以及其他各种各样基于KDE的软件。\nProfile 在安装心仪的 DE/WM 之前，建议切换到的 desktop profile 下，执行\n# eselect profile list 以列出所有的 profiles，然后进行选择。例如：\nopenrc 下，可以选择\n amd64/17.1/desktop amd64/17.1/desktop/gnome amd64/17.1/desktop/plasma  systemd 下，可以选择\n amd64/17.1/desktop/systemd amd64/17.1/desktop/gnome/systemd amd64/17.1/desktop/plasma/systemd  如若只想安装轻量级的窗口管理器，那么可以选择类似 amd64/17.1/desktop 一样的纯 desktop profile。\n根据本文上下文环境，这里我选择 amd64/17.1/desktop/plasma 以准备好 KDE Plasma 的前期环境\n# eselect profile set 9 虽然 desktop profile 下已经配置启动了基本的 ALSA 声音接口功能，但个人建议再启用 PulseAudio 声音服务器以获得更多功能。只需编辑 /etc/portage/make.conf 文件，设置\necho 'USE=\"pulseaudio\"'  /etc/portage/make.conf 切换到 desktop profile 并不是一个必须的操作，也可以在基础的 profile 或者其它的 profile 下进行，但如果这样的话，则需要再自行额外配置，会相对复杂一点，此处不多做说明。\nPlasma Plasma 5 是 KDE 正在发展的一代桌面环境，基于 Qt 5 和 KDE Framework 5 。\n安装 kde-plasma/plasma-meta 包提供完整的 Plasma 5 桌面，执行此命令将 plasma-meta 这个元包添加到 world set 中：\n# emerge --ask kde-plasma/plasma-meta 你也可以选择安装 kde-plasma/plasma-desktop，它提供了一个非常基本的桌面，让用户可以自由安装他们需要的额外软件包 - 或者更确切地说，让他们自己找出并补全缺少的功能。\n警告：请注意，仅安装kde-plasma/plasma-desktop会丢失重要的软件包，例如kde-plasma/powerdevil（电源管理，挂起和休眠选项），kde-plasma/systemsettings等等，在这种情况下都不会被支持。\n小工具\nkde-plasma/kdeplasma-addons 提供了很多有用的小工具 (早就被 kde-plasma/plasma-meta作为依赖安装了)：\n# emerge --ask kde-plasma/kdeplasma-addons 显示管理器\nSDDM （Simple Desktop Display Manager） 是被推荐的登录管理器并且它默认会通过 kde-plasma/plasma-meta 被自动安装。 另外你也可以选择使用 LightDM ,这需要为 kde-plasma/plasma-meta 设置 -sddm 的 USE 旗标， 同时还要修改 /etc/conf.d/xdm 中的设置。 同时在发生错误时请阅读 SDDM 页面。\n如果是其它的 DM 也是启用对应的服务即可。\n# systemctl enable sddm.service 无显示管理器\nPlasma 可以用startx以老式方式启动，但需要格外小心以确保它获得有效的会话。创建 ~/.xinitrc 文件：\n#!/bin/sh exec dbus-launch --exit-with-session startplasma-x11 这也可以写入~/.profile文件中，该文件将在登录时执行。\ndbus-launch --exit-with-session startplasma-wayland 系统托盘 Plasma 5 对系统托盘图标使用StatusNotifier规范。由于并非所有应用程序都已移植到新系统，因此需要一些应变方法，并且 Plasma 5 也具有将旧的基于xembed的系统托盘图标转换为StatusNotifier图标的方法。\n通过激活kde-plasma/plasma-meta的 legacy-systray 来启用传统支持，这将引入kde-plasma/xembed-sni-proxy。编辑 /etc/portage/package.use/kde-plasma-settings\n# xembed system tray support for legacy applications kde-plasma/plasma-meta legacy-systray Pidgin net-im/pidgin 需要 x11-plugins/pidgin-indicator。安装完成后，在 工具|插件 下可以找到 Ubuntu 指示器 插件。\nKWallet 在登录桌面后添加一个（无线）网络连接或者在kde-apps/kmail中添加一个电子邮箱账户时，许多用户被推荐使用 kde-frameworks/kwallet —— Plasma桌面的加密密码存储器。\n有个软件包kde-apps/kwalletmanager，可用于管理KWallets，导入及导出密码：\n# emerge --ask kde-apps/kwalletmanager KWallet 自动解锁\nkde-plasma/kwallet-pam 提供了一种机制，可以避免在登录后即被要求访问kwallet。\n# emerge --ask kde-plasma/kwallet-pam 需要如下的配置：\n 为了KWallet的安全性，请使用比较传统的blowfish加密，而不是GPG 在kwallet和用户使用相同的密码 让登录管理器支持PAM特性 - x11-misc/sddm 和 x11-misc/lightdm 都支持  通过SDDM解锁KWallet PAM的配置行，编辑 /etc/pam.d/sddm：\n-auth optional pam_kwallet5.so -session optional pam_kwallet5.so auto_start 附注：对于LightDM， 需要自己编辑/etc/pam.d/lightdm\n附注：如果在登录时，存有你的用户的KWallet文件的文件系统已经被pam_mount挂载，你可能需要将~/.local/share/kwalletd/kdewallet.salt复制到你的根文件系统的相同路径下。否则，PAM会在主目录可用之前尝试解锁KWallet并失败。实际包含加密的KWallet密码的文件~/.local/share/kwalletd/kdewallet.kwl不需要复制。\n禁用 KWallet\n要完全禁用KWallet子系统，请编辑 ~/.config/kwalletrc：\n[Wallet] Enabled=false SSH/GPG 密钥启动/关闭脚本 ssh-agent 脚本位于 /etc/xdg/plasma-workspace/env 和 /etc/xdg/plasma-workspace/shutdown。关闭脚本需要设置可执行位，因为它们不是源。Keychain 提供了更多信息\nUsing keychain with Plasma 5 Keychain is a frontend to ssh-agent and ssh-add, allowing long running sessions and letting the user enter passphases just once. It can also be used to allow scripts access to SSH connections.\n# emerge --ask net-misc/keychain Plasma 5 users, instead of using ~/.bash_profile, can let Plasma manage ssh-agent for them. In order to do so, edit /etc/xdg/plasma-workspace/env/10-agent-startup.sh, which is read during Plasma’s startup, and /etc/xdg/plasma-workspace/shutdown/10-agent-shutdown.sh, which is executed during its shutdown.\nHere is how one could edit those files:\nEditing /etc/xdg/plasma-workspace/env/10-agent-startup.sh for Plasma 5\nSSH_AGENT=true Editing /etc/xdg/plasma-workspace/shutdown/10-agent-shutdown.sh for Plasma 5\nif [ -n \"${SSH_AGENT_PID}\" ]; then eval \"$(ssh-agent -k)\" fi Now, all that has to be done is launch a terminal of choice, like kde-apps/konsole, and load the right set of keys to use. For example:\n$ keychain ~/.ssh/id_rsa The keys will be remembered until the end of the Plasma session (or until the ssh-agent process is killed manually).\n使用root权限运行 GUI 应用 警告：使用root权限启动 GUI 应用可能是一个 非常 坏的主意。相比之下，更好的办法是将常规用户添加到相应的组或者只是无提权地运行命令。只有在绝对必要时才使用 kdesu 。\nKDE Plasma有一个实用程序，用于以root权限启动图形应用。它由kde-plasma/kde-cli-tools提供 - 要使用 USE 标志kdesu构建。这将会安装kde-frameworks/kdesu的一个图形前端。这依赖Xorg，并且仅在X内有效。编辑 /etc/portage/package.use/kde-plasma-settings\n# Build graphical frontend for kde-frameworks/kdesu (requires X) kde-plasma/kde-cli-tools kdesu X 记得要重建软件包以获取更改：\n# emerge -1 kde-cli-tools 可以通过从KRunner或终端仿真器调用kdesu来使用它：\n# kdesu  将显示一个消息对话框，提示输入root密码。\n附注：出于安全原因，某些应用（如kwrite、dolphin等）拒绝使用kdesu打开。\n应用程序 发行版本包含很多基于 Qt 5/KDE Frameworks 5 的应用程序和支持库。\n安装 kde-apps/kde-apps-meta 包提供完整的应用程序集合，但是可替代地，可以挑选其中一个或多个较小的元包。\n个人建议没必要使用默认设置来安装 kde-apps/kde-apps-meta 包，因为会引入太多不常用的应用，建议根据 USE 来管理（下文 USE 标记一节有说明），选择性安装，即\n# echo 'kde-apps/kde-apps-meta -*'  /etc/portage/package.use/kdeapps 同时取消 kdecore-meta 的 webengine 依赖，以减少当下的编译时间\n# echo 'kde-apps/kdecore-meta -webengine'  /etc/portage/package.use/kdeapps 安装最核心的 KDE 应用，其它 KDE 应用根据需要安装即可\n# emerge --ask kde-apps/kde-apps-meta 本地化 Plasma-5 和应用程序的每个包都提供了本地化文件。可以在系统设置中启用本地化。\nKDE PIM KDE PIM 是一整套用于管理个人信息的应用程序，包括邮件，日历，联系人等。它有几个可选的运行时依赖来扩展其功能：\n 病毒检测：app-antivirus/clamav 垃圾邮件过滤：mail-filter/bogofilter 或 mail-filter/spamassassin  框架 KDE Frameworks 5 是一套运行库和软件框架的合集，为KDE Plasma 5 和 KDE 应用提供基础，但是可能会受到一些 Qt 程序的影响。\nKDE 框架大部分是运行库，只提供少量的面对用户的功能。它不需要被手动安装 —— 需要的软件包会被作为别的软件包的依赖自动安装。\n更多KDE软件 最主要的 KDE 应用程序在 Porage 树的 kde-apps 和kde-misc 分类中。\nTips How to reset KDE / display settings after a move to a new machine I had to remove .local/share/kscreen on plasma5\nGNOME GNOME 是一个流行的能够启动 Xorg 和 Wayland 会话的 桌面环境 。本指南 尝试描述 GNOME 的所有方面，包括安装、配置和使用。\n从 3.30 版本开始，Gentoo 上的 GNOME 能够再次在 OpenRC 上运行。详情参见 Mart Raudsepp (leio) 的 blog post。\n什么是 GNOME? 项目 GNOME 项目是一个自由的软件组织，它致力于 GNOME 的发展，Unix/Linux 桌面套件和开发平台。 GNOME 基金会协调发展 GNOME 项目的其他方面。\n软件 GNOME 是一个桌面环境和一个开发平台。这款自由软件是包括 Canonical (Ubuntu) 和 Red Hat（Red Hat Linux、Fedora、Centos）在内的多个行业领导者的首选桌面。\n准备 从历史上看，Xorg 显示服务器是 Linux 上所有桌面环境的标准显示基础。对于 GNOME 3 及更高版本，已经开始转向更新的 Wayland 显示服务器协议。NVIDIA 以外的系统在 Wayland 上运行 GNOME 会话没有问题。\n也就是说，退一步讲，最好先阅读并按照 Xorg 指南 中设置 X 环境的说明。\n根据 GNOME 上游的说法，GNOME 3 是用 systemd 初始化系统编写的。因此，systemd 用户最好从 systemd 文章中阅读并遵守所有必要的内核设置。\n安装 在安装 GNOME 套件之前，编辑系统的 USE 变量是个好主意。 Gentoo 开发人员提供了一个 GNOME 特定配置文件，以帮助对 GNOME 软件堆栈进行系统范围的调整。在安装 GNOME 之前选择最新且稳定的 GNOME 特定配置文件。\n使用 logind 的 OpenRC 用户可以选择此特定配置文件：\n# eselect profile set default/linux/amd64/17.1/desktop/gnome systemd 用户将会选择以下 profile：\n# eselect profile set default/linux/amd64/17.1/desktop/gnome/systemd 确保 X、gtk 和 gnome 位于 /etc/portage/make.conf 中的 USE 变量中。 建议启用对 D-Bus 系统范围的支持。 systemd 包括这个系统消息总线。 也将 systemd 添加到 USE 变量（D-Bus 是 GNOME 广泛使用的系统消息总线）。 如果不需要 KDE 支持，请从 USE 中删除 qt5 和 kde。 可以通过在它们前面添加减号 (-) 来删除 USE 标志。 有关正确使用的减号，请参见下面的示例。\nUSE=\"-qt5 -kde X gtk gnome systemd\" 附注：当使用 desktop/gnome profile, 这些 USE flags将为你设置。\n一旦完成,就由emerge GNOME来安装GNOME，安装一个完整的GNOME，它提供了所有你可能需要的额外的软件包：\n# emerge --ask gnome-base/gnome “最小化”GNOME安装，该选项提供了一个轻量级的GNOME安装没有额外的工具\n# emerge --ask gnome-base/gnome-light 这将需要一段时间，所以要开始阅读我们 wiki 中的其他部分。准备好了么？很好，现在更新环境变量：\n# env-update \u0026\u0026 source /etc/profile 接下来剩余的服务和用户组将被清除。\n验证 plugdev 组是否存在。如果是，建议让每个 GNOME 用户成为该组的成员，但这是可选的（该组不再常见）。\n# getent group plugdev plugdev❌104: 取代  为GNOME用户的用户名:\n# gpasswd -a  plugdev 第一印象 现在是时候看看什么是刚刚构建的。退出root 终端并以普通用户身份登录。下一步骤是配置会话管理器，使用GNOMEstartx 命令来调用(请看using startx 在Xorg guide的更多信息)。\n启用 GDM 注：有关 GDM 故障排除的帮助可以在 GNOME/GDM 文章中找到。\nsystemd\n在引导时启动 GDM：\n# systemctl enable gdm.service 要立即启动 GDM，运行：\n# systemctl start gdm.service Tip：以下命令同时启用并立即启动 GDM：\n# systemctl enable --now gdm.service 另一个建议是激活 Network Manager，以防没有其他网络管理服务被激活。\n使用 startx 退出 root shell 并以普通用户身份登录。 下一步是配置会话管理器以在调用 startx 命令时运行 GNOME（有关更多信息，请参阅 Xorg 指南中的使用 startx）。\n# echo \"exec gnome-session\"  ~/.xinitrc 从 gnome-base/gnome-session-2.26.2 开始，当使用 ~/.xinitrc 方法启动桌面时，用户需要预先添加 XDG_MENU_PREFIX 变量以获取 GNOME 菜单。如果 ~/.xinitrc 没有被使用，它将被自动处理；无需额外的配置。\n# sed -i '1i\\export XDG_MENU_PREFIX=gnome-' ~/.xinitrc 现在开始运行安装的图形环境startx:\n# startx 如果一切顺利GNOME，我们高兴的问候您。祝贺你成功设置GNOME!\n移除 完全删除 GNOME 安装的一种可能方法是明确卸载 gnome-base/gnome 包，然后清除该包的依赖项。\n为了做到这一点，请确保主 ebuild 存储库已同步：\n# emerge --sync 接下来，运行全局更新使系统是全新的：\n# emerge --ask --update --newuse --deep --with-bdeps=y @world 卸载 GNOME 基础包：\n# emerge --ask --depclean gnome-base/gnome 最后，清理系统：\n# emerge --ask --depclean GNOME 现已删除。\nTips How can I reset my display settings through terminal? Removing ~/.config/monitors.xml should do it:\ncfw 在gentoo下用不了，设置端口总为0；\nclash 在gentoo下需要root权限，最好用 systemd service 运行。\nFreeBSD Handbook ZFS Z 檔案系統 或 ZFS 是設計來克服許多在以往設計中發現的主要問題的一個先進的檔案系統。\n最初由 Sun™ 所開發，後來的開放源始碼 ZFS 開發已移到 OpenZFS 計劃。\nZFS 的設計目標主要有三個：\n 資料完整性：所有資料都會有一個資料的校驗碼 (checksum)，資料寫入時會計算校驗碼然後一併寫入，往後讀取資料時會再計算一次校驗碼，若校驗碼與當初寫入時不相符，便可偵測到資料錯誤，此時若有可用的資料備援 (Data redundancy)，ZFS 會嘗試自動修正錯誤。 儲存池：實體的儲存裝置都會先被加入到一個儲存池 (Pool)，這個共用的儲存池可用來配置儲存空間，儲存池的空間可被所有的檔案系統使用且透過加入新的儲存裝置來增加空間。 效能：提供多個快取機制來增加效能。先進、以記憶體為基礎的讀取快取可使用 ARC。第二層以磁碟為基礎的讀取快取可使用 L2ARC，以磁碟為基礎的同步寫入快取則可使用 ZIL。  完整的功能清單與術語在 [ZFS 特色與術語](#ZFS 特色與術語) 中有詳述。\n什麼使 ZFS 與眾不同 ZFS 與以往任何的檔案系統有顯著的不同，因為它不只是一個檔案系統，ZFS 的獨特優點來自結合了以往被分開的磁碟區管理程式 (Volume Manager) 及檔案系統兩個角色，讓檔案系統也能夠察覺磁碟底層結構的變動。傳統在一個磁碟上只能建立一個檔案系統，若有兩個磁碟則會需要建立兩個分開的檔案系統，在傳統要解決這個問題要使用硬體 RAID 來製作一個空間實際上由數顆實體磁碟所組成的單一的邏輯磁碟給作業系統，作業系統便可在這個邏輯磁碟上放置檔案系統，即使是在那些使用 GEOM 提供的軟體 RAID 解決方案也是一樣，把 UFS 檔案系統放在 RAID Transform 上面當做是一個單一的裝置。ZFS 結合了磁碟區管理程式 (Volume Manager) 與檔案系統來解決這個問題並讓建立多個檔案系統可以共用一個儲存池 (Pool)。ZFS 最大的優點是可以察覺實體磁碟配置的變動，當有額外的磁碟加入到儲存池時可以自動擴增現有的檔案系統，所有的檔案系統便可使用這個新的空間。ZFS 也有數個不同的屬性可以套用到各別檔案系統上，比起單一檔案系統，對建立數個不同檔案系統與資料集 (Dataset) 時有許多的好處。\n快速入門指南 這裡有一個啟動機制，可讓 FreeBSD 在系統初始化時掛載 ZFS 儲存池。要開啟這個功能，可加入此行到 /etc/rc.conf：\nzfs_enable=\"YES\" 然後啟動服務：\n# service zfs start 本節的例子會假設有三個 SCSI 磁碟，名稱分別為 da0, da1 及 da2。SATA 硬體的使用者裝置名稱改為 ada 。\n單磁碟儲存池 要使用一個磁碟裝置建立一個簡單、無備援的儲存池可：\n# zpool create example /dev/da0 要檢視這個新的儲存池，可查看 df 的輸出結果：\n# df Filesystem 1K-blocks Used Avail Capacity Mounted on ... example 17547136 0 17547136 0% /example 這個輸出結果說明 example 儲存池已建立且被掛載，現在已經可以作為檔案系統存取，可以在上面建立檔案且使用者可以瀏覽：\n# cd /example # ls # touch testfile # ls -al total 4 drwxr-xr-x 2 root wheel 3 Aug 29 23:15 . drwxr-xr-x 21 root wheel 512 Aug 29 23:12 .. -rw-r--r-- 1 root wheel 0 Aug 29 23:15 testfile 但是，這個儲存池並未運用到任何 ZFS 功能，若要在這個儲存池上建立一個有開啟壓縮功能的資料集：\n# zfs create example/compressed # zfs set compression=gzip example/compressed example/compressed 資料集現在是一個 ZFS 壓縮的檔案系統，可以試著複製較大的檔案到 /example/compressed。\n壓縮功能也可以使用以下指令關閉：\n# zfs set compression=off example/compressed 要卸載檔案系統，使用 zfs umount 然後再使用 df 確認：\n# zfs umount example/compressed # df Filesystem 1K-blocks Used Avail Capacity Mounted on ... example 17547008 0 17547008 0% /example 要重新掛載檔案系統以便再次使用，使用 zfs mount 然後以 df 檢查：\n# zfs mount example/compressed # df Filesystem 1K-blocks Used Avail Capacity Mounted on ... example 17547008 0 17547008 0% /example example/compressed 17547008 0 17547008 0% /example/compressed 儲存池與檔案系統也可以從 mount 的結果查詢到：\n# mount /dev/ad0s1a on / (ufs, local) devfs on /dev (devfs, local) /dev/ad0s1d on /usr (ufs, local, soft-updates) example on /example (zfs, local) example/compressed on /example/compressed (zfs, local) 在建立之後，ZFS 的資料集可如同其他檔案系統一般使用，且有許多額外功能可在每個資料集上設定。例如，建立一個預計存放重要的資料的新檔案系統 data，要設定每個資料區塊 (Data block) 要保留兩份備份：\n# zfs create example/data # zfs set copies=2 example/data 現在，可以使用 df 指令來查看資料與空間的使用率：\n# df Filesystem 1K-blocks Used Avail Capacity Mounted on ... example 17547008 0 17547008 0% /example example/compressed 17547008 0 17547008 0% /example/compressed example/data 17547008 0 17547008 0% /example/data 注意，從這個可以發現每個在儲存池上的檔案系統都擁有相同的可用空間，這是為什麼要在這些範例使用 df 的原因，為了要顯示檔案系統只會用它們所需要使用到的空間，且均取自同一個儲存池。ZFS 淘汰了磁碟區 (Volume) 與分割區 (Partition) 的概念，且允許多個檔案系統共用相同的儲存池。\n不需要使用時可摧毀檔案系統後再摧毀儲存池：\n# zfs destroy example/compressed # zfs destroy example/data # zpool destroy example RAID-Z 磁碟損壞時，要避免資料因磁碟故障造成遺失便是使用 RAID。ZFS 在它的儲存池設計中支援了這項功能。RAID-Z 儲存池需要使用三個或更多的磁碟，但可以提供比鏡像 (Mirror) 儲存池更多的可用空間。\n這個例子會建立一個 RAID-Z 儲存池，並指定要加入這個儲存池的磁碟：\n# zpool create storage raidz da0 da1 da2  Sun™ 建議用在 RAID-Z 設定的裝置數在三到九個之間。若需要由 10 個或更多磁碟組成單一儲存池的環境，可考慮分成較小的 RAID-Z 群組。若只有兩個可用的磁碟且需要做備援 (Redundancy)，可考慮使用 ZFS 鏡像 (Mirror)。請參考 zpool(8) 取得更多詳細資訊。\n 先前的例子已經建立了 storage 儲存池 (zpool)，現在這個例子會在該儲存池中建立一個新的檔案系統，名稱為 home：\n# zfs create storage/home 可以設定開啟壓縮及保留目錄及檔案額外備份的功能：\n# zfs set copies=2 storage/home # zfs set compression=gzip storage/home 要讓這個空間作為使用者的新家目錄位置，需複製使用者資料到這個目錄並建立適合的符號連結 (Symbolic link)：\n# cp -rp /home/* /storage/home # rm -rf /home /usr/home # ln -s /storage/home /home # ln -s /storage/home /usr/home 現在使用者的資料會儲存在新建立的 /storage/home，可以加入新使用者並登入該使用者來測試。\n試著建立檔案系統快照 (Snapshot)，稍後可用來還原 (Rollback)：\n# zfs snapshot storage/home@08-30-08 快照只可以使用整個檔案系統製作，無法使用各別目錄或檔案。\n@ 字元用來區隔檔案系統名稱 (File system) 或磁碟區 (Volume) 名稱，若有重要的目錄意外被刪除，檔案系統可以備份然後還原到先前目錄還存在時的快照 (Snapshot)：\n# zfs rollback storage/home@08-30-08 要列出所有可用的快照，可在檔案系統的 .zfs/snapshot 目錄執行 ls，舉例來說，要查看先前已做的快照：\n# ls /storage/home/.zfs/snapshot 也可以寫一個 Script 來對使用者資料做例行性的快照，但隨著時間快照可能消耗大量的磁碟空間。先前的快照可以使用指令移除：\n# zfs destroy storage/home@08-30-08 在測試之後，便可讓 /storage/home 成為真正的 /home 使用此指令：\n# zfs set mountpoint=/home storage/home 執行 df 興 mount 來確認系統現在是否以把檔案系統做為真正的 /home：\n# mount ... storage on /storage (zfs, local) storage/home on /home (zfs, local) # df Filesystem 1K-blocks Used Avail Capacity Mounted on ... storage 26320512 0 26320512 0% /storage storage/home 26320512 0 26320512 0% /home 這個動作完成 RAID-Z 最後的設定，有關已建立的檔案系統每日狀態更新可以做為 periodic(8) 的一部份在每天晚上執行。加入此行到 /etc/periodic.conf：\ndaily_status_zfs_enable=\"YES\" 復原 RAID-Z 每個軟體 RAID 都有監控其狀態 (state) 的方式，而 RAID-Z 裝置的狀態可以使用這個指令來查看：\n# zpool status -x 如果所有儲存池為上線 (Online) 且正常，則訊息會顯示：\nall pools are healthy 如果有發生問題，可能磁碟會呈現離線 (Offline) 的狀態，此時儲存池的狀態會是：\npool: storage state: DEGRADED status: One or more devices has been taken offline by the administrator. Sufficient replicas exist for the pool to continue functioning in a degraded state. action: Online the device using 'zpool online' or replace the device with 'zpool replace'. scrub: none requested config: NAME STATE READ WRITE CKSUM storage DEGRADED 0 0 0 raidz1 DEGRADED 0 0 0 da0 ONLINE 0 0 0 da1 OFFLINE 0 0 0 da2 ONLINE 0 0 0 errors: No known data errors 這代表著裝置在之前被管理者使用此指令拿下線：\n# zpool offline storage da1 現在系統可以關機然後更換 da1，當系統恢復上線，則可以替換掉儲存池中故障的磁碟：\n# zpool replace storage da1 到這裡，可以再檢查狀態一次，這時不需使用 -x 參數來顯示所有的儲存池：\n# zpool status storage pool: storage state: ONLINE scrub: resilver completed with 0 errors on Sat Aug 30 19:44:11 2008 config: NAME STATE READ WRITE CKSUM storage ONLINE 0 0 0 raidz1 ONLINE 0 0 0 da0 ONLINE 0 0 0 da1 ONLINE 0 0 0 da2 ONLINE 0 0 0 errors: No known data errors 在這個例子中，所有的磁碟均已正常運作。\n資料檢驗 ZFS 使用校驗碼 (Checksum) 來檢驗資料的完整性 (Integrity)，會在建立檔案系統時便自動開啟。\n 校驗碼 (Checksum) 可以關閉，但並不建議！校驗碼只會使用非常少的儲存空間來確保資料的完整性。若關閉校驗碼會使許多 ZFS 功能無法正常運作，且關閉校驗碼對並不會明顯的改善效能。\n 檢驗校驗碼這個動作即所謂的清潔 (Scrub)，可以使用以下指令來檢驗 storage 儲存池的資料完整性：\n# zpool scrub storage 清潔所需要的時間依儲存的資料量而定，較大的資料量相對會需要花費較長的時間來檢驗。清潔會對 I/O 有非常密集的操作且一次只能進行一個清潔動作。在清潔完成之後，可以使用 status 來查看狀態：\n# zpool status storage pool: storage state: ONLINE scrub: scrub completed with 0 errors on Sat Jan 26 19:57:37 2013 config: NAME STATE READ WRITE CKSUM storage ONLINE 0 0 0 raidz1 ONLINE 0 0 0 da0 ONLINE 0 0 0 da1 ONLINE 0 0 0 da2 ONLINE 0 0 0 errors: No known data errors 查詢結果會顯示上次完成清潔的時間來協助追蹤是否要再做清潔。定期清潔可以協助保護資料不會默默損壞且確保儲存池的完整性。\n請參考 zfs(8) 及 zpool(8) 來取得其他 ZFS 選項。\nzpool 管理 ZFS 管理分成兩個主要的工具。zpool 工具用來控制儲存池的運作並可處理磁碟的新增、移除、更換與管理。[zfs](#zfs 管理) 工具用來建立、摧毀與管理檔案系統 (File system) 與磁碟區 (Volume) 的資料集。\n建立與摧毀儲存池 建立 ZFS 儲存池 (zpool) 要做幾個涉及長遠規劃的決定，因為建立儲存池之後便無法再更改儲存池的結構。最重要的決定是要使用那一種型態的 vdev 來將實體磁碟設為同一群組。請參考 vdev 型態 的清單來取得有關可用選項的詳細資訊。大部份的 vdev 型態不允許在建立儲存池之後再加入額外的磁碟，鏡像 (Mirror) 是可以允許加入額外的磁碟到 vdev 的其中一個例外，另一個則是串連 (Stripe)，可以加入額外的磁碟到 vdev 來升級為鏡像。雖然可以加入額外的 vdev 來擴充儲存池，但儲存池的配置在建立之後便無法更改，若要要更改，則必須先備份資料，把儲存池摧毀後再重新建立。\n建立一個簡單的鏡像儲存池：\n# zpool create mypool mirror /dev/ada1 /dev/ada2 # zpool status pool: mypool state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada1 ONLINE 0 0 0 ada2 ONLINE 0 0 0 errors: No known data errors 可以一次建立數個 vdev，磁碟群組間使用 vdev 型態關鍵字來區隔，在這個例子使用 mirror：\n# zpool create mypool mirror /dev/ada1 /dev/ada2 mirror /dev/ada3 /dev/ada4 pool: mypool state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada1 ONLINE 0 0 0 ada2 ONLINE 0 0 0 mirror-1 ONLINE 0 0 0 ada3 ONLINE 0 0 0 ada4 ONLINE 0 0 0 errors: No known data errors 儲存池也可以不使用整個磁碟而改使用分割區 (Partition) 來建立。把 ZFS 放到不同的分割區可讓同一個磁碟有其他的分割區可做其他用途，尤其是有 Bootcode 與檔案系統要用來開機的分割區，這讓磁碟可以用來開機也同樣可以做為儲存池的一部份。在 FreeBSD 用分割區來替代整個磁碟並不會對效能有影響。使用分割區也讓管理者可以對磁碟容量做 少算的預備，使用比完整容量少的容量，未來若要替換的磁碟號稱與原磁碟相同，但實際上卻比較小時，也可符合這個較小的分割區容量，以使用替換的磁碟。\n使用分割區建立一個 RAID-Z2 儲存池：\n# zpool create mypool raidz2 /dev/ada0p3 /dev/ada1p3 /dev/ada2p3 /dev/ada3p3 /dev/ada4p3 /dev/ada5p3 # zpool status pool: mypool state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 raidz2-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 ada3p3 ONLINE 0 0 0 ada4p3 ONLINE 0 0 0 ada5p3 ONLINE 0 0 0 errors: No known data errors 不需使用的儲存池可以摧毀，來讓磁碟可以再次使用。摧毀一個儲存池要先卸載所有該儲存池的資料集。若資料集在使用中，卸載的操作會失敗且儲存池不會被摧毀。儲存池的摧毀可以使用 -f 來強制執行，但這可能造成那些有開啟這些資料集之中檔案的應用程式無法辨識的行為。\n加入與移除裝置 加入磁碟到儲存池 (zpool) 會有兩種情形：使用 zpool attach 加入一個磁碟到既有的 vdev，或使用 zpool add 加入 vdev 到儲存池。只有部份 vdev 型態 允許在 vdev 建立之後加入磁碟。\n由單一磁碟所建立的儲存池缺乏備援 (Redundancy) 功能，可以偵測到資料的損壞但無法修復，因為資料沒有其他備份可用。備份數 (Copies) 屬性可以讓您從較小的故障中復原，如磁碟壞軌 (Bad sector)，但無法提供與鏡像或 RAID-Z 同樣層級的保護。由單一磁碟所建立的儲存池可以使用 zpool attach 來加入額外的磁碟到 vdev，來建立鏡像。zpool attach 也可用來加入額外的磁碟到鏡像群組，來增加備援與讀取效率。若使用的磁碟已有分割區，可以複製該磁碟的分割區配置到另一個，使用 gpart backup 與 gpart restore 可讓這件事變的很簡單。\n加入 ada1p3 來升級單一磁碟串連 (stripe) vdev ada0p3 採用鏡像型態 (mirror)：\n# zpool status pool: mypool state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 errors: No known data errors # zpool attach mypool ada0p3 ada1p3 Make sure to wait until resilver is done before rebooting. If you boot from pool 'mypool', you may need to update boot code on newly attached disk 'ada1p3'. Assuming you use GPT partitioning and 'da0' is your new boot disk you may use the following command: gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 da0 # gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1 bootcode written to ada1 # zpool status pool: mypool state: ONLINE status: One or more devices is currently being resilvered. The pool will continue to function, possibly in a degraded state. action: Wait for the resilver to complete. scan: resilver in progress since Fri May 30 08:19:19 2014 527M scanned out of 781M at 47.9M/s, 0h0m to go 527M resilvered, 67.53% done config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 (resilvering) errors: No known data errors # zpool status pool: mypool state: ONLINE scan: resilvered 781M in 0h0m with 0 errors on Fri May 30 08:15:58 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 errors: No known data errors 若不想選擇加入磁碟到既有的 vdev ，對 RAID-Z 來說，可選擇另一種方式，便是加入另一個 vdev 到儲存池。額外的 vdev 可以提供更高的效能，分散寫入資料到 vdev 之間，每個 vdev 會負責自己的備援。也可以混合使用不同的 vdev 型態，但並不建議，例如混合使用 mirror 與 RAID-Z，加入一個無備援的 vdev 到一個含有 mirror 或 RAID-Z vdev 的儲存池會讓資料損壞的風險擴大整個儲存池，由於會分散寫入資料，若在無備援的磁碟上發生故障的結果便是遺失大半寫到儲存池的資料區塊。\n在每個 vdev 間的資料是串連的，例如，有兩個 mirror vdev，便跟 RAID 10 一樣在兩個 mirror 間分散寫入資料，且會做空間的分配，因此 vdev 會在同時達到全滿 100% 的用量。若 vdev 間的可用空間量不同則會影響到效能，因為資料量會不成比例的寫入到使用量較少的 vdev。\n當連接額外的裝置到一個可以開機的儲存池，要記得更新 Bootcode。\n連接第二個 mirror 群組 (ada2p3 及 ada3p3) 到既有的 mirror：\n# zpool status pool: mypool state: ONLINE scan: resilvered 781M in 0h0m with 0 errors on Fri May 30 08:19:35 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 errors: No known data errors # zpool add mypool mirror ada2p3 ada3p3 # gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2 bootcode written to ada2 # gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada3 bootcode written to ada3 # zpool status pool: mypool state: ONLINE scan: scrub repaired 0 in 0h0m with 0 errors on Fri May 30 08:29:51 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 mirror-1 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 ada3p3 ONLINE 0 0 0 errors: No known data errors 現在已無法從儲存池上移除 vdev，且磁碟只能夠在有足夠備援空間的情況下從 mirror 移除，若在 mirror 群組中只剩下一個磁碟，便會取消 mirror 然後還原為 stripe，若剩下的那個磁碟故障，便會影響到整個儲存池。\n從一個三方 mirror 群組移除一個磁碟：\n# zpool status pool: mypool state: ONLINE scan: scrub repaired 0 in 0h0m with 0 errors on Fri May 30 08:29:51 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 errors: No known data errors # zpool detach mypool ada2p3 # zpool status pool: mypool state: ONLINE scan: scrub repaired 0 in 0h0m with 0 errors on Fri May 30 08:29:51 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 errors: No known data errors 檢查儲存池狀態 儲存池的狀態很重要，若有磁碟機離線或偵測到讀取、寫入或校驗碼 (Checksum) 錯誤，對應的錯誤計數便會增加。status 會顯示儲存池中每一個磁碟機的設定與狀態及整個儲存池的狀態。需要處置的方式與有關最近清潔 (Scrub) 的詳細資訊也會一併顯示。\n# zpool status pool: mypool state: ONLINE scan: scrub repaired 0 in 2h25m with 0 errors on Sat Sep 14 04:25:50 2013 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 raidz2-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 ada3p3 ONLINE 0 0 0 ada4p3 ONLINE 0 0 0 ada5p3 ONLINE 0 0 0 errors: No known data errors 清除錯誤 當偵測到錯誤發生，讀取、寫入或校驗碼 (Checksum) 的計數便會增加。使用 zpool clear mypool 可以清除錯誤訊息及重置計數。清空錯誤狀態對當儲存池發生錯誤要使用自動化 Script 通知的管理者來說會很重要，因在舊的錯誤尚未清除前不會回報後續的錯誤。\n更換運作中的裝置 可能有一些情況會需要更換磁碟為另一個磁碟，當要更換運作中的磁碟，此程序會維持舊有的磁碟在更換的過程為上線的狀態，儲存池不會進入降級 (Degraded) 的狀態，來減少資料遺失的風險。zpool replace 會複製所有舊磁碟的資料到新磁碟，操作完成之後舊磁碟便會與 vdev 中斷連線。若新磁碟容量較舊磁碟大，也可以會增加儲存池來使用新的空間，請參考 擴增儲存池。\n更換儲存池中正在運作的狀置：\n# zpool status pool: mypool state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 errors: No known data errors # zpool replace mypool ada1p3 ada2p3 Make sure to wait until resilver is done before rebooting. If you boot from pool 'zroot', you may need to update boot code on newly attached disk 'ada2p3'. Assuming you use GPT partitioning and 'da0' is your new boot disk you may use the following command: gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 da0 # gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2 # zpool status pool: mypool state: ONLINE status: One or more devices is currently being resilvered. The pool will continue to function, possibly in a degraded state. action: Wait for the resilver to complete. scan: resilver in progress since Mon Jun 2 14:21:35 2014 604M scanned out of 781M at 46.5M/s, 0h0m to go 604M resilvered, 77.39% done config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 replacing-1 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 (resilvering) errors: No known data errors # zpool status pool: mypool state: ONLINE scan: resilvered 781M in 0h0m with 0 errors on Mon Jun 2 14:21:52 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 errors: No known data errors 處理故障裝置 當儲存池中的磁碟故障，該故障硬碟所屬的 vdev 便會進入降級 (Degraded) 狀態，所有的資料仍可使用，但效能可能會降低，因為遺失的資料必須從可用的備援資料計算才能取得。要將 vdev 恢復完整運作的狀態必須更換故障的實體裝置。然後 ZFS 便會開始修復 (Resilver，古代鏡子的修復稱 Resilver) 作業，會從可用的備援資料計算出故障磁碟中的資料並寫入到替換的裝置上。完成後 vdev 便會重新返回上線 (Online) 的狀態。\n若 vdev 沒有任何備援資料或有多個裝置故障，沒有足夠的備援資料可以補償，儲存池便會進入故障 (Faulted) 的狀態。\n更換故障的磁碟時，故障磁碟的名稱會更換為裝置的 GUID，若替換裝置要使用相同的裝置名稱，則在 zpool replace 不須加上新裝置名稱參數。\n使用 zpool replace 更換故障的磁碟：\n# zpool status pool: mypool state: DEGRADED status: One or more devices could not be opened. Sufficient replicas exist for the pool to continue functioning in a degraded state. action: Attach the missing device and online it using 'zpool online'. see: http://illumos.org/msg/ZFS-8000-2Q scan: none requested config: NAME STATE READ WRITE CKSUM mypool DEGRADED 0 0 0 mirror-0 DEGRADED 0 0 0 ada0p3 ONLINE 0 0 0 316502962686821739 UNAVAIL 0 0 0 was /dev/ada1p3 errors: No known data errors # zpool replace mypool 316502962686821739 ada2p3 # zpool status pool: mypool state: DEGRADED status: One or more devices is currently being resilvered. The pool will continue to function, possibly in a degraded state. action: Wait for the resilver to complete. scan: resilver in progress since Mon Jun 2 14:52:21 2014 641M scanned out of 781M at 49.3M/s, 0h0m to go 640M resilvered, 82.04% done config: NAME STATE READ WRITE CKSUM mypool DEGRADED 0 0 0 mirror-0 DEGRADED 0 0 0 ada0p3 ONLINE 0 0 0 replacing-1 UNAVAIL 0 0 0 15732067398082357289 UNAVAIL 0 0 0 was /dev/ada1p3/old ada2p3 ONLINE 0 0 0 (resilvering) errors: No known data errors # zpool status pool: mypool state: ONLINE scan: resilvered 781M in 0h0m with 0 errors on Mon Jun 2 14:52:38 2014 config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 errors: No known data errors 清潔儲存池 建議儲存池要定期清潔 (Scrub)，最好是每一個月清潔一次。 scrub 作業對磁碟操作非常的密集，在執行時會降低磁碟的效能。在排程 scrub 時避免在使用高峰的時期，或使用 vfs.zfs.scrub_delay 來調整 scrub 的相對優先權來避免影響其他的工作。\n# zpool scrub mypool # zpool status pool: mypool state: ONLINE scan: scrub in progress since Wed Feb 19 20:52:54 2014 116G scanned out of 8.60T at 649M/s, 3h48m to go 0 repaired, 1.32% done config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 raidz2-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 ada2p3 ONLINE 0 0 0 ada3p3 ONLINE 0 0 0 ada4p3 ONLINE 0 0 0 ada5p3 ONLINE 0 0 0 errors: No known data errors 若發生需要取消清潔作業的事，可以下 zpool scrub -s mypool。\n自我修復 校驗碼 (Checksum) 會隨資料區塊一併儲存，這使得檔案系統可以做到自我修復。這個功能可以在校驗碼與儲存池中的另一個裝置不同時自動修復資料。舉例來說，有兩個磁碟做鏡像 (Mirror)，其中一個磁碟機開始失常並無法正常儲存資料，甚至是資料放在長期封存的儲存裝置上，已經很久沒有被存取。傳統的檔案系統需要執行演算法來檢查並修復資料如 fsck(8)，這些指令耗費時間，且在嚴重時需要管理者手動決定要做那一種修復操作。當 ZFS 偵測到資料區塊的校驗碼不對時，它除了把資料交給需要的應用程式外，也會修正在磁碟上錯誤的資料。這件事不需要與系統管理者作任何互動便會在一般的儲存池操作時完成。\n接下來的例子會示範自我修復會如何運作。建立一個使用磁碟 /dev/ada0 及 /dev/ada1 做鏡像的儲存池。\n# zpool create healer mirror /dev/ada0 /dev/ada1 # zpool status healer pool: healer state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM healer ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 0 errors: No known data errors # zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT healer 960M 92.5K 960M - - 0% 0% 1.00x ONLINE - 將部份需要使用自我修復功能來保護的重要資料複製到該儲存池，建立一個儲存池的校驗碼供稍後做比較時使用。\n# cp /some/important/data /healer # zfs list NAME SIZE ALLOC FREE CAP DEDUP HEALTH ALTROOT healer 960M 67.7M 892M 7% 1.00x ONLINE - # sha1 /healer  checksum.txt # cat checksum.txt SHA1 (/healer) = 2753eff56d77d9a536ece6694bf0a82740344d1f 寫入隨機的資料到鏡像的第一個磁碟來模擬資料損毀的情況。要避免 ZFS 偵測到錯誤時馬上做修復，接著要將儲存池匯出，待模擬資料損毀之後再匯入。\n 這是一個危險的操作，會破壞重要的資料。在這裡使用僅為了示範用，不應在儲存池正常運作時嘗試使用，也不應將這個故意損壞資料的例子用在任何其他的檔案系統上，所以請勿使用任何不屬於該儲存池的其他磁碟裝置名稱並確定在執行指令前已對儲存池做正確的備份！\n # zpool export healer # dd if=/dev/random of=/dev/ada1 bs=1m count=200 200+0 records in 200+0 records out 209715200 bytes transferred in 62.992162 secs (3329227 bytes/sec) # zpool import healer 儲存池的狀態顯示有一個裝置發生了錯誤。注意，應用程式從儲存池讀取的資料中並沒有任何的錯誤資料，ZFS 會自 ada0 裝置提供有正確校驗碼的資料。結果裡面 CKSUM 欄位含有非零值便是有錯誤校驗碼的裝置。\n# zpool status healer pool: healer state: ONLINE status: One or more devices has experienced an unrecoverable error. An attempt was made to correct the error. Applications are unaffected. action: Determine if the device needs to be replaced, and clear the errors using 'zpool clear' or replace the device with 'zpool replace'. see: http://illumos.org/msg/ZFS-8000-4J scan: none requested config: NAME STATE READ WRITE CKSUM healer ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 1 errors: No known data errors 錯誤已經被偵測到並且由未被影響的 ada0 鏡像磁碟上的備援提供資料。可與原來的校驗碼做比較來看儲存池是否已修復為一致。\n# sha1 /healer  checksum.txt # cat checksum.txt SHA1 (/healer) = 2753eff56d77d9a536ece6694bf0a82740344d1f SHA1 (/healer) = 2753eff56d77d9a536ece6694bf0a82740344d1f 儲存池在故意竄改資料前與後的兩個校驗碼仍相符顯示了 ZFS 在校驗碼不同時偵測與自動修正錯誤的能力。注意，這只在當儲存池中有足夠的備援時才可做到，由單一裝置組成的儲存池並沒有自我修復的能力。這也是為什麼在 ZFS 中校驗碼如此重要，任何原因都不該關閉。不需要 fsck(8) 或類似的檔案系統一致性檢查程式便能夠偵測與修正問題，且儲存儲存池在發生問題時仍可正常運作。接著需要做清潔作業來覆蓋在 ada1 上的錯誤資料。\n# zpool scrub healer # zpool status healer pool: healer state: ONLINE status: One or more devices has experienced an unrecoverable error. An attempt was made to correct the error. Applications are unaffected. action: Determine if the device needs to be replaced, and clear the errors using 'zpool clear' or replace the device with 'zpool replace'. see: http://illumos.org/msg/ZFS-8000-4J scan: scrub in progress since Mon Dec 10 12:23:30 2012 10.4M scanned out of 67.0M at 267K/s, 0h3m to go 9.63M repaired, 15.56% done config: NAME STATE READ WRITE CKSUM healer ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 627 (repairing) errors: No known data errors 清潔作業會從 ada0 讀取資料並重新寫入任何在 ada1 上有錯誤校驗碼的資料。這個操作可以由 zpool status 的輸出中呈現修復中 (repairing) 的項目來辨識。這個作業完成後，儲存池的狀態會更改為：\n# zpool status healer pool: healer state: ONLINE status: One or more devices has experienced an unrecoverable error. An attempt was made to correct the error. Applications are unaffected. action: Determine if the device needs to be replaced, and clear the errors using 'zpool clear' or replace the device with 'zpool replace'. see: http://illumos.org/msg/ZFS-8000-4J scan: scrub repaired 66.5M in 0h2m with 0 errors on Mon Dec 10 12:26:25 2012 config: NAME STATE READ WRITE CKSUM healer ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 2.72K errors: No known data errors 清潔操作完成便同步了 ada0 到 ada1 間的所有資料。執行 zpool clear 可以清除 (Clear) 儲存池狀態的錯誤訊息。\n# zpool clear healer # zpool status healer pool: healer state: ONLINE scan: scrub repaired 66.5M in 0h2m with 0 errors on Mon Dec 10 12:26:25 2012 config: NAME STATE READ WRITE CKSUM healer ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 0 errors: No known data errors 儲存池現在恢復完整運作的狀態且清除所有的錯誤了。\n擴增儲存池 可用的備援儲存池大小會受到每個 vdev 中容量最小的裝置限制。最小的裝置可以替換成較大的裝置，在更換 (Replace) 或修復 (Resilver) 作業後，儲存池可以成長到該新裝置的可用容量。例如，要做一個 1 TB 磁碟機與一個 2 TB 磁碟機的鏡像，可用的空間會是 1 TB，當 1 TB 磁碟機備更換成另一個 2 TB 的磁碟機時，修復程序會複製既有的資料到新的磁碟機，由於現在兩個裝置都有 2 TB 的容量，所以鏡像的可用空間便會成長到 2 TB。\n可以在每個裝置用 zpool online -e 來觸發擴充的動作，在擴充完所有裝置後，儲存池便可使用額外的空間。\n匯入與匯出儲存池 儲存池在移動到其他系統之前需要做匯出 (Export)，會卸載所有的資料集，然後標記每個裝置為已匯出，為了避免被其他磁碟子系統存取，因此仍會鎖定這些裝置。這個動作讓儲存池可以在支援 ZFS 的其他機器、其他作業系統做匯入 (Import)，甚至是不同的硬體架構 (有一些注意事項，請參考 zpool(8))。當資料集有被開啟的檔案，可使用 zpool export -f 來強制匯出儲存池，使用這個指令需要小心，資料集是被強制卸載的，因此有可能造成在該資料集開啟檔案的應用程式發生無法預期的結果。\n匯出未使用的儲存池：\n# zpool export mypool 匯入儲存池會自動掛載資料集，若不想自動掛載，可以使用 zpool import -N。zpool import -o 可以設定在匯入時暫時使用的屬性。zpool import altroot= 允許匯入時指定基礎掛載點 (Base mount point) 來替換檔案系統根目錄。若儲存池先前用在不同的系統且不正常匯出，可能會需要使用 zpool import -f 來強制匯入。zpool import -a 會匯入所有沒有被其他系統使用的儲存池。\n列出所有可以匯入的儲存池：\n# zpool import pool: mypool id: 9930174748043525076 state: ONLINE action: The pool can be imported using its name or numeric identifier. config: mypool ONLINE ada2p3 ONLINE 使用替代的根目錄匯入儲存池：\n# zpool import -o altroot=/mnt mypool # zfs list zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 110K 47.0G 31K /mnt/mypool 升級儲存儲存池 在升級 FreeBSD 之後或儲存池是由其他使用舊版 ZFS 的系統匯入，儲存池可以手動升級到最新版本的 ZFS 來支援新的功能。在升級前請評估儲存池是否還要在舊的系統做匯入，由於升級是一個單向的程序，舊的儲存池可以升級，但有新功能的儲存池無法降級。\n升級一個 v28 的儲存以支援功能旗標 (Feature Flags)：\n# zpool status pool: mypool state: ONLINE status: The pool is formatted using a legacy on-disk format. The pool can still be used, but some features are unavailable. action: Upgrade the pool using 'zpool upgrade'. Once this is done, the pool will no longer be accessible on software that does not support feat flags. scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 0 errors: No known data errors # zpool upgrade This system supports ZFS pool feature flags. The following pools are formatted with legacy version numbers and can be upgraded to use feature flags. After being upgraded, these pools will no longer be accessible by software that does not support feature flags. VER POOL --- ------------ 28 mypool Use 'zpool upgrade -v' for a list of available legacy versions. Every feature flags pool has all supported features enabled. # zpool upgrade mypool This system supports ZFS pool feature flags. Successfully upgraded 'mypool' from version 28 to feature flags. Enabled the following features on 'mypool': async_destroy empty_bpobj lz4_compress multi_vdev_crash_dump ZFS 的新功能在 zpool upgrade 尚未完成之前無法使用。可以用 zpool upgrade -v 來查看升級後有那些新功能，也同時會列出已經支援那些功能。\n升級儲存池支援新版的功能旗標 (Feature flags)：\n# zpool status pool: mypool state: ONLINE status: Some supported features are not enabled on the pool. The pool can still be used, but some features are unavailable. action: Enable all features using 'zpool upgrade'. Once this is done, the pool may no longer be accessible by software that does not support the features. See zpool-features(7) for details. scan: none requested config: NAME STATE READ WRITE CKSUM mypool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0 ONLINE 0 0 0 ada1 ONLINE 0 0 0 errors: No known data errors # zpool upgrade This system supports ZFS pool feature flags. All pools are formatted using feature flags. Some supported features are not enabled on the following pools. Once a feature is enabled the pool may become incompatible with software that does not support the feature. See zpool-features(7) for details. POOL FEATURE --------------- zstore multi_vdev_crash_dump spacemap_histogram enabled_txg hole_birth extensible_dataset bookmarks filesystem_limits # zpool upgrade mypool This system supports ZFS pool feature flags. Enabled the following features on 'mypool': spacemap_histogram enabled_txg hole_birth extensible_dataset bookmarks filesystem_limits  在使用儲存池來開機的系統上的 Boot code 也必須一併更新來支援新的儲存池版本，可在含有 Boot code 的分割區使用 gpart bootcode 來更新。目前有兩種 Boot code 可使用，需視系統開機的方式使用：GPT (最常用的選項) 以及 EFI (較新的系統)。針對傳統使用 GPT 開機的系統，可以使用以下指令：# gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1針對使用 EFI 開機的系統可以執行以下指令：# gpart bootcode -p /boot/boot1.efifat -i 1 ada1套用 Boot code 到所有儲存池中可開機的磁碟。請參考 gpart(8) 以取得更多資訊。\n 顯示已記錄的儲存池歷史日誌 修改儲存池的指令會被記錄下來，會記錄的動作包含資料集的建立，屬性更改或更換磁碟。這個歷史記錄用來查看儲存池是如何建立、由誰執行、什麼動作及何時。歷史記錄並非儲存在日誌檔 (Log file)，而是儲存在儲存池。查看這個歷史記錄的指令名稱為 zpool history：\n# zpool history History for 'tank': 2013-02-26.23:02:35 zpool create tank mirror /dev/ada0 /dev/ada1 2013-02-27.18:50:58 zfs set atime=off tank 2013-02-27.18:51:09 zfs set checksum=fletcher4 tank 2013-02-27.18:51:18 zfs create tank/backup 輸出結果顯示曾在該儲存池上執行的 zpool 與 zfs 指令以及時間戳記。只有會修改儲存池或類似的指令會被記錄下來，像是 zfs list 這種指令並不會被記錄。當不指定儲存池名稱時，會列出所有儲存池的歷史記錄。\n在提供選項 -i 或 -l 時 zpool history 可以顯更多詳細資訊。-i 會顯示使用者觸發的事件外，也會顯示內部記錄的 ZFS 事件。\n# zpool history -i History for 'tank': 2013-02-26.23:02:35 [internal pool create txg:5] pool spa 28; zfs spa 28; zpl 5;uts 9.1-RELEASE 901000 amd64 2013-02-27.18:50:53 [internal property set txg:50] atime=0 dataset = 21 2013-02-27.18:50:58 zfs set atime=off tank 2013-02-27.18:51:04 [internal property set txg:53] checksum=7 dataset = 21 2013-02-27.18:51:09 zfs set checksum=fletcher4 tank 2013-02-27.18:51:13 [internal create txg:55] dataset = 39 2013-02-27.18:51:18 zfs create tank/backup 更多詳細的資訊可加上 -l 來取得，歷史記錄會以較長的格式顯示，包含的資訊有執行指令的使用者名稱、主機名稱以及更改的項目。\n# zpool history -l History for 'tank': 2013-02-26.23:02:35 zpool create tank mirror /dev/ada0 /dev/ada1 [user 0 (root) on :global] 2013-02-27.18:50:58 zfs set atime=off tank [user 0 (root) on myzfsbox:global] 2013-02-27.18:51:09 zfs set checksum=fletcher4 tank [user 0 (root) on myzfsbox:global] 2013-02-27.18:51:18 zfs create tank/backup [user 0 (root) on myzfsbox:global] 輸出結果顯示 root 使用者使用 /dev/ada0 及 /dev/ada1 建立鏡像的儲存池。主機名稱 myzfsbox 在建立完儲存池後也同樣會顯示。由於儲存池可以從一個系統匯出再匯入到另一個系統，因此主機名稱也很重要，這樣一來可以清楚的辦識在其他系統上執行的每一個指令的主機名稱。\n兩個 zpool history 選項可以合併使用來取得最完整的儲存池詳細資訊。儲存池歷史記錄在追蹤執行什麼動作或要取得除錯所需的輸出結果提供了非常有用的資訊。\n監視效能 內建的監視系統可以即時顯示儲存池的 I/O 統計資訊。它會顯示儲存池剩餘的空間與使用的空間，每秒執行了多少讀取與寫入的操作，有多少 I/O 頻寬被使用。預設會監視所有在系統中的儲存池都並顯示出來，可以提供儲存池名稱來只顯示該儲存池的監視資訊。舉一個簡單的例子：\n# zpool iostat capacity operations bandwidth pool alloc free read write read write ---------- ----- ----- ----- ----- ----- ----- data 288G 1.53T 2 11 11.3K 57.1K 要持續監視 I/O 的活動可以在最後的參數指定一個數字，這個數字代表每次更新資訊所間隔的秒數。在每次經過間隔的時間後會列出新一行的統計資訊，按下 Ctrl+C 可以中止監視。或者在指令列的間隔時間之後再指定一個數字，代表總共要顯示的統計資訊筆數。\n使用 -v 可以顯示更詳細的 I/O 統計資訊。每個在儲存池中的裝置會以一行統計資訊顯示。這可以幫助了解每一個裝置做了多少讀取與寫入的操作，並可協助確認是否有各別裝置拖慢了整個儲存池的速度。以下範例會顯示有兩個裝置的鏡像儲存池：\n# zpool iostat -v capacity operations bandwidth pool alloc free read write read write ----------------------- ----- ----- ----- ----- ----- ----- data 288G 1.53T 2 12 9.23K 61.5K mirror 288G 1.53T 2 12 9.23K 61.5K ada1 - - 0 4 5.61K 61.7K ada2 - - 1 4 5.04K 61.7K ----------------------- ----- ----- ----- ----- ----- ----- 分割儲存儲存池 由一個或多個鏡像 vdev 所組成的儲存池可以切分開成兩個儲存池。除非有另外指定，否則每個鏡像的最後一個成員會被分離，用來建立一個含有相同資料的新儲存池。在做這個操作的第一次應先使用 -n，會顯示預計會做的操作而不會真的執行，這可以協助確認操作是否與使用者所要的相同。\nzfs 管理 zfs 工具負責建立、摧毀與管理在一個儲存池中所有的 ZFS 資料集。儲存池使用 [zpool](#zpool 管理) 來管理。\n建立與摧毀資料集 不同於傳統的磁碟與磁碟區管理程式 (Volume manager) ，在 ZFS 中的空間並不會預先分配。傳統的檔案系統在分割與分配空間完後，若沒有增加新的磁碟便無法再增加額外的檔案系統。在 ZFS，可以隨時建立新的檔案系統，每個資料集 (Dataset) 都有自己的屬性，包含壓縮 (Compression)、去重複 (Deduplication)、快取 (Caching) 與配額 (Quota) 功能以及其他有用的屬性如唯讀 (Readonly)、區分大小寫 (Case sensitivity)、網路檔案分享 (Network file sharing) 以及掛載點 (Mount point)。資料集可以存在於其他資料集中，且子資料集會繼承其父資料集的屬性。每個資料集都可以作為一個單位來管理、委託 (Delegate)、備份 (Replicate)、快照 (Snapshot)、監禁 ([Jail](#ZFS 與 Jail)) 與摧毀 (Destroy)，替每種不同類型或集合的檔案建立各別的資料集還有許多的好處。唯一的缺點是在當有非常大數量的資料集時，部份指令例如 zfs list 會變的較緩慢，且掛載上百個或其至上千個資料集可能會使 FreeBSD 的開機程序變慢。\n建立一個新資料集並開啟 LZ4 壓縮：\n# zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 781M 93.2G 144K none mypool/ROOT 777M 93.2G 144K none mypool/ROOT/default 777M 93.2G 777M / mypool/tmp 176K 93.2G 176K /tmp mypool/usr 616K 93.2G 144K /usr mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/ports 144K 93.2G 144K /usr/ports mypool/usr/src 144K 93.2G 144K /usr/src mypool/var 1.20M 93.2G 608K /var mypool/var/crash 148K 93.2G 148K /var/crash mypool/var/log 178K 93.2G 178K /var/log mypool/var/mail 144K 93.2G 144K /var/mail mypool/var/tmp 152K 93.2G 152K /var/tmp # zfs create -o compress=lz4 mypool/usr/mydataset # zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 781M 93.2G 144K none mypool/ROOT 777M 93.2G 144K none mypool/ROOT/default 777M 93.2G 777M / mypool/tmp 176K 93.2G 176K /tmp mypool/usr 704K 93.2G 144K /usr mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/mydataset 87.5K 93.2G 87.5K /usr/mydataset mypool/usr/ports 144K 93.2G 144K /usr/ports mypool/usr/src 144K 93.2G 144K /usr/src mypool/var 1.20M 93.2G 610K /var mypool/var/crash 148K 93.2G 148K /var/crash mypool/var/log 178K 93.2G 178K /var/log mypool/var/mail 144K 93.2G 144K /var/mail mypool/var/tmp 152K 93.2G 152K /var/tmp 摧毀資料集會比刪除所有在資料集上所殘留的檔案來的快，由於摧毀資料集並不會掃描所有檔案並更新所有相關的 Metadata。\n摧毀先前建立的資料集：\n# zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 880M 93.1G 144K none mypool/ROOT 777M 93.1G 144K none mypool/ROOT/default 777M 93.1G 777M / mypool/tmp 176K 93.1G 176K /tmp mypool/usr 101M 93.1G 144K /usr mypool/usr/home 184K 93.1G 184K /usr/home mypool/usr/mydataset 100M 93.1G 100M /usr/mydataset mypool/usr/ports 144K 93.1G 144K /usr/ports mypool/usr/src 144K 93.1G 144K /usr/src mypool/var 1.20M 93.1G 610K /var mypool/var/crash 148K 93.1G 148K /var/crash mypool/var/log 178K 93.1G 178K /var/log mypool/var/mail 144K 93.1G 144K /var/mail mypool/var/tmp 152K 93.1G 152K /var/tmp # zfs destroy mypool/usr/mydataset # zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 781M 93.2G 144K none mypool/ROOT 777M 93.2G 144K none mypool/ROOT/default 777M 93.2G 777M / mypool/tmp 176K 93.2G 176K /tmp mypool/usr 616K 93.2G 144K /usr mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/ports 144K 93.2G 144K /usr/ports mypool/usr/src 144K 93.2G 144K /usr/src mypool/var 1.21M 93.2G 612K /var mypool/var/crash 148K 93.2G 148K /var/crash mypool/var/log 178K 93.2G 178K /var/log mypool/var/mail 144K 93.2G 144K /var/mail mypool/var/tmp 152K 93.2G 152K /var/tmp 在最近版本的 ZFS，zfs destroy 是非同步的，且釋放出的空間會許要花費數分鐘才會出現在儲存池上，可使用 zpool get freeing poolname 來查看 freeing 屬性，這個屬性會指出資料集在背景已經釋放多少資料區塊了。若有子資料集，如快照 (Snapshot) 或其他資料集存在的話，則會無法摧毀父資料集。要摧毀一個資料集及其所有子資料集，可使用 -r 來做遞迴摧毀資料集及其所有子資料集，可用 -n -v 來列出會被這個操作所摧毀的資料集及快照，而不會真的摧毀，因摧毀快照所釋放出的空間也會同時顯示。\n建立與摧毀磁碟區 磁碟區 (Volume) 是特殊類型的資料集，不會被掛載成一個檔案系統，而是會被當做儲存區塊裝置出現在 /dev/zvol/poolname/dataset 下。這讓磁碟區可供其他檔案系統使用、拿來備份虛擬機器的磁碟或是使用 iSCSI 或 HAST 通訊協定匯出。\n磁碟區可以被格式化成任何檔案系統，或不使用檔案系統來儲存原始資料。對一般使用者，磁碟區就像是一般的磁碟，可以放置一般的檔案系統在這些 zvols 上，並提供一般磁碟或檔案系統一般所沒有的功能。例如，使用壓縮屬性在一個 250 MB 的磁碟區可建立一個壓縮的 FAT 檔案系統。\n# zfs create -V 250m -o compression=on tank/fat32 # zfs list tank NAME USED AVAIL REFER MOUNTPOINT tank 258M 670M 31K /tank # newfs_msdos -F32 /dev/zvol/tank/fat32 # mount -t msdosfs /dev/zvol/tank/fat32 /mnt # df -h /mnt | grep fat32 Filesystem Size Used Avail Capacity Mounted on /dev/zvol/tank/fat32 249M 24k 249M 0% /mnt # mount | grep fat32 /dev/zvol/tank/fat32 on /mnt (msdosfs, local) 摧毀一個磁碟區與摧毀一個一般的檔案系統資料集差不多。操作上幾乎是即時的，但在背景會需要花費數分鐘來讓釋放空間再次可用。\n重新命名資料集 資料集的名稱可以使用 zfs rename 更改。父資料集也同樣可以使用這個指令來更改名稱。重新命名一個資料集到另一個父資料集也會更改自父資料集繼承的屬性值。重新命名資料集後，會被卸載然後重新掛載到新的位置 (依繼承的新父資料集而定)，可使用 -u 來避免重新掛載。\n重新命名一個資料集並移動該資料集到另一個父資料集：\n# zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 780M 93.2G 144K none mypool/ROOT 777M 93.2G 144K none mypool/ROOT/default 777M 93.2G 777M / mypool/tmp 176K 93.2G 176K /tmp mypool/usr 704K 93.2G 144K /usr mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/mydataset 87.5K 93.2G 87.5K /usr/mydataset mypool/usr/ports 144K 93.2G 144K /usr/ports mypool/usr/src 144K 93.2G 144K /usr/src mypool/var 1.21M 93.2G 614K /var mypool/var/crash 148K 93.2G 148K /var/crash mypool/var/log 178K 93.2G 178K /var/log mypool/var/mail 144K 93.2G 144K /var/mail mypool/var/tmp 152K 93.2G 152K /var/tmp # zfs rename mypool/usr/mydataset mypool/var/newname # zfs list NAME USED AVAIL REFER MOUNTPOINT mypool 780M 93.2G 144K none mypool/ROOT 777M 93.2G 144K none mypool/ROOT/default 777M 93.2G 777M / mypool/tmp 176K 93.2G 176K /tmp mypool/usr 616K 93.2G 144K /usr mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/ports 144K 93.2G 144K /usr/ports mypool/usr/src 144K 93.2G 144K /usr/src mypool/var 1.29M 93.2G 614K /var mypool/var/crash 148K 93.2G 148K /var/crash mypool/var/log 178K 93.2G 178K /var/log mypool/var/mail 144K 93.2G 144K /var/mail mypool/var/newname 87.5K 93.2G 87.5K /var/newname mypool/var/tmp 152K 93.2G 152K /var/tmp 快照也可以像這樣重新命名，由於快照的本質使其無法被重新命名到另一個父資料集。要遞迴重新命名快照可指定 -r，然後在子資料集中所有同名的快照也會一併被重新命名。\n# zfs list -t snapshot NAME USED AVAIL REFER MOUNTPOINT mypool/var/newname@first_snapshot 0 - 87.5K - # zfs rename mypool/var/newname@first_snapshot new_snapshot_name # zfs list -t snapshot NAME USED AVAIL REFER MOUNTPOINT mypool/var/newname@new_snapshot_name 0 - 87.5K - 設定資料集屬性 每個 ZFS 資料集有數個屬性可以用來控制其行為。大部份的屬性會自動繼承自其父資料集，但可以被自己覆蓋。設定資料集上的屬性可使用 zfs set property=value dataset。大部份屬性有限制可用的值，zfs get 會顯示每個可以使用的屬性及其可用的值。大部份可以使用 zfs inherit 還原成其繼承的值。\n也可設定使用者自訂的屬性。這些屬性也會成為資料集設定的一部份，且可以被用來提供資料集或其內容的額外資訊。要分別自訂屬性與 ZFS 提供的屬性，會使用冒號 (:) 建立一個自訂命名空間供自訂屬性使用。\n# zfs set custom:costcenter=1234 tank # zfs get custom:costcenter tank NAME PROPERTY VALUE SOURCE tank custom:costcenter 1234 local 要移除自訂屬性，可用 zfs inherit 加上 -r。若父資料集未定義任何自訂屬性，將會將該屬性完全移除 (更改動作仍會記錄於儲存池的歷史記錄)。\n# zfs inherit -r custom:costcenter tank # zfs get custom:costcenter tank NAME PROPERTY VALUE SOURCE tank custom:costcenter - - # zfs get all tank | grep custom:costcenter # 取得與設定共享屬性 两个常用和有用的数据集属性是NFS和SMB共享选项。设置这些参数可以定义是否以及如何在网络上共享ZFS数据集。目前，FreeBSD只支持通过NFS设置共享。输入以下命令获取当前共享状态:\n# zfs get sharenfs mypool/usr/home NAME PROPERTY VALUE SOURCE mypool/usr/home sharenfs on local # zfs get sharesmb mypool/usr/home NAME PROPERTY VALUE SOURCE mypool/usr/home sharesmb off local 如果需要共享数据集，请输入:\n# zfs set sharenfs=on mypool/usr/home 还可以为通过NFS共享数据集设置额外的选项，例如-alldirs、-maprot和-network。如果要为NFS共享的数据集设置其他选项，请输入:\n# zfs set sharenfs=\"-alldirs,-maproot=root,-network=192.168.1.0/24\" mypool/usr/home 管理快照 (Snapshot) 快照 (Snapshot) 是 ZFS 最強大的功能之一。快照提供了資料集唯讀、單一時間點 (Point-in-Time) 的複製功能，使用了寫入時複製 (Copy-On-Write, COW) 的技術，可以透過保存在磁碟上的舊版資料快速的建立快照。若沒有快照存在，在資料被覆蓋或刪除時，便回收空間供未來使用。由於只記錄前一個版本與目前資料集的差異，因此快照可節省磁碟空間。快照只允許在整個資料集上使用，無法在各別檔案或目錄。當建立了一個資料集的快照時，便備份了所有內含的資料，這包含了檔案系統屬性、檔案、目錄、權限等等。第一次建立快照時只會使用到更改參照到資料區塊的空間，不會用到其他額外的空間。使用 -r 可以對使用同名的資料集及其所有子資料集的建立一個遞迴快照，提供一致且即時 (Moment-in-time) 的完整檔案系統快照功能，這對於那些彼此有相關或相依檔案存放在不同資料集的應用程式非常重要。不使用快照所備份的資料其實是分散不同時間點的。\nZFS 中的快照提供了多種功能，即使是在其他缺乏快照功能的檔案系統上。一個使用快照的典型例子是在安裝軟體或執行系統升級這種有風險的動作時，能有一個快速的方式可以備份檔案系統目前的狀態，若動作失敗，可以使用快照還原 (Roll back) 到與快照建立時相同的系統狀態，若升級成功，便可刪除快照來釋放空間。若沒有快照功能，升級失敗通常會需要使用備份來恢復 (Restore) 系統，而這個動作非常繁瑣、耗時且可能會需要停機一段時間系統無法使用。使用快照可以快速的還原，即使系統正在執行一般的運作，只而要短暫或甚至不需停機。能夠節省大量在有數 TB 的儲存系統上從備份複製所需資料的時間。快照並非要用來取代儲存池的完整備份，但可以用在快速且簡單的保存某個特定時間點的資料集。\n建立快照 快照可以使用 zfs snapshot dataset@snapshotname 來建立。加入 -r 可以遞迴對所有同名的子資料集建立快照。\n建立一個整個儲存池的遞迴快照：\n# zfs list -t all NAME USED AVAIL REFER MOUNTPOINT mypool 780M 93.2G 144K none mypool/ROOT 777M 93.2G 144K none mypool/ROOT/default 777M 93.2G 777M / mypool/tmp 176K 93.2G 176K /tmp mypool/usr 616K 93.2G 144K /usr mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/ports 144K 93.2G 144K /usr/ports mypool/usr/src 144K 93.2G 144K /usr/src mypool/var 1.29M 93.2G 616K /var mypool/var/crash 148K 93.2G 148K /var/crash mypool/var/log 178K 93.2G 178K /var/log mypool/var/mail 144K 93.2G 144K /var/mail mypool/var/newname 87.5K 93.2G 87.5K /var/newname mypool/var/newname@new_snapshot_name 0 - 87.5K - mypool/var/tmp 152K 93.2G 152K /var/tmp # zfs snapshot -r mypool@my_recursive_snapshot # zfs list -t snapshot NAME USED AVAIL REFER MOUNTPOINT mypool@my_recursive_snapshot 0 - 144K - mypool/ROOT@my_recursive_snapshot 0 - 144K - mypool/ROOT/default@my_recursive_snapshot 0 - 777M - mypool/tmp@my_recursive_snapshot 0 - 176K - mypool/usr@my_recursive_snapshot 0 - 144K - mypool/usr/home@my_recursive_snapshot 0 - 184K - mypool/usr/ports@my_recursive_snapshot 0 - 144K - mypool/usr/src@my_recursive_snapshot 0 - 144K - mypool/var@my_recursive_snapshot 0 - 616K - mypool/var/crash@my_recursive_snapshot 0 - 148K - mypool/var/log@my_recursive_snapshot 0 - 178K - mypool/var/mail@my_recursive_snapshot 0 - 144K - mypool/var/newname@new_snapshot_name 0 - 87.5K - mypool/var/newname@my_recursive_snapshot 0 - 87.5K - mypool/var/tmp@my_recursive_snapshot 0 - 152K - 建立的快照不會顯示在一般的 zfs list 操作結果，要列出快照需在 zfs list 後加上 -t snapshot，使用 -t all 可以同時列出檔案系統的內容及快照。\n快照並不會直接掛載，因此 MOUNTPOINT 欄位的路徑如此顯示。在 AVAIL 欄位不會有可用的磁碟空間，因為快照建立之後便無法再寫入。比較快照與其原來建立時的資料集：\n# zfs list -rt all mypool/usr/home NAME USED AVAIL REFER MOUNTPOINT mypool/usr/home 184K 93.2G 184K /usr/home mypool/usr/home@my_recursive_snapshot 0 - 184K - 同時顯示資料集與快照可以了解快照如何使用 COW 技術來運作。快照只會保存有更動 (差異) 的資料，並非整個檔案系統的內容，這個意思是說，快照只會在有做更動時使用一小部份的空間，複製一個檔案到該資料集，可以讓空間使用量變的更明顯，然後再做第二個快照：\n# cp /etc/passwd /var/tmp # zfs snapshot mypool/var/tmp@after_cp # zfs list -rt all mypool/var/tmp NAME USED AVAIL REFER MOUNTPOINT mypool/var/tmp 206K 93.2G 118K /var/tmp mypool/var/tmp@my_recursive_snapshot 88K - 152K - mypool/var/tmp@after_cp 0 - 118K - 第二快照只會包含了資料集做了複製動作後的更動，這樣的機制可以節省大量的空間。注意在複製之後快照 mypool/var/tmp@my_recursive_snapshot 於 USED 欄位中的大小也更改了，這說明了這個更動在前次快照與之後快照間的關係。\n比對快照 ZFS 提供了內建指令可以用來比對兩個快照 (Snapshot) 之間的差異，在使用者想要查看一段時間之間檔案系統所的變更時非常有用。例如 zfs diff 可以讓使用者在最後一次快照中找到意外刪除的檔案。對前面一節所做的兩個快照使用這個指令會產生以下結果：\n# zfs list -rt all mypool/var/tmp NAME USED AVAIL REFER MOUNTPOINT mypool/var/tmp 206K 93.2G 118K /var/tmp mypool/var/tmp@my_recursive_snapshot 88K - 152K - mypool/var/tmp@after_cp 0 - 118K - # zfs diff mypool/var/tmp@my_recursive_snapshot M /var/tmp/ + /var/tmp/passwd 指令會列出指定快照 (在這個例子中為 mypool/var/tmp@my_recursive_snapshot) 與目前檔案系統間的更改。第一個欄位是更改的類型：\n   类型 含义     + 加入了該路徑或檔案。   - 刪除了該路徑或檔案。   M 修改了該路徑或檔案。   R 重新命名了該路徑或檔案。    對照這個表格來看輸出的結果，可以明顯的看到 passwd 是在快照 mypool/var/tmp@my_recursive_snapshot 建立之後才加入的，結果也同樣看的到掛載到 /var/tmp 的父目錄已經做過修改。\n在使用 ZFS 備份功能來傳輸一個資料集到另一個主機備份時比對兩個快照也同樣很有用。\n比對兩個快照需要提供兩個資料集的完整資料集名稱與快照名稱：\n# cp /var/tmp/passwd /var/tmp/passwd.copy # zfs snapshot mypool/var/tmp@diff_snapshot # zfs diff mypool/var/tmp@my_recursive_snapshot mypool/var/tmp@diff_snapshot M /var/tmp/ + /var/tmp/passwd + /var/tmp/passwd.copy # zfs diff mypool/var/tmp@my_recursive_snapshot mypool/var/tmp@after_cp M /var/tmp/ + /var/tmp/passwd 備份管理者可以比對兩個自傳送主機所接收到的兩個快照並查看實際在資料集中的變更。請參考 備份 一節來取得更多資訊。\n使用快照還原 只要至少有一個可用的快照便可以隨時還原。大多數在已不需要目前資料集，想要改用較舊版的資料的情況，例如，本地開發的測試發生錯誤、不良的系統更新破壞了系統的整體功能或需要還原意外刪除檔案或目錄 … 等，都是非常常見的情形。幸運的，要還原到某個快照只需要簡單輸入 zfs rollback snapshotname。會依快照所做的變更數量來決定處理的時間，還原的操作會在一段時間後完成。在這段時間中，資料集會一直保持一致的狀態，類似一個符合 ACID 原則的資料庫在做還原。還原可在資料集處於上線及可存取的情況下完成，不需要停機。還原到快照之後，資料集便回到當初執行快照時相同的狀態，所有沒有在快照中的其他資料便會被丟棄，因此往後若還有可能需要部份資料時，建議在還原到前一個快照之前先對目前的資料集做快照，這樣一來，使用者便可以在快照之間來回快換，而不會遺失重要的資料。\n在第一個範例中，因為 rm 操作不小心移除了預期外的資料，要還原到快照。\n# zfs list -rt all mypool/var/tmp NAME USED AVAIL REFER MOUNTPOINT mypool/var/tmp 262K 93.2G 120K /var/tmp mypool/var/tmp@my_recursive_snapshot 88K - 152K - mypool/var/tmp@after_cp 53.5K - 118K - mypool/var/tmp@diff_snapshot 0 - 120K - # ls /var/tmp passwd passwd.copy vi.recover # rm /var/tmp/passwd* # ls /var/tmp vi.recover 在此時，使用者發現到刪除了太多檔案並希望能夠還原。ZFS 提供了簡單的方可以取回檔案，便是使用還原 (Rollback)，但這只在有定期對重要的資料使用快照時可用。要拿回檔案並從最後一次快照重新開始，可執行以下指令：\n# zfs rollback mypool/var/tmp@diff_snapshot # ls /var/tmp passwd passwd.copy vi.recover 還原操作會將資料集還原為最後一次快照的狀態。這也可以還原到更早之前，有其他在其之後建立的快照。要這麼做時，ZFS 會發出這個警告：\n# zfs list -rt snapshot mypool/var/tmp AME USED AVAIL REFER MOUNTPOINT mypool/var/tmp@my_recursive_snapshot 88K - 152K - mypool/var/tmp@after_cp 53.5K - 118K - mypool/var/tmp@diff_snapshot 0 - 120K - # zfs rollback mypool/var/tmp@my_recursive_snapshot cannot rollback to 'mypool/var/tmp@my_recursive_snapshot': more recent snapshots exist use '-r' to force deletion of the following snapshots: mypool/var/tmp@after_cp mypool/var/tmp@diff_snapshot 這個警告是因在該快照與資料集的目前狀態之間有其他快照存在，然而使用者想要還原到該快照。要完成這樣的還原動作，必須刪除在這之間的快照，因為 ZFS 無法追蹤不同資料集狀態間的變更。在使用者未指定 -r 來確認這個動作前，ZFS 不會刪除受影響的快照。若確定要這麼做，那麼必須要知道會遺失所有在這之間的快照，然後可執行以下指令：\n# zfs rollback -r mypool/var/tmp@my_recursive_snapshot # zfs list -rt snapshot mypool/var/tmp NAME USED AVAIL REFER MOUNTPOINT mypool/var/tmp@my_recursive_snapshot 8K - 152K - # ls /var/tmp vi.recover 可從 zfs list -t snapshot 的結果來確認 zfs rollback -r 會移除的快照。\n從快照還原個別檔案 快照會掛載在父資料集下的隱藏目錄：.zfs/snapshots/snapshotname。預設不會顯示這些目錄，即使是用 ls -a 指令。雖然該目錄不會顯示，但該目錄實際存在，而且可以像一般的目錄一樣存取。一個名稱為 snapdir 的屬性可以控制是否在目錄清單中顯示這些隱藏目錄，設定該屬性為可見 (visible) 可以讓這些目錄出現在 ls 以及其他處理目錄內容的指令中。\n# zfs get snapdir mypool/var/tmp NAME PROPERTY VALUE SOURCE mypool/var/tmp snapdir hidden default # ls -a /var/tmp . .. passwd vi.recover # zfs set snapdir=visible mypool/var/tmp # ls -a /var/tmp . .. .zfs passwd vi.recover 要還原個別檔案到先前的狀態非常簡單，只要從快照中複製檔案到父資料集。在 .zfs/snapshot 目錄結構下有一個與先前所做的快照名稱相同的目錄，可以很容易的找到。在下個範例中，我們會示範從隱藏的 .zfs 目錄還原一個檔案，透過從含有該檔案的最新版快照複製：\n# rm /var/tmp/passwd # ls -a /var/tmp . .. .zfs vi.recover # ls /var/tmp/.zfs/snapshot after_cp my_recursive_snapshot # ls /var/tmp/.zfs/snapshot/after_cp passwd vi.recover # cp /var/tmp/.zfs/snapshot/after_cp/passwd /var/tmp 執行 ls .zfs/snapshot 時，雖然 snapdir 可能已經設為隱藏，但仍可能可以顯示該目錄中的內容，這取決於管理者是否要顯示這些目錄，可以只顯示特定的資料集，而其他的則不顯示。從這個隱藏的 .zfs/snapshot 複製檔案或目錄非常簡單，除此之外，嘗試其他的動作則會出現以下錯誤：\n# cp /etc/rc.conf /var/tmp/.zfs/snapshot/after_cp/ cp: /var/tmp/.zfs/snapshot/after_cp/rc.conf: Read-only file system 這個錯誤用來提醒使用者快照是唯讀的，在建立之後不能更改。無法複製檔案進去或從該快照目錄中移除，因為這會變更該資料集所代表的狀態。\n快照所消耗的空間是依據自快照之後父檔案系統做了多少變更來決定，快照的 written 屬性可以用來追蹤有多少空間被快照所使用。\n使用 zfs destroy dataset@snapshot 可以摧毀快照並回收空間。加上 -r 可以遞迴移除所有在父資料集下使用同名的快照。加入 -n -v 來顯示將要移除的快照清單以及估計回收的空間，而不會實際執行摧毀的操作。\n管理複本 (Clone) 複本 (Clone) 是快照的複製，但更像是一般的資料集，與快照不同的是，複本是非唯讀的 (可寫)，且可掛載，可以有自己的屬性。使用 zfs clone 建立複本之後，便無法再摧毀用來建立複本的快照。複本與快照的父/子關係可以使用 zfs promote 來對換。提升複本之後 ，快照便會成為複本的子資料集，而不是原來的父資料集，這個動作會改變空間計算的方式，但並不會實際改變空間的使用量。複本可以被掛載到 ZFS 檔案系統階層中的任何一點，並非只能位於原來快照的位置底下。\n要示範複本功能會用到這個範例資料集：\n# zfs list -rt all camino/home/joe NAME USED AVAIL REFER MOUNTPOINT camino/home/joe 108K 1.3G 87K /usr/home/joe camino/home/joe@plans 21K - 85.5K - camino/home/joe@backup 0K - 87K - 會使用到複本一般是要在可以保留快照以便出錯時可還原的情況下使用指定的資料集做實驗，由於快照並無法做更改，所以會建立一個可以讀/寫的快照複本。當在複本中做完想要執行的動作後，便可以提升複本成資料集，然後移除舊的檔案系統。嚴格來說這並非必要，因為複本與資料集可同時存在，不會有任何問題。\n# zfs clone camino/home/joe@backup camino/home/joenew # ls /usr/home/joe* /usr/home/joe: backup.txz plans.txt /usr/home/joenew: backup.txz plans.txt # df -h /usr/home Filesystem Size Used Avail Capacity Mounted on usr/home/joe 1.3G 31k 1.3G 0% /usr/home/joe usr/home/joenew 1.3G 31k 1.3G 0% /usr/home/joenew 建立完的複本便有與建立快照時狀態相同的資料集，現在複本可以獨立於原來的資料集來做更改。剩下唯一與資料集之間的關係便是快照，ZFS 會在屬性 origin 記錄這個關係，一旦在快照與複本之間的相依關係因為使用 zfs promote 提升而移除時，複本的 origin 也會因為成為一個完全獨立的資料集而移除。以下範例會示範這個動作：\n# zfs get origin camino/home/joenew NAME PROPERTY VALUE SOURCE camino/home/joenew origin camino/home/joe@backup - # zfs promote camino/home/joenew # zfs get origin camino/home/joenew NAME PROPERTY VALUE SOURCE camino/home/joenew origin - - 做為部份更改之後，例如複製 loader.conf 到提升後的複本，這個例子中的舊目錄便無須保留，取而代之的是提升後的複本，這個動作可以用兩個連續的指令來完成：在舊資料集上執行 zfs destroy 並在與舊資料相似名稱 (也可能用完全不同的名稱) 的複本上執行 zfs rename。\n# cp /boot/defaults/loader.conf /usr/home/joenew # zfs destroy -f camino/home/joe # zfs rename camino/home/joenew camino/home/joe # ls /usr/home/joe backup.txz loader.conf plans.txt # df -h /usr/home Filesystem Size Used Avail Capacity Mounted on usr/home/joe 1.3G 128k 1.3G 0% /usr/home/joe 快照的複本現在可以如同一般資料集一樣使用，它的內容包含了所有來自原始快照的資料以及後來加入的檔案，例如 loader.conf。複本可以在許多不同的情境下使用提供 ZFS 的使用者有用的功能，例如，Jail 可以透過含有已安裝了各種應用程式集的快照來提供，使用者可以複製這些快照然後加入自己想要嘗試的應用程式，一但更改可以滿足需求，便可提升複本為完整的資料集然後提供給終端使用者，讓終端使用者可以如同實際擁有資料集一般的使用，這個以節省提供這些 Jail 的時間與管理成本。\n備份 (Replication) 將資料保存在單一地點的單一儲存池上會讓資料暴露在盜竊、自然或人為的風險之下，定期備份整個儲存池非常重要，ZFS 提供了內建的序列化 (Serialization) 功能可以將資料以串流傳送到標準輸出。使用這項技術，不僅可以將資料儲存到另一個已連結到本地系統的儲存池，也可以透過網路將資料傳送到另一個系統，這種備份方式以快照為基礎 (請參考章節 ZFS 快照(Snapshot))。用來備份資料的指令為 zfs send 及 zfs receive。\n以下例子將示範使用兩個儲存池來做 ZFS 備份：\n# zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT backup 960M 77K 896M - - 0% 0% 1.00x ONLINE - mypool 984M 43.7M 940M - - 0% 4% 1.00x ONLINE - 名為 mypool 的儲存池為主要的儲存池，資料會定期寫入與讀取的位置。第二個儲存池 backup 用來待命 (Standby)，萬一主要儲存池無法使用時可替換。注意，ZFS 並不會自動做容錯移轉 (Fail-over)，必須要由系統管理者在需要的時候手動完成。快照會用來提供一個與檔系統一致的版本來做備份，mypool 的快照建立之後，便可以複製到 backup 儲存池，只有快照可以做備份，最近一次快照之後所做的變更不會含在內容裡面。\n# zfs snapshot mypool@backup1 # zfs list -t snapshot NAME USED AVAIL REFER MOUNTPOINT mypool@backup1 0 - 43.6M - 快照存在以後，便可以使用 zfs send 來建立一個代表快照內容的串流，這個串流可以儲存成檔案或由其他儲存池接收。串流會寫入到標準輸出，但是必須要重新導向到一個檔案或轉接到其他地方，否則會錯誤：\n# zfs send mypool@backup1 Error: Stream can not be written to a terminal. You must redirect standard output. 要使用 zfs send 備份一個資料集，可重新導向到一個位於在已掛載到備份儲存池上的檔案。確定該儲存池有足夠的空間容納要傳送的快照，這裡指的是該快照中內含的所有資料，並非只有上次快照到該快照間的變更。\n# zfs send mypool@backup1  /backup/backup1 # zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT backup 960M 63.7M 896M - - 0% 6% 1.00x ONLINE - mypool 984M 43.7M 940M - - 0% 4% 1.00x ONLINE - zfs send 會傳輸在快照 backup1 中所有的資料到儲存池 backup。可以使用 cron(8) 排程來自動完成建立與傳送快照的動作。\n若不想將備份以封存檔案儲存，ZFS 可用實際的檔案系統來接收資料，讓備份的資料可以直接被存取。要取得實際包含在串流中的資料可以用 zfs receive 將串流轉換回檔案與目錄。以下例子會以管線符號連接 zfs send 及 zfs receive，將資料從一個儲存池複製到另一個，傳輸完成後可以直接使用接收儲存池上的資料。一個資料集只可以被複製到另一個空的資料集。\n# zfs snapshot mypool@replica1 # zfs send -v mypool@replica1 | zfs receive backup/mypool send from @ to mypool@replica1 estimated size is 50.1M total estimated size is 50.1M TIME SENT SNAPSHOT # zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT backup 960M 63.7M 896M - - 0% 6% 1.00x ONLINE - mypool 984M 43.7M 940M - - 0% 4% 1.00x ONLINE - 漸進式備份 zfs send 也可以比較兩個快照之間的差異，並且只傳送兩者之間的差異，這麼做可以節省磁碟空間及傳輸時間。例如：\n# zfs snapshot mypool@replica2 # zfs list -t snapshot NAME USED AVAIL REFER MOUNTPOINT mypool@replica1 5.72M - 43.6M - mypool@replica2 0 - 44.1M - # zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT backup 960M 61.7M 898M - - 0% 6% 1.00x ONLINE - mypool 960M 50.2M 910M - - 0% 5% 1.00x ONLINE - 會建立一個名為 replica2 的第二個快照，這個快照只中只會含有目前與前次快照 replica1 之間檔案系統所做的變更。使用 zfs send -i 並指定要用來產生漸進備份串流的快照，串流中只會含有做過更改的資料。這個動作只在接收端已經有初始快照時才可用。\n# zfs send -v -i mypool@replica1 mypool@replica2 | zfs receive /backup/mypool send from @replica1 to mypool@replica2 estimated size is 5.02M total estimated size is 5.02M TIME SENT SNAPSHOT # zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT backup 960M 80.8M 879M - - 0% 8% 1.00x ONLINE - mypool 960M 50.2M 910M - - 0% 5% 1.00x ONLINE - # zfs list NAME USED AVAIL REFER MOUNTPOINT backup 55.4M 240G 152K /backup backup/mypool 55.3M 240G 55.2M /backup/mypool mypool 55.6M 11.6G 55.0M /mypool # zfs list -t snapshot NAME USED AVAIL REFER MOUNTPOINT backup/mypool@replica1 104K - 50.2M - backup/mypool@replica2 0 - 55.2M - mypool@replica1 29.9K - 50.0M - mypool@replica2 0 - 55.0M - 如此一來，便成功傳輸漸進式的串流，只有做過更改的資料會被備份，不會傳送完整的 replica1。由於不會備份完整的儲存池，只傳送差異的部份，所以可以減少傳輸的時間並節省磁碟空間，特別是在網路緩慢或需要考量每位元傳輸成本時非常有用。\n從儲存池 mypool 複製所有檔案與資料的新檔案系統 backup/mypool 便可以使用。若指定 -P，會一併複製資料集的屬性，這包含壓縮 (Compression) 設定，配額 (Quota) 及掛載點 (Mount point)。若指定 -R，會複製所有指定資料集的子資料集，及這些子資料集的所有屬性。可將傳送與接收自動化來定期使用第二個儲存池做備份。\n透過 SSH 傳送加密的備份 透過網路來傳送串流是一個做遠端備份不錯的方式，但是也有一些缺點，透過網路連線傳送的資料沒有加密，這會讓任何人都可以在未告知傳送方的情況下攔截並轉換串流回資料，這是我們所不想見到的情況，特別是在使用網際網路傳送串流到遠端的主機時。SSH 可用來加密要透過網路連線傳送的資料，在 ZFS 只需要將串流重新導向到標準輸出，如此一來便可簡單的轉接到 SSH。若要讓檔案系統內容在傳送或在遠端系統中也維持在加密的狀態可考慮使用 PEFS。\n有一些設定以及安全性注意事項必須先完成，只有對 zfs send 操作必要的步驟才會在此說明，要取得更多有關 SSH 的資訊請參考 OpenSSH。\n必要的環境設定：\n  使用 SSH 金鑰設定傳送端與接收端間無密碼的 SSH 存取\n  正常會需要 root 的權限來傳送與接收串流，這需要可以 root 登入到接收端系統。但是，預設因安全性考慮會關閉以 root 登入。ZFS 委託 (ZFS Delegation) 系統可以用來允許一個非 root 使用者在每個系統上執行各自的發送與接收操作。\n  在傳送端系統上：\n# zfs allow -u someuser send,snapshot mypool   要掛載儲存池，無權限的使用者必須擁有該目錄且必須允許一般的使用者掛載檔案系統。在接收端系統上：\n# sysctl vfs.usermount=1 vfs.usermount: 0 - 1 # sysrc -f /etc/sysctl.conf vfs.usermount=1 # zfs create recvpool/backup # zfs allow -u someuser create,mount,receive recvpool/backup # chown someuser /recvpool/backup   無權限的使用者現在有能力可以接收並掛載資料集，且 home 資料集可以被複製到遠端系統：\n% zfs snapshot -r mypool/home@monday % zfs send -R mypool/home@monday | ssh someuser@backuphost zfs recv -dvu recvpool/backup 替儲存在儲存池 mypool 上的檔案系統資料集 home 製作一個遞迴快照 monday，然後使用 zfs send -R 來傳送包含該資料集及其所有子資料集、快照、複製與設定的串流。輸出會被導向到 SSH 連線的遠端主機 backuphost 上等候輸入的 zfs receive，在此建議使用完整網域名稱或 IP 位置。接收端的機器會寫入資料到 recvpool 儲存池上的 backup 資料集，在 zfs recv 加上 -d 可覆寫在接收端使用相同名稱的快照，加上 -u 可讓檔案系統在接收端不會被掛載，當使用 -v，會顯示更多有關傳輸的詳細資訊，包含已花費的時間及已傳輸的資料量。\n資料集、使用者以及群組配額 資料集配額 (Dataset quota) 可用來限制特定資料集可以使用的的空間量。參考配額 (Reference Quota) 的功能也非常相似，差在參考配額只會計算資料集自己使用的空間，不含快照與子資料集。類似的，使用者 (User) 與群組 (Group) 配額可以用來避免使用者或群組用掉儲存池或資料集的所有空間。\n要設定 storage/home/bob 的資料集配額為 10 GB：\n# zfs set quota=10G storage/home/bob 要設定 storage/home/bob 的參考配額為 10 GB：\n# zfs set refquota=10G storage/home/bob 要移除 storage/home/bob 的 10 GB 配額：\n# zfs set quota=none storage/home/bob 設定使用者配額的一般格式為 userquota@user=size 使用者的名稱必須使用以下格式：\n POSIX 相容的名稱，如 joe。 POSIX 數字 ID，如 789。 SID 名稱，如 joe.bloggs@example.com。 SID 數字 ID，如 S-1-123-456-789。  例如，要設定使用者名為 joe 的使用者配額為 50 GB：\n# zfs set userquota@joe=50G 要移除所有配額：\n# zfs set userquota@joe=none  使用者配額的屬性不會顯示在 zfs get all。非 root 的使用者只可以看到自己的配額，除非它們有被授予 userquota 權限，擁有這個權限的使用者可以檢視與設定任何人的配額。\n 要設定群組配額的一般格式為：groupquota@group=size。\n要設定群組 firstgroup 的配額為 50 GB 可使用：\n# zfs set groupquota@firstgroup=50G 要移除群組 firstgroup 的配額，或確保該群組未設定配額可使用：\n# zfs set groupquota@firstgroup=none 如同使用者配額屬性，非 root 使用者只可以查看自己所屬群組的配額。而 root 或擁有 groupquota 權限的使用者，可以檢視並設定所有群組的任何配額。\n要顯示在檔案系統或快照上每位使用者所使用的空間量及配額可使用 zfs userspace，要取得群組的資訊則可使用 zfs groupspace，要取得有關支援的選項資訊或如何只顯示特定選項的資訊請參考 zfs(1)。\n有足夠權限的使用者及 root 可以使用以下指令列出 storage/home/bob 的配額：\n# zfs get quota storage/home/bob 保留空間 保留空間 (Reservation) 可以確保資料集最少可用的空間量，其他任何資料集無法使用保留的空間，這個功能在要確保有足夠的可用空間來存放重要的資料集或日誌檔時特別有用。\nreservation 屬性的一般格式為 reservation=size，所以要在 storage/home/bob 設定保留 10 GB 的空間可以用：\n# zfs set reservation=10G storage/home/bob 要清除任何保留空間：\n# zfs set reservation=none storage/home/bob 同樣的原則可以應用在 refreservation 屬性來設定參考保留空間 (Reference Reservation)，參考保留空間的一般格式為 refreservation=size。\n這個指令會顯示任何已設定於 storage/home/bob 的 reservation 或 refreservation：\n# zfs get reservation storage/home/bob # zfs get refreservation storage/home/bob 壓縮 (Compression) ZFS 提供直接的壓縮功能，在資料區塊層級壓縮資料不僅可以節省空間，也可以增加磁碟的效能。若資料壓縮了 25%，但壓縮的資料會使用了與未壓縮版本相同的速率寫入到磁碟，所以實際的寫入速度會是原來的 125%。壓縮功能也可來替代去重複 (Deduplication) 功能，因為壓縮並不需要使用額外的記憶體。\nZFS 提了多種不同的壓縮演算法，每一種都有不同的優缺點，隨著 ZFS v5000 引進了 LZ4 壓縮技術，可對整個儲存池開啟壓縮，而不像其他演算法需要消耗大量的效能來達成，最大的優點是 LZ4 擁有 提早放棄 的功能，若 LZ4 無法在資料一開始的部份達成至少 12.5% 的壓縮率，便會以不壓縮的方式來寫入資料區塊來避免 CPU 在那些已經壓縮過或無法壓縮的資料上浪費運算能力。要取得更多有關 ZFS 中可用的壓縮演算法詳細資訊，可參考術語章節中的壓縮 (Compression) 項目。\n管理者可以使用資料集的屬性來監視壓縮的效果。\n# zfs get used,compressratio,compression,logicalused mypool/compressed_dataset NAME PROPERTY VALUE SOURCE mypool/compressed_dataset used 449G - mypool/compressed_dataset compressratio 1.11x - mypool/compressed_dataset compression lz4 local mypool/compressed_dataset logicalused 496G - 資料集目前使用了 449 GB 的空間 (在 used 屬性)。在尚未壓縮前，該資料集應該會使用 496 GB 的空間 (於 logicalused 屬性)，這個結果顯示目前的壓縮比為 1.11:1。\n壓縮功能在與使用者配額 (User Quota) 一併使用時可能會產生無法預期的副作用。使用者配額會限制一個使用者在一個資料集上可以使用多少空間，但衡量的依據是以 壓縮後 所使用的空間，因此，若一個使用者有 10 GB 的配額，寫入了 10 GB 可壓縮的資料，使用者將還會有空間儲存額外的資料。若使用者在之後更新了一個檔案，例如一個資料庫，可能有更多或較少的可壓縮資料，那麼剩餘可用的空間量也會因此而改變，這可能會造成奇怪的現象便是，一個使用者雖然沒有增加實際的資料量 (於 logicalused 屬性)，但因為更改影響了壓縮率，導致使用者達到配額的上限。\n壓縮功能在與備份功能一起使用時也可能會有類似的問題，通常會使用配額功能來限制能夠儲存的資料量來確保有足夠的備份空間可用。但是由於配額功能並不會考量壓縮狀況，可能會有比未壓縮版本備份更多的資料量會被寫入到資料集。\n去重複 (Deduplication) 當開啟，去重複 (Deduplication) 功能會使用每個資料區塊的校驗碼 (Checksum) 來偵測重複的資料區塊，當新的資料區塊與現有的資料區塊重複，ZFS 便會寫入連接到現有資料的參考來替代寫入重複的資料區塊，這在資料中有大量重複的檔案或資訊時可以節省大量的空間，要注意的是：去重複功能需要使用大量的記憶體且大部份可節省的空間可改開啟壓縮功能來達成，而壓縮功能不需要使用額外的記憶體。\n要開啟去重複功能，需在目標儲存池設定 dedup 屬性：\n# zfs set dedup=on pool 只有要被寫入到儲存池的新資料才會做去重複的動作，先前已被寫入到儲存池的資料不會因此啟動了這個選項而做去重複。查看已開啟去重複屬性的儲存池會如下：\n# zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT pool 2.84G 2.19M 2.83G - - 0% 0% 1.00x ONLINE - DEDUP 欄位會顯示儲存池的實際去重複率，數值為 1.00x 代表資料尚未被去重複。在下一個例子會在前面所建立的去重複儲存池中複製三份 Port 樹到不同的目錄中。\n# for d in dir1 dir2 dir3; do  mkdir $d \u0026\u0026 cp -R /usr/ports $d \u0026  done 已經偵測到重複的資料並做去重複：\n# zpool list NAME SIZE ALLOC FREE CKPOINT EXPANDSZ FRAG CAP DEDUP HEALTH ALTROOT pool 2.84G 20.9M 2.82G - - 0% 0% 3.00x ONLINE - DEDUP 欄位顯示有 3.00x 的去重複率，這代表已偵測到多份複製的 Port 樹資料並做了去重複的動作，且只會使用第三份資料所佔的空間。去重複能節省空間的潛力可以非常巨大，但會需要消耗大量的記憶體來持續追蹤去重複的資料區塊。\n去重複並非總是有效益的，特別是當儲存池中的資料本身並沒有重複時。ZFS 可以透過在現有儲存池上模擬開啟去重複功能來顯示可能節省的空間：\n# zdb -S pool Simulated DDT histogram: bucket allocated referenced ______ ______________________________ ______________________________ refcnt blocks LSIZE PSIZE DSIZE blocks LSIZE PSIZE DSIZE ------ ------ ----- ----- ----- ------ ----- ----- ----- 1 2.58M 289G 264G 264G 2.58M 289G 264G 264G 2 206K 12.6G 10.4G 10.4G 430K 26.4G 21.6G 21.6G 4 37.6K 692M 276M 276M 170K 3.04G 1.26G 1.26G 8 2.18K 45.2M 19.4M 19.4M 20.0K 425M 176M 176M 16 174 2.83M 1.20M 1.20M 3.33K 48.4M 20.4M 20.4M 32 40 2.17M 222K 222K 1.70K 97.2M 9.91M 9.91M 64 9 56K 10.5K 10.5K 865 4.96M 948K 948K 128 2 9.50K 2K 2K 419 2.11M 438K 438K 256 5 61.5K 12K 12K 1.90K 23.0M 4.47M 4.47M 1K 2 1K 1K 1K 2.98K 1.49M 1.49M 1.49M Total 2.82M 303G 275G 275G 3.20M 319G 287G 287G dedup = 1.05, compress = 1.11, copies = 1.00, dedup * compress / copies = 1.16 在 zdb -S 分析完儲存池後會顯示在啟動去重複後可達到的空間減少比例。在本例中，1.16 是非常差的空間節省比例，因為這個比例使用壓縮功能便能達成。若在此儲存池上啟動去重複並不能明顯的節省空間使用量，那麼就不值得耗費大量的記憶體來開啟去重複功能。透過公式 ratio = dedup * compress / copies，系統管理者可以規劃儲存空間的配置，來判斷要處理的資料是否有足夠的重複資料區塊來平衡所需的記憶體。若資料是可壓縮的，那麼空間節少的效果可能會非常好，建議先開啟壓縮功能，且壓縮功能也可以大大提高效能。去重複功能只有在可以節省可觀的空間且有足夠的記憶體做 DDT 時才開啟。\nZFS 與 Jail zfs jail 以及相關的 jailed 屬性可以用來將一個 ZFS 資料集委託給一個 Jail 管理。zfs jail *jailid* 可以將一個資料集連結到一個指定的 Jail，而 zfs unjail 則可解除連結。資料集要可以在 Jail 中控制需設定 jailed 屬性，一旦資料集被隔離便無法再掛載到主機，因為有掛載點可能會破壞主機的安全性。\n委託管理 一個全面性的權限委託系統可能無權限的使用者執行 ZFS 的管理功能。例如，若每個使用者的家目錄均為一個資料集，便可以給予使用者權限建立與摧毀它們家目錄中的快照。可以給予備份使用者使用備份功能的權限。一個使用量統計的 Script 可以允許其在執行時能存取所有使用者的空間利用率資料。甚至可以將委託權限委託給其他人，每個子指令與大多數屬性都可使用權限委託。\n委託資料集建立 zfs allow someuser create mydataset 可以給予指定的使用者在指定的父資料集下建立子資料集的權限。這裡需要注意：建立新資料集會牽涉到掛載，因此需要設定 FreeBSD 的 vfs.usermount sysctl(8) 為 1 來允許非 root 的使用者掛載一個檔案系統。這裡還有另一項限制可以避免濫用：非 root 使用者必須擁有掛載點在檔案系統中所在位置的權限才可掛載。\n委託權限委託 zfs allow someuser allow mydataset 可以給予指定的使用者有權限指派它們在目標資料集或其子資料集上擁有的任何權限給其他人。若該使用者擁有 snapshot 權限及 allow 權限，則該使用者可以授權 snapshot 權限給其他使用者。\n進階主題 調校 這裡有數個可調校的項目可以調整，來讓 ZFS 在面對各種工作都能以最佳狀況運作。\n…\ni386 上的 ZFS ZFS 所提供的部份功能需要使用大量記憶體，且可能需要對有限 RAM 的系統調校來取得最佳的效率。\n記憶體 最低需求，總系統記憶體應至少有 1 GB，建議的 RAM 量需視儲存池的大小以及使用的 ZFS 功能而定。一般的經驗法則是每 1 TB 的儲存空間需要 1 GB 的 RAM，若有開啟去重複的功能，一般的經驗法則是每 1 TB 的要做去重複的儲存空間需要 5 GB 的 RAM。雖然有部份使用者成功使用較少的 RAM 來運作 ZFS，但系統在負載較重時有可能會因為記憶用耗而導致當機，對於要使用低於建議 RAM 需求量來運作的系統可能會需要更進一步的調校。\n核心設定 由於在 i386™ 平台上位址空間的限制，在 i386™ 架構上的 ZFS 使用者必須加入這個選項到自訂核心設定檔，重新編譯核心並重新開啟：\noptions KVA_PAGES=512 這個選項會增加核心位址空間，允許調整 vm.kvm_size 超出目前的 1 GB 限制或在 PAE 的 2 GB 限制。要找到這個選項最合適的數值，可以將想要的位址空間換算成 MB 然後除以 4，在本例中，以 2 GB 計算後即為 512。\n載入程式可調參數 在所有的 FreeBSD 架構上均可增加 kmem 位址空間，經測試在一個 1 GB 實體記憶體的測試系統上，加入以下選項到 /boot/loader.conf，重新開啟系統，可成功設定：\nvm.kmem_size=\"330M\" vm.kmem_size_max=\"330M\" vfs.zfs.arc_max=\"40M\" vfs.zfs.vdev.cache.size=\"5M\" 要取得更多詳細的 ZFS 相關調校的建議清單，請參考 https://wiki.freebsd.org/ZFSTuningGuide。\n其他資源  FreeBSD Wiki - ZFS FreeBSD Wiki - ZFS Tuning Illumos Wiki - ZFS Oracle Solaris ZFS Administration Guide Calomel Blog - ZFS Raidz Performance, Capacity and Integrity  特色與術語 ZFS 是一個從本質上與眾不同的檔案系統，由於它並非只是一個檔案系統，ZFS 結合了檔案系統及磁碟區管理程式，讓額外的儲存裝置可以即時的加入到系統並可讓既有的檔案系統立即使用這些在儲存池中空間。透過結合傳統區分為二的兩個角色，ZFS 能夠克服以往 RAID 磁碟群組無法擴充的限制。每個在儲存池頂層的裝置稱作 vdev，其可以是一個簡單的磁碟或是一個 RAID 如鏡像或 RAID-Z 陣列。ZFS 的檔案系統 (稱作 資料集 (Dataset)) 每一個資料集均可存取整個存池所共通的可用空間，隨著使用儲存池來配置空間區塊，儲存池能給每個檔案系統使用的可用空間就會減少，這個方法可以避免擴大分割區會使的可用空間分散分割區之間的常見問題。\n   術語 含义     儲存池 (Pool) 儲存池 (Pool) 是建構 ZFS 最基礎的單位。一個儲存池可由一個或多個 vdev 所組成，是用來儲存資料的底層裝置。儲存池會被拿來建立一個或多個檔案系統 (資料集 Dataset) 或區塊裝置 (磁碟區 Volume)，這些資料集與磁碟區會共用儲存池的剩餘可用空間。每一個儲存池可由名稱與 GUID 來辨識。可用的功能會依儲存池上的 ZFS 版本而有不同。   vdev 型態 (vdev Types) 儲存池是由一個或多個 vdev 所組成，vdev 可以是一個磁碟或是 RAID Transform 的磁碟群組。當使用多個 vdev，ZFS 可以分散資料到各個 vdev 來增加效能與最大的可用空間。磁碟 (Disk) - 最基本的 vdev 型態便是一個標準的資料區塊裝置，這可以是一整個磁碟 (例如 /dev/ada0 或 /dev/da0) 或一個分割區 (/dev/ada0p3)。在 FreeBSD 上，使用分割區來替代整個磁碟不會影響效能，這可能與 Solaris 說明文件所建議的有所不同。檔案 (File) - 除了磁碟外，ZFS 儲存池可以使用一般檔案為基礎，這在測試與實驗時特別有用。在 zpool create 時使用檔案的完整路徑作為裝置路徑。所有 vdev 必須至少有 128 MB 的大小。鏡像 (Mirror) - 要建立鏡像，需使用 mirror 關鍵字，後面接著要做為該鏡像成員裝置的清單。一個鏡像需要由兩個或多個裝置來組成，所有的資料都會被寫入到所有的成員裝置。鏡像 vdev 可以對抗所有成員故障只剩其中一個而不損失任何資料。正常單一磁碟的 vdev 可以使用 zpool attach 隨時升級成為鏡像 vdev。RAID-Z - ZFS 實作了 RAID-Z，以標準的 RAID-5 修改而來，可提供奇偶校驗 (Parity) 更佳的分散性並去除了 “RAID-5 write hole” 導致在預期之外的重啟後資料與奇偶校驗資訊不一致的問題。ZFS 支援三個層級的 RAID-Z，可提供不同程度的備援來換取減少不同程度的可用空間，類型的名稱以陣列中奇偶校驗裝置的數量與儲存池可以容許磁碟故障的數量來命名，從 RAID-Z1 到 RAID-Z3 。在 RAID-Z1 配置 4 個磁碟，每個磁碟 1 TB，可用的儲存空間則為 3 TB，且若其中一個磁碟故障仍可以降級 (Degraded) 的模式運作，若在故障磁碟尚未更換並修復 (Resilver) 之前又有磁碟故障，所有在儲存池中的資料便會遺失。在 RAID-Z3 配置 8 個 1 TB 的磁碟，磁碟區將會可以提供 5 TB 的可用空間且在 3 個磁碟故障的情況下仍可運作。Sun™ 建議單一個 vdev 不要使用超過 9 個磁碟。若配置需要使用更多磁碟，建議分成兩個 vdev，這樣儲存池的資料便會分散到這兩個 vdev。使用兩個 RAID-Z2 各由 8 個磁碟組成的 vdev 的配置可以建立一個類似 RAID-60 的陣列。RAID-Z 群組的儲存空量會接近其中最小的磁碟乘上非奇偶校驗磁碟的數量。4 個 1 TB 磁碟在 RAID-Z1 會有接近 3 TB 的實際大小，且一個由 8 個 1 TB 磁碟組成的 RAID-Z3 陣列會有 5 TB 的可用空間。備援 (Spare) - ZFS 有特殊的虛擬 vdev 型態可用來持續追蹤可用的熱備援裝置 (Hot spare)。注意，安裝的熱備援裝置並不會自動佈署，熱備援裝置需要手動使用 zfs replace 設定替換故障的裝置。日誌 (Log) - ZFS 記錄裝置，也被稱作 ZFS 意圖日誌 (ZFS Intent Log, ZIL) 會從正常的儲存池裝置移動意圖日誌到獨立的裝置上，通常是一個 SSD。有了獨立的日誌裝置，可以明顯的增進有大量同步寫入應用程式的效能，特別是資料庫。日誌裝置可以做成鏡像，但不支援 RAID-Z，若使用多個日誌裝置，寫入動作會被負載平衡分散到這些裝置。快取 (Cache) - 加入快取 vdev 到儲存池可以增加儲存空間的 L2ARC 快取。快取裝置無法做鏡像，因快取裝置只會儲存額外的現有資料的複本，並沒有資料遺失的風險。   交易群組 (Transaction Group, TXG) 交易群組是一種將更動的資料區塊包裝成一組的方式，最後再一次寫入到儲存池。交易群組是 ZFS 用來檢驗一致性的基本單位。每個交易群組會被分配一個獨一無二的 64-bit 連續代號。最多一次可以有三個活動中的交易群組，這三個交易群組的每一個都有這三種狀態：* 開放 (Open) - 新的交易群組建立之後便處於開放的狀態，可以接受新的寫入動作。永遠會有開放狀態的交易群組，即始交易群組可能會因到達上限而拒絕新的寫入動作。一但開放的交易群組到達上限或到達 vfs.zfs.txg.timeout，交易群組便會繼續進入下一個狀態。 * 靜置中 (Quiescing) - 一個短暫的狀態，會等候任何未完成的操作完成，不會阻擋新開放的交易群組建立。一旦所有在群組中的交易完成，交易群組便會進入到最終狀態。 * 同步中 (Syncing) - 所有在交易群組中的資料會被寫任到穩定的儲存空間，這個程序會依序修改其他也需同樣寫入到穩定儲存空間的資料，如 Metadata 與空間對應表。同步的程多會牽涉多個循環，首先是同步所有更改的資料區塊，也是最大的部份，接著是 Metadata，這可能會需要多個循環來完成。由於要配置空間供資料區塊使用會產生新的 Metadata，同步中狀態在到達循環完成而不再需要分配任何額外空間的狀態前無法結束。同步中狀態也是完成 synctask 的地方，Synctask 是指管理操作，如：建立或摧毀快照與資料集，會修改 uberblock，也會在此時完成。同步狀態完成後，其他處於狀態中狀態的交易群組便會進入同步中狀態。 所有管理功能如快照 (Snapshot) 會作為交易群組的一部份寫入。當 synctask 建立之後，便會加入到目前開放的交易群組中，然後該群組會盡快的進入同步中狀態來減少管理指令的延遲。   Adaptive Replacement Cache (ARC) ZFS 使用了自適應替換快取 (Adaptive Replacement Cache, ARC)，而不是傳統的最近最少使用 (Least Recently Used, LRU) 快取，LRU 快取在快取中是一個簡單的項目清單，會依每個物件最近使用的時間來排序，新項會加入到清單的最上方，當快取額滿了便會去除清單最下方的項目來空出空間給較常使用的物件。ARC 結合了四種快取清單，最近最常使用 (Most Recently Used, MRU) 及最常使用 (Most Frequently Used, MFU) 物件加上兩個清單各自的幽靈清單 (Ghost list)，這些幽靈清單會追蹤最近被去除的物件來避免又被加回到快取，避免過去只有偶爾被使用的物件加入清單可以增加快取的命中率。同時使用 MRU 及 MFU 的另外一個優點是掃描一個完整檔案系統可以去除在 MRU 或 LRU 快取中的所有資料，有利於這些才剛存取的內容。使用 ZFS 也有 MFU 可只追蹤最常使用的物件並保留最常被存取的資料區塊快取。   L2ARC L2ARC 是 ZFS 快取系統的第二層，主要的 ARC 會儲存在 RAM 當中，但因為 RAM 可用的空間量通常有限，因此 ZFS 也可以使用 快取 vdev (Cache vdev)。固態磁碟 (Solid State Disk, SSD) 常被拿來此處作為快取裝置，因為比起傳統旋轉碟片的磁碟，固態磁碟有較快的速度與較低的延遲。L2ARC 是選用的，但使用可以明顯增進那些已使用 SSD 快取的檔案讀取速度，無須從一般磁碟讀取。L2ARC 也同樣可以加速去重複 (Deduplication)，因為 DDT 並不適合放在 RAM，但適合放在 L2ARC，比起要從磁碟讀取，可以加快不少速度。為了避免 SSD 因寫入次速過多而過早耗損，加入到快取裝置的資料速率會被限制，直到快取用盡 (去除第一個資料區塊來騰出空間) 之前，寫入到 L2ARC 的資料速率會限制在寫入限制 (Write limit) 與加速限制 (Boost limit) 的總合，之後則會限制為寫入限制，可以控制這兩個速度限制的 sysctl(8) 數值分別為 vfs.zfs.l2arc_write_max 控制每秒有多少數位元組可寫入到快取，而 vfs.zfs.l2arc_write_boost 可在 “渦輪預熱階段” (即寫入加速) 時增加寫入限制。   ZIL ZIL 會使用比主要儲存池還更快的儲存裝置來加速同步寫入動作 (Synchronous transaction)，如 SSD。當應用程式請求做一個同步的寫入時 (保証資料會安全的儲存到磁碟，而不是先快取稍後再寫入)，資料會先寫入到速度較快的 ZIL 儲存空間，之後再一併寫入到一般的磁碟。這可大量的減少延遲並增進效能。ZIL 只會有利於使用像資料庫這類的同步工作，一般非同步的寫入像複製檔案，則完全不會用到 ZIL。   寫入時複製 (Copy-On-Write) 不像傳統的檔案系統，在 ZFS，當資料要被覆寫時，不會直接覆寫舊資料所在的位置，而是將新資料會寫入到另一個資料區塊，只在資料寫入完成後才會更新 Metadata 指向新的位置。因此，在發生寫入中斷 (在寫入檔案的過程中系統當機或電源中斷) 時，原來檔案的完整內容並不會遺失，只會放棄未寫入完成的新資料，這也意謂著 ZFS 在發生預期之外的關機後不需要做 fsck(8)。   資料集 (Dataset) 資料集 (Dataset) 是 ZFS 檔案系統、磁碟區、快照或複本的通用術語。每個資料集都有獨一無二的名稱使用 poolname/path@snapshot 格式。儲存池的根部技術上來說也算一個資料集，子資料集會採用像目錄一樣的層級來命名，例如 mypool/home，home 資料集是 mypool 的子資料集並且會繼承其屬性。這可以在往後繼續擴展成 mypool/home/user，這個孫資料集會繼承其父及祖父的屬性。在子資料集的屬性可以覆蓋預設繼承自父及祖父的屬性。資料集及其子資料級的管理權限可以委託 (Delegate) 給他人。   檔案系統 (File system) ZFS 資料集最常被當做檔案系統使用。如同大多數其他的檔案系統，ZFS 檔案系統會被掛載在系統目錄層級的某一處且內含各自擁有權限、旗標及 Metadata 的檔案與目錄。   磁碟區 (Volume) 除了一般的檔案系統資料集之外，ZFS 也可以建立磁碟區 (Volume)，磁碟區是資料區塊裝置。磁碟區有許多與資料集相似的功能，包含複製時寫入、快照、複本以及資料校驗。要在 ZFS 的頂層執行其他檔案系統格式時使用磁碟區非常有用，例如 UFS 虛擬化或匯出 iSCSI 延伸磁區 (Extent)。   快照 (Snapshot) ZFS 的寫入時複製 (Copy-On-Write, COW) 設計可以使用任意的名稱做到幾乎即時、一致的快照。在製做資料集的快照或父資料集遞迴快照 (會包含其所有子資料集) 之後，新的資料會寫入到資的資料區塊，但不會回收舊的資料區塊為可用空間，快照中會使用原版本的檔案系統，而快照之後所做的變更則會儲存在目前的檔案系統，因此不會重複使用額外的空間。當新的資料寫入到目前的檔案系統，便會配置新的資料區塊來儲存這些資料。快照表面大小 (Apparent size) 會隨著在目前檔案系統停止使用的資料區塊而成長，但僅限於快照。可以用唯讀的方式掛載這些快照來復原先前版本的檔案，也可以還原 (Rollback) 目前的檔案系統到指定的快照，來還原任何在快照之後所做的變更。每個在儲存池中的資料區塊都會有一個參考記數器，可以用來持續追蹤有多少快照、複本、資料集或是磁碟區使用這個資料區塊，當刪除檔案與快照參照的計數變會滅少，直到沒有任何東西參考這個資料區塊才會被回收為可用空間。快照也可使用 hold 來標記，檔標記為 hold 時，任何嘗試要刪除該快照的動作便會回傳 EBUSY 的錯誤，每個快照可以標記多個不同唯一名稱的 hold，而 release 指令則可以移除 hold，這樣才可刪除快照。在磁碟區上快可以製作快照，但只能用來複製或還原，無法獨立掛載。   複本 (Clone) 快照也可以做複本，複本是可寫入版本的快照，讓檔案系統可分支成為新的資料集。如同快照，複本一開始不會消耗任何額外空間，隨著新資料寫入到複本會配置新的資料區塊，複本的表面大小 (Apparent size) 才會成長，當在複本檔案系統或磁碟區的資料區塊被覆寫時，在先前資料區塊的參考計數則會減少。建立複本所使用的快照無法被刪除，因為複本會相依該快照，快照為父，複本為子。複本可以被提升 (promoted)、反轉相依關係，來讓複本成為父，之前的父變為子，這個操作不需要額外的空間。由於反轉了父與子使用的空間量，所以可能會影響既有的配額 (Quota) 與保留空間 (Reservation)。   校驗碼 (Checksum) 配置每個資料區塊快的同時也會做資料校驗，資料校驗用的演算法是依資料集屬性而有所不同的，請參考 set。每個資料區塊會在讀取的過成便完成校驗，讓 ZFS 可以偵測到隱藏的損壞，若資料不符合預期的校驗碼，ZFS 會嘗試從任何可用的備援來還原資料，例如鏡像 (Mirror) 或 RAID-Z。要檢驗所有資料的校驗碼可以使用清潔 (Scrub)，資料校驗的演算法有：* fletcher2 * fletcher4 * sha256 fletcher 演算法最快，而 sha256 雖較消耗效能，但其有強大的密碼雜湊與較低的衝突率。也可關閉資料校驗，但並不建議。   壓縮 (Compression) 每個資料集都有壓縮 (Compression) 屬性，預設是關閉的，這個屬性可以設定使用以下幾個壓縮演算法的其中一個來壓縮寫入到資料集的新資料。壓縮除了減少空間使用量外，常也會增加讀取與寫入的吞吐量，因為會減少讀取與寫入的資料區塊。* LZ4 - ZFS 儲存池版本 5000 (功能旗標) 後所增加，LZ4 現在是建議的壓縮演算法，在處理可壓縮的資料時 LZ4 壓縮比 LZJB 快將近 50%，在處理不可壓縮的資料時快將近三倍，LZ4 解壓縮也比 LZJB 將近 80%。在現代的 CPU 上，LZ4 經常平均可用 500 MB/s 的速度壓縮，而解壓縮可到達 1.5 GB/s (每個 CPU 核心)。* LZJB - 預設的壓縮演算法。由 Jeff Bonwick 所開發 (ZFS 的創始人之一)。LZJB 與 GZIP 相比，可以較低的 CPU 提供較佳的壓縮功能。在未來預設的壓縮演算法將會更換為 LZ4。* GZIP - 在 ZFS 可用的熱門串流壓縮演算法。使用 GZIP 主要的優點之一便是可設定壓縮層級。當設定 compress 屬性，管理者可以選擇壓縮層級範圍從最低的壓縮層級 gzip1 到最高的壓縮層級 gzip9。這讓管理者可以控制要使用多少 CPU 來節省磁碟空間。* ZLE - 零長度編號是一個特殊的壓縮演算法，它只會壓縮連續的零。這種壓縮演算法只在資料集中含有大量為零的資料區塊時有用。   備份數 (Copies) 當設定大於 1 的數值時，copies 屬性會指示 ZFS 備份每個在檔案系統 (File System) 或磁碟區 (Volume) 的資料區塊數份。在重要的資料集上設定這個屬性可以做額外的備援以在資料校驗碼不相符時可做復原。在沒有做備援的儲存池上，備份功能提供只是一種資料的備援方式，備份功能可以復原單一壞軌或其他情況的次要損壞，但無法復原儲存池中整個磁碟損壞所損失的資料。   去重複 (Deduplication) 校驗碼讓在寫入時可以偵測重複資料區塊，使用去重複，可以增加既有、完全相同的資料區塊參考數來節省儲存空間。要偵測重複的資料區塊需要在記憶體中儲存去重複資料表 (Deduplication table, DDT)，這個資料表中會有唯一的校驗碼清單、這些資料區塊的所在位置以及參考數。當寫入新資料時，便會計算校驗碼然後比對清單中是否有符合的既有資料區塊已在清單。去重複使用了 SHA256 校驗碼演算法來提供一個安全的加密雜湊，去重複功能是可以調校的，若 dedup 設為 on 只要符合校驗碼便會認為資料完全相同，若 dedup 設為 verify 則會一個一個位元檢查兩個資料區塊的資料來確保資料真的完全相同，若資料不同便會註記與雜湊衝突並會分別儲存兩個資料區塊。由於 DDT 須要儲存每個唯一資料區塊的雜湊，所以會消耗大量的記憶體，一般的經驗法則是每 1 TB 的去重複資料需要使用 5-6 GB 的記憶體。由於要有足夠的 RAM 來儲存整個 DDT 在實務上並不實際，導致在每個新資料區塊寫入前需要從磁碟來讀取 DDT 會對效能有很大的影響，去重複功能可以使用 L2ARC 儲存 DDT 以在快速的系統記憶體及較慢的磁碟之間取得一個平衡點。也可以考慮使用壓縮功能來取代此功能，因為壓縮也能節省相近的空間使用量而不需要大量額外的記憶體。   清潔 (Scrub) ZFS 有 scrub 來替代 fsck(8) 來做一致性的檢查。scrub 會讀取所有儲存在儲存池中的資料區塊並且根據儲存在 Metadata 中已知良好的校驗碼來檢驗這些資料區塊的校驗碼，定期檢查儲存池中儲存的所有資料可以確保實際使用這些資料前已將所有損壞的資料區塊復原。在不正常的關閉之後並不需要做清潔動作，但建議每三個月至少執行一次。在正常使用讀取時便會檢查每個資料區塊的校驗碼，但清潔動作可以確保那些不常用的資料也會被檢查以避免隱藏的損壞，如此便能增進資料的安全性，特別是對用來保存資料的儲存裝置。scrub 可以使用 vfs.zfs.scrub_delay 調整相對優先權來避免清潔動作降低儲存池上其他工作的效率。   資料集配額 (Dataset Quota) 除了配額及空間保留外，ZFS 提供非常快速且準確的資料集、使用者及群組空間的計算功能，這可讓管理者調整空間配置的方式且可為重要的檔案系統保留空間。ZFS supports different types of quotas: the dataset quota, the reference quota (refquota), the user quota, and the group quota.配額會限制資料集及後裔包含資料集的快照、子資料集及子資料集的快照能使用的空間量。磁碟區上無法設定配額，因為 volsize 屬性已經被用來做內定的配額。   參考配額 (Reference Quota) 參考配額可以設定一個硬性限制 (Hard limit) 來限制資料集能使用的空間量，而這個硬性限制只包含了資料集參考的空間，並不含其後裔所使用的空間，如：檔案系統或快照。   使用者配額 (User Quota) 使用者配額在用來限制特定使用者能使用的空間量時非常有用。   群組配額 (Group Quota) 群組配額可以限制特定群組能使用的空間量。   資料集保留空間 (Dataset Reservation) reservation 屬性可以確保對特定資料集及其後裔最小可用的空間量，若在 storage/home/bob 設定 10 GB 的保留空間且其他資料集嘗試使用所有剩餘的空間時，會保留至少 10 GB 的空間供這個資料集使用。若要製作 storage/home/bob 的快照，該快照所使用的空間也會被列入保留空間計算。 refreservation 屬性也以類似的方式運作，但是他 不包含 後裔，例如：快照。不管那一種保留空間在許多情境皆很有用，例如：要規劃與測試磁碟空間配置在新系統上的適應性，或是確保有足夠的空間供稽查日誌或系統還原程序及檔案使用。   參考保留空間 (Reference Reservation) refreservation 屬性可以確保對特定資料集 不包含 其後裔最小可用的空間，這代表若在 storage/home/bob 設定 10 GB 的保留空間且其他資料集嘗試使用所有剩餘的空間時，會保留至少 10 GB 的空間供這個資料集使用。於正常 reservation 不同的是，由快照及後裔資料集所使用的空間並不會列入保留空間計算。例如，若要製作一個 storage/home/bob 的快照，在 refreservation 空間之外必須要有足夠的空間才能成功完成這項操作，主資料集的後裔並不會列入 refreservation 空間額計算，所以也不會佔用保留空間。   修復 (Resilver) 當有磁碟故障且被更換後，新的磁碟必須回存先前所遺失的資料，會使用分散在其他磁碟上的奇偶校驗資訊來計算並寫入遺失的資料到新的磁碟機的這個程序稱作 修復 (Resilvering)。   上線 (Online) 一個儲存池或 vdev 處於線上 (Online) 狀態時代表所有該裝置的成員均已連結且正常運作。個別裝置處於線上 (Online) 狀態時代表功能正常。   離線 (Offline) 若有足夠的備援可避免儲存池或 vdev 進入故障 (Faulted) 狀態，個別裝置若可由管理者設為離線 (Offline) 狀態，管理者可以選擇要設定那一個磁碟為離線來準備更換或是讓其更容易辨識。   降級 (Degraded) 一個儲存池或 vdev 處於降級 (Degraded) 狀態代表其有一個或多個磁碟已斷線或故障，此時儲存池仍可以使用，但只要再有其他的裝置故障，儲存池會無法復原。重新連線缺少的裝置或更換故障的磁碟，並在新裝置完成修復 (Resilver) 程序可讓儲存池返回線上 (Online) 狀態。   故障 (Faulted) 一個儲存池或 vdev 處於故障 (Faulted) 狀態代表無法運作，會無法存取在該裝置上的資料。當在 vdev 中缺少或故障的裝置數超過備援的層級，儲存池或 vdev 會進入故障 (Faulted) 狀態。若缺少的裝置可以重新連結上，儲存池便會返回線上 (Online) 狀態。若沒有足夠的備援可補償故障的磁碟數量便會遺失儲存池中的內容且只能從備份還原。    Gentoo on ZFS 备份 初始化硬盘 这里的初始化硬盘是为了将原来的数据全部清除并且重新建立LUKS和文件系统。出于安全的考虑，备份不应该直接在硬盘上分区创建文件系统后备份在上面，应该做一层加密再去创建文件系统和备份。\n将硬盘插入需要备份的电脑上\n查看新增的设备\n$ fdisk -l Disk /dev/sda: 232.9 GiB, 250055122432 bytes, 488388911 sectors Disk model: 00AAJS-00B4A0 Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0x80f01a9c Device Boot Start End Sectors Size Id Type /dev/sda1 2048 488388910 488386863 232.9G 83 Linux 这里可以看到新添加的磁盘，上面是有以前的东西，这里为了安全起见用随机数据覆盖掉这个分区。 这里会清除可能存在的任何没有加密的旧数据，如果遭受攻击这会让攻击者更难确定数据位置，这一步会很慢（取决于你的接口速度和硬盘速率）。\n$ sudo dd if=/dev/urandom of=/dev/sda bs=1M status=progress \u0026\u0026 sync 完成之后，我们需要重新对这个硬盘进行分区\n$ sudo fdisk /dev/sda Welcome to fdisk (util-linux 2.35.2). Changes will remain in memory only, until you decide to write them. Be careful before using the write command. Command (m for help): n Partition type p primary (0 primary, 0 extended, 4 free) e extended (container for logical partitions) Select (default p): Using default response p. Partition number (1-4, default 1): First sector (2048-488388910, default 2048): Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-488388910, default 488388910): Created a new partition 1 of type 'Linux' and of size 232.9 GiB. Command (m for help): w The partition table has been altered. Calling ioctl() to re-read partition table. Syncing disks. 这样就创建了一个分区，接下来我们要在这个分区上创建LUKS\n创建 LUKS 我们这里可以使用cryptsetup这个命令来初始化我们的LUKS分区\n如果你没有这个命令可以运行这条命令进行安装：\n$ emerge -av cryptsetup 然后初始化分区\n$ sudo cryptsetup luksFormat /dev/sda1 WARNING! ======== This will overwrite data on /dev/sda1 irrevocably. Are you sure? (Type 'yes' in capital letters): YES Enter passphrase for /dev/sda1: Verify passphrase: 这里会提示这个操作将会将这个分区里面的内容全部删掉，输入大写的YES确认，然后输入两次密码，注意密码是没有回显的。\n打开 LUKS 和创建文件系统 现在是LUKS已经做好了，但是我们还需要在上面格式化分区才能够挂载使用，我们首先要打开LUKS分区：\n$ sudo cryptsetup luksOpen /dev/sda1 backup Password: Enter passphrase for /dev/sda1: 我这里是想打开这个LUKS卷，为了区分和其他的我给这个名字叫做backup，然后会提示你输入LUKS的密码，正确输入之后就可以在/dev/mappaer下面看到一个backup的设备了\n现在对这个分区进行格式化，这次用的是ext4的分区\n$ sudo mkfs.ext4 -v /dev/mapper/backup 创建挂载点和挂载 在完成了分区初始化之后我们还需要创建一个挂载点用于挂载这个备份的分区:\n$ sudo mkdir -pv /backup 挂载分区:\n$ sudo mount -v /dev/mapper/backup /backup 备份系统 下载就可以备份系统了，这次使用的是rsync工具来进行备份系统：\n$ sudo rsync -aAXv --exclude={\"/dev/*\",\"/proc/*\",\"/sys/*\",\"/tmp/*\",\"/run/*\",\"/mnt/*\",\"/media/*\",\"/lost+found\",\"/backup/*\",\"/swapfile\"} / /backup 这里使用的-aAXv选项的意思是：文件将会以归档模式传输，保留符号设备，文件权限，修改时间，ACL和扩展属性，并且将备份的过程打印在屏幕上。\n--exclude就是排除特定的文件类似于/dev、/proc之类的，/backup是我们的备份分区不需要再去搞一份防止出现奇奇怪怪的后果。\n这会耗费很多时间可以休息一下做其他的事情。\n等待这个备份完成之后我们就可以卸载这块硬盘进行保存了。\n卸载挂载点\n$ umount /backup 关闭LUKS分区\n$ cryptsetup luksClose backup 迁移到 ZFS 分区 首先我需要把之前的分区全部干掉，然后创建如下表的分区：\n   分区 文件系统 大小     /dev/nvme0n1p1 fat32 128M   /dev/nvme0n1p2 swap 64G   /dev/nvme0n1p3 ZFS ALL    直接在系统里面丢swapfile是不合理的，最好是有个单独的分区给swap。\n初始化分区 创建完成分区之后我们还需要对分区进行初始化：\n$ mkfs.vfat -F32 /dev/nvme0n1p1 $ mkswap /dev/nvme0n1p2 创建 pool 这里需要注意一点是像是我们之前分区的/dev/nvme0n这种设备或者是/dev/sda这样的，如果插拔U盘之类的可能盘序会发生变化，但是ZFS池是不会意识到这个变化的，这样就会产生zfs池不可用的问题，我们需要一些方法来获取到磁盘的id并以此来创建我们的zfs池。\n$ ls -l /dev/disk/by-id lrwxrwxrwx 1 root root 13 Feb 13 12:29 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM - ../../nvme0n1 lrwxrwxrwx 1 root root 15 Feb 13 12:32 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part1 - ../../nvme0n1p1 lrwxrwxrwx 1 root root 15 Feb 13 12:29 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part2 - ../../nvme0n1p2 KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part3 - ../../nvme0n1p3 ... 这里的KXG50PNV2T04_KIOXIA_Y9IS103FTHDM就是我们的硬盘，nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part1就是我们创建作为未来的/boot分区。\n当我们创建zfs池的时候尽可能选择用这种id的方式去创建。现在我们创建一个加密的zpool：\n$ zpool create -f -o ashift=12 -o cachefile=/etc/zfs/zpool.cache -O compression=lz4 -O xattr=sa -O relatime=on -O acltype=posixacl -O dedup=off -O encryption=on -O keyformat=passphrase -m none -R /mnt/gentoo rock /dev/disk/by-id/nvme-eui.000000000000001000080d0200600f01-part3 zpoolprops\n ashift=ashift: Pool sector size exponent, to the power of 2 (internally referred to as ashift). The typical case for setting this property is when performance is important and the underlying disks use 4KiB sectors but report 512B sectors to the OS (for compatibility reasons); in that case, set ashift=12 (which is 1«12 = 4096). cachefile=path|none: Controls the location of where the pool configuration is cached. Setting this property caches the pool configuration in a different location that can later be imported with zpool import -c.  根据提示输入密码（注意密码不会有回显，并不是键盘坏了）。\n这条命令创建了一个名为 rock的zfs池 使用的压缩算法为lz4。\n如果说你想创建一个不带加密的zpool可以去掉-O encryption=on -O keyformat=passphrase这两个选项。\n创建 datasets 接下来我们要创建自己的rootfs，并且在上面打开加密功能：\n$ zfs create -o mountpoint=none -o canmount=off rock/os $ zfs create -o mountpoint=/ rock/os/gentoo 安装系统 这次安装系统的话，是打算直接从硬盘恢复的，首先插上备份好的硬盘：\n$ fdisk -l ........ Disk /dev/sdc: 232.88 GiB, 250055122432 bytes, 488388911 sectors Disk model: 00AAJS-00B4A0 Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 4096 bytes / 33553920 bytes Disklabel type: dos Disk identifier: 0x80f01a9c Device Boot Start End Sectors Size Id Type /dev/sdc1 2048 488388910 488386863 232.9G 83 Linux 这里看到我们的备份硬盘。我们要创建一个目录用来挂载这个分区：\n$ mkdir -pv /backup 打开LUKS分区：\n$ cryptsetup luksOpen /dev/sdc1 backup Enter passphrase for /dev/sdc1: 输入之前设置的密码。挂载分区：\n$ mount -v /dev/mapper/backup /backup 还有一个分区我们要注意一下就是/boot分区，创建boot分区的挂载点：\n$ mkdir -pv /mnt/gentoo/boot 挂载分区：\n$ mount -v /dev/nvme0n1p1 /mnt/gentoo/boot 将所有文件同步到zfs的dataset里面：\n$ rsync -aAXv --exclude={\"/dev/*\",\"/proc/*\",\"/sys/*\",\"/tmp/*\",\"/run/*\",\"/mnt/*\",\"/media/*\",\"/lost+found\",\"/backup/*\",\"/swapfile\"} /backup/ /mnt/gentoo 这个复制需要一定的时间，耐心等待完成，期间不要断开硬盘或者是拔掉电源。\nchroot 等到复制原来的系统完成之后我们就需要进入chroot环境，然后完成其他的必要配置了。\n拷贝ZFS池缓存文件：\n$ mkdir -pv /mnt/gentoo/etc/zfs $ cp -v /etc/zfs/zpool.cache /mnt/gentoo/etc/zfs 拷贝网络的DNS：\n$ cp --dereference /etc/resolv.conf /mnt/gentoo/etc/ 挂载必要的文件系统：\n$ mount --types proc /proc /mnt/gentoo/proc $ mount --rbind /sys /mnt/gentoo/sys $ mount --make-rslave /mnt/gentoo/sys $ mount --rbind /dev /mnt/gentoo/dev $ mount --make-rslave /mnt/gentoo/dev 我们不是在官方的Livecd下面还需要执行：\n$ test -L /dev/shm \u0026\u0026 rm /dev/shm \u0026\u0026 mkdir /dev/shm $ mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm $ chmod 1777 /dev/shm 进入chroot：\n$ chroot /mnt/gentoo /bin/bash $ source /etc/profile $ export PS1=\"(chroot) $PS1\" ZFS 安装和配置 首先是要给原来的系统安装上ZFS的支持，确保内核打开了Zlib的支持：\nGeneral Architecture Dependent Options --- GCC plug ins --- [ ] Randomize layout of sensitive kernel structures Cryptographic API ---  Deflate compression algorithm Security options --- [ ] Harden common str/mem functions against buffer overflows 我们还需要调整portage让ZFS包接收测试分支的包：\n$ echo \"sys-fs/zfs-kmod ~amd64\"  /etc/portage/package.accept_keywords/zfs-kmod $ echo \"sys-fs/zfs ~amd64\"  /etc/portage/package.accept_keywords/zfs 如果你想要使用实时的包可以:\n$ echo \"=sys-fs/zfs-kmod-9999 **\"  /etc/portage/package.accept_keywords/zfs-kmod $ echo \"=sys-fs/zfs-9999 **\"  /etc/portage/package.accept_keywords/zfs 但是不推荐用最新的，要到处找patch。\n安装ZFS：\n$ emerge -av zfs 有一个很重要的点，每次更新内核或者是编译内核之后最好是重新构建一下模块，否则有可能遇到zpool无法正常初始化的问题：\n$ emerge -va @module-rebuild 将zfs加入到开机启动项和对应的启动级别：\n$ systemctl enable zfs.target $ systemctl enable zfs-import-cache $ systemctl enable zfs-mount $ systemctl enable zfs-import.target 生成和验证zfs hostid文件，这个文件是用于genkernel生成initramfs和zfs导入池的时候验证完整性时候需要的：\n$ zgenhostid $ file /etc/hostid Bootload fstab and Initramfs GRUB 修改grub的配置文件，内容如下：\nGRUB_CMDLINE_LINUX=\"dozfs root=ZFS=rock/os/gentoo\" 安装bootload：\n$ grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=Gentoo 生成配置文件：\n$ grub-mkconfig -o /boot/grub/grub.cfg fstab 挂载的工作这次交给zfs来去完成，我们这里还需要修改一下fstab\n首先查看分区的id：\n$ blkid /dev/nvme0n1p1: UUID=\"129F-3405\" BLOCK_SIZE=\"512\" TYPE=\"vfat\" PARTUUID=\"537bd932-cc1f-5643-a297-feebaeb6a5ea\" /dev/nvme0n1p2: LABEL=\"rock\" UUID=\"7999529021869478878\" UUID_SUB=\"11607083434113154920\" BLOCK_SIZE=\"4096\" TYPE=\"zfs_member\" PARTUUID=\"d68d6b86-a407-4141-a1a7-1379cbe1e049\" 可以看到我们的/boot分分区UUID是129F-3405，现在可以修改/etc/fstab\n$ nano -w /etc/fstab 内容如下\n# /dev/nvme0n1p1 /dev/nvme0n1p1 /boot vfat rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=iso8859-1,shortname=mixed,errors=remount-ro\t0 2 initramfs 重新生成initramfs，之前的initramfs没有zfs的支持这次要加上，为了保证工作正常还需要将genkrenel切换到testing分支\n$ echo \"=sys-kernel/genkernel-9999 **\"  /etc/portage/package.accept_keywords/genkernel 更新genkernel\n$ emerge -av genkernel 重新生成initramfs文件\n$ genkernel initramfs --zfs --compress-initramfs 重启 在重启验证之前我们需要先做一些清理工作\n首先退出chroot环境\n$ exit 卸载备份分区\n$ umount -R /backup 关闭backup卷\n$ cryptsetup luksClose backup 然后就可以重启啦\n$ reboot 重启之后第一次可能还是没办法正常进入系统，需要进入到shell里面导入一下zpool\n$ zpool import -f rock 设置一下分区挂载点\n$ zfs set mountpoint=/ rock/os/gentoo 然后再重启一下就可以正常进入系统了。\n使用ZFS备份 创建备份ZFS池 首先进入livecd，查看设备：\n$ fdisk -l Disk /dev/nvme0n1: 1.86 TiB, 2048408248320 bytes, 4000797360 sectors ... Disk /dev/sda: 233.76 GiB, 251000193024 bytes, 490234752 sectors ... Disk /dev/sdc: 57.81 GiB, 62075699200 bytes, 121241600 sectors ... 这里的设备分别为：\n   物理位置 说明     /dev/nvme0n1 系统盘   /dev/sda 备份盘   /dev/sdc 启动盘    首先在备份盘上创建一个分区（分配所有空间到这个分区上）：\n$ fdisk /dev/sda Welcome to fdisk (util-linux 2.36). Changes will remain in memory only, until you decide to write them. Be careful before using the write command. Device does not contain a recognized partition table. Created a new DOS disklabel with disk identifier 0x108318f9. Command (m for help): n Partition type p primary (0 primary, 0 extended, 4 free) e extended (container for logical partitions) Select (default p): Using default response p. Partition number (1-4, default 1): First sector (2048-490234751, default 2048): Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-490234751, default 490234751): Created a new partition 1 of type 'Linux' and of size 233.8 GiB. Command (m for help): w The partition table has been altered. Calling ioctl() to re-read partition table. Syncing disks. 查看硬盘ID\n$ ls -l /dev/disk/by-id ... lrwxrwxrwx 1 root root 10 Feb 27 14:53 usb-ACASIS_MAC3E_000000000001-0:0-part1 - ../../sda1 ... usb-ACASIS_MAC3E_000000000001-0:0-part1这里就是我们所需要的硬盘ID，我们使用这个来创建备份池子：\n$ zpool create -f -o ashift=12 -o cachefile=/etc/zfs/zpool.cache -O compression=lz4 -O xattr=sa -O relatime=on -O acltype=posixacl -O dedup=off -m none -R /mnt/backup backup /dev/disk/by-id/usb-ACASIS_MAC3E_000000000001-0:0-part1 备份池也可以加密。\n创建快照 首先导入原来的zpool\n$ zpool import -f rock 给之前的系统创建一个快照：\n$ sudo zfs snapshot rock/os/gentoo@2021-02-27-0000-01-install 查看\n$ zfs list -r -t snapshot -o name,creation rock/os/gentoo rock/os/gentoo@2021-02-27-0000-01-install Sat Feb 27 14:16 2021 发送快照 我们需要打开原来的rock/os/gentoo数据集\n但是首先要设置一下挂载点：\n$ zfs set mountpoint=/mnt/gentoo rock/os/gentoo 打开rock/os/gentoo数据集\n$ zfs mount -l -a 发送快照到backup/os/gentoo\n$ zfs send rock/os/gentoo@2021-02-27-0000-01-install | zfs recv backup/2021-02-27-0000-01-backup 这个会花很长的时间，取决于你使用的接口速度，可以通过这条命令查看io情况：\n$ zpool iostat 2 这条命令是查看所有的zpoolio情况，2秒刷新一次。\n备份/boot分区 设置挂载点\n$ zfs set mountpoint=/mnt/backup backup/2021-02-27-0000-01-backup 备份\n$ mkdir -pv /mnt/boot $ mount -v /dev/nvme0n1p1 /mnt/boot $ cp -rv /mnt/boot/* /mnt/backup/boot/ 恢复快照 卸除挂载：\n$ zfs umount backup/2021-02-27-0000-01-backup 现在就可以恢复快照了：\n$ zfs send backup/2021-02-27-0000-01-backup | zfs recv -F -x encryption rock/os/gentoo 定期备份 在Gentoo的Portage Tree中提供了一个sys-fs/zfs-auto-snapshot的包，这个包可以帮我们创建一个定时任务周期性的备份我们的ZFS\n$ sudo emerge -av sys-fs/zfs-auto-snapshot 可以根据需要配置备份的周期：\n$ sudo zfs set com.sun:auto-snapshot:daily=true rock/os/gentoo $ sudo zfs set com.sun:auto-snapshot:weekly=true rock/os/gentoo 问题排查 grub 救援 grub rescue set prefix=(hd0,1)/boot/grub grub rescue set root=(hd0,1) grub rescue insmod normal grub rescue normal grub rescue insmod linux grub rescue linux /boot/vmlinuz-3.13.0-29-generic dozfs root=ZFS=rock/os/gentoo grub rescue initrd /boot/initrd.img-3.13.0-29-generic grub rescue boot 通过 livecd 修复 导入 zpool\n$ zpool import -f rock $ zfs set mountpoint=/mnt/gentoo rock/os/gentoo 挂载 dataset\n$ zfs mount -la 挂载 boot 分区\n$ mount /dev/nvme0n1p1 /mnt/gentoo/boot/ 挂载必要的文件系统\n$ mount --types proc /proc /mnt/gentoo/proc $ mount --rbind /sys /mnt/gentoo/sys $ mount --make-rslave /mnt/gentoo/sys $ mount --rbind /dev /mnt/gentoo/dev $ mount --make-rslave /mnt/gentoo/dev # 我们不是在官方的Livecd下面还需要执行： $ test -L /dev/shm \u0026\u0026 rm /dev/shm \u0026\u0026 mkdir /dev/shm $ mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm $ chmod 1777 /dev/shm 进入 chroot\n$ chroot /mnt/gentoo /bin/bash $ source /etc/profile $ export PS1=\"(chroot) $PS1\" 退出 chroot\n$ exit 卸除挂载\n$ umount -R /mnt/gentoo 改回 rootfs 挂载点\n$ zfs set mountpoint=/ rock/os/gentoo 重启\n$ reboot LUKS 数据的安全，保密性在现在的生活中显得越来越重要。随着数字化的时代的来临，越来越多的数据被数字化，特别是更多有关于我们隐私的数据在不断生成，甚至还有我们需要离线保存的密钥等。而且通常我们使用磁盘，USB 闪存，SD 卡等存储介质进行存储，即便我们已经离线存储，仍然不能保证该存储介质不会丢失，如果丢失那么对于我们来说有可能是灾难性的事件。因此对这些离线存储的重要数据，再次进行进行加密是非常有必要的，本文将告诉你如何加密你的移动存储介质。\n在此之前先介绍一下 LUKS：\n LUKS （Linux Unified Key Setup）是 Linux 硬盘加密的标准。 通过提供标准的磁盘格式，它不仅可以促进发行版之间的兼容性，还可以提供对多个用户密码的安全管理。 与现有解决方案相比，LUKS 将所有必要的设置信息存储在分区信息首部中，使用户能够无缝传输或迁移其数据。\n 内核配置（可选） 通常来说，大部分发行版的内核都已经配置了相关的加密部分，因此非 gentoo 用户可以跳过此部分。\n配置 device mapper 和 crypt target：\n[*] Enable loadable module support Device Drivers --- [*] Multiple devices driver support (RAID and LVM) ---  Device mapper support  Crypt target support 配置加密 API：\n[*] Cryptographic API ---  XTS support  SHA224 and SHA256 digest algorithm  AES cipher algorithms  AES cipher algorithms (x86_64)  User-space interface for hash algorithms  User-space interface for symmetric key cipher algorithms 编译新内核并配置应用，然后重启：\n# make -j9 \u0026\u0026 make modules_install \u0026\u0026 make install 安装软件 通常的发行版已经预装了该软件包，可以直接使用，下面是 Gentoo 的安装方法\n# emerge --ask sys-fs/cryptsetup 创建加密分区 注意，该操作会清空你选择分区或设备上的所有数据，请谨慎操作，输入大写的 YES 确认\n# cryptsetup -s 512 luksFormat /dev/sdd WARNING! ======== This will overwrite data on /dev/sdd irrevocably. Are you sure? (Type uppercase yes): YES Enter passphrase: Verify passphrase: 利用密钥文件加密分区 除了密码之外，还可以选择使用密钥文件解密你的硬盘，也就是相当于一个密钥，当然可以也可以只使用密钥文件或者同时使用密码与密钥文件。\n生成随机密钥文件 # dd if=/dev/urandom of=/root/enc.key bs=1 count=4096 添加密钥文件作为密码之一 # cryptsetup luksAddKey /dev/sdd /root/enc.key Enter any existing passphrase: 移除解密密码 移除普通密码：\n# cryptsetup luksRemoveKey /dev/sdd Enter LUKS passphrase to be deleted: ... 移除 key file 密码：\n# cryptsetup luksRemoveKey -d /root/enc.key /dev/sdd 注意：千万不要将所有密码移除，至少需要留有一个密码访问设备，移除操作不可撤销\n解密与挂载 密码解密 # cryptsetup luksOpen /dev/sdd myusb Enter passphrase for /dev/sdd: key file 解密 # cryptsetup luksOpen -d /root/enc.key /dev/sdd myusb 创建文件系统 在挂载使用之前，我们仍然需要对设备创建文件系统才可以使用，可以选择任何你喜欢的文件系统，例如 btrfs，ext4，vfat，ntfs 等\n# mkfs.ext4 /dev/mapper/myusb mke2fs 1.43.6 (29-Aug-2017) Creating filesystem with 488448 4k blocks and 122160 inodes Filesystem UUID: 995e172a-2bc6-432c-a60f-2d4d7093e748 Superblock backups stored on blocks: 32768, 98304, 163840, 229376, 294912 Allocating group tables: done Writing inode tables: done Creating journal (8192 blocks): done Writing superblocks and filesystem accounting information: done 挂载 现在可以像正常分区一样挂载我们的加密分区设备了\n# mount /dev/mapper/myusb /mnt/ # df -h /dev/mapper/myusb 1.9G 5.7M 1.7G 1% /mnt 卸载挂载点并关闭加密分区 # umount /mnt # cryptsetup luksClose myusb 总结 在完成整个步骤以后，您现在需要做的就是妥善保管您的加密存储，可采用同样的方式加密多个设备进行备份，因为谁也不能保证这移动设备会不会在什么时候丢掉。\nInput Method Editor 中文字体 在应用之前，最好先安装好中文字体和 emojis\n# emerge media-fonts/noto-cjk media-fonts/noto-emoji # eselect fontconfig list # eselect fontconfig enable 70-noto-cjk.conf 也可以将字体文件复制到目录 ~/.local/share/fonts/ 下，然后执行 fc-cache -f -v 创建字体缓存。\n改善字体渲染效果   安装字体：下载更纱黑体\nTUNA (CN): https://mirrors.tuna.tsinghua.edu.cn/github-release/be5invis/Sarasa-Gothic\nNJU (CN): https://mirror.nju.edu.cn/github-release/be5invis/Sarasa-Gothic\n  调整系统字体：系统设置 - 字体\n在系统字体设置那将那些默认的noto sans字体改为更纱黑体即可，前三个最好相应调大一个等级。等距字体可以使用等距更纱黑体，也可以使用你喜欢的等距字体。\n  调整系统缩放：系统设置 - 显示和监控 - 显示配置 - 缩放显示\n默认是100%，可以调整到110～120之间，具体数值根据自己效果设定\n  调整字体DPI：系统设置 - 字体 - 勾选“固定字体DPI”并调整DPI的值\n默认是96，同样也可以调整到110~120之间，具体数值根据自己效果设定\n  调整字体展示优先级：将下述内容保存为 ~/.fonts.conf文件\n    sans-serif  Sarasa Gothic SC Sarasa Gothic TC Sarasa Gothic J Sarasa Gothic K    monospace  Sarasa Mono SC Sarasa Mono TC Sarasa Mono J Sarasa Mono K      调整完之后注销重新登入\n输入法 作为中文用户，肯定需要款输入法，我推荐使用 fcitx （还有一款叫 ibus）。目前稳定维护的 fcitx 版本是 5 ，但是官方仓库 ::gentoo 目前只有 4 （也能用，就是不怎么维护了）。\n官方仓库 fcitx4 重要：先配置下 fcitx4 开启对 gtk2 的支持以避免有些程序无法使用（gtk3 默认开启了）\n# echo 'app-i18n/fcitx gtk2'  /etc/portage/package.use/fcitx 然后安装\n# emerge app-i18n/fcitx:4 app-i18n/fcitx-configtool:4 app-i18n/fcitx-qt5:4 app-i18n/fcitx-libpinyin:4 其中：\n app-i18n/fcitx 是 fcitx 的主程序 app-i18n/fcitx-configtool 是它的配置工具 app-i18n/fcitx-qt5 用于支持在 qt 程序上使用它 app-i18n/fcitx-libpinyin 是一个输入法  额外仓库 fcitx5 为使用最新的 fcitx5，这里需要使用额外的仓库 ，因为官方仓库目前（2021-11-23）没有。提供 fcitx5 的 Gentoo 仓库（Overlay）推荐 gentoo-zh 。具体方法为：\n  先安装添加额外的仓库必要的工具\n# emerge app-eselect/eselect-repository   然后启用仓库，启用过程中，可能会因为网络原因导致比较慢，请耐心等待\n# eselect repository enable gentoo-zh   更新以获取下仓库内容。\n# emerge dev-vcs/git # emerge --sync gentoo-zh 如果一直卡在这里，那说明当前网络访问 github.com 不流畅。这时候有一种方法是：访问 https://fastgit.org （我不对该网站做任何保证），　修改 /etc/portage/repos.conf/eselect-repo.conf 文件，替换对应链接的域名为上述网站内指定值，并再次同步。\n  添加 portage 配置用于安装\n# mkdir -p /etc/portage/package.mask/ # echo '*/*::gentoo-zh'  /etc/portage/package.mask/gentoo-zh # mkdir -p /etc/portage/package.unmask/ # echo 'app-i18n/fcitx5-meta::gentoo-zh'  /etc/portage/package.unmask/fcitx5 # echo 'app-i18n/fcitx5::gentoo-zh'  /etc/portage/package.unmask/fcitx5 # echo 'app-i18n/fcitx5-configtool::gentoo-zh'  /etc/portage/package.unmask/fcitx5 # echo 'app-i18n/fcitx5-chinese-addons::gentoo-zh'  /etc/portage/package.unmask/fcitx5 # echo 'app-i18n/fcitx5-gtk::gentoo-zh'  /etc/portage/package.unmask/fcitx5 # echo 'app-i18n/fcitx5-qt::gentoo-zh'  /etc/portage/package.unmask/fcitx5 # echo 'app-i18n/libime::gentoo-zh'  /etc/portage/package.unmask/fcitx5 # echo 'x11-libs/xcb-imdkit::gentoo-zh'  /etc/portage/package.unmask/fcitx5 # mkdir -p /etc/portage/package.accept_keywords # echo 'app-i18n/fcitx5-meta ~amd64'  /etc/portage/package.accept_keywords/fcitx5 # echo 'app-i18n/fcitx5 ~amd64'  /etc/portage/package.accept_keywords/fcitx5 # echo 'app-i18n/fcitx5-configtool ~amd64'  /etc/portage/package.accept_keywords/fcitx5 # echo 'app-i18n/fcitx5-chinese-addons ~amd64'  /etc/portage/package.accept_keywords/fcitx5 # echo 'app-i18n/fcitx5-gtk ~amd64'  /etc/portage/package.accept_keywords/fcitx5 # echo 'app-i18n/fcitx5-qt ~amd64'  /etc/portage/package.accept_keywords/fcitx5 # echo 'app-i18n/libime ~amd64'  /etc/portage/package.accept_keywords/fcitx5 # echo 'x11-libs/xcb-imdkit ~amd64'  /etc/portage/package.accept_keywords/fcitx5   之后安装\n# emerge app-i18n/fcitx5-meta 或者\n# EGIT_OVERRIDE_REPO_FCITX_LIBIME=https://hub.fastgit.org/fcitx/libime.git EGIT_OVERRIDE_REPO_KPU_KENLM=https://hub.fastgit.org/kpu/kenlm.git emerge app-i18n/fcitx5-meta 这里安装了 fcitx 的元包，它会自动依赖安装 fcitx5 主体、 RIME 输入法、配置工具等，这个仓库也会默认安装上 fcitx5-chinese-addons ，里面包含有中文输入法。\n如果安装的时候长时间停止在校验 manifest，尝试用 eclean 清除 distfiles 和 packages。可能原因是混合使用了 gentoo（官方） 和 gentoo-zh（overlay）。\n  最后安装肥猫百万大词库：\nDownload latest version of “zhwiki.dict” from https://github.com/felixonmars/fcitx5-pinyin-zhwiki/releases\nCopy into ~/.local/share/fcitx5/pinyin/dictionaries/ (create the folder if it does not exist)\n  提示：\n  当使用非官方的 Fcitx5 时，因为没有镜像收录，所以源码需从 Github 下载，这时可能遇到因网络问题导致无法下载的情况（可以从 /var/log/emerge-fetch.log 文件查看源码包下载情况），如果遇到这种情况那么请自行通过各种途径下载好对应的 .tar.gz 格式（或类似）软件包，然后移动到 /var/cache/distfiles/ 目录下。\n  软件包需更名为对应的包名加完整的版本号（执行上述 emerge  命令后可以看到完整的版本号），比如当显示的包名为 app-i18n/fcitx-gtk-5.0.8:5::gentoo-zh 那么就更名下载的源码包为 fcitx-gtk-5.0.8.tar.gz （ / 符号后以及 : 符号前的内容），以此类推。\n  或者，在 emerge-fetch.log 可以看到下载链接和类似如下的行\nSaving to: ‘/var/cache/distfiles/fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2.__download__’ 通过下载链接下载文件后，改名为删除 .__download__ 剩余部分，如 fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2，然后删除对应的 /var/cache/distfiles/fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2.__download__ 缓存文件，并把重命名的文件移动到 /var/cache/distfiles/。\n  拥抱Fcitx5 起因\n2015年12月，计科杀手 csslayer 创建了fcitx/fcitx5代码库，独自开始了对 Fcitx5 的开发。\n如今五年过去了，Fcitx5 也日渐成熟。（个人感觉算法上相当不错\n今年年初，我从 fcitx-rime 换到 fcitx5-rime ，感觉并不明显 （毕竟对于 Rime 用户来说从4到5最大的变化是界面\n然后，在 Arch Linux CN 众多群友的诱惑下, 我决定尝试一下 Fcitx5 自带的拼音输入法。\n首次使用的体验是相当的棒的，Fcitx5 在默认配置下表现良好，云拼音也有百度，Google，Google CN 三种可选尽管我不怎么用云拼音，整句输入也是相当的棒，还有输入预测功能。\n但这并不是让我抛弃我在 Rime 积攒下的词库投靠老K输入法Fcitx5自带拼音的理由……真正的原因是最近发生的几件事……\n  首先是非常好的反馈体验，开发者老K对待用户非常友好，而且生产力十足\n  然后是 Felix 爬了维基百科制作了肥猫百万大词库，随后大佬 outloudvi 制作了萌娘百科词库，Fcitx5 的日用词库基本满足（AUR 上皆有打包，且在 Arch CN 源有打包\n  肥猫大词库中的一个讨论促使Fcitx5引入了一项新功能——根据前缀生成候选项，效果如图：\n这个功能我觉得对于长词输入是很棒的\n  添加了类似搜狗U模式的拆字模式，效果如图：\n  还有一件事是 Fcitx5 可以使用 fcitx, fcitx5, ibus 的输入法模块（感觉黑科技\n  我从 rime 移植过来一份符号表，这样输入就方便了很多\n  优势\n 上述几条个人认为皆为优势 fcitx5-rime 支持加载动态库形式的 Rime 插件，在设置中填写插件名称即可使用，注意 octagram 插件名称与文件名并不一样（fcitx-rime 无此支持，ibus-rime 有此支持但是似乎配置文件有点问题（喜讯：Arch 官方仓库中的 librime 已经打包了 lua 和 octagram（即语料库）插件 自带一套 LaTeX 简易输入表（虽然只能输入一小部分特殊字符 笔画过滤: 参见 Fcitx5_使用笔画过滤 以词定字 查看选中文字的 Unicode 编码：选中文字，然后使用快捷键 ctrl + alt + shift + u 可以查看选中文字的编码 更好的支持（Fcitx4 已经停止支持  关于设置\n推荐以下设置：\n 预测看个人喜好 启用颜文字 云拼音根据需要来，但是不推荐 Google 后端，原因显然 preedit 也就是单行显示自己选择 安装肥猫百万大词库（墙裂推荐 Lua 插件！！！自带日期和时间，另外推荐几个，内含进制转换、简易计算器和密码生成器  主题美化\n有以下几种选择：\n  kimpanel(KDE)/gnome-shell-extension-kimpanel(Gnome) （同时这也应该是目前 Wayland 下唯一的方案）\n  Material Color 主题，有多种颜色以及单行双行两种模式，Arch 官方源有打包\n  黑色透明主题\n  黑色主题\n  Materia EXP 主题，系统使用暗色主题的用户请谨慎使用\n  Simple Blue 主题\n  Adwaita-dark，推荐 Gnome 用户使用\n  经典的Material 主题，这个主题同时支持4和5 我都没注意这个主题更新了 fcitx5 支持（fcitx5 版本有人在 AUR 上打了包，包名：fcitx5-skin-material\n  base16 material darker 主题\n  自制主题 （顺便写份主题文档吧\n  以上主题在 AUR 皆有打包(似乎目前已有主题在 AUR 上都有打包了\nfcitx5皮肤制作 这次是 fcitx5 是用搜狗皮肤（无法实现动态）！\n下载仓库\n$ git clone https://github.com/fkxxyz/ssfconv.git $ cd ssfconv 下载皮肤\n先从搜狗输入法的皮肤官网下载自己喜欢的皮肤，得到ssf格式的文件，例如 【雨欣】蒲公英的思念.ssf\n转换皮肤\n$ ./ssfconv -t fcitx5 【雨欣】蒲公英的思念.ssf 【雨欣】蒲公英的思念 复制到用户皮肤目录\n$ mkdir -p ~/.local/share/fcitx5/themes/ $ cp -r 【雨欣】蒲公英的思念 ~/.local/share/fcitx5/themes/ 使用该皮肤\n用下面这条命令可以看到该皮肤的名称：\n$ grep Name ~/.local/share/fcitx5/themes/【雨欣】蒲公英的思念/theme.conf 直接修改配置文件 ~/.config/fcitx5/conf/classicui.conf，将 Theme 的值改成这个皮肤的名称即可。\nfcitx(5)+rime的畅快体验   下载词库转换工具：imewlconverter\n  安装 dotnet-runtime\n  寻找词库文件\n 比如从搜狗词库中寻找：搜狗细胞词库词库下载词典_输入法字典 或者从qq词库中寻找：QQ输入法-词库平台    转换词库文件：以“网络工程词库.scel”为例\n$ dotnet ImeWlConverterCmd.dll -ct:pinyin -os:linux -i:scel ./网络工程词库.scel -o:rime ./network.txt  -i:scel对应搜狗的词库文件后缀，如果你要转换qq的词库文件把这里改成qcel -o:rime ./network.txt表示按照rime输入法词库文件格式转换，转换出的文件在当前目录下，且名字为network.txt    转换完成之后将这个文件拷贝到你的用户资料目录下：\n fcitx4: ~/.config/fcitx/rime fcitx5:~/.local/share/fcixt5/rime  文件以luna_pinyin.xxx.dict.yaml的格式命名，如luna_pinyin.network.dict.yaml，之后重启fcitx(5)即可\n  dict.7z 是我的词库文件，拿去解压到你的用户资料目录下即可使用。\n环境配置 无论选择哪个版本、哪个仓库，安装完成后，均执行此配置，这里另开一个终端，以普通用户编辑 ~/.pam_environment 文件（这里为普通用户的家目录下，不存在则创建一个），然后添加以下内容：\nGTK_IM_MODULE DEFAULT=fcitx QT_IM_MODULE DEFAULT=fcitx XMODIFIERS DEFAULT=\\@im=fcitx SDL_IM_MODULE DEFAULT=fcitx 之后，登出 KDE Plasma，后重新登陆，此时只需做最后的配置，以安装的为 fcitx:5 为例，\n 右击托盘区输入法图标，选择 Configure 点击右下角 Add Input Method search 框下输入 Pinyin 选中 Pinyin 后点击右下角的 Add Apply 后退出界面 右击托盘区输入法图标，选择 Restart  Rime 安装 rime 输入法引擎\n# fcitx4 $ sudo emerge app-i18n/fcitx-rime # fcitx5 $ sudo emerge app-i18n/fcitx5-rime 下载 rime-cloverpinyin 最新版本（如clover.schema-build-1.1.4.zip）输入方案（配置方案），解压到用户资料夹：\n fcitx：~/.config/fcitx/rime fcitx5：~/.local/share/fcitx5/rime  在用户资料夹下创建 default.custom.yaml ，内容为\npatch: \"menu/page_size\": 8 schema_list: - schema: clover 其中 8 表示打字的时候输入面板的每一页的候选词数目，可以设置成 1~9 任意数字。\n写好该文件之后，点击右下角托盘图标右键菜单，点“重新部署”，然后再点右键，在方案列表里面应该就有“ 🍀️四叶草拼音输入法”的选项了。\n更多访问 Rime 官网。\nSettings System Settings Appearance\n Global Theme: Breeze  Workspace Behavior\n General Behavior  Clicking files or folders: Selects them   Screen Locking  Lock screen automatically: 10 minutes    Startup and Shutdown\n Login Screen  Breeze    Regional Settings\n Date \u0026 Time  Set date and time automatically    Connections\n IPv4  Method: Automatic (Only addresses) DNS Servers: 114.114.114.114    Settings\n Proxy  Use manually specified proxy configuration    Display Configuration\n  Night Color\n  Activate Night Color\n  Sunset to sunrise at manual location\nBeijin: 39.90403 116.40753\n    Bluetooth 蓝牙默认是无法使用的\n# systemctl enable bluetooth 首选编辑器 Gentoo Linux 默认安装的编辑器为 nano ，这是一个初始设置下就很适合新手的编辑器，如果你有其它的要求，比如想使用 vim 或者 emacs ，可以先安装\n# emerge -vj app-editors/vim # emerge -vj app-editors/emacs 列出当前存在的编辑器\n# eselect editor list 根据所需要的编辑器对应的序号，设置默认\n# eselect editor set 「序号」 # . /etc/profile Apps mutt # emerge net-mail/fetchmail mail-filter/procmail mail-client/mutt mail-mta/msmtp mpv # emerge media-video/mpv spotify # emerge media-sound/spotify youtube-dl # emerge dev-python/pip ... aria2 # echo 'net-misc/aria2 bittorrent'  /etc/portage/package.use/aria2 # emerge net-misc/aria2 Typora # echo '=app-editors/typora-0.11.18::gentoo-zh='  /etc/portage/package.unmask/typora # echo '=app-editors/typora-0.11.18::gentoo-zh ~amd64'  /etc/portage/package.accept_keywords/typora # cp -av /opt/typora/share/icons/hicolor/* /usr/share/icons/hicolor/ zsh # emerge app-shells/zsh $ chsh Password: Changing the login shell for kurome Enter the new value, or press ENTER for the default Login Shell [/bin/bash]: /bin/zsh Clash clash 需要 root 执行，编写一个 service 就可以了。\ncfw 无法设置 port，总是重置为 0。\nBrowsers 关于浏览器的选择有很多，比如\n www-client/google-chrome （chrome 的官方二进制包） www-client/google-chrome-beta （chrome 的官方二进制包， beta 分支） www-client/chromium （chromium 源码包，需编译，时间很久很久） www-client/firefox-bin （火狐官方二进制包，国际版） www-client/firefox （火狐源码包，需编译，时间很久） www-client/microsoft-edge-beta （Edge 官方二进制包， beta 分支） 等  可以自行选择安装。命令依旧是 emerge  。安装个别浏览器时，可能会因为许可问题导致无法安装，如何解决看下文的 软件的许可 一节。\n其它的应用自行发掘。这里有推荐应用列表：\n https://wiki.gentoo.org/wiki/Recommended_applications https://wiki.archlinux.org/title/List_of_applications  至此，桌面配置告一段落。\nkio-extras (only for kde)\nMTP (Media Transfer Protocol) is a protocol to allow the transfer of files to external devices. It is provided by several programs, most of them depending on FUSE.\n# echo 'kde-apps/kio-extras mtp'  /etc/portage/package.use/kio-extras # emerge --ask kde-apps/kio-extras Gwenview KDE app，看图。\n# emerge kde-apps/gwenview Okular KDE app，PDF 阅读。\n# emerge kde-apps/okular KTimer KDE app，类似于 cronie，只不过是GUI。\n# emerge kde-apps/ktimer KClock KDE app，一个时钟。\n# eselect repository enable guru # emerge --sync guru # echo '*/*::guru'  /etc/portage/package.mask/guru # echo '=kde-apps/kclock-21.12::guru'  /etc/portage/package.unmask/kclock # echo '=kde-apps/kclock-21.12::guru ~amd64'  /etc/portage/package.accept_keywords/kclock # echo '=kde-frameworks/kirigami-addons-0.2::guru'  /etc/portage/package.unmask/kclock # echo '=kde-frameworks/kirigami-addons-0.2::guru ~amd64'  /etc/portage/package.accept_keywords/kcloc # emerge kde-apps/kclock RSIBreak 番茄钟\nLibreOffice # emerge app-office/libreoffice-bin Flameshot 很棒的截图软件\n$ sudo emerge media-gfx/flameshot Spectacle KDE app，用的不是很习惯。\n# emerge kde-apps/spectacle KeePassXC # emerge app-admin/keepassxc PPSSPP # echo \"games-emulation/ppsspp ~amd64\"  /etc/portage/package.accept_keywords/ppsspp # emerge games-emulation/ppsspp papirus-icon-theme $ sudo emerge -a papirus-icon-theme Vulkan # emerge --ask media-libs/vulkan-loader tree # emerge app-text/tree qemu # echo 'QEMU_SOFTMMU_TARGETS=\"x86_64\"'  /etc/portage/make.conf # echo 'QEMU_USER_TARGETS=\"x86_64\"'  /etc/portage/make.conf # emerge app-emulation/qemu net-fs/samba # gpasswd -a kurome kvm Could not access KVM kernel module: Permission denied\nDocker # emerge --ask --verbose app-emulation/docker # systemctl enable docker.service # systemctl start docker.service # usermod -aG docker  # docker run --rm hello-world lsusb # emerge --ask sys-apps/usbutils p7zip # emerge app-arch/p7zip Important: The 7-zip archive format does not store standard Unix file permissions such as owner/group or extended file attributes. Those who desire to use 7-zip as a long-term backup or archiving solution should wrap files in a tar archive before compressing with 7z. Use the following command to archive directories of files, preserving Unix file permissions:\n$ tar cf -  | 7za a -si .tar.7z To extract:\n$ 7za x -so .tar.7z | tar xf - zip # emerge app-arch/zip Ark File archiver by KDE\n# emerge kde-apps/ark ADB and Fastboot Fastboot is included with ADB inside the dev-util/android-tools package::\n# emerge --ask dev-util/android-tools To run adb without root privileges then the unprivileged user account must be added to the plugdev group:\n# groupmod -a plugdev -U kurome no permissions (missing udev rules? user is in the plugdev group)\n需添加 udev 规则：使用下面的模板，并用你的 [VENDOR ID] 和 [PRODUCT ID] 替换里面的值。 然后把这些规则复制到 /etc/udev/rules.d/51-android.rules：\nSUBSYSTEM==\"usb\", ATTR{idVendor}==\"[VENDOR ID]\", MODE=\"0666\", GROUP=\"adbusers\" SUBSYSTEM==\"usb\",ATTR{idVendor}==\"[VENDOR ID]\",ATTR{idProduct}==\"[PRODUCT ID]\",SYMLINK+=\"android_adb\" SUBSYSTEM==\"usb\",ATTR{idVendor}==\"[VENDOR ID]\",ATTR{idProduct}==\"[PRODUCT ID]\",SYMLINK+=\"android_fastboot\" 再加载刚定义的规则，运行：\n# udevadm control --reload-rules 确保你是 adbusers user group 的成员，以访问 adb 设备。\nadb: device unauthorized.\n请打开手机同意 USB 调试。\nFile transfer Push a file\n$ adb push mypicture.png /sdcard/on/device Push a folder\n$ adb push myfolder /sdcard/on/device Push all files in a folder\n$ adb push myfolder/ /sdcard/on/device Pull a file\n$ adb pull /sdcard/on/device/mypicture.png Pull a folder\n$ adb pull /sdcard/on/device /home/̩$(whoami)/android-folder/ Flatpak # cat  /etc/portage/accept_keywords/flatpak sys-apps/flatpak ~amd64 acct-user/flatpak ~amd64 acct-group/flatpak ~amd64 dev-util/ostree ~amd64 # emerge sys-apps/flatpak # flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo # flatpak remote-modify flathub --url=https://mirror.sjtu.edu.cn/flathub neofetch $ sudo emerge app-misc/neofetch 使用自定义图像 默认情况下，Neofetch 将显示你的操作系统 logo 以及系统信息。当然，你可以根据需要更改图像。\n要显示图像，Linux 系统应该安装以下依赖项：\n w3m-img（用于显示图像。w3m-img 有时与 w3m 包捆绑在一起）， Imagemagick（用于创建缩略图），  大多数 Linux 发行版的默认仓库中都提供了 w3m-img 和 ImageMagick 包。因此，你可以使用你的发行版的默认包管理器来安装它们。\n现在，运行以下命令以使用自定义图像显示系统信息：\n$ neofetch --w3m /home/sk/Pictures/image.png 或者，\n$ neofetch --w3m --source /home/sk/Pictures/image.png 或者，你可以指向包含以下图像的目录。\n$ neofetch --w3m  配置 Neofetch 当我们第一次运行 Neofetch 时，它默认会为每个用户在 $HOME/.config/neofetch/config.conf 中创建一个配置文件。你可以调整此文件来告诉 neofetch 该显示、删除和/或修改哪些详细信息。\n还可以在不同版本中保留此配置文件。这意味着你只需根据自己的喜好自定义一次，并在升级到更新版本后使用相同的设置。你甚至可以将此文件共享给你的朋友和同事，使他拥有与你相同的设置。\ncpuid2cpuflags 检测cpu指令集\n$ sudo emerge app-portage/cpuid2cpuflags $ sudo cpuid2cpuflags 安装完成之后使用该指令并将输出值作为CPU_FLAGS_X86的值输入到make.conf中\nflaggie 安装flaggie来更加方便的管理单个包的USE变量\n$ sudo emerge app-portage/flaggie 用法：比如添加a包的b特性\n# flaggie a +b 去掉c包的d特性\n# flaggie c -d Others Recommended applications: Gentoo List of applications: Arch Tips 为 Portage 包管理器设置代理 开门见山，本文介绍在 Gentoo Linux 下如何正确地对其包管理器 Portage 设置代理，即日常使用的 emerge 命令。这里介绍软件下载安装时需要的配置；对于同步 Portage 树，则是部分适用。\nGentoo 的默认设置  代理： 无 工具： 默认使用 wget 作为下载工具，但对于绝大部分的 live 包，会有针对的 eclass 使用对应的版本控制工具从远程仓库抓取，这里仅以 git 为例。  live 包：即版本号带 9999* 的这些包；用于匹配 live ebuild 文件名的正则表达式为 9999*(-r[0-9]{1,3})?.ebuild$ ，可还是有一些包使用了这种版本命名规则却并非真正的 live 包，比如 openjfx/openjfx-8.999.ebuild ；这里不会通过版本号来判断是否需要配置 git 参数，所以并不影响，仅作介绍。\n持久性地修改代理 通用配置 $ man make.conf 可以看到里面有说明如何配置代理，但是过于简要，这边详细说明。\n对于一般情况，在 /etc/portage/make.conf 文件下配置如下三个变量，就完全足够：\nhttp_proxy=\"[protocol://][user[:password]@]proxyhost[:port]\" https_proxy=\"[protocol://][user[:password]@]proxyhost[:port]\" ftp_proxy=\"[protocol://][user[:password]@]proxyhost[:port]\" 这些变量会在 emerge 命令运行时，传递给预配置的 FETCHCOMMAND 即 wget 命令。但，该命令有一个问题是不支持 socks 协议；所以，对于不同的协议需要有不同的代理服务，这样子很麻烦。\n修改以支持 socks 协议有一个应变的方法，即修改默认的获取命令为 curl ，同样是在 /etc/portage/make.conf 文件下配置变量，如下：\nFETCHCOMMAND=\"curl --retry 3 --connect-timeout 60 --ftp-pasv -Lfo \\\"\\${DISTDIR}/\\${FILE}\\\" \\\"\\${URI}\\\"\" RESUMECOMMAND=\"curl -C - --retry 3 --connect-timeout 60 --ftp-pasv -Lfo \\\"\\${DISTDIR}/\\${FILE}\\\" \\\"\\${URI}\\\"\" 其中 RESUMECOMMAND 是用于恢复意外中断的下载命令，保存后即完成修改，此时，就可以给不同协议配置同样的 socks 类协议的代理服务，均可生效。如：\nhttps_proxy=\"socks5h://127.0.0.1:1080\" 单独配置 git 抓取 对于 live 包，它们目前大多数直接使用 git 命令从远程仓库抓取。其它版本控制工具（目前支持的大致有 bzr, cvs, darcs, mercurial, subversion）同理，请自行修改后套用；当然也有直接使用 wget|curl 下载 live 包的情况，那么这种情况如上「一」述。\ngit 命令支持 socks 协议，并且除了能吃上述配置的环境变量外，\n配置 https_proxy 时也配好 http_proxy ，否则可能出现 SSL_ERROR_SYSCALL 错误。\n还能独立于其它包单独配置 git 自身的代理，方法有两种：\n  git 能配置针对整个 Linux 系统的参数，运行：\ngit config --system http.proxy '[protocol://][user[:password]@]proxyhost[:port]' 此命令会将配置写入到 /etc/gitconfig 文件内，并生效于系统级别，会被用户/项目级别的配置覆盖。\n  通过 Portage 的全局 bashrc 文件 /etc/portage/bashrc 来配置临时的 git 代理\n这种方式会对系统配置造成最少的干扰，只略微繁琐一点，需要将下述脚本代码写入上述的 bashrc 文件内：\nif [[ ${EBUILD_PHASE} == \"unpack\" \u0026\u0026 ${INHERITED} =~ git\\-r3 ]]; then git config --global http.proxy '[protocol://][user[:password]@]proxyhost[:port]' fi 这个 bashrc 只被 Portage 引用，会在进入每一个安装阶段时被导入。目前，Portage 下抓取 git 项目是通过 git-r3.eclass 实现，该 eclass 定义了 git 项目是在 src_unpack 阶段被更新，所以这里只需要在此阶段时设置即可。且，因为该目录不是被抓取包的 git 目录，所以只能设置用户级别的配置以生效，配置文件会被存放于 Portage 安装过程中沙盒的家目录下，即对应 安装软件临时目录 （这个目录是 Portage 在编译/安装软件过程中临时建立的，会在成功安装软件后被删除，所以不用担心会有文件残留。具体位置是可以自定义的，详情看 make.conf(5) 手册下 PORTAGE_TMPDIR 条目）下的 homedir/ 目录。\n  临时添加代理 对于需要临时添加代理以使用的情况，目前我知道两种方式：\n推荐：ProxyChains ProxyChains is a UNIX program, that hooks network-related libc functions in dynamically linked programs via a preloaded DLL and redirects the connections through SOCKS4a/5 or HTTP proxies.\n使用 net-misc/proxychains 软件适用所有下载方式。\n配置文件可以放在 ~/.proxychains/proxychains.conf，也可以放在 /etc/proxychains.conf，但是放在 etc 下更好，因为有时候要通过sudo安装软件。\n# emerge net-misc/proxychains # vi /etc/proxychains.conf ... socks5 127.0.0.1 7891 配置好代理列表后，通过如下命令使用：\n#proxychains -q emerge [...] 临时指定环境变量 {ftp,http,https}_proxy 的方式，适用性同持久性配置。\n即如下命令：\nexport http_proxy=\"...\" https_... emerge [...] 或\nhttp_proxy=\"...\" https_... emerge [...] Freeing disk space How to Change \u0026 Set the Default crontab Editor $ EDITOR=nano crontab -e How to update dolphin file manager in real time The way in order to refresh Dolphin is to press F5. However, this would be manual.\nIn order to continuously refresh, an automatic solution, create a bash script that runs on boot. This bash script should press F5 every five seconds if Dolphin is open. Create a file named dolphin-update in /usr/local/bin with the following contents:\n#!/bin/bash while true; do PID=$(pgrep \"dolphin\") if [ \"$?\" -ne \"0\" ]; then xdotool key 'F5' fi sleep 5 done You may need to first create it as root and then change the owner to your user:\nsudo chown username:username /usr/local/bin/dolphin-update Ensure that it has executable permissions:\nchmod +x /usr/local/bin/dolphin-update Now we need that to run on boot. To do that run sudo crontab -e and add the following line to the end of the file:\n@reboot /usr/local/bin/dolphin-update This script will run on boot.\nYou should now have a continuously refreshing Dolphin!\nThere are some caveats to this script.\n If you open Dolphin, go to another application where F5 triggers something, (eg Chromium refreshes the page), the script will still run and be a constant annoyance. Solution: Close Dolphin when not actively using it. As a cron job is used, if your computer crashes, the script will not run on boot. However this is a problem with cron not the script.  What the script means, line by line:\n #!/bin/bash - shebang to run with bash while true; do - run continuously PID=$(pgrep \"dolphin\") - find the process ID of a dolphin instance. This is purely there to check whether there is even a instance of Dolphin running. if [ \"$?\" -ne \"0\" ]; then - check the result of whether there is a Dolphin instance running. If there is, then … xdotool key 'F5' - press F5 fi - end the if block sleep 5 - wait 5 seconds before repeating the process done - end the while block  How do I convert a .PNG into a .ICO? $ ffmpeg -i img.png img.ico $ ffmpeg -i img.png -vf scale=32:32 img.ico Crop a photo to fit a circle using ffmpeg $ ffmpeg -i avatar.png -i mask.png -filter_complex \"[0]scale=400:400[ava];[1]alphaextract[alfa];[ava][alfa]alphamerge\" output.png scale=400:400 是 mask.png 的大小。\nmask.png is just a circle, example:\nPath to KDE Picture of the Day $ cd $HOME/.cache/plasma_engine_potd $ file * apod: JPEG image data, JFIF standard 1.01, resolution (DPI), density 96x96, segment length 16, comment: \"Description: Adobe ImageReady\", baseline, precision 8, 960x634, components 3 bing: JPEG image data, JFIF standard 1.01, resolution (DPI), density 96x96, segment length 16, baseline, precision 8, 1920x1080, components 3 unsplash:1065976: JPEG image data, JFIF standard 1.01, resolution (DPI), density 72x72, segment length 16, baseline, precision 8, 3840x2160, components 3 Baloo Baloo is the file indexing and file search framework for KDE Plasma, with a focus on providing a very small memory footprint along with with extremely fast searching.\nIndexing limitations\nBaloo uses the file metadata extractors in KFileMetadata to get information about each file it indexes. This means for a file’s content to be indexed\n the file must have a recognizable MIME type KDE must have an extractor for that MIME type  Other limitations:\n Baloo doesn’t index text files (those whose MIME type is detected as “text/something\") over 10 MB (source). The KFileMetadata extractor for text attempts to convert text to Unicode. If the file uses another encoding, such as iso-8859-1, any file contents after the first character that is invalid in Unicode will not be indexed. You may find the -i option to the file command-line utility useful; it tries to infer the character set of a file, e.g. file -i path/to/myfile.txt.  Using Baloo\nBaloo is not an application, but a daemon to index files. Applications can use the Baloo framework to provide file search results. For example, Dolphin’s Content search can use Baloo.\nKDE System Settings  File Search provides an intentionally limited number of settings. You can make additional adjustments in Baloo’s configuration file.\nbalooctl\nbalooctl is a CLI command to perform certain operations on Baloo. Enter balooctl --help in a terminal app such as userbase:Konsole to list its available subcommands.\nBaloo File Extractor Crashes on every boot I find Baloo fragile and a nuisance. Sometimes it works OK on my amd64 and ~amd64 machines, other times not. If you are not interested in file indexing, you can disable it:\n$ balooctl disable 这个不好用，菊苣（巨巨、大佬）们都推荐关闭。\n内核升级一般步骤 升级内核 建议在make.conf中添加USE='symlink'，然后更新系统。\n$ sudo emerge --ask --verbose --update --deep --newuse @world Configuration $ sudo make menuconfig Build $ sudo make -j4 Install $ sudo make modules_install $ sudo make install BootLoader $ sudo grub-mkconfig -o /boot/grub/grub.cfg 重启以应用新的内核。\nClean $ sudo eclean-kernel -n 1 仅保留当前内核。\ndwm 长时间日常使用动态窗口管理器之后发现，相比与传统的DE型桌面，这种WM型窗口管理方式确实能很大程度上提高工作效率。\nDE和WM的区别 首先说明一下我即将提到的东西是什么。\n DE：Desktop Environment WM：Window Manager  桌面环境是一个相对完整的概念，一般情况下DE包含WM，比如Gnome3的默认WM是Mutter，KDE5的默认WM是KWin。主流的桌面环境都提供了大量自带的桌面组件来构成其完整的桌面体验。\n窗口管理器只是管理出现在你的桌面上的各种窗口的组件，具体的管理内容包含比如：窗口堆叠方式，窗口移动规则等。大多数人接触到的是堆叠式窗口管理器，一个窗口可以叠放在其他窗口之上，调整窗口的主要方式是鼠标。我即将介绍的dwm（Dynamic Window Manager）属于动态窗口管理器，可以自定义不同窗口的出现规则如平铺或者堆叠，主要的调整窗口的方式是键盘。\n大多数窗口管理器只提供管理窗口的逻辑和人机交互的处理，并不自带其他组件如程序启动器、终端等软件，因此只运行一个窗口管理器理论上是要比运行一个完整的桌面环境更加节约资源，也有更好的可伸缩性。\n实际上WM这个概念是应用了奥卡姆剃刀原理，把那些看似有点用但实际上多余的功能全部剔除，只留下你真正需要的和最常用的功能并加以强化，Less is More.\ndwm与其他wm的区别 前面已经说明了dwm与堆叠式窗口管理器的区别，下面说明一下dwm与其他平铺\u0026动态窗口管理器的区别。\ndwm使用C语言编写，使用修改源代码的方式来进行配置。说到源代码可能有些同学就有点害怕，其实修改源代码也很简单，因为有现成的例子可以复(bai)用(piao)嘛！通过直接修改源代码理论上可以确保你的dwm能满足你所有的需求，同时也没有多余的，你不需要的功能。\n相比之下，另外一个相当流行的动态窗口管理器i3wm也是使用C语言编写，但是通过修改其配置文件来配置，这相当于i3wm向你暴露可以被配置的接口来满足你的需求，但是这样的配置方式缺点在于你不能向其添加你需要的需求，只能向上游提交issue来完成enhancement。\n具有和dwm相似配置能力的窗口管理器是xmonad，它也是通过直接修改源代码的方式来调整配置，但是因为使用haskell编写的所以需要安装相当多的依赖，此外其运行效率也不及dwm。\n通用的wm配置 因为一个可独立运行的窗口管理器默认不携带任何多余的软件，所以为了满足日常使用需要进行一定程度的自定义配置，下面给出一下通用的配置：\n常用软件的推荐\n用半角逗号分隔的同类别软件顺序表示推荐等级\n 终端：kitty, alacritty, termite（前两个有GPU加速） 护眼：redshift-gtk 程序启动器：dmenu, rofi Shell：fish, zsh 壁纸设置器：feh, nitrogen 音乐播放器：mpd\u0026ncmpcpp（基于终端）, deadbeaf-git 特效合成器：picom-jonaburg-git, picom 文件管理器：thunar, nemo 电源管理器：xfce4-power-manager 截图工具：flameshot, scrot 主题设置器：lxappearance\u0026qt5ct\u0026xsettingsd 输入法：fcitx5 科学上网工具：qv2ray 剪切板管理器：copyq 云同步工具：nutstore（坚果云）, dropbox 通知管理器：dunst 锁屏管理器：betterlockscreen, xautolock（用于自动锁屏） pdf 阅读器：zathura（vim风格）, atril（没有gnome依赖的evince） 文本编辑器：nvim, doom emacs(可选)，(vs)code 屏幕亮度调节器：light  关于平铺还是浮动\n个人建议多数窗口平铺，以下窗口默认浮动：\nvirtualbox, lxappearance, qq, gpick, qalculator, slickpicker\n关于GTK主题和QT主题\n我建议让QT程序使用GTK主题，除上文提到的qt5ct再安装qt5-styleplugins\n在qt5ct中设置风格为gtk2\ndwm安装 $ wget https://dl.suckless.org/dwm/dwm-6.2.tar.gz $ tar xpvf dwm-6.2.tar.gz $ mv dwm-6.2 ~/.dwm dwm配置 配置dwm主要需要修改的文件是config.def.h，主要的配置方式是使用被人写好的patch加必要时候的手动修改。dwm的patch都在其官方网站\n具体过程是这样的：\n 找到你需要的patch并下载 将其移动到~/.dwm目录下  $ patch 之后会输出这个patch过程的详细情况，一般情况不会出现问题\n需要注意的是要一个一个来\n出现问题之后需要对照如：config.def.h.rej, dwm.c.rej等后缀为rej的文件来手动修改对应的没有rej后缀的源文件\n打开之后rej文件中行首标有+的行是需要添加的行，标有-的行是需要删除的行\n所有更改都修改完毕之后重新编译安装，执行：\n$ rm -f ./config.h \u0026\u0026 sudo make clean install 不要忘记添加dwm.desktop文件：\n$ sudo vim /usr/share/xsessions/dwm.desktop [Desktop Entry] Encoding=UTF-8 Name=Dwm Comment=Dynamic window manager Exec=dwm Icon=dwm Type=XSession 下面是我自己打完patch之后的配置：\nhttps://github.com/ayamir/dwm-dotfilesgithub.com/ayamir/dwm-dotfiles\n新手可以直接使用我的配置，相对比较完整，使用说明我已经写好了，基本上实现了i3wm上提供的功能。\nQuestions Problem with transparencies and windowing ghosting out Anyhow, I now applied the “force smoothest animations” in the KDE compositor settings and it seems to have done the trick!Telegram not launching from the browser xdg-open\nTelegram not launching from the browser xdg-open I am receiving the following message:\nUnable to create io-slave. klauncher said: Unknown protocol 'tg'. Hey! So it’s easy to solve\n Open the folder \\~/.local/share/applications find some files about telegram desktop, like an example, my is userapp-Telegram Desktop-FXJ6T0.desktop Add the line at the end of file MimeType=application/x-xdg-protocol-tg;x-scheme-handler/tg; Reload your browser (maybe do not need…) Enjoy!  我的该目录下有两个与telegram相关的desktop文件，都改了之后就行了。\n",
  "wordCount" : "126596",
  "inLanguage": "en",
  "datePublished": "2022-03-08T17:03:39+08:00",
  "dateModified": "2022-03-08T17:03:39+08:00",
  "author":{
    "@type": "Person",
    "name": "Sakamoto Kurome"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://sakamotokurome.github.io/posts/gentoo/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Sakamoto Kurome",
    "logo": {
      "@type": "ImageObject",
      "url": "https://sakamotokurome.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://sakamotokurome.github.io/" accesskey="h" title="Sakamoto Kurome (Alt + H)">Sakamoto Kurome</a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://sakamotokurome.github.io/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://sakamotokurome.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://sakamotokurome.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Gentoo
    </h1>
    <div class="post-meta"><span title='2022-03-08 17:03:39 +0800 CST'>March 8, 2022</span>&nbsp;·&nbsp;253 min&nbsp;·&nbsp;Sakamoto Kurome

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#qemulinux-guesthttpswikigentooorgwikiqemulinux_guest" aria-label="QEMU/Linux guest"><a href="https://wiki.gentoo.org/wiki/QEMU/Linux_guest">QEMU/Linux guest</a></a><ul>
                        
                <li>
                    <a href="#configuration" aria-label="Configuration">Configuration</a><ul>
                        
                <li>
                    <a href="#host" aria-label="Host">Host</a></li>
                <li>
                    <a href="#using-uefi-with-qemuhttpsfedoraprojectorgwikiusing_uefi_with_qemu" aria-label="Using UEFI with QEMU"><a href="https://fedoraproject.org/wiki/Using_UEFI_with_QEMU">Using UEFI with QEMU</a></a></li></ul>
                </li>
                <li>
                    <a href="#questions" aria-label="Questions">Questions</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bb%8b%e7%bb%8dhttpswikigentooorgwikihandbookamd64installationabout" aria-label="介绍"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/About">介绍</a></a><ul>
                        
                <li>
                    <a href="#%e6%ac%a2%e8%bf%8e" aria-label="欢迎">欢迎</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e6%ad%a5%e9%aa%a4" aria-label="安装步骤">安装步骤</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%80%89%e6%8b%a9%e6%ad%a3%e7%a1%ae%e7%9a%84%e5%ae%89%e8%a3%85%e5%aa%92%e4%bb%8bhttpswikigentooorgwikihandbookamd64installationmedia" aria-label="选择正确的安装媒介"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Media">选择正确的安装媒介</a></a><ul>
                        
                <li>
                    <a href="#%e7%a1%ac%e4%bb%b6%e9%9c%80%e6%b1%82" aria-label="硬件需求">硬件需求</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8gentoo-linux%e5%ae%89%e8%a3%85%e5%85%89%e7%9b%98" aria-label="使用Gentoo Linux安装光盘">使用Gentoo Linux安装光盘</a><ul>
                        
                <li>
                    <a href="#%e6%9c%80%e5%b0%8f%e5%8c%96%e5%ae%89%e8%a3%85cd" aria-label="最小化安装CD">最小化安装CD</a></li>
                <li>
                    <a href="#stage%e5%8f%88%e6%98%af%e4%bb%80%e4%b9%88" aria-label="stage又是什么？">stage又是什么？</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%8b%e8%bd%bd" aria-label="下载">下载</a><ul>
                        
                <li>
                    <a href="#%e8%8e%b7%e5%be%97%e5%ae%89%e8%a3%85%e5%aa%92%e4%bb%8b" aria-label="获得安装媒介">获得安装媒介</a></li>
                <li>
                    <a href="#%e6%a0%a1%e9%aa%8c%e4%b8%8b%e8%bd%bd%e7%9a%84%e6%96%87%e4%bb%b6" aria-label="校验下载的文件">校验下载的文件</a></li>
                <li>
                    <a href="#%e5%88%bb%e5%bd%95%e5%85%89%e7%9b%98" aria-label="刻录光盘">刻录光盘</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%90%af%e5%8a%a8" aria-label="启动">启动</a><ul>
                        
                <li>
                    <a href="#%e5%90%af%e5%8a%a8%e5%ae%89%e8%a3%85%e5%aa%92%e4%bb%8b" aria-label="启动安装媒介">启动安装媒介</a></li>
                <li>
                    <a href="#%e9%a2%9d%e5%a4%96%e7%9a%84%e7%a1%ac%e4%bb%b6%e9%85%8d%e7%bd%ae" aria-label="额外的硬件配置">额外的硬件配置</a></li>
                <li>
                    <a href="#%e6%8e%a8%e8%8d%90%e7%94%a8%e6%88%b7%e8%b4%a6%e5%8f%b7" aria-label="推荐：用户账号">推荐：用户账号</a></li>
                <li>
                    <a href="#%e5%9c%a8%e5%ae%89%e8%a3%85%e6%97%b6%e6%9f%a5%e7%9c%8b%e6%96%87%e6%a1%a3" aria-label="在安装时查看文档">在安装时查看文档</a></li>
                <li>
                    <a href="#%e6%8e%a8%e8%8d%90%e5%90%af%e5%8a%a8ssh%e6%9c%8d%e5%8a%a1httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle88eb7e58f96e59fbae69cace7b3bbe7bb9f" aria-label="推荐：启动SSH服务"><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E8%8E%B7%E5%8F%96%E5%9F%BA%E6%9C%AC%E7%B3%BB%E7%BB%9F">推荐：启动SSH服务</a></a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e7%bd%91%e7%bb%9chttpswikigentooorgwikihandbookamd64installationnetworking" aria-label="配置网络"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Networking">配置网络</a></a><ul>
                        
                <li>
                    <a href="#%e8%87%aa%e5%8a%a8%e7%bd%91%e7%bb%9c%e6%a3%80%e6%b5%8b" aria-label="自动网络检测">自动网络检测</a><ul>
                        
                <li>
                    <a href="#%e8%af%86%e5%88%ab%e6%8e%a5%e5%8f%a3%e5%90%8d%e7%a7%b0" aria-label="识别接口名称">识别接口名称</a></li>
                <li>
                    <a href="#ifconfig%e5%91%bd%e4%bb%a4" aria-label="ifconfig命令">ifconfig命令</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e7%bd%91%e7%bb%9c" aria-label="测试网络">测试网络</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%87%aa%e5%8a%a8%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae" aria-label="自动网络配置">自动网络配置</a></li>
                <li>
                    <a href="#%e9%bb%98%e8%ae%a4%e4%bd%bf%e7%94%a8net-setup" aria-label="默认：使用net-setup">默认：使用net-setup</a></li>
                <li>
                    <a href="#%e5%8f%af%e9%80%89%e4%bd%bf%e7%94%a8ppp" aria-label="可选：使用PPP">可选：使用PPP</a></li>
                <li>
                    <a href="#%e5%8f%af%e9%80%89%e4%bd%bf%e7%94%a8pptp" aria-label="可选：使用PPTP">可选：使用PPTP</a></li>
                <li>
                    <a href="#%e6%89%8b%e5%8a%a8%e9%85%8d%e7%bd%ae%e7%bd%91%e7%bb%9c" aria-label="手动配置网络">手动配置网络</a><ul>
                        
                <li>
                    <a href="#%e5%8a%a0%e8%bd%bd%e9%80%82%e5%bd%93%e7%9a%84%e7%bd%91%e7%bb%9c%e6%a8%a1%e5%9d%97" aria-label="加载适当的网络模块">加载适当的网络模块</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8dhcp" aria-label="使用DHCP">使用DHCP</a></li>
                <li>
                    <a href="#%e5%87%86%e5%a4%87%e6%97%a0%e7%ba%bf%e7%bd%91%e7%bb%9c%e9%93%be%e6%8e%a5" aria-label="准备无线网络链接">准备无线网络链接</a></li>
                <li>
                    <a href="#%e7%bd%91%e7%bb%9c%e6%9c%af%e8%af%ad%e8%a7%a3%e8%af%bb" aria-label="网络术语解读">网络术语解读</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8ifconfig%e5%92%8croute" aria-label="使用ifconfig和route">使用ifconfig和route</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%87%86%e5%a4%87%e7%a3%81%e7%9b%98httpswikigentooorgwikihandbookamd64installationdisks" aria-label="准备磁盘"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks">准备磁盘</a></a><ul>
                        
                <li>
                    <a href="#%e5%9d%97%e8%ae%be%e5%a4%87%e7%ae%80%e4%bb%8b" aria-label="块设备简介">块设备简介</a><ul>
                        
                <li>
                    <a href="#%e5%9d%97%e8%ae%be%e5%a4%87" aria-label="块设备">块设备</a></li>
                <li>
                    <a href="#%e5%88%86%e5%8c%ba%e8%a1%a8" aria-label="分区表">分区表</a></li>
                <li>
                    <a href="#%e9%ab%98%e7%ba%a7%e5%ad%98%e5%82%a8" aria-label="高级存储">高级存储</a></li>
                <li>
                    <a href="#%e9%bb%98%e8%ae%a4%e5%88%86%e5%8c%ba%e6%96%b9%e6%a1%88" aria-label="默认分区方案">默认分区方案</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%ae%be%e8%ae%a1%e4%b8%80%e4%b8%aa%e5%88%86%e5%8c%ba%e6%96%b9%e6%a1%88" aria-label="设计一个分区方案">设计一个分区方案</a><ul>
                        
                <li>
                    <a href="#%e5%a4%9a%e5%b0%91%e4%b8%aa%e5%88%86%e5%8c%ba%e4%bb%a5%e5%8f%8a%e5%a4%9a%e5%a4%a7" aria-label="多少个分区以及多大？">多少个分区以及多大？</a></li>
                <li>
                    <a href="#%e9%82%a3%e4%b9%88swap%e7%a9%ba%e9%97%b4%e5%91%a2" aria-label="那么swap空间呢？">那么swap空间呢？</a></li>
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af-efi-%e7%b3%bb%e7%bb%9f%e5%88%86%e5%8c%ba-esp" aria-label="什么是 EFI 系统分区 (ESP)？">什么是 EFI 系统分区 (ESP)？</a></li>
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%afbios%e5%bc%95%e5%af%bc%e5%88%86%e5%8c%ba" aria-label="什么是BIOS引导分区？">什么是BIOS引导分区？</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-gpt-for-uefi-%e5%af%b9%e7%a3%81%e7%9b%98%e8%bf%9b%e8%a1%8c%e5%88%86%e5%8c%ba" aria-label="使用 GPT for UEFI 对磁盘进行分区">使用 GPT for UEFI 对磁盘进行分区</a><ul>
                        
                <li>
                    <a href="#%e6%9f%a5%e7%9c%8b%e5%bd%93%e5%89%8d%e5%88%86%e5%8c%ba%e5%b8%83%e5%b1%80" aria-label="查看当前分区布局">查看当前分区布局</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa%e6%96%b0%e7%9a%84%e7%a3%81%e7%9b%98%e6%a0%87%e7%ad%be%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e5%88%86%e5%8c%ba" aria-label="创建一个新的磁盘标签/删除所有分区">创建一个新的磁盘标签/删除所有分区</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba-efi-%e7%b3%bb%e7%bb%9f%e5%88%86%e5%8c%ba-esp" aria-label="创建 EFI 系统分区 (ESP)">创建 EFI 系统分区 (ESP)</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%baswap%e5%88%86%e5%8c%ba" aria-label="创建swap分区">创建swap分区</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e6%a0%b9%e5%88%86%e5%8c%ba" aria-label="创建根分区">创建根分区</a></li>
                <li>
                    <a href="#%e4%bf%9d%e5%ad%98%e5%88%86%e5%8c%ba%e5%b8%83%e5%b1%80" aria-label="保存分区布局">保存分区布局</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-mbr-%e5%af%b9%e7%a3%81%e7%9b%98%e8%bf%9b%e8%a1%8c%e5%88%86%e5%8c%ba%e4%bb%a5%e7%94%a8%e4%ba%8e-bioslegacy-%e5%90%af%e5%8a%a8" aria-label="使用 MBR 对磁盘进行分区以用于 BIOS/legacy 启动">使用 MBR 对磁盘进行分区以用于 BIOS/legacy 启动</a><ul>
                        
                <li>
                    <a href="#%e6%9f%a5%e7%9c%8b%e5%bd%93%e5%89%8d%e5%88%86%e5%8c%ba%e5%b8%83%e5%b1%80-1" aria-label="查看当前分区布局">查看当前分区布局</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa%e6%96%b0%e7%9a%84%e7%a3%81%e7%9b%98%e6%a0%87%e7%ad%be%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e5%88%86%e5%8c%ba-1" aria-label="创建一个新的磁盘标签/删除所有分区">创建一个新的磁盘标签/删除所有分区</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%bc%95%e5%af%bc%e5%88%86%e5%8c%ba" aria-label="创建引导分区">创建引导分区</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba-swap-%e5%88%86%e5%8c%ba" aria-label="创建 swap 分区">创建 swap 分区</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e6%a0%b9%e5%88%86%e5%8c%ba-1" aria-label="创建根分区">创建根分区</a></li>
                <li>
                    <a href="#%e4%bf%9d%e5%ad%98%e5%88%86%e5%8c%ba%e5%b8%83%e5%b1%80-1" aria-label="保存分区布局">保存分区布局</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" aria-label="创建文件系统">创建文件系统</a><ul>
                        
                <li>
                    <a href="#%e4%bb%8b%e7%bb%8d" aria-label="介绍">介绍</a></li>
                <li>
                    <a href="#%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" aria-label="文件系统">文件系统</a></li>
                <li>
                    <a href="#%e4%b8%ba%e5%88%86%e5%8c%ba%e5%ba%94%e7%94%a8%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" aria-label="为分区应用文件系统">为分区应用文件系统</a></li>
                <li>
                    <a href="#%e6%bf%80%e6%b4%bbswap%e5%88%86%e5%8c%ba" aria-label="激活swap分区">激活swap分区</a></li>
                <li>
                    <a href="#%e5%8f%af%e9%80%89%e4%bd%bf%e7%94%a8-swapfile" aria-label="可选：使用 swapfile">可选：使用 swapfile</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%8c%82%e8%bd%bd-root-%e5%88%86%e5%8c%ba" aria-label="挂载 root 分区">挂载 root 分区</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85gentoo%e5%ae%89%e8%a3%85%e6%96%87%e4%bb%b6httpswikigentooorgwikihandbookamd64installationstage" aria-label="安装Gentoo安装文件"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Stage">安装Gentoo安装文件</a></a><ul>
                        
                <li>
                    <a href="#%e5%ae%89%e8%a3%85stage%e5%8c%85" aria-label="安装stage包">安装stage包</a><ul>
                        
                <li>
                    <a href="#%e8%ae%be%e7%bd%ae%e6%97%a5%e6%9c%9f%e5%92%8c%e6%97%b6%e9%97%b4" aria-label="设置日期和时间">设置日期和时间</a></li>
                <li>
                    <a href="#%e9%80%89%e6%8b%a9%e4%b8%80%e4%b8%aastage%e5%8c%85" aria-label="选择一个stage包">选择一个stage包</a></li>
                <li>
                    <a href="#%e4%b8%8b%e8%bd%bdstage%e5%8e%8b%e7%bc%a9%e5%8c%85" aria-label="下载stage压缩包">下载stage压缩包</a></li>
                <li>
                    <a href="#%e8%a7%a3%e5%8e%8bstage%e5%8e%8b%e7%bc%a9%e5%8c%85" aria-label="解压stage压缩包">解压stage压缩包</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e7%bc%96%e8%af%91%e9%80%89%e9%a1%b9" aria-label="配置编译选项">配置编译选项</a><ul>
                        
                <li>
                    <a href="#%e4%bb%8b%e7%bb%8d-1" aria-label="介绍">介绍</a></li>
                <li>
                    <a href="#cflags-%e5%92%8c-cxxflags" aria-label="CFLAGS 和 CXXFLAGS">CFLAGS 和 CXXFLAGS</a></li>
                <li>
                    <a href="#makeoptshttpswikigentooorgwikimakeopts" aria-label="MAKEOPTS"><a href="https://wiki.gentoo.org/wiki/MAKEOPTS">MAKEOPTS</a></a></li>
                <li>
                    <a href="#makeconf-templatehttpszhuanlanzhihucomp166652475" aria-label="make.conf template"><a href="https://zhuanlan.zhihu.com/p/166652475">make.conf template</a></a></li>
                <li>
                    <a href="#%e5%b0%b1%e4%bd%8d%e9%a2%84%e5%a4%87%e5%87%ba%e5%8f%91-" aria-label="就位，预备，出发 ！">就位，预备，出发 ！</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85gentoo%e5%9f%ba%e7%a1%80%e7%b3%bb%e7%bb%9fhttpswikigentooorgwikihandbookamd64installationbase" aria-label="安装Gentoo基础系统"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Base">安装Gentoo基础系统</a></a><ul>
                        
                <li>
                    <a href="#chrooting" aria-label="Chrooting">Chrooting</a><ul>
                        
                <li>
                    <a href="#%e5%8f%af%e9%80%89%e9%80%89%e6%8b%a9%e9%95%9c%e5%83%8f%e7%ab%99%e7%82%b9" aria-label="可选：选择镜像站点">可选：选择镜像站点</a></li>
                <li>
                    <a href="#%e5%a4%8d%e5%88%b6dns%e4%bf%a1%e6%81%af" aria-label="复制DNS信息">复制DNS信息</a></li>
                <li>
                    <a href="#%e6%8c%82%e8%bd%bd%e5%bf%85%e8%a6%81%e7%9a%84%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" aria-label="挂载必要的文件系统">挂载必要的文件系统</a></li>
                <li>
                    <a href="#%e8%bf%9b%e5%85%a5%e6%96%b0%e7%8e%af%e5%a2%83" aria-label="进入新环境">进入新环境</a></li>
                <li>
                    <a href="#%e6%8c%82%e8%bd%bd-boot-%e5%88%86%e5%8c%ba" aria-label="挂载 boot 分区">挂载 boot 分区</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aeportage" aria-label="配置Portage">配置Portage</a><ul>
                        
                <li>
                    <a href="#%e4%bb%8e%e7%bd%91%e7%ab%99%e5%ae%89%e8%a3%85-gentoo-ebuild-%e6%95%b0%e6%8d%ae%e5%ba%93%e5%bf%ab%e7%85%a7" aria-label="从网站安装 Gentoo ebuild 数据库快照">从网站安装 Gentoo ebuild 数据库快照</a></li>
                <li>
                    <a href="#%e5%8f%af%e9%80%89%e6%9b%b4%e6%96%b0portage-ebuild-%e6%95%b0%e6%8d%ae%e5%ba%93" aria-label="可选：更新Portage ebuild 数据库">可选：更新Portage ebuild 数据库</a></li>
                <li>
                    <a href="#%e9%98%85%e8%af%bb%e6%96%b0%e9%97%bb%e6%9d%a1%e7%9b%ae" aria-label="阅读新闻条目">阅读新闻条目</a></li>
                <li>
                    <a href="#%e9%80%89%e6%8b%a9%e6%ad%a3%e7%a1%ae%e7%9a%84%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="选择正确的配置文件">选择正确的配置文件</a></li>
                <li>
                    <a href="#%e6%8e%a8%e8%8d%90%e5%ae%89%e8%a3%85%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%8c%85httpswikigentooorgwikibinary_package_guidezh-cn" aria-label="推荐：安装二进制包"><a href="https://wiki.gentoo.org/wiki/Binary_package_guide/zh-cn">推荐：安装二进制包</a></a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aeuse%e5%8f%98%e9%87%8f" aria-label="配置USE变量">配置USE变量</a></li>
                <li>
                    <a href="#%e6%8e%a8%e8%8d%90-%e9%85%8d%e7%bd%ae-accept_license-%e5%8f%98%e9%87%8f" aria-label="推荐： 配置 ACCEPT_LICENSE 变量">推荐： 配置 ACCEPT_LICENSE 变量</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0world%e9%9b%86%e5%90%88" aria-label="更新@world集合">更新@world集合</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8f%af%e9%80%89%e4%bd%bf%e7%94%a8-openrc-%e4%bd%9c%e4%b8%ba-init-%e7%b3%bb%e7%bb%9f" aria-label="可选：使用 OpenRC 作为 init 系统">可选：使用 OpenRC 作为 init 系统</a></li>
                <li>
                    <a href="#%e6%97%b6%e5%8c%ba" aria-label="时区">时区</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae-locale" aria-label="配置 locale">配置 locale</a><ul>
                        
                <li>
                    <a href="#locale-%e7%94%9f%e6%88%90" aria-label="Locale 生成">Locale 生成</a></li>
                <li>
                    <a href="#locale-%e9%80%89%e6%8b%a9" aria-label="Locale 选择">Locale 选择</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aelinux%e5%86%85%e6%a0%b8httpswikigentooorgwikihandbookamd64installationkernel" aria-label="配置Linux内核"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Kernel">配置Linux内核</a></a><ul>
                        
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e6%ba%90%e7%a0%81" aria-label="安装源码">安装源码</a></li>
                <li>
                    <a href="#%e9%bb%98%e8%ae%a4%e6%89%8b%e5%8a%a8%e9%85%8d%e7%bd%ae" aria-label="默认：手动配置">默认：手动配置</a><ul>
                        
                <li>
                    <a href="#%e4%bb%8b%e7%bb%8d-2" aria-label="介绍">介绍</a></li>
                <li>
                    <a href="#%e6%bf%80%e6%b4%bb%e5%bf%85%e8%a6%81%e7%9a%84%e9%80%89%e9%a1%b9" aria-label="激活必要的选项">激活必要的选项</a></li>
                <li>
                    <a href="#%e6%9e%b6%e6%9e%84%e7%89%b9%e6%9c%89%e7%9a%84%e5%86%85%e6%a0%b8%e9%85%8d%e7%bd%ae" aria-label="架构特有的内核配置">架构特有的内核配置</a></li>
                <li>
                    <a href="#%e7%bc%96%e8%af%91%e5%92%8c%e5%ae%89%e8%a3%85" aria-label="编译和安装">编译和安装</a></li>
                <li>
                    <a href="#%e5%8f%af%e9%80%89%e7%94%9f%e6%88%90%e4%b8%80%e4%b8%aainitramfs" aria-label="可选：生成一个initramfs">可选：生成一个initramfs</a></li>
                <li>
                    <a href="#%e5%a4%87%e9%80%89localmodconfig" aria-label="备选：localmodconfig">备选：localmodconfig</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%a4%87%e9%80%89%e4%bd%bf%e7%94%a8genkernel" aria-label="备选：使用genkernel">备选：使用genkernel</a></li>
                <li>
                    <a href="#%e6%8e%a8%e8%8d%90%e4%ba%8c%e8%bf%9b%e5%88%b6" aria-label="推荐：二进制">推荐：二进制</a></li>
                <li>
                    <a href="#%e5%86%85%e6%a0%b8%e6%a8%a1%e5%9d%97" aria-label="内核模块">内核模块</a><ul>
                        
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e6%a8%a1%e5%9d%97" aria-label="配置模块">配置模块</a></li>
                <li>
                    <a href="#%e6%8e%a8%e8%8d%90%e5%ae%89%e8%a3%85%e5%9b%ba%e4%bb%b6" aria-label="推荐：安装固件">推荐：安装固件</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e7%b3%bb%e7%bb%9fhttpswikigentooorgwikihandbookamd64installationsystem" aria-label="配置系统"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/System">配置系统</a></a><ul>
                        
                <li>
                    <a href="#%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e4%bf%a1%e6%81%af" aria-label="文件系统信息">文件系统信息</a><ul>
                        
                <li>
                    <a href="#%e5%85%b3%e4%ba%8e-fstab" aria-label="关于 fstab">关于 fstab</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%baetcfstab%e6%96%87%e4%bb%b6" aria-label="创建/etc/fstab文件">创建/etc/fstab文件</a></li>
                <li>
                    <a href="#%e6%8e%a8%e8%8d%90genfstab" aria-label="推荐：genfstab">推荐：genfstab</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bd%91%e7%bb%9c%e4%bf%a1%e6%81%af" aria-label="网络信息">网络信息</a><ul>
                        
                <li>
                    <a href="#%e4%b8%bb%e6%9c%ba%e5%90%8d" aria-label="主机名">主机名</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e7%bd%91%e7%bb%9c" aria-label="配置网络">配置网络</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-systemd-networkd" aria-label="使用 systemd-networkd">使用 systemd-networkd</a></li>
                <li>
                    <a href="#%e6%8e%a8%e8%8d%90%e4%bd%bf%e7%94%a8-networkmanager" aria-label="推荐：使用 NetworkManager">推荐：使用 NetworkManager</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#the-hosts-file" aria-label="The hosts file">The hosts file</a></li>
                <li>
                    <a href="#root-%e5%af%86%e7%a0%81" aria-label="Root 密码">Root 密码</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e7%b3%bb%e7%bb%9f%e5%b7%a5%e5%85%b7httpswikigentooorgwikihandbookamd64installationtools" aria-label="安装系统工具"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Tools">安装系统工具</a></a><ul>
                        
                <li>
                    <a href="#%e7%b3%bb%e7%bb%9f%e6%97%a5%e5%bf%97%e5%b7%a5%e5%85%b7" aria-label="系统日志工具">系统日志工具</a></li>
                <li>
                    <a href="#%e5%8f%af%e9%80%89cron%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b" aria-label="可选：Cron守护进程">可选：Cron守护进程</a></li>
                <li>
                    <a href="#%e5%8f%af%e9%80%89%e6%96%87%e4%bb%b6%e7%b4%a2%e5%bc%95" aria-label="可选：文件索引">可选：文件索引</a></li>
                <li>
                    <a href="#%e5%8f%af%e9%80%89%e8%bf%9c%e7%a8%8b%e8%ae%bf%e9%97%ae" aria-label="可选：远程访问">可选：远程访问</a></li>
                <li>
                    <a href="#%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e5%b7%a5%e5%85%b7" aria-label="文件系统工具">文件系统工具</a></li>
                <li>
                    <a href="#%e7%bd%91%e7%bb%9c%e5%b7%a5%e5%85%b7" aria-label="网络工具">网络工具</a><ul>
                        
                <li>
                    <a href="#%e5%ae%89%e8%a3%85dhcp%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="安装DHCP客户端">安装DHCP客户端</a></li>
                <li>
                    <a href="#%e5%8f%af%e9%80%89%e5%ae%89%e8%a3%85pppoe%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="可选：安装PPPoE客户端">可选：安装PPPoE客户端</a></li>
                <li>
                    <a href="#%e6%8e%a8%e8%8d%90%e5%ae%89%e8%a3%85%e6%97%a0%e7%ba%bf%e7%bd%91%e7%bb%9c%e5%b7%a5%e5%85%b7" aria-label="推荐：安装无线网络工具">推荐：安装无线网络工具</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e5%bc%95%e5%af%bc%e5%8a%a0%e8%bd%bd%e7%a8%8b%e5%ba%8fhttpswikigentooorgwikihandbookamd64installationbootloader" aria-label="配置引导加载程序"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Bootloader">配置引导加载程序</a></a><ul>
                        
                <li>
                    <a href="#%e9%80%89%e6%8b%a9%e5%bc%95%e5%af%bc%e5%99%a8" aria-label="选择引导器">选择引导器</a></li>
                <li>
                    <a href="#%e9%bb%98%e8%ae%a4grub2" aria-label="默认：GRUB2">默认：GRUB2</a><ul>
                        
                <li>
                    <a href="#emerge" aria-label="Emerge">Emerge</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85" aria-label="安装">安装</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae" aria-label="配置">配置</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e6%95%91%e6%80%a5%e6%8e%a7%e5%88%b6%e5%8f%b0httpswikiarchlinuxorgtitlegrub_e7ae80e4bd93e4b8ade69687e4bdbfe794a8e69591e680a5e68ea7e588b6e58fb0" aria-label="使用救急控制台"><a href="https://wiki.archlinux.org/title/GRUB_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E4%BD%BF%E7%94%A8%E6%95%91%E6%80%A5%E6%8E%A7%E5%88%B6%E5%8F%B0">使用救急控制台</a></a></li>
                <li>
                    <a href="#%e5%8f%af%e9%80%89%e5%90%af%e7%94%a8%e4%bc%91%e7%9c%a0%e5%94%a4%e9%86%92httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle9858de7bdae" aria-label="可选：启用休眠唤醒"><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E9%85%8D%E7%BD%AE">可选：启用休眠唤醒</a></a></li>
                <li>
                    <a href="#%e5%8f%af%e9%80%89%e5%a4%9a%e7%b3%bb%e7%bb%9f" aria-label="可选：多系统">可选：多系统</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%a4%87%e9%80%891lilo" aria-label="备选1：LILO">备选1：LILO</a><ul>
                        
                <li>
                    <a href="#emerge-1" aria-label="Emerge">Emerge</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae-1" aria-label="配置">配置</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85-1" aria-label="安装">安装</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%a4%87%e9%80%892efibootmgr" aria-label="备选2：efibootmgr">备选2：efibootmgr</a></li>
                <li>
                    <a href="#%e5%a4%87%e9%80%893-syslinux" aria-label="备选3: Syslinux">备选3: Syslinux</a></li>
                <li>
                    <a href="#%e5%a4%87%e9%80%894systemd-boothttpswikigentooorgwikisystemd-boot" aria-label="备选4：systemd-boot"><a href="https://wiki.gentoo.org/wiki/Systemd-boot">备选4：systemd-boot</a></a><ul>
                        
                <li>
                    <a href="#uefi-boot-manager" aria-label="UEFI boot manager">UEFI boot manager</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%87%8d%e5%90%af%e7%b3%bb%e7%bb%9f" aria-label="重启系统">重启系统</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%94%b6%e5%b0%be%e5%ae%89%e8%a3%85%e5%b7%a5%e4%bd%9c" aria-label="收尾安装工作">收尾安装工作</a><ul>
                        
                <li>
                    <a href="#%e7%94%a8%e6%88%b7%e7%ae%a1%e7%90%86" aria-label="用户管理">用户管理</a><ul>
                        
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0%e4%b8%80%e4%b8%aa%e6%97%a5%e5%b8%b8%e4%bd%bf%e7%94%a8%e7%9a%84%e7%94%a8%e6%88%b7" aria-label="添加一个日常使用的用户">添加一个日常使用的用户</a></li>
                <li>
                    <a href="#sudohttpswikigentooorgwikisudo" aria-label="sudo"><a href="https://wiki.gentoo.org/wiki/Sudo">sudo</a></a></li></ul>
                </li>
                <li>
                    <a href="#%e7%a3%81%e7%9b%98%e6%b8%85%e7%90%86" aria-label="磁盘清理">磁盘清理</a><ul>
                        
                <li>
                    <a href="#%e5%88%a0%e9%99%a4tar%e5%8c%85" aria-label="删除tar包">删除tar包</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%8b%e4%b8%80%e6%ad%a5%e8%af%a5%e5%81%9a%e4%bb%80%e4%b9%88" aria-label="下一步该做什么？">下一步该做什么？</a><ul>
                        
                <li>
                    <a href="#%e6%96%87%e6%a1%a3" aria-label="文档">文档</a></li>
                <li>
                    <a href="#gentoo-%e5%9c%a8%e7%ba%bf" aria-label="Gentoo 在线">Gentoo 在线</a></li>
                <li>
                    <a href="#%e7%bb%93%e8%af%ad" aria-label="结语">结语</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#portage%e4%bb%8b%e7%bb%8d" aria-label="Portage介绍">Portage介绍</a><ul>
                        
                <li>
                    <a href="#%e6%ac%a2%e8%bf%8e%e4%bd%bf%e7%94%a8-portage" aria-label="欢迎使用 Portage">欢迎使用 Portage</a></li>
                <li>
                    <a href="#gentoo-%e8%bd%af%e4%bb%b6%e4%bb%93%e5%ba%93" aria-label="Gentoo 软件仓库">Gentoo 软件仓库</a><ul>
                        
                <li>
                    <a href="#ebuild" aria-label="Ebuild">Ebuild</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0-gentoo-%e8%bd%af%e4%bb%b6%e4%bb%93%e5%ba%93" aria-label="更新 Gentoo 软件仓库">更新 Gentoo 软件仓库</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bb%b4%e6%8a%a4%e8%bd%af%e4%bb%b6" aria-label="维护软件">维护软件</a><ul>
                        
                <li>
                    <a href="#%e6%90%9c%e7%b4%a2%e8%bd%af%e4%bb%b6" aria-label="搜索软件">搜索软件</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e8%bd%af%e4%bb%b6" aria-label="安装软件">安装软件</a></li>
                <li>
                    <a href="#%e6%9f%a5%e6%89%be%e5%b7%b2%e5%ae%89%e8%a3%85%e8%bd%af%e4%bb%b6%e7%9a%84%e6%96%87%e6%a1%a3" aria-label="查找已安装软件的文档">查找已安装软件的文档</a></li>
                <li>
                    <a href="#%e5%8d%b8%e8%bd%bd%e8%bd%af%e4%bb%b6" aria-label="卸载软件">卸载软件</a></li>
                <li>
                    <a href="#%e9%bb%98%e8%ae%a4%e9%80%89%e9%a1%b9" aria-label="默认选项">默认选项</a></li>
                <li>
                    <a href="#understanding-portages-formatted-and-colored-outputhttpwikigentooksiezycplhowto_use_portage_correctlyhtm" aria-label="Understanding Portage&amp;rsquo;s Formatted and Colored Output"><strong><a href="http://wikigentoo.ksiezyc.pl/HOWTO_Use_Portage_Correctly.htm">Understanding Portage&rsquo;s Formatted and Colored Output</a></strong></a></li></ul>
                </li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0%e7%b3%bb%e7%bb%9f" aria-label="更新系统">更新系统</a><ul>
                        
                <li>
                    <a href="#%e5%85%b3%e4%ba%8e%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e7%9a%84%e6%9b%b4%e6%96%b0" aria-label="关于配置文件的更新">关于配置文件的更新</a></li>
                <li>
                    <a href="#%e6%94%b9%e5%8f%98%e6%a1%8c%e9%9d%a2%e7%8e%af%e5%a2%83httpslitterhougelangleylifeblog20210609gentoo-maintain-02-change-profile" aria-label="改变桌面环境/ Change Profile"><a href="https://litterhougelangley.life/blog/2021/06/09/gentoo-maintain-02/">改变桌面环境</a>/ Change Profile</a></li></ul>
                </li>
                <li>
                    <a href="#licenses" aria-label="Licenses">Licenses</a></li>
                <li>
                    <a href="#masking--unmasking-packages" aria-label="Masking &amp;amp; Unmasking packages">Masking &amp; Unmasking packages</a><ul>
                        
                <li>
                    <a href="#%e5%b1%8f%e8%94%bd%e7%89%b9%e5%ae%9a%e7%9a%84%e5%8c%85%e7%89%88%e6%9c%ac" aria-label="屏蔽特定的包版本">屏蔽特定的包版本</a></li>
                <li>
                    <a href="#%e4%bb%8e-ebuild-%e5%ad%98%e5%82%a8%e5%ba%93%e4%b8%ad%e5%b1%8f%e8%94%bd%e5%8c%85" aria-label="从 ebuild 存储库中屏蔽包">从 ebuild 存储库中屏蔽包</a></li></ul>
                </li>
                <li>
                    <a href="#accept_keywordshttpswikigentooorgwikiaccept_keywordszh-cn" aria-label="ACCEPT_KEYWORDS"><a href="https://wiki.gentoo.org/wiki/ACCEPT_KEYWORDS/zh-cn">ACCEPT_KEYWORDS</a></a><ul>
                        
                <li>
                    <a href="#%e5%8f%98%e9%87%8f%e5%9c%a8%e5%93%aa%e9%87%8c%e8%ae%be%e7%bd%ae" aria-label="变量在哪里设置？">变量在哪里设置？</a></li>
                <li>
                    <a href="#%e7%a8%b3%e5%ae%9a%e4%b8%8e%e4%b8%8d%e7%a8%b3%e5%ae%9a%e7%9a%84-keywords" aria-label="稳定与不稳定的 keywords">稳定与不稳定的 keywords</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bd%93portage%e6%8a%a5%e9%94%99%e7%9a%84%e6%97%b6%e5%80%99" aria-label="当Portage报错的时候">当Portage报错的时候</a><ul>
                        
                <li>
                    <a href="#%e7%ae%80%e4%bb%8b" aria-label="简介">简介</a></li>
                <li>
                    <a href="#%e8%a2%ab%e9%98%bb%e6%8c%a1%e7%9a%84%e5%8c%85" aria-label="被阻挡的包">被阻挡的包</a></li>
                <li>
                    <a href="#%e8%a2%ab%e5%b1%8f%e8%94%bd%e7%9a%84%e5%8c%85" aria-label="被屏蔽的包">被屏蔽的包</a></li>
                <li>
                    <a href="#use%e5%bf%85%e8%a6%81%e7%9a%84%e6%9b%b4%e6%94%b9" aria-label="USE必要的更改">USE必要的更改</a></li>
                <li>
                    <a href="#%e7%bc%ba%e5%a4%b1%e4%be%9d%e8%b5%96" aria-label="缺失依赖">缺失依赖</a></li>
                <li>
                    <a href="#%e6%84%8f%e6%8c%87%e4%b8%8d%e6%98%8e%e7%9a%84%e8%bd%af%e4%bb%b6%e5%8c%85" aria-label="意指不明的软件包">意指不明的软件包</a></li>
                <li>
                    <a href="#%e5%be%aa%e7%8e%af%e4%be%9d%e8%b5%96" aria-label="循环依赖">循环依赖</a></li>
                <li>
                    <a href="#%e4%b8%8b%e8%bd%bd%e5%a4%b1%e8%b4%a5" aria-label="下载失败">下载失败</a></li>
                <li>
                    <a href="#%e7%b3%bb%e7%bb%9fprofile%e4%bf%9d%e6%8a%a4" aria-label="系统Profile保护">系统Profile保护</a></li>
                <li>
                    <a href="#digest%e9%aa%8c%e8%af%81%e5%a4%b1%e8%b4%a5" aria-label="Digest验证失败">Digest验证失败</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e5%b7%a5%e5%85%b7" aria-label="其他工具">其他工具</a><ul>
                        
                <li>
                    <a href="#app-portageeixhttpspackagesgentooorgpackagesapp-portageeix" aria-label="app-portage/eix"><a href="https://packages.gentoo.org/packages/app-portage/eix">app-portage/eix</a></a></li>
                <li>
                    <a href="#app-portagegentoolkithttpspackagesgentooorgpackagesapp-portagegentoolkit" aria-label="app-portage/gentoolkit"><a href="https://packages.gentoo.org/packages/app-portage/gentoolkit">app-portage/gentoolkit</a></a><ul>
                        
                <li>
                    <a href="#ecleanhttpswikigentooorgwikiecleanzh-cn" aria-label="eclean"><a href="https://wiki.gentoo.org/wiki/Eclean/zh-cn">eclean</a></a></li></ul>
                </li>
                <li>
                    <a href="#app-portageportage-utilshttpspackagesgentooorgpackagesapp-portageportage-utils" aria-label="app-portage/portage-utils"><a href="https://packages.gentoo.org/packages/app-portage/portage-utils">app-portage/portage-utils</a></a></li>
                <li>
                    <a href="#app-portagepflhttpspackagesgentooorgpackagesapp-portagepfl" aria-label="app-portage/pfl"><a href="https://packages.gentoo.org/packages/app-portage/pfl">app-portage/pfl</a></a></li>
                <li>
                    <a href="#%e5%a4%9a%e7%89%88%e6%9c%ac%e7%ae%a1%e7%90%86" aria-label="多版本管理">多版本管理</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#use%e6%a0%87%e8%ae%b0" aria-label="USE标记">USE标记</a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%afuse%e6%a0%87%e5%bf%97" aria-label="什么是USE标志">什么是USE标志</a><ul>
                        
                <li>
                    <a href="#use%e6%a0%87%e5%bf%97%e7%9a%84%e6%8c%87%e5%af%bc%e6%80%9d%e6%83%b3" aria-label="USE标志的指导思想">USE标志的指导思想</a></li>
                <li>
                    <a href="#use%e6%a0%87%e5%bf%97%e7%9a%84%e8%ae%be%e5%ae%9a" aria-label="USE标志的设定">USE标志的设定</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8use%e6%a0%87%e5%bf%97" aria-label="使用USE标志">使用USE标志</a><ul>
                        
                <li>
                    <a href="#%e5%a3%b0%e6%98%8e%e6%b0%b8%e4%b9%85use%e6%a0%87%e5%bf%97" aria-label="声明永久USE标志">声明永久USE标志</a></li>
                <li>
                    <a href="#%e4%b8%ba%e5%8d%95%e4%b8%aa%e5%8c%85%e5%a3%b0%e6%98%8euse%e6%a0%87%e5%bf%97" aria-label="为单个包声明USE标志">为单个包声明USE标志</a></li>
                <li>
                    <a href="#%e5%a3%b0%e6%98%8e%e4%b8%b4%e6%97%b6use%e6%a0%87%e5%bf%97" aria-label="声明临时USE标志">声明临时USE标志</a></li>
                <li>
                    <a href="#%e4%bc%98%e5%85%88%e7%ba%a7" aria-label="优先级">优先级</a></li>
                <li>
                    <a href="#%e5%9c%a8%e6%95%b4%e4%b8%aa%e7%b3%bb%e7%bb%9f%e4%b8%8a%e5%ba%94%e7%94%a8%e6%96%b0%e7%9a%84use%e6%a0%87%e5%bf%97" aria-label="在整个系统上应用新的USE标志">在整个系统上应用新的USE标志</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%bd%af%e4%bb%b6%e5%8c%85%e7%89%b9%e6%9c%89%e7%9a%84use%e6%a0%87%e5%bf%97" aria-label="软件包特有的USE标志">软件包特有的USE标志</a></li>
                <li>
                    <a href="#%e6%bb%a1%e8%b6%b3-required_use" aria-label="满足 REQUIRED_USE">满足 REQUIRED_USE</a></li></ul>
                </li>
                <li>
                    <a href="#portage%e5%8a%9f%e8%83%bd%e7%89%b9%e6%80%a7" aria-label="Portage功能特性">Portage功能特性</a><ul>
                        
                <li>
                    <a href="#portage%e7%89%b9%e6%80%a7" aria-label="Portage特性">Portage特性</a></li>
                <li>
                    <a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%bc%96%e8%af%91" aria-label="分布式编译">分布式编译</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8distcc" aria-label="使用distcc">使用distcc</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85-distcc" aria-label="安装 distcc">安装 distcc</a></li>
                <li>
                    <a href="#%e6%bf%80%e6%b4%bbportage%e7%9a%84distcc%e6%94%af%e6%8c%81" aria-label="激活Portage的distcc支持">激活Portage的distcc支持</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bc%93%e5%86%b2%e7%bc%96%e8%af%91%e7%bb%93%e6%9e%9c" aria-label="缓冲编译结果">缓冲编译结果</a><ul>
                        
                <li>
                    <a href="#%e5%85%b3%e4%ba%8eccache" aria-label="关于ccache">关于ccache</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85-ccache" aria-label="安装 ccache">安装 ccache</a></li>
                <li>
                    <a href="#%e6%bf%80%e6%b4%bbportage-ccache-%e6%94%af%e6%8c%81" aria-label="激活Portage ccache 支持">激活Portage ccache 支持</a></li>
                <li>
                    <a href="#%e9%9d%9eportage%e7%bc%96%e8%af%91%e4%b8%ad%e4%bd%bf%e7%94%a8ccache" aria-label="非Portage编译中使用ccache">非Portage编译中使用ccache</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%8c%85%e6%94%af%e6%8c%81" aria-label="二进制包支持">二进制包支持</a><ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e9%a2%84%e7%bc%96%e8%af%91%e5%8c%85" aria-label="创建预编译包">创建预编译包</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e9%a2%84%e7%bc%96%e8%af%91%e5%8c%85" aria-label="安装预编译包">安装预编译包</a></li>
                <li>
                    <a href="#%e5%b0%86%e9%a2%84%e6%9e%84%e5%bb%ba%e7%9a%84%e8%bd%af%e4%bb%b6%e5%8c%85%e5%88%86%e5%8f%91%e7%bb%99%e4%bb%96%e4%ba%ba" aria-label="将预构建的软件包分发给他人">将预构建的软件包分发给他人</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%8b%e8%bd%bd%e6%96%87%e4%bb%b6" aria-label="下载文件">下载文件</a><ul>
                        
                <li>
                    <a href="#%e5%b9%b6%e8%a1%8c%e4%b8%8b%e8%bd%bd" aria-label="并行下载">并行下载</a></li>
                <li>
                    <a href="#%e9%aa%8c%e8%af%81%e6%ba%90%e6%96%87%e4%bb%b6" aria-label="验证源文件">验证源文件</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" aria-label="环境变量">环境变量</a><ul>
                        
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f-1" aria-label="环境变量">环境变量</a><ul>
                        
                <li>
                    <a href="#%e7%ae%80%e4%bb%8b-1" aria-label="简介">简介</a></li>
                <li>
                    <a href="#%e9%87%8d%e8%a6%81%e7%9a%84%e4%be%8b%e5%ad%90" aria-label="重要的例子">重要的例子</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f%e7%9a%84%e5%ae%9a%e4%b9%89" aria-label="全局变量的定义">全局变量的定义</a><ul>
                        
                <li>
                    <a href="#envd%e7%9b%ae%e5%bd%95" aria-label="env.d目录">env.d目录</a></li>
                <li>
                    <a href="#env-update" aria-label="env-update">env-update</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%9c%ac%e5%9c%b0%e5%8f%98%e9%87%8f%e7%9a%84%e5%ae%9a%e4%b9%89" aria-label="本地变量的定义">本地变量的定义</a><ul>
                        
                <li>
                    <a href="#%e7%89%b9%e5%ae%9a%e7%94%a8%e6%88%b7" aria-label="特定用户">特定用户</a></li>
                <li>
                    <a href="#%e7%89%b9%e5%ae%9a%e4%bc%9a%e8%af%9d" aria-label="特定会话">特定会话</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#ebuild-1" aria-label="ebuild">ebuild</a><ul>
                        
                <li>
                    <a href="#gentoo-development-guide-chinesehttpsblogsoymilkfungentoo-development-guide-chinese" aria-label="Gentoo Development Guide Chinese"><a href="https://blog.soymilk.fun/Gentoo-Development-Guide-Chinese/">Gentoo Development Guide Chinese</a></a></li>
                <li>
                    <a href="#ebuild-%e7%bc%96%e5%86%99%e5%9f%ba%e6%9c%ac%e6%8c%87%e5%8d%97httpswikigentooorgwikibasic_guide_to_write_gentoo_ebuilds" aria-label="Ebuild 编写基本指南"><a href="https://wiki.gentoo.org/wiki/Basic_guide_to_write_Gentoo_Ebuilds">Ebuild 编写基本指南</a></a><ul>
                        
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa-ebuild" aria-label="如何创建一个 ebuild">如何创建一个 ebuild</a></li>
                <li>
                    <a href="#%e7%bb%99%e5%ae%9a%e6%ba%90%e5%8e%8b%e7%bc%a9%e5%8c%85%e7%a4%ba%e4%be%8b" aria-label="给定源压缩包示例">给定源压缩包示例</a></li>
                <li>
                    <a href="#%e6%89%93%e8%a1%a5%e4%b8%81" aria-label="打补丁">打补丁</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9d%e6%8e%a2-ebuildhttpssegmentfaultcoma1190000003819421" aria-label="初探 ebuild"><a href="https://segmentfault.com/a/1190000003819421">初探 ebuild</a></a><ul>
                        
                <li>
                    <a href="#ebuild-%e5%9c%a8%e5%93%aa%e9%87%8c" aria-label="ebuild 在哪里？">ebuild 在哪里？</a></li>
                <li>
                    <a href="#%e5%bb%ba%e7%ab%8b%e8%87%aa%e5%b7%b1%e7%9a%84-overlay" aria-label="建立自己的 Overlay">建立自己的 Overlay</a></li>
                <li>
                    <a href="#hello-world" aria-label="Hello World!">Hello World!</a></li>
                <li>
                    <a href="#emerge-%e4%b8%8e-ebuild-%e6%9c%89%e4%bb%80%e4%b9%88%e8%81%94%e7%b3%bb" aria-label="emerge 与 ebuild 有什么联系？">emerge 与 ebuild 有什么联系？</a></li></ul>
                </li>
                <li>
                    <a href="#slothttpswikitankywoocomlinuxgentoohtmlslot" aria-label="SLOT"><a href="https://wiki.tankywoo.com/linux/gentoo.html#slot">SLOT</a></a><ul>
                        
                <li>
                    <a href="#%e7%9c%9f%e5%ae%9e%e7%9a%84-hello-world" aria-label="真实的 Hello World！">真实的 Hello World！</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#ebuild-repositoryhttpswikigentooorgwikiebuild_repository" aria-label="ebuild repository"><a href="https://wiki.gentoo.org/wiki/Ebuild_repository">ebuild repository</a></a><ul>
                        
                <li>
                    <a href="#the-gentoo-ebuild-repository" aria-label="The Gentoo ebuild repository">The Gentoo ebuild repository</a></li>
                <li>
                    <a href="#repositories-in-general" aria-label="Repositories in general">Repositories in general</a><ul>
                        
                <li>
                    <a href="#priorities" aria-label="Priorities">Priorities</a></li></ul>
                </li>
                <li>
                    <a href="#repository-synchronization" aria-label="Repository synchronization">Repository synchronization</a></li>
                <li>
                    <a href="#repository-management-tools" aria-label="Repository management tools">Repository management tools</a><ul>
                        
                <li>
                    <a href="#eselect-repository" aria-label="eselect-repository">eselect-repository</a></li>
                <li>
                    <a href="#layman" aria-label="Layman">Layman</a></li></ul>
                </li>
                <li>
                    <a href="#usage" aria-label="Usage">Usage</a><ul>
                        
                <li>
                    <a href="#emerging-a-duplicate-package" aria-label="Emerging a duplicate package">Emerging a duplicate package</a></li></ul>
                </li>
                <li>
                    <a href="#best-practices" aria-label="Best practices">Best practices</a><ul>
                        
                <li>
                    <a href="#cache-generation" aria-label="Cache generation">Cache generation</a></li>
                <li>
                    <a href="#masking-enabled-ebuild-repositories" aria-label="Masking enabled ebuild repositories">Masking enabled ebuild repositories</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#projectportagesynchttpswikigentooorgwikiprojectportagesync" aria-label="Project:Portage/Sync"><a href="https://wiki.gentoo.org/wiki/Project:Portage/Sync">Project:Portage/Sync</a></a><ul>
                        
                <li>
                    <a href="#general-help" aria-label="General help">General help</a><ul>
                        
                <li>
                    <a href="#migration" aria-label="Migration">Migration</a></li>
                <li>
                    <a href="#operation" aria-label="Operation">Operation</a></li>
                <li>
                    <a href="#examples" aria-label="Examples">Examples</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e6%98%be%e5%8d%a1%e9%a9%b1%e5%8a%a8httpslitterhougelangleylifeblog20210521gentoo" aria-label="显卡驱动"><a href="https://litterhougelangley.life/blog/2021/05/21/gentoo/">显卡驱动</a></a><ul>
                        
                <li>
                    <a href="#makeconf" aria-label="make.conf">make.conf</a></li>
                <li>
                    <a href="#%e9%a9%b1%e5%8a%a8" aria-label="驱动">驱动</a><ul>
                        
                <li>
                    <a href="#intel" aria-label="Intel">Intel</a></li>
                <li>
                    <a href="#nvidia" aria-label="nvidia">nvidia</a></li></ul>
                </li>
                <li>
                    <a href="#nvidiaoptimushttpswikigentooorgwikinvidiaoptimus" aria-label="NVIDIA/Optimus"><a href="https://wiki.gentoo.org/wiki/NVIDIA/Optimus">NVIDIA/Optimus</a></a><ul>
                        
                <li>
                    <a href="#xorgconf" aria-label="xorg.conf">xorg.conf</a></li>
                <li>
                    <a href="#gdm" aria-label="gdm">gdm</a></li>
                <li>
                    <a href="#sddm" aria-label="sddm">sddm</a></li>
                <li>
                    <a href="#%e6%97%a0%e6%98%be%e7%a4%ba%e7%ae%a1%e7%90%86%e5%99%a8httpszhuanlanzhihucomp174837792" aria-label="无显示管理器"><a href="https://zhuanlan.zhihu.com/p/174837792">无显示管理器</a></a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#kdehttpswikigentooorgwikikdezh-cn" aria-label="KDE"><a href="https://wiki.gentoo.org/wiki/KDE/zh-cn">KDE</a></a><ul>
                        
                <li>
                    <a href="#profile" aria-label="Profile">Profile</a></li>
                <li>
                    <a href="#plasma" aria-label="Plasma">Plasma</a><ul>
                        
                <li>
                    <a href="#%e5%ae%89%e8%a3%85-2" aria-label="安装">安装</a></li>
                <li>
                    <a href="#%e7%b3%bb%e7%bb%9f%e6%89%98%e7%9b%98" aria-label="系统托盘">系统托盘</a><ul>
                        
                <li>
                    <a href="#pidgin" aria-label="Pidgin">Pidgin</a></li></ul>
                </li>
                <li>
                    <a href="#kwallet" aria-label="KWallet">KWallet</a></li>
                <li>
                    <a href="#sshgpg-%e5%af%86%e9%92%a5%e5%90%af%e5%8a%a8%e5%85%b3%e9%97%ad%e8%84%9a%e6%9c%ac" aria-label="SSH/GPG 密钥启动/关闭脚本">SSH/GPG 密钥启动/关闭脚本</a><ul>
                        
                <li>
                    <a href="#using-keychain-with-plasma-5" aria-label="Using keychain with Plasma 5">Using keychain with Plasma 5</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8root%e6%9d%83%e9%99%90%e8%bf%90%e8%a1%8c-gui-%e5%ba%94%e7%94%a8" aria-label="使用root权限运行 GUI 应用">使用root权限运行 GUI 应用</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="应用程序">应用程序</a><ul>
                        
                <li>
                    <a href="#%e5%ae%89%e8%a3%85-3" aria-label="安装">安装</a></li>
                <li>
                    <a href="#%e6%9c%ac%e5%9c%b0%e5%8c%96" aria-label="本地化">本地化</a></li>
                <li>
                    <a href="#kde-pim" aria-label="KDE PIM">KDE PIM</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%a1%86%e6%9e%b6" aria-label="框架">框架</a></li>
                <li>
                    <a href="#%e6%9b%b4%e5%a4%9akde%e8%bd%af%e4%bb%b6" aria-label="更多KDE软件">更多KDE软件</a></li>
                <li>
                    <a href="#tips" aria-label="Tips">Tips</a><ul>
                        
                <li>
                    <a href="#how-to-reset-kde--display-settings-after-a-move-to-a-new-machinehttpsaskubuntucomquestions299241how-to-reset-kde-display-settings-after-a-move-to-a-new-machine" aria-label="How to reset KDE / display settings after a move to a new machine"><a href="https://askubuntu.com/questions/299241/how-to-reset-kde-display-settings-after-a-move-to-a-new-machine">How to reset KDE / display settings after a move to a new machine</a></a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#gnomehttpswikigentooorgwikignomeguide" aria-label="GNOME"><a href="https://wiki.gentoo.org/wiki/GNOME/Guide">GNOME</a></a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af-gnome" aria-label="什么是 GNOME?">什么是 GNOME?</a><ul>
                        
                <li>
                    <a href="#%e9%a1%b9%e7%9b%ae" aria-label="项目">项目</a></li>
                <li>
                    <a href="#%e8%bd%af%e4%bb%b6" aria-label="软件">软件</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%87%86%e5%a4%87" aria-label="准备">准备</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85-4" aria-label="安装">安装</a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%b8%80%e5%8d%b0%e8%b1%a1" aria-label="第一印象">第一印象</a><ul>
                        
                <li>
                    <a href="#%e5%90%af%e7%94%a8-gdm" aria-label="启用 GDM">启用 GDM</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-startx" aria-label="使用 startx">使用 startx</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%a7%bb%e9%99%a4" aria-label="移除">移除</a></li>
                <li>
                    <a href="#tips-1" aria-label="Tips">Tips</a><ul>
                        
                <li>
                    <a href="#how-can-i-reset-my-display-settings-through-terminalhttpsaskubuntucomquestions749333how-can-i-reset-my-display-settings-through-terminal" aria-label="How can I reset my display settings through terminal?"><a href="https://askubuntu.com/questions/749333/how-can-i-reset-my-display-settings-through-terminal">How can I reset my display settings through terminal?</a></a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#freebsd-handbook-zfshttpsdocsfreebsdorgzh-twbookshandbookzfs" aria-label="FreeBSD Handbook ZFS"><a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/">FreeBSD Handbook ZFS</a></a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e9%ba%bc%e4%bd%bf-zfs-%e8%88%87%e7%9c%be%e4%b8%8d%e5%90%8c" aria-label="什麼使 ZFS 與眾不同">什麼使 ZFS 與眾不同</a></li>
                <li>
                    <a href="#%e5%bf%ab%e9%80%9f%e5%85%a5%e9%96%80%e6%8c%87%e5%8d%97" aria-label="快速入門指南">快速入門指南</a><ul>
                        
                <li>
                    <a href="#%e5%96%ae%e7%a3%81%e7%a2%9f%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="單磁碟儲存池">單磁碟儲存池</a></li>
                <li>
                    <a href="#raid-z" aria-label="RAID-Z">RAID-Z</a></li>
                <li>
                    <a href="#%e5%be%a9%e5%8e%9f-raid-z" aria-label="復原 RAID-Z">復原 RAID-Z</a></li>
                <li>
                    <a href="#%e8%b3%87%e6%96%99%e6%aa%a2%e9%a9%97" aria-label="資料檢驗">資料檢驗</a></li></ul>
                </li>
                <li>
                    <a href="#zpool-%e7%ae%a1%e7%90%86" aria-label="zpool 管理"><code>zpool</code> 管理</a><ul>
                        
                <li>
                    <a href="#%e5%bb%ba%e7%ab%8b%e8%88%87%e6%91%a7%e6%af%80%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="建立與摧毀儲存池">建立與摧毀儲存池</a></li>
                <li>
                    <a href="#%e5%8a%a0%e5%85%a5%e8%88%87%e7%a7%bb%e9%99%a4%e8%a3%9d%e7%bd%ae" aria-label="加入與移除裝置">加入與移除裝置</a></li>
                <li>
                    <a href="#%e6%aa%a2%e6%9f%a5%e5%84%b2%e5%ad%98%e6%b1%a0%e7%8b%80%e6%85%8b" aria-label="檢查儲存池狀態">檢查儲存池狀態</a></li>
                <li>
                    <a href="#%e6%b8%85%e9%99%a4%e9%8c%af%e8%aa%a4" aria-label="清除錯誤">清除錯誤</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%8f%9b%e9%81%8b%e4%bd%9c%e4%b8%ad%e7%9a%84%e8%a3%9d%e7%bd%ae" aria-label="更換運作中的裝置">更換運作中的裝置</a></li>
                <li>
                    <a href="#%e8%99%95%e7%90%86%e6%95%85%e9%9a%9c%e8%a3%9d%e7%bd%ae" aria-label="處理故障裝置">處理故障裝置</a></li>
                <li>
                    <a href="#%e6%b8%85%e6%bd%94%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="清潔儲存池">清潔儲存池</a></li>
                <li>
                    <a href="#%e8%87%aa%e6%88%91%e4%bf%ae%e5%be%a9" aria-label="自我修復">自我修復</a></li>
                <li>
                    <a href="#%e6%93%b4%e5%a2%9e%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="擴增儲存池">擴增儲存池</a></li>
                <li>
                    <a href="#%e5%8c%af%e5%85%a5%e8%88%87%e5%8c%af%e5%87%ba%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="匯入與匯出儲存池">匯入與匯出儲存池</a></li>
                <li>
                    <a href="#%e5%8d%87%e7%b4%9a%e5%84%b2%e5%ad%98%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="升級儲存儲存池">升級儲存儲存池</a></li>
                <li>
                    <a href="#%e9%a1%af%e7%a4%ba%e5%b7%b2%e8%a8%98%e9%8c%84%e7%9a%84%e5%84%b2%e5%ad%98%e6%b1%a0%e6%ad%b7%e5%8f%b2%e6%97%a5%e8%aa%8c" aria-label="顯示已記錄的儲存池歷史日誌">顯示已記錄的儲存池歷史日誌</a></li>
                <li>
                    <a href="#%e7%9b%a3%e8%a6%96%e6%95%88%e8%83%bd" aria-label="監視效能">監視效能</a></li>
                <li>
                    <a href="#%e5%88%86%e5%89%b2%e5%84%b2%e5%ad%98%e5%84%b2%e5%ad%98%e6%b1%a0" aria-label="分割儲存儲存池">分割儲存儲存池</a></li></ul>
                </li>
                <li>
                    <a href="#zfs-%e7%ae%a1%e7%90%86" aria-label="zfs 管理"><code>zfs</code> 管理</a><ul>
                        
                <li>
                    <a href="#%e5%bb%ba%e7%ab%8b%e8%88%87%e6%91%a7%e6%af%80%e8%b3%87%e6%96%99%e9%9b%86" aria-label="建立與摧毀資料集">建立與摧毀資料集</a></li>
                <li>
                    <a href="#%e5%bb%ba%e7%ab%8b%e8%88%87%e6%91%a7%e6%af%80%e7%a3%81%e7%a2%9f%e5%8d%80" aria-label="建立與摧毀磁碟區">建立與摧毀磁碟區</a></li>
                <li>
                    <a href="#%e9%87%8d%e6%96%b0%e5%91%bd%e5%90%8d%e8%b3%87%e6%96%99%e9%9b%86" aria-label="重新命名資料集">重新命名資料集</a></li>
                <li>
                    <a href="#%e8%a8%ad%e5%ae%9a%e8%b3%87%e6%96%99%e9%9b%86%e5%b1%ac%e6%80%a7" aria-label="設定資料集屬性">設定資料集屬性</a><ul>
                        
                <li>
                    <a href="#%e5%8f%96%e5%be%97%e8%88%87%e8%a8%ad%e5%ae%9a%e5%85%b1%e4%ba%ab%e5%b1%ac%e6%80%a7" aria-label="取得與設定共享屬性">取得與設定共享屬性</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ae%a1%e7%90%86%e5%bf%ab%e7%85%a7-snapshot" aria-label="管理快照 (Snapshot)">管理快照 (Snapshot)</a><ul>
                        
                <li>
                    <a href="#%e5%bb%ba%e7%ab%8b%e5%bf%ab%e7%85%a7" aria-label="建立快照">建立快照</a></li>
                <li>
                    <a href="#%e6%af%94%e5%b0%8d%e5%bf%ab%e7%85%a7" aria-label="比對快照">比對快照</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e5%bf%ab%e7%85%a7%e9%82%84%e5%8e%9f" aria-label="使用快照還原">使用快照還原</a></li>
                <li>
                    <a href="#%e5%be%9e%e5%bf%ab%e7%85%a7%e9%82%84%e5%8e%9f%e5%80%8b%e5%88%a5%e6%aa%94%e6%a1%88" aria-label="從快照還原個別檔案">從快照還原個別檔案</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ae%a1%e7%90%86%e8%a4%87%e6%9c%ac-clone" aria-label="管理複本 (Clone)">管理複本 (Clone)</a></li>
                <li>
                    <a href="#%e5%82%99%e4%bb%bd-replication" aria-label="備份 (Replication)">備份 (Replication)</a><ul>
                        
                <li>
                    <a href="#%e6%bc%b8%e9%80%b2%e5%bc%8f%e5%82%99%e4%bb%bd" aria-label="漸進式備份">漸進式備份</a></li>
                <li>
                    <a href="#%e9%80%8f%e9%81%8e-ssh-%e5%82%b3%e9%80%81%e5%8a%a0%e5%af%86%e7%9a%84%e5%82%99%e4%bb%bd" aria-label="透過 SSH 傳送加密的備份">透過 SSH 傳送加密的備份</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%b3%87%e6%96%99%e9%9b%86%e4%bd%bf%e7%94%a8%e8%80%85%e4%bb%a5%e5%8f%8a%e7%be%a4%e7%b5%84%e9%85%8d%e9%a1%8d" aria-label="資料集、使用者以及群組配額">資料集、使用者以及群組配額</a></li>
                <li>
                    <a href="#%e4%bf%9d%e7%95%99%e7%a9%ba%e9%96%93" aria-label="保留空間">保留空間</a></li>
                <li>
                    <a href="#%e5%a3%93%e7%b8%ae-compression" aria-label="壓縮 (Compression)">壓縮 (Compression)</a></li>
                <li>
                    <a href="#%e5%8e%bb%e9%87%8d%e8%a4%87-deduplication" aria-label="去重複 (Deduplication)">去重複 (Deduplication)</a></li>
                <li>
                    <a href="#zfs-%e8%88%87-jail" aria-label="ZFS 與 Jail">ZFS 與 Jail</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%a7%94%e8%a8%97%e7%ae%a1%e7%90%86" aria-label="委託管理">委託管理</a><ul>
                        
                <li>
                    <a href="#%e5%a7%94%e8%a8%97%e8%b3%87%e6%96%99%e9%9b%86%e5%bb%ba%e7%ab%8b" aria-label="委託資料集建立">委託資料集建立</a></li>
                <li>
                    <a href="#%e5%a7%94%e8%a8%97%e6%ac%8a%e9%99%90%e5%a7%94%e8%a8%97" aria-label="委託權限委託">委託權限委託</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%80%b2%e9%9a%8e%e4%b8%bb%e9%a1%8c" aria-label="進階主題">進階主題</a><ul>
                        
                <li>
                    <a href="#%e8%aa%bf%e6%a0%a1" aria-label="調校">調校</a><ul>
                        
                <li>
                    <a href="#i386-%e4%b8%8a%e7%9a%84-zfs" aria-label="i386 上的 ZFS">i386 上的 ZFS</a></li>
                <li>
                    <a href="#%e8%a8%98%e6%86%b6%e9%ab%94" aria-label="記憶體">記憶體</a></li>
                <li>
                    <a href="#%e6%a0%b8%e5%bf%83%e8%a8%ad%e5%ae%9a" aria-label="核心設定">核心設定</a></li>
                <li>
                    <a href="#%e8%bc%89%e5%85%a5%e7%a8%8b%e5%bc%8f%e5%8f%af%e8%aa%bf%e5%8f%83%e6%95%b8" aria-label="載入程式可調參數">載入程式可調參數</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e8%b3%87%e6%ba%90" aria-label="其他資源">其他資源</a></li>
                <li>
                    <a href="#%e7%89%b9%e8%89%b2%e8%88%87%e8%a1%93%e8%aa%9e" aria-label="特色與術語">特色與術語</a></li></ul>
                </li>
                <li>
                    <a href="#gentoo-on-zfshttpswikigentooorgwikiuserali3nxinstalling_gentoo_linux_efistub_on_zfs" aria-label="Gentoo on ZFS"><a href="https://wiki.gentoo.org/wiki/User:Ali3nx/Installing_Gentoo_Linux_EFISTUB_On_ZFS">Gentoo on ZFS</a></a><ul>
                        
                <li>
                    <a href="#%e5%a4%87%e4%bb%bdhttpswwwyafamoepostbackup-your-gentoo-system" aria-label="备份"><a href="https://www.yafa.moe/post/backup-your-gentoo-system/">备份</a></a><ul>
                        
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e7%a1%ac%e7%9b%98" aria-label="初始化硬盘">初始化硬盘</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba-luks" aria-label="创建 LUKS">创建 LUKS</a></li>
                <li>
                    <a href="#%e6%89%93%e5%bc%80-luks-%e5%92%8c%e5%88%9b%e5%bb%ba%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" aria-label="打开 LUKS 和创建文件系统">打开 LUKS 和创建文件系统</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e6%8c%82%e8%bd%bd%e7%82%b9%e5%92%8c%e6%8c%82%e8%bd%bd" aria-label="创建挂载点和挂载">创建挂载点和挂载</a></li>
                <li>
                    <a href="#%e5%a4%87%e4%bb%bd%e7%b3%bb%e7%bb%9f" aria-label="备份系统">备份系统</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%bf%81%e7%a7%bb%e5%88%b0-zfshttpswwwyafamoepostgentoo-on-zfs" aria-label="迁移到 ZFS"><a href="https://www.yafa.moe/post/gentoo-on-zfs/">迁移到 ZFS</a></a><ul>
                        
                <li>
                    <a href="#%e5%88%86%e5%8c%ba" aria-label="分区">分区</a><ul>
                        
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e5%88%86%e5%8c%ba" aria-label="初始化分区">初始化分区</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba-pool" aria-label="创建 pool">创建 pool</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba-datasets" aria-label="创建 datasets">创建 datasets</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e7%b3%bb%e7%bb%9f" aria-label="安装系统">安装系统</a></li>
                <li>
                    <a href="#chroot" aria-label="chroot">chroot</a></li>
                <li>
                    <a href="#zfs-%e5%ae%89%e8%a3%85%e5%92%8c%e9%85%8d%e7%bd%ae" aria-label="ZFS 安装和配置">ZFS 安装和配置</a></li>
                <li>
                    <a href="#bootload-fstab-and-initramfs" aria-label="Bootload fstab and Initramfs">Bootload fstab and Initramfs</a><ul>
                        
                <li>
                    <a href="#grub" aria-label="GRUB">GRUB</a></li>
                <li>
                    <a href="#fstab" aria-label="fstab">fstab</a></li>
                <li>
                    <a href="#initramfs" aria-label="initramfs">initramfs</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%87%8d%e5%90%af" aria-label="重启">重启</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8zfs%e5%a4%87%e4%bb%bdhttpswwwyafamoepostuse-zfs-backup-system" aria-label="使用ZFS备份"><a href="https://www.yafa.moe/post/use-zfs-backup-system/">使用ZFS备份</a></a><ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%a4%87%e4%bb%bdzfs%e6%b1%a0" aria-label="创建备份ZFS池">创建备份ZFS池</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%bf%ab%e7%85%a7" aria-label="创建快照">创建快照</a></li>
                <li>
                    <a href="#%e5%8f%91%e9%80%81%e5%bf%ab%e7%85%a7" aria-label="发送快照">发送快照</a></li>
                <li>
                    <a href="#%e5%a4%87%e4%bb%bdboot%e5%88%86%e5%8c%ba" aria-label="备份/boot分区">备份<code>/boot</code>分区</a></li>
                <li>
                    <a href="#%e6%81%a2%e5%a4%8d%e5%bf%ab%e7%85%a7" aria-label="恢复快照">恢复快照</a></li>
                <li>
                    <a href="#%e5%ae%9a%e6%9c%9f%e5%a4%87%e4%bb%bd" aria-label="定期备份">定期备份</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%97%ae%e9%a2%98%e6%8e%92%e6%9f%a5" aria-label="问题排查">问题排查</a><ul>
                        
                <li>
                    <a href="#grub-%e6%95%91%e6%8f%b4" aria-label="grub 救援">grub 救援</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87-livecd-%e4%bf%ae%e5%a4%8d" aria-label="通过 livecd 修复">通过 livecd 修复</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#lukshttpslinuxcnarticle-9640-1html" aria-label="LUKS"><a href="https://linux.cn/article-9640-1.html">LUKS</a></a><ul>
                        
                <li>
                    <a href="#%e5%86%85%e6%a0%b8%e9%85%8d%e7%bd%ae%e5%8f%af%e9%80%89" aria-label="内核配置（可选）">内核配置（可选）</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e8%bd%af%e4%bb%b6-1" aria-label="安装软件">安装软件</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%8a%a0%e5%af%86%e5%88%86%e5%8c%ba" aria-label="创建加密分区">创建加密分区</a></li>
                <li>
                    <a href="#%e5%88%a9%e7%94%a8%e5%af%86%e9%92%a5%e6%96%87%e4%bb%b6%e5%8a%a0%e5%af%86%e5%88%86%e5%8c%ba" aria-label="利用密钥文件加密分区">利用密钥文件加密分区</a><ul>
                        
                <li>
                    <a href="#%e7%94%9f%e6%88%90%e9%9a%8f%e6%9c%ba%e5%af%86%e9%92%a5%e6%96%87%e4%bb%b6" aria-label="生成随机密钥文件">生成随机密钥文件</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0%e5%af%86%e9%92%a5%e6%96%87%e4%bb%b6%e4%bd%9c%e4%b8%ba%e5%af%86%e7%a0%81%e4%b9%8b%e4%b8%80" aria-label="添加密钥文件作为密码之一">添加密钥文件作为密码之一</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%a7%bb%e9%99%a4%e8%a7%a3%e5%af%86%e5%af%86%e7%a0%81" aria-label="移除解密密码">移除解密密码</a></li>
                <li>
                    <a href="#%e8%a7%a3%e5%af%86%e4%b8%8e%e6%8c%82%e8%bd%bd" aria-label="解密与挂载">解密与挂载</a><ul>
                        
                <li>
                    <a href="#%e5%af%86%e7%a0%81%e8%a7%a3%e5%af%86" aria-label="密码解密">密码解密</a></li>
                <li>
                    <a href="#key-file-%e8%a7%a3%e5%af%86" aria-label="key file 解密">key file 解密</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f-1" aria-label="创建文件系统">创建文件系统</a></li>
                <li>
                    <a href="#%e6%8c%82%e8%bd%bd" aria-label="挂载">挂载</a></li>
                <li>
                    <a href="#%e5%8d%b8%e8%bd%bd%e6%8c%82%e8%bd%bd%e7%82%b9%e5%b9%b6%e5%85%b3%e9%97%ad%e5%8a%a0%e5%af%86%e5%88%86%e5%8c%ba" aria-label="卸载挂载点并关闭加密分区">卸载挂载点并关闭加密分区</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a></li></ul>
                </li>
                <li>
                    <a href="#input-method-editor" aria-label="Input Method Editor">Input Method Editor</a><ul>
                        
                <li>
                    <a href="#%e4%b8%ad%e6%96%87%e5%ad%97%e4%bd%93httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle4b8ade69687e5ad97e4bd93" aria-label="中文字体"><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93">中文字体</a></a><ul>
                        
                <li>
                    <a href="#%e6%94%b9%e5%96%84%e5%ad%97%e4%bd%93%e6%b8%b2%e6%9f%93%e6%95%88%e6%9e%9chttpszhuanlanzhihucomp343934880" aria-label="改善字体渲染效果"><a href="https://zhuanlan.zhihu.com/p/343934880">改善字体渲染效果</a></a></li></ul>
                </li>
                <li>
                    <a href="#%e8%be%93%e5%85%a5%e6%b3%95httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle8be93e585a5e6b395" aria-label="输入法"><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E8%BE%93%E5%85%A5%E6%B3%95">输入法</a></a><ul>
                        
                <li>
                    <a href="#%e5%ae%98%e6%96%b9%e4%bb%93%e5%ba%93-fcitx4" aria-label="官方仓库 fcitx4">官方仓库 fcitx4</a></li>
                <li>
                    <a href="#%e9%a2%9d%e5%a4%96%e4%bb%93%e5%ba%93-fcitx5" aria-label="额外仓库 fcitx5">额外仓库 fcitx5</a><ul>
                        
                <li>
                    <a href="#%e6%8b%a5%e6%8a%b1fcitx5httpsblogcoelacanthusmoepoststechwelcome-to-fcitx5" aria-label="拥抱Fcitx5"><a href="https://blog.coelacanthus.moe/posts/tech/welcome-to-fcitx5/">拥抱Fcitx5</a></a></li>
                <li>
                    <a href="#fcitx5%e7%9a%ae%e8%82%a4%e5%88%b6%e4%bd%9chttpsbbsdeepinorgphonezhpost223810" aria-label="fcitx5皮肤制作"><a href="https://bbs.deepin.org/phone/zh/post/223810">fcitx5皮肤制作</a></a></li>
                <li>
                    <a href="#fcitx5rime%e7%9a%84%e7%95%85%e5%bf%ab%e4%bd%93%e9%aa%8chttpszhuanlanzhihucomp287774005" aria-label="fcitx(5)&#43;rime的畅快体验"><a href="https://zhuanlan.zhihu.com/p/287774005">fcitx(5)+rime的畅快体验</a></a></li></ul>
                </li>
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%aehttpswikiarchlinuxorgtitlefcitxset_environment_variables_for_im_modules" aria-label="环境配置"><a href="https://wiki.archlinux.org/title/fcitx#Set_environment_variables_for_IM_modules">环境配置</a></a></li>
                <li>
                    <a href="#rimehttpszhuanlanzhihucomp114296129" aria-label="Rime"><a href="https://zhuanlan.zhihu.com/p/114296129">Rime</a></a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#settings" aria-label="Settings">Settings</a><ul>
                        
                <li>
                    <a href="#system-settings" aria-label="System Settings">System Settings</a></li>
                <li>
                    <a href="#bluetoothhttpswikigentooorgwikibluetooth" aria-label="Bluetooth"><a href="https://wiki.gentoo.org/wiki/Bluetooth">Bluetooth</a></a></li>
                <li>
                    <a href="#%e9%a6%96%e9%80%89%e7%bc%96%e8%be%91%e5%99%a8" aria-label="首选编辑器">首选编辑器</a></li></ul>
                </li>
                <li>
                    <a href="#apps" aria-label="Apps">Apps</a><ul>
                        
                <li>
                    <a href="#mutt" aria-label="mutt">mutt</a></li>
                <li>
                    <a href="#mpv" aria-label="mpv">mpv</a></li>
                <li>
                    <a href="#spotify" aria-label="spotify">spotify</a></li>
                <li>
                    <a href="#youtube-dl" aria-label="youtube-dl">youtube-dl</a></li>
                <li>
                    <a href="#aria2" aria-label="aria2">aria2</a></li>
                <li>
                    <a href="#typora" aria-label="Typora">Typora</a></li>
                <li>
                    <a href="#zsh" aria-label="zsh">zsh</a></li>
                <li>
                    <a href="#clash" aria-label="Clash">Clash</a></li>
                <li>
                    <a href="#browsers" aria-label="Browsers">Browsers</a></li>
                <li>
                    <a href="#kio-extrashttpswikigentooorgwikimtp" aria-label="kio-extras"><a href="https://wiki.gentoo.org/wiki/MTP">kio-extras</a></a><ul>
                        
                <li>
                    <a href="#gwenview" aria-label="Gwenview">Gwenview</a></li>
                <li>
                    <a href="#okular" aria-label="Okular">Okular</a></li></ul>
                </li>
                <li>
                    <a href="#ktimer" aria-label="KTimer">KTimer</a></li>
                <li>
                    <a href="#kclock" aria-label="KClock">KClock</a></li>
                <li>
                    <a href="#rsibreakhttpsuserbasekdeorgrsibreakzh-cn" aria-label="RSIBreak"><a href="https://userbase.kde.org/RSIBreak/zh-cn">RSIBreak</a></a></li>
                <li>
                    <a href="#libreoffice" aria-label="LibreOffice">LibreOffice</a></li>
                <li>
                    <a href="#flameshot" aria-label="Flameshot">Flameshot</a><ul>
                        
                <li>
                    <a href="#spectacle" aria-label="Spectacle">Spectacle</a></li></ul>
                </li>
                <li>
                    <a href="#keepassxchttpskeepassxcorg" aria-label="KeePassXC"><a href="https://keepassxc.org/">KeePassXC</a></a></li>
                <li>
                    <a href="#ppsspp" aria-label="PPSSPP">PPSSPP</a></li>
                <li>
                    <a href="#papirus-icon-themehttpsgithubcompapirusdevelopmentteampapirus-icon-theme" aria-label="papirus-icon-theme"><a href="https://github.com/PapirusDevelopmentTeam/papirus-icon-theme">papirus-icon-theme</a></a></li>
                <li>
                    <a href="#vulkanhttpswikigentooorgwikivulkan" aria-label="Vulkan"><a href="https://wiki.gentoo.org/wiki/Vulkan">Vulkan</a></a></li>
                <li>
                    <a href="#tree" aria-label="tree">tree</a></li>
                <li>
                    <a href="#qemu" aria-label="qemu">qemu</a></li>
                <li>
                    <a href="#dockerhttpswikigentooorgwikidocker" aria-label="Docker"><a href="https://wiki.gentoo.org/wiki/Docker">Docker</a></a></li>
                <li>
                    <a href="#lsusbhttpswikigentooorgwikiusbutils" aria-label="lsusb"><a href="https://wiki.gentoo.org/wiki/Usbutils">lsusb</a></a></li>
                <li>
                    <a href="#p7ziphttpswikigentooorgwikip7zip" aria-label="p7zip"><a href="https://wiki.gentoo.org/wiki/P7zip">p7zip</a></a><ul>
                        
                <li>
                    <a href="#ziphttpswwwtecmintcomunzip-extract-zip-files-to-specific-directory-in-linux" aria-label="zip"><a href="https://www.tecmint.com/unzip-extract-zip-files-to-specific-directory-in-linux/">zip</a></a></li>
                <li>
                    <a href="#arkhttpsappskdeorgark" aria-label="Ark"><a href="https://apps.kde.org/ark/">Ark</a></a></li></ul>
                </li>
                <li>
                    <a href="#adb-and-fastboothttpswikigentooorgwikiandroidadb" aria-label="ADB and Fastboot"><a href="https://wiki.gentoo.org/wiki/Android/adb">ADB and Fastboot</a></a><ul>
                        
                <li>
                    <a href="#file-transfer" aria-label="File transfer">File transfer</a></li></ul>
                </li>
                <li>
                    <a href="#flatpak" aria-label="Flatpak">Flatpak</a></li>
                <li>
                    <a href="#neofetchhttpszhuanlanzhihucomp69777438" aria-label="neofetch"><a href="https://zhuanlan.zhihu.com/p/69777438">neofetch</a></a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e8%87%aa%e5%ae%9a%e4%b9%89%e5%9b%be%e5%83%8f" aria-label="使用自定义图像">使用自定义图像</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae-neofetch" aria-label="配置 Neofetch">配置 Neofetch</a></li></ul>
                </li>
                <li>
                    <a href="#cpuid2cpuflags" aria-label="cpuid2cpuflags">cpuid2cpuflags</a></li>
                <li>
                    <a href="#flaggie" aria-label="flaggie">flaggie</a></li></ul>
                </li>
                <li>
                    <a href="#others" aria-label="Others">Others</a><ul>
                        
                <li>
                    <a href="#recommended-applicationshttpswikigentooorgwikirecommended_applications-gentoo" aria-label="Recommended applications: Gentoo"><a href="https://wiki.gentoo.org/wiki/Recommended_applications">Recommended applications</a>: Gentoo</a></li>
                <li>
                    <a href="#list-of-applicationshttpswikiarchlinuxorgtitlelist_of_applications-arch" aria-label="List of applications: Arch"><a href="https://wiki.archlinux.org/title/List_of_applications">List of applications</a>: Arch</a></li></ul>
                </li>
                <li>
                    <a href="#tips-2" aria-label="Tips">Tips</a><ul>
                        
                <li>
                    <a href="#%e4%b8%ba-portage-%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8%e8%ae%be%e7%bd%ae%e4%bb%a3%e7%90%86httpsbitbilinetset-proxy-for-gentoo-portagehtml" aria-label="为 Portage 包管理器设置代理"><a href="https://bitbili.net/set-proxy-for-gentoo-portage.html">为 Portage 包管理器设置代理</a></a><ul>
                        
                <li>
                    <a href="#gentoo-%e7%9a%84%e9%bb%98%e8%ae%a4%e8%ae%be%e7%bd%ae" aria-label="Gentoo 的默认设置">Gentoo 的默认设置</a></li>
                <li>
                    <a href="#%e6%8c%81%e4%b9%85%e6%80%a7%e5%9c%b0%e4%bf%ae%e6%94%b9%e4%bb%a3%e7%90%86" aria-label="持久性地修改代理">持久性地修改代理</a><ul>
                        
                <li>
                    <a href="#%e9%80%9a%e7%94%a8%e9%85%8d%e7%bd%ae" aria-label="通用配置">通用配置</a></li>
                <li>
                    <a href="#%e5%8d%95%e7%8b%ac%e9%85%8d%e7%bd%ae-git-%e6%8a%93%e5%8f%96" aria-label="单独配置 git 抓取">单独配置 git 抓取</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%b4%e6%97%b6%e6%b7%bb%e5%8a%a0%e4%bb%a3%e7%90%86" aria-label="临时添加代理">临时添加代理</a><ul>
                        
                <li>
                    <a href="#%e6%8e%a8%e8%8d%90proxychains" aria-label="推荐：ProxyChains">推荐：ProxyChains</a></li>
                <li>
                    <a href="#%e4%b8%b4%e6%97%b6%e6%8c%87%e5%ae%9a%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" aria-label="临时指定环境变量">临时指定环境变量</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#freeing-disk-spacehttpswikigentooorgwikiknowledge_basefreeing_disk_space" aria-label="Freeing disk space"><a href="https://wiki.gentoo.org/wiki/Knowledge_Base:Freeing_disk_space">Freeing disk space</a></a></li>
                <li>
                    <a href="#how-to-change--set-the-default-crontab-editorhttpswwwservernoobscomchange-set-the-default-crontab-editortextif20you20want20to20change20your20default20crontabin20general2c20you20use20this20command3a20export20editor3d2fusr2fbin2fnano" aria-label="How to Change &amp;amp; Set the Default crontab Editor"><a href="https://www.servernoobs.com/change-set-the-default-crontab-editor/#:~:text=If%20you%20want%20to%20change%20your%20default%20crontab,in%20general%2C%20you%20use%20this%20command%3A%20export%20EDITOR%3D%2Fusr%2Fbin%2Fnano.">How to Change &amp; Set the Default crontab Editor</a></a></li>
                <li>
                    <a href="#how-to-update-dolphin-file-manager-in-real-timehttpsaskubuntucomquestions311303how-to-update-dolphin-file-manager-in-real-time" aria-label="How to update dolphin file manager in real time"><a href="https://askubuntu.com/questions/311303/how-to-update-dolphin-file-manager-in-real-time">How to update dolphin file manager in real time</a></a></li>
                <li>
                    <a href="#how-do-i-convert-a-png-into-a-icohttpssuperusercomquestions227736how-do-i-convert-a-png-into-a-ico1012535" aria-label="How do I convert a .PNG into a .ICO?"><a href="https://superuser.com/questions/227736/how-do-i-convert-a-png-into-a-ico/1012535">How do I convert a .PNG into a .ICO?</a></a></li>
                <li>
                    <a href="#crop-a-photo-to-fit-a-circle-using-ffmpeghttpsstackoverflowcomquestions63997289can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg" aria-label="Crop a photo to fit a circle using ffmpeg"><a href="https://stackoverflow.com/questions/63997289/can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg">Crop a photo to fit a circle using ffmpeg</a></a></li>
                <li>
                    <a href="#path-to-kde-picture-of-the-dayhttpsaskubuntucomquestions1197417where-is-bings-picture-of-the-day-stored-on-my-system" aria-label="Path to KDE Picture of the Day"><a href="https://askubuntu.com/questions/1197417/where-is-bings-picture-of-the-day-stored-on-my-system">Path to KDE Picture of the Day</a></a></li>
                <li>
                    <a href="#baloohttpscommunitykdeorgbaloo" aria-label="Baloo"><a href="https://community.kde.org/Baloo">Baloo</a></a><ul>
                        
                <li>
                    <a href="#baloo-file-extractor-crashes-on-every-boothttpsforumsgentooorgviewtopic-t-1096234-start-0html" aria-label="Baloo File Extractor Crashes on every boot"><a href="https://forums.gentoo.org/viewtopic-t-1096234-start-0.html">Baloo File Extractor Crashes on every boot</a></a></li></ul>
                </li>
                <li>
                    <a href="#%e5%86%85%e6%a0%b8%e5%8d%87%e7%ba%a7%e4%b8%80%e8%88%ac%e6%ad%a5%e9%aa%a4httpsblogsoymilkfun20201117linuxgentoogentookernelupdate" aria-label="内核升级一般步骤"><a href="https://blog.soymilk.fun/2020/11/17/Linux/Gentoo/GentooKernelUpdate/">内核升级一般步骤</a></a><ul>
                        
                <li>
                    <a href="#%e5%8d%87%e7%ba%a7%e5%86%85%e6%a0%b8" aria-label="升级内核">升级内核</a></li>
                <li>
                    <a href="#configuration-1" aria-label="Configuration">Configuration</a></li>
                <li>
                    <a href="#build" aria-label="Build">Build</a></li>
                <li>
                    <a href="#install" aria-label="Install">Install</a></li>
                <li>
                    <a href="#bootloader" aria-label="BootLoader">BootLoader</a></li>
                <li>
                    <a href="#clean" aria-label="Clean">Clean</a></li></ul>
                </li>
                <li>
                    <a href="#dwmhttpszhuanlanzhihucomp346719806" aria-label="dwm"><a href="https://zhuanlan.zhihu.com/p/346719806">dwm</a></a><ul>
                        
                <li>
                    <a href="#de%e5%92%8cwm%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="DE和WM的区别">DE和WM的区别</a></li>
                <li>
                    <a href="#dwm%e4%b8%8e%e5%85%b6%e4%bb%96wm%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="dwm与其他wm的区别">dwm与其他wm的区别</a></li>
                <li>
                    <a href="#%e9%80%9a%e7%94%a8%e7%9a%84wm%e9%85%8d%e7%bd%ae" aria-label="通用的wm配置">通用的wm配置</a></li>
                <li>
                    <a href="#dwm%e5%ae%89%e8%a3%85" aria-label="dwm安装">dwm安装</a></li>
                <li>
                    <a href="#dwm%e9%85%8d%e7%bd%aehttpszhuanlanzhihucomp183861786" aria-label="dwm配置"><a href="https://zhuanlan.zhihu.com/p/183861786">dwm配置</a></a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#questions-1" aria-label="Questions">Questions</a><ul>
                        
                <li>
                    <a href="#problem-with-transparencies-and-windowing-ghosting-outhttpsforumgarudalinuxorgtproblem-with-transparencies-and-windowing-ghosting-out9568" aria-label="Problem with transparencies and windowing ghosting out"><a href="https://forum.garudalinux.org/t/problem-with-transparencies-and-windowing-ghosting-out/9568">Problem with transparencies and windowing ghosting out</a></a></li>
                <li>
                    <a href="#telegram-not-launching-from-the-browser-xdg-openhttpswwwredditcomrmanjarolinuxcommentsk76cphtelegram_not_launching_from_the_browser_xdgopen" aria-label="Telegram not launching from the browser xdg-open"><a href="https://www.reddit.com/r/ManjaroLinux/comments/k76cph/telegram_not_launching_from_the_browser_xdgopen/">Telegram not launching from the browser xdg-open</a></a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Gentoo-zh 群推荐安装教程：</p>
<ol>
<li><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html">https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html</a></li>
<li><a href="https://www.yafa.moe/post/install-gentoo-on-mac/">https://www.yafa.moe/post/install-gentoo-on-mac/</a></li>
<li><a href="https://litterhougelangley.life/blog/2021/05/21/gentoo/">https://litterhougelangley.life/blog/2021/05/21/gentoo/</a></li>
<li><a href="https://blog.bugsur.xyz/gentoo-handbook-installation/">https://blog.bugsur.xyz/gentoo-handbook-installation/</a></li>
</ol>
<p>群内如果要贴长文本，可以使用网络粘贴板：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;输出命令&gt; | curl -F <span style="color:#e6db74">&#34;c=@-&#34;</span> <span style="color:#e6db74">&#34;https://fars.ee/&#34;</span>
</code></pre></div><p>并且将输出里的 <code>url: http://far.se/xxxx</code> 这行贴出来。使用的时候可以 <code>curl http://far.se/xxxx | less</code> 查看</p>
<h2 id="qemulinux-guesthttpswikigentooorgwikiqemulinux_guest"><a href="https://wiki.gentoo.org/wiki/QEMU/Linux_guest">QEMU/Linux guest</a><a hidden class="anchor" aria-hidden="true" href="#qemulinux-guesthttpswikigentooorgwikiqemulinux_guest">#</a></h2>
<h3 id="configuration">Configuration<a hidden class="anchor" aria-hidden="true" href="#configuration">#</a></h3>
<h4 id="host">Host<a hidden class="anchor" aria-hidden="true" href="#host">#</a></h4>
<p>To create a disk image for the virtual machine, run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ qemu-img create -f qcow2 Gentoo-VM.img 30G
</code></pre></div><p>Download a minimal Gentoo LiveCD from <a href="https://www.gentoo.org/downloads/">here</a>.</p>
<p>Since QEMU requires a lot of <a href="https://wiki.gentoo.org/wiki/QEMU/Options">options</a>, it would be a good idea to put them into a shell script, e.g.:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vim start_Gentoo_VM.sh
<span style="color:#75715e">#!/bin/bash</span>
DISKIMG<span style="color:#f92672">=</span>$HOME/VirtualMachine/Gentoo-VM.img
exec qemu-system-x86_64 -enable-kvm <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -bios /usr/share/edk2-ovmf/OVMF_CODE.fd <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -cpu host <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -drive file<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>DISKIMG<span style="color:#e6db74">}</span>,if<span style="color:#f92672">=</span>virtio <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -netdev user,id<span style="color:#f92672">=</span>vmnic,hostname<span style="color:#f92672">=</span>Gentoo-VM,hostfwd<span style="color:#f92672">=</span>tcp::10022-:22 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -device virtio-net,netdev<span style="color:#f92672">=</span>vmnic <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -device virtio-rng-pci <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -m 4G <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -smp <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -monitor stdio <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -vga std <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -audiodev pa,id<span style="color:#f92672">=</span>snd0 -device ich9-intel-hda -device hda-output,audiodev<span style="color:#f92672">=</span>snd0 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -name <span style="color:#e6db74">&#34;Gentoo VM&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        $@
        
$ chmod u+x start_Gentoo_VM.sh
</code></pre></div><p>Change the path to your disk image Gentoo-VM.img in the script. You can add more options when calling the script. To boot the disk image, run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./start_Gentoo_VM.sh -boot d -cdrom $HOME/Downloads/install-amd64-minimal-20211107T170547Z.iso
</code></pre></div><p>Install the guest per the <a href="https://wiki.gentoo.org/wiki/Handbook:Main_Page">Gentoo Handbook</a>. See the <a href="https://wiki.gentoo.org/wiki/QEMU/Linux_guest#Guest">guest section</a> for optimum support. After the installation start the script without the additional options.</p>
<h4 id="using-uefi-with-qemuhttpsfedoraprojectorgwikiusing_uefi_with_qemu"><a href="https://fedoraproject.org/wiki/Using_UEFI_with_QEMU">Using UEFI with QEMU</a><a hidden class="anchor" aria-hidden="true" href="#using-uefi-with-qemuhttpsfedoraprojectorgwikiusing_uefi_with_qemu">#</a></h4>
<p>UEFI for x86 QEMU/KVM VMs is called OVMF (Open Virtual Machine Firmware). It comes from EDK2 (EFI Development Kit), which is the UEFI reference implementation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge sys-firmware/edk2-ovmf
</code></pre></div><p><a href="https://www.ubuntubuzz.com/2021/04/how-to-boot-uefi-on-qemu.html">检查是否安装</a>，命令为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ equery f sys-firmware/edk2-ovmf | grep OVMF
/usr/share/edk2-ovmf/OVMF_CODE.fd
/usr/share/edk2-ovmf/OVMF_CODE.secboot.fd
/usr/share/edk2-ovmf/OVMF_VARS.fd
</code></pre></div><p>要在虚拟机中运行操作系统的映像文件，添加 <code>-bios /usr/share/ovmf/OVMF.fd</code>。该代码调用名为 OVMF.fd 的文件，该文件是 Qemu 的 UEFI 固件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">qemu-system-x86_64 -bios /usr/share/edk2-ovmf/OVMF_CODE.fd -cdrom ubuntu-21.04-desktop-amd64.iso
</code></pre></div><p>这个名为<em>ovmf的</em>包其实就是名为TianoCore的程序。该名称本身代表<a href="https://github.com/tianocore/tianocore.github.io/wiki/OVMF-FAQ#what-is-open-virtual-machine-firmware-ovmf">开放虚拟机固件</a>)。</p>
<h3 id="questions">Questions<a hidden class="anchor" aria-hidden="true" href="#questions">#</a></h3>
<p><a href="https://github.com/utmapp/UTM/issues/2333"><strong>&ldquo;BdsDxe: failed to load Boot0001&rdquo;</strong></a></p>
<p><a href="https://www.reddit.com/r/Proxmox/comments/ckfthg/vm_no_longer_boots_after_creating_windows_10_vm/">solution</a>: Try hitting F2 to enter the OVMF settings during guest boot and manually pick a new boot drive option.</p>
<h2 id="介绍httpswikigentooorgwikihandbookamd64installationabout"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/About">介绍</a><a hidden class="anchor" aria-hidden="true" href="#介绍httpswikigentooorgwikihandbookamd64installationabout">#</a></h2>
<h3 id="欢迎">欢迎<a hidden class="anchor" aria-hidden="true" href="#欢迎">#</a></h3>
<p>首先，欢迎使用Gentoo！您将会进入一个选择自由和性能至上的世界。Gentoo的一切都是为了自由选择。在安装Gentoo时就数次明确表明了这一特点——用户可以自己选择想要编译的一切内容、选择安装Gentoo的方式、选择想用的系统日志程序等等。</p>
<p>Gentoo 是一个快速、现代化的元发行版，它的设计简洁、灵活。Gentoo 围绕自由软件建立，它不会对它的用户隐瞒“引擎盖下的细节”。Gentoo 所使用的软件包维护系统 Portage 是用 Python 编写的，这意味着用户可以轻松地查看和修改它的源代码。 Gentoo 的软件包管理系统使用源代码包（虽然也支持预编译软件包），并通过标准的文本文件配置Gentoo。换句话说，开放无处不在。</p>
<p>“自由选择”是 Gentoo 运行的关键，这点很重要，大家要理解。我们尽量不强迫用户去做任何他们不喜欢的事情。</p>
<h3 id="安装步骤">安装步骤<a hidden class="anchor" aria-hidden="true" href="#安装步骤">#</a></h3>
<p>Gentoo的安装可以被分成10个步骤，分别对应后续的章节。执行完每个步骤，都会让系统进入某种确定的状态：</p>
<table>
<thead>
<tr>
<th style="text-align:left">步骤</th>
<th style="text-align:left">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">用户处于一个准备好安装 Gentoo 的工作环境中。</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">用于安装 Gentoo 的互联网连接已经准备完毕。</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">硬盘已经为 Gentoo 的安装初始化完毕。</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">安装环境已经准备好，用户准备 chroot 到新环境中去。</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left">那些在所有Gentoo安装中都相同的核心软件包已经安装完毕。</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left">Linux内核已经安装完毕。</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left">用户已经创建好大部分的 Gentoo 系统配置文件。</td>
</tr>
<tr>
<td style="text-align:left">8</td>
<td style="text-align:left">必要的系统工具已经安装完毕。</td>
</tr>
<tr>
<td style="text-align:left">9</td>
<td style="text-align:left">合适的启动引导程序 (Bootloader) 已经安装配置完毕。</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td style="text-align:left">登录系统，你就可以在已经全新安装完毕的 Gentoo Linux 系统中尽情探索了！</td>
</tr>
</tbody>
</table>
<h2 id="选择正确的安装媒介httpswikigentooorgwikihandbookamd64installationmedia"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Media">选择正确的安装媒介</a><a hidden class="anchor" aria-hidden="true" href="#选择正确的安装媒介httpswikigentooorgwikihandbookamd64installationmedia">#</a></h2>
<h3 id="硬件需求">硬件需求<a hidden class="anchor" aria-hidden="true" href="#硬件需求">#</a></h3>
<p>在开始之前，我们先列出在一台 amd64 的主机上成功安装Gentoo所必须的硬件需求。</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">Minimal CD</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">CPU</td>
<td style="text-align:left">Any x86-64 CPU, both AMD64 and Intel 64</td>
</tr>
<tr>
<td style="text-align:left">Memory</td>
<td style="text-align:left">2 GB</td>
</tr>
<tr>
<td style="text-align:left">Disk space</td>
<td style="text-align:left">8 GB (excluding swap space)</td>
</tr>
<tr>
<td style="text-align:left">Swap space</td>
<td style="text-align:left">At least 2 GB</td>
</tr>
</tbody>
</table>
<h3 id="使用gentoo-linux安装光盘">使用Gentoo Linux安装光盘<a hidden class="anchor" aria-hidden="true" href="#使用gentoo-linux安装光盘">#</a></h3>
<h4 id="最小化安装cd">最小化安装CD<a hidden class="anchor" aria-hidden="true" href="#最小化安装cd">#</a></h4>
<p>Gentoo最小化安装CD是一张可引导镜像：包含有完整Gentoo环境的。它允许用户从CD或其它安装媒介引导进入Linux。在引导过程中将检测硬件并加载适当的驱动。这个镜像由Gentoo开发人员维护，能让任何有Internet连接的人来安装Gentoo。</p>
<p>最小化安装CD叫做 <code>install-amd64-minimal-&lt;release&gt;.iso</code>。</p>
<h4 id="stage又是什么">stage又是什么？<a hidden class="anchor" aria-hidden="true" href="#stage又是什么">#</a></h4>
<p>stage3压缩包是一个包含有最小化Gentoo环境的文件，可用来按照本手册介绍继续安装Gentoo。以前的Gentoo手册描述了使用三个 <a href="https://wiki.gentoo.org/wiki/Stage_tarball">stage tarballs</a> 的其中一个来进行安装。现在Gentoo仍然提供stage1和stage2的压缩包，但是官方安装方法只使用stage3压缩包。如果你对使用stage1或stage2压缩包安装Gentoo感兴趣，请阅读 Gentoo 常见问题中的<a href="https://wiki.gentoo.org/wiki/FAQ/zh-cn#.E5.A6.82.E4.BD.95.E4.BD.BF.E7.94.A8stage1.E6.88.96stage2_tarball.E5.AE.89.E8.A3.85Gentoo.EF.BC.9F">如何使用stage1或stage2 tarball安装Gentoo</a>?</p>
<p>Stage 文件可以在任意一个<a href="https://www.gentoo.org/downloads/mirrors/">Gentoo官方镜像站 </a>的 <code>releases/amd64/autobuilds/</code>  路径下下载，中国可选择<a href="https://mirrors.tuna.tsinghua.edu.cn/gentoo/releases/amd64/autobuilds/current-stage3-amd64-systemd/">Tsinghua University</a>。</p>
<h3 id="下载">下载<a hidden class="anchor" aria-hidden="true" href="#下载">#</a></h3>
<h4 id="获得安装媒介">获得安装媒介<a hidden class="anchor" aria-hidden="true" href="#获得安装媒介">#</a></h4>
<p>Gentoo Linux使用<em>最小化安装CD</em>做为默认安装媒介，它带有一个非常小的可引导的Gentoo Linux环境。此环境包含所有正确的安装工具。 CD镜像本身可以从<a href="https://www.gentoo.org/downloads/">官方下载页</a>（推荐）或任意一个<a href="https://www.gentoo.org/downloads/mirrors/">镜像站</a>下载。</p>
<p>在这些镜像站上，最小化安装CD可以通过以下方式找到：</p>
<ol>
<li>进入 releases/ 目录</li>
<li>选择相应的架构, 如 <strong>amd64/</strong></li>
<li>选择 autobuilds/ 目录</li>
<li>对于 <strong>amd64</strong> 和 <strong>x86</strong> 平台的用户，请选择 current-install-amd64-minimal/ 目录。</li>
</ol>
<p>在这个位置，安装媒体文件是那些带有.iso扩展名的文件。比如下面的清单：</p>
<pre tabindex="0"><code>[DIR] hardened/                                          05-Dec-2014 01:42    -   
[   ] install-amd64-minimal-20141204.iso                 04-Dec-2014 21:04  208M  
[   ] install-amd64-minimal-20141204.iso.CONTENTS        04-Dec-2014 21:04  3.0K  
[   ] install-amd64-minimal-20141204.iso.DIGESTS         04-Dec-2014 21:04  740   
[TXT] install-amd64-minimal-20141204.iso.DIGESTS.asc     05-Dec-2014 01:42  1.6K  
[   ] stage3-amd64-20141204.tar.bz2                      04-Dec-2014 21:04  198M  
[   ] stage3-amd64-20141204.tar.bz2.CONTENTS             04-Dec-2014 21:04  4.6M  
[   ] stage3-amd64-20141204.tar.bz2.DIGESTS              04-Dec-2014 21:04  720   
[TXT] stage3-amd64-20141204.tar.bz2.DIGESTS.asc          05-Dec-2014 01:42  1.5K
</code></pre><p>在上面的例子中， <code>install-amd64-minimal-20141204.iso</code>文件是最小化安装CD。但可以看到,还有其他相关文件存在:</p>
<ul>
<li>.CONTENTS 文件是一个文本文件，它列出了安装媒介中的所有文件。这个文件可用于在下载前确认安装媒介是否包含特定的固件和驱动程序。</li>
<li>.DIGESTS 文件包含了ISO文件的Hash值，有不同的Hash格式／算法。这个文件可以用来验证已下载的ISO文件有没有损坏。</li>
<li>.DIGESTS.asc 文件不仅包含了ISO文件的Hash值（和 .DIGESTS 文件一样），还包含了它的加密签名。这个文件即可用于验证已下载的ISO文件是否损坏，也可验证文件确实是由Gentoo发行工程组（Gentoo Release Engineering Team）发布而没有被篡改。</li>
</ul>
<p>现在可以先忽略当前位置的其他文件——它们在安装的后续步骤中会被提到。下载 .ISO，另外如果想要验证下载的文件，同时下载ISO文件对应的 .DIGESTS.asc。 .CONTENTS 文件不需要下载，因为安装指南后续不会用到这个文件。 .DIGESTS 这个文件和.DIGESTS.asc 文件包含相同的信息，除此以外后者还包含有上面文件的数字签名。</p>
<h4 id="校验下载的文件">校验下载的文件<a hidden class="anchor" aria-hidden="true" href="#校验下载的文件">#</a></h4>
<p><strong>注</strong>：这是一个可选步骤，并不是安装 Gentoo Linux 所必须的。但是，我们仍然推荐这么做，以此来确保下载的文件没有损坏，以及确保下载文件确实由 <a href="https://wiki.gentoo.org/wiki/Project:Infrastructure">Gentoo Infrastructure Team</a>提供。</p>
<p>通过 .DIGESTS 和 .DIGESTS.asc 文件，可以使用合适的工具来校验 ISO 文件的有效性。校验通常有两个步骤：　　</p>
<ol>
<li>首先，验证加密签名，确保安装文件是由Gentoo发行工程组（ Gentoo Release Engineering team ） 提供</li>
<li>如果加密签名是有效的，就验证它的文件校验值 （比如 SHA512,WHIRLPOOL），以此来确认下载的文件没有损坏。</li>
</ol>
<p>在 Linux 系统上,最常用的验证加密签名的方法就是使用 <a href="https://packages.gentoo.org/packages/app-crypt/gnupg">app-crypt/gnupg</a> 这个软件。安装了这个程序,就可以使用以下命令来验证 .DIGESTS.asc 文件中的数字（GPG）签名。</p>
<p>首先，下载 <a href="https://www.gentoo.org/downloads/signatures/">数字签名页</a> 中正确的密匙：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gpg --keyserver hkps://keys.gentoo.org --recv-keys 0xBB572E0E2D182910
gpg: requesting key 0xBB572E0E2D182910 from hkp server pool.sks-keyservers.net
gpg: key 0xBB572E0E2D182910: <span style="color:#e6db74">&#34;Gentoo Linux Release Engineering (Automated Weekly Release Key) &lt;releng@gentoo.org&gt;&#34;</span> <span style="color:#ae81ff">1</span> new signature
gpg: <span style="color:#ae81ff">3</span> marginal<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> needed, <span style="color:#ae81ff">1</span> complete<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> needed, classic trust model
gpg: depth: <span style="color:#ae81ff">0</span>  valid:   <span style="color:#ae81ff">3</span>  signed:  <span style="color:#ae81ff">20</span>  trust: 0-, 0q, 0n, 0m, 0f, 3u
gpg: depth: <span style="color:#ae81ff">1</span>  valid:  <span style="color:#ae81ff">20</span>  signed:  <span style="color:#ae81ff">12</span>  trust: 9-, 0q, 0n, 9m, 2f, 0u
gpg: next trustdb check due at 2018-09-15
gpg: Total number processed: <span style="color:#ae81ff">1</span>
gpg:         new signatures: <span style="color:#ae81ff">1</span>
</code></pre></div><p>下一步验证 .DIGESTS.asc 文件的数字（GPG）签名：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gpg --verify install-amd64-minimal-20141204.iso.DIGESTS.asc
gpg: Signature made Fri <span style="color:#ae81ff">05</span> Dec <span style="color:#ae81ff">2014</span> 02:42:44 AM CET
gpg:                using RSA key 0xBB572E0E2D182910
gpg: Good signature from <span style="color:#e6db74">&#34;Gentoo Linux Release Engineering (Automated Weekly Release Key) &lt;releng@gentoo.org&gt;&#34;</span> <span style="color:#f92672">[</span>unknown<span style="color:#f92672">]</span>
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: 13EB BDBE DE7A <span style="color:#ae81ff">1277</span> 5DFD  B1BA BB57 2E0E 2D18 <span style="color:#ae81ff">2910</span>
</code></pre></div><p>确认数字签名有效后，接下来就是验证校验值，以确保下载的ISO文件没有损坏。 .DIGESTS.asc 文件包含了多个哈希算法，所以验证正确校验和的方法之一是先找到登记在文件 .DIGESTS.asc 中的相应的校验值。例如，获取 SHA512 的校验值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ grep -A <span style="color:#ae81ff">1</span> -i sha512 install-amd64-minimal-20141204.iso.DIGESTS.asc
<span style="color:#75715e"># SHA512 HASH</span>
364d32c4f8420605f8a9fa3a0fc55864d5b0d1af11aa62b7a4d4699a427e5144b2d918225dfb7c5dec8d3f0fe2cddb7cc306da6f0cef4f01abec33eec74f3024  install-amd64-minimal-20141204.iso
--
<span style="color:#75715e"># SHA512 HASH</span>
0719a8954dc7432750de2e3076c8b843a2c79f5e60defe43fcca8c32ab26681dfb9898b102e211174a895ff4c8c41ddd9e9a00ad6434d36c68d74bd02f19b57f  install-amd64-minimal-20141204.iso.CONTENTS
</code></pre></div><p>在上面的输出中，显示了两个SHA512校验和：一个用于文件：install-amd64-minimal-20141204.iso，一个用于与之对应的 .CONTENTS 文件。只有第一个校验值有用，因为要用它来和下面计算出来的 SHA512 的校验值进行比较：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sha512sum install-amd64-minimal-20141204.iso
364d32c4f8420605f8a9fa3a0fc55864d5b0d1af11aa62b7a4d4699a427e5144b2d918225dfb7c5dec8d3f0fe2cddb7cc306da6f0cef4f01abec33eec74f3024  install-amd64-minimal-20141204.iso
</code></pre></div><p>如果两个校验值匹配，那么表明文件没有损坏，安装可以继续进行。损坏的文件会导致安装出现问题，请重新下载。</p>
<h4 id="刻录光盘">刻录光盘<a hidden class="anchor" aria-hidden="true" href="#刻录光盘">#</a></h4>
<p>当然,只是下载一个 ISO 文件是无法开始 Gentoo Linux 的安装的。需要将这个ISO文件刻录成一张用来启动的 CD 光盘，是要将 ISO 文件里的内容而不是 ISO 文件本身刻录到CD光盘上。下面介绍了一些常见的方式——这里可以找到其他更复杂的方式：<a href="https://wiki.gentoo.org/wiki/FAQ#How_do_I_burn_an_ISO_file.3F">如何刻录ISO文件</a>。</p>
<p>在 Linux 系统上，可以通过 <strong>cdrecord</strong> 命令将ISO文件刻录到CD光盘上，这个命令由 <a href="https://packages.gentoo.org/packages/app-cdr/cdrtools">app-cdr/cdrtools</a> 软件包提供。</p>
<p>将ISO文件刻录到 /dev/sr0 设备的 CD 光碟上（这是系统上的第一个 CD 设备-在必要时将其替换为正确的设备）:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cdrecord dev<span style="color:#f92672">=</span>/dev/sr0 install-amd64-minimal-20141204.iso
</code></pre></div><p>喜欢使用图形化界面的用户可以使用 K3B ，它由 <a href="https://packages.gentoo.org/packages/kde-app/k3b">kde-app/k3b</a> 软件包提供。在 K3B 软件中，选择“工具”（Tools）菜单，然后选择“刻录CD镜像”（Burn CD Image）。</p>
<h3 id="启动">启动<a hidden class="anchor" aria-hidden="true" href="#启动">#</a></h3>
<h4 id="启动安装媒介">启动安装媒介<a hidden class="anchor" aria-hidden="true" href="#启动安装媒介">#</a></h4>
<p>安装媒介准备就绪后，就可以启动了。 将安装媒介插入系统中，重启，然后进入主板的固件用户界面。 通常是在开机自检（POST）过程中通过在键盘上按DEL, F1, F10, 或 ESC 进入，“触发”键取决于系统和主板。 如果使用主板的型号作为关键字在互联网搜索引擎进行搜索， 结果应该很容易确定。进入主板的固件菜单后，更改引导顺序，以便在内部磁盘设备之前尝试外部可启动媒介（CD / DVD盘或USB驱动器）。 否则，系统很可能会重新启动到内部磁盘设备，从而忽略外部启动媒介。</p>
<p><strong>重要</strong>：如果想安装使用 UEFI 引导的 Gentoo ，建议立即使用UEFI启动。如果不用 UEFI 来启动，可能就要在最后完成 Gentoo Linux 的安装之前制作一个可以启动的 UEFI U盘（或其他介质）。</p>
<p>如果启动没有成功，请确保将安装媒介插入系统，然后重新启动。这是会显示一个启动提示符。 此时按Enter键将使用默认的启动选项启动。如果要使用自定义引导选项引导安装媒介，请按照启动选项指定一个内核，然后按Enter键。</p>
<p><strong>附注</strong>：在大多数情况下，默认的Gentoo内核可以像之前提到的那样可以在没有任何指定参数的情况下正常工作，有关启动故障排除和专家选项，请继续执行此部分。否则，只需按Enter并跳转至<a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Media#Extra_hardware_configuration">其他硬件配置</a>.</p>
<p>在启动提示符下，用户可以按 F1 键显示可用的内核，按 F2 按键显示可用的启动选项。如果在15秒内没做任何选择（既不显示信息，也不选择内核）安装媒介将会从硬盘启动。这样不用将 CD 光盘从光盘驱动器里拿出来，也可以在安装过程中重启和尝试已安装好的环境（这有时在远程安装的时候很有用）。</p>
<p>提到了指定一个内核。 在最小安装介质上，只提供了两个预定义的内核启动选项。 默认选项叫<strong>gentoo</strong>。 另一个是“-nofb”变量; 这会禁用内核帧缓冲区支持。</p>
<p><strong>内核选择</strong></p>
<ul>
<li>
<p>gentoo</p>
<p>默认内核，支持K8 CPU（包括NUMA支持）和EM64T CPU。</p>
</li>
<li>
<p>gentoo-nofb</p>
<p>与“gentoo”相同，但没有framebuffer支持。</p>
</li>
<li>
<p>memtest86</p>
<p>测试本地RAM的错误。</p>
</li>
</ul>
<p>引导选项可以配合内核进一步调整引导过程的行为。</p>
<p><strong>硬件选择</strong></p>
<ul>
<li>
<p>acpi=on</p>
<p>这个选项载入对 ACPI 的支持，同时也会让 CD 光盘在启动时运行 acpid 守护进程。在系统需要 ACPI 才能正常工作的情况下才需要设置此选项。超线程（Hyperthreading）的支持不需要此选项。</p>
</li>
<li>
<p>acpi=off</p>
<p>彻底禁用 ACPI。这个选项在一些较老的系统上比较有用，同样也是使用 APM 功能的必需项。这个选项也会禁用处理器的超线程支持。</p>
</li>
<li>
<p>console=X</p>
<p>这会启用对一些终端的访问许可。它的第一个参数是设备，默认是 ttyS0， 之后的其它选项请使用逗号分割。默认参数是 9600,8,n,1 。</p>
</li>
<li>
<p>dmraid=X</p>
<p>这会传递参数给 device-mapper RAID 子系统。需要在参数两端加上括号。</p>
</li>
<li>
<p>doapm</p>
<p>这会加载对 APM 驱动的支持。这同时需要 <code>acpi=off</code>.</p>
</li>
<li>
<p>dopcmcia</p>
<p>这会加载对 PCMCIA 和 Cardbus 硬件的支持，并且会使 pcmcia cardmgr 在 CD 启动时被启用. 这只有在从 PCMCIA/Cardbus 设备启动时才需要。</p>
</li>
<li>
<p>doscsi</p>
<p>这会加载对大部分 SCSI 控制器的支持。当从使用 SCSI 内核子系统的 USB 设备启动时需要这个参数。</p>
</li>
<li>
<p>sda=stroke</p>
<p>这会允许用户对整块硬盘进行分区，即使是 BIOS 无法控制的大容量硬盘。这个选项只有在使用老的 BIOS 的机器上才需要。注意，请把 “sda” 替换为需要这么做的设备。</p>
</li>
<li>
<p>ide=nodma</p>
<p>这会强制内核禁用 DMA ，一些 IDE 芯片组和一些 CDROM 的驱动需要这么做才能工作。如果系统无法正常读取 IDE 的 CDROM，可以试试这个选项。这同时也会禁止默认的 hdpram 设置被执行。</p>
</li>
<li>
<p>noapic</p>
<p>这会禁用一些新主板上的高级程序中断控制器（Advanced Programmable Interrupt Controller，APIC），因为这可能会造成一些旧的硬件无法正常工作。</p>
</li>
<li>
<p>nodetect</p>
<p>这会禁止 CD 的全部自动检测功能，包括对硬件的检测和 DHCP 探测。 这有助于对启动失败的 CD 或驱动器进行查错。</p>
</li>
<li>
<p>nodhcp</p>
<p>这会禁用在被发现的网卡上进行 DHCP 探测。这在需要使用固定 IP 的时候很有用。</p>
</li>
<li>
<p>nodmraid</p>
<p>禁用对 device-mapper RAID 的支持，比如板载的IDE/SATA RAID控制器。</p>
</li>
<li>
<p>nofirewire</p>
<p>这禁用了对 “火线”（ Firewire ） 模块的加载。该选项只在“火线”（Firewire）造成 CD 无法正常启动时才需要。</p>
</li>
<li>
<p>nogpm</p>
<p>这禁用对 gpm 控制台的鼠标（gpm console mouse）的支持。</p>
</li>
<li>
<p>nohotplug</p>
<p>这会禁止在启动时加载对热插拔和冷插拔的脚本。这有助于对启动失败的 CD 或驱动器进行查错。</p>
</li>
<li>
<p>nokeymap</p>
<p>这会禁用选择键盘映射（只有不是 US 键盘时才需要进行对键盘映射的设置）。</p>
</li>
<li>
<p>nolapic</p>
<p>这会在单处理器内核里禁用本地APIC。</p>
</li>
<li>
<p>nosata</p>
<p>这会禁止加载 Serial ATA 模块. 这在 SATA 子系统出错时才需要。</p>
</li>
<li>
<p>nosmp</p>
<p>这会在支持 SMP 的内核上禁用 SMP（Symmetric Multiprocessing）。这在为排查与 SMP 相关的驱动或内核错误时很有用。</p>
</li>
<li>
<p>nosound</p>
<p>这会禁止对音频的支持和音量控制。这在音频系统造成问题时很有用。</p>
</li>
<li>
<p>nousb</p>
<p>这会禁止自动加载的 USB 模块。这在 USB 出现问题时很有用。</p>
</li>
<li>
<p>slowusb</p>
<p>这会为慢速的USB CDROM 在启动时添加更多额外的中断，就像 IBM BladeCenter 那样。</p>
</li>
</ul>
<p><strong>逻辑卷／设备管理</strong></p>
<ul>
<li>
<p>dolvm</p>
<p>这会启用 Linux 的逻辑分区管理器（Logical Volume Management）。</p>
</li>
</ul>
<p><strong>其他选项</strong></p>
<ul>
<li>
<p>debug</p>
<p>启用调试代码。这可能会显得乱糟糟的，因为这会向输出大量的数据。</p>
</li>
<li>
<p>docache</p>
<p>这会把整个 CD 运行环境缓存到内存中，这会使用户可以卸载 /mnt/cdrom 并挂载另外一个 CDROM 。这个选项需要至少两倍于 CD 大小的内存空间。</p>
</li>
<li>
<p>doload=X</p>
<p>这会使启动时内存盘（initial ramdisk，initrd）加载这之后列出来的模块和它们的依赖。把“X”替换为模块名称，当需要加载多个模块时请用逗号分割。</p>
</li>
<li>
<p>dosshd</p>
<p>在启动时启用 sshd 服务，这在无人值守安装时很有用。</p>
</li>
<li>
<p>passwd=foo</p>
<p>这会将等号后的字符设置为 root 用户的密码，当使用“dosshd”参数时需要这么做因为默认的 root 密码是留空的。</p>
</li>
<li>
<p>noload=X</p>
<p>这会使启动时内存盘（initial ramdisk，initrd）跳过对某些会造成问题的特定模块的加载。使用方法和“doload”相同。</p>
</li>
<li>
<p>nonfs</p>
<p>禁止在启动时启用 portmap/nfsmount 。</p>
</li>
<li>
<p>nox</p>
<p>这会使启用X的 LiveCD 不自动启动X，而是使用命令行。</p>
</li>
<li>
<p>scandelay</p>
<p>这会使 CD 在启动过程中等待十秒来使一些初始化很慢的设备完成初始化。</p>
</li>
<li>
<p>scandelay=X</p>
<p>这允许用户指定 CD 在启动过程中等待一些初始化很慢的设备完成初始化所需的延迟的时间。把X替换为所需要等待的时间（以秒为单位，只需要填写数字）。</p>
</li>
</ul>
<p><strong>附注</strong>：启动媒介将先检查<code>no*</code>选项，再检查<code>do*</code>选项，所以那些选项可以按照这个顺序覆盖。</p>
<p>现在启动安装媒介，选择一个内核（如果默认的 <strong>gentoo</strong> 的内核不能满足）和引导选项。作为示例，我们引导 <strong>gentoo</strong> 内核启动，并带有<code>dopcmcia</code>作为内核参数：</p>
<pre tabindex="0"><code>boot: gentoo dopcmcia
</code></pre><p>接下来迎接用户的是一个引导屏幕和进度条。如果用来安装系统的是一个非US键盘，确保马上按Alt + F1来切换到详细模式并遵照提示。如果在10秒钟内什么都没有选，则接受默认（US键盘）并继续引导过程。一旦引导过程完成，用户将自动以<em>root</em>超级用户身份登录到“Live”Gentoo Linux环境。当前控制台将显示一个root提示符，并且可以通过按Alt + F2、Alt + F3和Alt + F4切换到其他控制台。按Alt + F1返回到启动时的那个。</p>
<h4 id="额外的硬件配置">额外的硬件配置<a hidden class="anchor" aria-hidden="true" href="#额外的硬件配置">#</a></h4>
<p>当安装媒介启动时，它会尝试检测所有的硬件设备并加载合适的内核模块来支持硬件。在绝大多数的情况下，它工作得很好。然而，在某些情况下它可能没有自动加载系统所需的内核模块。如果 PCI 自动检测错过了一些系统硬件，相应的内核模块就必须手动加载了。</p>
<p>下面例子手工加载了 8139too 模块（它提供对某些类型的网卡的支持）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># modprobe 8139too</span>
</code></pre></div><h4 id="推荐用户账号">推荐：用户账号<a hidden class="anchor" aria-hidden="true" href="#推荐用户账号">#</a></h4>
<p>如果其他人需要访问安装环境，或者需要以非 root 用户的身份在安装媒介上运行命令（例如出于安全原因使用没有 root 特权的 <strong>irssi</strong> 聊天），这时就需要创建额外的用户帐户，并将 root 用户密码设为强密码。</p>
<p>使用 <strong>passwd</strong> 命令来修改 root 用户密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># passwd</span>
New password: <span style="color:#f92672">(</span>Enter the new password<span style="color:#f92672">)</span>
Re-enter password: <span style="color:#f92672">(</span>Re-enter the password<span style="color:#f92672">)</span>
</code></pre></div><p>要创建一个用户账户，先输入他们的信息，然后设置密码。用 <strong>useradd</strong> 和 <strong>passwd</strong> 命令来完成这些操作。</p>
<p>在下面的例子中，创建了一个名为“john”的用户。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># useradd -m -G users john</span>
<span style="color:#75715e"># passwd john</span>
New password: <span style="color:#f92672">(</span>Enter john<span style="color:#e6db74">&#39;s password)
</span><span style="color:#e6db74">Re-enter password: (Re-enter john&#39;</span>s password<span style="color:#f92672">)</span>
</code></pre></div><p>使用 <strong>su</strong> 命令可以从 root 用户（当前用户）切换到新建的用户：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># su - john</span>
</code></pre></div><h4 id="在安装时查看文档">在安装时查看文档<a hidden class="anchor" aria-hidden="true" href="#在安装时查看文档">#</a></h4>
<p><strong>TTYs</strong></p>
<p>要在安装期间查看 Gentoo 安装手册，首先要按照上面的方法创建一个新的用户帐户。然后按 Alt+F2 进入一个新的终端。</p>
<p>在安装期间， 可以用 <strong>links</strong> 命令来浏览 Gentoo 安装手册 - 当然，只有在互联网连接可用的时候才行。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ links https://wiki.gentoo.org/wiki/Handbook:AMD64/zh-cn
</code></pre></div><p>要回到原来的终端，请按 Alt+F1 。</p>
<p><strong>GNU Screen</strong></p>
<p>Screen是官方Gentoo安装介质中默认安装的实用程序。对于经验丰富的Linux爱好者来说，使用 screen 分割窗口查看安装说明，而不是上面提到的多个TTY的方法， 这可能更高效。</p>
<h4 id="推荐启动ssh服务httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle88eb7e58f96e59fbae69cace7b3bbe7bb9f"><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E8%8E%B7%E5%8F%96%E5%9F%BA%E6%9C%AC%E7%B3%BB%E7%BB%9F">推荐：启动SSH服务</a><a hidden class="anchor" aria-hidden="true" href="#推荐启动ssh服务httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle88eb7e58f96e59fbae69cace7b3bbe7bb9f">#</a></h4>
<p>如果你通过的是虚拟机安装，或者同一网络下有其它电脑可以使用，那么使用 ssh 连接上本机，通过复制粘贴命令来操作会更加方便，而 LiveCD 环境下的 sshd 配置为，执行，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano /etc/ssh/sshd_config</span>
</code></pre></div><p>打开 sshd 配置文件，确保如下两个选项</p>
<ul>
<li>PermitRootLogin</li>
<li>PasswordAuthentication</li>
</ul>
<p>前面都没有注释符 <code>#</code> ，后面的值都为 <code>yes</code> ，后按下 Ctrl + X ， y ， Enter 保存退出。之后执行，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># rc-service sshd start</span>
</code></pre></div><p>启用 sshd 服务后，为 LiveCD 环境的 root 用户设置一个密码，如果不想设置复杂密码，可以编辑 /etc/security/passwdqc.conf 文件，将 enforce=everyone 改成 enforce=none 保存后再设置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># passwd root</span>
</code></pre></div><p>之后就可以通过其它电脑/主机连接到此 LiveCD 环境了。</p>
<p><strong>附注</strong>：如果用户登录到系统，他们将看到一个本系统主机密钥需要确认的信息（也就是我们说的密匙指纹）。此行为是典型的并且可以像预期一样与SSH服务器进行初始连接。但是，以后当系统设置好，并有人登录到新安装的系统时，SSH客户端会警告主机密钥已被更改。这是因为现在用户登录 - 对于SSH来讲 - 是一个不同的服务器（即新安装的Gentoo系统，而不是现在正在使用的安装系统环境）。请按照屏幕上的指示，去替换用户端的主机密钥</p>
<p>网络需要能正常工作，sshd 才能使用。请参照 <a href="#%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C">配置网络</a> 的内容继续安装。</p>
<h2 id="配置网络httpswikigentooorgwikihandbookamd64installationnetworking"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Networking">配置网络</a><a hidden class="anchor" aria-hidden="true" href="#配置网络httpswikigentooorgwikihandbookamd64installationnetworking">#</a></h2>
<h3 id="自动网络检测">自动网络检测<a hidden class="anchor" aria-hidden="true" href="#自动网络检测">#</a></h3>
<p>它能够自动检测到么？</p>
<p>如果系统接入到一个有DHCP服务器的以太网络，网络配置非常可能会自动设置。这样的话，安装CD所包含的很多网络命令，比如<strong>ssh</strong>、<strong>scp</strong>、<strong>ping</strong>、<strong>irssi</strong>、<strong>wget</strong>、<strong>links</strong>，以及其他的一些, 都可以立即工作。</p>
<h4 id="识别接口名称">识别接口名称<a hidden class="anchor" aria-hidden="true" href="#识别接口名称">#</a></h4>
<p><strong>ifconfig命令</strong></p>
<h4 id="ifconfig命令">ifconfig命令<a hidden class="anchor" aria-hidden="true" href="#ifconfig命令">#</a></h4>
<p>如果网络已配置，<strong>ifconfig</strong>命令应该会列出一个或多个网络接口（围绕着lo）。在下面的示例中显示为eth0：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ifconfig</span>
eth0      Link encap:Ethernet  HWaddr 00:50:BA:8F:61:7A
          inet addr:192.168.0.2  Bcast:192.168.0.255  Mask:255.255.255.0
          inet6 addr: fe80::50:ba8f:617a/10 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1498792 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1284980 errors:0 dropped:0 overruns:0 carrier:0
          collisions:1984 txqueuelen:100
          RX bytes:485691215 <span style="color:#f92672">(</span>463.1 Mb<span style="color:#f92672">)</span>  TX bytes:123951388 <span style="color:#f92672">(</span>118.2 Mb<span style="color:#f92672">)</span>
          Interrupt:11 Base address:0xe800 
</code></pre></div><p>作为<a href="http://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/">预测的网络接口名称</a>控制的结果, 系统的接口名称可以和旧的eth0命名规则很不一样。近期的安装媒介可能显示常规网络接口名字像是eno0、ens1或enp5s0。查看<strong>ifconfig</strong>输出中找到有你本地网络相关的IP地址的接口。</p>
<p><strong>Tip</strong>：如果使用标准的<strong>ifconfig</strong>命令没有显示出接口，尝试使用带有<code>-a</code>选项的相同的命令。这个选项强制这个工具去显示系统检测到的所有的网络接口，不管他们是up或down状态。如果<strong>ifconfig -a</strong>没有提供结果，则硬件有错误或者接口驱动没有加载到内核中。这些情况都超过本手册的范围。联系 <a href="ircs://irc.libera.chat/#gentoo">#gentoo</a> (<a href="https://web.libera.chat/#gentoo">webchat</a>) 需求支持。</p>
<p><strong>ip命令</strong></p>
<p>作为<strong>ifconfig</strong>的一个备选，<strong>ip</strong>命令可以用来识别接口名称。下面的示例展示了<strong>ip addr</strong>（由于是另外一个系统，所以显示的信息不同于前一个示例）的输出:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ip addr</span>
2: eno1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc pfifo_fast state UP group default qlen <span style="color:#ae81ff">1000</span>
    link/ether e8:40:f2:ac:25:7a brd ff:ff:ff:ff:ff:ff
    inet 10.0.20.77/22 brd 10.0.23.255 scope global eno1
       valid_lft forever preferred_lft forever
    inet6 fe80::ea40:f2ff:feac:257a/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre></div><p>上面的输出读起来可能比另外的更乱一点。在上面的示例中，接口名称直接跟在数字后面；它是eno1。</p>
<p>在本文档的其余部分，手册中假设要操作的网络接口叫作eth0。</p>
<h4 id="测试网络">测试网络<a hidden class="anchor" aria-hidden="true" href="#测试网络">#</a></h4>
<p>尝试ping你的ISP的DNS服务器（可在/etc/resolv.conf中找到）和选择一个网站。这可确信网络正常工作并且网络包可以到达网络，DNS名称解析能正常工作等等。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#e6db74">&#39;nameserver 114.114.114.114&#39;</span> &gt;/etc/resolv.conf
ping -c <span style="color:#ae81ff">3</span> www.gentoo.org
</code></pre></div><p>如果这些都工作，则本章节中其余的部分可跳过，直接跳到安装介绍的下一步骤（<a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks/zh-cn">准备磁盘</a>）。</p>
<h3 id="自动网络配置">自动网络配置<a hidden class="anchor" aria-hidden="true" href="#自动网络配置">#</a></h3>
<p>如果网络没有立即工作，一些安装媒介允许用户使用<strong>net-setup</strong>（针对常规或无线网络），<strong>pppoe-setup</strong>（针对ADSL用户）或 <strong>pptp</strong>（针对PPTP用户）。</p>
<p>如果安装媒介没有包含这些工具，继续<a href="#%E6%89%8B%E5%8A%A8%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C">手动配置网络</a>。</p>
<ul>
<li>常规以太网用户应该继续<a href="#%E9%BB%98%E8%AE%A4%EF%BC%9A%E4%BD%BF%E7%94%A8net-setup">默认：使用net-setup</a></li>
<li>ADSL用户应该继续<a href="#%E5%A4%87%E9%80%89%EF%BC%9A%E4%BD%BF%E7%94%A8PPP">备选：使用PPP</a></li>
<li>PPTP用户应该继续<a href="#%E5%A4%87%E9%80%89%EF%BC%9A%E4%BD%BF%E7%94%A8PPTP">备选：使用PPTP</a></li>
</ul>
<h3 id="默认使用net-setup">默认：使用net-setup<a hidden class="anchor" aria-hidden="true" href="#默认使用net-setup">#</a></h3>
<p>如果网络没有自动配置，最简单的方式是运行<strong>net-setup</strong>脚本来设置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># net-setup eth0</span>
</code></pre></div><p><strong>net-setup</strong>将会询问关于网络环境的一些问题。当所有这些完成后，网络连接就应该工作。以前面的方式测试网络连接。如果测试通过，恭喜！跳过本章节剩余部分并继续<a href="#%E5%87%86%E5%A4%87%E7%A3%81%E7%9B%98">准备磁盘</a>。</p>
<p>如果网络还是不能工作，继续<a href="#%E6%89%8B%E5%8A%A8%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C">手动配置网络</a>。</p>
<h3 id="可选使用ppp">可选：使用PPP<a hidden class="anchor" aria-hidden="true" href="#可选使用ppp">#</a></h3>
<p>假设需要使用PPPoE连接到互联网，安装CD（任何版本）包含ppp来使这件事变得容易。使用提供的<strong>pppoe-setup</strong>脚本来配置连接。设置过程中将询问已连接到你的ADSL调制解调器的以太网设备、用户名和密码、DNS服务器的IP地址，以及是否需要一个简单的防火墙。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># pppoe-setup</span>
<span style="color:#75715e"># pppoe-start</span>
</code></pre></div><p>如果还是有什么错误，再次在etc/ppp/pap-secrets或/etc/ppp/chap-secrets中检查用户名和密码都是正确的，并且确保使用了正确的以太网设备。如果以太网设备不存在，则需要加载合适的网络模块。如果是那样，继续<a href="#%E6%89%8B%E5%8A%A8%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE">手动网络配置</a>将解释如何加载合适的网络模块。</p>
<p>如果所有事都还，继续<a href="#%E5%87%86%E5%A4%87%E7%A3%81%E7%9B%98">准备磁盘</a>。</p>
<h3 id="可选使用pptp">可选：使用PPTP<a hidden class="anchor" aria-hidden="true" href="#可选使用pptp">#</a></h3>
<p>如果需要PPTP支持，使用安装CD提供的<strong>pptpclient</strong>。但是首先确保配置是正确的。编辑/etc/ppp/pap-secrets或/etc/ppp/chap-secrets让它包含正确的用户名/密码组合：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/ppp/chap-secrets</span>
</code></pre></div><p>如果需要，继续调整/etc/ppp/options.pptp：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/ppp/options.pptp</span>
</code></pre></div><p>当所有事都已完成，运行<strong>pptp</strong>（带着一些options.pptp无法设定的选项）来连接到服务器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># pptp &lt;server ipv4 address&gt;</span>
</code></pre></div><p>现在继续<a href="#%E5%87%86%E5%A4%87%E7%A3%81%E7%9B%98">准备磁盘</a>。</p>
<h3 id="手动配置网络">手动配置网络<a hidden class="anchor" aria-hidden="true" href="#手动配置网络">#</a></h3>
<h4 id="加载适当的网络模块">加载适当的网络模块<a hidden class="anchor" aria-hidden="true" href="#加载适当的网络模块">#</a></h4>
<p>安装光盘在启动时，会尝试检测所有硬件设备并加载适当的内核模块（驱动程序）以支持你的硬件。绝大多数情况下，它都做得非常好。尽管如此，在某些情况下它可能还是无法自动载入你所需要的内核模块。</p>
<p>如果<strong>net-setup</strong>或<strong>pppoe-setup</strong>都失败，则可能是网络没有立即被找到。也就是说用户可能需要手动加载合适的内核模块。</p>
<p>要找出什么内核模块提供网络，使用<strong>ls</strong>命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ls /lib/modules/`uname -r`/kernel/drivers/net</span>
</code></pre></div><p>如果找到一个针对网络设备的驱动，使用<strong>modprobe</strong>来加载内核模块。比如，要加载pcnet32模块：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># modprobe pcnet32</span>
</code></pre></div><p>要检查网卡现在是否检测到，使用<strong>ifconfig</strong>。一个检测到的网卡应该在结果中像这样（再一次，这里的eth0只是一个示例）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ifconfig eth0</span>
eth0      Link encap:Ethernet  HWaddr FE:FD:00:00:00:00  
          BROADCAST NOARP MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:0 <span style="color:#f92672">(</span>0.0 b<span style="color:#f92672">)</span>  TX bytes:0 <span style="color:#f92672">(</span>0.0 b<span style="color:#f92672">)</span>
</code></pre></div><p>不过如果你得到如下错误信息，说明没有检测到网卡：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ifconfig eth0</span>
eth0: error fetching interface information: Device not found
</code></pre></div><p>系统中可用网络接口命名可以通过/sys文件系统列出。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ls /sys/class/net</span>
dummy0  eth0  lo  sit0  tap0  wlan0
</code></pre></div><p>在上面的示例中，找到了6个接口。eth0是最像（有线）以太网络适配器，而wlan0 是无线的。</p>
<p>假设现在网络已经检测到了，重新尝试<strong>net-setup</strong>或<strong>pppoe-setup</strong>（现在应该工作了），但是对于铁杆的人，我们还是要解释如何手动配置网络。</p>
<p>基于你的网络从下面的章节中选择一个进行设置：</p>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8DHCP">使用DHCP</a> 针对自动获取IP</li>
<li><a href="#%E5%87%86%E5%A4%87%E6%97%A0%E7%BA%BF%E8%AE%BF%E9%97%AE">准备无线访问</a> 如果使用无线网络</li>
<li><a href="#%E7%BD%91%E7%BB%9C%E6%9C%AF%E8%AF%AD%E8%A7%A3%E8%AF%BB">了解网络术语</a> 解释了关于网络的基础</li>
<li><a href="#%E4%BD%BF%E7%94%A8ifconfig%E5%92%8Croute">使用ifconfig和route</a> 解释了如何手动设置网络</li>
</ul>
<h4 id="使用dhcp">使用DHCP<a hidden class="anchor" aria-hidden="true" href="#使用dhcp">#</a></h4>
<p>DHCP（动态主机配置协议）使自动接受网络信息（IP地址、掩码、广播地址、网关、名称服务器等）变得容易。这只在网络中有DHCP服务器（或者如果ISP提供商提供一个DHCP服务）时有用。要使一个网络接口自动接受信息，使用<strong>dhcpcd</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># dhcpcd eth0</span>
</code></pre></div><p>一些网络管理员要求你使用DHCP服务器所提供的主机名和域名。 这种情况下请用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># dhcpcd -HD eth0</span>
</code></pre></div><p>如果这个工作的话（试着ping一些Internet服务器，像Google的8.8.8.8 或者 Cloudflare的 1.1.1.1 译者注：中国的114.114.114.114），则所有事情都设置好了并可以继续。跳过剩下的章节并继续到<a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks/zh-cn">准备磁盘</a>。</p>
<h4 id="准备无线网络链接">准备无线网络链接<a hidden class="anchor" aria-hidden="true" href="#准备无线网络链接">#</a></h4>
<p><strong>附注</strong>：可能只有特定的架构支持<strong>iw</strong>命令。如果这个命令不可用，检查<a href="https://packages.gentoo.org/packages/net-wireless/iw">net-wireless/iw</a>包是否可用于当前架构。除非安装<a href="https://packages.gentoo.org/packages/net-wireless/iw">net-wireless/iw</a>包，否则<strong>iw</strong>命令将一直不可用。</p>
<p>当使用一块无线（802.11）网卡，在继续之前需要先配置无线设置。要查看当前无线网卡的设置，你可以使用<strong>iw</strong>。运行<strong>iw</strong>可能会显示如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># iw dev wlp9s0 info</span>
Interface wlp9s0
	ifindex <span style="color:#ae81ff">3</span>
	wdev 0x1
	addr 00:00:00:00:00:00
	type managed
	wiphy <span style="color:#ae81ff">0</span>
	channel <span style="color:#ae81ff">11</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">2462</span> MHz<span style="color:#f92672">)</span>, width: <span style="color:#ae81ff">20</span> MHz <span style="color:#f92672">(</span>no HT<span style="color:#f92672">)</span>, center1: <span style="color:#ae81ff">2462</span> MHz
	txpower 30.00 dBm
</code></pre></div><p>检查当前连接：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># iw dev wlp9s0 link</span>
Not connected.
</code></pre></div><p>或</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># iw dev wlp9s0 link</span>
Connected to 00:00:00:00:00:00 <span style="color:#f92672">(</span>on wlp9s0<span style="color:#f92672">)</span>
	SSID: GentooNode
	freq: <span style="color:#ae81ff">2462</span>
	RX: <span style="color:#ae81ff">3279</span> bytes <span style="color:#f92672">(</span><span style="color:#ae81ff">25</span> packets<span style="color:#f92672">)</span>
	TX: <span style="color:#ae81ff">1049</span> bytes <span style="color:#f92672">(</span><span style="color:#ae81ff">7</span> packets<span style="color:#f92672">)</span>
	signal: -23 dBm
	tx bitrate: 1.0 MBit/s
</code></pre></div><p><strong>附注</strong>：一些无线网卡的设备名可能是wlan0或ra0而不是wlp9s0。运行<strong>ip link</strong> 来识别正确的设备名称。</p>
<p>对于大多数用户，只需要两个设置来连接，即ESSID（也称无线网络名称）和可选的WEP密钥。</p>
<ul>
<li>首先，确保接口处于活动状态：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ip link set dev wlp9s0 up</span>
</code></pre></div><ul>
<li>连接到名为“GentooNode”的开放网络：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># iw dev wlp9s0 connect -w GentooNode</span>
</code></pre></div><ul>
<li>设置一个WEP密钥：使用<code>d:</code>前缀：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># iw dev wlp9s0 connect -w GentooNode key 0:d:1234123412341234abcd</span>
</code></pre></div><ul>
<li>用ASCII WEP密钥连接：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># iw dev wlp9s0 connect -w GentooNode key 0:some-password</span>
</code></pre></div><p><strong>附注</strong>：如果无线网络配置为WPA或WPA2，则需要使用<strong>wpa_supplicant</strong>。关于为Gentoo Linux配置无线网络的更多信息，请阅读Gentoo手册中的<a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Networking/Wireless">无线网络章节</a>。</p>
<p>使用<strong>iw dev wlp9s0 link</strong>确认无线设置。如果无线已经工作，继续按下一章节（<a href="#%E7%BD%91%E7%BB%9C%E6%9C%AF%E8%AF%AD%E8%A7%A3%E8%AF%BB">了解网络术语</a>）配置IP级别的网络选项或者使用前面描述的<strong>net-setup</strong>工具。</p>
<h4 id="网络术语解读">网络术语解读<a hidden class="anchor" aria-hidden="true" href="#网络术语解读">#</a></h4>
<p>如果以上所做的全部失败，你将不得不手动配置你的网络。这其实一点也不难。不过，你需要熟悉一些网络术语，才能配置好网络令自己满意。读完本节之后，你将了解到什么是网关，子网掩码是作什么用的，广播地址是如何形成的，以及为什么需要名称服务器。</p>
<p>在网络中，主机通过它们的IP地址（互联网协议地址）来标识。这个地址被看为是由四个0到255的数字来组成。很好，至少在使用IPv4（IP版本4）时。实事上，这样的一个IPv4地址包括32个位（1和0）。让我们来看一个示例：</p>
<pre tabindex="0"><code>IP地址（数字）：   192.168.0.2
IP地址（位）：     11000000 10101000 00000000 00000010
                   -------- -------- -------- --------
                      192      168       0        2
</code></pre><p><strong>附注</strong>：比IPv4更成功的IPv6使用128位（1和0）。在这章节中，我们只关注IPv4地址。</p>
<p>在所有可访问到的网络里，这样的IP地址跟主机是一一对应的（比如你能够连接到的每台主机必须拥有一个唯一的IP地址）。为了区别一个网络内部和外部的主机，IP地址被分为两个部分：网络部分和主机部分。</p>
<p>由一堆1后面跟着一堆0的掩码写出了网络的分离。IP映射到1的部分是网络部分，剩下的是主机部分。通常，掩码可以写成IP地址。</p>
<pre tabindex="0"><code>IP地址：       192      168       0        2
            11000000 10101000 00000000 00000010
掩码：      11111111 11111111 11111111 00000000
               255      255      255       0
           +--------------------------+--------+
                       网络              主机
</code></pre><p>换句话说，192.168.0.14是示例网络的一部分，但192.168.1.2不是。</p>
<p>广播地址是一个拥有相同网络部分，但是主机部分全是1的IP地址。网络上的每一个主机都监听这个IP地址。它的真正用途是用来广播包。</p>
<pre tabindex="0"><code>IP地址：       192      168       0        2
            11000000 10101000 00000000 00000010
广播：      11000000 10101000 00000000 11111111
               192      168       0       255
           +--------------------------+--------+
                       网络              主机
</code></pre><p>了能在互联网上冲浪，网络中的每个主机必须知道哪个主机共享着互联网连接。这个主机叫作网关。它同样是一台常规主机，它有一个常规IP地址（比如192.168.0.1）。</p>
<p>之前我们说每台主机都有它自己的IP地址。要通过名称来到达这台主机（代替一个IP地址）我们需要一个服务去翻译一个名称（比如dev.gentoo.org）到一个IP地址（64.5.62.82）。这样的服务叫做<em>名称服务</em>。要使用这样的服务，需要在/etc/resolv.conf中定义所需的名称服务器。</p>
<p>有些情况下，网关同时也是名称服务器。不然的话，需要在这个文件中添加ISP提供的名称服务器。</p>
<p>总结一下，在继续之前需要下面的信息：</p>
<table>
<thead>
<tr>
<th style="text-align:left">网络项目</th>
<th style="text-align:left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">系统IP地址</td>
<td style="text-align:left">192.168.0.2</td>
</tr>
<tr>
<td style="text-align:left">掩码</td>
<td style="text-align:left">255.255.255.0</td>
</tr>
<tr>
<td style="text-align:left">广播</td>
<td style="text-align:left">192.168.0.255</td>
</tr>
<tr>
<td style="text-align:left">网关</td>
<td style="text-align:left">192.168.0.1</td>
</tr>
<tr>
<td style="text-align:left">名称服务器</td>
<td style="text-align:left">195.130.130.5, 195.130.130.133</td>
</tr>
</tbody>
</table>
<h4 id="使用ifconfig和route">使用ifconfig和route<a hidden class="anchor" aria-hidden="true" href="#使用ifconfig和route">#</a></h4>
<p>设置网络由三步组成：</p>
<ol>
<li>使用<strong>ifconfig</strong>指派一个IP地址</li>
<li>使用<strong>route</strong>设置到网关的路由</li>
<li>通过/etc/resolv.conf设置名称服务器的IP完成</li>
</ol>
<p>要指派一个IP地址，需要IP地址、广播地址和掩码。运行下面的命令，替换${IP_ADDR}为正确的IP地址、${BROADCAST}为正确的广播地址以及${NETMASK}为正确的掩码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ifconfig eth0 ${IP_ADDR} broadcast ${BROADCAST} netmask ${NETMASK} up</span>
</code></pre></div><p>用<strong>route</strong>设置路由。替换${GATEWAY}为正确的网络IP地址：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># route add default gw ${GATEWAY}</span>
</code></pre></div><p>现在打开/etc/resolv.conf：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/resolv.conf</span>
</code></pre></div><p>使用下面的模板填入名称服务器。确保替换${NAMESERVER1}和${NAMESERVER2}为合适的名称服务器地址：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nameserver <span style="color:#e6db74">${</span>NAMESERVER1<span style="color:#e6db74">}</span>
nameserver <span style="color:#e6db74">${</span>NAMESERVER2<span style="color:#e6db74">}</span>
</code></pre></div><p>就是这样。现在通过ping一些互联网服务器（像Google的8.8.8.8 或者 Cloudflare的 1.1.1.1 译者注：中国的114.114.114.114）来测试网络。如果这个工作的话，再次恭喜。继续到<a href="#%E5%87%86%E5%A4%87%E7%A3%81%E7%9B%98">准备磁盘</a>。</p>
<h2 id="准备磁盘httpswikigentooorgwikihandbookamd64installationdisks"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks">准备磁盘</a><a hidden class="anchor" aria-hidden="true" href="#准备磁盘httpswikigentooorgwikihandbookamd64installationdisks">#</a></h2>
<h3 id="块设备简介">块设备简介<a hidden class="anchor" aria-hidden="true" href="#块设备简介">#</a></h3>
<h4 id="块设备">块设备<a hidden class="anchor" aria-hidden="true" href="#块设备">#</a></h4>
<p>让我们来好好看看Gentoo Linux以及普通Linux中有关磁盘方面的知识，包括块设备、分区和Linux文件系统。一旦磁盘的来龙去脉都了解了，我们将设置分区和文件系统以进行安装。</p>
<p>首先，让我们来看看块设备。最著名的块设备可能是代表Linux系统第一块磁盘的/dev/sda。SCSI和SATA磁盘全标为/dev/sd*；甚至IDE磁盘在libata内核框架下也标为/dev/sd*。当使用老设备框架时，第一个IDE磁盘是/dev/hda。</p>
<p>下表将帮助读者确定系统上找到某种类型的块设备的位置：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Type of device</th>
<th style="text-align:left">Default device handle</th>
<th style="text-align:left">Editorial notes and considerations</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SATA, SAS, SCSI, or USB flash</td>
<td style="text-align:left">/dev/sda</td>
<td style="text-align:left">Found on hardware from roughly 2007 until the present, this device handle is perhaps the most commonly used in Linux. These types of devices can be connected via the <a href="https://en.wikipedia.org/wiki/Serial_ATA">SATA bus</a>, <a href="https://en.wikipedia.org/wiki/SCSI">SCSI</a>, <a href="https://en.wikipedia.org/wiki/USB">USB</a> bus as block storage. As example, the first partition on the first SATA device is called /dev/sda1.</td>
</tr>
<tr>
<td style="text-align:left">NVM Express (NVMe)</td>
<td style="text-align:left">/dev/nvme0n1</td>
<td style="text-align:left">The latest in solid state technology, <a href="https://en.wikipedia.org/wiki/NVM_Express">NVMe</a> drives are connected to the PCI Express bus and have the fastest transfer block speeds on the market. Systems from around 2014 and newer may have support for NVMe hardware. The first partition on the first NVMe device is called /dev/nvme0n1p1.</td>
</tr>
<tr>
<td style="text-align:left">MMC, eMMC, and SD</td>
<td style="text-align:left">/dev/mmcblk0</td>
<td style="text-align:left"><a href="https://en.wikipedia.org/wiki/MultiMediaCard#eMMC">embedded MMC</a> devices, SD cards, and other types of memory cards can be useful for data storage. That said, many systems may not permit booting from these types of devices. It is suggested to <strong>not</strong> use these devices for active Linux installations; rather consider using them to transfer files, which is their design goal. Alternatively they could be useful for short-term backups.</td>
</tr>
</tbody>
</table>
<p>上面的块设备代表磁盘的抽象接口。用户程序可以使用这些块设备来与你的磁盘进行交互，而无需担心驱动器到底是 SATA，SCSI 还是其他什么东西。该程序可以把磁盘当作一系列连续的，可随机访问的 4096 字节块（4K）的存储。</p>
<h4 id="分区表">分区表<a hidden class="anchor" aria-hidden="true" href="#分区表">#</a></h4>
<p>虽然理论上可以用一整块磁盘来安装一个Linux系统（比如当创建一个 btrfs RAID时），但是实践中几乎从不这样做。实际上，一块磁盘可以被分成小一些的、更容易管理的块设备。在 <strong>amd64</strong> 系统里，这被称为分区。有两个标准的分区技术可以被使用：MBR（有时也称为 DOS 磁盘标签）和GPT；这些与两种引导过程类型相关：传统 BIOS 引导和 UEFI 引导。</p>
<p><strong>GUID 分区表 (GPT)</strong></p>
<p><em>GUID 分区表 (GPT)<em>设置（也称为 GPT 磁盘标签）对分区使用 64 位标识符。它用来存储分区信息的空间也远比 MBR 分区表（DOS 磁盘标签）的512字节要大，GPT磁盘它也不对分区的数量作限制。分区的</em>大小</em>限制可以达到 8 ZiB（zebibytes）。</p>
<p>译者注：</p>
<ul>
<li>1ZiB = 1,024 EiB</li>
<li>1EiB = 1024 PiB</li>
<li>1PiB = 1024 TiB</li>
<li>1TiB = 1024 GiB</li>
<li>1GiB = 1024 MiB</li>
<li>1MiB = 1024 KiB</li>
<li>1KiB = 1024 B</li>
</ul>
<p>当操作系统和系统固件之间的软件接口是UEFI (相对于BIOS)时，GPT几乎是必选的，因为这里 DOS 磁盘标签会引起很多兼容性问题。</p>
<p>GPT还利用校验和和冗余。 它携带CRC32校验和以检测报头和分区表中的错误，并在磁盘的末尾有一个备份GPT。 此备份表可用于恢复磁盘开头附近主GPT的损坏。</p>
<p><strong>Important</strong>：关于 GPT 有一些注意事项：</p>
<ul>
<li>在基于 BIOS 的计算机上使用 GPT 是可行的，但不能与 Microsoft Windows 操作系统进行双重引导。原因是如果 Microsoft Windows 检测到 GPT 分区标签，它将以 UEFI 模式启动。</li>
<li>一些配置为以 BIOS/CSM/legacy 模式启动的有问题的（旧）主板固件在从 GPT 标记的磁盘启动时也可能存在问题。</li>
</ul>
<p><strong>主引导记录 (MBR) 或 DOS 引导扇区</strong></p>
<p><a href="https://en.wikipedia.org/wiki/Master_boot_record">主引导记录</a>引导扇区（也称为 DOS 引导扇区或 DOS 磁盘标签）于 1983 年首次在 PC DOS 2.x 中引入。 MBR 使用 32 位标识符作为分区的起始扇区和长度，并支持三种分区类型：主分区、扩展分区和逻辑分区。主分区的信息存储在主引导记录本身——磁盘最开始的一个非常小的（通常是 512 字节）位置。由于空间很小，因此仅支持四个主分区（例如，/dev/sda1 到 /dev/sda4）。</p>
<p>为了支持更多的分区，可以将 MBR 中的主分区之一标记为<em>扩展</em>分区。然后，该分区可以包含其它逻辑分区（分区内的分区）。</p>
<p><strong>重要</strong>：虽然大多数主板制造商仍然支持，但 MBR 引导扇区及其相关的分区限制被认为是传统的分区方式。除非使用 2010 之前的硬件，否则最好使用 <a href="https://en.wikipedia.org/wiki/GUID_Partition_Table">GUID 分区表</a> 对磁盘进行分区。必须继续进行设置类型的读者应了解以下信息：</p>
<ul>
<li>大多数 2010 年后的主板都有接受用 MBR 引导扇区作为传统（受支持但不理想的）引导模式。</li>
<li>由于使用 32 位标识符，MBR 中的分区表无法处理大于 2 TiB 的存储空间。</li>
<li>除非创建扩展分区，否则 MBR 最多支持四个分区。</li>
<li>此设置不提供备份引导扇区，因此如果某些内容覆盖分区表，所有分区信息将丢失。</li>
</ul>
<p>也就是说，在 AWS 等虚拟化云环境中仍经常使用 MBR 和 BIOS 启动。</p>
<p>手册作者建议读者安装Gentoo时尽可能使用 [GPT](#使用 GPT for UEFI 对磁盘进行分区) 。</p>
<h4 id="高级存储">高级存储<a hidden class="anchor" aria-hidden="true" href="#高级存储">#</a></h4>
<p><strong>amd64</strong> 安装 CD 提供了对逻辑卷管理器 (LVM) 的支持。 LVM 通过增加分区设置提供的灵活性。它允许将分区和磁盘组合到卷组中，并在快速的固态硬盘上为慢速的机械硬盘定义 RAID 组或缓存。下面的安装说明将侧重于&quot;常规&quot;分区，如果强烈需要 LVM，请访问 <a href="https://wiki.gentoo.org/wiki/LVM">LVM</a> 文章了解更多详情。新手请注意：LVM虽然完全支持 ，但不在本指南的范围内。</p>
<h4 id="默认分区方案">默认分区方案<a hidden class="anchor" aria-hidden="true" href="#默认分区方案">#</a></h4>
<p>在本手册的其余部分，我们将讨论和解释两种情况：1) GPT 分区表和 UEFI 引导，以及 2) MBR 分区表和传统 BIOS 引导。虽然可以混合搭配，但这超出了本手册的范围。如上所述，现代设备应该使用 GPT 分区表和 UEFI 引导；作为此规则的一个例外，MBR 和 BIOS 引导依然经常用于虚拟化（云）环境。</p>
<p>以下分区方案将用作一个简单的示例布局：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Partition</th>
<th style="text-align:left">Filesystem</th>
<th style="text-align:left">Size</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">/dev/sda1</td>
<td style="text-align:left">fat32 (UEFI) or ext4 (BIOS)</td>
<td style="text-align:left">256M</td>
<td style="text-align:left">Boot/EFI system partition</td>
</tr>
<tr>
<td style="text-align:left">/dev/sda2</td>
<td style="text-align:left">(swap)</td>
<td style="text-align:left">RAM size * 2</td>
<td style="text-align:left">Swap partition</td>
</tr>
<tr>
<td style="text-align:left">/dev/sda3</td>
<td style="text-align:left">ext4</td>
<td style="text-align:left">Rest of the disk</td>
<td style="text-align:left">Root partition</td>
</tr>
</tbody>
</table>
<p>如果这些信息已经足够，高级读者可以直接跳转到实际分区操作。</p>
<p><strong>fdisk</strong> 和 <strong>parted</strong> 都是分区实用程序。 <strong>fdisk</strong> 是众所周知的，稳定的，推荐用于 MBR 分区布局分区工具。 <strong>parted</strong> 是最早支持 GPT 分区的 Linux 块设备管理的分区工具之一，并提供了替代方案。此处使用 <strong>fdisk</strong> 是因为它具有更好的基于文本的用户界面。</p>
<p>在进行创建分区的指导之前，关于分区方案和常见陷阱我们会先介绍更多的细节。</p>
<h3 id="设计一个分区方案">设计一个分区方案<a hidden class="anchor" aria-hidden="true" href="#设计一个分区方案">#</a></h3>
<h4 id="多少个分区以及多大">多少个分区以及多大？<a hidden class="anchor" aria-hidden="true" href="#多少个分区以及多大">#</a></h4>
<p>分区数量高度依赖于环境。比如，如果有很多个用户，则建议有一个独立的 /home/，以增强安全性及便于备份。如果安装 Gentoo 来做邮件服务器，则 /var/ 应该独立，因为所有的邮件都储存于 /var/。选择一个正确的文件系统将会获得最大化的性能。游戏服务器应该有一个独立的 /opt/，因为大多数游戏服务器都安装在那里。原因也和 /home/ 目录一样：安全和备份。在大多数场景下，应该保持 /usr/ 大一些：不仅是因为它包含多数的应用程序，还因为它通常还托管着 Gentoo ebuild 存储库（默认情况下位于 /var/db/repos/gentoo ），占用大约 650 MiB 的空间。这个磁盘空间的估计值默认不包括 /var/cache/ 下的 binpkgs/ 和 distfiles/ 目录。</p>
<p>在Gentoo的大多数情况下，/usr和/var应该保持相对较大的容量。/usr 包含系统上的大多数应用程序和Linux内核源（/usr/src 下）。默认情况下，/var 包含 gentoo ebuild存储库（位于/var/db/repos/gentoo），通常会消耗大约650 MiB（这取决于文件系统）的磁盘空间。此空间估计不包括/var/cache/distfiles（source files）和/var/cache/binpkgs（binary packages）目录。</p>
<p>分区的数量和大小取决于权衡利弊后根据实际情况选择最佳选项。单独的分区或卷具有以下优点：</p>
<ul>
<li>为每个分区或者卷选择性能最好的文件系统。</li>
<li>当一个失控的工具持续向一个分区或卷写文件时，也不至于让整个系统由于无可用空间而无法运行。</li>
<li>如果有必要，可以简化文件系统检查，多个检查可以并行的完成（尽管使用多个磁盘比使用多个分区更多地实现了这一优势）。</li>
<li>可以通过在挂载一些分区或卷时使用只读、<code>nosuid</code>（忽略setuid属性）、<code>noexec</code>（忽略可执行属性）等来增加安全性。</li>
</ul>
<p>但是，多个分区也有一些缺点：</p>
<ul>
<li>如果配置不正确，系统可能在一个分区上有很多可用空间，而在另一个分区上可用空间很少。</li>
<li>/usr/ 的单独分区可能需要管理员使用 initramfs 引导，以便在其他引导脚本启动之前挂载该分区。由于 initramfs 的生成和维护超出了本手册的范围，<strong>我们建议新手不要为 /usr/ 使用单独的分区</strong>。</li>
<li>SCSI 和 SATA 也有 15 个分区的限制，除非磁盘使用 GPT 标签。</li>
</ul>
<p><strong>附注</strong>：如果你打算使用 Systemd，/usr/ 必须在启动时可用，作为根文件系统的一部分或通过 initramfs 挂载。</p>
<h4 id="那么swap空间呢">那么swap空间呢？<a hidden class="anchor" aria-hidden="true" href="#那么swap空间呢">#</a></h4>
<p>对于swap空间，没有一个完美值。swap空间的目的是当内存（RAM）有压力时为内核提供磁盘存储。一个swap空间允许内核将看过来稍后不会被访问的内存页面移动到磁盘（swap或者page-out）、施放内存。当然，如果那块内存突然要使用到，需要花一些时间（相比较内存，硬盘是非常慢的）将这些页面需要放回到内存中（page-in）。</p>
<p>如果系统不运行很需要内存的应用程序或系统有足够多的可能内存，则不需要太多的swap空间。不过，swap空间还用来在休眠时储存整个内存。如果一个系统需要休眠，则必须需要大一点的swap空间，通常至少为系统安装的内存数量。</p>
<p>作为一般规则，建议交换空间大小为内部存储器 (RAM) 的两倍。对于具有多个硬盘的系统，明智的做法是在每个磁盘上创建一个交换分区，以便它们可以用于并行读/写操作。当必须访问交换空间中的数据时，磁盘交换的速度越快，系统运行的速度就越快。在机械和固态磁盘之间进行选择时，最好将交换放在 SSD 上以提高性能。此外，交换文件可以用作交换分区的替代方案；这对于磁盘空间非常有限的系统来说非常有趣。</p>
<h4 id="什么是-efi-系统分区-esp">什么是 EFI 系统分区 (ESP)？<a hidden class="anchor" aria-hidden="true" href="#什么是-efi-系统分区-esp">#</a></h4>
<p>在使用由 UEFI 引导（而不是 BIOS）的操作系统上安装 Gentoo 时，创建 EFI 系统分区 (ESP) 很重要。下面的说明包含正确处理此操作所需的关键点。 <strong>在 BIOS/Legacy 模式下启动时不需要 EFI 系统分区。</strong></p>
<p>ESP <em>必须</em>是 FAT 变体（有时在 Linux 系统上显示为 <em>vfat</em>）。官方 [UEFI 规范](<a href="http://www.uefi.org/sites/default/files/resources/UEFI">http://www.uefi.org/sites/default/files/resources/UEFI</a> 2_5.pdf) 表示 UEFI 固件将识别 FAT12、16 或 32 文件系统，但建议使用 FAT32。分区后，相应地格式化 ESP：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkfs.fat -F 32 /dev/sda1</span>
</code></pre></div><p><strong>警告</strong>：如果 ESP 没有使用 FAT 变体进行格式化，那么系统的 UEFI 固件将找不到引导加载程序（或 Linux 内核）并且很可能无法引导系统！</p>
<h4 id="什么是bios引导分区">什么是BIOS引导分区？<a hidden class="anchor" aria-hidden="true" href="#什么是bios引导分区">#</a></h4>
<p>只有在 BIOS/Legacy 模式下将 GPT 分区布局与 GRUB2 结合时，才需要 BIOS 引导分区。 **在 EFI/UEFI 模式下引导时不需要它，使用 MBR 表时也不需要它。**它是一个非常小的分区（1 到 2 MB），像 GRUB2 这样的可以在其中放置超出容量的引导加载程序。本指南中不会使用它。</p>
<h3 id="使用-gpt-for-uefi-对磁盘进行分区">使用 GPT for UEFI 对磁盘进行分区<a hidden class="anchor" aria-hidden="true" href="#使用-gpt-for-uefi-对磁盘进行分区">#</a></h3>
<p>以下部分解释了如何使用 <strong>fdisk</strong> 为 GPT/UEFI 引导安装创建示例分区布局。范例分区布局我们在前面已经提到过了。</p>
<table>
<thead>
<tr>
<th style="text-align:left">Partition</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">/dev/sda1</td>
<td style="text-align:left">EFI system (and boot) partition</td>
</tr>
<tr>
<td style="text-align:left">/dev/sda2</td>
<td style="text-align:left">Swap partition</td>
</tr>
<tr>
<td style="text-align:left">/dev/sda3</td>
<td style="text-align:left">Root partition</td>
</tr>
</tbody>
</table>
<p>请您根据自己的实际需要来调整您的分区布局。</p>
<h4 id="查看当前分区布局">查看当前分区布局<a hidden class="anchor" aria-hidden="true" href="#查看当前分区布局">#</a></h4>
<p><strong>fdisk</strong>是一个流行的和强大的分区工具。用<strong>fdisk</strong>向磁盘开火吧！（在我们的例子里，我们使用/dev/sda）:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># fdisk /dev/sda</span>
</code></pre></div><p>使用 p 键来显示磁盘当前的分区配置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>:p
Disk /dev/sda: 28.89 GiB, <span style="color:#ae81ff">31001149440</span> bytes, <span style="color:#ae81ff">60549120</span> sectors
Disk model: DataTraveler 2.0
Units: sectors of <span style="color:#ae81ff">1</span> * 512 <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span> bytes
Sector size <span style="color:#f92672">(</span>logical/physical<span style="color:#f92672">)</span>: <span style="color:#ae81ff">512</span> bytes / <span style="color:#ae81ff">512</span> bytes
I/O size <span style="color:#f92672">(</span>minimum/optimal<span style="color:#f92672">)</span>: <span style="color:#ae81ff">512</span> bytes / <span style="color:#ae81ff">512</span> bytes
Disklabel type: gpt
Disk identifier: 21AAD8CF-DB67-0F43-9374-416C7A4E31EA
 
Device        Start      End  Sectors  Size Type
/dev/sda1      <span style="color:#ae81ff">2048</span>   <span style="color:#ae81ff">526335</span>   <span style="color:#ae81ff">524288</span>  256M EFI System
/dev/sda2    <span style="color:#ae81ff">526336</span>  <span style="color:#ae81ff">2623487</span>  <span style="color:#ae81ff">2097152</span>    1G Linux swap
/dev/sda3   <span style="color:#ae81ff">2623488</span> <span style="color:#ae81ff">19400703</span> <span style="color:#ae81ff">16777216</span>    8G Linux filesystem
/dev/sda4  <span style="color:#ae81ff">19400704</span> <span style="color:#ae81ff">60549086</span> <span style="color:#ae81ff">41148383</span> 19.6G Linux filesystem
</code></pre></div><p>这块特定的磁盘被配置为容纳 2 个 Linux 文件系统（每个都有一个相应的分区列为“Linux”）以及一个交换分区（列为“Linux swap”）。</p>
<h4 id="创建一个新的磁盘标签删除所有分区">创建一个新的磁盘标签/删除所有分区<a hidden class="anchor" aria-hidden="true" href="#创建一个新的磁盘标签删除所有分区">#</a></h4>
<p>输入 g 在磁盘上创建一个新的 GPT 磁盘标签；这将删除所有现有分区。</p>
<pre tabindex="0"><code>Command (m for help):g
Created a new GPT disklabel (GUID: 87EA4497-2722-DF43-A954-368E46AE5C5F).
</code></pre><p>对于现有的 GPT 磁盘标签（参见上面 p 的输出），或者考虑从磁盘中一一删除现有分区。输入 d 来删除一个分区。例如，要删除现有的 /dev/sda1：</p>
<pre tabindex="0"><code>Command (m for help):d
Partition number (1-4): 1
</code></pre><p>这个分区已经计划被删除了，当您用p键打印分区清单时它将不会被显示了，但此时它还未被实际删除，直到改变被真正保存。这将允许用户在操作错误后中止——此时，输入q并按Enter可以立即防止分区被删除。</p>
<p>重复敲击 p来打印分区清单，然后敲击 d键和分区号码来删除它。最终，分区表将变得空空如也。</p>
<pre tabindex="0"><code>Command (m for help):p
Disk /dev/sda: 28.89 GiB, 31001149440 bytes, 60549120 sectors
Disk model: DataTraveler 2.0
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: 87EA4497-2722-DF43-A954-368E46AE5C5F
</code></pre><p>现在在内存中的分区表已经空了，我们是时候来创建分区了。</p>
<h4 id="创建-efi-系统分区-esp">创建 EFI 系统分区 (ESP)<a hidden class="anchor" aria-hidden="true" href="#创建-efi-系统分区-esp">#</a></h4>
<p>首先创建一个小的 EFI 系统分区，该分区也将挂载为 /boot。输入 n 创建一个新分区，然后输入 1 选择第一个分区。当提示输入第一个扇区时，确保它从 2048（引导加载程序可能需要）开始并输入 Enter。当提示输入最后一个扇区时，输入 +256M 创建一个大小为 256 MB 的分区：</p>
<pre tabindex="0"><code>Command (m for help):n
Partition number (1-128, default 1): 1
First sector (2048-60549086, default 2048): 
Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-60549086, default 60549086): +256M
 
Created a new partition 1 of type 'Linux filesystem' and of size 256 MiB.
</code></pre><p>将分区标记为 EFI 系统分区：</p>
<pre tabindex="0"><code>Command (m for help):t
Selected partition 1
Partition type (type L to list all types): 1
Changed type of partition 'Linux filesystem' to 'EFI System'.
</code></pre><h4 id="创建swap分区">创建swap分区<a hidden class="anchor" aria-hidden="true" href="#创建swap分区">#</a></h4>
<p>接下来，要创建交换分区，请输入 n 创建一个新分区，然后输入 2 创建第二个分区 /dev/sda2。当提示输入第一个扇区时，输入 Enter。当提示输入最后一个扇区时，输入 +4G（或交换空间所需的任何其他大小）以创建大小为 4GB 的分区。</p>
<pre tabindex="0"><code>Command (m for help):n
Partition number (2-128, default 2): 
First sector (526336-60549086, default 526336): 
Last sector, +/-sectors or +/-size{K,M,G,T,P} (526336-60549086, default 60549086): +4G
 
Created a new partition 2 of type 'Linux filesystem' and of size 4 GiB.
</code></pre><p>完成后，输入t设置分区类型，2选择刚刚创建的分区，然后输入 <em>19</em> 设置分区类型为 &ldquo;Linux Swap&rdquo;。</p>
<pre tabindex="0"><code>Command (m for help):t
Partition number (1,2, default 2): 2
Partition type (type L to list all types): 19
 
Changed type of partition 'Linux filesystem' to 'Linux swap'.
</code></pre><h4 id="创建根分区">创建根分区<a hidden class="anchor" aria-hidden="true" href="#创建根分区">#</a></h4>
<p>最后，要创建根分区，请输入 n 以创建新分区。然后输入 3 创建第三个分区，/dev/sda3。当提示输入第一个扇区时，按 Enter。当提示输入最后一个扇区时，按 Enter 以创建一个分区，该分区占用磁盘上的其余剩余空间。完成这些步骤后，输入 p 应该会显示一个类似于以下内容的分区表：</p>
<pre tabindex="0"><code>Command (m for help):p
Disk /dev/sda: 28.89 GiB, 31001149440 bytes, 60549120 sectors
Disk model: DataTraveler 2.0
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: 87EA4497-2722-DF43-A954-368E46AE5C5F
 
Device       Start      End  Sectors  Size Type
/dev/sda1     2048   526335   524288  256M EFI System
/dev/sda2   526336  8914943  8388608    4G Linux swap
/dev/sda3  8914944 60549086 51634143 24.6G Linux filesystem
</code></pre><h4 id="保存分区布局">保存分区布局<a hidden class="anchor" aria-hidden="true" href="#保存分区布局">#</a></h4>
<p>要保存分区布局并退出 <strong>fdisk</strong>，请敲击 w。</p>
<pre tabindex="0"><code>Command (m for help):w
</code></pre><p>当分区创建完成后，就该在其上部署文件系统了。</p>
<h3 id="使用-mbr-对磁盘进行分区以用于-bioslegacy-启动">使用 MBR 对磁盘进行分区以用于 BIOS/legacy 启动<a hidden class="anchor" aria-hidden="true" href="#使用-mbr-对磁盘进行分区以用于-bioslegacy-启动">#</a></h3>
<p>下面解释了如何为 MBR/BIOS 传统引导安装创建示例分区布局。前面提到的示例分区布局现在是：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Partition</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">/dev/sda1</td>
<td style="text-align:left">Boot partition</td>
</tr>
<tr>
<td style="text-align:left">/dev/sda2</td>
<td style="text-align:left">Swap partition</td>
</tr>
<tr>
<td style="text-align:left">/dev/sda3</td>
<td style="text-align:left">Root partition</td>
</tr>
</tbody>
</table>
<p>可以根据个人喜好更改分区布局。</p>
<h4 id="查看当前分区布局-1">查看当前分区布局<a hidden class="anchor" aria-hidden="true" href="#查看当前分区布局-1">#</a></h4>
<p>针对磁盘启动 <strong>fdisk</strong>（在我们的示例中，我们使用 /dev/sda）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># fdisk /dev/sda</span>
</code></pre></div><p>输入p显示磁盘的当前分区配置：</p>
<pre tabindex="0"><code>Command (m for help):p
Disk /dev/sda: 28.89 GiB, 31001149440 bytes, 60549120 sectors
Disk model: DataTraveler 2.0
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: 21AAD8CF-DB67-0F43-9374-416C7A4E31EA
 
Device        Start      End  Sectors  Size Type
/dev/sda1      2048   526335   524288  256M EFI System
/dev/sda2    526336  2623487  2097152    1G Linux swap
/dev/sda3   2623488 19400703 16777216    8G Linux filesystem
/dev/sda4  19400704 60549086 41148383 19.6G Linux filesystem
</code></pre><p>直到现在，这个特定的磁盘被配置为使用 GPT 表容纳两个 Linux 文件系统（每个都有一个相应的分区列为 &ldquo;Linux&rdquo;）以及一个交换分区（列为 &ldquo;Linux swap&rdquo;）。</p>
<h4 id="创建一个新的磁盘标签删除所有分区-1">创建一个新的磁盘标签/删除所有分区<a hidden class="anchor" aria-hidden="true" href="#创建一个新的磁盘标签删除所有分区-1">#</a></h4>
<p>输入 o 在磁盘上创建一个新的 MBR 磁盘标签（这里也称为 DOS 磁盘标签）；这将删除所有现有分区。</p>
<pre tabindex="0"><code>Command (m for help):o
Created a new DOS disklabel with disk identifier 0xe04e67c4.
The device contains 'gpt' signature and it will be removed by a write command. See fdisk(8) man page and --wipe option for more details.
</code></pre><p>对于现有的 DOS 磁盘标签（参见上面 p 的输出），或者考虑从磁盘中一一删除现有分区。输入 d 删除分区。例如，要删除现有的 /dev/sda1：</p>
<pre tabindex="0"><code>Command (m for help):d
Partition number (1-4): 1
</code></pre><p>该分区现已计划删除。打印分区列表时将不再显示 (p，但在保存更改之前它不会被删除。如果发生错误，用户可以中止操作 —— 在这种情况下, 立即输入 q 并按 Enter 不会删除分区。</p>
<p>重复输入 p 打印出一个分区列表，然后输入 d 和分区号来删除它。最终，分区表将为空：</p>
<pre tabindex="0"><code>Command (m for help):p
Disk /dev/sda: 28.89 GiB, 31001149440 bytes, 60549120 sectors
Disk model: DataTraveler 2.0
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xe04e67c4
</code></pre><p>现在我们已准备好创建分区。</p>
<h4 id="创建引导分区">创建引导分区<a hidden class="anchor" aria-hidden="true" href="#创建引导分区">#</a></h4>
<p>首先，创建一个将挂载到 /boot 的小分区。输入 n 创建一个新分区，然后输入 p 作为主分区，输入 1 选择第一个主分区。当提示输入第一个扇区时，确保它从 2048（引导加载程序可能需要）开始并按 Enter。当提示输入最后一个扇区时，输入 +256M 创建一个大小为 256 MB 的分区：</p>
<pre tabindex="0"><code>Command (m for help):n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1): 1
First sector (2048-60549119, default 2048): 
Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-60549119, default 60549119): +256M
 
Created a new partition 1 of type 'Linux' and of size 256 MiB.
</code></pre><h4 id="创建-swap-分区">创建 swap 分区<a hidden class="anchor" aria-hidden="true" href="#创建-swap-分区">#</a></h4>
<p>接下来，要创建交换分区，输入 n 创建一个新分区，然后输入 p，然后输入 2 创建第二个主分区，/dev/sda2。当提示输入第一个扇区时，按 Enter。当提示输入最后一个扇区时，输入 +4G（或交换空间所需的任何其他大小）以创建大小为 4GB 的分区。</p>
<pre tabindex="0"><code>Command (m for help):n
Partition type
   p   primary (1 primary, 0 extended, 3 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (2-4, default 2): 2
First sector (526336-60549119, default 526336): 
Last sector, +/-sectors or +/-size{K,M,G,T,P} (526336-60549119, default 60549119): +4G
 
Created a new partition 2 of type 'Linux' and of size 4 GiB.
</code></pre><p>完成后，输入t设置分区类型，输入2选择刚刚创建的分区，然后输入 <em>82</em> 设置分区类型为 &ldquo;Linux Swap&rdquo;。</p>
<pre tabindex="0"><code>Command (m for help):t
Partition number (1,2, default 2): 2
Hex code (type L to list all codes): 82

&lt;!--T:179--&gt;
Changed type of partition 'Linux' to 'Linux swap / Solaris'.
</code></pre><h4 id="创建根分区-1">创建根分区<a hidden class="anchor" aria-hidden="true" href="#创建根分区-1">#</a></h4>
<p>最后，要创建根分区，请输入 n 以创建新分区。然后输入 p 和 3 以创建第三个主分区 /dev/sda3。当提示输入第一个扇区时，按 Enter。当提示输入最后一个扇区时，按 Enter 以创建一个分区，该分区占用磁盘上的剩余空间。完成这些步骤后，输入 p 应该会显示一个类似于以下内容的分区表：</p>
<pre tabindex="0"><code>Command (m for help):p
Disk /dev/sda: 28.89 GiB, 31001149440 bytes, 60549120 sectors
Disk model: DataTraveler 2.0
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xe04e67c4
 
Device     Boot   Start      End  Sectors  Size Id Type
/dev/sda1          2048   526335   524288  256M 83 Linux
/dev/sda2        526336  8914943  8388608    4G 82 Linux swap / Solaris
/dev/sda3       8914944 60549119 51634176 24.6G 83 Linux
</code></pre><h4 id="保存分区布局-1">保存分区布局<a hidden class="anchor" aria-hidden="true" href="#保存分区布局-1">#</a></h4>
<p>要保存分区布局并退出 <strong>fdisk</strong>，输入 w。</p>
<pre tabindex="0"><code>Command (m for help):w
</code></pre><p>现在是时候将文件系统应用在分区上了。</p>
<h3 id="创建文件系统">创建文件系统<a hidden class="anchor" aria-hidden="true" href="#创建文件系统">#</a></h3>
<h4 id="介绍">介绍<a hidden class="anchor" aria-hidden="true" href="#介绍">#</a></h4>
<p>现在分区已经创建，该在上面设置文件系统了。下一章节中描述了 Linux 所支持的众多文件系统。知道使用哪一个文件系统的读者可以继续阅读<a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks/zh-cn#Applying_a_filesystem_to_a_partition">为分区应用文件系统</a>。剩下的人应该学习可用的文件系统……</p>
<h4 id="文件系统">文件系统<a hidden class="anchor" aria-hidden="true" href="#文件系统">#</a></h4>
<p>有一些可以使用的文件系统。有些在amd64架构上稳定——建议在选择为一个重要分区实验性的选择文件系统前继续阅读。</p>
<ul>
<li>
<p>btrfs</p>
<p>是下一代文件系统，提供了许多高级功能，如快照，通过校验和自我修复、 透明压缩、 子卷和集成 RAID。几个发行版已经开始将它作为一个默认的选项,但它还未为生产工作做好准备。文件系统报告崩溃是常见的。其开发人员敦促人们运行最新的内核版本来解决安全问题,以及老的问题。 这种情况已经很多年了,现在使用它还为时过早。如果出现变更，以及发生了变化，解决错误问题，都很少往旧内核注入补丁。请谨慎使用这个文件系统!</p>
</li>
<li>
<p>ext2</p>
<p>是经考验证明可靠的Linux文件系统，但是没有元数据日志，这意味这在启动系统时的ext2文件系统的日常检查相当耗时。现在相当一部分的新一代的日志文件系统都可以非常迅速检查一致性，因此比那些非日志文件系统更受欢迎。当你启动系统碰巧遇到文件系统状态不一致时，日志文件系统不会在那里耽搁很长时间。</p>
</li>
<li>
<p>ext3</p>
<p>是ext2文件系统的带日志版本，提供了元数据日志模式以快速恢复数据。此外还提供了其他增强的日志模式，如完整数据日志模式和有序数据日志模式。它使用了HTree索引，在几乎所有的情况下都能保持高性能。简而言之，ext3是非常好及可靠的文件系统。</p>
</li>
<li>
<p>ext4</p>
<p>最初创建为ext3的一个分支，EXT4带来了新的功能，性能改进和去除中度更改磁盘格式大小限制。它可以跨越体积高达1的EB并用16 TB最大文件大小。取而代之的是经典的ext2/3位块分配的ext4的使用范围，这对提高大文件的性能，并减少碎片。的Ext4还提供了更为复杂的块分配算法（延迟分配和多嵌段分配）给文件系统驱动更多的方式来优化数据的布局在磁盘上。 EXT4是推荐的通用所有平台的文件系统。</p>
</li>
<li>
<p>f2fs</p>
<p>这个文件系统最初由三星创建用于NAND闪存，是一种闪存文件系统 从直到2016年第二季度起，这个文件系统仍然被认为不成熟。把Gentoo安装到microSD卡，USB驱动器或其他基于闪存的存储设备时使用它是一个不错的选择。</p>
</li>
<li>
<p>JFS</p>
<p>是IBM的高性能日志文件系统。JFS是一个轻量级的、快速的和稳定的基于B+树的文件系统，在很多情况下都有很好的表现。</p>
</li>
<li>
<p>ReiserFS</p>
<p>是基于B+树的文件系统，它有着非常全面的性能，特别时在处理很多小文件的时候，虽然会占用多一点CPU。ReiserFS相比其他文件系统显得受维护的不够。</p>
</li>
<li>
<p>XFS</p>
<p>是一种带元数据日志的文件系统，它有一个健壮的特性集，并且对可伸缩性进行了优化。XFS似乎对各种各样的硬件问题显得不够宽容。</p>
</li>
<li>
<p>vfat</p>
<p>也称为FAT32，被支持Linux，但不支持任何权限设置。它主要用于互操作性与其他操作系统（主要是微软的Windows），但也是很有必要的一些系统固件（如UEFI）的支持。</p>
</li>
<li>
<p>NTFS</p>
<p>这个“新技术”的文件系统是Microsoft Windows的旗舰文件系统。 与上面的vfat类似，它不存储BSD或Linux正常工作所需的权限设置或扩展属性，因此它不能用作根文件系统。 它应该&rsquo;只&rsquo;用于与Microsoft Windows系统的互操作性（注意只强调）。</p>
</li>
</ul>
<h4 id="为分区应用文件系统">为分区应用文件系统<a hidden class="anchor" aria-hidden="true" href="#为分区应用文件系统">#</a></h4>
<p>在一个分区或卷上创建一个文件系统，这里有用于每一个可能的分区的工具。 单击下表中的文件系统名称，了解每个文件系统的更多信息：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Filesystem</th>
<th style="text-align:left">Creation command</th>
<th style="text-align:left">On minimal CD?</th>
<th style="text-align:left">Package</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="https://wiki.gentoo.org/wiki/Btrfs">btrfs</a></td>
<td style="text-align:left"><strong>mkfs.btrfs</strong></td>
<td style="text-align:left">Yes</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/btrfs-progs">sys-fs/btrfs-progs</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="https://wiki.gentoo.org/wiki/Ext4">ext4</a></td>
<td style="text-align:left"><strong>mkfs.ext4</strong></td>
<td style="text-align:left">Yes</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/e2fsprogs">sys-fs/e2fsprogs</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="https://wiki.gentoo.org/wiki/F2FS">f2fs</a></td>
<td style="text-align:left"><strong>mkfs.f2fs</strong></td>
<td style="text-align:left">Yes</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/f2fs-tools">sys-fs/f2fs-tools</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="https://wiki.gentoo.org/wiki/JFS">jfs</a></td>
<td style="text-align:left"><strong>mkfs.jfs</strong></td>
<td style="text-align:left">Yes</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/jfsutils">sys-fs/jfsutils</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="https://wiki.gentoo.org/wiki/ReiserFS">reiserfs</a></td>
<td style="text-align:left"><strong>mkfs.reiserfs</strong></td>
<td style="text-align:left">Yes</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/reiserfsprogs">sys-fs/reiserfsprogs</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="https://wiki.gentoo.org/wiki/XFS">xfs</a></td>
<td style="text-align:left"><strong>mkfs.xfs</strong></td>
<td style="text-align:left">Yes</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/xfsprogs">sys-fs/xfsprogs</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="https://wiki.gentoo.org/wiki/FAT">vfat</a></td>
<td style="text-align:left"><strong>mkfs.vfat</strong></td>
<td style="text-align:left">Yes</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/dosfstools">sys-fs/dosfstools</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="https://wiki.gentoo.org/wiki/NTFS">NTFS</a></td>
<td style="text-align:left"><strong>mkfs.ntfs</strong></td>
<td style="text-align:left">Yes</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/ntfs3g">sys-fs/ntfs3g</a></td>
</tr>
</tbody>
</table>
<p>例如，要将 EFI 系统分区 (/dev/sda1) 设为 FAT32，将根分区 (/dev/sda3) 设为 ext4，如示例分区结构中所用，将使用以下命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkfs.vfat -F 32 /dev/sda1</span>
<span style="color:#75715e"># mkfs.ext4 /dev/sda3</span>
</code></pre></div><p>当在一个小的分区（少于8 GiB）上使用 ext2、ext3 或 ext4，则创建文件系统时必须带适当的选项以保留足够的 inode。<strong>mke2fs</strong>（<strong>mkfs.ext2</strong>）应用程序使用“字节每inode”设置来计算一个文件系统 inode 的数量。在小分区，建议增加计算出的 inode 数量。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkfs.ext4 -T small /dev/&lt;device&gt;</span>
</code></pre></div><p>这一般将是对于给定的文件系统inode数量的四倍，它的“字节每inode”从16kB每个减少到4kB每个。这个可以在将来通过提供比例进行调整：</p>
<p>现在在新创建的分区（或逻辑卷）上创建文件系统。</p>
<h4 id="激活swap分区">激活swap分区<a hidden class="anchor" aria-hidden="true" href="#激活swap分区">#</a></h4>
<p><strong>mkswap</strong>是用来初始化swap分区的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkswap /dev/sda2</span>
</code></pre></div><p>要激活swap分区，使用<strong>swapon</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># swapon /dev/sda2</span>
</code></pre></div><p>使用上面提到的命令创建和激活swap。</p>
<h4 id="可选使用-swapfile">可选：使用 swapfile<a hidden class="anchor" aria-hidden="true" href="#可选使用-swapfile">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fallocate -l 15G /swapfile
$ chmod <span style="color:#ae81ff">600</span> /swapfile
$ mkswap /swapfile
$ swapon /swapfile
$ swapon -s
</code></pre></div><h3 id="挂载-root-分区">挂载 root 分区<a hidden class="anchor" aria-hidden="true" href="#挂载-root-分区">#</a></h3>
<p>现在分区都已初始化并有文件系统，接下来该挂载那些分区了。使用<strong>mount</strong>命令，但是不要忘记为每一个创建的分区创建需要的挂载目录。比如示例中我们挂载根分区:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mount /dev/sda3 /mnt/gentoo</span>
</code></pre></div><p><strong>附注</strong>：如果/tmp/需要放在一个独立分区，确保在挂载后变更它的权限：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># chmod 1777 /mnt/gentoo/tmp</span>
</code></pre></div><p>这同样适用于/var/tmp。</p>
<p>后面的介绍中将挂载proc文件系统（一个内核的虚拟接口）和其它内核伪文件系统。不过我们首先<a href="#%E5%AE%89%E8%A3%85Gentoo%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6">安装Gentoo安装文件</a>。</p>
<h2 id="安装gentoo安装文件httpswikigentooorgwikihandbookamd64installationstage"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Stage">安装Gentoo安装文件</a><a hidden class="anchor" aria-hidden="true" href="#安装gentoo安装文件httpswikigentooorgwikihandbookamd64installationstage">#</a></h2>
<h3 id="安装stage包">安装stage包<a hidden class="anchor" aria-hidden="true" href="#安装stage包">#</a></h3>
<h4 id="设置日期和时间">设置日期和时间<a hidden class="anchor" aria-hidden="true" href="#设置日期和时间">#</a></h4>
<p>在安装Gentoo之前，最好确保日期和时间设置正确。 错误配置的时间可能会导致奇怪的结果：基本系统文件应设置精确的时间戳。 事实上，由于几个网站和服务使用加密通信（SSL / TLS），如果系统时间差的离谱，可能无法下载安装文件！</p>
<p>验证当前时间使用命令<strong>date</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># date</span>
Mon Oct  <span style="color:#ae81ff">3</span> 13:16:22 PDT <span style="color:#ae81ff">2021</span>
</code></pre></div><p>如果显示的日期/时间不正确，请使用下列方法之一进行更新。</p>
<p><strong>附注</strong>：不包括实时时钟（RTC）的主板应配置为自动将系统时钟与时间服务器同步。 这也适用于包含RTC但具有故障电池的系统。</p>
<p><strong>自动</strong></p>
<p>Gentoo 的官方安装光盘包含 <strong>ntpd</strong> 命令 (属于包 <a href="https://packages.gentoo.org/packages/net-misc/ntp">net-misc/ntp</a> package)。官方光盘包括指向ntp.org时间服务器的配置文件。它可以用于使用时间服务器，使得系统时钟自动同步到UTC时间。使用方法见<a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Networking/zh-cn">配置网络</a> 但在某些架构的光盘上可能不可用。</p>
<p><strong>警告</strong>：自动时间同步需要付出一个代价。它将向时间服务器显示系统的IP地址和相关网络信息（在下面的示例中为ntp.org）。有隐私问题的用户应该注意这个“之前”使用下面的方法设置系统时钟。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ntpd -q -g</span>
</code></pre></div><p><strong>手动</strong></p>
<p>也可以用<strong>date</strong> 命令来对系统时钟执行手动设置。使用 <code>MMDDhhmmYYYY</code> 语法 (月, 日, 小时, 分钟 和 年)。</p>
<p>建议所有Linux系统使用UTC时间。 稍后在安装期间将定义时区。 这将修改时钟的显示为本地时间。</p>
<p>比如，设置时间到2016年10月3日的13:16：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># date 100313162021</span>
</code></pre></div><h4 id="选择一个stage包">选择一个stage包<a hidden class="anchor" aria-hidden="true" href="#选择一个stage包">#</a></h4>
<p><strong>multilib（32和64位）</strong></p>
<p>选择一个基础压缩包的系统可以在稍后的安装过程节省大量的时间，特别是当它是一次<a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Base/zh-cn#.E9.80.89.E6.8B.A9.E6.AD.A3.E7.A1.AE.E7.9A.84.E9.85.8D.E7.BD.AE.E6.96.87.E4.BB.B6">选择正确的配置文件</a>。一个stage包的选择将直接影响未来的系统配置，可以在以后省的头痛。该压缩包 multilib 尽可能使用64位的库，只必要时对32位版本兼容。这对于大多数安装一个很好的选择，因为它在未来的定制提供了极大的灵活性量。那些谁希望自己的系统，能够容易地切换配置,应该下载根据各自的处理器架构 multilib的压缩包选项。</p>
<p>大多数用户应该不需要使用“高级”tar包选项；它们用于特定的软件或硬件配置。</p>
<p><strong>no-multilib（纯64位）</strong></p>
<p>选择一个no-multilib压缩包:no-multilib是在系统的基础上提供了一个完整的64位操作系统环境。这有效地使得切换到multilib的profile是不可能的(不是完全不可能)。这些刚刚开始使用Gentoo的新手不应该选择一个 no-multilib 压缩包，除非&quot;绝对必要&quot;。而且应该有很好的理由并做出负责任的选择。</p>
<p><strong>警告</strong>：注意，把一个系统从no-multilib迁移到multilib需要极其丰富的使用Gentoo的知识并熟悉底层的工具链。这一做法甚至可能导致<a href="https://wiki.gentoo.org/wiki/Project:Toolchain">Toolchain developers</a> 这令人不寒而栗。不适合内心柔弱之人,而且也超出了本指南的范围。</p>
<p><strong>其他  <em>profile</em> 属性说明</strong></p>
<ul>
<li>openrc: 带此单词表示，其默认的初始化程序为 openrc</li>
<li>systemd: 带此单词表示，其默认的初始化程序为 systemd，而不带该单词所有 <em>profile</em> ，默认初始化程序都是 openrc （即 Gentoo Linux 官方默认）</li>
<li>selinux: 带此单词表示，其默认包含 SELinux 相关配置，启用 SELinux</li>
<li>hardened: 带此单词表示，其默认包含强化安全性相关的配置</li>
</ul>
<p>正常使用情况下，推荐如下两个 stage3 进行下载：</p>
<ul>
<li>current-stage3-amd64-openrc</li>
<li><strong>current-stage3-amd64-systemd</strong></li>
</ul>
<p>openrc 是 Gentoo Linux 官方维护且默认的初始化程序，而 systemd 则是如今大多数发行版使用的初始化程序，各有优劣，二者均可，自行选择。</p>
<h4 id="下载stage压缩包">下载stage压缩包<a hidden class="anchor" aria-hidden="true" href="#下载stage压缩包">#</a></h4>
<p>前往挂载根文件系统的 Gentoo 挂载点（类似于 /<code>mnt/gentoo</code>）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cd /mnt/gentoo</span>
</code></pre></div><p>根据不同的安装媒介，下载stage压缩包所需的唯一工具是网络浏览器。</p>
<p><strong>图形化浏览器</strong></p>
<p>那些使用图形化网页浏览器从主网站<a href="https://www.gentoo.org/downloads/#other-arches">下载小节</a>复制stage文件URL也没有问题。 只需选择适当的选项卡，右键单击stage文件的链接，然后复制链接地址（Firefox）或复制链接位置（Chromium）将链接复制到剪贴板，然后 将链接粘贴到命令行中的 <strong>wget</strong>程序以下载stage tarball：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># wget &lt;PASTED_STAGE_URL&gt;</span>
</code></pre></div><p>例如</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># wget https://mirrors.bfsu.edu.cn/gentoo/releases/amd64/autobuilds/current-stage3-amd64-systemd/stage3-amd64-systemd-20220315T091810Z.tar.xz</span>
<span style="color:#75715e"># wget https://mirrors.bfsu.edu.cn/gentoo/releases/amd64/autobuilds/current-stage3-amd64-systemd/stage3-amd64-systemd-20220315T091810Z.tar.xz.DIGESTS</span>
<span style="color:#75715e"># cat stage3-amd64-systemd-20220315T091810Z.tar.xz</span>
<span style="color:#75715e"># sha512sum stage3-amd64-systemd-20220315T091810Z.tar.xz</span>
</code></pre></div><p><strong>命令行浏览器</strong></p>
<p>更多传统的读者或是 Gentoo 的“老前辈”，只能命令行工作，可能更喜欢使用非图形化菜单驱动的浏览器 <strong>links</strong>。 要下载一个 stage，请像下面这样访问Gentoo镜像列表：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># links https://www.gentoo.org/downloads/mirrors/</span>
</code></pre></div><p>要设置<strong>links</strong>使用一个HTTP代理，在传入URL上加一个<code>-http-proxy</code>选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># links -http-proxy proxy.server.com:8080 https://www.gentoo.org/downloads/mirrors/</span>
</code></pre></div><p><strong>links</strong>之外还有一个<strong>lynx</strong>浏览器。和<strong>links</strong>类似，它也是一个非图形化的浏览器，但不是自带的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># lynx https://www.gentoo.org/downloads/mirrors/</span>
</code></pre></div><p>如果需要定义一个代理，设置http_proxy和/或ftp_proxy变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># export http_proxy=&#34;http://proxy.server.com:port&#34;</span>
<span style="color:#75715e"># export ftp_proxy=&#34;http://proxy.server.com:port&#34;</span>
</code></pre></div><p>在镜像列表中，选择一个附近镜像站。通常HTTP镜像站就足够了，但其他网络协议是可用的。请访问<code>releases/amd64/autobuilds/</code> 。 那里将显示所有可用stage文件 （可能他们个别小组架构在命名的子目录中存储）。选择一个，然后按 d 下载。</p>
<p>stage 文件下载完成后，可以验证 stage tarball 的完整性并验证其内容。</p>
<p>对验证stage文件不感兴趣的用户可以通过按 q 来关闭命令行浏览器，并且可以直接移步到 <a href="#%E8%A7%A3%E5%8E%8Bstage%E5%8E%8B%E7%BC%A9%E5%8C%85">解压stage压缩包</a> 部分。</p>
<p><strong>验证</strong></p>
<p><strong>附注</strong>：一些 tarballs 是通过XZ压缩的。在下载以 .tar.xz 结尾的 tarball 时，请确保在下面的命令中调整tarball文件名的 .tar.bz2 。</p>
<p>与最小安装CD一样，可以使用额外的下载来验证stage文件。 虽然这些步骤可以被跳过，但这些文件是为那些关心他们刚刚下载的文件合法性的用户提供的。</p>
<ul>
<li>A .CONTENTS 文件包含stage压缩包内的所有文件的列表。</li>
<li>A .DIGESTS 文件，其中包含用不同的算法校验的stage文件。</li>
<li>A .DIGESTS.asc 像.DIGESTS文件一样, 包含不同的stage文件的校验和，但也加密签名，以确保它是由Gentoo项目提供的。</li>
</ul>
<p>使用 <strong>openssl</strong> 并比较,提供的校验输出与.DIGESTS或者.DIGESTS.asc 文件的内容是否一致。</p>
<p>比如，要验证SHA512校验值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># openssl dgst -r -sha512 stage3-amd64-&lt;release&gt;-&lt;init&gt;.tar.?(bz2|xz)</span>
</code></pre></div><p>使用<strong>sha512sum</strong>命令的另外一种方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># sha512sum stage3-amd64-&lt;release&gt;-&lt;init&gt;.tar.?(bz2|xz)</span>
</code></pre></div><p>要验证Whirlpool校验值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># openssl dgst -r -whirlpool stage3-amd64-&lt;release&gt;-&lt;init&gt;.tar.?(bz2|xz)</span>
</code></pre></div><p>该值需要匹配，否则下载的文件可能已损坏（或摘要文件）。比较这些命令的输出与.DIGESTS(.asc)中的值。该值需要匹配，否则下载的文件可能已损坏（或digests文件）。</p>
<p>就像在ISO文件中，它也可以来验证加密签名的.DIGESTS.asc。使用 <strong>gpg</strong> 以确保DIGESTS.asc文件校验和未被篡改:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># gpg --verify stage3-amd64-&lt;release&gt;-&lt;init&gt;.tar.?(bz2|xz){.DIGESTS.asc,}</span>
</code></pre></div><h4 id="解压stage压缩包">解压stage压缩包<a hidden class="anchor" aria-hidden="true" href="#解压stage压缩包">#</a></h4>
<p>现在，解压下载的stage到系统。我们使用 <strong>tar</strong>来进行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># tar xpvf stage3-*.tar.xz --xattrs-include=&#39;*.*&#39; --numeric-owner</span>
</code></pre></div><p>确保你使用了同样的参数 ( <code>xpf</code> 和 <code>--xattrs-include='*.*'</code>)。 <code>x</code>表示解开（Extract），<code>v</code>表示详细信息（Verbose）可以用来查看解压缩时发生了什么（可选参数）， <code>p</code> 表示保留权限（Preserve permissions），还有<code>f</code> 表示我们要解开一个文件，而不是标准输入。最后，<code>--numeric-owner</code> 被用于确保从tarball中提取的文件的用户和组ID与Gentoo发布工程团队预期的保持一致，即使大胆的用户使用的不是Gentoo官方安装媒介。</p>
<p>现在stage文件已经解压好了，下面我们继续<a href="#%E9%85%8D%E7%BD%AE%E7%BC%96%E8%AF%91%E9%80%89%E9%A1%B9">配置编译选项</a>。</p>
<h3 id="配置编译选项">配置编译选项<a hidden class="anchor" aria-hidden="true" href="#配置编译选项">#</a></h3>
<h4 id="介绍-1">介绍<a hidden class="anchor" aria-hidden="true" href="#介绍-1">#</a></h4>
<p>为了优化Gentoo，可以设置一些影响Portage的变量，Gentoo官方支持包管理器。 所有这些变量可以设置为环境变量（使用<strong>export</strong>），但这不是永久的。 为了保留设置，Portage读入<code>/etc/portage/make.conf</code>文件 ，一个用于Portage的配置文件，它有一个预配置好的模板文件在 <code>/usr/share/portage/config/make.globals</code> ，而 <code>make.conf</code> 下的配置会覆盖该模板下对应变量。</p>
<p><strong>附注</strong>：所有可能的变量的注释列表可以在 <code>/mnt/gentoo/usr/share/portage/config/make.conf.example</code>中找到。要成功安装Gentoo，只需要设置下面提到的变量。</p>
<p>启动编辑器（在本指南中，我们使用 <strong>nano</strong>）来更改我们将在下面讨论的优化变量。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /mnt/gentoo/etc/portage/make.conf</span>
</code></pre></div><p>从make.conf.example文件中可以明显看出文件的结构：注释行以 <code>#</code>开头，其他行使用 <code>VARIABLE=&quot;value&quot;</code> 语法定义变量。 接下来选取其中的几个进行讨论。</p>
<h4 id="cflags-和-cxxflags">CFLAGS 和 CXXFLAGS<a hidden class="anchor" aria-hidden="true" href="#cflags-和-cxxflags">#</a></h4>
<p>CFLAGS 和 CXXFLAGS 变量分别定义了GCC C和C ++编译器的优化标志。 尽管这些标志一般在这里默认被定义过，但为了性能最大化，需要分别优化每个程序的这些配置。 原因是因为每个程序都不同。 但是，这是不可管理的，因此这些标志在 make.conf 文件中定义。</p>
<p>应该在make.conf中定义优化标志，这将使系统的响应速度最快。 不要在此变量中放置实验性的设置; 太多的优化可能会使程序表现不佳（崩溃，甚至更糟，故障）。</p>
<p>我们不会解释所有可能的优化选项。 要了解它们，请阅读<a href="https://gcc.gnu.org/onlinedocs/">GNU在线手册</a>或gcc信息页面 (<strong>info gcc</strong>-只适用于可用的Linux系统)。make.conf.example 文件本身也包含了很多例子和信息; 不要忘了读它。</p>
<p>第一个设置是标志 <code>-march=</code> 和 <code>-mtune=</code> ，指定目标体系结构的名称。 可能用到的选项在make.conf.example文件中有描述（作为注释）。 一个常用的值是“native”，它告诉编译器选择当前系统体系结构（用户正在安装Gentoo时的系统）。(如果你知道自己处理器的代号，就用自己的处理器代号替换这里的native 比如我的是skylake，如果不确定就使用native。一个得到处理器代号的简单办法：使用 <a href="https://www.cpuid.com/softwares/cpu-z.html">CPU-Z</a> 检测）。</p>
<p>第二个是标志 <code>-O</code>（即大写的字母O，而不是数字零），它指定了gcc优化级别标志。 可能用到级别的是s（对于大小最优化），0（零 - 无优化），1,2或甚至3等更多的优化选项（每个级别具有与前面相同的标志，加上一些额外选项）。 <code>-O2</code>是建议的默认值。 <code>-O3</code>在整个系统范围内使用时会导致问题，因此我们建议您坚持使用<code>-O2</code>。</p>
<p>另一个普遍使用的优化标记是<code>-pipe</code>（不同编译阶段通信使用管道而不是临时文件）。它对产生的代码没有任何影响，但是会使用更多的内存。在内存不多的系统里，gcc可能会被杀掉。如果是那样的话，就不要用这个标记。</p>
<p>使用 <code>-fomit-frame-pointer</code>（它将不在寄存器里为不需要帧指针的函数保存帧指针）可能会在调试程序的时候造成严重后果！</p>
<p>在你定义 CFLAGS和CXXFLAGS的时候，你需要把这些优化标记都合并起来。stage3文件里包含的你解压缩出来的默认值已经足够好了。下面这个例子仅仅是个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#75715e"># Compiler flags to set for all languages</span>
<span style="color:#a6e22e">COMMON_FLAGS</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-march=native -O2 -pipe&#34;</span>
<span style="color:#75715e"># Use the same settings for both variables</span>
<span style="color:#a6e22e">CFLAGS</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${COMMON_FLAGS}&#34;</span>
<span style="color:#a6e22e">CXXFLAGS</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${COMMON_FLAGS}&#34;</span>
</code></pre></div><p><strong>Tip</strong>：通过<a href="https://wiki.gentoo.org/wiki/GCC_optimization">GCC 优化指导</a>这篇文章获取有更多的信息，比如这些优化变量如何影响你的系统，<a href="https://wiki.gentoo.org/wiki/Safe_CFLAGS">Safe CFLAGS</a>也许是对初学者开始优化系统更实用的一篇文章</p>
<h4 id="makeoptshttpswikigentooorgwikimakeopts"><a href="https://wiki.gentoo.org/wiki/MAKEOPTS">MAKEOPTS</a><a hidden class="anchor" aria-hidden="true" href="#makeoptshttpswikigentooorgwikimakeopts">#</a></h4>
<p>通过使用MAKEOPTS 你可以定义在安装软件的时候同时可以产生并行编译的数目。官方推荐取「内存大小/2G」（<code>free -h</code>）与「CPU 线程数」（<code>nproc</code>）中的较小者。</p>
<p><strong>警告</strong>：使用大量job会显着影响内存消耗。良好的建议是为指定的每项工作至少有2 GiB的RAM（例如，<code>-j6</code>需要至少12个GiB）。要避免内存不足，请降低作业数量以适应可用内存。</p>
<p><strong>提示</strong>：使用并行emerges （<code>--jobs</code>）时，运行的有效作业数量可以呈指数增长（最高使工作数乘以emerge作业数）。通过运行仅限localhost-only distcc配置，可以根据仅限于每个主机的编译器实例的数量来解决此问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">MAKEOPTS</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-j5&#34;</span>
</code></pre></div><p>如果变量未进行设置，那么 portage 会根据当前 CPU 的线程数自动赋予一个值，该自动值等于当前 CPU 线程数。</p>
<h4 id="makeconf-templatehttpszhuanlanzhihucomp166652475"><a href="https://zhuanlan.zhihu.com/p/166652475">make.conf template</a><a hidden class="anchor" aria-hidden="true" href="#makeconf-templatehttpszhuanlanzhihucomp166652475">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># These settings were set by the catalyst build script that automatically</span>
<span style="color:#75715e"># built this stage.</span>
<span style="color:#75715e"># Please consult /usr/share/portage/config/make.conf.example for a more</span>
<span style="color:#75715e"># detailed example.</span>
COMMON_FLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-march=skylake -O2 -pipe&#34;</span>
CFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>COMMON_FLAGS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
CXXFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>COMMON_FLAGS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
FCFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>COMMON_FLAGS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
FFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>COMMON_FLAGS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
CHOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;x86_64-pc-linux-gnu&#34;</span>   <span style="color:#75715e">#直接填写即可</span>
CPU_FLAGS_X86<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3&#34;</span>  <span style="color:#75715e"># CPU指令集，按照自己CPU的实际情况填写，后文会提到</span>
MAKEOPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-j8&#34;</span>                <span style="color:#75715e"># 同时编译的线程数</span>

<span style="color:#75715e"># NOTE: This stage was built with the bindist Use flag enabled</span>
PORTDIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/var/db/repos/gentoo&#34;</span>
DISTDIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/var/cache/distfiles&#34;</span>
PKGDIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/var/cache/binpkgs&#34;</span>

<span style="color:#75715e"># This sets the language of build output to English.</span>
<span style="color:#75715e"># Please keep this setting intact when reporting bugs.</span>
LC_MESSAGES<span style="color:#f92672">=</span>C

<span style="color:#75715e"># Emerge Default Option</span>
EMERGE_DEFAULT_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--keep-going --with-bdeps=y --quiet --ask --verbose&#34;</span>   <span style="color:#75715e"># emerge的默认选项</span>
AUTO_CLEAN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;yes&#34;</span>  <span style="color:#75715e">#每次安装完包之后自动清理</span>

<span style="color:#75715e"># Accept</span>
ACCEPT_KEYWORDS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;~amd64&#34;</span>           <span style="color:#75715e"># 如果你更喜欢稳定而非最新那这里用amd64</span>
ACCEPT_LICENSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;*&#34;</span>                 <span style="color:#75715e"># 接受所有许可证的软件</span>

<span style="color:#75715e"># Lang</span>
L10N<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en-US zh-CN en zh&#34;</span>           <span style="color:#75715e"># 语言设置照抄即可</span>

<span style="color:#75715e"># Harkware</span>
VIDEO_CARDS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;intel i965 nvidia&#34;</span>    <span style="color:#75715e"># intel集成显卡和nvidia显卡（不使用novueau）</span>
ALSA_CARDS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hda_intel&#34;</span>             <span style="color:#75715e"># intel声卡</span>
INPUT_DEVICES<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;libinput synaptics&#34;</span> <span style="color:#75715e"># 输入设备 非笔记本去除后面的synaptics</span>

<span style="color:#75715e">#Grub</span>
GRUB_PLATFORMS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;efi-64&#34;</span>            <span style="color:#75715e"># 设置GRUB版本 照抄即可</span>

<span style="color:#75715e"># Ccache</span>
<span style="color:#75715e"># FEATURES=&#34;parallel-fetch ccache&#34;   # 使用ccache来大大提高重新编译时的速度，等后面安装并设置ccache之后取消注释</span>
<span style="color:#75715e"># CCACHE_DIR=&#34;/var/cache/ccache&#34;     # ccache使用的目录</span>

<span style="color:#75715e"># Aria2                             # 使用aria2提高下载速度（不设置也无大碍，设置的话一定要注意指令拼写正确）</span>
FETCHCOMMAND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/usr/bin/aria2c -d \${DISTDIR} -o \${FILE} --allow-overwrite=true --max-tries=5 --max-file-not-found=2 --max-concurrent-downloads=5 --connect-timeout=5  --timeout=5 --split=5 --min-split-size=2M --lowest-speed-limit=20K --max-connection-per-server=9 --uri-selector=feedback \${URI}&#34;</span>
RESUMECOMMAND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>FETCHCOMMAND<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># USE                               # USE变量是Gentoo最有威力的变量 也是Gentoo吸引我的原因之一</span>
FUCKDE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-gnome -gnome-shell -gnome-keyring -nautilus -kde&#34;</span>
<span style="color:#75715e"># 不打算安装gnome和kde及其相关组件</span>
FUCKSV<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-bindist -mdev elogind -dhcpcd -oss -grub -plymouth -systemd -consolekit&#34;</span>
<span style="color:#75715e"># 不使用systemd plymouth consolekit 只使用elogind（旧教程会使用consolekit，事实上elogind是consolekit未来的替代品）</span>
SOFTWARE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sudo -icu client git chromium openmp minizip udev blkid efi hwdb smack acpi ccache dbus policykit udisks&#34;</span>
<span style="color:#75715e"># 需要用到的特性 照抄即可</span>
AUDIO<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;alsa jack pulseaudio&#34;</span>
<span style="color:#75715e"># 对于音频相关软件使用pulseaudio alsa jack特性</span>
NET<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;network networkmanager connection-sharing wifi http2&#34;</span>
<span style="color:#75715e"># 网络相关 照抄即可</span>
VIDEO<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;X vulkan layers glamor nvidia gallium&#34;</span>
<span style="color:#75715e"># 图形相关 照抄即可</span>
ELSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cjk emoji&#34;</span>
<span style="color:#75715e"># 照抄</span>

USE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>FUCKDE<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>FUCKSV<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>SOFTWARE<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>AUDIO<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>NET<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>VIDEO<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>ELSE<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
<span style="color:#75715e"># 定义需要的USE变量</span>

<span style="color:#75715e"># Mirrors</span>
GENTOO_MIRRORS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://mirrors.bfsu.edu.cn/gentoo&#34;</span> <span style="color:#75715e"># 设置镜像站为北外镜像站（清华镜像站的影分身，压力小，速度快）</span>

<span style="color:#75715e"># Proxy</span>
http_proxy<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://127.0.0.1:8889&#34;</span>     <span style="color:#75715e"># emerge时用到的代理 需要代理时候自行设置 勿照抄 下同</span>
https_proxy<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://127.0.0.1:8889&#34;</span>
</code></pre></div><ul>
<li>
<p><a href="https://wiki.gentoo.org/wiki//etc/portage/make.conf">make.conf</a></p>
</li>
<li>
<p><a href="https://wiki.gentoo.org/wiki/CHOST">CHOST</a></p>
</li>
<li>
<p><a href="https://wiki.gentoo.org/wiki//etc/portage/make.conf#CPU_FLAGS_X86">CPU_FLAGS_X86</a></p>
</li>
<li>
<p><a href="https://forums.gentoo.org/viewtopic-t-415759-view-next.html?sid=591bad342a64f08dd9985eec46c33e5c">AUTO_CLEAN</a>: man make.conf wrote</p>
<pre tabindex="0"><code>AUTOCLEAN = [&quot;yes&quot; | &quot;no&quot;]
Automatically cleans the system by removing outdated packages which will not remove functionalities or prevent your system from working. On major ABI changes this may need to be set to off to ensure that the system can be rebuilt using the new libs before the old ones are removed. Downgrading with this option turned off may result in missing symlinks and an inoperable system.
Defaults to yes.
</code></pre></li>
<li>
<p><a href="https://forums.gentoo.org/viewtopic-t-1001002-start-0.html">ALSA_CARDS</a>:</p>
<p>ALSA_CARDS is used by sys-firmware/alsa-firmware and media-sound/alsa-tools (result of eix -U ALSA_CARDS).</p>
<p>If you have an intel hda(according to your lspci output), you don&rsquo;t need to bother with ALSA_CARDS, because that card doesn&rsquo;t require anything special. If you still want to set it for the sake of completeness, use ALSA_CARDS=&ldquo;hda-intel&rdquo;.</p>
</li>
<li>
<p><a href="https://wiki.gentoo.org/wiki/Xorg/Guide#Make.conf">INPUT_DEVICES</a></p>
</li>
</ul>
<h4 id="就位预备出发-">就位，预备，出发 ！<a hidden class="anchor" aria-hidden="true" href="#就位预备出发-">#</a></h4>
<p>根据你的喜好更新并保存<code>/mnt/gentoo/etc/portage/make.conf</code>（nano用户可以敲 <code>Ctrl+X</code>）。</p>
<p>让我们继续 <a href="#%E5%AE%89%E8%A3%85Gentoo%E5%9F%BA%E7%A1%80%E7%B3%BB%E7%BB%9F">安装Gentoo 基本系统</a>.</p>
<h2 id="安装gentoo基础系统httpswikigentooorgwikihandbookamd64installationbase"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Base">安装Gentoo基础系统</a><a hidden class="anchor" aria-hidden="true" href="#安装gentoo基础系统httpswikigentooorgwikihandbookamd64installationbase">#</a></h2>
<h3 id="chrooting">Chrooting<a hidden class="anchor" aria-hidden="true" href="#chrooting">#</a></h3>
<h4 id="可选选择镜像站点">可选：选择镜像站点<a hidden class="anchor" aria-hidden="true" href="#可选选择镜像站点">#</a></h4>
<p><strong>分发文件</strong></p>
<p>为了能更快的下载源代码，这里推荐选择一个快的镜像。Portage 将会在make.conf文件中查找GENTOO_MIRRORS变量，并使用其中所列的镜像。可以通过浏览 Gentoo 镜像列表搜索一个（或一组）最接近系统物理位置（往往那是最快的）的镜像。另外，我们提供一个叫作<strong>mirrorselect</strong>的好工具，它为用户选择所需镜像提供了一个很好的交换。只需要移动光标选择镜像并按Spacebar选择一个或多个镜像。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mirrorselect -i -o &gt;&gt; /mnt/gentoo/etc/portage/make.conf</span>
</code></pre></div><p>如果因为连接国外网络不畅的原因，导致获取列表失败，这时候也可以直接手动指定一个镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#e6db74">&#39;GENTOO_MIRRORS=&#34;https://mirrors.tuna.tsinghua.edu.cn/gentoo&#34;&#39;</span> &gt;&gt; /mnt/gentoo/etc/portage/make.conf
</code></pre></div><p><strong>官方 ebuild 软件仓库</strong></p>
<p>选择镜像的第二个重要步骤是通过/<code>etc/portage/repos.conf/gentoo.conf</code>文件来配置 Gentoo的 ebuild 软件仓库。这个文件包含了更新 Portage 数据库（包含 Portage 需要下载和安装软件包所需要的信息的一个 ebuild 和相关文件的集合）所需要的同步信息。</p>
<p>通过几个简单的步骤就可以完成软件仓库的配置。首先，如果它不存在，则创建<a href="https://wiki.gentoo.org/wiki//etc/portage/repos.conf">repos.conf</a>目录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir --parents /mnt/gentoo/etc/portage/repos.conf</span>
</code></pre></div><p>接下来，复制 Portage 提供的 Gentoo 仓库配置文件到这个（新创建的）目录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf</span>
</code></pre></div><p>使用一个文件编辑器或通过使用 <code>cat</code> 命令来看一眼。文件里的内容应该是.ini格式并且看起来像是这样：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cat /mnt/gentoo/etc/portage/repos.conf/gentoo.conf</span>
<span style="color:#f92672">[</span>DEFAULT<span style="color:#f92672">]</span>
main-repo <span style="color:#f92672">=</span> gentoo
 
<span style="color:#f92672">[</span>gentoo<span style="color:#f92672">]</span>
location <span style="color:#f92672">=</span> /var/db/repos/gentoo
sync-type <span style="color:#f92672">=</span> rsync
sync-uri <span style="color:#f92672">=</span> rsync://rsync.gentoo.org/gentoo-portage
auto-sync <span style="color:#f92672">=</span> yes
sync-rsync-verify-jobs <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
sync-rsync-verify-metamanifest <span style="color:#f92672">=</span> yes
sync-rsync-verify-max-age <span style="color:#f92672">=</span> <span style="color:#ae81ff">24</span>
sync-openpgp-key-path <span style="color:#f92672">=</span> /usr/share/openpgp-keys/gentoo-release.asc
sync-openpgp-key-refresh-retry-count <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span>
sync-openpgp-key-refresh-retry-overall-timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">1200</span>
sync-openpgp-key-refresh-retry-delay-exp-base <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
sync-openpgp-key-refresh-retry-delay-max <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>
sync-openpgp-key-refresh-retry-delay-mult <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
</code></pre></div><p>上面列出的默认的sync-uri变量值将决定一个基于轮询的镜像位置。这将缓解Gentoo基础设施上带宽的压力并能提供一个由于特定镜像离线的故障安全。除非使用本地私有Portage镜像，否则建议保留默认URI。</p>
<p><strong>Tip</strong>：对那些有兴趣的话，可以在Portage项目的<a href="https://wiki.gentoo.org/wiki/Project:Portage/Sync">同步主题</a>中找到关于Portage的同步API插件的官方规范。</p>
<p><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E6%95%B0%E6%8D%AE%E5%BA%93"><strong>自定义 ebuild 软件仓库</strong></a></p>
<p>同步方式：</p>
<ul>
<li>rsync 方式可以使用命令校验本地改动，但本地同步时速度较慢；镜像站同步上游频率正常</li>
<li>git 方式可以使用命令结合人工介入判断以校验本地改动，本地同步时速度快；官方镜像点与原始仓库同步最及时，但国内镜像站同步上游频率低</li>
</ul>
<p>目前推荐使用 git 方式。为了使得更新更迅速，建议自定义一个靠近自己的镜像站点。方法为先创建一个自定义配置文件 <code>/etc/portage/repos.conf/gentoo.conf</code> ，后根据同步类型进行操作：</p>
<ul>
<li>
<p>自定义 rsync 方式同步配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>gentoo<span style="color:#f92672">]</span>
location   <span style="color:#f92672">=</span> /var/db/repos/gentoo
auto-sync  <span style="color:#f92672">=</span> yes
sync-type  <span style="color:#f92672">=</span> rsync
sync-uri   <span style="color:#f92672">=</span> rsync://mirrors.bfsu.edu.cn/gentoo-portage
<span style="color:#75715e"># 国内我这里建议可以使用北外的镜像站，其负载小，带宽大，更新迅速。</span>
<span style="color:#75715e"># 其它国内的镜像站我所知的还有：</span>
<span style="color:#75715e">#   TUNA： rsync://mirrors.tuna.tsinghua.edu.cn/gentoo-portage</span>
<span style="color:#75715e">#    163： rsync://mirrors.163.com/gentoo-portage</span>
<span style="color:#75715e">#  中科大： rsync://rsync.mirrors.ustc.edu.cn/gentoo-portage/</span>
</code></pre></div><p>Gentoo Linux 官方有一份较为完整的 <a href="https://www.gentoo.org/support/rsync-mirrors/">rsync 镜像列表</a> 。</p>
</li>
<li>
<p>自定义 git 方式同步配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>gentoo<span style="color:#f92672">]</span>
location   <span style="color:#f92672">=</span> /var/db/repos/gentoo
auto-sync  <span style="color:#f92672">=</span> yes
sync-type  <span style="color:#f92672">=</span> git
sync-depth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
sync-uri   <span style="color:#f92672">=</span> https://mirrors.bfsu.edu.cn/git/gentoo-portage.git
<span style="color:#75715e"># 国内我找到的 git 方式同步镜像只有北外和 TUNA 两家</span>
<span style="color:#75715e">#   TUNA 的地址： https://mirrors.tuna.tsinghua.edu.cn/git/gentoo-portage.git</span>
<span style="color:#75715e"># 但它们的同步上游的频率都很低（截至发文时确认为 11 小时一次）</span>
<span style="color:#75715e"># 所以若使用 git 方式同步，在网络流畅的情况，个人更建议直接同步官方镜像：</span>
<span style="color:#75715e">#   https://github.com/gentoo-mirror/gentoo.git</span>
sync-git-verify-commit-signature <span style="color:#f92672">=</span> yes
<span style="color:#75715e"># 设置校验最上层 commit 的签名，默认是不校验的</span>
</code></pre></div><p>之后执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">emerge -vj dev-vcs/git
<span style="color:#75715e"># 以安装 git 工具，它并不是系统自带的</span>

rm -rf /var/db/repos/gentoo
<span style="color:#75715e"># 删除原有的不支持 git 方式的数据库</span>

emerge --sync
<span style="color:#75715e"># 初始化同步一次数据库</span>
</code></pre></div></li>
</ul>
<p>如果你比较疑惑为何在 mirrorselect 时添加了一个镜像地址，此时又添加了，那么在此说明：</p>
<p>安装 Gentoo Linux 时往 <code>/etc/portage/make.conf</code> 写入的镜像地址，是 distfiles 镜像地址，用于下载安装软件时的软件本体（源代码或者二进制包），也包括了很多其它内容，比如 Portage 数据库的快照（但此快照不适用于日常更新）。</p>
<p>而此时配置的镜像是用于同步 Portage 系统的数据库，其包含了基础的系统配置文件，安装软件所需的描述文件等等很多基础内容。</p>
<h4 id="复制dns信息">复制DNS信息<a hidden class="anchor" aria-hidden="true" href="#复制dns信息">#</a></h4>
<p>在进行新环境之前，还有一件要做的事情就是复制<code>/etc/resolv.conf</code>中的DNS信息。需要完成这个来确保即使进入到新环境后网络仍然可以使用。<code>/etc/resolv.conf</code>包含着当前网络中的DNS服务器。</p>
<p>要复制这个信息，建议通过<strong>cp</strong>命令的 <code>--dereference</code> 选项。这可以保障如果/etc/resolv.conf是一个符号链接的话，复制的是那个目标文件而不是这个符号文件自己。否则在新环境中，符号文件将指向一个不存在的文件（因为链接目标非常可能不会在新环境中）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp --dereference /etc/resolv.conf /mnt/gentoo/etc/</span>
</code></pre></div><p>或者</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;nameserver 114.114.114.114&#39; &gt; /mnt/gentoo/etc/resolv.conf</span>
</code></pre></div><h4 id="挂载必要的文件系统">挂载必要的文件系统<a hidden class="anchor" aria-hidden="true" href="#挂载必要的文件系统">#</a></h4>
<p>稍等片刻，Linux 的根目录将变更到新的位置。为了确保新环境正常工作，需要确保一些文件系统可以正常使用。</p>
<p>需要提供的文件系统是：</p>
<ul>
<li><code>/proc/</code> 一个pseudo文件系统（看起来像是常规文件，事实上却是实时生成的），由Linux内核暴露的一些环境信息</li>
<li><code>/sys/</code> 一个pseudo文件系统，像要被取代的/proc/一样，比/proc/更加有结构</li>
<li><code>/dev/</code> 是一个包含全部设备文件的常规文件系统，一部分由Linux设备管理器（通常是<strong>udev</strong>）管理</li>
</ul>
<p><code>/proc/</code>位置将要挂载到<code>/mnt/gentoo/proc/</code>，而其它的两个都是绑定挂载。字面上的意思是，例如<code>/mnt/gentoo/sys/</code>事实上<em>就是</em><code>/sys/</code>（它只是同一个文件系统的第二个条目点），而<code>/mnt/gentoo/proc/</code>是（可以说是）文件系统的一个新的挂载。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mount --types proc /proc /mnt/gentoo/proc</span>
<span style="color:#75715e"># mount --rbind /sys /mnt/gentoo/sys</span>
<span style="color:#75715e"># mount --make-rslave /mnt/gentoo/sys</span>
<span style="color:#75715e"># mount --rbind /dev /mnt/gentoo/dev</span>
<span style="color:#75715e"># mount --make-rslave /mnt/gentoo/dev</span>
<span style="color:#75715e"># mount --bind /run /mnt/gentoo/run</span>
<span style="color:#75715e"># mount --make-slave /mnt/gentoo/run</span>
</code></pre></div><p><strong>附注</strong>：<code>--make-rslave</code>操作是稍后安装systemd支持时所需要的。</p>
<p><strong>警告</strong>：当使用非Gentoo安装媒介时，比如 Ubuntu，这时可能还不算完。一些发行版将<code>/dev/shm</code>符号链接到<code>/run/shm/</code>，在chroot后将变得不可用。为了让<code>/dev/shm/</code>是一个正常挂载的<code>tmpfs</code>，可以这样修复：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># test -L /dev/shm &amp;&amp; rm /dev/shm &amp;&amp; mkdir /dev/shm</span>
<span style="color:#75715e"># mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm</span>
</code></pre></div><p>同时确保设置了权限为<code>1777</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># chmod 1777 /dev/shm</span>
</code></pre></div><h4 id="进入新环境">进入新环境<a hidden class="anchor" aria-hidden="true" href="#进入新环境">#</a></h4>
<p>现在所有的分区已经初始化，并且基础环境已经安装，是时候进入到新的安装环境了。这意思着会话将把根目录（能访问到最顶层的位置）从当前的安装环境（安装CD或其他安装媒介）变为安装系统（叫做初始化分区）。因此叫作 <em>change root</em> 或 <em>chroot</em>。</p>
<p>完成chroot有三个步骤：</p>
<ol>
<li>使用 chroot 将根目录的位置从 <code>/</code>（在安装媒介里）更改成 <code>/mnt/gentoo/</code> （在分区里）</li>
<li>使用 <strong>source</strong> 命令将一些设置（那些在 <code>/etc/profile</code> 中的）重新载入到内存中</li>
<li>更改主提示符来帮助我们记住当前会话在一个 chroot 环境里面。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># chroot /mnt/gentoo /bin/bash</span>
<span style="color:#75715e"># source /etc/profile</span>
<span style="color:#75715e"># export PS1=&#34;(chroot) ${PS1}&#34;</span>
</code></pre></div><p>从现在开始，所有的动作将立即在新Gentoo Linux环境里生效。当然这离完成还很远，因为安装还剩下很多章节 ！</p>
<p><strong>Tip</strong>：如果安装Gentoo时在这一步之后的任何地方中断，那么“应该”可以从这一步“继续”安装。不必再重新给磁盘分区！只需要[挂载 root 分区](#挂载 root 分区) 并运行上述步骤，然后通过<a href="#%E5%A4%8D%E5%88%B6DNS%E4%BF%A1%E6%81%AF">复制 DNS 信息</a> 重新进入工作环境。 这也对修复引导程序问题很有用。 更多的信息可以在 <a href="https://wiki.gentoo.org/wiki/Chroot">chroot</a> 这篇文章中找到。</p>
<h4 id="挂载-boot-分区">挂载 boot 分区<a hidden class="anchor" aria-hidden="true" href="#挂载-boot-分区">#</a></h4>
<p>现在已经进入新的环境，必须创建并挂载 boot 分区。 当编译内核并安装引导加载程序时，这将非常重要：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mount /dev/sda1 /boot</span>
</code></pre></div><p>可以挂载到 /boot/efi/ 分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /boot/efi</span>
<span style="color:#75715e"># mount /dev/sda1 /boot/efi/</span>
</code></pre></div><h3 id="配置portage">配置Portage<a hidden class="anchor" aria-hidden="true" href="#配置portage">#</a></h3>
<h4 id="从网站安装-gentoo-ebuild-数据库快照">从网站安装 Gentoo ebuild 数据库快照<a hidden class="anchor" aria-hidden="true" href="#从网站安装-gentoo-ebuild-数据库快照">#</a></h4>
<p>接下来，是安装 Gentoo ebuild 数据库。这个快照包含一组文件，包括通知 Portage 中有关可用软件的标题（用于安装），系统管理员可以选择哪些配置文件，软件包或 profile 特定新闻 (news) 项目等。</p>
<p>建议那些使用限制性防火墙的用户使用 <strong>emerge-webrsync</strong> 命令（它使用 HTTP / FTP 协议下载快照）节省网络带宽。 没有网络或带宽限制的读者可以愉快地跳到下一节。</p>
<p>这将从Gentoo的一个镜像中获取最新的快照（每天发布）并将其安装到系统上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge-webrsync</span>
</code></pre></div><p><strong>附注</strong>：在这个操作中，<strong>emerge-webrsync</strong>可能会报找不到 <code>/var/db/repos/gentoo/</code> 位置。这是预期内的并且不用担心——这个工具将会创建这个位置。</p>
<p>从现在开始，Portage 可能会提示建议运行某些更新。这是因为在安装了一个新的repository 快照后，Portage 发现了 stage 文件中已经安装的某些软件包有更新的版本。现在可以安全的忽略包的更新；可以延迟到 Gentoo 安装完成之后更新。</p>
<h4 id="可选更新portage-ebuild-数据库">可选：更新Portage ebuild 数据库<a hidden class="anchor" aria-hidden="true" href="#可选更新portage-ebuild-数据库">#</a></h4>
<p>注：如果不配置代理的话，这个真的非常慢，非常耗时。</p>
<p>Gentoo 数据库可以更新到最新版本。前面的<strong>emerge-webrsync</strong>命令将安装一个最近的快照（通常是24小时以内），所以这一步是可选的。</p>
<p>假设需要最新更新的软件包（1小时以内），可以使用<strong>emerge &ndash;sync</strong>。这个命令将使用rsync协议来更新 Gentoo ebuild 数据库（之前通过<strong>emerge-webrsync</strong>获得的）到最新状态。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --sync</span>
</code></pre></div><p>在慢速的终端上，比如一些framebuffer或者串口控制台，建议使用<code>--quiet</code>选项来加速这个进程：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --sync --quiet</span>
</code></pre></div><h4 id="阅读新闻条目">阅读新闻条目<a hidden class="anchor" aria-hidden="true" href="#阅读新闻条目">#</a></h4>
<p>当同步Portage ebuild 数据库时，Portage 可能会输出类似于下面的信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">* IMPORTANT: <span style="color:#ae81ff">2</span> news items need reading <span style="color:#66d9ef">for</span> repository <span style="color:#e6db74">&#39;gentoo&#39;</span>.
* Use eselect news to read news items.
</code></pre></div><p>创建新闻条目是为了提供一个通信媒介，通过 Gentoo ebuild 数据库来给用户推送重要的消息。可以使用 <strong>eselect news</strong> 管理新闻条目。<strong>eselect</strong> 应用程序是一个Gentoo 特有的应用程序，它允许使用通用管理接口来管理系统。在这里，要用到 <strong>eselect</strong> 的 <code>news</code> 模块。</p>
<p>对于<code>news</code>模块，最常用的有三个操作：</p>
<ul>
<li>使用<code>list</code>显示一个可用新闻条目的预览。</li>
<li>使用<code>read</code>来阅读新闻条目。</li>
<li>使用<code>purge</code>将在新闻条目阅读后删除，并且不能再次阅读。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect news list</span>
<span style="color:#75715e"># eselect news read</span>
<span style="color:#75715e"># eselect news read --quiet</span>
</code></pre></div><p>可以通过新闻阅读器手册页查看更多关于新闻阅读器的信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># man news.eselect</span>
</code></pre></div><h4 id="选择正确的配置文件">选择正确的配置文件<a hidden class="anchor" aria-hidden="true" href="#选择正确的配置文件">#</a></h4>
<p><em>配置文件</em>是任何一个Gentoo系统的积木。它不仅指定USE、CFLAGS和其它重要变量的默认值，还会锁定系统的包版本范围。这些设定全是由Gentoo的Portage开发者们来维护。</p>
<p>使用<strong>eselect</strong>，你能看到当前系统正在使用什么配置文件，现在来使用<code>profile</code>模块：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect profile list</span>
  ...
  <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>   default/linux/amd64/17.1 <span style="color:#f92672">(</span>stable<span style="color:#f92672">)</span>
  <span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>   default/linux/amd64/17.1/selinux <span style="color:#f92672">(</span>stable<span style="color:#f92672">)</span>
  <span style="color:#f92672">[</span>3<span style="color:#f92672">]</span>   default/linux/amd64/17.1/hardened <span style="color:#f92672">(</span>stable<span style="color:#f92672">)</span>
  <span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>   default/linux/amd64/17.1/hardened/selinux <span style="color:#f92672">(</span>stable<span style="color:#f92672">)</span>
  <span style="color:#f92672">[</span>5<span style="color:#f92672">]</span>   default/linux/amd64/17.1/desktop <span style="color:#f92672">(</span>stable<span style="color:#f92672">)</span>
  <span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>   default/linux/amd64/17.1/desktop/gnome <span style="color:#f92672">(</span>stable<span style="color:#f92672">)</span>
  <span style="color:#f92672">[</span>7<span style="color:#f92672">]</span>   default/linux/amd64/17.1/desktop/gnome/systemd <span style="color:#f92672">(</span>stable<span style="color:#f92672">)</span>
  <span style="color:#f92672">[</span>8<span style="color:#f92672">]</span>   default/linux/amd64/17.1/desktop/plasma <span style="color:#f92672">(</span>stable<span style="color:#f92672">)</span>
  <span style="color:#f92672">[</span>9<span style="color:#f92672">]</span>   default/linux/amd64/17.1/desktop/plasma/systemd <span style="color:#f92672">(</span>stable<span style="color:#f92672">)</span>
  ...
</code></pre></div><p><strong>附注</strong>：命令的这个输出只是一个示例，并会随时间演变。</p>
<p>可以看到，一些架构还会有桌面的子配置文件。</p>
<p><strong>Warning</strong>：升级 profile 不能掉以轻心。 选择初始 profile 时，请确保使用与最初使用的 stage3 “相同的版本”（例如 17.1 ）。 每个新的 profile 版本都通过新闻项目公布，新闻项目中包含了迁移说明。 在切换到较新的 profile 之前，请务必阅读并遵循这些内容。</p>
<p>在看完框架的可用配置文件amd64之后，用户可以键入以下命令为系统选择一个不同的配置文件，比如选择 plasma/systemd：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect profile set 9</span>
</code></pre></div><p><strong>No-multilib</strong></p>
<p>若要选择没有 32 位应用和类库的纯 64 位环境，请使用一个 no-multilib 的配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect profile list</span>
Available profile symlink targets:
  <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>   default/linux/amd64/17.1 *
  <span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>   default/linux/default/linux/amd64/17.1/desktop
  <span style="color:#f92672">[</span>3<span style="color:#f92672">]</span>   default/linux/default/linux/amd64/17.1/desktop/gnome
  <span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>   default/linux/default/linux/amd64/17.1/desktop/kde
  <span style="color:#f92672">[</span>5<span style="color:#f92672">]</span>   default/linux/default/linux/amd64/17.1/no-multilib
</code></pre></div><p>接下来选择<em>no-multilib</em>配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect profile set 5</span>
<span style="color:#75715e"># eselect profile list</span>
Available profile symlink targets:
  <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>   default/linux/default/linux/amd64/17.1
  <span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>   default/linux/default/linux/amd64/17.1/desktop
  <span style="color:#f92672">[</span>3<span style="color:#f92672">]</span>   default/linux/default/linux/amd64/17.1/desktop/gnome
  <span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>   default/linux/default/linux/amd64/17.1/desktop/kde
  <span style="color:#f92672">[</span>5<span style="color:#f92672">]</span>   default/linux/default/linux/amd64/17.1/no-multilib *
</code></pre></div><p><strong>附注</strong>：<code>developer</code> 子配置文件是专用于Gentoo Linux开发，也就是说不是用于普通用户。</p>
<h4 id="推荐安装二进制包httpswikigentooorgwikibinary_package_guidezh-cn"><a href="https://wiki.gentoo.org/wiki/Binary_package_guide/zh-cn">推荐：安装二进制包</a><a hidden class="anchor" aria-hidden="true" href="#推荐安装二进制包httpswikigentooorgwikibinary_package_guidezh-cn">#</a></h4>
<p>对于虚拟机或其他情况，可以选择是否安装二进制包而不是自己从源码开始编译。</p>
<p>二进制包的提供是目前 Gentoo 的一种实验性质的方案，它的存在能显著缩短整体安装时间，降低机器负载，但目前对二进制包是不存在文件校验的，所以使用它有些许潜在风险。同时，使用二进制包表示将不会对本机有编译优化。（其它的也有可能导致一些需要编译的包出现编译问题）</p>
<p>另外，如果本地一些包的 [USE标记](# USE标记) 有变动或者一些包的依赖有了变动，那么对于该包， Portage 目前默认会回退到自行编译安装的状态（也推荐这样），在尽可能安装二进制包的同时，也完全不影响正常的使用。</p>
<p>如果你决定启用这个尚处于实验状态的方案，那么需创建一个文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">$ cat &gt; /etc/portage/binrepos.conf</span>
<span style="color:#66d9ef">[binhost]</span>
<span style="color:#a6e22e">priority</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">9999</span>
<span style="color:#a6e22e">sync-uri</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">https://mirrors.tuna.tsinghua.edu.cn/gentoo/experimental/amd64/binpkg/default/linux/17.1/x86-64/</span>
</code></pre></div><p>sync-uri 可以配置成任意所选镜像地址</p>
<p>再编辑 <code>/etc/portage/make.conf</code> 文件，设置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">EMERGE_DEFAULT_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--binpkg-changed-deps=y --binpkg-respect-use=y --getbinpkg=y&#34;</span>
</code></pre></div><p>最终，我的配置为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;EMERGE_DEFAULT_OPTS=&#34;--binpkg-changed-deps=y --binpkg-respect-use=y --getbinpkg=y --autounmask --autounmask-keep-masks --autounmask-write=n --keep-going -v -a&#34;&#39; &gt;&gt; /etc/portage/make.conf</span>
</code></pre></div><h4 id="配置use变量">配置USE变量<a hidden class="anchor" aria-hidden="true" href="#配置use变量">#</a></h4>
<p>USE是Gentoo为用户提供的最具威力的变量之一。很多程序通过它可以选择编译或者不编译某些可选的支持。例如，一些程序可以在编译时加入对 GTK+或是对Qt的支持。其它的程序可以在编译时加入或不加入对于SLL的支持。有些程序甚至可以在编译时加入对framebuffer的支持（svgalib）以取代X11（X服务器）。</p>
<p>大多数的发行版会使用尽可能多的支持特性编译它们的软件包，这既增加了软件的大小也减慢了启动时间，而这些还没有算上可能会涉及到的大量依赖性问题。Gentoo可以让你自己定义软件编译的选项，而这正是USE要做的事。</p>
<p>在USE变量里你可以定义关键字，它被用来对应相应的编译选项。例如，<code>ssl</code>将会把SSL支持编译到程序中以支持它。<code>-X</code>会移除其对于X服务器的支持（注意前面的减号）。<code>gnome gtk -kde -qt4 -qt5</code>将会以支持GNOME（和GTK+）但不支持KDE（和Qt）的方式编译软件，使系统为GNOME做完全调整（如果架构支持）。</p>
<p>默认的USE设置全放在了系统所使用的Gentoo配置文件的<code>make.defaults</code>文件中。Gentoo对它的配置文件们使用了一个（复杂的）继承系统，在这个阶段我们不去深入。最简单的检查当前活动的USE标记的办法是运行<strong>emerge &ndash;info</strong>并选择以USE开头的那一行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --info | grep ^USE</span>
USE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;X acl alsa amd64 berkdb bindist bzip2 cli cracklib crypt cxx dri ...&#34;</span>
</code></pre></div><p><strong>附注</strong>：上面的示例被截断了，实际上的USE列表值是非常非常多的。</p>
<p>可以在系统的 <code>/var/db/repos/gentoo/profiles/use.desc</code> 中找到可用的USE标记的完整描述。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># less /var/db/repos/gentoo/profiles/use.desc</span>
</code></pre></div><p>在<strong>less</strong>命令中，可以通过使用<code>↑</code>和<code>↓</code>键来滚动，并且可以按<code>q</code>退出。</p>
<p>作为示例，我们展示一个支持DVD、ALSA,以及CD录制的基于KDE系统的USE设置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/make.conf</span>
USE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-gtk -gnome qt5 kde dvd alsa cdr&#34;</span>
</code></pre></div><p>当USE在<code>/etc/portage/make.conf</code>中定义，会从那个默认列表中<em>添加</em>（或者<em>移除</em>，如果USE标记以<code>-</code>号开头的话）。用户想忽略所有默认的USE设置并完全由自己管理的话，应该在make.conf中定义USE以<code>-*</code>开头：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">USE</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-* X acl alsa &#34;</span>
</code></pre></div><p><strong>警告</strong>：由于仔细选择 USE 标志默认值可能会对某些软件包防止冲突和其它错误，所以尽管可以设置 <code>-*</code>（如上例所示），但不鼓励这样做。</p>
<h4 id="推荐-配置-accept_license-变量">推荐： 配置 ACCEPT_LICENSE 变量<a hidden class="anchor" aria-hidden="true" href="#推荐-配置-accept_license-变量">#</a></h4>
<p>Gentoo 对所有的软件包都使用包所属的许可证进行标记。这允许用户在安装软件之前根据特定的许可证或许可证组来选择软件。</p>
<p><strong>Important</strong>：ebuild 中 的 LICENSE 变量仅是为 Gentoo 开发人员和用户准备的一份指南。它既不是法律声明，也不保证其真实性。因此不要过度依赖它，您需要深入检查软件包的本身，以及您使用的所有文件。</p>
<p>Portage 使用 ACCEPT_LICENSE 变量决定那些包允许对之前接受的许可证不提示用户。同样，也可以在 <code>/etc/portage/package.license</code> 中每个包中设置例外。</p>
<p>在 Gentoo 仓库中定义的许可证组，由 <a href="https://wiki.gentoo.org/wiki/Project:Licenses">Gentoo Licenses project</a> 项目管理，有：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Group Name</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="https://www.gnu.org/licenses/license-list.html">@GPL-COMPATIBLE</a></td>
<td style="text-align:left">GPL compatible licenses approved by the Free Software Foundation</td>
</tr>
<tr>
<td style="text-align:left">@FSF-APPROVED</td>
<td style="text-align:left">Free software licenses approved by the FSF (includes @GPL-COMPATIBLE)</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://www.opensource.org/licenses">@OSI-APPROVED</a></td>
<td style="text-align:left">Licenses approved by the Open Source Initiative</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://www.gnu.org/philosophy/free-sw.html">@MISC-FREE</a></td>
<td style="text-align:left">Misc licenses that are probably free software, i.e. follow the Free Software Definition but are not approved by either FSF or OSI</td>
</tr>
<tr>
<td style="text-align:left">@FREE-SOFTWARE</td>
<td style="text-align:left">Combines @FSF-APPROVED, @OSI-APPROVED and @MISC-FREE</td>
</tr>
<tr>
<td style="text-align:left">@FSF-APPROVED-OTHER</td>
<td style="text-align:left">FSF-approved licenses for &ldquo;free documentation&rdquo; and &ldquo;works of practical use besides software and documentation&rdquo; (including fonts)</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://freedomdefined.org/">@MISC-FREE-DOCS</a></td>
<td style="text-align:left">Misc licenses for free documents and other works (including fonts) that follow the free definition but are NOT listed in @FSF-APPROVED-OTHER</td>
</tr>
<tr>
<td style="text-align:left">@FREE-DOCUMENTS</td>
<td style="text-align:left">Combines @FSF-APPROVED-OTHER and @MISC-FREE-DOCS</td>
</tr>
<tr>
<td style="text-align:left">@FREE</td>
<td style="text-align:left">Metaset of all licenses with the freedom to use, share, modify and share modifications. Combines @FREE-SOFTWARE and @FREE-DOCUMENTS</td>
</tr>
<tr>
<td style="text-align:left">@BINARY-REDISTRIBUTABLE</td>
<td style="text-align:left">Licenses that at least permit free redistribution of the software in binary form. Includes @FREE</td>
</tr>
<tr>
<td style="text-align:left">@EULA</td>
<td style="text-align:left">License agreements that try to take away your rights. These are more restrictive than &ldquo;all-rights-reserved&rdquo; or require explicit approval</td>
</tr>
</tbody>
</table>
<p>Gentoo 在配置文件中提供了有预定义的值，默认接受由自由软件基金会明确批准的许可，开源项目或者遵循自由软件定义，例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># portageq envvar ACCEPT_LICENSE</span>
@FREE
</code></pre></div><p>可以通过更改 <code>/etc/portage/make.conf</code> 来自定义整个系统，使之接受所有许可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;ACCEPT_LICENSE=&#34;*&#34;&#39; &gt;&gt; /etc/portage/make.conf</span>
</code></pre></div><p>还可以根据需要添加每个软件包的覆盖：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/package.license/kernel</span>
app-arch/unrar unRAR
sys-kernel/linux-firmware @BINARY-REDISTRIBUTABLE
sys-firmware/intel-microcode intel-ucode
</code></pre></div><h4 id="更新world集合">更新@world集合<a hidden class="anchor" aria-hidden="true" href="#更新world集合">#</a></h4>
<p>程序的原子指的是由完整类别组成的名称，没有版本和其他的限定符号比如说 net-vpn/openvpn。什么时候会用到原子呢？比如说你要引用一个基于SQLite的数据库 dev-python/axiom 但是这个是和sci-mathematics/axiom 是一个软件包名字这个时候原子就派上用场了。</p>
<p>可以将多个原子分为一组，从而可以针对整个组来进行操作（比如说重建某个组）。对于这个组有个名字：集合，集合以<code>@</code>作为前缀，其中一些是在Portage里由预先定义的比如说 <code>@system</code>集合包括主要的系统软件包。像是我们安装一个软件包（原子）这个就会记录在 <code>/var/lib/portage/world</code>中 (<code>@world</code>集合包含了<code>@system</code>集合，如果有需要还可以自己定义集合)。将 <code>world</code> 文件复制到其它运行 Gentoo 的电脑上，就可以还原原机器上安装的软件和环境。</p>
<p>明智的做法是更新系统的 <a href="https://wiki.gentoo.org/wiki/World_set_(Portage)">@world set</a> ，以便可以构建系统。</p>
<p>当系统应用了任何升级，或从 任何profile 构建了stage3 后，应用了变化的 use 标记时，下一步是“必要”的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask --verbose --update --deep --newuse @world</span>
</code></pre></div><p><strong>Tip</strong>：如果选择了桌面环境配置文件，则此过程可能大大增加安装过程所需的时间量。 时间紧迫的人可以通过这个“经验法则”工作： 配置文件名称越短，系统的特定属性越少，@world设置的特定性越低，系统将需要的软件包越少。 换一种说法：</p>
<ul>
<li>选择 <code>default/linux/amd64/17.1</code> 将只有很少的包被重装或更新</li>
<li>选择 <code>default/linux/amd64/17.1/desktop/gnome/systemd</code> 将需要安装许多软件包，因为init系统要更改为systemd，并且将安装GNOME桌面环境框架。</li>
</ul>
<h3 id="可选使用-openrc-作为-init-系统">可选：使用 OpenRC 作为 init 系统<a hidden class="anchor" aria-hidden="true" href="#可选使用-openrc-作为-init-系统">#</a></h3>
<p>**本文的后续部分专注于  <a href="https://wiki.gentoo.org/wiki/Systemd/zh-cn">Systemd</a> 作为默认的 init 系统。**如果读者要安装 <a href="https://wiki.gentoo.org/wiki/GNOME">GNOME</a> 3.8 及之后版本则必须使用 Systemd。如果需要使用 <a href="https://wiki.gentoo.org/wiki/OpenRC">OpenRC</a> （传统的 Gentoo init 系统），可以阅读<a href="https://wiki.gentoo.org/wiki/Handbook:AMD64">官方文档</a>。</p>
<h3 id="时区">时区<a hidden class="anchor" aria-hidden="true" href="#时区">#</a></h3>
<p>为系统选择时区。在/usr/share/zoneinfo/中查找可用的时区。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ls /usr/share/zoneinfo</span>
</code></pre></div><p>假设选择的时区是 Asia/Shanghai，生成一个符号链接：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span>
</code></pre></div><p>稍后，当系统运行时，我们可以使用<em>timedatectl</em>命令配置时区和相关设置。</p>
<h3 id="配置-locale">配置 locale<a hidden class="anchor" aria-hidden="true" href="#配置-locale">#</a></h3>
<h4 id="locale-生成">Locale 生成<a hidden class="anchor" aria-hidden="true" href="#locale-生成">#</a></h4>
<p>大多数用户只想在他们的系统上使用一或两个地区。对于 root 用户而言，<strong>一般使用默认的配置即可</strong>。但这里需要添加上自己所需其它语言设置以供普通用户使用。</p>
<p>Locale 不只是指定用户应该使用与系统进行交互的语言，同时也指定了字符串排序，日期和时间的显示等规则。Locale 是 &ldquo;区分大小写&rdquo; 的，必须完全按照描述的方式表示。完整的 locale 可用列表可以在 <code>/usr/share/i18n/SUPPORTED</code> 文件中找到。</p>
<p>系统支持的 locale 必须在 <code>/etc/locale.gen</code> 文件中定义。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># &lt;语言&gt;_&lt;国家代码&gt;[@可选的变体].&lt;编码&gt; &lt;编码&gt;</span>
</code></pre></div><p>下面的地区是一个示例，展示了同时使用英语（美国）和汉语（中国）及附加字符格式（如UTF-8）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cat &gt;&gt; /etc/locale.gen</span>
en_US.UTF-8 UTF-8
zh_CN.UTF-8 UTF-8
</code></pre></div><p><strong>警告</strong>：我们&quot;强烈&quot;建议添加至少一个UTF-8格式的地区设置，因为许多应用程序也许需要这样才能正确构建。</p>
<p>下一步是运行 <strong>locale-gen</strong> 命令。此命令会生成 <code>/etc/locale.gen</code> 文件中所有指定的地区。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># locale-gen</span>
</code></pre></div><p>要验证当前所选择的 locale 可用，可以运行 <strong>locale -a</strong>。</p>
<h4 id="locale-选择">Locale 选择<a hidden class="anchor" aria-hidden="true" href="#locale-选择">#</a></h4>
<p>等完成后，我们就来设定系统级别的 locale 设置。我们又一次使用 <strong>eselect</strong> 来做这件事，现在使用 <code>locale</code> 模块。</p>
<p>通过 <strong>eselect locale list</strong> 可显示可用的目标：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect locale list</span>
Available targets <span style="color:#66d9ef">for</span> the LANG variable:
  <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>   C
  <span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>   C.utf8
  <span style="color:#f92672">[</span>3<span style="color:#f92672">]</span>   POSIX
  <span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>   en_US.utf8
  <span style="color:#f92672">[</span>5<span style="color:#f92672">]</span>   zh_CN.utf8
  <span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>   C.UTF8 *
  <span style="color:#f92672">[</span> <span style="color:#f92672">]</span>   <span style="color:#f92672">(</span>free form<span style="color:#f92672">)</span>
</code></pre></div><p>可以使用 <strong><code>eselect locale set &lt;NUMBER&gt;</code></strong> 选择正确的 locale：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect locale set 4</span>
</code></pre></div><p>这个还可以通过手动编辑 <code>/etc/env.d/02locale</code> 文件来完成：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">LANG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zh_CN.UTF-8&#34;</span>
LC_COLLATE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;C&#34;</span>
</code></pre></div><p>设定 locale 可以避免在后面安装中，内核和软件汇编时的警告和错误。</p>
<p>现在重新加载环境：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># env-update &amp;&amp; source /etc/profile &amp;&amp; export PS1=&#34;(chroot) ${PS1}&#34;</span>
</code></pre></div><p>完整的<a href="https://wiki.gentoo.org/wiki/Localization/Guide">本地化指南</a>提供了有关 locale 选择过程的其他指导。另一个有意思的文章是为系统启用 UTF-8 的具体信息的 <a href="https://wiki.gentoo.org/wiki/UTF-8">UTF-8</a> 指南。</p>
<h2 id="配置linux内核httpswikigentooorgwikihandbookamd64installationkernel"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Kernel">配置Linux内核</a><a hidden class="anchor" aria-hidden="true" href="#配置linux内核httpswikigentooorgwikihandbookamd64installationkernel">#</a></h2>
<h3 id="安装源码">安装源码<a hidden class="anchor" aria-hidden="true" href="#安装源码">#</a></h3>
<p>Linux内核是所有发行版的核心。它位于用户程序和系统硬件之间。Gentoo提供给用户一些可选的内核源码。完整的带描述的列表在<a href="https://wiki.gentoo.org/wiki/Kernel/Overview">内核概述页面</a>。</p>
<p>Gentoo Linux 所提供的可用内核源码包都在 <code>sys-kernel</code> 类下。而其中以下两个个版本更通用：</p>
<ul>
<li>
<p>sys-kernel/gentoo-sources</p>
<p>这是最高到内核主线版本的内核源码包，需要自行配置后，再自行编译后安装</p>
</li>
<li>
<p>sys-kernel/gentoo-kernel</p>
<p>这是最高到内核主线版本的内核源码包，但同时包含了通用的内核配置，可自动编译后安装</p>
</li>
</ul>
<p>针对基于amd64 系统的Gentoo，建议使用包<a href="https://packages.gentoo.org/packages/sys-kernel/gentoo-sources"> sys-kernel/gentoo-sources</a>。</p>
<p>选择一个合适的内核并使用<strong>emerge</strong>来安装它。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-kernel/gentoo-sources</span>
</code></pre></div><p>这将在<code>/usr/src/</code>中安装Linux内核源码。如果在选择的内核源代码包上没有启用<code>USE=symlink</code>，它将不会自己创建一个符号链接。</p>
<p>通常需要维护<code>/usr/src/linux</code>符号链接，这样它就指向与当前运行的内核相对应的源代码。但是，默认情况下不会创建这个符号链接。创建符号链接的一个简单方法是利用eselect的内核模块。</p>
<p>关于符号链接的目的以及如何管理它的更多信息，请参阅 <a href="https://wiki.gentoo.org/wiki/Kernel/Upgrade">Kernel/Upgrade</a>。</p>
<p>首先，列出所有已安装的内核:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect kernel list</span>
Available kernel symlink targets:
  <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>   linux-4.9.16-gentoo
</code></pre></div><p>要创建一个名为linux的符号链接，请使用:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect kernel set 1</span>
<span style="color:#75715e"># ls -l /usr/src/linux</span>
lrwxrwxrwx    <span style="color:#ae81ff">1</span> root   root    <span style="color:#ae81ff">12</span> Oct <span style="color:#ae81ff">13</span> 11:04 /usr/src/linux -&gt; linux-4.9.16-gentoo
</code></pre></div><p>现在是时候来配置和编译内核源代码了。有两种方法：</p>
<ol>
<li>手动配置并生成内核。</li>
<li>一个叫作<strong>genkernel</strong>的工具用来自动化生成并安装Linux内核。</li>
</ol>
<p>我们在这里解释做为默认选择的手动配置，它是优化环境的最好方式。</p>
<h3 id="默认手动配置">默认：手动配置<a hidden class="anchor" aria-hidden="true" href="#默认手动配置">#</a></h3>
<h4 id="介绍-2">介绍<a hidden class="anchor" aria-hidden="true" href="#介绍-2">#</a></h4>
<p>手动配置内核经常被Linux用户认为是最困难的步骤。事实并非如此——但是当您手动配置几次内核之后，你就不会再觉得它有多么难了：）</p>
<p>无论如何，有一件事是真实的：当手动配置内核时，了解（硬件）系统是至关重要的。大多数信息可以通过安装包含<strong>lspci</strong>命令的<a href="https://packages.gentoo.org/packages/sys-apps/pciutils">sys-apps/pciutils</a>来收集：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-apps/pciutils</span>
</code></pre></div><p><strong>附注</strong>：在chroot中，可以安全的忽略任何<strong>lspci</strong>可能抛出的关于pcilib的警告（比如<em>pcilib: cannot open /sys/bus/pci/devices</em>）。</p>
<p>另一个系统信息来源是运行<strong>lsmod</strong>来查看安装CD使用什么内核模块，它可能对启用什么提供了一个好的暗示。</p>
<p>现在进入内核源码目录并执行<strong>make menuconfig</strong>。这将启动一个菜单驱动的配置屏幕。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cd /usr/src/linux</span>
<span style="color:#75715e"># make menuconfig</span>
</code></pre></div><p>Linux内核配置有很多很多的章节。我们先列出一些必须激活的选项（否则Gentoo将无法工作，或者离开附加的调整将无法正常工作）。我们同时在Gentoo维基上有一个<a href="https://wiki.gentoo.org/wiki/Kernel/Gentoo_Kernel_Configuration_Guide">Gentoo内核配置指南</a>可能会在将来有帮助。</p>
<h4 id="激活必要的选项">激活必要的选项<a hidden class="anchor" aria-hidden="true" href="#激活必要的选项">#</a></h4>
<p>如果您使用的是 <a href="https://packages.gentoo.org/packages/sys-kernel/gentoo-sources">sys-kernel/gentoo-sources</a>，我们强烈建议您启用Gentoo的配置选项。这些确保可以使用适当的功能所需的最低内核功能：</p>
<pre tabindex="0"><code>Gentoo Linux ---&gt;
  Generic Driver Options ---&gt;
    [*] Gentoo Linux support
    [*]   Linux dynamic and persistent device naming (userspace devfs) support
    [*]   Select options required by Portage features
        Support for init systems, system and service managers  ---&gt;
          [*] OpenRC, runit and other script based systems and managers
          [*] systemd
</code></pre><p>当然，您在最后两行中的选择取决于您的Init系统（OpenRC与Systemd）的选择。</p>
<p>如果您使用的是 <a href="https://packages.gentoo.org/packages/sys-kernel/vanilla-sources">sys-kernel/vanilla-sources</a>, ，您必须自己找到所需的选项。</p>
<p>确保引导系统的每一个至关重要的驱动（比如SCSI控制器,等等）是编译进内核而不是作为一个模块，否则系统将无法完全引导。</p>
<p>接下来选择最正确的CPU类型。同时建议启用MCE功能（如果可用）能在硬件出现问题时通知用户。在一些架构（比如x86_64），这些错误不会打印到 <strong>dmesg</strong>，但是会到/dev/mcelog。这需要<a href="https://packages.gentoo.org/packages/app-admin/mcelog">app-admin/mcelog</a>包。</p>
<p>同时选择<em>Maintain a devtmpfs file system to mount at /dev</em>来让重要的设备文件在引导过程的早期就已就绪(CONFIG_DEVTMPFS and CONFIG_DEVTMPFS_MOUNT):</p>
<pre tabindex="0"><code>Device Drivers ---&gt;
  Generic Driver Options ---&gt;
    [*] Maintain a devtmpfs filesystem to mount at /dev
    [*]   Automount devtmpfs at /dev, after the kernel mounted the rootfs
</code></pre><p>验证 SCSI 磁盘支持是否已激活(CONFIG_BLK_DEV_SD):</p>
<pre tabindex="0"><code>Device Drivers ---&gt;
   SCSI device support  ---&gt;
      &lt;*&gt; SCSI disk support
</code></pre><p>现在进入File Systems并选择你使用的文件系统。不要作为模块来编译根文件系统所使用的文件系统，否则Gentoo系统将不能挂载这个分区。同时选择<em>Virtual memory</em>和*/proc file system*根据系统的需要选择一个或多个以下选项(CONFIG_EXT2_FS, CONFIG_EXT3_FS, CONFIG_EXT4_FS, CONFIG_MSDOS_FS, CONFIG_VFAT_FS, CONFIG_PROC_FS, and CONFIG_TMPFS):</p>
<pre tabindex="0"><code>File systems ---&gt;
  &lt;*&gt; Second extended fs support
  &lt;*&gt; The Extended 3 (ext3) filesystem
  &lt;*&gt; The Extended 4 (ext4) filesystem
  &lt;*&gt; Reiserfs support
  &lt;*&gt; JFS filesystem support
  &lt;*&gt; XFS filesystem support
  &lt;*&gt; Btrfs filesystem support
  DOS/FAT/NT Filesystems  ---&gt;
    &lt;*&gt; MSDOS fs support
    &lt;*&gt; VFAT (Windows-95) fs support
 
  Pseudo Filesystems ---&gt;
    [*] /proc file system support
    [*] Tmpfs virtual memory file system support (former shm fs)
</code></pre><p>如果使用PPPoE连接到互联网，或者是拨号调制解调器，则启用下面的选项(CONFIG_PPP, CONFIG_PPP_ASYNC, and CONFIG_PPP_SYNC_TTY)：</p>
<pre tabindex="0"><code>Device Drivers ---&gt;
  Network device support ---&gt;
    &lt;*&gt; PPP (point-to-point protocol) support
    &lt;*&gt;   PPP support for async serial ports
    &lt;*&gt;   PPP support for sync tty ports
</code></pre><p>这两个压缩选项将是无害的，但是它们一定是不需要的，包括基于以太网的PPP选项也是一样，只有在配置内核模式PPPoE时才会需要。</p>
<p>不要忘记在内核中包括网（以太网或无线）卡。</p>
<p>大多数系统会有多核心处理，所以激活“Symmetric multi-processing support”是重要的' (CONFIG_SMP)：</p>
<pre tabindex="0"><code>Processor type and features  ---&gt;
  [*] Symmetric multi-processing support
</code></pre><p><strong>附注</strong>：在多核心系统中，每一个核心计作一个处理器。</p>
<p>如果使用USB输入设备（比如键盘和鼠标）或其他USB设备，不要忘记启用那些(CONFIG_HID_GENERIC and CONFIG_USB_HID, CONFIG_USB_SUPPORT, CONFIG_USB_XHCI_HCD, CONFIG_USB_EHCI_HCD, CONFIG_USB_OHCI_HCD):：</p>
<pre tabindex="0"><code>Device Drivers ---&gt;
  HID support  ---&gt;
    -*- HID bus support
    &lt;*&gt;   Generic HID driver
    [*]   Battery level reporting for HID devices
      USB HID support  ---&gt;
        &lt;*&gt; USB HID transport layer
  [*] USB support  ---&gt;
    &lt;*&gt;     xHCI HCD (USB 3.0) support
    &lt;*&gt;     EHCI HCD (USB 2.0) support
    &lt;*&gt;     OHCI HCD (USB 1.1) support
</code></pre><h4 id="架构特有的内核配置">架构特有的内核配置<a hidden class="anchor" aria-hidden="true" href="#架构特有的内核配置">#</a></h4>
<p>如果要支持32位程序，请确保选择IA32 Emulation(CONFIG_IA32_EMULATION)。Gentoo 默认会安装一个multilib 系统（混合 32 位/ 64 位计算），所以除非使用了一个 no-multilib 配置文件，否则这个选项是必需的。</p>
<pre tabindex="0"><code>Processor type and features  ---&gt;
   [ ] Machine Check / overheating reporting 
   [ ]   Intel MCE Features
   [ ]   AMD MCE Features
   Processor family (AMD-Opteron/Athlon64)  ---&gt;
      ( ) Opteron/Athlon64/Hammer/K8
      ( ) Intel P4 / older Netburst based Xeon
      ( ) Core 2/newer Xeon
      ( ) Intel Atom
      ( ) Generic-x86-64
Executable file formats / Emulations  ---&gt;
   [*] IA32 Emulation
</code></pre><p>如果在分区时使用GPT分区标签，则启用对它的支持 (CONFIG_PARTITION_ADVANCED and CONFIG_EFI_PARTITION)：</p>
<pre tabindex="0"><code>-*- Enable the block layer ---&gt;
   Partition Types ---&gt;
      [*] Advanced partition selection
      [*] EFI GUID Partition support
</code></pre><p>如果使用UEFI来引导系统，则在内核中启用EFI桩支持和EFI变量 (CONFIG_EFI, CONFIG_EFI_STUB, CONFIG_EFI_MIXED, and CONFIG_EFI_VARS)：</p>
<pre tabindex="0"><code>Processor type and features  ---&gt;
    [*] EFI runtime service support 
    [*]   EFI stub support
    [*]     EFI mixed-mode support
 
Firmware Drivers  ---&gt;
    EFI (Extensible Firmware Interface) Support  ---&gt;
        &lt;*&gt; EFI Variable Support via sysfs
</code></pre><h4 id="编译和安装">编译和安装<a hidden class="anchor" aria-hidden="true" href="#编译和安装">#</a></h4>
<p>当配置完成，是时间来编译和安装内核了。退出配置并开始编译过程：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># make &amp;&amp; make modules_install</span>
</code></pre></div><p><strong>附注</strong>：还可以启用并行生成使用<strong>make -jX</strong>，<code>X</code>是一个生成过程中所允许运行的并行任务的整数。这类似于早期有关<code>/etc/portage/make.conf</code>的中关于MAKEOPTS变量的介绍。</p>
<p>当内核完成编译，复制内核镜像到<code>/boot/</code>。这由<strong>make install</strong>命令来处理：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># make install</span>
</code></pre></div><p>这将复制内核镜像到<code>/boot/</code>，一起的还有<code>System.map</code>文件和内核配置文件。</p>
<h4 id="可选生成一个initramfs">可选：生成一个initramfs<a hidden class="anchor" aria-hidden="true" href="#可选生成一个initramfs">#</a></h4>
<p>在某些情况中需要建立一个initramfs (initial ram file system) ——一个基于内存的初始化文件系统，它用于解决如何在真正初始化系统运行前执行用户空间程序。类似的方案还有一种叫 initrd ，两者功能基本一致，实现方式有差异。</p>
<p>它代表着一种方案，也代表着一个文件。它在一些基础情况下并不是必须的。</p>
<p>在说明它存在的意义前，先简单说明下 Linux 系统的基本启动流程：</p>
<ol>
<li>PC 加电，BIOS/UEFI 自检后载入系统引导程序</li>
<li>引导程序载入内核</li>
<li>内核挂载根目录所对应的分区</li>
<li>内核执行根目录下系统的初始化（init）命令</li>
<li>自此来到了用户空间下</li>
</ol>
<p>这个基本的流程里面会出现问题，看步骤 3</p>
<ul>
<li>问题一、如果这个根目录的分区无法直接挂载怎么办（被加密了、使用了 RAID、它是一个 NFS，等情况）</li>
<li>问题二、如果这个根目录的分区下的 <code>/usr</code> 又单独分区了，里面没所需文件怎么办（这个文件夹包含了系统的库文件等）</li>
</ul>
<p>如果上述两种情况都未出现，那么只要把根目录分区所对应的文件系统驱动被编译进内核（而非模块的形式），就可以省略掉 initramfs ；如果出现了任意一种情况，这个时候就需要 initramfs 的参与。</p>
<p>正如前文所说， initramfs 提供了在真正系统初始化前提前进入用户空间的功能，它其实就是一个简略版的完整系统，通过它，可以把该解密的分区解密，该挂载的内核无法直接挂载的分区（包括模块未加载，额外的分区，需要联网等情况）都挂载好，之后再由根目录下真正的系统初始化程序接管。</p>
<p>如果没有initramfs的，存在着巨大的风险，系统将无法正常开机，因为这是负责安装的文件系统工具需要驻留在这些文件系统的信息。 initramfs中的一个将在必要的文件拉进它的内核启动之后使用的档案，但控制被移交前转移到初始化工具。在initramfs的脚本，然后将确保分区正确地安装在系统继续启动之前。</p>
<p>Gentoo Linux 提供了一个工具叫 <a href="https://packages.gentoo.org/packages/sys-kernel/genkernel">sys-kernel/genkernel</a> 可用于创建 initramfs，其配置文件位于 <code>/etc/genkernel.conf</code> ，里面对每个变量的设置都有详细的说明。 有别于其它的 initramfs 创建工具， genkernel 会单独编译一个独立的 initramfs 环境（而非直接使用当前系统环境），并打包压缩。这会使得其相对于其它的工具（比如 dracut）创建过程更慢。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-kernel/genkernel</span>
<span style="color:#75715e"># genkernel --install --kernel-config=/path/to/used/kernel.config initramfs</span>
</code></pre></div><p>为了在initramfs中启用特定的支持，比如LVM或RAID，要为<strong>genkernel</strong>添加一个合适的选项。查看<strong>genkernel &ndash;help</strong>以获得更多信息。在下面的示例中，我们启用LVM和软件RAID (<strong>mdadm</strong>) 的支持：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># genkernel --lvm --mdadm --install --kernel-config=/path/to/used/kernel.config initramfs</span>
</code></pre></div><p>initramfs将存储在/boot/。结果文件可以简单的通过列出以<em>initramfs</em>开头的文件来找到：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ls /boot/initramfs*</span>
</code></pre></div><p>现在继续到<a href="#%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97">内核模块</a>。</p>
<h4 id="备选localmodconfig">备选：localmodconfig<a hidden class="anchor" aria-hidden="true" href="#备选localmodconfig">#</a></h4>
<p>内核是否真的需要自定义配置？这个问题因人而异，有人想要一份精简的内核，有人只要功能完善即可。我个人建议则是，非嵌入式环境下，对内核体积没要求情况下量力而行即可。内核的配置系统太过庞与复杂，理解所有的配置很难。而纯粹使用通用的配置则会导致模块目录太大，无用的模块太多，也不妥。</p>
<p><code>make localmodconfig</code> 生成了一份完整的内核配置文件。此命令的含义是，以当前系统环境为参考，禁用没有被加载的模块配置。可在纯模块加载的系统环境下，接上你有的设备，开启你需要用到的所有服务，然后执行它。一般用于首次配置内核，使得后续配置更轻松。</p>
<p>而进一步的配置可以在内核目录下使用 <code>make menuconfig</code> 命令打开一个界面化的配置菜单，根据界面内提示进行。也可以执行 <code>make help</code> 显示帮助信息，以方便根据需要自行选择。</p>
<p>自定义配置时，建议给该配置文件设定一个自定义版本，以便于区分，配置路径位于:</p>
<pre tabindex="0"><code>General setup  ---&gt;
  (-examplename) Local version - append to kernel release
</code></pre><p>其它的项目本文不会说明，建议查阅 <a href="https://wiki.gentoo.org/wiki/Kernel#Configuration">官方内核配置文档</a> ，其它可查阅的资料有：</p>
<ul>
<li>在界面化的配置菜单界面，选中选项按下 h 后显示的说明</li>
<li>查询硬件设备对应驱动的 Linux-Hardware 站点（英文）： <a href="https://linux-hardware.org/index.php?view=search">https://linux-hardware.org/index.php?view=search</a></li>
<li>cateee.net 的 Linux 内核驱动数据库（英文）： <a href="https://cateee.net/lkddb/web-lkddb/">https://cateee.net/lkddb/web-lkddb/</a></li>
<li>金步国针对旧版本内核的配置说明（中文）： <a href="http://www.jinbuguo.com/kernel/longterm-linux-kernel-options.html">http://www.jinbuguo.com/kernel/longterm-linux-kernel-options.html</a></li>
</ul>
<h3 id="备选使用genkernel">备选：使用genkernel<a hidden class="anchor" aria-hidden="true" href="#备选使用genkernel">#</a></h3>
<p>如果手动配置看起来太恐怖，建议使用<strong>genkernel</strong>。它将自动配置并编译内核。</p>
<p><strong>genkernel</strong>配置内核的工作原理几乎和安装CD配置的内核完全一致。也就是说当使用<strong>genkernel</strong>建立内核，系统通常将在引导时检测全部硬件，就像安装CD所做的。因为<strong>genkernel</strong>不需要任何手动内核配置，它对于那些不能轻松的编译他们自动内核的用户来说是一个理想的解决方案。</p>
<p>现在，我们来看看如何使用genkernel。首先emerge <a href="https://packages.gentoo.org/packages/sys-kernel/genkernel">sys-kernel/genkernel</a>这个ebuild：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-kernel/genkernel</span>
</code></pre></div><p>接下来，编辑/etc/fstab文件来使包含有第二个值为/boot/的那条的第一个值指向到正确的设备。如果是按照本手册的分区示例，则这个设备非常像使用ext4文件系统的/dev/sda1。这将使文件中的这一条目看起来像是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/fstab</span>
/dev/sda1	/boot	ext4	defaults	<span style="color:#ae81ff">0</span> <span style="color:#ae81ff">2</span>
</code></pre></div><p><strong>附注</strong>：在Gentoo将来的安装中，还要再配置一次/etc/fstab。现在只需要正确设置/boot来让<strong>genkernel</strong>应用程序读到相应的配置。</p>
<p>现在，运行<strong>genkernel all</strong>来编译内核源码。值得注意的是，使用<strong>genkernel</strong>编译一个内核将支持几乎全部的硬件，这将使编译过程需要一阵子来完成！</p>
<p><strong>附注</strong>：如果引导分区不是使用ext4作为文件系统，它<em>可能</em>需要使用<strong>genkernel &ndash;menuconfig all</strong>来手动配置内核，并在内核中添加对这个具体文件系统的支持（比如：不是作为一个模块）。LVM2用户可能要作为参数来添加<code>--lvm</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># genkernel all</span>
</code></pre></div><p>一旦genkernel完成，将创建一个内核、全部的模块和初始化内存文件（initramfs）。我们将在文档后面配置引导器的时候使用这个内核和initrd。记下内核和initrd名字作为编辑引导器配置文件的信息。initrd将在后执行硬件检测之后、“真实”系统启动之前立即启动。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ls /boot/kernel* /boot/initramfs*</span>
</code></pre></div><h3 id="推荐二进制">推荐：二进制<a hidden class="anchor" aria-hidden="true" href="#推荐二进制">#</a></h3>
<p>因为内核的配置非常复杂，需根据每台机器的环境而定，为了简单与节约时间，可以选择预编译好的，适用范围最广的二进制内核。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-kernel/gentoo-kernel-bin</span>
</code></pre></div><p><code>sys-kernel/gentoo-kernel-bin</code> 是最高到内核主线版本的内核二进制包，其使用的是最通用的内核配置。</p>
<h3 id="内核模块">内核模块<a hidden class="anchor" aria-hidden="true" href="#内核模块">#</a></h3>
<h4 id="配置模块">配置模块<a hidden class="anchor" aria-hidden="true" href="#配置模块">#</a></h4>
<p><strong>附注</strong>：硬件模块手动列出是可选的。在大多数情况下，<strong>udev</strong>通常将加载所有被检测为已连接的硬件模块。然而，列出自动检测到的模块是没有什么不良影响的。有时，一些奇特硬件需要帮助来加载其驱动程序。</p>
<p>在 /etc/modules-load.d/<em>.conf 中各个模块的每一行列出需要自动加载的模块。如果有必要的话，可以在 /etc/modprobe.d/</em>.conf 文件中，为模块设置添加附加选项。</p>
<p>要查看所有可用模块，运行下面的<strong>find</strong>命令。不要忘记替换“<code>&lt;kernel version&gt;</code>”为刚刚编译的内核版本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># find /lib/modules/&lt;kernel version&gt;/ -type f -iname &#39;*.o&#39; -or -iname &#39;*.ko&#39; | less</span>
</code></pre></div><p>比如，要自动加载3c59x.ko模块（3Com网卡家族的特定驱动），编辑/etc/modules-load.d/network.conf文件并在里面输入模块名字。实际的文件名对 loader 来说无关紧要。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /etc/modules-load.d</span>
<span style="color:#75715e"># nano -w /etc/modules-load.d/network.conf</span>
</code></pre></div><p>继续到<a href="#%E9%85%8D%E7%BD%AE%E7%B3%BB%E7%BB%9F">配置系统</a>来安装。</p>
<h4 id="推荐安装固件">推荐：安装固件<a hidden class="anchor" aria-hidden="true" href="#推荐安装固件">#</a></h4>
<p>一些驱动需要先在系统上安装附加的固件才能工作。经常网络接口上会使用，特别是无线网络接口。此外，来自 AMD 、 NVidia 和 Intel 等供应商的现代视频芯片在使用开源驱动程序时，通常也需要外部固件文件。大多数固件都打包在 <a href="https://packages.gentoo.org/packages/sys-kernel/linux-firmware">sys-kernel/linux-firmware</a> 里：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-kernel/linux-firmware</span>
</code></pre></div><h2 id="配置系统httpswikigentooorgwikihandbookamd64installationsystem"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/System">配置系统</a><a hidden class="anchor" aria-hidden="true" href="#配置系统httpswikigentooorgwikihandbookamd64installationsystem">#</a></h2>
<h3 id="文件系统信息">文件系统信息<a hidden class="anchor" aria-hidden="true" href="#文件系统信息">#</a></h3>
<h4 id="关于-fstab">关于 fstab<a hidden class="anchor" aria-hidden="true" href="#关于-fstab">#</a></h4>
<p>在Linux系统下，系统所用到的所有分区都必须在 /etc/fstab文件中指明。这个文件包含了这些分区的挂载点（在系统目录树中的位置）、挂载方法和特殊挂载选项（是否自动挂载，是否某个用户可以挂载它等）。</p>
<h4 id="创建etcfstab文件">创建/etc/fstab文件<a hidden class="anchor" aria-hidden="true" href="#创建etcfstab文件">#</a></h4>
<p>/etc/fstab文件使用一种特殊语法格式。每行都包含六个字段。这些字段之间由空白键（空格键，tab键，或者两者混合使用）分隔。每个字段都有自己的含意：</p>
<ol>
<li>第一个字段显示要挂载的特殊 block 设备或远程文件系统。 有几种设备标识符可用于特殊块设备节点，包括设备文件路径，文件系统标签，UUID以及分区标签。</li>
<li>第二个字段是分区挂载点，也就是分区应该挂载到的地方</li>
<li>第三个字段给出分区所用的文件系统</li>
<li>第四个字段给出的是挂载分区时mount命令所用的挂载选项。由于每个文件系统都有自己的挂载选项，我们建议你阅读mount手册（man mount）以获得所有挂载选项的列表。多个挂载选项之间是用逗号分隔的。</li>
<li>第五个字段是给dump使用的，用以决定这个分区是否需要dump。一般情况下，你可以把该字段设为0（零）。</li>
<li>第六个字段是给fsck使用的，用以决定系统非正常关机之后文件系统的检查顺序。根文件系统应该为1，而其它的应该为2（如果不需要文件系统自检的话可以设为0）。</li>
</ol>
<p><strong>重要</strong>：Gentoo 默认提供的 /etc/fstab 不是有效的fstab 文件，它只是提供了几个模板。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/fstab</span>
</code></pre></div><p>在文本的其余部分，我们使用默认的块设备 /dev/sd* 文件作为分区。</p>
<p><strong>分区表和UUIDs</strong></p>
<p>MBR（BIOS）和GPT都支持“文件系统”标签和“文件系统”的UUID。 这些属性可以在尝试查找和挂载块设备时使用，作为 <strong>mount</strong> 命令的替代方法，在 /etc/fstab 中定义。文件系统标签和 UUID 由 LABEL 和 UUID 前缀标识，可以使用 <strong>blkid</strong> 命令查看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># blkid</span>
</code></pre></div><p><strong>警告</strong>：如果分区中的文件系统被擦除，则文件系统标签和UUID值将随后被更改或删除。</p>
<p>出于唯一性，建议使用 MBR 分区表的读者使用UUID来定义/etc/fstab 中的可挂载卷。</p>
<p><strong>分区卷标和 UUIDs</strong></p>
<p>已经使用 GPT 磁盘的用户有一些更稳定的选项可用于在 /etc/fstab 中定义分区。分区卷标和分区 UUID 可以用来标识块设备的单独分区，而不管为分区本身选择了什么文件系统。分区卷标和 UUID 分别由 PARTLABEL 和 PARTUUID 前缀标识，可以通过运行 <strong>blkid</strong> 命令在终端中很好地查看分区标签：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># blkid</span>
</code></pre></div><p>虽然对于分区表不总是正确的，但使用UUID来标识fstab 中的分区，即使将来文件系统更改，也可以保证在寻找某个卷时引导加载程序不会被混淆。对于经常重新启动并定期添加和删除SATA设备时，在 fstab 中定义分区，使用旧的默认分区文件 (/dev/sd*N非常危险) 。</p>
<p>块设备文件的命名取决于许多因素，包括磁盘如何以及以什么顺序加载到系统。它们也可能以不同的顺序显示，具体情况取决于在早期启动过程中内核首先检测到哪些设备。 有了这个说明，除非有人打算不断地解决磁盘排序问题，使用默认块设备文件是一个简单和直接的方法。</p>
<p>让我们来看看如何写下/boot/分区的选项。 这只是一个示例，应根据安装时的具体情况进行修改。 在amd64分区示例中， /boot/ 通常是/dev/sda1 ext4作为文件系统。 它需要在启动期间进行检查，所以我们写下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/dev/sda1   /boot     ext4    defaults        <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">2</span>
</code></pre></div><p>有些用户不希望/boot/分区自动挂载，以提高系统的安全性。 他们应该用<em>noauto</em>.代替 <em>defaults</em>。这意味着这些用户将需要在每次他们想要使用它时手动挂载这个分区。</p>
<p>增加符合你分区方案的规则，为你的光驱（当然，如果你有其他分区或者驱动器，也为它们加上）添加挂载规则。</p>
<p>下面是<code>/etc/fstab</code>文件的例子（for MBR）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/dev/sda1   /boot        ext4    defaults,noatime     <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">2</span>
/dev/sda2   none         swap    sw                   <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
/dev/sda3   /            ext4    noatime              <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1</span>
  
/dev/cdrom  /mnt/cdrom   auto    noauto,user          <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</code></pre></div><p><code>auto</code>选项可以使<strong>mount</strong> 猜测文件系统（推荐对于可移动设备采用这个选项，因为它们可能采用很多不同的文件系统），而 <code>user</code>选项使得非root用户可以挂载光驱。</p>
<p>为了提高性能，大多数用户想要添加 <code>noatime</code> mount选项，这将拥有更快的系统，因为访问时间没有注册（一般不需要这些）。 这也推荐用于固态硬盘（SSD）用户，他们还应该启用<code>discard</code> 安装选项（现在只支持ext4和btrfs），这使得 <code>TRIM</code>命令有效。</p>
<p>下面是<code>/etc/fstab</code>文件的例子（for GPT）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># EFI 分区</span>
UUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;XXXX-XXXX&#34;</span> /boot vfat rw,noatime,errors<span style="color:#f92672">=</span>remount-ro <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">2</span>
<span style="color:#75715e"># 交换分区</span>
UUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;XXXXXXXX-...XXXX&#34;</span> none swap sw <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
<span style="color:#75715e"># 根分区</span>
UUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;XXXXXXXX-...XXXX&#34;</span> / ext4 defaults,noatime <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1</span>
</code></pre></div><p>仔细检查<code>/etc/fstab</code>文件，保存并退出以继续。</p>
<h4 id="推荐genfstab">推荐：genfstab<a hidden class="anchor" aria-hidden="true" href="#推荐genfstab">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -av genfstab</span>
<span style="color:#75715e"># genfstab -U / &gt;&gt; /etc/fstab</span>
</code></pre></div><h3 id="网络信息">网络信息<a hidden class="anchor" aria-hidden="true" href="#网络信息">#</a></h3>
<h4 id="主机名">主机名<a hidden class="anchor" aria-hidden="true" href="#主机名">#</a></h4>
<p>要设置主机名称，创建/编辑 <code>/etc/hostname</code> ，然后直接输入所需的主机名。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;SAKAMOTO&#39; &gt; /etc/hostname</span>
</code></pre></div><p>当使用 systemd 引导时，存在一个名为hostnamectl的工具，用于编辑<code>/etc/hostname</code>和<code>/etc/machine-info</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># hostnamectl set-hostname &lt;HOSTNAME&gt;</span>
</code></pre></div><p>参考 <strong>man hostnamectl</strong> 来获得更多选项。</p>
<h4 id="配置网络">配置网络<a hidden class="anchor" aria-hidden="true" href="#配置网络">#</a></h4>
<p>在Gentoo Linux安装时，网络已经配置。然而，这是安装的安装光盘本身的配置，并不是新的系统环境的网络配置。现在你所要设置的是Gentoo系统的永久网络配置。</p>
<p><strong>附注</strong>：更多关于网络配置的详细信息，包括网卡绑定、网桥、802.1Q VLANs和无线网络在内的高级配置会在<a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Full/Networking">Gentoo网络配置</a>这一部分介绍。</p>
<h5 id="使用-systemd-networkd">使用 systemd-networkd<a hidden class="anchor" aria-hidden="true" href="#使用-systemd-networkd">#</a></h5>
<p>systemd-networkd 在有线网络接口的简单配置上是很有用的。它在默认情况下是禁用的。</p>
<p>要配置systemd-networkd，在<code>/etc/systemd/network</code>路径下创建一个文件。network请参考<a href="https://www.freedesktop.org/software/systemd/man/systemd.network.html">systemd.network(5)</a>， 一个简单的DHCP配置如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/systemd/network/50-dhcp.network</span>
<span style="color:#f92672">[</span>Match<span style="color:#f92672">]</span>
Name<span style="color:#f92672">=</span>en*

<span style="color:#f92672">[</span>Network<span style="color:#f92672">]</span>
DHCP<span style="color:#f92672">=</span>yes
</code></pre></div><p>在启动时自动启用网络连接</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># systemctl enable systemd-networkd.service</span>
<span style="color:#75715e"># systemctl start systemd-networkd.service</span>
</code></pre></div><p>注意systemd-networkd 默认不会自动更新 resolv.conf ，要 systemd 管理 DNS 设置，替换 resolv.conf 为一个符号连接并启动 systemd-resolved。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ln -snf /run/systemd/resolve/resolv.conf /etc/resolv.conf</span>
<span style="color:#75715e"># systemctl enable systemd-resolved.service</span>
<span style="color:#75715e"># systemctl start systemd-resolved.service</span>
</code></pre></div><h5 id="推荐使用-networkmanager">推荐：使用 NetworkManager<a hidden class="anchor" aria-hidden="true" href="#推荐使用-networkmanager">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask net-misc/networkmanager</span>
<span style="color:#75715e"># systemctl enable NetworkManager</span>
</code></pre></div><p>使用 <code>nmtui</code> 设置：在 IPv4 CONFIGURATION 设置 DNS-servers 为 114.114.114.114，并开启 Ignore automatically obtained DNS parameters。因为它会把路由器ip（192.168.0.1）放在<code>/etc/resolv.conf</code> 第一个，导致ping不通。</p>
<h3 id="the-hosts-file">The hosts file<a hidden class="anchor" aria-hidden="true" href="#the-hosts-file">#</a></h3>
<p>Next inform Linux about the network environment. This is defined in <code>/etc/hosts</code> and helps in resolving host names to IP addresses for hosts that aren&rsquo;t resolved by the nameserver.</p>
<pre tabindex="0"><code># This defines the current system and must be set
127.0.0.1     tux.homenetwork tux localhost
  
# Optional definition of extra systems on the network
192.168.0.5   jenny.homenetwork jenny
192.168.0.6   benny.homenetwork benny
</code></pre><p>Save and exit the editor to continue.</p>
<h3 id="root-密码">Root 密码<a hidden class="anchor" aria-hidden="true" href="#root-密码">#</a></h3>
<p>使用<strong>passwd</strong>命令设置root密码。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># passwd</span>
</code></pre></div><p>root帐户是一个功能强大的帐户，因此请选择一个强密码。 稍后将为日常操作创建其他常规用户帐户。</p>
<p><strong><a href="https://wiki.archlinux.org/title/Reset_lost_root_password">Reset lost root password</a></strong></p>
<ol>
<li>Append the <code>init=/bin/bash</code> <a href="https://wiki.archlinux.org/title/Kernel_parameter">kernel parameter</a> to your boot loader&rsquo;s boot entry.</li>
<li>Your root file system is mounted as read-only now, so remount it as read/write: <code>mount -n -o remount,rw /</code>.</li>
<li>Use the <a href="https://wiki.archlinux.org/title/Passwd">passwd</a> command to create a new password for the root user.</li>
<li>Reboot by typing <code>reboot -f</code> and do not lose your password again!</li>
</ol>
<p><strong><a href="https://askubuntu.com/questions/47538/how-to-make-read-only-file-system-writable">Read-only file system</a></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mount -o remount,rw /</span>
</code></pre></div><h2 id="安装系统工具httpswikigentooorgwikihandbookamd64installationtools"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Tools">安装系统工具</a><a hidden class="anchor" aria-hidden="true" href="#安装系统工具httpswikigentooorgwikihandbookamd64installationtools">#</a></h2>
<h3 id="系统日志工具">系统日志工具<a hidden class="anchor" aria-hidden="true" href="#系统日志工具">#</a></h3>
<p>因为有一些工具提供给用户的功能比较类似，它们就没有包含在stage3当中。现在就是你选择安装哪一个的时候了。</p>
<p>你首先需要决定的就是系统日志工具。Unix和Linux在日志记录功能方面有良好的传统——如果你愿意的话你可以把系统发生的所有事件都记录到日志文件中。这些功能就是通过系统日志工具来完成的。</p>
<p><strong>systemd 提供了自己的日志记录工具</strong>，名字叫“ journal”。在运行systemd的系统上，可以选择性的地安装单独的 syslog 程序，并且可能需要进行其他配置才能使syslog 守护进程从日志中读取消息。</p>
<p>Gentoo提供了多种系统日志工具可供选择。包括：</p>
<ul>
<li><a href="https://packages.gentoo.org/packages/app-admin/sysklogd">app-admin/sysklogd</a> -提供传统的系统日志记录守护程序。默认日志配置容易学习，这个包是初学者的好选择。</li>
<li><a href="https://packages.gentoo.org/packages/app-admin/syslog-ng">app-admin/syslog-ng</a> -高级系统记录器。 需要额外配置很多东西， 更高级的用户可以根据它的日志潜力选择这个包; 注意额外的配置是任何种类的智能日志记录的必要条件。</li>
<li><a href="https://packages.gentoo.org/packages/app-admin/metalog">app-admin/metalog</a> -一个可以灵活配置的系统日志工具。</li>
</ul>
<p>Portage内或许还有其他的系统日志工具——我们的可用软件包数量是以天为单位在增加的。</p>
<p><strong>Tip</strong>：如果你打算使用sysklogd或者syslog-ng你很可能会随后希望安装并且配置 <a href="https://wiki.gentoo.org/wiki/Logrotate">logrotate</a> ，因为这些系统日志工具并没有提供系统日志文件的滚动功能。</p>
<h3 id="可选cron守护进程">可选：Cron守护进程<a hidden class="anchor" aria-hidden="true" href="#可选cron守护进程">#</a></h3>
<p>接下来你可以选择cron守护进程。尽管这是可选的并且不是系统所必须的，但是最好能够安装一个。</p>
<p>cron守护程序执行计划中的命令。 如果某些命令需要定期执行（例如每天，每周或每月），这是非常方便的。</p>
<p>Gentoo提供了几个可选的cron守护进程： <a href="https://packages.gentoo.org/packages/sys-process/bcron">sys-process/bcron</a>, <a href="https://packages.gentoo.org/packages/sys-process/dcron">sys-process/dcron</a>, <a href="https://packages.gentoo.org/packages/sys-process/fcron">sys-process/fcron</a>, and <a href="https://packages.gentoo.org/packages/sys-process/cronie">sys-process/cronie</a>。安装这其中一个的方法和安装一个系统日志工具的方法类似。下面的例子使用<a href="https://packages.gentoo.org/packages/sys-process/cronie">sys-process/cronie</a>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-process/cronie</span>
<span style="color:#75715e"># systemctl enable cronie</span>
</code></pre></div><p>如果使用 dcron，则需要执行额外的初始化命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># crontab /etc/crontab</span>
</code></pre></div><p>如果使用 fcron，则需要额外的 emerge 步骤：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --config sys-process/fcron</span>
</code></pre></div><h3 id="可选文件索引">可选：文件索引<a hidden class="anchor" aria-hidden="true" href="#可选文件索引">#</a></h3>
<p>如果你想索引你的系统文件使得你能够使用locate工具很快定位它们，你需要安装<a href="https://packages.gentoo.org/packages/sys-apps/mlocate">sys-apps/mlocate</a>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-apps/mlocate</span>
</code></pre></div><h3 id="可选远程访问">可选：远程访问<a hidden class="anchor" aria-hidden="true" href="#可选远程访问">#</a></h3>
<p>为了能够在安装后远程访问系统，必须将sshd配置为在启动时启动。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ systemctl enable sshd
</code></pre></div><p>如果需要串行控制台访问(这在远程服务器的情况下是可能的)，则必须配置agetty。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ systemctl enable getty@tty1.service
</code></pre></div><h3 id="文件系统工具">文件系统工具<a hidden class="anchor" aria-hidden="true" href="#文件系统工具">#</a></h3>
<p>根据你所使用的文件系统的不同，你需要安装必须的文件系统工具（用于检查文件系统完整性、创建额外的文件系统等）。请注意管理ext2，ext3和ext4文件系统的工具 (<a href="https://packages.gentoo.org/packages/sys-fs/e2fsprogs">sys-fs/e2fsprogs</a>)已经做为系统的一部分被安装了。</p>
<p>以下的表格列出了特定文件系统所需要安装的工具。</p>
<table>
<thead>
<tr>
<th style="text-align:left">Filesystem</th>
<th style="text-align:left">Package</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Ext 4</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/e2fsprogs">sys-fs/e2fsprogs</a></td>
</tr>
<tr>
<td style="text-align:left">XFS</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/xfsprogs">sys-fs/xfsprogs</a></td>
</tr>
<tr>
<td style="text-align:left">ReiserFS</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/reiserfsprogs">sys-fs/reiserfsprogs</a></td>
</tr>
<tr>
<td style="text-align:left">JFS</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/jfsutils">sys-fs/jfsutils</a></td>
</tr>
<tr>
<td style="text-align:left">VFAT (FAT32, &hellip;)</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/dosfstools">sys-fs/dosfstools</a></td>
</tr>
<tr>
<td style="text-align:left">Btrfs</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/btrfs-progs">sys-fs/btrfs-progs</a></td>
</tr>
<tr>
<td style="text-align:left">ZFS</td>
<td style="text-align:left"><a href="https://packages.gentoo.org/packages/sys-fs/zfs">sys-fs/zfs</a></td>
</tr>
</tbody>
</table>
<p><strong>Tip</strong>：获取更多关于Gentoo上文件系统的信息请看<a href="https://wiki.gentoo.org/wiki/Filesystem">filesystem article</a>。</p>
<h3 id="网络工具">网络工具<a hidden class="anchor" aria-hidden="true" href="#网络工具">#</a></h3>
<p>如果不需要任何其它网络工具，请立即继续 <a href="#%E9%85%8D%E7%BD%AE%E5%BC%95%E5%AF%BC%E5%8A%A0%E8%BD%BD%E7%A8%8B%E5%BA%8F">配置引导程序</a>。</p>
<h4 id="安装dhcp客户端">安装DHCP客户端<a hidden class="anchor" aria-hidden="true" href="#安装dhcp客户端">#</a></h4>
<p><strong>重要</strong>：虽然可选，但大多数用户会发现他们需要一个DHCP客户端，用来连接到他们网络上的DHCP服务器。 请借此机会安装DHCP客户端。如果忘记此步骤，则系统可能无法访问网络，从而使之后无法下载DHCP客户端。</p>
<p>为了使系统能够使用netifrc脚本自动获取一个或多个IP地址，需要安装DHCP客户端。 我们建议使用<a href="https://packages.gentoo.org/packages/net-misc/dhcpcd">net-misc/dhcpcd</a>，虽然许多其他DHCP客户端可通过Gentoo数据库下载：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask net-misc/dhcpcd</span>
</code></pre></div><p>关于 <strong>dhcpcd</strong> 的更多信息可以通过 <a href="https://wiki.gentoo.org/wiki/Dhcpcd">dhcpcd 文章</a>查询。</p>
<h4 id="可选安装pppoe客户端">可选：安装PPPoE客户端<a hidden class="anchor" aria-hidden="true" href="#可选安装pppoe客户端">#</a></h4>
<p>如果你需要ppp来连接网络，你需要安装它 <a href="https://packages.gentoo.org/packages/net-dialup/ppp">net-dialup/ppp</a> 。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask net-dialup/ppp</span>
</code></pre></div><h4 id="推荐安装无线网络工具">推荐：安装无线网络工具<a hidden class="anchor" aria-hidden="true" href="#推荐安装无线网络工具">#</a></h4>
<p>如果系统将连接无线网络,请为开放网络或 WEP 网络安装 <a href="https://packages.gentoo.org/packages/net-wireless/iw">net-wireless/iw</a> 包，为 WPA 或 WPA2 网络安装 <a href="https://packages.gentoo.org/packages/net-wireless/wpa_supplicant">net-wireless/wpa_supplicant</a> 包。<strong>iw</strong> 也是一个有用的无线网络扫描的基本诊断工具</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask net-wireless/iw net-wireless/wpa_supplicant</span>
</code></pre></div><p>现在继续<a href="#%E9%85%8D%E7%BD%AE%E5%BC%95%E5%AF%BC%E5%8A%A0%E8%BD%BD%E7%A8%8B%E5%BA%8F">配置引导启动程序</a>。</p>
<h2 id="配置引导加载程序httpswikigentooorgwikihandbookamd64installationbootloader"><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Bootloader">配置引导加载程序</a><a hidden class="anchor" aria-hidden="true" href="#配置引导加载程序httpswikigentooorgwikihandbookamd64installationbootloader">#</a></h2>
<h3 id="选择引导器">选择引导器<a hidden class="anchor" aria-hidden="true" href="#选择引导器">#</a></h3>
<p>完成配置Linux内核、安装系统工具和编辑配置文件之后，现在是时候去安装Linux安装的最后一个重要的部分：引导器。</p>
<p>引导器负责在引导过程中启动内核——若没有引导器，系统将不知道按下电源键后将如何进行。</p>
<p>针对<strong>amd64</strong>，我们编写了如果在基于BIOS的系统上配置<a href="#%E9%BB%98%E8%AE%A4%EF%BC%9AGRUB2">GRUB2</a>或<a href="#%E5%A4%87%E9%80%891%EF%BC%9ALILO">LILO</a>，以及针对UEFI系统的<a href="#%E9%BB%98%E8%AE%A4%EF%BC%9AGRUB2">GRUB2</a>或<a href="#%E5%A4%87%E9%80%892%EF%BC%9Aefibootmgr">efibootmgr</a>。</p>
<p>在本手册的这一部分中，描述了 &ldquo;emerging&rdquo; 引导加载程序包和 &ldquo;installing&rdquo; 引导加载程序到系统磁盘之间的区别。 这里，术语 &ldquo;emerging&rdquo; 将用于请求 <a href="https://wiki.gentoo.org/wiki/Portage">Portage</a> 使软件包安装于系统。 术语 &ldquo;installing&rdquo; 将表示引导加载程序复制文件或物理地修改系统的磁盘驱动器的适当部分，以便在下一次开机时使引导加载程序“激活并准备好操作”。</p>
<h3 id="默认grub2">默认：GRUB2<a hidden class="anchor" aria-hidden="true" href="#默认grub2">#</a></h3>
<p>默认情况下，Gentoo系统现在主要依赖于<a href="https://wiki.gentoo.org/wiki/GRUB">GRUB</a>（在<a href="https://packages.gentoo.org/packages/sys-boot/grub">sys-boot/grub</a> 包中），它是GRUB Legacy的继任者。无需额外配置，GRUB2就能支持旧的BIOS(&ldquo;pc&rdquo;) 系统。 在安装之前加上少量的配置，Grub2可以支持超过一半的平台。 有关详细信息，请参阅位于<a href="https://wiki.gentoo.org/wiki/GRUB2">GRUB2</a>的<a href="https://wiki.gentoo.org/wiki/GRUB2#Prerequisites">先决条件</a>。</p>
<h4 id="emerge">Emerge<a hidden class="anchor" aria-hidden="true" href="#emerge">#</a></h4>
<p>当使用只支持MBR分区表的旧版BIOS系统时，无需进行其他配置即可安装GRUB：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask --verbose sys-boot/grub</span>
</code></pre></div><p>UEFI用户注意：运行上述命令将在出现之前输出启用的GRUB_PLATFORMS 值。 当使用支持UEFI的系统时，用户需要确保启用 <code>GRUB_PLATFORMS=&quot;efi-64&quot;</code> 参数（默认情况下是这样）。 如果设置不是这样，则需要在安装GRUB2之前将 <code>GRUB_PLATFORMS=&quot;efi-64&quot;</code>添加到<code>/etc/portage/make.conf</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;GRUB_PLATFORMS=&#34;efi-64&#34;&#39; &gt;&gt; /etc/portage/make.conf</span>
<span style="color:#75715e"># emerge --ask sys-boot/grub</span>
</code></pre></div><p>如果GRUB2在未先添加<code>GRUB_PLATFORMS=&quot;efi-64&quot;</code>到make.conf时就已经emerge过，可以添加这一行（像上面显示那样）然后通过<code>--update --newuse</code> options to <strong>emerge</strong>:选项来重新计算 <a href="https://wiki.gentoo.org/wiki/World_set_(Portage)">world package set</a> ：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask --update --newuse --verbose sys-boot/grub</span>
</code></pre></div><p>GRUB2现在已经安装到系统中了，但是还没有激活。</p>
<h4 id="安装">安装<a hidden class="anchor" aria-hidden="true" href="#安装">#</a></h4>
<p>接下来，通过<strong>grub-install</strong>命令安装GRUB2所需的文件到<code>/boot/grub/</code>目录。假设第一块磁盘（引导系统的那块）是/dev/sda，将使用下面的一条命令：</p>
<p><strong>使用BIOS时</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># grub-install /dev/sda</span>
</code></pre></div><p><strong>使用UEFI时</strong></p>
<p><strong>重要</strong>：确保EFI系统分区在运行<strong>grub-install</strong>“之前”已经挂载。它可能会使<strong>grub-install</strong>安装的GRUB EFI文件（grubx64.efi（到一个错误的目录“并且不会”提供“任何”辨识使用错误目录的信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># grub-install --target=x86_64-efi --efi-directory=/boot</span>
</code></pre></div><p><strong>附注</strong>：当/boot分区没有格式化成vfat时，必须修改 <code>--efi-directory</code>选项到EFI系统分区。如</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># grub-install --target=x86_64-efi --efi-directory=/boot/efi</span>
</code></pre></div><p><strong>重要</strong>：如果 <strong>grub_install</strong> 返回了一个错误，类似 <code>Could not prepare Boot variable: Read-only file system</code>，那么为了成功安装，可能必须需要将 efivars 重新挂载为读写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mount -o remount,rw /sys/firmware/efi/efivars</span>
</code></pre></div><p>一些主板制造商（包括虚拟机）似乎只支持EFI系统分区（ESP）中.EFI文件的 /efi/boot/目录。 GRUB安装程序可以使用 <code>--removable</code>选项自动执行此操作。 在运行以下命令之前验证是否已安装ESP。 假设ESP安装在/boot（如前所述），执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># grub-install --target=x86_64-efi --efi-directory=/boot --removable</span>
</code></pre></div><p>这将创建UEFI规范定义的默认目录，然后将 grubx64.efi 文件复制到由同一规范定义的“默认”EFI文件位置。</p>
<h4 id="配置">配置<a hidden class="anchor" aria-hidden="true" href="#配置">#</a></h4>
<p>接下来，基于用户在<code>/etc/default/grub</code>文件和<code>/etc/grub.d</code>中特别配置的脚本文件来生成GRUB2。在大多数场景中，不需要由用户来配置，GRUB2就可以自动检测出哪个内核用于引导（位于<code>/boot/</code>中最高的那一个）以及根文件系统是什么。也可以使用<code>GRUB_CMDLINE_LINUX</code> 变量在<code>/etc/default/grub</code>中附加内核参数。</p>
<p>要生成最终的GRUB2配置，运行<strong>grub-mkconfig</strong>命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># grub-mkconfig -o /boot/grub/grub.cfg</span>
Generating grub.cfg ...
Found linux image: /boot/vmlinuz-4.9.16-gentoo
Found initrd image: /boot/initramfs-genkernel-amd64-4.9.16-gentoo
<span style="color:#66d9ef">done</span>
</code></pre></div><p>需要注意至少找到一个Linux镜像在命令的输出中，它们是用来引导系统的。如果使用一个initramfs或用<strong>genkernel</strong>建立内核，同样会检测到正确的initrd 镜像。如果不是这样，进入到<code>/boot/</code>并使用<strong>ls</strong>命令检查内容。如果文件确实不存在，回到内核配置和安装的介绍。</p>
<p><strong>Tip</strong>：<strong>os-prober</strong>实用程序可与GRUB2配合使用，以检测所连接驱动器上的其他操作系统。可检测到Windows 7, 8.1, 10,和其他Linux发行版。 那些希望双引导系统的应该出现<a href="https://packages.gentoo.org/packages/sys-boot/os-prober">sys-boot/os-prober</a>包，然后重新运行 <strong>grub-mkconfig</strong>命令（如上所示）。 如果遇到问题，请务必先阅读<a href="https://wiki.gentoo.org/wiki/GRUB2">GRUB2</a> 文章，然后再向Gentoo社区请求支持。</p>
<h4 id="使用救急控制台httpswikiarchlinuxorgtitlegrub_e7ae80e4bd93e4b8ade69687e4bdbfe794a8e69591e680a5e68ea7e588b6e58fb0"><a href="https://wiki.archlinux.org/title/GRUB_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E4%BD%BF%E7%94%A8%E6%95%91%E6%80%A5%E6%8E%A7%E5%88%B6%E5%8F%B0">使用救急控制台</a><a hidden class="anchor" aria-hidden="true" href="#使用救急控制台httpswikiarchlinuxorgtitlegrub_e7ae80e4bd93e4b8ade69687e4bdbfe794a8e69591e680a5e68ea7e588b6e58fb0">#</a></h4>
<p><code>set</code> 用来修改变量，<code>insmod</code> 用来载入模组以添加功能。</p>
<p>如果 <code>/boot</code> 在单独分区上（例如在用 UEFI 的时候），适当地进行修改：</p>
<p><strong>注意：</strong> 因为 boot 是一个单独的分区而不是根分区的一部分，你得手动把它的地址写清楚，格式和前面的 prefix 一样。</p>
<pre tabindex="0"><code>set root=(hd0,5)
linux (hdX,Y)/vmlinuz-linux root=/dev/sda6
initrd (hdX,Y)/initramfs-linux.img
boot
</code></pre><h4 id="可选启用休眠唤醒httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle9858de7bdae"><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E9%85%8D%E7%BD%AE">可选：启用休眠唤醒</a><a hidden class="anchor" aria-hidden="true" href="#可选启用休眠唤醒httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle9858de7bdae">#</a></h4>
<p>如果之前有分配交换分区，在这里可以执行如下命令以启用其休眠后唤醒的功能</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># sed -Ei &#34;/GRUB_CMDLINE_LINUX_DEFAULT/s/^#*(GRUB.*DEFAULT=).*$/\1\&#34;resume=UUID=$(blkid -o value /dev/sdX4 | head -1)\&#34;/&#34; /etc/default/grub</span>
</code></pre></div><p>也可以手动修改，打开 /etc/default/grub 文件：</p>
<ul>
<li>找到 GRUB_CMDLINE_LINUX_DEFAULT 变量</li>
<li>去掉其注释标记 (#)</li>
<li>在其双引号内添加上 <code>resume=UUID=&lt;UUID 值&gt;</code>，　此 &lt;UUID 值&gt; 可由命令 blkid -o value /dev/sdX4 | head -1 显示</li>
</ul>
<p>最后创建配置 ：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># grub-mkconfig -o /boot/grub/grub.cfg</span>
</code></pre></div><h4 id="可选多系统">可选：多系统<a hidden class="anchor" aria-hidden="true" href="#可选多系统">#</a></h4>
<p>如果电脑存在多系统，可以执行如下步骤添加其它系统的引导菜单选项：</p>
<ul>
<li>
<p>给 grub 添加 mount 这个 USE 以满足 os-prober 的依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;sys-boot/grub mount&#39; &gt;/etc/portage/package.use/grub</span>
</code></pre></div></li>
<li>
<p>安装 os-prober 工具</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -vj os-prober</span>
</code></pre></div><p>如果你上面进行了启用休眠唤醒可选操作，更新了 grub 配置文件，那么安装完成后可能会有一个关于 Grub 的配置文件更新提示 <code>IMPORTANT: config file '/etc/default/grub' needs updating.</code> 这个暂时不用理会，也可「更新配置文件」</p>
</li>
<li>
<p>配置 grub 以启用 os-prober 功能</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;GRUB_DISABLE_OS_PROBER=false&#39; &gt;&gt;/etc/default/grub</span>
</code></pre></div></li>
<li>
<p>之后再次运行一次上述的 <code>grub-mkconfig</code> 命令，该命令会自动识别同一机器上其它的系统，并做成引导菜单选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># grub-mkconfig -o /boot/grub/grub.cfg</span>
</code></pre></div></li>
</ul>
<h3 id="备选1lilo">备选1：LILO<a hidden class="anchor" aria-hidden="true" href="#备选1lilo">#</a></h3>
<h4 id="emerge-1">Emerge<a hidden class="anchor" aria-hidden="true" href="#emerge-1">#</a></h4>
<p>LILO (the <strong>LI</strong>nux<strong>LO</strong>ader,) 是Linux引导程序的久经考验的主力。但是它缺少GRUB所拥有的一些特性。LILO仍旧在一些系统上被使用的原因是GRUB无法使用但LILO却可以。当然还因为一些人是先认识了LILO而且对它忠心不二。不管怎样，Gentoo可以支持它们两个启动器。</p>
<p>安装LILO是一件轻而易举的事，使用emerge就可以了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-boot/lilo</span>
</code></pre></div><h4 id="配置-1">配置<a hidden class="anchor" aria-hidden="true" href="#配置-1">#</a></h4>
<p>要配置LILO，首先要创建 <code>/etc/lilo.conf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/lilo.conf</span>
</code></pre></div><p>在配置文件中，小节（sections）被用于指向可引导的内核。请确保内核文件（与内核版本号一起）和initramfs文件都可以被知晓，因为它们都需要被这个配置文件所引用。</p>
<p><strong>Note</strong>：如果根文件系统是JFS，请在每一个引导条目之后增加 <code>append=&quot;ro&quot;</code>因为JFS在它被挂载为可读写之前需要重放它的日志。</p>
<pre tabindex="0"><code>boot=/dev/sda             # Install LILO in the MBR
prompt                    # Give the user the chance to select another section
timeout=50                # Wait 5 (five) seconds before booting the default section
default=gentoo            # When the timeout has passed, boot the &quot;gentoo&quot; section
compact                   # This drastically reduces load time and keeps the map file smaller; may fail on some systems
  
image=/boot/vmlinuz-4.9.16-gentoo
  label=gentoo            # Name we give to this section
  read-only               # Start with a read-only root. Do not alter!
  root=/dev/sda3          # Location of the root filesystem
  
image=/boot/vmlinuz-4.9.16-gentoo
  label=gentoo.rescue     # Name we give to this section
  read-only               # Start with a read-only root. Do not alter!
  root=/dev/sda3         # Location of the root filesystem
  append=&quot;init=/bin/bb&quot;   # Launch the Gentoo static rescue shell
  
# The next two lines are for dual booting with a Windows system.
# In this example, Windows is hosted on /dev/sda6.
other=/dev/sda6
  label=windows
</code></pre><p><strong>附注</strong>：如果您使用不同的分区方案或内核文件，请根据需要进行调整。</p>
<p>如果initramfs是必须的，那么就更改配置文件以便引用这个initramfs文件，并且告诉initramfs根设备的所在位置。</p>
<pre tabindex="0"><code>image=/boot/vmlinuz-4.9.16-gentoo
  label=gentoo
  read-only
  append=&quot;root=/dev/sda3&quot;
  initrd=/boot/initramfs-genkernel-amd64-4.9.16-gentoo
</code></pre><p>如果额外的选项需要被传递到内核，使用<code>append</code>语句。例如增加 <code>video</code> 语句来使能framebuffer：</p>
<pre tabindex="0"><code>image=/boot/vmlinuz-4.9.16-gentoo
  label=gentoo
  read-only
  root=/dev/sda3
  append=&quot;video=uvesafb:mtrr,ywrap,1024x768-32@85&quot;
</code></pre><p>使用 <strong>genkernel</strong>的用户应该了解他们的内核使用与安装CD相同的引导选项。例如，如果对SCSI设备的支持需要被使能，就增加 <code>doscsi</code>到内核选项中。</p>
<p>现在保存这个文件并退出。</p>
<h4 id="安装-1">安装<a hidden class="anchor" aria-hidden="true" href="#安装-1">#</a></h4>
<p>为了彻底完成，运行 /sbin/lilo，这样 LILO 就会把 /etc/lilo.conf 中的设置应用到系统中（也就是说安装它自己到磁盘上）。要记住每一次一个新内核被安装或者 lilo.conf 文件被改变后，/sbin/lilo 都需要执行一次，以确保在内核文件名发生改变后系统仍然能够被引导起来。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># /sbin/lilo</span>
</code></pre></div><h3 id="备选2efibootmgr">备选2：efibootmgr<a hidden class="anchor" aria-hidden="true" href="#备选2efibootmgr">#</a></h3>
<p>在基于UEFI的系统上，系统上的UEFI固件（换句话说，主引导加载程序）可以直接操作以查找UEFI引导条目。 这样的系统不需要具有额外的（也称为辅助）引导加载器，如GRUB2，以帮助引导系统。 据说，基于EFI的引导加载程序（如GRUB2）存在的原因是在引导过程中“扩展”UEFI系统的功能。 使用<strong>efibootmgr</strong>是真正的那些想要采取一个极简主义（虽然更僵硬的）方法来启动他们的系统; 使用GRUB2（见上文）对于大多数用户更容易，因为它在引导UEFI系统时提供了灵活的方法。</p>
<p>记住<a href="https://packages.gentoo.org/packages/sys-boot/efibootmgr">sys-boot/efibootmgr</a>应用程序不是一个引导器，它是一个和UEFI固件相互作用并更新它的设置，因为之前安装的Linux内核可以通过额外的选项（如果需要）来引导，或允许多重引导条目。可以通过EFI变量（需要支持EFI变量的内核）来完成这个相互作用。</p>
<p>一定要阅读通过 <a href="https://wiki.gentoo.org/wiki/EFI_stub">EFI stub</a>内核文章“&lsquo;再<em>继续。 内核必须具有能够被系统的UEFI固件直接引导的特定选项。 可能需要重新编译内核。 看看**<a href="https://wiki.gentoo.org/wiki/Efibootmgr">efibootmgr</a>** 文章，这也是一个好主意。</em></p>
<p><strong>附注</strong>：要重申，<strong>efibootmgr</strong> <em>不是</em>引导UEFI系统的要求。Linux内核本身就可以启动即引导，其他内核命令行选项可以内置到Linux内核（有一个内核配置选项）允许用户指定启动参数作为命令行选项，甚至initramfs 可以“内置”到内核。</p>
<p>那些决定采取这种方法的人必须安装软件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-boot/efibootmgr</span>
</code></pre></div><p>接下来，创建 /boot/efi/boot/，并复制内核文件到这个位置，并叫作bootx64.efi：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /boot/efi/boot</span>
<span style="color:#75715e"># cp /boot/vmlinuz-* /boot/efi/boot/bootx64.efi</span>
</code></pre></div><p>接下来，告诉UEFI固件创建一个叫作“Gentoo”的引导条目，它拥有全新编译的EFI stub内核：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># efibootmgr --create --disk /dev/sda --part 2 --label &#34;Gentoo&#34; --loader &#34;\efi\boot\bootx64.efi&#34;</span>
</code></pre></div><p>如果使用一个内存文件系统（initramfs），为它添加相应的引导选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># efibootmgr -c -d /dev/sda -p 2 -L &#34;Gentoo&#34; -l &#34;\efi\boot\bootx64.efi&#34; initrd=&#39;\initramfs-genkernel-amd64-4.9.16-gentoo&#39;</span>
</code></pre></div><p><strong>附注</strong>：UEFI定义强制要求使用\作为目录分割符。</p>
<p>完成这些变更后，当系统重新启动时，会有一个叫作“Gentoo”的引导条目。</p>
<h3 id="备选3-syslinux">备选3: Syslinux<a hidden class="anchor" aria-hidden="true" href="#备选3-syslinux">#</a></h3>
<p>Syslinux是 <strong>amd64</strong>架构的另一种引导加载程序替代方案。 它不仅支持MBR，从版本6.00开始，它开始支持EFI启动。 还支持PXE（网络）引导和鲜为人知的选项。 尽管Syslinux是许多流行的引导加载程序，但它并没有得到手册的支持。 读者可以在<a href="https://wiki.gentoo.org/wiki/Syslinux">Syslinux</a>文章中找到有关新兴然后安装此引导加载程序的信息。</p>
<h3 id="备选4systemd-boothttpswikigentooorgwikisystemd-boot"><a href="https://wiki.gentoo.org/wiki/Systemd-boot">备选4：systemd-boot</a><a hidden class="anchor" aria-hidden="true" href="#备选4systemd-boothttpswikigentooorgwikisystemd-boot">#</a></h3>
<p><strong>systemd-boot</strong>, formerly called gummiboot, is a simple UEFI boot manager capable of booting Linux and Windows in EFI mode.</p>
<p><strong>Note</strong>: As of systemd 220, systemd-boot has been included with <a href="https://wiki.gentoo.org/wiki/Systemd">systemd</a> (accessible via the <strong>bootctl</strong> command). If <a href="https://packages.gentoo.org/packages/sys-apps/systemd">sys-apps/systemd</a> has been installed on the system, then <a href="https://packages.gentoo.org/packages/sys-boot/systemd-boot">sys-boot/systemd-boot</a> does <em>not</em> need to be installed.</p>
<h4 id="uefi-boot-manager">UEFI boot manager<a hidden class="anchor" aria-hidden="true" href="#uefi-boot-manager">#</a></h4>
<p>The systemd-boot application makes the installation, which only needs to be performed once (unless a new version of systemd-boot needs to be installed), fairly simple. Verify the following:</p>
<ul>
<li>
<p>The system is booted with EFI to start with (either from a EFI compatible media, or through any other UEFI boot manager) as it will otherwise fail to install.</p>
</li>
<li>
<p>The EFI variable file system (efivars) is mounted read/write:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mount -t efivarfs efivarfs /sys/firmware/efi/efivars</span>
</code></pre></div></li>
</ul>
<p>Then perform the install itself:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># bootctl --path /boot/efi install</span>
</code></pre></div><p>The installation will install the proper EFI files so that the EFI-capable system will boot the systemd-boot bootloader.</p>
<h3 id="重启系统">重启系统<a hidden class="anchor" aria-hidden="true" href="#重启系统">#</a></h3>
<p>退出chroot环境并unmount全部已持载分区。然后敲入一条有魔力的命令来初始化最终的、真实的测试：<strong>reboot</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># exit</span>
<span style="color:#75715e"># cd</span>
<span style="color:#75715e"># umount -l /mnt/gentoo/dev{/shm,/pts,}</span>
<span style="color:#75715e"># umount -R /mnt/gentoo</span>
<span style="color:#75715e"># reboot</span>
</code></pre></div><p>当然，别忘了移除可引导CD，否则可能再次从CD启动，而不是新的Gentoo系统。</p>
<p>当重启进全新安装的Gentoo环境，继续完成<a href="#%E6%94%B6%E5%B0%BE%E5%AE%89%E8%A3%85%E5%B7%A5%E4%BD%9C">结束Gentoo安装</a>。</p>
<h2 id="收尾安装工作">收尾安装工作<a hidden class="anchor" aria-hidden="true" href="#收尾安装工作">#</a></h2>
<h3 id="用户管理">用户管理<a hidden class="anchor" aria-hidden="true" href="#用户管理">#</a></h3>
<h4 id="添加一个日常使用的用户">添加一个日常使用的用户<a hidden class="anchor" aria-hidden="true" href="#添加一个日常使用的用户">#</a></h4>
<p>在Unix/Linux系统中，用root进行工作是一件危险的事情，应该尽量避免。因此我们强烈推荐您为日常使用添加一个普通用户。</p>
<p>用户所属的组定义了其可以执行的活动。下表中列出了许多您可能希望使用的重要组：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Group</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">audio</td>
<td style="text-align:left">Be able to access the audio devices.</td>
</tr>
<tr>
<td style="text-align:left">cdrom</td>
<td style="text-align:left">Be able to directly access optical devices.</td>
</tr>
<tr>
<td style="text-align:left">floppy</td>
<td style="text-align:left">Be able to directly access floppy devices.</td>
</tr>
<tr>
<td style="text-align:left">games</td>
<td style="text-align:left">Be able to play games.</td>
</tr>
<tr>
<td style="text-align:left">portage</td>
<td style="text-align:left">Be able to access portage restricted resources.</td>
</tr>
<tr>
<td style="text-align:left">usb</td>
<td style="text-align:left">Be able to access USB devices.</td>
</tr>
<tr>
<td style="text-align:left">video</td>
<td style="text-align:left">Be able to access video capturing hardware and doing hardware acceleration.</td>
</tr>
<tr>
<td style="text-align:left">wheel</td>
<td style="text-align:left">Be able to use <strong>su</strong>.</td>
</tr>
</tbody>
</table>
<p>比如，创建一个叫作<a href="https://wiki.gentoo.org/wiki/User:Larry">larry</a>的<em>wheel</em>、<em>users</em>和<em>audio</em>组的成员用户，首先作为root登录（只有root能创建用户）并运行<strong>useradd</strong>：</p>
<pre tabindex="0"><code>Login: root
Password: (输入root 密码)
# useradd -m -G users,wheel,audio -s /bin/bash larry
# passwd larry
Password: (输入larry的密码)
Re-enter password: (重复输入密码)
</code></pre><p>如果一个用户仍需要以root身份做一些任务，他们可以使用**su -**来临时得到root权限。另一种方式是使用<a href="https://wiki.gentoo.org/wiki/Sudo">sudo</a>包，如果配置正确的话，非常安全。</p>
<h4 id="sudohttpswikigentooorgwikisudo"><a href="https://wiki.gentoo.org/wiki/Sudo">sudo</a><a hidden class="anchor" aria-hidden="true" href="#sudohttpswikigentooorgwikisudo">#</a></h4>
<p>sudo 使普通用户可以以超级权限执行命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-admin/sudo</span>
</code></pre></div><p>打开配置文件，找到 <code>#%wheel</code> 开头的几行设置，根据说明去掉所需配置行的注释符号</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># visudo</span>
</code></pre></div><h3 id="磁盘清理">磁盘清理<a hidden class="anchor" aria-hidden="true" href="#磁盘清理">#</a></h3>
<h4 id="删除tar包">删除tar包<a hidden class="anchor" aria-hidden="true" href="#删除tar包">#</a></h4>
<p>当Gentoo安装完毕并且系统已经重启过，如果所有事情都完成好了，我们现在要从硬盘上删除下载的stage3的tar包。记住它们下载在/目录。</p>
<pre tabindex="0"><code># rm /stage3-*.tar.xz
</code></pre><h3 id="下一步该做什么">下一步该做什么？<a hidden class="anchor" aria-hidden="true" href="#下一步该做什么">#</a></h3>
<h4 id="文档">文档<a hidden class="anchor" aria-hidden="true" href="#文档">#</a></h4>
<p>不知道接下来该做什么？现在有许多途径可以探索…Getoo 为用户提供了大量的可能性，因此也已经在 wiki 和其他与 Gentoo 相关的子域名上提供大量的文档（少量没有），可以通过这些文档来进行探索（参见下面的 [Gentoo 在线](#Gentoo 在线)章节）。</p>
<p>读者一定要看一下 Gentoo 手册的下一章节<a href="#Portage%E4%BB%8B%E7%BB%8D">使用 Gentoo</a>，讲述了如何保障软件是最新的、如何安装额外的软件包、USE 标记的更多细节、OpenRC init 系统，以及与 Gentoo 系统安装后，管理相关的各种其他信息话题。</p>
<p>除了这本手册，也鼓励读者去探索Gentoo维基的其他角落来寻找更多的、社区提供的文档。Gentoo wiki 组同时提供一个<a href="https://wiki.gentoo.org/wiki/Main_Page#Documentation_topics">文档概述</a>，其中按照类别列出了一系列的维基文档。比如，它指向的<a href="https://wiki.gentoo.org/wiki/Localization/Guide">本地化指南</a>能使系统更有家的感觉（特别适用于以英语为第二语言的用户）。</p>
<h4 id="gentoo-在线">Gentoo 在线<a hidden class="anchor" aria-hidden="true" href="#gentoo-在线">#</a></h4>
<p><strong>重要</strong>：读者应注意，所有在线的 Gentoo 官方网站均受Gentoo的 <a href="https://wiki.gentoo.org/wiki/Project:Council/Code_of_conduct">行为准则</a>约束。活跃于 Gentoo 社区是一种特权，而不是一种权利，用户应该知道行为准则的存在是有原因的。</p>
<p>除了 Freenode 托管的因特网中继聊天（ internet relay chat IRC）网络和邮件列表之外，大多数Gentoo 网站要求每个站点都有一个帐户，以便提问、展开讨论或上报 Bug。</p>
<p><strong>论坛 和 IRC</strong></p>
<p>欢迎每个用户来我们的 <a href="https://forums.gentoo.org/">Gentoo 论坛</a> 或我们的 <a href="https://www.gentoo.org/get-involved/irc-channels/">Gentoo 的 因特网中继聊天（ internet relay chat IRC）频道</a>。有很多以前发现的新 Gentoo 安装遇到的问题，在获得一些反馈后得以解决，这些问题的经验可以在论坛中轻松地搜索查看。其他用户第一次使用 Gentoo 遇到安装问题的可能性非常令人惊讶。建议用户在 Gentoo 支持频道寻求帮助之前搜索论坛和 wiki。</p>
<p><strong>邮件列表</strong></p>
<p>这些是提供给社区成员的<a href="https://www.gentoo.org/get-involved/mailing-lists/">一些邮件列表</a>，他们更愿意通过电子邮件请求支持或反馈，而不是在论坛或IRC上创建用户帐户。用户需要按照说明进行操作，以便订阅特定的邮件列表。</p>
<p><strong>Bugs</strong></p>
<p>有时，在查看 wiki、搜索论坛、在IRC频道或邮件列表中寻求支持之后，并没有问题已知的解决方案。一般来说，这是在 Gentoo 的 <a href="https://bugs.gentoo.org/">Bugzilla 网站</a> 上报告 bug 的信号。</p>
<p><strong>开发指南</strong></p>
<p>希望了解更多有关开发 Gentoo 的读者可以查看<a href="https://devmanual.gentoo.org/">开发指南</a>。该指南提供了有关编写 ebuild、使用 eclass 的说明，并提供了 Gentoo 开发中许多<a href="https://devmanual.gentoo.org/general-concepts/index.html">基本概念</a>的定义。</p>
<h4 id="结语">结语<a hidden class="anchor" aria-hidden="true" href="#结语">#</a></h4>
<p>Gentoo 是一个健壮、灵活、维护良好的发行版。开发者社区很高兴听到关于如何使Gentoo 成为一个“更好的”发行版的反馈。</p>
<p>在此提醒，任何关于 “本手册”的反馈应该按照<a href="https://wiki.gentoo.org/wiki/Handbook:Main_Page#How_do_I_improve_the_Handbook.3F">如何改进手册？</a>章节中开头的详细准则。</p>
<p>我们期待看到我们的用户将如何选择使用Gentoo！</p>
<h2 id="portage介绍">Portage介绍<a hidden class="anchor" aria-hidden="true" href="#portage介绍">#</a></h2>
<h3 id="欢迎使用-portage">欢迎使用 Portage<a hidden class="anchor" aria-hidden="true" href="#欢迎使用-portage">#</a></h3>
<p>Portage 系统是 Gentoo 在软件管理方面最显著的创新之一。由于 Portage 的高度灵活性和数量庞大的特性，它时常被誉为 Linux 下最好的软件管理工具。</p>
<p>Portage 是用 <a href="https://www.python.org/">Python</a> 和 <a href="https://www.gnu.org/software/bash">Bash</a> 两种语言编写的。因为它们都是脚本语言所以用户可以直接阅读它的代码。</p>
<p>大多数用户通过 <strong>emerge</strong> 使用 Portage。本章的内容不是复述 emerge 的 man page。要了解 emerge 的所有可用选项，请查阅 emerge 的 man page（<a href="http://www.jinbuguo.com/pkgmanager/gentoo/emerge.html">emerge 中文手册</a>）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># man emerge</span>
</code></pre></div><h3 id="gentoo-软件仓库">Gentoo 软件仓库<a hidden class="anchor" aria-hidden="true" href="#gentoo-软件仓库">#</a></h3>
<p>查询 Portage 的信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --info</span>
</code></pre></div><h4 id="ebuild">Ebuild<a hidden class="anchor" aria-hidden="true" href="#ebuild">#</a></h4>
<p>当 Gentoo 的文档介绍某个软件包的时候，这意味着 Gentoo 的用户们可以在 Gentoo 的软件仓库里找到它。ebuild 是一种包含了所有 Portage 维护软件（比如安装，搜索，查询等等）所需信息的文件，而 Gentoo 的软件仓库是它们的一个集合。这些 ebuild 文件默认储存在 <code>/var/db/repos/gentoo</code>。</p>
<p>Portage 对于软件的行为都是基于本地的 ebuild。为了能收到新的软件包，安全更新等等，时常更新本地 ebuild 是一件很重要的事情。</p>
<h4 id="更新-gentoo-软件仓库">更新 Gentoo 软件仓库<a hidden class="anchor" aria-hidden="true" href="#更新-gentoo-软件仓库">#</a></h4>
<p>Gentoo 的软件仓库通常使用 <strong>rsync</strong> 进行同步，rsync 是一个快速的文件增量传输工具。要使用它很简单，Portage 的命令行前端 <strong>emerge</strong> 提供了一个调用 <strong>rsync</strong> 的方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --sync</span>
</code></pre></div><p>有时防火墙会干扰 <strong>rsync</strong> 与镜像的连接。这时，我们可以使用 <strong>emerge-webrsync</strong> 来自动下载和安装 Portage 树的快照版本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge-webrsync</span>
</code></pre></div><p>使用 <strong>emerge-webrsync</strong> 的另一个好处是可以只安装由 Gentoo release engineering 团队的 GPG 密钥签名过的快照。与此有关的详细信息可以在 <a href="https://wiki.gentoo.org/wiki/Handbook:Parts/Working/Features#Validated_Gentoo_repository_snapshots">fetching validated Gentoo repository snapshots</a> 找到</p>
<h3 id="维护软件">维护软件<a hidden class="anchor" aria-hidden="true" href="#维护软件">#</a></h3>
<h4 id="搜索软件">搜索软件<a hidden class="anchor" aria-hidden="true" href="#搜索软件">#</a></h4>
<p>有很多方法可以在 Gentoo 的软件仓库寻找软件。其中之一是使用 <strong>emerge</strong> 本身。在默认情况下 <strong>emerge &ndash;search</strong> 会返回所有符合搜索条件的包名。</p>
<p>举个例子，找出所有名字里含有 “pdf” 的包：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -s &lt;包名&gt;</span>
<span style="color:#75715e"># emerge --search pdf</span>
</code></pre></div><p>如果要根据描述进行搜索，可以使用 <code>--searchdesc</code> （或 <code>-S</code>）选项:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --searchdesc pdf</span>
</code></pre></div><p>需要注意的是它会输出很多信息。不过由于都有很清楚的标识，我们就不再赘述它们的意思了。</p>
<h4 id="安装软件">安装软件<a hidden class="anchor" aria-hidden="true" href="#安装软件">#</a></h4>
<p>当你找到了软件包的名字，安装它只需要简单得使用 <strong>emerge</strong>。举个例子，如果要安装 gnumeric：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge &lt;包名&gt;</span>
<span style="color:#75715e"># emerge --ask app-office/gnumeric</span>
</code></pre></div><p>由于很多软件依赖其它的软件，在安装该软件的同时很可能还会安装它的一些以来。不要担心，Portage 可以很好地处理依赖关系。如果要知道 Portage 会安装什么软件，可以在命令中加入 <code>-p/--pretend</code>选项。举个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --pretend gnumeric</span>
</code></pre></div><p>在安装软件期间，Portage将从Internet下载必要的源代码（如果需要），并将其默认存储在 <code>/var/cache/distfiles/</code> 中。 之后，它将解压缩，编译和安装包。 要让Portage仅下载源代码而不安装软件，请添加<code>-f/--fetchonly</code>选项到emerge命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --fetchonly gnumeric</span>
</code></pre></div><p>恢复上一次失败的 emerge</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -r</span>
</code></pre></div><p>其它常用的选项有</p>
<ul>
<li>
<p><code>-1/--oneshot</code> 一般用在安装软件包时，不将该包添加到 world 集中</p>
</li>
<li>
<p><code>-O/--nodeps</code> 不计算依赖关系，只操作指定的包（安装时可能会因为依赖不满足而导致安装失败）</p>
</li>
<li>
<p><code>-j/--jobs</code> 设置 Portage 同时执行的最大任务数，如果未设置数量，那么 Portage 不会限制最大的任务数。如果要将该选项添加到默认选项下，那么建议配合 <code>-l/--load-average</code> 使用， <code>-l/--load-average</code> 用于配置 emerge 的负载阈值，当当前负载到达设定值后， emerge 将不再开启新任务，以避免负载过高，这在 CPU 不够强悍或者内存不宽裕的机器上很需要。比如在一个 8 核 16 线程 16G 内存的机器上，可以设置成 <code>-j -l 12</code> ，这样的设定使 portage 的并行任务数不由硬性规定的数目来限制，而是通过动态负载来进行限制。</p>
</li>
<li>
<p><code>--keep-going</code> 它会在安装出错时，跳过安装失败的包，并重新计算依赖后继续安装剩余包</p>
</li>
<li>
<p><code>-n/--noreplace</code> 不重复安装已经安装的包（默认会忽略掉 USE 的改动以及升级的查询，除非对应加上 <code>-D/-U</code> 和 <code>-u</code> 选项）</p>
</li>
<li>
<p><code>-t/--tree</code> 显示给定包的安装依赖树</p>
</li>
<li>
<p><code>--autounmask</code> 类</p>
<p>这是一组在新装软件包时便于解除安装限制的选项。之前有介绍，在 Portage 安装软件的过程中，可能会因为 USE/License/Keywords 等因素导致无法直接安装，需要配置后再进行，而这组选项可以自动化这个过程。个人建议的相关选项组合为 <code>--autounmask --autounmask-keep-masks --autounmask-write=n</code> ，此组合不会完全自动写入配置到系统下，但是提示了如何配置，方便手动写入，既简化了处理限制的流程，又能保证掌握每次安装包时的改动。</p>
</li>
</ul>
<h4 id="查找已安装软件的文档">查找已安装软件的文档<a hidden class="anchor" aria-hidden="true" href="#查找已安装软件的文档">#</a></h4>
<p>许多软件包中包含有自己的文档，有些时候，<code>doc</code>的USE标记决定了软件包中的自带文档是否会被安装。您可以通过 <strong>emerge -vp category/包名</strong>命令来检查是否存在<code>doc</code> USE 标志：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -vp media-libs/alsa-lib</span>
These are the packages that would be merged, in order:
 
Calculating dependencies... <span style="color:#66d9ef">done</span>!
<span style="color:#f92672">[</span>ebuild   R    <span style="color:#f92672">]</span> media-libs/alsa-lib-1.1.3::gentoo  USE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;python -alisp -debug -doc&#34;</span> ABI_X86<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;(64) -32 (-x32)&#34;</span> PYTHON_TARGETS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;python2_7&#34;</span> <span style="color:#ae81ff">0</span> KiB
</code></pre></div><p>最好的启用 <code>doc</code> USE 的方式是在 /etc/portage/package.use里对想要启用的包单独启用，这样你就能只获得你想要的软件文档。了解更多信息请阅读 <a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/USE/zh-cn">USE flags chapter</a>。</p>
<p>当一个软件包安装结束后，它的文档通常会存放在/usr/share/doc/目录下的，以软件包名命名的子目录中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -l /usr/share/doc/alsa-lib-1.1.3
total <span style="color:#ae81ff">16</span>
-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">3098</span> Mar  <span style="color:#ae81ff">9</span> 15:36 asoundrc.txt.bz2
-rw-r--r-- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">672</span> Mar  <span style="color:#ae81ff">9</span> 15:36 ChangeLog.bz2
-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">1083</span> Mar  <span style="color:#ae81ff">9</span> 15:36 NOTES.bz2
-rw-r--r-- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">220</span> Mar  <span style="color:#ae81ff">9</span> 15:36 TODO.bz2
</code></pre></div><p>列出已安装文档文件的更可靠方法是使用 <strong>equery</strong> 的 <code>--filter</code> 选项。 <strong>equery</strong> 用于查询Portage的数据库，并作为 <a href="https://packages.gentoo.org/packages/app-portage/gentoolkit">app-portage/gentoolkit</a> 包的一部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ equery files --filter<span style="color:#f92672">=</span>doc alsa-lib
 * Searching <span style="color:#66d9ef">for</span> alsa-lib in media-libs ...
 * Contents of media-libs/alsa-lib-1.1.3:
/usr/share/doc/alsa-lib-1.1.3/ChangeLog.bz2
/usr/share/doc/alsa-lib-1.1.3/NOTES.bz2
/usr/share/doc/alsa-lib-1.1.3/TODO.bz2
/usr/share/doc/alsa-lib-1.1.3/asoundrc.txt.bz2
</code></pre></div><p><code>--filter</code> 选项可与其他规则一起使用，以查看许多其他类型文件的安装位置。可以在 <strong>equery</strong> 的手册中查看其他功能: <strong>man 1 equery</strong>。</p>
<h4 id="卸载软件">卸载软件<a hidden class="anchor" aria-hidden="true" href="#卸载软件">#</a></h4>
<p>当您想把一个软件包从系统中移除的时候，使用 <strong>emerge &ndash;unmerge</strong>命令。命令执行完成后，Portage将会移除此软件包安装到您系统中的所有文件，除了那些在安装软件后您修改过的配置文件。保留这些修改过的配置文件是为了便于您今后再次使用它。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --unmerge gnumeric</span>
<span style="color:#75715e"># emerge -C &lt;包名&gt;</span>
</code></pre></div><p>当您从系统中移除一个软件包时，之前那些为了满足其依赖关系而被自动安装的软件包将会被保留在系统中。要使Portage找到现在可以删除的所有依赖项，可以使用 <code>--depclean</code> 功能。</p>
<p>自动清理系统下的软件包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask --depclean</span>
<span style="color:#75715e"># emerge -ac</span>
</code></pre></div><h4 id="默认选项">默认选项<a hidden class="anchor" aria-hidden="true" href="#默认选项">#</a></h4>
<p>emerge 支持配置一组默认选项，用于在每次运行 emerge 时采用。这个储存默认选项的变量名为 <code>EMERGE_DEFAULT_OPTS</code> ，在 <code>/etc/portage/make.conf</code> 文件下设置。</p>
<p>这里一组比较推荐的默认选项配置为</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">EMERGE_DEFAULT_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--autounmask --autounmask-keep-masks --autounmask-write=n --keep-going -v -j -l 12&#34;</span>
</code></pre></div><p>其中的 12 请根据实际情况修改，如果配置了上文的 binhost ，那么对应选项也添加进入。</p>
<h4 id="understanding-portages-formatted-and-colored-outputhttpwikigentooksiezycplhowto_use_portage_correctlyhtm"><strong><a href="http://wikigentoo.ksiezyc.pl/HOWTO_Use_Portage_Correctly.htm">Understanding Portage&rsquo;s Formatted and Colored Output</a></strong><a hidden class="anchor" aria-hidden="true" href="#understanding-portages-formatted-and-colored-outputhttpwikigentooksiezycplhowto_use_portage_correctlyhtm">#</a></h4>
<p>Output from portage is compactly formatted to indicate a plethora of information.</p>
<p><strong>Emerge &ldquo;Pretend&rdquo; Output</strong></p>
<ul>
<li>N = new (not yet installed)</li>
<li>S = new SLOT installation (side-by-side versions)</li>
<li>U = updating (to another version)</li>
<li>D = downgrading (best version seems lower)</li>
<li>R = replacing (re-merging same version)</li>
<li>F = fetch restricted (must be manually downloaded)</li>
<li>f = fetch (already downloaded)</li>
<li>B = blocked by an already installed package</li>
</ul>
<p><strong>USE Flags</strong></p>
<ul>
<li>An unmarked USE flag is unchanged and enabled.</li>
<li><strong>-</strong> A dash preceding a USE flag (<strong>yellow</strong>, <strong>green</strong> or <strong>blue</strong>) shows that it is disabled.</li>
<li><strong>%</strong> A percent symbol following a USE flag indicates that it is new for this package. Identical to yellow output.</li>
<li>***** An asterisk following a USE flag indicates that its meaning/scope has been updated. Identical to green output.</li>
<li><strong>()</strong> Parentheses around a USE flag indicate that it is currently masked by your profile. This is usually because the USE flag can not be supported on the given platform (for example, the <strong>win32codecs</strong> on <strong>amd64</strong> with non-binary packages) or is irrelevant (for example, <strong>sse</strong> is available on all <strong>amd64</strong> CPU&rsquo;s, so there&rsquo;s no point being able to disable it in a 64-bit environment).</li>
</ul>
<p><strong>Color Output</strong></p>
<p>Portage returns information to you using both symbols and colors. While the combination makes for a pretty output it also may appear confusing on first glance. Note that the color information is not required, so it repeats the symbolic output.</p>
<ul>
<li><strong>red</strong> - The USE flag is enabled and has not changed.</li>
<li><strong>yellow</strong> - The USE flag has been added since the package was last installed.</li>
<li><strong>green</strong> - The USE flag has changed since the last time the package was installed, as the asterisk after it indicates.</li>
<li><strong>blue</strong> - The USE flag is disabled, as the dash before it indicates.</li>
</ul>
<p><strong>Example</strong></p>
<p>If you run the command</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --verbose --deep --newuse world</span>
</code></pre></div><p>you might get something similar to</p>
<pre tabindex="0"><code>[ebuild   R    ] sys-kernel/linux-headers-2.6.11-r2  USE=&quot;-gcc64%&quot; 36,470 kB 
[ebuild    U   ] sys-process/psmisc-22.2  USE=&quot;X* ipv6 nls (-selinux)&quot; 238 kB
</code></pre><p>In this example the <strong>sys-kernel/linux-headers</strong> package would be reinstalled as indicated by the &ldquo;R&rdquo; at the beginning of the line. The <strong>sys-process/psmisc</strong> package is being updated, as shown by the &ldquo;U&rdquo; at the beginning of the line.</p>
<ul>
<li>The <strong>gcc64</strong> USE flag is colored <strong>yellow</strong> and followed by &ldquo;<strong>%</strong>&rdquo; showing that that option has been added since the package was last installed. The &ldquo;<strong>-</strong>&rdquo; shows that it will be disabled during this update.</li>
<li>The <strong>X</strong> USE flag will be <strong>green</strong> and followed by &ldquo;*<strong><strong>&rdquo; because that USE flag has changed since the last time the package was installed, as the asterisk after it indicates. No &ldquo;</strong>-</strong>&rdquo; shows that it will be enabled during this update.</li>
<li>The <strong>ipv6</strong> and <strong>nls</strong> USE flags would appear <strong>red</strong> since they are enabled (No &ldquo;<strong>-</strong>&quot;) and have not changed (No &ldquo;*****&quot;).</li>
<li>The <strong>selinux</strong> USE flag will be <strong>blue</strong> because the flag is disabled, as the dash before it indicates. The parentheses also show that it is an unavailable or irrelevant option.</li>
</ul>
<h3 id="更新系统">更新系统<a hidden class="anchor" aria-hidden="true" href="#更新系统">#</a></h3>
<p>要保持您的系统在最佳状态（更不用说安装那些最新的安全更新），您需要定期的更新您的系统。由于Portage只能检查本地已有文件，因此您首先应该更新您的Portage树。当您的Portage树更新后，您可以用 <strong>emerge &ndash;update @world</strong>命令来更新系统。在下一个例子里，我们还会使用 <code>--ask</code> 选项来控制Portage显示它要更新的软件包列表， 并让您决定是否继续更新。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --ask @world</span>
</code></pre></div><p>Portage将搜索已安装的程序的新版本。 然而，它只会验证明确安装的应用程序（在 /var/lib/portage/world 列出的应用程序）的版本，却不会检查它们的依赖项。若要更新这些包的依赖项，请添加 <code>--deep</code> 选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --deep @world</span>
</code></pre></div><p>但是，这并不意味着会更新所有的软件包：某些系统上的软件包，会在编译和构建软件的过程中需要，但是一旦安装完软件，就不再需要这些依赖项。 Portage 称这些依赖为“构建依赖”。 若要在更新时包含这些构建依赖，请添加 <code>--with-bdeps=y</code> 选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --deep --with-bdeps=y @world</span>
</code></pre></div><p>因为有时那些没有明确安装的包（但作为其他软件包的依赖而装入系统中）会推出安全更新，所以推荐偶尔运行一下这个命令。</p>
<p>每当您改变了系统中任何的 USE 标记后，最好加入 <code>--newuse</code> 选项。这样 Portage 将会验证这个 USE 标记变动后，是否需要安装新的软件包或者将现有的软件包重新编译。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --deep --with-bdeps=y --newuse @world</span>
</code></pre></div><p><strong>Meta软件包</strong></p>
<p>Gentoo中的一些软件包并没有包含任何实际的内容，而只是用来安装一系列软件包的集合。例如，<a href="https://packages.gentoo.org/packages/kde-plasma/plasma-meta">kde-plasma/plasma-meta</a> 包就是一个包含了一系列与Plasma相关的互相依赖的软件包的集合，您可以通过安装它来在系统中搭建起一个完整的KDE Plasma 桌面环境。</p>
<p>如果您试图从系统中移除一个这样的软件包的集合体，只是单纯地使用 <strong>emerge &ndash;unmerge</strong> 命令并不能完成您的要求，原因在于这些包的依赖关系仍然保留在系统中。</p>
<p>不用担心，Portage也提供了移除孤立依赖的软件包的功能，但由于软件包间的依赖关系是动态的，您首先需要充分地更新您的整个系统，包括更改USE标记设定而导致的变化。在这之后您可以运行<strong>emerge &ndash;depclean</strong>来移除那些完全没有被其他包依赖的软件包。移除之后你需要重新编译那些曾经与刚刚移除的这些包动态连接过的应用程序，因为实际上这些程序不需要那些包。</p>
<p>所有这些可以用以下三个命令来实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --deep --newuse @world</span>
<span style="color:#75715e"># emerge --depclean</span>
<span style="color:#75715e"># revdep-rebuild</span>
</code></pre></div><h4 id="关于配置文件的更新">关于配置文件的更新<a hidden class="anchor" aria-hidden="true" href="#关于配置文件的更新">#</a></h4>
<p>有时候在更新了某些软件包后你会发现出现了一个类似如下的提示信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">* IMPORTANT: <span style="color:#ae81ff">2</span> config files in <span style="color:#e6db74">&#39;/etc&#39;</span> need updating.
* See the CONFIGURATION FILES and CONFIGURATION FILES UPDATE TOOLS
* sections of the emerge man page to learn how to update config files.
</code></pre></div><p>一般出现这种情况的直接原因是你通过归属于一个软件包的文件修改了其默认配置，导致新安装的文件与现存文件不符，于是 Portage 出于保护现存文件的目的，将新文件重命名为了对应目录下的 <code>._cfgxxxx_&lt;原名&gt;</code> 文件，这是一个很常见的情况。</p>
<p>而每当出现这种情况后，需要做的操作就是人工介入，判断一下保留哪个文件，还是将两个文件合并。而自带用于进行此操作的对应命令有 <code>dispatch-conf</code> 与 <code>etc-update</code> 。</p>
<p>以 <code>dispatch-conf</code> 为例，root 权限下执行后，它会逐个文件列出改动，然后提示你进行操作，比如按 z 保留旧的配置文件，按 u 使用新安装的配置文件替换旧的，等等。</p>
<h4 id="改变桌面环境httpslitterhougelangleylifeblog20210609gentoo-maintain-02-change-profile"><a href="https://litterhougelangley.life/blog/2021/06/09/gentoo-maintain-02/">改变桌面环境</a>/ Change Profile<a hidden class="anchor" aria-hidden="true" href="#改变桌面环境httpslitterhougelangleylifeblog20210609gentoo-maintain-02-change-profile">#</a></h4>
<ul>
<li>
<p>首先修改 <code>/var/lib/portage/world</code> 文件，这个文件记录了用户主动安装的软件，换句话说，整个系统的构建就是围绕这 world 来创建的。将这个文件中不再需要的包删除，比方说 KDE 的软件和一些后续可以再安装，而目前保留可能造成构建麻烦的软件，比方说 htop，megasync，telegram-desktop，fcitx5 之类的，尽量减少到保留必须的就可以了，比方说内核，zfs 之类的。另外可以使用 <code>emerge --deselect xxxx</code> 命令清理 world 。</p>
</li>
<li>
<p>然后是修改或是删除暂时不需要的 USE 配置文件。这里需要强调一下，world 文件是我们手动安装的软件，这些软件用  <code>/etc/portage/package.use/</code>  定义了其他附带安装的软件包和组。里面不再需要的包，就需要精简，甚至是删除。</p>
</li>
<li>
<p>其次使用 eselect profile 修改配置文件到需要的 Profile 。</p>
</li>
<li>
<p>再次就是运行 <code>emerge --sync; emerge --depclean</code> 来清理系统。一般情况下，这个步骤会删除数百个包，耐心等它完成。</p>
</li>
<li>
<p>最后就是一些收尾工作，清理结束后，运行一些小工具来解决一些新老软件依赖的问题，运行下面的命令一波清：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -avj @preserved-rebuild; perl-cleaner --all; emerge --sync; emerge -avujDN --with-bdeps=y --autounmask-write=y @world</span>
</code></pre></div><p>运行以后看看会不会有什么 Block 之类的包，或者循环依赖的包，手动删除下；还有时候解决不了看看是不是 USE 没有清理干净，多试几次就会清理干净，更新没有任何报错就可以开始后续的操作了。</p>
</li>
<li>
<p>这个时候一般会来一次全系统重构。命令如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -ej --keep-going @world</span>
</code></pre></div></li>
<li>
<p>清理 <code>/home/&lt;user&gt;/</code> 下的各种配置文件，安装新的桌面环境。</p>
</li>
</ul>
<h3 id="licenses">Licenses<a hidden class="anchor" aria-hidden="true" href="#licenses">#</a></h3>
<p>从Portage版本2.1.7开始，可以根据其授权协议接受或拒绝安装软件。 portage 树中的所有包在其ebuild中包含一个LICENSE选项。 运行<strong>emerge &ndash;search package/category</strong> 将显示软件包的许可证。</p>
<p><strong>Important</strong>：ebuild 中 的 LICENSE 变量仅是为 Gentoo 开发人员和用户准备的一份指南。它既不是法律声明，也不保证其真实性。因此不要过度依赖它，您需要深入检查软件包的本身，以及您使用的所有文件。</p>
<p>默认情况下，Portage允许<a href="https://www.gnu.org/licenses/license-list.html">自由软件基金会</a>，<a href="https://opensource.org/licenses">开源计划</a>或遵循<a href="https://www.gnu.org/philosophy/free-sw.html">自由软件定义</a>明确批准的许可。</p>
<p>控制允许的许可证的变量称为ACCEPT_LICENSE，可以在<code>/etc/portage/make.conf</code>文件中设置。 在下一个示例中，将显示他的默认值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ACCEPT_LICENSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-* @FREE&#34;</span>
</code></pre></div><p>使用此配置，可以安装具有自由软件或文档许可证的软件包。非自由软件将无法安装。</p>
<p>可以在ACCEPT_LICENSE中全局设置 ACCEPT_LICENSE，或者在<code>/etc/portage/package.license</code> 文进行配置。</p>
<p>举个例子，要允许<a href="https://packages.gentoo.org/packages/www-client/google-chrome">www-client/google-chrome</a> 包的google-chrome的授权协议， 把下面的内容添加到 <code>/etc/portage/package.license</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;类&gt;/&lt;名&gt; &lt;许可名称&gt;
www-client/google-chrome google-chrome
<span style="color:#75715e"># 亦可指定版本，比如对 20210818 及以上版本的 sys-kernel/linux-firmware 进行配置</span>
&gt;<span style="color:#f92672">=</span>sys-kernel/linux-firmware-20210818 linux-fw-redistributable no-source-code
</code></pre></div><p>这允许安装<a href="https://packages.gentoo.org/packages/www-client/google-chrome">www-client/google-chrome</a> 程序包，但禁止安装<a href="https://packages.gentoo.org/packages/www-plugins/chrome-binary-plugins">www-plugins/chrome-binary-plugins</a> 程序包，即使它具有相同的 授权协议。</p>
<p><strong>重要</strong>：授权协议存储在 /var/db/repos/gentoo/licenses/ ，授权协议组在/var/db/repos/gentoo/profiles/license_groups 里面。<em>CAPITAL</em>字母中每行的第一个条目是许可证组的名称，之后的每个条目都是单独的许可证。</p>
<p>在 ACCEPT_LICENSE 变量中定义的许可证组前缀为<code>@</code> 符号。一种可能的设置（以前的Portage默认设置），是允许除“最终用户许可协议（EULA）”以外所有的许可证，“最终用户许可协议（EULA）”中的许可证需要阅读并签署接受协议。要完成此操作，请接受所有许可证（使用<code>*</code>），然后删除EULA组中的许可证，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ACCEPT_LICENSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;* -@EULA&#34;</span>
</code></pre></div><p>请注意，此设置也将接受非自由软件和文档。</p>
<h3 id="masking--unmasking-packages">Masking &amp; Unmasking packages<a hidden class="anchor" aria-hidden="true" href="#masking--unmasking-packages">#</a></h3>
<p>package.mask中指定的软件将会不被安装（可以将其看成黑名单），当新版本的软件出现一些问题的时候（或者是不兼容）可以在这个文件中添加对应的记录。</p>
<p><strong><code>/etc/portage/package.unmask</code></strong> 文件的作用将会覆盖package.mask的效果（安装白名单）。</p>
<h4 id="屏蔽特定的包版本">屏蔽特定的包版本<a hidden class="anchor" aria-hidden="true" href="#屏蔽特定的包版本">#</a></h4>
<p>如果它不存在，请创建/etc/portage/package.mask <em>文件</em>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#34;&gt;x11-drivers/ati-drivers-12.6_beta_pre897&#34; &gt;&gt; /etc/portage/package.mask</span>
</code></pre></div><p>或者，创建/etc/portage/package.mask/ <em>目录</em>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /etc/portage/package.mask/</span>
<span style="color:#75715e"># echo &#34;&gt;x11-drivers/ati-drivers-12.6_beta_pre897&#34; &gt; /etc/portage/package.mask/ati-drivers</span>
</code></pre></div><h4 id="从-ebuild-存储库中屏蔽包">从 ebuild 存储库中屏蔽包<a hidden class="anchor" aria-hidden="true" href="#从-ebuild-存储库中屏蔽包">#</a></h4>
<p>创建一个文件以从名为“larry”的 ebuild 存储库中屏蔽名称为<a href="https://packages.gentoo.org/packages/www-client/firefox">www-client/firefox </a>的包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#34;www-client/firefox::larry&#34; &gt; /etc/portage/package.mask/firefox</span>
</code></pre></div><p><strong><a href="https://forums.gentoo.org/viewtopic-p-7518568.html">屏蔽 overlay 所有的包</a></strong></p>
<p>常规操作都是enable repository 后把所有包都mask 掉，要用的时候单独一个个开，加上 autounmask 也不用自己写。</p>
<pre tabindex="0"><code>*/*::overlay_name
</code></pre><h3 id="accept_keywordshttpswikigentooorgwikiaccept_keywordszh-cn"><a href="https://wiki.gentoo.org/wiki/ACCEPT_KEYWORDS/zh-cn">ACCEPT_KEYWORDS</a><a hidden class="anchor" aria-hidden="true" href="#accept_keywordshttpswikigentooorgwikiaccept_keywordszh-cn">#</a></h3>
<p>ACCEPT_KEYWORDS 变量告诉包管理器哪个 ebuild 的 <a href="https://wiki.gentoo.org/wiki/KEYWORDS">KEYWORDS</a> 允许接受。</p>
<h4 id="变量在哪里设置">变量在哪里设置？<a hidden class="anchor" aria-hidden="true" href="#变量在哪里设置">#</a></h4>
<p>这个变量通常通过 Gentoo 的 <a href="https://wiki.gentoo.org/wiki/Profile_(Portage)">profile</a> 设置。但是可以在用户的 <a href="https://wiki.gentoo.org/wiki//etc/portage/make.conf">/etc/portage/make.conf</a> 文件里进行覆盖，以及在 <a href="https://wiki.gentoo.org/wiki//etc/portage/package.accept_keywords">/etc/portage/package.accept_keywords</a> 文件/目录下的每个包里或者甚至在命令行中进行覆盖。</p>
<p><strong>Important</strong>：通过命令行覆盖 ACCEPT_KEYWORDS 变量通常被认为是个坏主意，因为设置不会被包管理器保存而且可能导致不必要的行为。</p>
<h4 id="稳定与不稳定的-keywords">稳定与不稳定的 keywords<a hidden class="anchor" aria-hidden="true" href="#稳定与不稳定的-keywords">#</a></h4>
<p>在绝大多数的 profile 中 ACCEPT_KEYWORDS 变量的默认值即系统架构本身，例如 <code>ACCEPT_KEYWORDS=&quot;amd64&quot;</code> 或者 <code>ACCEPT_KEYWORDS=&quot;arm&quot;</code>。在此情况下，包管理器只接受那些KEYWORDS 变量包含此架构的 ebuild。如果用户希望能够安装那些还未被认为适合生产环境使用的 ebuild，可以在架构前添加 <code>~</code> 前缀，例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/make.conf</span>
ACCEPT_KEYWORDS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;~amd64&#34;</span>
</code></pre></div><p>由于ACCEPT_KEYWORDS变量是增量的，在添加测试关键字 (<code>~amd64</code>)的时候，不应当指定稳定的关键字(<code>amd64</code>)。</p>
<p>如果不是进行系统全局设置，那么可以在 <code>/etc/portage/package.accept_keywords</code> 文件或目录中对每个包进行单独设置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;类&gt;/&lt;名&gt; <span style="color:#f92672">[</span>可选的关键字配置<span style="color:#f92672">]</span>
<span style="color:#75715e"># games</span>
games-fps/doomsday ~amd64
<span style="color:#75715e"># 亦可指定版本，比如对 21.04.3 及以上版本的 kde-apps-meta 进行配置</span>
&gt;<span style="color:#f92672">=</span>kde-apps/kde-apps-meta-21.04.3
</code></pre></div><p>除了 ACCEPT_KEYWORDS 的通常值以外， package.accept_keywords 还支持三个特殊值：</p>
<ul>
<li><code>*</code> — 如果包在任何系统架构是稳定的，那么它可见</li>
<li><code>~*</code> — 如果包在任何系统架构是测试的，那么它可见</li>
<li><code>**</code> — 这个包总是可见的 (KEYWORDS 被完全忽略)</li>
</ul>
<p>最后一个选项对于版本经常改变的包 （当前 svn/git/mercurial/… 版本的包， 他们通过 live ebuild 来支持，并且没有 KEYWORDS 变量。</p>
<h3 id="当portage报错的时候">当Portage报错的时候<a hidden class="anchor" aria-hidden="true" href="#当portage报错的时候">#</a></h3>
<h4 id="简介">简介<a hidden class="anchor" aria-hidden="true" href="#简介">#</a></h4>
<p>正如我们之前指出的那样，Portage是一个非常强大并支持许多特性的软件包管理工具，而这是其他类似工具所欠缺的。为了理解这一点，我们为您粗略地解释一些Portage的面貌。</p>
<p>通过使用Portage，一个软件的不同版本可以共存于一个系统中。其他发行版倾向于直接在软件包名字中包含版本号（例如freetype 和 freetype2），Gentoo的Portage使用一种我们称之为<em>SLO的技术来实现这种并存。一个ebuild为它自身的版本声明了一个确切的SLOT。具有不同SLOT的同一软件的Ebuild可以共存于同一个系统中。例如，上例中那个freetype包就拥有不同的ebuilds，里面分别有 SLOT=&ldquo;1&rdquo; 和SLOT=&ldquo;2&quot;的标志</em></p>
<p>有一些不同的软件包提供了类似的功能。比如metalogd，sysklogd和syslog-ng都是系统日志记录工具。那些依赖于“系统日志记录工具”的程序并不能随便的依赖于其中之一，比如metalogd。因为其他的系统日志工具可能也是很好的选择。好在Portage允许使用虚拟包：每一个系统日志记录工具都可以提供<a href="https://packages.gentoo.org/packages/virtual/logger">virtual/logger</a>包，因此应用程序们可以设定成仅仅依赖于virtual/syslog即可。</p>
<p>Portage树中的软件可以存在于不同的分支中。您的系统默认只会接受那些Gentoo认为稳定的软件包。绝大多数新提交的软件会被添加到测试分支里。这意味着在此软件被标示为稳定版前需要进行更多的测试。尽管您可以看到那些软件的ebuilds已经加入Portage数据库，在它们未被加入稳定分支前Portage将不会安装它们。</p>
<p>有些软件只能在某几个体系结构上使用。或者在其他体系结构中还不能运行，或者仍需要对其进行更多的测试，或者将软件提交到Portage树中的开发者还不能确定这个软件能否运行于其他体系结构。</p>
<p>每一个Gentoo安装都依附于一个确定的profile，此文件里除了其他信息外还包含了一个正常工作的系统需要的软件包的列表。</p>
<h4 id="被阻挡的包">被阻挡的包<a hidden class="anchor" aria-hidden="true" href="#被阻挡的包">#</a></h4>
<p>Portage关于被阻挡的包的警告(使用 &ndash;pretend参数)</p>
<pre tabindex="0"><code>[blocks B     ] mail-mta/ssmtp (is blocking mail-mta/postfix-2.2.2-r1)
</code></pre><p>Portage关于被阻挡的包的警告(不使用 &ndash;pretend参数)</p>
<pre tabindex="0"><code>!!! Error: the mail-mta/postfix package conflicts with another package.
!!!        both can't be installed on the same system together.
!!!        Please use 'emerge --pretend' to determine blockers.
</code></pre><p>Ebuilds文件中包含了特定的字段，里面为Portage提供了此软件的各种依赖关系的信息。总计有两种可能的依赖关系：一种是编译依赖，在 DEPEND 区域进行声明;另一种是“运行时”依赖，在 RDEPEND 区域中进行声明。如果上述两种依赖关系中任何一个明确指明某个实体或者虚拟包（译注：可能已安装和正要安装）与要安装的包不相容的时候，就会阻挡软件的安装。</p>
<p>虽然Portage的最新版本足够聪明，可以在没有用户干预的情况下解决轻微的问题，但偶尔也需要手动解决此类问题。</p>
<p>为了使安装得以继续进行，您可以选择不安装这个软件包，或者先将发生冲突的包卸载。例如，在我们给出的这个例子中，您可以选择不安装postfix，或者先卸载ssmtp。</p>
<p>你也可能会遇到某些特定版本的包被屏蔽的情况，比如<code>&lt;media-video/mplayer-1.0_rc1-r2</code>。在这种情况下，升级到一个更新的版本就能解决问题。</p>
<p>也有可能两个需要安装的包互相阻挡。这种少见的情况下，您应该明确自己为什么需要同时安装它们。绝大多数时候您只需要安装它们之中的一个就可以了。如果不是这样，请您到 <a href="https://bugs.gentoo.org/">Gentoo&rsquo;s bugtracking system</a> 中提交一个bug。</p>
<h4 id="被屏蔽的包">被屏蔽的包<a hidden class="anchor" aria-hidden="true" href="#被屏蔽的包">#</a></h4>
<p>Portage关于被阻挡的包的警告</p>
<pre tabindex="0"><code>!!! all ebuilds that could satisfy &quot;bootsplash&quot; have been masked.
</code></pre><p>PPortage关于被屏蔽的包的警告——原因</p>
<pre tabindex="0"><code>!!! possible candidates are:
  
- gnome-base/gnome-2.8.0_pre1 (masked by: ~x86 keyword)
- lm-sensors/lm-sensors-2.8.7 (masked by: -sparc keyword)
- sys-libs/glibc-2.3.4.20040808 (masked by: -* keyword)
- dev-util/cvsd-1.0.2 (masked by: missing keyword)
- games-fps/unreal-tournament-451 (masked by: package.mask)
- sys-libs/glibc-2.3.2-r11 (masked by: profile)
- net-im/skype-2.1.0.81 (masked by: skype-eula license(s))
</code></pre><p>当您想安装一个对于您系统不可用的软件包。您会收到类似这样的屏蔽错误提示。您应该试着安装那些对于您系统可用的程序或者等待那些不可用的包被置为可用的。通常一个软件包被屏蔽的原因在于：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Reason for mask</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">~arch keyword</td>
<td style="text-align:left">这个软件没有经过充分的测试，不能进入稳定分支，请等待一段时间后在尝试使用它。</td>
</tr>
<tr>
<td style="text-align:left">-arch keyword or -* keyword</td>
<td style="text-align:left">这个软件不能工作在您机器的体系结构中。如果您确信它能工作那么请到我们的bugzilla网站提交一个bug报告。</td>
</tr>
<tr>
<td style="text-align:left">missing keyword</td>
<td style="text-align:left">这个软件还没有在您机器的体系结构中进行过测试。您可以咨询相应体系结构移植小组是否能对它进行测试，或者您自己为他们进行这样的测试并将您得到的结论提交到我们的bugzilla网站。</td>
</tr>
<tr>
<td style="text-align:left">package.mask</td>
<td style="text-align:left">这个软件被认为是损坏的，不稳定的或者有更严重的问题，它被故意标识为“不应使用”。</td>
</tr>
<tr>
<td style="text-align:left">profile</td>
<td style="text-align:left">这个软件不适用于您的profile。安装这样的应用软件可能会破坏您的系统，或者只是不能与您使用的profile相兼容。</td>
</tr>
<tr>
<td style="text-align:left">license</td>
<td style="text-align:left">这个包的许可证的ACCEPT_LICENSE值不正确。 通过设置许可证或正确的许可证组来允许其许可证:/etc/portage/make.conf或 /etc/portage/package.license</td>
</tr>
</tbody>
</table>
<h4 id="use必要的更改">USE必要的更改<a hidden class="anchor" aria-hidden="true" href="#use必要的更改">#</a></h4>
<p>Portage 提示 USE 标志需要进行更改</p>
<pre tabindex="0"><code>The following USE changes are necessary to proceed:
#required by app-text/happypackage-2.0, required by happypackage (argument)
&gt;=app-text/feelings-1.0.0 test
</code></pre><p>如果未使用<code>--autounmask</code>参数，则错误消息也可能显示如下：</p>
<pre tabindex="0"><code>emerge: there are no ebuilds built with USE flags to satisfy &quot;app-text/feelings[test]&quot;.
!!! One of the following packages is required to complete your request:
- app-text/feelings-1.0.0 (Change USE: +test)
(dependency required by &quot;app-text/happypackage-2.0&quot; [ebuild])
(dependency required by &quot;happypackage&quot; [argument])
</code></pre><p>当请求安装包时，发生这种警告或错误，这不仅取决于另一个包，而且还要求该包使用特定的USE标志（或一组USE标志）构建。 在给定的示例中，包应用文本/感觉需要使用 USE=&ldquo;test&quot;构建，但此系统上未设置此USE标志。</p>
<p>要解决这个问题， 到/etc/portage/make.conf编辑里面的USE标志, 或者去/etc/portage/package.use设置一个特殊的包.</p>
<h4 id="缺失依赖">缺失依赖<a hidden class="anchor" aria-hidden="true" href="#缺失依赖">#</a></h4>
<p>Portage提示依赖性不满足</p>
<pre tabindex="0"><code>emerge: there are no ebuilds to satisfy &quot;&gt;=sys-devel/gcc-3.4.2-r4&quot;.
  
!!! Problem with ebuild sys-devel/gcc-3.4.2-r2
!!! Possibly a DEPEND/*DEPEND problem.
</code></pre><p>这表示您正尝试安装的应用程序依赖于您的系统不可用的另外一些软件包。请到bugzilla查看是否有此问题的记录，如果没有查找到相关信息的话请提交一个报告。除非您的系统混用了不同分支，否则这类问题不应该发生，若发生了那就是一个bug。</p>
<h4 id="意指不明的软件包">意指不明的软件包<a hidden class="anchor" aria-hidden="true" href="#意指不明的软件包">#</a></h4>
<p>Portage对于意指不明的Ebuild名称的警告</p>
<pre tabindex="0"><code>[ Results for search key : listen ]
[ Applications found : 2 ]
  
*  dev-tinyos/listen [ Masked ]
      Latest version available: 1.1.15
      Latest version installed: [ Not Installed ]
      Size of files: 10,032 kB
      Homepage:      http://www.tinyos.net/
      Description:   Raw listen for TinyOS
      License:       BSD
  
*  media-sound/listen [ Masked ]
      Latest version available: 0.6.3
      Latest version installed: [ Not Installed ]
      Size of files: 859 kB
      Homepage:      http://www.listen-project.org
      Description:   A Music player and management for GNOME
      License:       GPL-2
  
!!! The short ebuild name &quot;listen&quot; is ambiguous. Please specify
!!! one of the above fully-qualified ebuild names instead.
</code></pre><p>您要安装的应用程序对应有多个同名的包。您需要同时指定类别的名称。Portage会列出所有可供选择的名称匹配的包。</p>
<h4 id="循环依赖">循环依赖<a hidden class="anchor" aria-hidden="true" href="#循环依赖">#</a></h4>
<p>Portage关于循环依赖问题的警告</p>
<pre tabindex="0"><code>!!! Error: circular dependencies: 
  
ebuild / net-print/cups-1.1.15-r2 depends on ebuild / app-text/ghostscript-7.05.3-r1
ebuild / app-text/ghostscript-7.05.3-r1 depends on ebuild / net-print/cups-1.1.15-r2
</code></pre><p>两个（或多个）您想安装的包由于循环依赖而不能安装。这很可能源于Portage树中的bug。请等一段时间后重新sync再尝试安装。您也可以去 <a href="https://bugs.gentoo.org/">Bugzilla</a> 看看是否已经有此问题的报告，或者提交一个关于它的报告。</p>
<h4 id="下载失败">下载失败<a hidden class="anchor" aria-hidden="true" href="#下载失败">#</a></h4>
<p>Portage关于下载失败的警告</p>
<pre tabindex="0"><code>!!! Fetch failed for sys-libs/ncurses-5.4-r5, continuing...
(...)
!!! Some fetch errors were encountered.  Please see above for details.
</code></pre><p>当Portage下载指定软件的源代码失败时，它会尝试继续安装其它（若适用）的应用程序。源代码下载失败可能源于镜像服务器没有正确同步，也可能因为ebuild文件给出了错误的下载地址。那些保存源代码的服务器也可能因为某些原因宕机。</p>
<p>一小时后重试一次，看看问题是否仍然存在。</p>
<h4 id="系统profile保护">系统Profile保护<a hidden class="anchor" aria-hidden="true" href="#系统profile保护">#</a></h4>
<p>Portage关于profile中保护的包的警告</p>
<pre tabindex="0"><code>!!! Trying to unmerge package(s) in system profile. 'sys-apps/portage'
!!! This could be damaging to your system.
</code></pre><p>您要求移除系统核心软件包中的一个。它是您的profile中所列出的必需的软件，因此不能从系统中移除。</p>
<h4 id="digest验证失败">Digest验证失败<a hidden class="anchor" aria-hidden="true" href="#digest验证失败">#</a></h4>
<p>Digest验证失败</p>
<pre tabindex="0"><code>&gt;&gt;&gt; checking ebuild checksums
!!! Digest verification failed:
</code></pre><p>这是Portage树中出现了错误的迹象，通常是由于将ebuild提交到Gentoo ebuild存储库时出错造成的。</p>
<p>当digest校验失败的时候，请不要尝试自己去为此软件包重新产生digest。使用<strong>ebuild foo manifest</strong> 并不能修复问题，反而很可能会使问题变得更糟。</p>
<p>取而代之的应该是等待一至两个小时以便让软件仓库安定下来。一般来说错误很有可能马上就会被注意到，但是修复程序可能需要一点时间来逐步扫描rsync镜像。当您等待的时候，到<a href="https://bugs.gentoo.org/">Bugzilla</a>或者<a href="ircs://irc.libera.chat/#gentoo">#gentoo</a> (<a href="https://web.libera.chat/#gentoo">webchat</a>) (IRC)看看是否已经有人报告了这个问题。如果没有，那就为那个损坏的ebuild提交一个bug报告吧。</p>
<p>修复错误后，重新同步Gentoo ebuild仓库以获取修复的digest。</p>
<p><strong>重要</strong>：值得注意的是：不要每天多次同步<a href="https://gitweb.gentoo.org/repo/gentoo.git/">Gentoo ebuild repository</a> 仓库。正如（当您运行<strong>emerge &ndash;sync</strong>时）Gentoo官方网络礼节策略所指出的那样，那些短时间内过于频繁进行多次sync的用户将会被更新服务器软封禁一段时间，一再不遵守这一政策的滥用者可能会被硬封禁。除非绝对必要，否则通常最好等待24小时再进行同步，因为这样您不会使Gentoo的rsync镜像服务器过载而影响其他用户的正常使用。</p>
<h3 id="其他工具">其他工具<a hidden class="anchor" aria-hidden="true" href="#其他工具">#</a></h3>
<p>单纯 Portage 自带的工具对于日常管理其会显得有些吃力，这里推荐几个比较有用的软件用于辅助管理 Portage。</p>
<h4 id="app-portageeixhttpspackagesgentooorgpackagesapp-portageeix"><a href="https://packages.gentoo.org/packages/app-portage/eix">app-portage/eix</a><a hidden class="anchor" aria-hidden="true" href="#app-portageeixhttpspackagesgentooorgpackagesapp-portageeix">#</a></h4>
<p>这个可以说是非常有用的软件，主要用于查询 Portage 数据库，其优势在于更快的速度、更人性化的显示格式以及更方便的查询模式。</p>
<p>使用前需执行 <code>eix-update</code> 以更新 eix 数据库，安装它之后，可以使用 <code>eix-sync</code> 命令来更新 Portage 数据库，更新完毕后会自动更新 eix 数据库，并显示更新前后的软件包对比情况。</p>
<p>使用 eix 查询所需软件，最基本的命令为</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eix &lt;包名匹配字符串&gt;</span>
</code></pre></div><p>也可只查询已安装的包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eix -I &lt;包名匹配字符串&gt;</span>
</code></pre></div><p>也可查询属于一个特定分类下的所有包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eix -C &lt;类名&gt;</span>
</code></pre></div><p>等等，执行 <code>man eix</code> 查看更多用法。</p>
<h4 id="app-portagegentoolkithttpspackagesgentooorgpackagesapp-portagegentoolkit"><a href="https://packages.gentoo.org/packages/app-portage/gentoolkit">app-portage/gentoolkit</a><a hidden class="anchor" aria-hidden="true" href="#app-portagegentoolkithttpspackagesgentooorgpackagesapp-portagegentoolkit">#</a></h4>
<p>包含了 Gentoo 的一些管理脚本，常用的命令有用于查询依赖关系，文件归属，软件包内容的 <code>equery</code> ，以及用于清理 distfile 的 <code>eclean-dist</code> 。比如</p>
<p>可以查询依赖 vim-core 的软件包（仅根据 ebuild 文件内容查询）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># equery d vim-core</span>
</code></pre></div><p>可以查询 vim 下属的依赖关系图</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># equery g vim</span>
</code></pre></div><p>可以查询 vim 安装了哪些文件到系统下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># equery f vim</span>
</code></pre></div><p>可以查询这个文件属于哪个包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># equery b /usr/bin/vim</span>
</code></pre></div><h5 id="ecleanhttpswikigentooorgwikiecleanzh-cn"><a href="https://wiki.gentoo.org/wiki/Eclean/zh-cn">eclean</a><a hidden class="anchor" aria-hidden="true" href="#ecleanhttpswikigentooorgwikiecleanzh-cn">#</a></h5>
<p><strong>eclean</strong> 是一个清理仓库源文件和二进制包的工具。它是 <a href="https://packages.gentoo.org/packages/app-portage/gentoolkit">app-portage/gentoolkit</a> 包的一部分，并由 <a href="https://wiki.gentoo.org/wiki/Project:Portage-Tools">Portage-Tools</a> 项目维护。</p>
<p><strong>安装</strong></p>
<p>安装 <strong>eclean</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask app-portage/gentoolkit</span>
</code></pre></div><p><strong>附注</strong>：关于 <a href="https://packages.gentoo.org/packages/app-portage/gentoolkit">app-portage/gentoolkit</a> 包中其他工具的信息请参看 <a href="https://wiki.gentoo.org/wiki/Gentoolkit">Gentoolkit article</a>。</p>
<p><strong>使用</strong></p>
<p>默认情况下，源文件存储在 /var/db/repos/gentoo/distfiles 目录下， 二进制包存储在 /var/db/repos/gentoo/packages 目录下；可以通过修改 /etc/portage/make.conf 中的 <a href="https://wiki.gentoo.org/wiki/DISTDIR">DISTDIR</a> 和 PKGDIR 变量更改对应的存储位置。如果不定期清理，这两个目录可能会悄然无声地变得非常巨大；这就是创建<strong>eclean</strong>的原因。</p>
<p>使用 <strong>eclean &ndash;help</strong> 来查看全部的命令简介、参数列表和使用介绍：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eclean --help</span>
</code></pre></div><p>通过 <code>distfiles</code> 参数清理源文件存放目录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eclean distfiles</span>
</code></pre></div><p>或者使用更简短的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eclean-dist</span>
</code></pre></div><p>使用下面的命令清理二进制包：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eclean packages</span>
</code></pre></div><p>或者使用更简短的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eclean-pkg</span>
</code></pre></div><p><strong>选项</strong></p>
<p>默认情况下，当前存储库中的任何ebuild相对应的源文件和二进制包都不会被删除。这样，只要程序包仍在当前存储库树中，系统管理员就可以轻松地降级程序包或安装以前删除的程序包。</p>
<p>举个例子，比如包 foo-1.0 和 foo-1.1 都在存储库中。在从 foo-1.0 升级到 foo-1.1 之后，运行 <strong>elcean distfiles</strong>，两个版本的源文件依然被保留，因此如果 foo-1.1 出现问题，用户可以很方便的重新安装 foo-1.0，而不必重新下载。</p>
<p>另一个可能的情况是安装之前删除的包。假设系统安装了 foo 包（任一版本）。在（不经意地）删除了这个包并运行了 <strong>eclean disfiles</strong> 之后，foo 的源文件依然被保留，可以重新安装而无需再次下载。</p>
<p>对二进制包同样的例子也一样适用。</p>
<p>为节省更多磁盘空间，请添加<code>--deep</code>选项：这将删除与某些当前安装的软件包（版本无关紧要）不对应的每个源文件或二进制软件包。请注意，这种方式当用户需要降级安装某个包或者重新安装之前删除的包的时候都必须重新下载。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eclean --deep distfiles</span>
<span style="color:#75715e"># eclean --deep packages</span>
</code></pre></div><p>一个替代方案是，同时使用 <code>--deep</code> 和 <code>--package-names</code> 选项：对于某些非当前安装的包（不管版本号是什么）的每个源文件或者二进制包都会被删除。这种方式当用户需重新安装之前删除的包的时候都必须重新下载，但是要降级安装某个包则不需要。</p>
<p>更多细节请参阅 eclean(1) man page：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># man 1 eclean</span>
</code></pre></div><h4 id="app-portageportage-utilshttpspackagesgentooorgpackagesapp-portageportage-utils"><a href="https://packages.gentoo.org/packages/app-portage/portage-utils">app-portage/portage-utils</a><a hidden class="anchor" aria-hidden="true" href="#app-portageportage-utilshttpspackagesgentooorgpackagesapp-portageportage-utils">#</a></h4>
<p>包含了 Portage 的帮助工具，与上面 gentoolkit 的功能有重合，他们具有互补性，常用的命令有用于分析 emerge 日志的 <code>qlop</code> 。它是用 C 写的，速度更快。</p>
<h4 id="app-portagepflhttpspackagesgentooorgpackagesapp-portagepfl"><a href="https://packages.gentoo.org/packages/app-portage/pfl">app-portage/pfl</a><a hidden class="anchor" aria-hidden="true" href="#app-portagepflhttpspackagesgentooorgpackagesapp-portagepfl">#</a></h4>
<p>Portage File List，可用于在线查询文件所归属的包，命令为 <code>e-file &lt;文件名&gt;</code> 。</p>
<h4 id="多版本管理">多版本管理<a hidden class="anchor" aria-hidden="true" href="#多版本管理">#</a></h4>
<p>Gentoo Linux 支持同一软件多版本同时存在于系统上，这归功于 Portage 系统的 slotting 机制。当你执行命令 <code>eix dev-lang/python</code> 会发现它有好多行可用版本，最前圆括号内的内容即对应的 slot 名，不同 slot 下的版本可同时安装到系统上（ slot 名内 <code>/</code> 符号后的内容表示其 sub-slot，同 slot 但不同 sub-slot 的版本无法共存）。比如，<code>sys-devel/gcc</code> , <code>sys-devel/clang</code> , <code>dev-lang/lua</code> 等等都支持多版本共存。</p>
<p>对于一些多版本共存的工具， Gentoo Linux 准备了对应的 <code>eselect</code> 命令以方便用户选择使用。其会在对应的 <code>$PATH</code> 目录下创建一个指向当前选定版本命令的软链接。比如，列出当前所有已经安装的 lua 版本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect lua list</span>
</code></pre></div><p>设定了系统下用户交互环境的默认 lua 版本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect lua set {序号}</span>
</code></pre></div><p>其它的类似，执行 <code>eselect help</code> 以查看当前所有支持的模块。不是所有的多版本共存的包都会有 eselect 模块，它们并不存在强制的依赖关系。执行 <code>eix -I2</code> 可以显示当前系统下安装的可多版本共存的包。</p>
<h2 id="use标记">USE标记<a hidden class="anchor" aria-hidden="true" href="#use标记">#</a></h2>
<h3 id="什么是use标志">什么是USE标志<a hidden class="anchor" aria-hidden="true" href="#什么是use标志">#</a></h3>
<h4 id="use标志的指导思想">USE标志的指导思想<a hidden class="anchor" aria-hidden="true" href="#use标志的指导思想">#</a></h4>
<p>你在安装gentoo（或者是其他发行版，甚至于其他特定操作系统）的时候，你要依据你工作的环境做出选择。服务器跟工作站的组织结构不同，游戏机跟3D工作站也会不一样。</p>
<p>不单只是选择你想要安装的包时如此，选择某一个包需要的特性时同样如此。如果你不需要OpenGL，为什么还要花费时间安装OpenGL并在其他包中加入对OpenGL的支持？如果你不用KDE，而且软件包没有KDE也能完美运行，为什么还要在编译这些包的时候加入KDE支持？</p>
<p>为了帮用户判断什么需要安装或激活，什么不需要；我们希望用户能用简单的方式设定他们自己的环境。这能促使用户判断他真正需要的东西，并让Portage做出有用的决定的过程变得简单。</p>
<h4 id="use标志的设定">USE标志的设定<a hidden class="anchor" aria-hidden="true" href="#use标志的设定">#</a></h4>
<p>我们来具体看看USE标志。每一个标志都是代表对某特定概念的支持和依赖关系信息的关键字。如果你设定了某个USE标志，Portage会明白他们需要支持所选关键字。当然这同时也改变了这个包的依赖关系信息。</p>
<p>让我们看一个特殊示例：关键字 <code>kde</code> 。如果你的 USE 变量里面没有这个关键字，所有具有可选KDE支持的包在编译时都 <em>不会</em> 编译KDE支持。所有具有可选KDE依赖关系的包在安装时都 <em>不会</em> （做为一个依赖关系而）安装KDE库。如果你设定了kde关键字，这些包在安装时都 <em>会</em> 编译KDE支持，而且KDE库也 <em>会</em> （作为一个依赖关系而）被安装。</p>
<p>通过正确设定关键字，你会得到一个根据你的需要而定制的系统。</p>
<h3 id="使用use标志">使用USE标志<a hidden class="anchor" aria-hidden="true" href="#使用use标志">#</a></h3>
<h4 id="声明永久use标志">声明永久USE标志<a hidden class="anchor" aria-hidden="true" href="#声明永久use标志">#</a></h4>
<p>就像前面提到的，所有USE标志都声明在 USE 变量里面。为了让用户能方便地查找和选择USE标志，我们提供了一份默认的USE设定。这些设定是我们觉得Gentoo用户通常都要用到的USE标志的集合。这个默认设置在make.defaults 文件──你的profile声明。</p>
<p>你的系统使用的profile是符号链接 <code>/etc/portage/make.profile</code> 所指向的目录。每个profile叠加于某个更大的profile之上，最终的结果是这些profile的并集。初始profile是base profile( <code>/var/db/repos/gentoo/profiles/base</code>)。</p>
<p>要查看当前正在使用的USE标志（全部），请使用 <strong>emerge &ndash;info</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --info | grep ^USE</span>
USE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;a52 aac acpi alsa branding cairo cdr dbus dts ...&#34;</span>
</code></pre></div><p>就像你看到的那样，这个变量已经包括了非常多的关键字。不要通过修改make.defaults 文件里的 USE 变量来满足你的需要：在升级Portage的时候，这个文件将会被覆盖。</p>
<p>要改变这个默认设置，你需要在 USE 变量里添加或移去关键字。这是通过在<code>/etc/portage/make.conf</code>里定义USE全局变量来实现的。在这个变量里，添加你需要的额外的USE标志，或者移去你不需要的USE标志。后者可通过在标记前面加个负号 (<code>-</code>).前缀来实现。</p>
<p>例如，要移除对 KDE 和 QT 的支持，并添加对 LDAP 的支持，可以在<code>/etc/portage/make.conf</code>里声明USE如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">USE</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-kde -qt4 -qt5 ldap&#34;</span>
</code></pre></div><h4 id="为单个包声明use标志">为单个包声明USE标志<a hidden class="anchor" aria-hidden="true" href="#为单个包声明use标志">#</a></h4>
<p>如果你不是想为整个系统声明USE标志，而是想要为一个（或者几个）程序声明USE标志，你需要编辑<code>/etc/portage/package.use</code>文件。package.use 通常是一个文件，不过它也可以是一个充满子文件的目录；请看下面的提示和 <strong>man 5 portage</strong> 以获得更多如何使用这个约定的信息。下面的例子假设 package.use 是一个文件。</p>
<p>比如说，如果你不想全局的启用 Blu-ray 支持，你只想把它应用到 VLC 包，你可以这样做：</p>
<pre tabindex="0"><code>&lt;类&gt;/&lt;名&gt; &lt;USE&gt;
media-video/vlc bluray
</code></pre><p><strong>Tip</strong>：如果 package.use 是一个已经存在的“目录”（而不是一个单文件），只需简单地在 package.use/ 目录下创建文件，就可以修改软件包的本地USE标记。虽然任何文件命名规范都行，但是更明智的做法是统一命名方案。</p>
<p>有一种规范是简单地使用包名作为子文件的标题。比如说，可以用如下方式为 <a href="https://packages.gentoo.org/packages/media-video/vlc">media-video/vlc</a> 软件包在本地设置 <code>bluray</code> USE 标记。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#34;media-video/vlc bluray&#34; &gt;&gt; /etc/portage/package.use/vlc</span>
</code></pre></div><p>你当然也可以直接为某一个程序禁用USE标志。比如说，禁用PHP的bzip2支持（但通过make.conf中的USE标志为其他包提供支持）：</p>
<pre tabindex="0"><code>dev-lang/php -bzip2
</code></pre><p><code>-*</code> 代表去除该匹配的包的所有已经添加的以及默认的 USE</p>
<pre tabindex="0"><code>&gt;=kde-apps/kde-apps-meta-21.04.3 -* admin
</code></pre><p>Portage 有一个 USE Expand 功能，即把指定变量的值扩展成 USE，这些指定的变量被设置在 Portage 数据库路径下的 <code>profiles/base/make.defaults</code> 文件的 USE_EXPAND 变量中。这个功能很实用，简化了配置值，还能进行归类，更便于管理。上文有一个 <a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E6%98%BE%E5%8D%A1%E7%9A%84%E9%85%8D%E7%BD%AE">显卡的配置</a> 其实就是一个 USE_EXPAND 值。其它会使用到它的地方不多，但也有，比如配置全局的本地化配置，就可以在 make.conf 文件下配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">L10N<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zh-CN zh-TW zh en-GB-oxendict en&#34;</span>
</code></pre></div><p>这样，那么以后当有包支持上述的本地化配置时，就会自动添加。</p>
<p>其它比如可以对 qemu 这个虚拟机添加额外的模拟平台， 可以往 <code>/etc/portage/package.use/qemu</code> 文件写</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">app-emulation/qemu QEMU_SOFTMMU_TARGETS: aarch x86_64
</code></pre></div><p>以支持 arm64 及 x86_64 平台。等等</p>
<h4 id="声明临时use标志">声明临时USE标志<a hidden class="anchor" aria-hidden="true" href="#声明临时use标志">#</a></h4>
<p>有时，你只想暂时改变一个USE设置。你可以仅仅把USE 变量声明成一个环境变量，而不必两次修改/etc/portage/make.conf 。但是要记住，当你重新emerge或者升级这个程序的时候（不管是单独地还是作为系统升级的一部分），你的修改会被重置。</p>
<p>下面的例子我们将在安装 SeaMonkey 的时候临时从 USE 变量中移去<code>pulseaudio</code> 值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># USE=&#34;-pulseaudio&#34; emerge www-client/seamonkey</span>
</code></pre></div><h4 id="优先级">优先级<a hidden class="anchor" aria-hidden="true" href="#优先级">#</a></h4>
<p>当然，USE设置有一定的优先级。按优先级排序（第一优先级最低）：</p>
<ol>
<li>make.defaults 里面的USE默认设定</li>
<li>用户在/etc/portage/make.conf里面的USE默认设定</li>
<li>用户在 /etc/portage/package.use里面的USE默认设定</li>
<li>用户作为环境变量的USE设定</li>
</ol>
<p>运行 <strong>emerge &ndash;info</strong>可以看到Portage识别的最终的USE设定。它会列出Portage使用的所有相关变量（包括 USE 变量）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --info</span>
</code></pre></div><h4 id="在整个系统上应用新的use标志">在整个系统上应用新的USE标志<a hidden class="anchor" aria-hidden="true" href="#在整个系统上应用新的use标志">#</a></h4>
<p>如果你已经修改了你的USE标志，而且你想用新的USE标志更新你的系统，可以使用<strong>emerge</strong>的 <code>--newuse</code>选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --update --deep --newuse @world</span>
</code></pre></div><p>然后运行Portage的depclean来移除已经安装到你的&quot;旧&quot;系统里但是在新USE标志中被废除的条件依赖关系。</p>
<p><strong>警告</strong>：运行<strong>emerge &ndash;depclean</strong>是一项危险的操作，必须小心。请反复检查要删除的包的列表里确定没有你仍然需要的包。下面这个例子里，我们添加了 <code>-p</code> 选项──来只列出这些包而不删除他们：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -p --depclean</span>
</code></pre></div><p>depclean完成之后， <strong>emerge</strong>会针对可能是已经删除的软件包提供的共享对象动态链接的应用程序提示重新构建。此操作完成前，为了防止破坏应用程序，Portage 将会保存必要的库。它存储着需要在 <code>preserved-rebuild</code> 设置的重建内容。若要重建必要的包，请运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge @preserved-rebuild</span>
</code></pre></div><p>这些都完成之后，你的系统就已经应用上了新的USE标志的设定。</p>
<h3 id="软件包特有的use标志">软件包特有的USE标志<a hidden class="anchor" aria-hidden="true" href="#软件包特有的use标志">#</a></h3>
<p>查看可用USE标志。</p>
<p>让我们以seamonkey来作例子，看看它接收什么USE标志。我们可以以<code>--pretend</code>和 <code>--verbose</code>为选项执行 <strong>emerge</strong>来查看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --pretend --verbose www-client/seamonkey</span>
These are the packages that would be merged, in order:
 
Calculating dependencies... <span style="color:#66d9ef">done</span>!
<span style="color:#f92672">[</span>ebuild  N     <span style="color:#f92672">]</span> www-client/seamonkey-2.48_beta1::gentoo  USE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;calendar chatzilla crypt dbus gmp-autoupdate ipc jemalloc pulseaudio roaming skia startup-notification -custom-cflags -custom-optimization -debug -gtk3 -jack -minimal (-neon) (-selinux) (-system-cairo) -system-harfbuzz -system-icu -system-jpeg -system-libevent -system-libvpx -system-sqlite {-test} -wifi&#34;</span> L10N<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-ca -cs -de -en-GB -es-AR -es-ES -fi -fr -gl -hu -it -ja -lt -nb -nl -pl -pt-PT -ru -sk -sv -tr -uk -zh-CN -zh-TW&#34;</span> 216,860 KiB
 
Total: <span style="color:#ae81ff">1</span> package <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> new<span style="color:#f92672">)</span>, Size of downloads: 216,860 KiB
</code></pre></div><p><strong>emerge</strong> 并不是做这件事的唯一工具。事实上，我们有一个专门的包信息工具叫<strong>equery</strong>，它属于<a href="https://packages.gentoo.org/packages/app-portage/gentoolkit">app-portage/gentoolkit</a>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask app-portage/gentoolkit</span>
</code></pre></div><p>现在以为参数执行 <strong>equery</strong> 来查看指定包的USE标志。例如：gnumeric包：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># equery --nocolor uses =gnumeric-1.12.31</span>
<span style="color:#f92672">[</span> Legend : U - final flag setting <span style="color:#66d9ef">for</span> installation<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>        : I - package is installed with flag     <span style="color:#f92672">]</span>
<span style="color:#f92672">[</span> Colors : set, unset                             <span style="color:#f92672">]</span>
 * Found these USE flags <span style="color:#66d9ef">for</span> app-office/gnumeric-1.12.31:
 U I
 + + introspection            : Add support <span style="color:#66d9ef">for</span> GObject based introspection
 - - libgda                   : Enable database support through gnome-extra/libgda.
 - - perl                     : Enable perl plugin loader.
 + + python                   : Enable python plugin loader.
 + + python_targets_python2_7 : Build with Python 2.7
</code></pre></div><h3 id="满足-required_use">满足 REQUIRED_USE<a hidden class="anchor" aria-hidden="true" href="#满足-required_use">#</a></h3>
<p>一些 ebuild 需要或禁止 USE 标志的某些组合才能正常工作。 这通过放置在 REQUIRED_USE ，用一组条件来表示。此条件确保所有功能和依赖性都已完成，并且构建将成功并按预期执行。 如果任何一个不符合，emerge 会提醒你，并要求你解决这个问题。</p>
<p>下面是 REQUIRED_USE 的一个例子：</p>
<table>
<thead>
<tr>
<th style="text-align:left">示例</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>REQUIRED_USE=&quot;foo? ( bar )&quot;</code></td>
<td style="text-align:left">如果设定 <code>foo</code>，则必须设定 <code>bar</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>REQUIRED_USE=&quot;foo? ( !bar )&quot;</code></td>
<td style="text-align:left">如果设定 <code>foo</code>，则不得设定 <code>bar</code>。</td>
</tr>
<tr>
<td style="text-align:left">`REQUIRED_USE=&ldquo;foo? (</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>REQUIRED_USE=&quot;^^ ( foo bar baz )&quot;</code></td>
<td style="text-align:left">必须在 <code>foo</code>、<code>bar</code> 或 <code>baz</code> 中设定一个。</td>
</tr>
<tr>
<td style="text-align:left">`REQUIRED_USE=&rdquo;</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>REQUIRED_USE=&quot;?? ( foo bar baz )&quot;</code></td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h2 id="portage功能特性">Portage功能特性<a hidden class="anchor" aria-hidden="true" href="#portage功能特性">#</a></h2>
<h3 id="portage特性">Portage特性<a hidden class="anchor" aria-hidden="true" href="#portage特性">#</a></h3>
<p>Portage有几个附加的特性，它们能够令您的Gentoo之旅更加愉快。这些特性中的大多数依赖于某些能够提高性能、可靠性、安全性等的软件工具。</p>
<p>为了打开或者关闭某一Portage特性您需要编辑 <code>/etc/portage/make.conf</code>中的 FEATURES变量，这个变量包含不同的特性关键字，用空格分开。在一些情况下您可能还需要额外的安装被这个特性所依赖的工具。</p>
<p>并不是所有Portage所支持的特性都在这里列出。完整的概述，请查阅make.conf手册页：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># man make.conf</span>
</code></pre></div><p>查看 FEATURES 的默认设置，运行<strong>emerge &ndash;info</strong>并且查找FEATURES变量或者用<strong>grep</strong> 显示它：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --info | grep ^FEATURES=</span>
</code></pre></div><h3 id="分布式编译">分布式编译<a hidden class="anchor" aria-hidden="true" href="#分布式编译">#</a></h3>
<h4 id="使用distcc">使用distcc<a hidden class="anchor" aria-hidden="true" href="#使用distcc">#</a></h4>
<p><strong>distcc</strong> 是一个分布式编译程序，可以把编译任务分配给同一网络中的不同机器，这些机器的配置不必完全相同。distcc客户端发送所有必须的信息给所有可利用的distcc服务器（运行distccd的机器）。这样它们每一个都能为客户端编译一部分源码。所获得的效果就是更短的编译时间。</p>
<p>您可以在Gentoo Distcc文档里找到更多的关于<a href="https://wiki.gentoo.org/wiki/Distcc">Distcc</a>的信息（包括如何让它在Gentoo上工作）。</p>
<h4 id="安装-distcc">安装 distcc<a hidden class="anchor" aria-hidden="true" href="#安装-distcc">#</a></h4>
<p>Distcc使用一个图形化监视器来监视您的机器发送出去的编译工作。请把 <code>USE=gnome</code> 或 <code>USE=gtk</code>放进您的USE设置中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># merge --ask sys-devel/distcc</span>
</code></pre></div><h4 id="激活portage的distcc支持">激活Portage的distcc支持<a hidden class="anchor" aria-hidden="true" href="#激活portage的distcc支持">#</a></h4>
<p>将 <code>distcc</code> 添加到<code>/etc/portage/make.conf</code>中的 <code>FEATURES &lt;/ var&gt;</code>变量中。 接下来，编辑MAKEOPTS变量，并增加系统允许的并行构建的数量。 一个已知的方法是填写 <code>-jN</code> 其中<code>N</code> 是运行distccd（包括当前主机）的CPU数量+1（或者核心数+1），但这只是一个建议。</p>
<p>现在运行 <strong>distcc-config</strong>并输入已有的DistCC服务器。作为一个简单例子，我们假设已有的DistCC服务器是192.168.1.102（当前主机）、192.168.1.103和192.168.1.104（两个远端服务器）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># distcc-config --set-hosts &#34;192.168.1.102 192.168.1.103 192.168.1.104&#34;</span>
</code></pre></div><p>当然，也不要忘了运行distccd系统服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># rc-update add distccd default</span>
<span style="color:#75715e"># /etc/init.d/distccd start</span>
</code></pre></div><h3 id="缓冲编译结果">缓冲编译结果<a hidden class="anchor" aria-hidden="true" href="#缓冲编译结果">#</a></h3>
<h4 id="关于ccache">关于ccache<a hidden class="anchor" aria-hidden="true" href="#关于ccache">#</a></h4>
<p><strong>ccache</strong>是一个快速编译器缓存。 无论何时编译应用程序，它都将缓存中间结果，以便每当重新编译相同的程序时，编译时间大大减少。 第一次运行ccache时，它会比正常编译慢得多。 但是后续的重新编译应该更快。 ccache只有在相同的应用程序将被重新编译多次（或相同应用程序的升级频繁发生）时才有用; 因此它通常只对软件开发人员有用。</p>
<p>如果您对ccache的工作机制有兴趣，请访问<a href="https://ccache.samba.org/">homepage</a>主页.</p>
<p><strong>警告</strong>：已知ccache会导致大量的编译失败。 有时ccache会保留旧代码对象或损坏的文件，这可能导致无法破损的源码。 如果发生这种情况（例如&quot;File not recognized: File truncated&quot;出现在构建日志中），请尝试重新编译ccache导致错误的应用程序 。添加<code>FEATURES=&quot;-ccache&quot;</code> 到/etc/portage/make.conf或者</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># FEATURES=&#34;-ccache&#34; emerge &lt;category/package&gt;</span>
</code></pre></div><h4 id="安装-ccache">安装 ccache<a hidden class="anchor" aria-hidden="true" href="#安装-ccache">#</a></h4>
<p>要安装ccache，只需要：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask dev-util/ccache</span>
</code></pre></div><h4 id="激活portage-ccache-支持">激活Portage ccache 支持<a hidden class="anchor" aria-hidden="true" href="#激活portage-ccache-支持">#</a></h4>
<p>打开 <code>/etc/portage/make.conf</code>并添加<code>ccache</code>到FEATURES变量:</p>
<pre tabindex="0"><code>FEATURES=&quot;ccache&quot;
CCACHE_SIZE=&quot;2G&quot;
</code></pre><p>要检查ccache是否运行，只需让它提供给您它的统计数据。因为Portage使用一个不同的ccache主目录，您需要设定CCACHE_DIR变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># CCACHE_DIR=&#34;/var/tmp/ccache&#34; ccache -s</span>
</code></pre></div><p><code>/var/tmp/ccache/</code>是Portage的默认ccache主目录；为了修改这个设置，您可以设定<code>/etc/portage/make.conf</code>中的CCACHE_DIR参数。</p>
<p>不过，如果您运行 <strong>ccache</strong> ，它使用的默认目录是<code>${HOME}/.ccache/</code>。这就是为什么当您查询（Portage）ccache统计数据的时候您需要设定 CCACHE_DIR参数的原因。</p>
<h4 id="非portage编译中使用ccache">非Portage编译中使用ccache<a hidden class="anchor" aria-hidden="true" href="#非portage编译中使用ccache">#</a></h4>
<p>如果您需要在非Portage编译中使用ccache，添加 <code>/usr/lib/ccache/bin/</code>到您 PATH参数里靠前的位置（在/usr/bin之前）。这一点可以通过编辑在您用户主目录中的<code>~/.bash_profile</code>文件来实现。使用<code>~/.bash_profile</code>是定义 PATH参数的一个方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/usr/lib/ccache/bin:</span><span style="color:#e6db74">${</span>PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</code></pre></div><h3 id="二进制包支持">二进制包支持<a hidden class="anchor" aria-hidden="true" href="#二进制包支持">#</a></h3>
<h4 id="创建预编译包">创建预编译包<a hidden class="anchor" aria-hidden="true" href="#创建预编译包">#</a></h4>
<p>Portage 也支持安装预编译软件包。尽管 Gentoo 本身并不提供预编译包，但 Portage 依然能够处理预编译包。</p>
<p>如果某个包已经被安装在您的系统上，您可以用 <strong>quickpkg</strong> 来创建预编译包。也可以用带有 <code>--buildpkg</code> 或 <code>--buildpkgonly</code> 选项的 emerge 命令。</p>
<p>如果您希望 Portage 为您所安装的每一个软件包创建预编译软件包，那么请在 FEATURES 中添加 <code>buildpkg</code> 变量。</p>
<p>预编译包的更多扩展支持可以用 catalyst 得到。关于catalyst的更多信息请参阅 <a href="https://wiki.gentoo.org/wiki/Project:Catalyst/FAQ">Catalyst FAQ</a>。</p>
<h4 id="安装预编译包">安装预编译包<a hidden class="anchor" aria-hidden="true" href="#安装预编译包">#</a></h4>
<p>尽管Gentoo并不提供，但是您可以自己建立一个“中心仓库”来存放预编译包。如果您希望使用这个仓库，您需要设定PORTAGE_BINHOST参数使Portage能够知道它。例如，如果预编译包在 ftp://buildhost/gentoo 上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/make.conf</span>
PORTAGE_BINHOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ftp://buildhost/gentoo&#34;</span>
</code></pre></div><p>当您需要安装预编译包的时候，在emerge命令后的 <code>--getbinpkg</code>选项旁加入 <code>--usepkg</code> 选项。前者让emerge命令从预定的服务器上下载预编译包，后者让emerge首先试图安装预编译包，如果预编译包不存在，那么才下载并编译源码。</p>
<p>例如：用预编译包安装gnumeric</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --usepkg --getbinpkg gnumeric</span>
</code></pre></div><p>关于emerge的预编译包的更多信息请参阅emerge手册页:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># man emerge</span>
</code></pre></div><h4 id="将预构建的软件包分发给他人">将预构建的软件包分发给他人<a hidden class="anchor" aria-hidden="true" href="#将预构建的软件包分发给他人">#</a></h4>
<p>如果预构建的软件要分发给其他人，请确保这样做是被允许的。 检查上游软件包的分发要求。 例如，对于在GNU GPL协议下发布的软件，源代码必须与二进制文件一起提供。</p>
<p>如果构建的二进制程序不可分发，则Ebuild可以在其RESTRICT 变量中定义 <code>bindist</code>限制。 有时，此限制取决于一个或多个USE标志。</p>
<p>默认情况下，Portage将不会屏蔽任何包，因为有限制。 这可以通过在<code>/etc/portage/make.conf</code>中设置ACCEPT_RESTRICT变量来全局更改。 例如，要掩盖具有<code>bindist</code> 限制的软件包，请将以下行添加到make.conf：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ACCEPT_RESTRICT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;* -bindist&#34;</span>
</code></pre></div><p>还可以通过将ACCEPT_RESTRICT选项用于<strong>emerge</strong>命令，来覆盖<code>--accept-restrict</code> 变量。 例如， <code>--accept-restrict=-bindist</code>将临时屏蔽带有<code>bindist</code> 限制的包。</p>
<p>还可以考虑在分发包时设置ACCEPT_LICENSE变量。 请参阅 <a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/Portage/zh-cn#Licenses">授权许可</a>。</p>
<p><strong>重要</strong>：每个 <em>用户</em>完全有责任遵守软件许可条款和每个用户国家的法律。 ebuilds（RESTRICT或LICENSE）定义的元数据变量可以为禁止预编译文件分发提供指导。但是Portage的输出或Gentoo开发人员的回答 <em>不是</em> 法律声明，不应该依赖他们。 谨慎遵守您的当地的法律。</p>
<h3 id="下载文件">下载文件<a hidden class="anchor" aria-hidden="true" href="#下载文件">#</a></h3>
<h4 id="并行下载">并行下载<a hidden class="anchor" aria-hidden="true" href="#并行下载">#</a></h4>
<p>Portage 通常是以root 用户运行的， <code>FEATURES=&quot;userfetch&quot;</code>可以让Portage在下载源码包的时候弃用 root 权限，并以 portage:portage 的用户/组权限运行。这是一个小小的安全性的提高方法。</p>
<p>如果在 FEATURES 设置了 <code>userfetch</code>，请确保在 root 权限下，使用 <strong>chown</strong> 命令更改在 /var/db/repos/gentoo 下所有文件的所有者：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># chown --recursive --verbose portage:portage /var/db/repos/gentoo</span>
</code></pre></div><h4 id="验证源文件">验证源文件<a hidden class="anchor" aria-hidden="true" href="#验证源文件">#</a></h4>
<p>要重新验证完整性并(可能)重新下载当前所有安装的软件包以前删除或损坏的 distfiles，请运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask --fetchonly --emptytree @world</span>
</code></pre></div><h2 id="环境变量">环境变量<a hidden class="anchor" aria-hidden="true" href="#环境变量">#</a></h2>
<h3 id="环境变量-1">环境变量<a hidden class="anchor" aria-hidden="true" href="#环境变量-1">#</a></h3>
<h4 id="简介-1">简介<a hidden class="anchor" aria-hidden="true" href="#简介-1">#</a></h4>
<p>环境变量是一个具有特定名字的对象，它包含了一个或者多个应用程序所将使用到的信息。通过使用环境变量，你可以很容易的修改一个牵涉到一个或多个应用程序的配置信息。</p>
<h4 id="重要的例子">重要的例子<a hidden class="anchor" aria-hidden="true" href="#重要的例子">#</a></h4>
<p>下表展示了一些Linux系统使用的变量并说明了它们的用处。在表格后面将列举一些变量例值。</p>
<table>
<thead>
<tr>
<th style="text-align:left">Variable</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PATH</td>
<td style="text-align:left">这个变量包含了一系列由冒号分隔开的目录，系统就从这些目录里寻找可执行文件。如果你输入的可执行文件（例如 <strong>ls</strong>, <strong>rc-update</strong>或者 <strong>emerge</strong>）不在这些目录中，系统就无法执行它（除非你输入这个命令的完整路径，如/bin/ls）。</td>
</tr>
<tr>
<td style="text-align:left">ROOTPATH</td>
<td style="text-align:left">这个变量的功能和 PATH相同，但它只罗列出超级用户（root）键入命令时所需检查的目录。</td>
</tr>
<tr>
<td style="text-align:left">LDPATH</td>
<td style="text-align:left">这个变量包含了一系列用冒号隔开的目录，动态链接器将在这些目录里查找库文件。</td>
</tr>
<tr>
<td style="text-align:left">MANPATH</td>
<td style="text-align:left">这个变量包含了一系列用冒号隔开的目录，命令 man 会在这些目录里搜索man页面。</td>
</tr>
<tr>
<td style="text-align:left">INFODIR</td>
<td style="text-align:left">这个变量包含了一系列用冒号隔开的目录，命令 info 将在这些目录里搜索info页面。</td>
</tr>
<tr>
<td style="text-align:left">PAGER</td>
<td style="text-align:left">这个变量包含了浏览文件内容的程序的路径，比如(<strong>less</strong> 或者 <strong>more</strong>)</td>
</tr>
<tr>
<td style="text-align:left">EDITOR</td>
<td style="text-align:left">这个变量包含了修改文件内容的程序（文件编辑器）的路径(比如 <strong>nano</strong> 或 <strong>vi</strong>).</td>
</tr>
<tr>
<td style="text-align:left">KDEDIRS</td>
<td style="text-align:left">这个变量包含了一系列用冒号隔开的目录，里面放的是KDE相关的资料。</td>
</tr>
<tr>
<td style="text-align:left">CONFIG_PROTECT</td>
<td style="text-align:left">这个变量包含了一系列用空格隔开的目录，它们在更新的时候会被Portage保护起来。</td>
</tr>
<tr>
<td style="text-align:left">CONFIG_PROTECT_MASK</td>
<td style="text-align:left">这个变量包含了一系列用空格隔开的目录，它们在更新的时候不会被Portage保护起来。</td>
</tr>
</tbody>
</table>
<p>下面你可以找到所有这些变量定义的范例：</p>
<pre tabindex="0"><code>PATH=&quot;/bin:/usr/bin:/usr/local/bin:/opt/bin:/usr/games/bin&quot;
ROOTPATH=&quot;/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin&quot;
LDPATH=&quot;/lib:/usr/lib:/usr/local/lib:/usr/lib/gcc-lib/i686-pc-linux-gnu/3.2.3&quot;
MANPATH=&quot;/usr/share/man:/usr/local/share/man&quot;
INFODIR=&quot;/usr/share/info:/usr/local/share/info&quot;
PAGER=&quot;/usr/bin/less&quot;
EDITOR=&quot;/usr/bin/vim&quot;
KDEDIRS=&quot;/usr&quot;
CONFIG_PROTECT=&quot;/usr/X11R6/lib/X11/xkb /opt/tomcat/conf \
                /usr/kde/3.1/share/config /usr/share/texmf/tex/generic/config/ \
                /usr/share/texmf/tex/platex/config/ /usr/share/config&quot;
CONFIG_PROTECT_MASK=&quot;/etc/gconf&quot;
</code></pre><h3 id="全局变量的定义">全局变量的定义<a hidden class="anchor" aria-hidden="true" href="#全局变量的定义">#</a></h3>
<h4 id="envd目录">env.d目录<a hidden class="anchor" aria-hidden="true" href="#envd目录">#</a></h4>
<p>Gentoo采用了/etc/env.d/目录来集中定义全局变量。在这个目录里，你会发现很多类似 00basic, 05gcc等等这样的文件，它们包含了文件名中提到的应用程序需要的变量。</p>
<p>举个例子，当你安装 <strong>gcc</strong>时，一个名为 05gcc 的文件就会被ebuild所创建，里面包含了如下一些变量：</p>
<pre tabindex="0"><code>PATH=&quot;/usr/i686-pc-linux-gnu/gcc-bin/3.2&quot;
ROOTPATH=&quot;/usr/i686-pc-linux-gnu/gcc-bin/3.2&quot;
MANPATH=&quot;/usr/share/gcc-data/i686-pc-linux-gnu/3.2/man&quot;
INFOPATH=&quot;/usr/share/gcc-data/i686-pc-linux-gnu/3.2/info&quot;
CC=&quot;gcc&quot;
CXX=&quot;g++&quot;
LDPATH=&quot;/usr/lib/gcc-lib/i686-pc-linux-gnu/3.2.3&quot;
</code></pre><p>其他的发行版会让你到/etc/profile或者其他地方修改和添加这些变量的定义。而Gentoo为用户（还有为Portage）提供了更加便捷的方式来维护和管理环境变量，以后你不再需要把精力放在那些众多的包含环境变量的文件身上了。</p>
<p>比如，当你更新完<strong>gcc</strong> 的时候， /etc/env.d/05gcc也会被同时更新，而不需要你手工来完成。</p>
<p>这不仅对Portage有益，作为用户，你也是受益者。有时候你需要设置某个系统范围的环境变量。我们拿http_proxy变量来做例子，为了避免http_proxy 搞乱，你只要新建一个文件/etc/env.d/99local然后添加你的定义：</p>
<pre tabindex="0"><code>http_proxy=&quot;proxy.server.com:8080&quot;
</code></pre><p>通过使用同一个文件来定义你所有的变量，你对如何定义自己的变量有了个大概的了解。</p>
<h4 id="env-update">env-update<a hidden class="anchor" aria-hidden="true" href="#env-update">#</a></h4>
<p>/etc/env.d/ 中的好几个文件都定义了PATH变量。这并没有错：当你运行<strong>env-update</strong>的时候，它会在更新环境变量之前把这些定义都追加到PATH里，因此对于软件包（或者用户）来说将会很容易地设置他们自己的环境变量，而不影响到现有变量的值。</p>
<p><strong>env-update</strong> 脚本会根据 /etc/env.d/ 里文件的字母顺序来附加变量的值。这些文件名必须要以两位数字开头。</p>
<pre tabindex="0"><code>00basic        99kde-env       99local
     +-------------+----------------+-------------+
PATH=&quot;/bin:/usr/bin:/usr/kde/3.2/bin:/usr/local/bin&quot;
</code></pre><p>变量并不总是被串联起来，只有下列变量才会被串联： ADA_INCLUDE_PATH, ADA_OBJECTS_PATH, CLASSPATH, KDEDIRS, PATH, LDPATH, MANPATH, INFODIR, INFOPATH, ROOTPATH, CONFIG_PROTECT, CONFIG_PROTECT_MASK, PRELINK_PATH, PRELINK_PATH_MASK, PKG_CONFIG_PATH,和PYTHONPATH。对于( /etc/env.d/) 里的文件中按照字母顺序排列后）其他所有变量，最新定义的值才会被使用到。</p>
<p>可以通过将变量名添加到 COLON_SEPARATED or SPACE_SEPARATED （也在 /etc/env.d/ 文件）。</p>
<p>当你运行 <strong>env-update</strong>的时候，它会在文件/etc/profile.env 里（会被/etc/profile使用）创建所有的环境变量。它也会从变量 LDPATH 中获取信息用来建立/etc/ld.so.conf。这些完成以后，它将运行 <strong>ldconfig</strong>来重建动态链接器需要的文件/etc/ld.so.cache。</p>
<p>如果你想在运行<strong>env-update</strong>后立即看到效果，执行下面的命令来更新你的环境。自己安装过Gentoo的用户可能已经记住了这个安装指南中提到过的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># env-update &amp;&amp; source /etc/profile</span>
</code></pre></div><p><strong>附注</strong>：上面的命令只会更新你当前终端里的环境变量、新控制台以及它们的子程序。因此，假如你正在X11里工作，你要么在每一个你打开的终端里输入<strong>source /etc/profile</strong> ，要么重新启动X，这样所有新的终端才能引用到新的变量。如果你使用了登录管理器，登陆成root然后输入 /etc/init.d/xdm 。如果不是这样，你需要注销然后重新登录回X这样才能产生使用新变量值的子程序。</p>
<p><strong>重要</strong>：你在定义其他变量时不能使用shell变量。这意味着这样的定义 <code>FOO=&quot;$BAR&quot;</code>（此处$BAR 是另外一个变量）是不允许的。</p>
<h3 id="本地变量的定义">本地变量的定义<a hidden class="anchor" aria-hidden="true" href="#本地变量的定义">#</a></h3>
<h4 id="特定用户">特定用户<a hidden class="anchor" aria-hidden="true" href="#特定用户">#</a></h4>
<p>你并不是一直都想定义全局变量。比如你想把/home/my_user/bin和当前目录（你当前所在的目录）添加到PATH 变量中，但又不想让其他用户的PATH变量中也有这个。如果你想定义一个本地变量，可以使用 ~/.bashrc 或者~/.bash_profile:</p>
<pre tabindex="0"><code>PATH=&quot;${PATH}:/home/my_user/bin:&quot;
</code></pre><p>当你重新登录的时候，你的PATH变量将被更新。</p>
<h4 id="特定会话">特定会话<a hidden class="anchor" aria-hidden="true" href="#特定会话">#</a></h4>
<p>有时候甚至需要更加严格的定义。你可能要使用一个你临时创建的目录里面的程序，而又不想输入它的路径或者为此短时间内内修改 ~/.bashrc。</p>
<p>在这种情况下，你只需要在当前会话中使用<strong>export</strong>来定义 PATH 变量。只要你不注销，PATH变量将保持这个临时的设置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># export PATH=&#34;${PATH}:/home/my_user/tmp/usr/bin&#34;</span>
</code></pre></div><h2 id="ebuild-1">ebuild<a hidden class="anchor" aria-hidden="true" href="#ebuild-1">#</a></h2>
<h3 id="gentoo-development-guide-chinesehttpsblogsoymilkfungentoo-development-guide-chinese"><a href="https://blog.soymilk.fun/Gentoo-Development-Guide-Chinese/">Gentoo Development Guide Chinese</a><a hidden class="anchor" aria-hidden="true" href="#gentoo-development-guide-chinesehttpsblogsoymilkfungentoo-development-guide-chinese">#</a></h3>
<h3 id="ebuild-编写基本指南httpswikigentooorgwikibasic_guide_to_write_gentoo_ebuilds"><a href="https://wiki.gentoo.org/wiki/Basic_guide_to_write_Gentoo_Ebuilds">Ebuild 编写基本指南</a><a hidden class="anchor" aria-hidden="true" href="#ebuild-编写基本指南httpswikigentooorgwikibasic_guide_to_write_gentoo_ebuilds">#</a></h3>
<p>一个 ebuild 文件是一个文本文件，供 Gentoo 包管理器使用，它标识一个特定的软件包以及 Gentoo 包管理器应该如何处理它。它使用一个 <a href="https://en.wikipedia.org/wiki/Bash_(Unix_shell)">bash</a> 类似语法风格，并通过 <a href="https://wiki.gentoo.org/wiki/EAPI">EAPI</a> 版本进行标准化。</p>
<p>Gentoo Linux 使用 ebuild 作为单个软件的包管理格式。这些 ebuild 包含相关软件的元数据（软件的名称和版本、软件使用的许可证和主页）、依赖信息（构建时和运行时依赖）以及有关如何处理的说明使用软件（配置、构建、安装、测试&hellip;）。</p>
<p>Gentoo 中 ebuild 的默认位置是 <a href="https://wiki.gentoo.org/wiki//var/db/repos/gentoo"><code>/var/db/repos/gentoo</code></a>/，该位置由<a href="https://wiki.gentoo.org/wiki/Repos.conf">repos.conf</a>文件确定。自定义ebuild建议放在<a href="https://wiki.gentoo.org/wiki/Custom_repository">自定义库</a>中，比如<code>/var/db/repos/larry</code>。</p>
<p><strong>ebuild</strong> 也是运行各种 <a href="https://devmanual.gentoo.org/ebuild-writing/functions/">ebuild 函数</a> 的 <a href="https://wiki.gentoo.org/wiki/Portage">Portage</a> 命令。通过运行以下命令在本地找到相关信息：</p>
<pre tabindex="0"><code># man 1 ebuild
# man 5 ebuild
</code></pre><p><strong>实时 ebuild</strong></p>
<p>如果源代码是从修订控制系统 (VCS) 获取的，那么此 ebuild 就是“实时 ebuild”。它们往往（但不一定）具有版本号 9999，以便可以轻松将其与基于上游版本的普通 ebuild 区分开来。</p>
<p>如果 ebuild 有一个变量 <code>PROPERTIES</code>，其中的值是“live”，那么它就是“实时的”。如果一个 ebuild 继承了一个 VCS eclass（例如 git-r3、mercurial、darcs），它将是实时的，因为这些 eclass 中有一行 <code>PROPERTIES+=&quot;live&quot;</code>。</p>
<p>在 packages.gentoo.org 站点中，实时 ebuild 具有标志 L 。在 eix 的输出中，它用 <code>*l</code> 标记。</p>
<h4 id="如何创建一个-ebuild">如何创建一个 ebuild<a hidden class="anchor" aria-hidden="true" href="#如何创建一个-ebuild">#</a></h4>
<p><a href="https://wiki.gentoo.org/wiki/Vim">vim</a> 的用户自动获取基本骨架（由 <a href="https://packages.gentoo.org/packages/app-vim/gentoo-syntax">app-vim/gentoo-syntax</a> 提供）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># vim ./foobar.ebuild</span>
</code></pre></div><p>模板</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Copyright 1999-2022 Gentoo Authors</span>
<span style="color:#75715e"># Distributed under the terms of the GNU General Public License v2</span>
 
EAPI<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>
 
DESCRIPTION<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
HOMEPAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
SRC_URI<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
 
LICENSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
SLOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span>
KEYWORDS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;~amd64 ~x86&#34;</span>
IUSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
 
DEPEND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
RDEPEND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DEPEND<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
BDEPEND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</code></pre></div><p>GNU Emacs 或 XEmacs 用户可以使用类似的工具（分别由 <a href="https://packages.gentoo.org/packages/app-emacs/ebuild-mode">app-emacs/ebuild-mode</a> 或 <a href="https://packages.gentoo.org/packages/app-xemacs/ebuild-mode">app-xemacs/ebuild-mode</a> 提供）。</p>
<p>其他编辑器的用户从 skel.ebuild 手动复制：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /var/db/repos/gentoo/skel.ebuild ./foobar.ebuild</span>
</code></pre></div><p>应该知道新包的基本信息，并将其添加到 <a href="https://devmanual.gentoo.org/ebuild-writing/variables/index.html#ebuild-defined-variables">ebuild-defined variables</a>。</p>
<h4 id="给定源压缩包示例">给定源压缩包示例<a hidden class="anchor" aria-hidden="true" href="#给定源压缩包示例">#</a></h4>
<p>为 <a href="https://github.com/chaos/scrub">Scrub</a> 创建一个 ebuild：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /var/db/repos/larry/app-misc/scrub</span>
<span style="color:#75715e"># cd $_</span>
<span style="color:#75715e"># vim ./scrub-2.6.1.ebuild</span>
</code></pre></div><p>模板</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Copyright 1999-2022 Gentoo Authors</span>
<span style="color:#75715e"># Distributed under the terms of the GNU General Public License v2</span>
 
EAPI<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>
 
DESCRIPTION<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Some words here&#34;</span>
HOMEPAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://github.com/chaos/scrub&#34;</span>
SRC_URI<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://github.com/chaos/scrub/releases/download/2.6.1/scrub-2.6.1.tar.gz&#34;</span>
 
LICENSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;GPL-2&#34;</span>
SLOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span>
KEYWORDS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;~amd64 ~x86&#34;</span>
IUSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
 
DEPEND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
RDEPEND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DEPEND<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
BDEPEND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</code></pre></div><p>允许在SRC_URI中使用<a href="https://devmanual.gentoo.org/ebuild-writing/variables/"><code>${PN}</code> variable</a>，但不建议。虽然它可能会缩小这条线，但一些 <a href="https://projects.gentoo.org/qa/policy-guide/ebuild-format.html#pg0103">reasoning why not to use it</a>也值得考虑。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">SRC_URI<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://github.com/chaos/</span><span style="color:#e6db74">${</span>PN<span style="color:#e6db74">}</span><span style="color:#e6db74">/releases/download/</span><span style="color:#e6db74">${</span>PV<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>P<span style="color:#e6db74">}</span><span style="color:#e6db74">.tar.gz&#34;</span>
</code></pre></div><p>可以使用<a href="https://dev.gentoo.org/~zmedico/portage/doc/man/ebuild.1.html">ebuild</a>命令来测试它:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ebuild ./scrub-2.6.1.ebuild clean unpack</span>
</code></pre></div><p>这应该下载并解压源压缩包。在极少数情况下，包应该可以工作，并且不需要在 ebuild 中进一步调整。</p>
<h4 id="打补丁">打补丁<a hidden class="anchor" aria-hidden="true" href="#打补丁">#</a></h4>
<p>如果源代码需要打补丁，可以从 <a href="https://wiki.gentoo.org/wiki/Patches">patches</a>文章中解释的解压源代码创建补丁。</p>
<p>补丁将被列在一个名为PATCHES的数组中，正如<a href="https://devmanual.gentoo.org/ebuild-writing/functions/src_prepare/epatch/index.html">devmanual</a>中所解释的那样。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PATCHES<span style="color:#f92672">=(</span>
	<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>FILESDIR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/<span style="color:#e6db74">${</span>P<span style="color:#e6db74">}</span>-foo.patch
	<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>FILESDIR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/<span style="color:#e6db74">${</span>P<span style="color:#e6db74">}</span>-bar.patch
<span style="color:#f92672">)</span>
 
src_prepare<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    default
    ...
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="初探-ebuildhttpssegmentfaultcoma1190000003819421"><a href="https://segmentfault.com/a/1190000003819421">初探 ebuild</a><a hidden class="anchor" aria-hidden="true" href="#初探-ebuildhttpssegmentfaultcoma1190000003819421">#</a></h3>
<p>2015-10-05</p>
<p>无论你使用过多少/多久其他的 Linux 发行版，初次接触 Gentoo 时，极有可能会觉得它在软件包的安装方面很神奇。若要在 Gentoo 中安装一个软件包，通常要定义如何进行软件源代码包的下载、解包、打补丁、编译、安装以及合并。为了实现对软件包进行细微的定制，还需要定义一些有用的元数据（即 USE 旗标）、补丁文件以及一些操控软件包编译与安装的过程。Gentoo 是通过 GNU Bash shell 脚本来定义这一切，这种脚本就是所谓的 ebuild 文件。</p>
<h4 id="ebuild-在哪里">ebuild 在哪里？<a hidden class="anchor" aria-hidden="true" href="#ebuild-在哪里">#</a></h4>
<p>我们在安装 Gentoo 时，一个必须的步骤是下载一个 Portage 树的镜像包，解包后通常安置于 <code>/var/db/repos/gentoo</code> 目录，之后每次执行 <code>emerge --sync</code> 时，便会根据官方远程网站上的 Portage 树来更新你本地的 Portage 树。</p>
<p>粗枝大叶的看，Portage 树有四层结点。根结点便是 <code>/var/db/repos/gentoo</code> 目录，第 2 层结点是软件包所属分类目录，第 3 层结点是软件包的名称目录，叶子结点则是 ebuild 文件以及其他辅助性文件或目录。以 <code>gnome-shell-3.12.2.ebuild</code> 文件为例，它在 Portage 树中的完整路径是 <code>/var/db/repos/gentoo/gnome-base/gnome-shell/gnome-shell-41.1.ebuild</code>。</p>
<p>对于我们期望的软件包，如果 Portage 树未提供针对它的 ebuild 文件，那么我们需要自己动手丰衣足食。一般是不建议将我们所写的 ebuild 文件放在 Portage 树中的，因为它们可能会在 <code>emerge --sync</code> 期间被冲刷（比如被官方的同名文件替换）。</p>
<p>Portage 树支持一种被称为 Overlay 的技术。简单来说，就是我们可以另行建立一棵新的 Portage 树，这棵树的规模虽然比官方的 Portage 树小很多，但是 Portage 树的管理系统可以将这可新的 Portage 树与官方 Portage 树『合并』。如果新的 Portage 树中某些结点与官方的 Portage 树存在重叠，那么 Portage 树的管理系统会以前者覆盖后者，因此我们新建的 Portage 树通常被直呼为『Overlay』。</p>
<h4 id="建立自己的-overlay">建立自己的 Overlay<a hidden class="anchor" aria-hidden="true" href="#建立自己的-overlay">#</a></h4>
<p>在 <code>/var/db/repos/</code> 目录中创建自己的 Overlay：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /var/db/repos/localrepo/{metadata,profiles}</span>
<span style="color:#75715e"># chown -R portage:portage /var/db/repos/localrepo</span>
</code></pre></div><p>在该 <code>/var/db/repos/localrepo/profiles/</code> 内添加 <code>repo_name</code> 文件。我们可以在这份文件中设置 Overlay 名称，只需将 Overlay 名称写入该文件即可。例如，我将我的 Overlay 命名为 <code>localrepo</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;localrepo&#39; &gt; /var/db/repos/localrepo/profiles/repo_name</span>
</code></pre></div><p>为了让我们的 Overlay 能够被 Portage 管理系统所接受，需要在 <code>/var/db/repos/localrepo/metadata/layout.conf</code> 内添加：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">masters</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">gentoo</span>
<span style="color:#a6e22e">auto-sync</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</code></pre></div><p>需要将 Overlay 路径告知 Portage 管理系统，即在 <code>/etc/portage/repos.conf/localrepo.conf</code> 文件中添加以下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[localrepo]</span>
<span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/var/db/repos/localrepo</span>
</code></pre></div><p>今后，就在这个 Overlay 中学习 ebuild 文件的编写。</p>
<h4 id="hello-world">Hello World!<a hidden class="anchor" aria-hidden="true" href="#hello-world">#</a></h4>
<p>下面通过写一个非常简单的 ebuild 文件来获取一些直观的认识。假设在 <code>app-misc</code> 这个分类中有一个名为 <code>hello-world</code> 的软件包，现在我们要为这个软件包的 1.0 版的安装写一份 ebuild 文件。</p>
<blockquote>
<p>注意：软件包的分类名并不是随意的，它必须要与 <code>/var/db/repos/gentoo</code> 中的某个子目录名一致。</p>
</blockquote>
<p>首先在 Overlay 中建立软件包所在的分支：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /var/db/repos/localrepo/app-misc/hello-world</span>
</code></pre></div><p>可从 <code>/var/db/repos/gentoo/header.txt</code> 文件中获得 ebuild 文件默认的文件头，即：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-apache" data-lang="apache"><span style="color:#75715e"># Copyright 2021 Gentoo Authors</span>
<span style="color:#75715e"># Distributed under the terms of the GNU General Public License v2</span>
</code></pre></div><p>只不过是一些 Bash 脚本注释形式的文件描述信息而已，但它们是必须的。可以直接将 <code>/var/db/repos/gentoo/header.txt</code> 文件复制为 <code>hello-world-1.0.ebuild</code> 文件，这样便可获得一个含有上述内容的空 ebuild 文件。ebuild 文件的名称必须符合 Portage 所认可的格式，即：<code>软件包名称-版本号.ebuild</code>。这一点很重要。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /var/db/repos/gentoo/header.txt /var/db/repos/localrepo/app-misc/hello-world/hello-world-1.0.ebuild</span>
</code></pre></div><p>下面，为这份 ebuild 文件增加以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">SLOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span>
</code></pre></div><p>这样，我们便建立了一份最为简单的 ebuild 文件。接下来就是在这份文件上签个字……也就是为之生成一份签名文件，表示这个 ebuild 的是我们做的，出了事我们负责。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cd /var/db/repos/localrepo/app-misc/hello-world</span>
<span style="color:#75715e"># ebuild ./hello-world-1.0.ebuild manifest</span>
</code></pre></div><p>若签名成功，会在 ebuild 文件同一目录中生成一份名为 <code>Manifest</code> 的文件。将来发布这份 ebuild 文件时，需要将数字签名文件一起发出，这样他人便可以验证这份 ebuild 是不是我们做的。因为非常有可能我们在向朋友们发送 ebuild 文件的过程中会被坏人拦截，然后篡改 ebuild 文件。由于 ebuild 是可被系统执行的脚本，因此很有可能变成『病毒』。因此，ebuild 文件的数字签名非常有必要。不过，这里为了简单起见，没有涉及如何用自己的密钥实现对 ebuild 的签名，所得 <code>Manifest</code> 文件仅仅是为了让 ebuild 能够被 Portage 管理系统所认可。</p>
<p>下面，继续向这份 ebuild 加入一些内容，使之变为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#75715e"># Copyright 2021 Gentoo Authors</span>
<span style="color:#75715e"># Distributed under the terms of the GNU General Public License v2</span>
 
<span style="color:#a6e22e">EAPI</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;7&#34;</span>
<span style="color:#a6e22e">SLOT</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span>
<span style="color:#a6e22e">DESCRIPTION</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;A classical example to use when starting on something new.&#34;</span>
<span style="color:#a6e22e">HOMEPAGE</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://wiki.gentoo.org/index.php?title=Basic_guide_to_write_Gentoo_Ebuilds&#34;</span>
 
<span style="color:#a6e22e">LICENSE</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;MIT&#34;</span>
<span style="color:#a6e22e">KEYWORDS</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;~alpha ~amd64 ~arm ~hppa ~ia64 ~ppc ~ppc64 ~s390 ~sh ~sparc ~x86&#34;</span>
</code></pre></div><p>基本上就是在原来那份最简单的 ebuild 文件的基础上增加了几个变量：</p>
<ul>
<li><code>EAPI</code>：Portage 系统已经为我们编写了许多有用的 Bash 函数，将 <code>EAPI</code> 的值设为 <code>7</code> 表示我们要用目前最新的 Bash 函数。这个变量必须要在 ebuild 文件头之后进行设定。</li>
<li><code>DESCRIPTION</code>：这个变量存储了 <code>hello-world</code> 这个软件包的简介信息。</li>
<li><code>HOMEPAGE</code>：定义了 <code>hello-world</code> 这个软件包的项目主页。</li>
<li><code>LICENSE</code>：定义了 <code>hello-world</code> 这个软件包所使用的许可证，例如 LGPL，GPL V2，GPL V3，MIT 等。</li>
<li><code>KEYWORDS</code>：如果你期望 <code>hello-world</code> 这个软件包能够安装在你的机器上，那么 <code>KEYWORDS</code> 变量的值必须要包含你在 <code>/etc/make.conf</code> 中所设定的 <code>ACCEPT_KEYWORDS</code> 值。</li>
</ul>
<p>一旦改动了 ebuild 文件内容，那么必须重新生成 <code>Manifest</code> 文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ebuild ./hello-world-1.0.ebuild manifest</span>
</code></pre></div><p>现在，便可以使用 <code>emerge</code> 命令安装这个目前依然是子虚乌有的软件包了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -a hello-world</span>

These are the packages that would be merged, in order:

Calculating dependencies... <span style="color:#66d9ef">done</span>!
<span style="color:#f92672">[</span>ebuild  N    ~<span style="color:#f92672">]</span> app-misc/hello-world-1.0::localrepo  <span style="color:#ae81ff">0</span> KiB

Total: <span style="color:#ae81ff">1</span> package <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> new<span style="color:#f92672">)</span>, Size of downloads: <span style="color:#ae81ff">0</span> KiB
</code></pre></div><p>虽然到现在为止，还是什么也没有做出来，但是看着 <code>emerge</code> 神奇的发现了我写的 <code>ebuild</code>，心底还是蔓生了一些幸福。</p>
<h4 id="emerge-与-ebuild-有什么联系">emerge 与 ebuild 有什么联系？<a hidden class="anchor" aria-hidden="true" href="#emerge-与-ebuild-有什么联系">#</a></h4>
<p>简单的说，就是 <code>emerge</code> 这个 Python 脚本会调用 <code>ebuild.sh</code> 这个 Bash 脚本，让后者去执行 ebuild 文件定义的软件包的下载、编译及安装过程。</p>
<p><img loading="lazy" src="/Distributions/2056857414-5611b125e4a99_fix732.png" alt=""  />
</p>
<p><code>ebuild.sh</code> 所操控的软件包安装过程是在一个沙箱（Sandbox）中进行的。这一过程结束后，<code>emerge</code> 脚本需要将沙箱中的成果转移到真实世界，即 <code>/</code> 目录。</p>
<h3 id="slothttpswikitankywoocomlinuxgentoohtmlslot"><a href="https://wiki.tankywoo.com/linux/gentoo.html#slot">SLOT</a><a hidden class="anchor" aria-hidden="true" href="#slothttpswikitankywoocomlinuxgentoohtmlslot">#</a></h3>
<p>SLOT, 即「槽」, 和具体某个包相关的概念, 是Gentoo实现多版本共存的基础。</p>
<p><code>0</code> 是默认的slot名, 表示没有使用slot;</p>
<p>slot名是空字符串表示彻底禁止使用slot;</p>
<p>带有slot的包, 包名后面会有<code>:</code>冒号分隔, 并带上slot, 如:</p>
<pre tabindex="0"><code>dev-python/dnspython-1.12.0-r200:py2
dev-python/dnspython-1.12.0-r300:py3
</code></pre><p>表示dnspython这个包分别有py2和py3两个slot。</p>
<p>相关的一些命令:</p>
<p><code>eix</code> 可以直接查看包的所有slot:</p>
<pre tabindex="0"><code>$ eix dnspython
* dev-python/dnspython
     Available versions:
     (py2)  1.12.0-r200
     (py3)  1.12.0-r300
       {examples test PYTHON_TARGETS=&quot;python2_7 python3_3 python3_4&quot;}
     Homepage:            http://www.dnspython.org/ https://pypi.python.org/pypi/dnspython
     Description:         DNS toolkit for Python
</code></pre><p><code>equery list -p</code>:</p>
<pre tabindex="0"><code>$ equery l -po dnspython
 * Searching for dnspython ...
[-P-] [  ] dev-python/dnspython-1.12.0-r200:py2
[-P-] [  ] dev-python/dnspython-1.12.0-r300:py3
[-P-] [ ~] dev-python/dnspython-1.12.0-r301:py3
</code></pre><p><code>equery keywords</code>:</p>
<pre tabindex="0"><code>$ equery keywords dnspython
Keywords for dev-python/dnspython:
            |                                 | u     |
            | a a   a         n   p r     s   | n     |
            | l m   r h i m m i   p i s   p   | u s   | r
            | p d a m p a 6 i o p c s 3   a x | s l   | e
            | h 6 r 6 p 6 8 p s p 6 c 9 s r 8 | e o   | p
            | a 4 m 4 a 4 k s 2 c 4 v 0 h c 6 | d t   | o
------------+---------------------------------+-------+-------
1.12.0-r200 | + + + ~ + + o o o + + o ~ ~ + + | o py2 | gentoo
------------+---------------------------------+-------+-------
1.12.0-r300 | + + + ~ + + o o o + + o ~ ~ + + | o py3 | gentoo
1.12.0-r301 | ~ ~ ~ ~ ~ ~ o o o ~ ~ o ~ ~ ~ ~ | o     | gentoo
</code></pre><h4 id="真实的-hello-world">真实的 Hello World！<a hidden class="anchor" aria-hidden="true" href="#真实的-hello-world">#</a></h4>
<p>在一个遥远的地方，真的存在着 hello-world 的源码包。我们只要通过 ebuild 文件将这个源码包的位置告诉 <code>ebuild.sh</code> 脚本，<code>ebuild.sh</code> 便会不远万里将其擒来。所以，我们需要在 <code>hello-world-1.0.ebuild</code> 文件中添加以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">SRC_URI</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://gitlab.com/alogim/gentoo-basic-ebuild/-/raw/master/update1/hello-world-1.0.tar.gz?inline=false&#34;</span>
</code></pre></div><p><code>SRC_URI</code> 这个变量便是存储源码包的下载地址的。</p>
<p>在重新生成 <code>Manifest</code> 时，<code>ebuild.sh</code> 便会自动将源码包下载到 <code>/var/cache/distfiles/</code> 目录，并为这个源码包也生成一个数字签名存储在 <code>Manifest</code> 文件中。</p>
<p>既然有了 <code>hello-world</code> 的源码包，那么下一步就该思考如何在 ebuild 文件中定义这个源码包的编译过程了。不过，解开刚才下载的 <code>hello-world-1.0.tar.gz</code> 包看一下，发现包里只有一份 Bash 脚本 <code>hello-world</code>，其内容为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>
echo <span style="color:#e6db74">&#34;Hello world!&#34;</span>
</code></pre></div><p>所以，这个源码包就没必要编译了，直接安装到系统中即可。从而，我们在 ebuild 文件中获得了第一次编写 ebuild 函数的机会。在现有的 <code>hello-world-1.0.ebuile</code> 的文件中继续添加以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">src_install<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    dobin hello-world
<span style="color:#f92672">}</span>
</code></pre></div><p><code>src_install</code> 是 <code>ebuild.sh</code> 脚本能够识别并执行的函数名。也就是说，从 <code>ebuild.sh</code> 脚本的角度来看，你若想让我替你将软件包安装至系统中，那么你必须得按照我的习惯来。我的习惯就是在你提供给我的 ebuild 文件中寻找 <code>src_install</code> 这个函数，如果有这个函数，我就执行它，否则我就什么也不做。这就是 <code>ebuild.sh</code> 与 ebuild 文件之间达成的一个约定。</p>
<p>现在我们在 ebuild 文件中向 <code>ebuild.sh</code> 提供了 <code>src_install</code> 这个函数。这个函数只包含一条命令：<code>dobin hello-world</code> 。这个命令的意思是为 <code>hello-world</code> 这个脚本设置可执行权限，然后将其安装至系统默认的可执行文件目录中，即 <code>/usr/bin</code> 目录。</p>
<p><code>src_install</code> 只是 <code>ebuild.sh</code> 与 ebuild 文件之间众多约定函数中的一个而已，并且这些约定函数是顺次被 <code>ebuild.sh</code> 执行的，如下图所示：</p>
<p><img loading="lazy" src="/Distributions/4012241762-5611b1511041c_fix732.png" alt=""  />
</p>
<p>这里存在一个问题，<code>hello-world</code> 这个 Bash 脚本是包含在 <code>hello-world-1.0.tar.gz</code> 这个包内的，而我们只在 <code>hello-world-1.0.ebuild</code> 文件中定义了 <code>src_install</code> 函数，那么 <code>hello-world-1.0.tar.gz</code> 何时被解包的呢？这个问题的答案是，Portage 管理系统中已经为这些约定的函数定义了默认行为。比如，用于为源码包解包的 <code>src_unpack</code> 函数，其默认的定义是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">src_unpack<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>A<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
        unpack <span style="color:#e6db74">${</span>A<span style="color:#e6db74">}</span>
    <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>如果在 ebuild 文件中没有重新定义 <code>src_unpack</code> 函数，那么 <code>ebuild.sh</code> 便会按照上面图示的管线调用默认的 <code>src_unpack</code> 函数。所以 <code>hello-world</code> 脚本得以从 <code>hello-world-1.0.tar.gz</code> 中解出。</p>
<p>对现在的 <code>hello-world-1.0.ebuild</code> 再次生成 <code>Manifest</code>，然后就可以用它将 <code>hello-world</code> 脚本安装至 <code>/usr/bin</code> 目录中了。</p>
<p>这就是我们用自己写的 ebuild 安装的第一个『软件包』。</p>
<h2 id="ebuild-repositoryhttpswikigentooorgwikiebuild_repository"><a href="https://wiki.gentoo.org/wiki/Ebuild_repository">ebuild repository</a><a hidden class="anchor" aria-hidden="true" href="#ebuild-repositoryhttpswikigentooorgwikiebuild_repository">#</a></h2>
<p>An <strong>ebuild repository</strong>, colloquially known as an <strong>overlay</strong>, is a structure of directories and files used to add and extend software packages for a Gentoo-based system.</p>
<p>Ebuild repositories contain ebuilds, eclasses, and other types of descriptive metadata files. These files inform the package manager of software available for installation, news items, and profile targets. An ebuild repository should conform to one or more <a href="https://wiki.gentoo.org/wiki/EAPI">Ebuild APIs</a> as detailed in Gentoo&rsquo;s <a href="https://wiki.gentoo.org/wiki/Package_Manager_Specification">Package Manager Specification</a>.</p>
<p>The <em><strong><a href="https://wiki.gentoo.org/wiki/Ebuild_repository#The_Gentoo_ebuild_repository">Gentoo ebuild repository</a></strong></em>, as Gentoo&rsquo;s primary and &ldquo;official&rdquo; repository, is the source for all the information needed to build and install Gentoo packages, contained in <a href="https://wiki.gentoo.org/wiki/Ebuild">ebuilds</a>.</p>
<p>Administrators of Gentoo systems can add additional ebuild repositories by using various utilities and methods described below.</p>
<h3 id="the-gentoo-ebuild-repository">The Gentoo ebuild repository<a hidden class="anchor" aria-hidden="true" href="#the-gentoo-ebuild-repository">#</a></h3>
<p>The <em>Gentoo ebuild repository</em> will sometimes be called by shorter, or even colloquial, names, such as the <em><strong>Gentoo repository</strong></em>, the <em><strong>Gentoo repo</strong></em>, <em><strong>::gentoo</strong></em>, <em><strong>gentoo.git</strong></em>, or occasionally just the &ldquo;<em><strong>repo</strong></em>&rdquo;. It was historically known within the Gentoo community as the <em>Portage tree</em>, <em>rsync tree</em>, or sometimes just &ldquo;<em>the tree</em>&rdquo;.</p>
<h3 id="repositories-in-general">Repositories in general<a hidden class="anchor" aria-hidden="true" href="#repositories-in-general">#</a></h3>
<p>Repositories are handled through <a href="https://wiki.gentoo.org/wiki//etc/portage/repos.conf">/etc/portage/repos.conf</a> (which, like many other Portage configuration locations, can be a file or a directory), and the <a href="https://wiki.gentoo.org/wiki/Eselect/Repository"><strong>eselect repository</strong></a> is is a tool to manage this configuration.</p>
<p>Repository definitions inside /etc/portage/repos.conf also inform Portage if and how the repository can be updated. With it, calling <strong>emaint sync &ndash;auto</strong> will automatically update the enabled repositories as well.</p>
<p>A deprecated, yet still supported method is to use the PORTDIR_OVERLAY variable inside /etc/portage/make.conf. This variable can point to one or more additional locations on the file system where additional repositories are available. The use of the <a href="https://wiki.gentoo.org/wiki//etc/portage/repos.conf">/etc/portage/repos.conf</a>/ directory is highly preferred.</p>
<p>For more information, see <a href="https://wiki.gentoo.org/wiki//etc/portage/repos.conf">/etc/portage/repos.conf</a> and the <a href="https://wiki.gentoo.org/wiki/Project:Portage/Sync#Operation">Portage/Sync article</a>.</p>
<h4 id="priorities">Priorities<a hidden class="anchor" aria-hidden="true" href="#priorities">#</a></h4>
<p>Ebuilds from repositories with higher priority numbers (for example <code>60</code>) will take precedence over ebuilds from repositories with lower priorities (such as <code>50</code>).</p>
<p>The list of ebuild repositories with their priorities can be obtained through the output of the following commands (look for the &ldquo;Repositories&rdquo; string):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --info --verbose</span>
<span style="color:#75715e"># portageq repos_config /</span>
</code></pre></div><p>The Gentoo ebuild repository will have a priority of <code>-1000</code> which means that all other repositories generally take precedence if they are assigned a higher priority. This is the default behaviour, because ebuild repositories are designed to &ldquo;lay over&rdquo; or &ldquo;on top&rdquo; of the Gentoo repository. To set the priority of other repositories, manually edit the relevant repos.conf section and set <strong>priority =</strong> to the desired value. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/repos.conf/eselect-repo.conf</span>

<span style="color:#f92672">[</span>guru<span style="color:#f92672">]</span>
location <span style="color:#f92672">=</span> /var/db/repos/guru
sync-type <span style="color:#f92672">=</span> git
sync-uri <span style="color:#f92672">=</span> https://github.com/gentoo-mirror/guru.git
priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</code></pre></div><p>Repositories that do not have a priority set default to 0.</p>
<h3 id="repository-synchronization">Repository synchronization<a hidden class="anchor" aria-hidden="true" href="#repository-synchronization">#</a></h3>
<p>Repository synchronization is generally managed with the <strong>emaint sync</strong> command. See the <a href="https://wiki.gentoo.org/wiki/Project:Portage/Sync#Operation">Portage sync</a> article, and <strong>man emaint</strong> for information on how to use the portage synchronization commands.</p>
<p>The <strong>emerge &ndash;sync</strong> command is now only a compatibility command, calling the emaint module. <strong>eix-sync</strong> is a wrapper using <strong>emerge &ndash;sync</strong>, followed by <strong>eix-update</strong>. For further details see the <a href="https://wiki.gentoo.org/wiki/Eix">Eix</a> article and <strong>man eix</strong>.</p>
<p>The <a href="https://wiki.gentoo.org/wiki/Portage#emerge-webrsync">emerge-webrsync</a> tool can be used to download and install the daily Gentoo Repository snapshot. This may help with firewall restrictions.</p>
<h3 id="repository-management-tools">Repository management tools<a hidden class="anchor" aria-hidden="true" href="#repository-management-tools">#</a></h3>
<h4 id="eselect-repository">eselect-repository<a hidden class="anchor" aria-hidden="true" href="#eselect-repository">#</a></h4>
<p><a href="https://wiki.gentoo.org/wiki/Eselect/Repository"><strong>eselect repository</strong></a> maintains /etc/portage/repos.conf entries for Portage to access and synchronize.</p>
<h4 id="layman">Layman<a hidden class="anchor" aria-hidden="true" href="#layman">#</a></h4>
<p><a href="https://wiki.gentoo.org/wiki/Eselect/Repository"><strong>eselect repository</strong></a> supersedes layman for most uses.</p>
<h3 id="usage">Usage<a hidden class="anchor" aria-hidden="true" href="#usage">#</a></h3>
<h4 id="emerging-a-duplicate-package">Emerging a duplicate package<a hidden class="anchor" aria-hidden="true" href="#emerging-a-duplicate-package">#</a></h4>
<p>When working with ebuild repositories it is possible to encounter a situation where multiple versions of the same package are available from different ebuild repositories. Instruct <a href="https://wiki.gentoo.org/wiki/Portage">Portage</a> to install a specific package from a specific ebuild repository with the <code>::</code> <a href="https://wiki.gentoo.org/wiki/Version_specifier#By_ebuild_repository">version specifier</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask category/atom::repository-name</span>
</code></pre></div><p>The same notation can be used for different emerge instructions, including uninstalling a package through <code>--depclean</code>.</p>
<h3 id="best-practices">Best practices<a hidden class="anchor" aria-hidden="true" href="#best-practices">#</a></h3>
<h4 id="cache-generation">Cache generation<a hidden class="anchor" aria-hidden="true" href="#cache-generation">#</a></h4>
<p>When large ebuild repositories are installed, Portage may take a long time to perform operations like dependency resolution. This is because ebuild repositories do not usually contain a metadata cache.</p>
<p>Generate a local metadata cache by running <strong>emerge &ndash;regen</strong> after syncing the ebuild repositories:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emaint sync --allrepos</span>
<span style="color:#75715e"># ( ulimit -n 4096 &amp;&amp; emerge --regen )</span>
</code></pre></div><p>Be careful, because <strong>emerge &ndash;regen</strong> takes a lot of time and it&rsquo;s not recommended for rsync users as rsync updates the cache using server-side caches (most of users of portage are rsync users). Rsync users should simply run <strong>emerge &ndash;sync</strong> (or <strong>eix-sync</strong>) to regenerate the cache. It&rsquo;s probably only users of very large ebuild repositories should try <strong>emerge &ndash;regen</strong>.</p>
<h4 id="masking-enabled-ebuild-repositories">Masking enabled ebuild repositories<a hidden class="anchor" aria-hidden="true" href="#masking-enabled-ebuild-repositories">#</a></h4>
<p>When using <em>large</em> ebuild repositories or those with <em>unknown/low quality code</em>, it is best practice to hard mask the whole ebuild repository and only accept specific ebuilds on a case-by-case basis. For example, for an overlay named &ldquo;repository-foobar&rdquo;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/package.mask/repository-foobar</span>
*/*::repository-foobar
</code></pre></div><p>Then add the specific package(s) from the repository-foobar overlay so that they will be available visible to Portage for installation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/package.unmask/bar</span>
foo-category/bar::repository-name
</code></pre></div><p>After the above unmask the package named &ldquo;foo-category/bar&rdquo; should be available and none of the other packages from the repository-foobar overlay will be available, which is by design.</p>
<h2 id="projectportagesynchttpswikigentooorgwikiprojectportagesync"><a href="https://wiki.gentoo.org/wiki/Project:Portage/Sync">Project:Portage/Sync</a><a hidden class="anchor" aria-hidden="true" href="#projectportagesynchttpswikigentooorgwikiprojectportagesync">#</a></h2>
<p>The new plug-in sync system is the next step in that migration. Using PORTDIR and PORTDIR_OVERLAY in make.conf could only list <em>where</em> the repository was location. Users could not specify other important attributes about that repository. The repos.conf style configuration allows for settings to be added on a per sync-type basis. Along with this new expandability and the plug-in sync system, it will be much easier to change to new repository syncing methods.</p>
<h3 id="general-help">General help<a hidden class="anchor" aria-hidden="true" href="#general-help">#</a></h3>
<p><strong>Note</strong>: While Portage can handle repos.conf as either a file or a directory of files. The preferred method is to be used as a <em><strong>directory</strong></em>. Other tools like <strong>layman</strong> and <strong>mirrorselect</strong> require and expect it to be a directory. Layman creates and manages its own layman.conf file to register installed overlays with Portage. <strong>mirrorselect</strong> looks for repos.conf/gentoo.conf file in order to modify the <code>sync-uri</code> parameter for the gentoo repository.</p>
<h4 id="migration">Migration<a hidden class="anchor" aria-hidden="true" href="#migration">#</a></h4>
<p><strong>Portage configuration</strong></p>
<p>If the /etc/portage/repos.conf directory does not exist:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir /etc/portage/repos.conf</span>
<span style="color:#75715e"># cp /usr/share/portage/config/repos.conf /etc/portage/repos.conf/gentoo.conf</span>
</code></pre></div><p>Then edit the file for your installation and desired settings, continue as needed with the remaining migration instructions. Edit all repos.conf/*.conf files, add the auto-sync option to each defined repository.</p>
<p>For sync-type, edit it to one of the installed supported types.</p>
<p>Current supported sync types include:</p>
<ol>
<li><code>rsync</code></li>
<li><code>git</code></li>
<li><code>svn</code></li>
<li><code>webrsync</code> or <code>websync</code> (equivalent to running <strong>emerge-webrsync</strong> separately).</li>
<li><code>cvs</code></li>
<li><code>laymansync</code> (if installed by <a href="https://wiki.gentoo.org/wiki/Layman">Layman</a>)</li>
</ol>
<p><a href="https://forums.gentoo.org/viewtopic-t-1072466-start-0.html">Example</a> local overlay sync-able from a git backup:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nano -w /etc/portage/repos.conf/gentoo.conf</span>
<span style="color:#f92672">[</span>DEFAULT<span style="color:#f92672">]</span>
main-repo <span style="color:#f92672">=</span> gentoo

<span style="color:#f92672">[</span>gentoo<span style="color:#f92672">]</span>
location <span style="color:#f92672">=</span> /var/db/repos/gentoo
sync-type <span style="color:#f92672">=</span> git
sync-uri <span style="color:#f92672">=</span> https://github.com/gentoo-mirror/gentoo.git
auto-sync <span style="color:#f92672">=</span> yes
priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
</code></pre></div><p>The above overlay can be synced with</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emaint sync -r gentoo</span>
</code></pre></div><h4 id="operation">Operation<a hidden class="anchor" aria-hidden="true" href="#operation">#</a></h4>
<p>Primary control of all sync operations has been moved from <strong>emerge</strong> to <strong>emaint</strong>. <strong>emerge &ndash;sync</strong> now runs the emaint sync module with the <code>--auto</code> option. This <code>--auto</code> option performs a sync on only those repositories with the auto-sync setting set to <code>yes</code> or <code>true</code>. If the auto-sync option is <em>not</em> set to <code>yes</code> or is absent, then <strong>emerge &ndash;sync</strong> may not sync any repositories.</p>
<p><strong>Note</strong>: As a result of the default auto-sync = True/Yes setting, commands like <strong>eix-sync</strong>, <strong>esync -l</strong>, <strong>emerge &ndash;sync &amp;&amp; layman -S</strong> will cause many repositories to be synced multiple times in a row. Please adjust configuration files or scripts as necessary for the new operation.</p>
<p><strong>Warning</strong>: Due to the above default. For any repositories (repos) that you EXPLICITLY do <em><strong>not</strong></em> want to be synced. You MUST set <code>auto-sync = no</code></p>
<h4 id="examples">Examples<a hidden class="anchor" aria-hidden="true" href="#examples">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emaint sync -a</span>
</code></pre></div><p>Equivalent to <strong>emerge &ndash;sync</strong>. Sync all repositories where <code>auto-sync = true</code> is set.</p>
<p><strong>Note</strong>: Due to the default <code>auto-sync = true</code> setting, this command will sync all repositories that do not have <code>auto-sync = no</code> explicitly set.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emaint sync -r foo</span>
</code></pre></div><p>Sync the foo repo (ignores auto-sync setting):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emaint sync --allrepos</span>
</code></pre></div><p>Sync all repositories with a valid sync-type and sync-url defined. (ignores auto-sync setting)</p>
<h2 id="显卡驱动httpslitterhougelangleylifeblog20210521gentoo"><a href="https://litterhougelangley.life/blog/2021/05/21/gentoo/">显卡驱动</a><a hidden class="anchor" aria-hidden="true" href="#显卡驱动httpslitterhougelangleylifeblog20210521gentoo">#</a></h2>
<p>在之前安装 Gentoo Linux 的过程中，二进制内核本身已自带了大多数显卡的内核驱动部分，该部分负责接收用户空间发送的指令及数据，进行处理后传递给显卡。</p>
<h3 id="makeconf">make.conf<a hidden class="anchor" aria-hidden="true" href="#makeconf">#</a></h3>
<p>对于 X 而言，这里以现代化的 N 卡为例，编辑 <code>/etc/portage/make.conf</code> 文件，双显卡 Intel+NVIDIA 添加以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;VIDEO_CARDS=&#34;intel i965 iris nvidia&#34;&#39; &gt;&gt; /etc/portage/make.conf</span>
</code></pre></div><ul>
<li>Intel 的一般设为 intel i965 iris， 详细查阅： <a href="https://wiki.gentoo.org/wiki/Intel">https://wiki.gentoo.org/wiki/Intel</a>。</li>
<li>N 卡开源驱动一般设为 nouveau， 详细查阅： <a href="https://wiki.gentoo.org/wiki/Nouveau">https://wiki.gentoo.org/wiki/Nouveau</a>。如若你的显卡是较新的 N 卡，开源驱动还未支持，请安装闭源驱动。</li>
<li>N 卡闭源驱动一般设为 nvidia， 详细查阅： <a href="https://wiki.gentoo.org/wiki/NVIDIA/nvidia-drivers">https://wiki.gentoo.org/wiki/NVIDIA/nvidia-drivers</a>。</li>
<li>amdgpu 用于给 X 开启 2D 驱动（X 下必须），radeonsi 用于给 OpenGL 的实现 mesa 开启对内核下 amdgpu 驱动的支持（无论 X 还是 Wayland 均需配置），如果 A 卡比较老，则额外添加 radeon 值，详细查阅： <a href="https://wiki.gentoo.org/wiki/AMDGPU">https://wiki.gentoo.org/wiki/AMDGPU</a>。</li>
<li>虚拟机下的驱动设置得具体看，比如现在的 VirtualBox 和 VMWare 都用 vmware 驱动，那么就设置值为 vmware，再比如 QEMU 可选使用 virgl 驱动，那么就设置为 virgl。</li>
</ul>
<p>在这里，还需将之前配置的普通用户 kurome 添加到 <code>video</code> 组下以使用硬件加速功能。执行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># gpasswd -a kurome video</span>
<span style="color:#75715e"># or</span>
<span style="color:#75715e"># groupmod -a video -U kurome</span>
</code></pre></div><h3 id="驱动">驱动<a hidden class="anchor" aria-hidden="true" href="#驱动">#</a></h3>
<h4 id="intel">Intel<a hidden class="anchor" aria-hidden="true" href="#intel">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -av xorg-server xf86-video-intel</span>
</code></pre></div><h4 id="nvidia">nvidia<a hidden class="anchor" aria-hidden="true" href="#nvidia">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -av nvidia-drivers xrandr</span>
</code></pre></div><p>禁用 nouveau：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cat &gt;&gt; /etc/modprobe.d/blacklist.conf</span>
blacklist nouveau
blacklist lbm-nouveau
options nouveau modeset<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</code></pre></div><p>要起作用，需要重启。</p>
<h3 id="nvidiaoptimushttpswikigentooorgwikinvidiaoptimus"><a href="https://wiki.gentoo.org/wiki/NVIDIA/Optimus">NVIDIA/Optimus</a><a hidden class="anchor" aria-hidden="true" href="#nvidiaoptimushttpswikigentooorgwikinvidiaoptimus">#</a></h3>
<p><strong>注意：请安装完成桌面环境后再来看这部分。</strong></p>
<p>一般情况下，intel + nvidia 用混合模式。</p>
<h4 id="xorgconf">xorg.conf<a hidden class="anchor" aria-hidden="true" href="#xorgconf">#</a></h4>
<p>For a laptop with Intel integrated graphics and Nvidia discrete graphics, the following xorg.conf should be sufficient:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p  /etc/X11/xorg.conf.d/</span>
<span style="color:#75715e"># nano /etc/X11/xorg.conf.d/10-nvidia.conf</span>
Section <span style="color:#e6db74">&#34;ServerLayout&#34;</span>
    Identifier <span style="color:#e6db74">&#34;layout&#34;</span>
    Screen <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#34;nvidia&#34;</span>
    Inactive <span style="color:#e6db74">&#34;intel&#34;</span>
EndSection

Section <span style="color:#e6db74">&#34;Device&#34;</span>
    Identifier <span style="color:#e6db74">&#34;nvidia&#34;</span>
    Driver <span style="color:#e6db74">&#34;nvidia&#34;</span>
    BusID <span style="color:#e6db74">&#34;01:00:0&#34;</span>
    Option <span style="color:#e6db74">&#34;RegistryDwords&#34;</span> <span style="color:#e6db74">&#34;EnableBrightnessControl=1&#34;</span>
EndSection

Section <span style="color:#e6db74">&#34;Screen&#34;</span>
    Identifier <span style="color:#e6db74">&#34;nvidia&#34;</span>
    Device <span style="color:#e6db74">&#34;nvidia&#34;</span>
    Option <span style="color:#e6db74">&#34;AllowEmptyInitialConfiguration&#34;</span>
EndSection

Section <span style="color:#e6db74">&#34;Device&#34;</span>
    Identifier <span style="color:#e6db74">&#34;intel&#34;</span>
    Driver <span style="color:#e6db74">&#34;modesetting&#34;</span>
EndSection

Section <span style="color:#e6db74">&#34;Screen&#34;</span>
    Identifier <span style="color:#e6db74">&#34;intel&#34;</span>
    Device <span style="color:#e6db74">&#34;intel&#34;</span>
EndSection
</code></pre></div><p>有朋友会问，BusID 是否需要根据自己的改一改，我觉得可能不用，我用过 intel + nvidia 的3台笔记本，这个 BusID 都没有变过，还来自不同厂家，小米，Thinkpad，雷蛇。</p>
<p>也可以通过<a href="https://www.cyberciti.biz/faq/linux-tell-which-graphics-vga-card-installed/">如下命令</a>确认一下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ lspci | grep -i --color <span style="color:#e6db74">&#39;vga\|3d\|2d&#39;</span>
00:02.0 VGA compatible controller: Intel Corporation UHD Graphics <span style="color:#ae81ff">620</span> <span style="color:#f92672">(</span>rev 07<span style="color:#f92672">)</span>
01:00.0 3D controller: NVIDIA Corporation GM108M <span style="color:#f92672">[</span>GeForce 930MX<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>rev a2<span style="color:#f92672">)</span>
</code></pre></div><h4 id="gdm">gdm<a hidden class="anchor" aria-hidden="true" href="#gdm">#</a></h4>
<p>编辑<code>/usr/share/gdm/greeter/autostart/optimus.desktop</code> 和 <code>/etc/xdg/autostart/optimus.desktop</code> 文件。写入的内容均一样：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>Desktop Entry<span style="color:#f92672">]</span>
Type<span style="color:#f92672">=</span>Application
Name<span style="color:#f92672">=</span>Optimus
Exec<span style="color:#f92672">=</span>sh -c <span style="color:#e6db74">&#34;xrandr --setprovideroutputsource modesetting NVIDIA-0; xrandr --auto&#34;</span>
NoDisplay<span style="color:#f92672">=</span>true
X-GNOME-Autostart-Phase<span style="color:#f92672">=</span>DisplayServer
</code></pre></div><h4 id="sddm">sddm<a hidden class="anchor" aria-hidden="true" href="#sddm">#</a></h4>
<p>编辑 <code>/etc/sddm.conf</code> 文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>X11<span style="color:#f92672">]</span>
DisplayCommand<span style="color:#f92672">=</span>/etc/sddm/scripts/Xsetup
</code></pre></div><p>下面创建一个脚本目录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /etc/sddm/scripts</span>
</code></pre></div><p>创建启动脚本，<code>cat &gt; /etc/sddm/scripts/Xsetup</code> ，内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>xrandr --setprovideroutputsource modesetting NVIDIA-0
xrandr --auto
</code></pre></div><p>最后赋予权限：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ chmod u+x /etc/sddm/scripts/Xsetup
</code></pre></div><h4 id="无显示管理器httpszhuanlanzhihucomp174837792"><a href="https://zhuanlan.zhihu.com/p/174837792">无显示管理器</a><a hidden class="anchor" aria-hidden="true" href="#无显示管理器httpszhuanlanzhihucomp174837792">#</a></h4>
<p>修改 <code>~/.xinitrc</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>xrandr --setprovideroutputsource modesetting NVIDIA-0
xrandr --auto
xrdb -merge ~/.Xresources
<span style="color:#f92672">[</span> -f ~/.xprofile <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> source ~/.xprofile
exec dbus-launch --exit-with-session startplasma-x11
</code></pre></div><p>前两行为必填，后两行为启动X11时同时加载这两个文件。</p>
<p>编写一个简单脚本：假设名字为 sx.sh</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>sudo modprobe nvidia_drm nvidia_modeset nvidia <span style="color:#f92672">&amp;&amp;</span> startx
</code></pre></div><p>授权启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ chmod u+x sx.sh
$ ./sx.sh
</code></pre></div><h2 id="kdehttpswikigentooorgwikikdezh-cn"><a href="https://wiki.gentoo.org/wiki/KDE/zh-cn">KDE</a><a hidden class="anchor" aria-hidden="true" href="#kdehttpswikigentooorgwikikdezh-cn">#</a></h2>
<p><strong>KDE</strong> 是一个自由软件社区，其提供了一组应用程序，包括流行的 Plasma 桌面环境。</p>
<p>Gentoo对KDE项目的支持非常好，包括对KDE Frameworks 5，Plasma 5和Applications的全面支持，以及其他各种各样基于KDE的软件。</p>
<h3 id="profile">Profile<a hidden class="anchor" aria-hidden="true" href="#profile">#</a></h3>
<p>在安装心仪的 DE/WM 之前，建议切换到的 <code>desktop</code> profile 下，执行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect profile list</span>
</code></pre></div><p>以列出所有的 profiles，然后进行选择。例如：</p>
<p>openrc 下，可以选择</p>
<ul>
<li>amd64/17.1/desktop</li>
<li>amd64/17.1/desktop/gnome</li>
<li>amd64/17.1/desktop/plasma</li>
</ul>
<p>systemd 下，可以选择</p>
<ul>
<li>amd64/17.1/desktop/systemd</li>
<li>amd64/17.1/desktop/gnome/systemd</li>
<li>amd64/17.1/desktop/plasma/systemd</li>
</ul>
<p>如若只想安装轻量级的窗口管理器，那么可以选择类似 amd64/17.1/desktop 一样的纯 desktop profile。</p>
<p>根据本文上下文环境，这里我选择 amd64/17.1/desktop/plasma 以准备好 KDE Plasma 的前期环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect profile set 9</span>
</code></pre></div><p>虽然 <code>desktop</code> profile 下已经配置启动了基本的 ALSA 声音接口功能，但个人建议再启用 PulseAudio 声音服务器以获得更多功能。只需编辑 <code>/etc/portage/make.conf</code> 文件，设置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">echo &#39;USE</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;pulseaudio&#34;&#39; &gt;&gt; /etc/portage/make.conf</span>
</code></pre></div><p>切换到 <code>desktop</code> profile 并不是一个必须的操作，也可以在基础的 profile 或者其它的 profile 下进行，但如果这样的话，则需要再自行额外配置，会相对复杂一点，此处不多做说明。</p>
<h3 id="plasma">Plasma<a hidden class="anchor" aria-hidden="true" href="#plasma">#</a></h3>
<p>Plasma 5 是 KDE 正在发展的一代桌面环境，基于 Qt 5 和 KDE Framework 5 。</p>
<h4 id="安装-2">安装<a hidden class="anchor" aria-hidden="true" href="#安装-2">#</a></h4>
<p>kde-plasma/plasma-meta 包提供完整的 Plasma 5 桌面，执行此命令将 plasma-meta 这个元包添加到 world set 中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask kde-plasma/plasma-meta</span>
</code></pre></div><p>你也可以选择安装 <a href="https://packages.gentoo.org/packages/kde-plasma/plasma-desktop">kde-plasma/plasma-desktop</a>，它提供了一个非常基本的桌面，让用户可以自由安装他们需要的额外软件包 - 或者更确切地说，让他们自己找出并补全缺少的功能。</p>
<p><strong>警告</strong>：请注意，仅安装<a href="https://packages.gentoo.org/packages/kde-plasma/plasma-desktop">kde-plasma/plasma-desktop</a>会丢失重要的软件包，例如<a href="https://packages.gentoo.org/packages/kde-plasma/powerdevil">kde-plasma/powerdevil</a>（电源管理，挂起和休眠选项），<a href="https://packages.gentoo.org/packages/kde-plasma/systemsettings">kde-plasma/systemsettings</a>等等，在这种情况下都不会被支持。</p>
<p><strong>小工具</strong></p>
<p><a href="https://packages.gentoo.org/packages/kde-plasma/kdeplasma-addons">kde-plasma/kdeplasma-addons</a> 提供了很多有用的小工具 (早就被 <a href="https://packages.gentoo.org/packages/kde-plasma/plasma-meta">kde-plasma/plasma-meta</a>作为依赖安装了)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask kde-plasma/kdeplasma-addons</span>
</code></pre></div><p><strong>显示管理器</strong></p>
<p><a href="https://wiki.gentoo.org/wiki/SDDM">SDDM</a> （Simple Desktop Display Manager） 是被推荐的登录管理器并且它默认会通过 <a href="https://packages.gentoo.org/packages/kde-plasma/plasma-meta">kde-plasma/plasma-meta</a> 被自动安装。 另外你也可以选择使用 <a href="https://wiki.gentoo.org/wiki/LightDM">LightDM</a> ,这需要为 <a href="https://packages.gentoo.org/packages/kde-plasma/plasma-meta">kde-plasma/plasma-meta</a> 设置 <code>-sddm</code> 的 USE 旗标， 同时还要修改 <code>/etc/conf.d/xdm</code> 中的设置。 同时在发生错误时请阅读 <a href="https://wiki.gentoo.org/wiki/SDDM">SDDM</a> 页面。</p>
<p>如果是其它的 DM 也是启用对应的服务即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># systemctl enable sddm.service</span>
</code></pre></div><p><strong>无显示管理器</strong></p>
<p>Plasma 可以用<strong>startx</strong>以老式方式启动，但需要格外小心以确保它获得有效的会话。创建 <code>~/.xinitrc</code> 文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>exec dbus-launch --exit-with-session startplasma-x11
</code></pre></div><p>这也可以写入<code>~/.profile</code>文件中，该文件将在登录时执行。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dbus-launch --exit-with-session startplasma-wayland
</code></pre></div><h4 id="系统托盘">系统托盘<a hidden class="anchor" aria-hidden="true" href="#系统托盘">#</a></h4>
<p>Plasma 5 对系统托盘图标使用<a href="http://blog.martin-graesslin.com/blog/2014/03/system-tray-in-plasma-next/">StatusNotifier规范</a>。由于并非所有应用程序都已移植到新系统，因此需要一些<a href="http://blog.martin-graesslin.com/blog/2014/06/where-are-my-systray-icons/">应变方法</a>，并且 Plasma 5 也具有将旧的基于xembed的系统托盘图标转换为StatusNotifier图标的方法。</p>
<p>通过激活<a href="https://packages.gentoo.org/packages/kde-plasma/plasma-meta">kde-plasma/plasma-meta</a>的 <code>legacy-systray</code> 来启用传统支持，这将引入<a href="https://packages.gentoo.org/packages/kde-plasma/xembed-sni-proxy">kde-plasma/xembed-sni-proxy</a>。编辑 <code>/etc/portage/package.use/kde-plasma-settings</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># xembed system tray support for legacy applications</span>
kde-plasma/plasma-meta legacy-systray
</code></pre></div><h5 id="pidgin">Pidgin<a hidden class="anchor" aria-hidden="true" href="#pidgin">#</a></h5>
<p><a href="https://packages.gentoo.org/packages/net-im/pidgin">net-im/pidgin</a> 需要 <a href="https://packages.gentoo.org/packages/x11-plugins/pidgin-indicator">x11-plugins/pidgin-indicator</a>。安装完成后，在 <em>工具|插件</em> 下可以找到 <em>Ubuntu 指示器</em> 插件。</p>
<h4 id="kwallet">KWallet<a hidden class="anchor" aria-hidden="true" href="#kwallet">#</a></h4>
<p>在登录桌面后添加一个（无线）网络连接或者在<a href="https://packages.gentoo.org/packages/kde-apps/kmail">kde-apps/kmail</a>中添加一个电子邮箱账户时，许多用户被推荐使用 <a href="https://packages.gentoo.org/packages/kde-frameworks/kwallet">kde-frameworks/kwallet</a> —— Plasma桌面的加密密码存储器。</p>
<p>有个软件包<a href="https://packages.gentoo.org/packages/kde-apps/kwalletmanager">kde-apps/kwalletmanager</a>，可用于管理KWallets，导入及导出密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask kde-apps/kwalletmanager</span>
</code></pre></div><p><strong>KWallet 自动解锁</strong></p>
<p><a href="https://packages.gentoo.org/packages/kde-plasma/kwallet-pam">kde-plasma/kwallet-pam</a> 提供了一种机制，可以避免在登录后即被要求访问kwallet。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask kde-plasma/kwallet-pam</span>
</code></pre></div><p>需要如下的配置：</p>
<ul>
<li>为了KWallet的安全性，请使用比较传统的blowfish加密，而不是GPG</li>
<li>在kwallet和用户使用相同的密码</li>
<li>让登录管理器支持PAM特性 - <a href="https://packages.gentoo.org/packages/x11-misc/sddm">x11-misc/sddm</a> 和 <a href="https://packages.gentoo.org/packages/x11-misc/lightdm">x11-misc/lightdm</a> 都支持</li>
</ul>
<p>通过SDDM解锁KWallet PAM的配置行，编辑 <code>/etc/pam.d/sddm</code>：</p>
<pre tabindex="0"><code>-auth           optional        pam_kwallet5.so
-session        optional        pam_kwallet5.so auto_start
</code></pre><p><strong>附注</strong>：对于LightDM， 需要自己编辑<code>/etc/pam.d/lightdm</code></p>
<p><strong>附注</strong>：如果在登录时，存有你的用户的KWallet文件的文件系统已经被<a href="https://wiki.gentoo.org/wiki/Pam_mount">pam_mount</a>挂载，你可能需要将~/.local/share/kwalletd/kdewallet.salt复制到你的根文件系统的相同路径下。否则，PAM会在主目录可用之前尝试解锁KWallet并失败。实际包含加密的KWallet密码的文件<code>~/.local/share/kwalletd/kdewallet.kwl</code>不需要复制。</p>
<p><strong>禁用 KWallet</strong></p>
<p>要完全禁用KWallet子系统，请编辑 <code>~/.config/kwalletrc</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>Wallet<span style="color:#f92672">]</span>
Enabled<span style="color:#f92672">=</span>false
</code></pre></div><h4 id="sshgpg-密钥启动关闭脚本">SSH/GPG 密钥启动/关闭脚本<a hidden class="anchor" aria-hidden="true" href="#sshgpg-密钥启动关闭脚本">#</a></h4>
<p>ssh-agent 脚本位于 /etc/xdg/plasma-workspace/env 和 /etc/xdg/plasma-workspace/shutdown。关闭脚本需要设置可执行位，因为它们不是源。<a href="https://wiki.gentoo.org/wiki/Keychain">Keychain</a> 提供了更多信息</p>
<h5 id="using-keychain-with-plasma-5">Using keychain with Plasma 5<a hidden class="anchor" aria-hidden="true" href="#using-keychain-with-plasma-5">#</a></h5>
<p>Keychain is a frontend to <strong>ssh-agent</strong> and <strong>ssh-add</strong>, allowing long running sessions and letting the user enter passphases just once. It can also be used to allow scripts access to SSH connections.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask net-misc/keychain</span>
</code></pre></div><p>Plasma 5 users, instead of using <code>~/.bash_profile</code>, can let Plasma manage ssh-agent for them. In order to do so, edit <code>/etc/xdg/plasma-workspace/env/10-agent-startup.sh</code>, which is read during Plasma&rsquo;s startup, and <code>/etc/xdg/plasma-workspace/shutdown/10-agent-shutdown.sh</code>, which is executed during its shutdown.</p>
<p>Here is how one could edit those files:</p>
<p>Editing <code>/etc/xdg/plasma-workspace/env/10-agent-startup.sh</code> for Plasma 5</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">SSH_AGENT<span style="color:#f92672">=</span>true
</code></pre></div><p>Editing <code>/etc/xdg/plasma-workspace/shutdown/10-agent-shutdown.sh</code> for Plasma 5</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SSH_AGENT_PID<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  eval <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>ssh-agent -k<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">fi</span>
</code></pre></div><p>Now, all that has to be done is launch a terminal of choice, like <a href="https://packages.gentoo.org/packages/kde-apps/konsole">kde-apps/konsole</a>, and load the right set of keys to use. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ keychain ~/.ssh/id_rsa
</code></pre></div><p>The keys will be remembered until the end of the Plasma session (or until the <strong>ssh-agent</strong> process is killed manually).</p>
<h4 id="使用root权限运行-gui-应用">使用root权限运行 GUI 应用<a hidden class="anchor" aria-hidden="true" href="#使用root权限运行-gui-应用">#</a></h4>
<p><strong>警告</strong>：使用root权限启动 GUI 应用可能是一个 <em>非常</em> 坏的主意。相比之下，更好的办法是将常规用户添加到相应的组或者只是无提权地运行命令。只有在绝对必要时才使用 <strong>kdesu</strong> 。</p>
<p>KDE Plasma有一个实用程序，用于以root权限启动图形应用。它由<a href="https://packages.gentoo.org/packages/kde-plasma/kde-cli-tools">kde-plasma/kde-cli-tools</a>提供 - 要使用 USE 标志<code>kdesu</code>构建。这将会安装<a href="https://packages.gentoo.org/packages/kde-frameworks/kdesu">kde-frameworks/kdesu</a>的一个图形前端。这依赖<a href="https://wiki.gentoo.org/wiki/Xorg">Xorg</a>，并且仅在X内有效。编辑 <code>/etc/portage/package.use/kde-plasma-settings</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Build graphical frontend for kde-frameworks/kdesu (requires X)</span>
kde-plasma/kde-cli-tools kdesu X
</code></pre></div><p>记得要重建软件包以获取更改：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -1 kde-cli-tools</span>
</code></pre></div><p>可以通过从KRunner或终端仿真器调用<strong>kdesu</strong>来使用它：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># kdesu &lt;program-name&gt;</span>
</code></pre></div><p>将显示一个消息对话框，提示输入root密码。</p>
<p><strong>附注</strong>：出于安全原因，某些应用（如kwrite、dolphin等）拒绝使用<strong>kdesu</strong>打开。</p>
<h3 id="应用程序">应用程序<a hidden class="anchor" aria-hidden="true" href="#应用程序">#</a></h3>
<p>发行版本包含很多基于 Qt 5/KDE Frameworks 5 的应用程序和支持库。</p>
<h4 id="安装-3">安装<a hidden class="anchor" aria-hidden="true" href="#安装-3">#</a></h4>
<p><a href="https://packages.gentoo.org/packages/kde-apps/kde-apps-meta">kde-apps/kde-apps-meta</a> 包提供完整的应用程序集合，但是可替代地，可以挑选其中一个或多个较小的元包。</p>
<p>个人建议没必要使用默认设置来安装 kde-apps/kde-apps-meta 包，因为会引入太多不常用的应用，建议根据 USE 来管理（下文 USE 标记一节有说明），选择性安装，即</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;kde-apps/kde-apps-meta -*&#39; &gt; /etc/portage/package.use/kdeapps</span>
</code></pre></div><p>同时取消 kdecore-meta 的 webengine 依赖，以减少当下的编译时间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;kde-apps/kdecore-meta -webengine&#39; &gt;&gt; /etc/portage/package.use/kdeapps</span>
</code></pre></div><p>安装最核心的 KDE 应用，其它 KDE 应用根据需要安装即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask kde-apps/kde-apps-meta</span>
</code></pre></div><h4 id="本地化">本地化<a hidden class="anchor" aria-hidden="true" href="#本地化">#</a></h4>
<p>Plasma-5 和应用程序的每个包都提供了<a href="https://wiki.gentoo.org/wiki/Localization">本地化文件</a>。可以在系统设置中启用本地化。</p>
<h4 id="kde-pim">KDE PIM<a hidden class="anchor" aria-hidden="true" href="#kde-pim">#</a></h4>
<p>KDE PIM 是一整套用于管理个人信息的应用程序，包括邮件，日历，联系人等。它有几个可选的运行时依赖来扩展其功能：</p>
<ul>
<li>病毒检测：<a href="https://packages.gentoo.org/packages/app-antivirus/clamav">app-antivirus/clamav</a></li>
<li>垃圾邮件过滤：<a href="https://packages.gentoo.org/packages/mail-filter/bogofilter">mail-filter/bogofilter</a> 或 <a href="https://packages.gentoo.org/packages/mail-filter/spamassassin">mail-filter/spamassassin</a></li>
</ul>
<h3 id="框架">框架<a hidden class="anchor" aria-hidden="true" href="#框架">#</a></h3>
<p>KDE Frameworks 5 是一套运行库和软件框架的合集，为KDE Plasma 5 和 KDE 应用提供基础，但是可能会受到一些 Qt 程序的影响。</p>
<p>KDE 框架大部分是运行库，只提供少量的面对用户的功能。它不需要被手动安装 —— 需要的软件包会被作为别的软件包的依赖自动安装。</p>
<h3 id="更多kde软件">更多KDE软件<a hidden class="anchor" aria-hidden="true" href="#更多kde软件">#</a></h3>
<p>最主要的 KDE 应用程序在 Porage 树的 <a href="https://packages.gentoo.org/category/kde-apps">kde-apps</a> 和<a href="https://packages.gentoo.org/category/kde-misc">kde-misc</a> 分类中。</p>
<h3 id="tips">Tips<a hidden class="anchor" aria-hidden="true" href="#tips">#</a></h3>
<h4 id="how-to-reset-kde--display-settings-after-a-move-to-a-new-machinehttpsaskubuntucomquestions299241how-to-reset-kde-display-settings-after-a-move-to-a-new-machine"><a href="https://askubuntu.com/questions/299241/how-to-reset-kde-display-settings-after-a-move-to-a-new-machine">How to reset KDE / display settings after a move to a new machine</a><a hidden class="anchor" aria-hidden="true" href="#how-to-reset-kde--display-settings-after-a-move-to-a-new-machinehttpsaskubuntucomquestions299241how-to-reset-kde-display-settings-after-a-move-to-a-new-machine">#</a></h4>
<p>I had to remove <code>.local/share/kscreen</code> on plasma5</p>
<h2 id="gnomehttpswikigentooorgwikignomeguide"><a href="https://wiki.gentoo.org/wiki/GNOME/Guide">GNOME</a><a hidden class="anchor" aria-hidden="true" href="#gnomehttpswikigentooorgwikignomeguide">#</a></h2>
<p>GNOME 是一个流行的能够启动 Xorg 和 Wayland 会话的 <a href="https://wiki.gentoo.org/wiki/Desktop_environment">桌面环境</a> 。本指南 尝试描述 GNOME 的所有方面，包括安装、配置和使用。</p>
<p>从 3.30 版本开始，Gentoo 上的 GNOME 能够再次<a href="https://www.gentoo.org/news/2019/03/27/gnome-330-openrc.html">在 OpenRC 上运行</a>。详情参见 <a href="https://wiki.gentoo.org/wiki/User:Leio">Mart Raudsepp (leio)</a> 的 <a href="https://blogs.gentoo.org/leio/2019/03/26/gnome-3-30">blog post</a>。</p>
<h3 id="什么是-gnome">什么是 GNOME?<a hidden class="anchor" aria-hidden="true" href="#什么是-gnome">#</a></h3>
<h4 id="项目">项目<a hidden class="anchor" aria-hidden="true" href="#项目">#</a></h4>
<p>GNOME 项目是一个自由的软件组织，它致力于 GNOME 的发展，Unix/Linux 桌面套件和开发平台。 GNOME 基金会协调发展 GNOME 项目的其他方面。</p>
<h4 id="软件">软件<a hidden class="anchor" aria-hidden="true" href="#软件">#</a></h4>
<p>GNOME 是一个桌面环境和一个开发平台。这款自由软件是包括 Canonical (Ubuntu) 和 Red Hat（Red Hat Linux、Fedora、Centos）在内的多个行业领导者的首选桌面。</p>
<h3 id="准备">准备<a hidden class="anchor" aria-hidden="true" href="#准备">#</a></h3>
<p>从历史上看，Xorg 显示服务器是 Linux 上所有桌面环境的标准显示基础。对于 GNOME 3 及更高版本，已经开始转向更新的 Wayland 显示服务器协议。NVIDIA 以外的系统在 Wayland 上运行 GNOME 会话没有问题。</p>
<p>也就是说，退一步讲，最好先阅读并按照 <a href="https://wiki.gentoo.org/wiki/Xorg/Guide">Xorg 指南</a> 中设置 X 环境的说明。</p>
<p>根据 GNOME 上游的说法，GNOME 3 是用 systemd 初始化系统编写的。因此，systemd 用户最好从 <a href="https://wiki.gentoo.org/wiki/Systemd">systemd</a> 文章中阅读并遵守所有必要的内核设置。</p>
<h3 id="安装-4">安装<a hidden class="anchor" aria-hidden="true" href="#安装-4">#</a></h3>
<p>在安装 GNOME 套件之前，编辑系统的 USE 变量是个好主意。 Gentoo 开发人员提供了一个 GNOME 特定配置文件，以帮助对 GNOME 软件堆栈进行系统范围的调整。在安装 GNOME 之前选择最新且稳定的 GNOME 特定配置文件。</p>
<p>使用 logind 的 OpenRC 用户可以选择此特定配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect profile set default/linux/amd64/17.1/desktop/gnome</span>
</code></pre></div><p>systemd 用户将会选择以下 profile：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect profile set default/linux/amd64/17.1/desktop/gnome/systemd</span>
</code></pre></div><p>确保 X、gtk 和 gnome 位于 /etc/portage/make.conf 中的 USE 变量中。 建议启用对 D-Bus 系统范围的支持。 systemd 包括这个系统消息总线。 也将 systemd 添加到 USE 变量（D-Bus 是 GNOME 广泛使用的系统消息总线）。 如果不需要 KDE 支持，请从 USE 中删除 qt5 和 kde。 可以通过在它们前面添加减号 (-) 来删除 USE 标志。 有关正确使用的减号，请参见下面的示例。</p>
<pre tabindex="0"><code>USE=&quot;-qt5 -kde X gtk gnome systemd&quot;
</code></pre><p><strong>附注</strong>：当使用 <code>desktop/gnome</code> profile, 这些 USE flags将为你设置。</p>
<p>一旦完成,就由emerge GNOME来安装GNOME，安装一个完整的GNOME，它提供了所有你可能需要的额外的软件包：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask gnome-base/gnome</span>
</code></pre></div><p>“最小化”GNOME安装，该选项提供了一个轻量级的GNOME安装没有额外的工具</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask gnome-base/gnome-light</span>
</code></pre></div><p>这将需要一段时间，所以要开始阅读我们 wiki 中的其他部分。准备好了么？很好，现在更新环境变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># env-update &amp;&amp; source /etc/profile</span>
</code></pre></div><p>接下来剩余的服务和用户组将被清除。</p>
<p>验证 <code>plugdev</code> 组是否存在。如果是，建议让每个 GNOME 用户成为该组的成员，但这是可选的（该组不再常见）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># getent group plugdev</span>
plugdev❌104:
</code></pre></div><p>取代 <code>&lt;username&gt;</code> 为GNOME用户的用户名:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># gpasswd -a &lt;username&gt; plugdev</span>
</code></pre></div><h3 id="第一印象">第一印象<a hidden class="anchor" aria-hidden="true" href="#第一印象">#</a></h3>
<p>现在是时候看看什么是刚刚构建的。退出root 终端并以普通用户身份登录。下一步骤是配置会话管理器，使用GNOME<strong>startx</strong> 命令来调用(请看<a href="https://wiki.gentoo.org/wiki/Xorg/Guide#Using_startx">using startx</a> 在Xorg guide的更多信息)。</p>
<h4 id="启用-gdm">启用 GDM<a hidden class="anchor" aria-hidden="true" href="#启用-gdm">#</a></h4>
<p><strong>注</strong>：有关 GDM 故障排除的帮助可以在 <a href="https://wiki.gentoo.org/wiki/GNOME/GDM">GNOME/GDM</a> 文章中找到。</p>
<p><strong>systemd</strong></p>
<p>在引导时启动 GDM：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># systemctl enable gdm.service</span>
</code></pre></div><p>要立即启动 GDM，运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># systemctl start gdm.service</span>
</code></pre></div><p><strong>Tip</strong>：以下命令同时启用并立即启动 GDM：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># systemctl enable --now gdm.service</span>
</code></pre></div><p>另一个建议是<a href="https://wiki.gentoo.org/wiki/NetworkManager#systemd">激活 Network Manager</a>，以防没有其他网络管理服务被激活。</p>
<h4 id="使用-startx">使用 startx<a hidden class="anchor" aria-hidden="true" href="#使用-startx">#</a></h4>
<p>退出 root shell 并以普通用户身份登录。 下一步是配置会话管理器以在调用 startx 命令时运行 GNOME（有关更多信息，请参阅 Xorg 指南中的<a href="https://wiki.gentoo.org/wiki/Xorg/Guide#Using_startx">使用 startx</a>）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#34;exec gnome-session&#34; &gt; ~/.xinitrc</span>
</code></pre></div><p>从 gnome-base/gnome-session-2.26.2 开始，当使用 ~/.xinitrc 方法启动桌面时，用户需要预先添加 XDG_MENU_PREFIX 变量以获取 GNOME 菜单。如果 ~/.xinitrc 没有被使用，它将被自动处理；无需额外的配置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># sed -i &#39;1i\export XDG_MENU_PREFIX=gnome-&#39; ~/.xinitrc</span>
</code></pre></div><p>现在开始运行安装的图形环境<strong>startx</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># startx</span>
</code></pre></div><p>如果一切顺利GNOME，我们高兴的问候您。祝贺你成功设置GNOME!</p>
<h3 id="移除">移除<a hidden class="anchor" aria-hidden="true" href="#移除">#</a></h3>
<p>完全删除 GNOME 安装的一种可能方法是明确卸载 <a href="https://packages.gentoo.org/packages/gnome-base/gnome">gnome-base/gnome</a> 包，然后清除该包的依赖项。</p>
<p>为了做到这一点，请确保主 ebuild 存储库已同步：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --sync</span>
</code></pre></div><p>接下来，运行全局更新使系统是全新的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask --update --newuse --deep --with-bdeps=y @world</span>
</code></pre></div><p>卸载 GNOME 基础包：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask --depclean gnome-base/gnome</span>
</code></pre></div><p>最后，清理系统：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask --depclean</span>
</code></pre></div><p>GNOME 现已删除。</p>
<h3 id="tips-1">Tips<a hidden class="anchor" aria-hidden="true" href="#tips-1">#</a></h3>
<h4 id="how-can-i-reset-my-display-settings-through-terminalhttpsaskubuntucomquestions749333how-can-i-reset-my-display-settings-through-terminal"><a href="https://askubuntu.com/questions/749333/how-can-i-reset-my-display-settings-through-terminal">How can I reset my display settings through terminal?</a><a hidden class="anchor" aria-hidden="true" href="#how-can-i-reset-my-display-settings-through-terminalhttpsaskubuntucomquestions749333how-can-i-reset-my-display-settings-through-terminal">#</a></h4>
<p>Removing <code>~/.config/monitors.xml</code> should do it:</p>
<p>cfw 在gentoo下用不了，设置端口总为0；</p>
<p>clash 在gentoo下需要root权限，最好用 systemd service 运行。</p>
<h2 id="freebsd-handbook-zfshttpsdocsfreebsdorgzh-twbookshandbookzfs"><a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/">FreeBSD Handbook ZFS</a><a hidden class="anchor" aria-hidden="true" href="#freebsd-handbook-zfshttpsdocsfreebsdorgzh-twbookshandbookzfs">#</a></h2>
<p><em>Z 檔案系統</em> 或 ZFS 是設計來克服許多在以往設計中發現的主要問題的一個先進的檔案系統。</p>
<p>最初由 Sun™ 所開發，後來的開放源始碼 ZFS 開發已移到 <a href="http://open-zfs.org/">OpenZFS 計劃</a>。</p>
<p>ZFS 的設計目標主要有三個：</p>
<ul>
<li>資料完整性：所有資料都會有一個資料的校驗碼 (checksum)，資料寫入時會計算校驗碼然後一併寫入，往後讀取資料時會再計算一次校驗碼，若校驗碼與當初寫入時不相符，便可偵測到資料錯誤，此時若有可用的資料備援 (Data redundancy)，ZFS 會嘗試自動修正錯誤。</li>
<li>儲存池：實體的儲存裝置都會先被加入到一個儲存池 (Pool)，這個共用的儲存池可用來配置儲存空間，儲存池的空間可被所有的檔案系統使用且透過加入新的儲存裝置來增加空間。</li>
<li>效能：提供多個快取機制來增加效能。先進、以記憶體為基礎的讀取快取可使用 ARC。第二層以磁碟為基礎的讀取快取可使用 L2ARC，以磁碟為基礎的同步寫入快取則可使用 ZIL。</li>
</ul>
<p>完整的功能清單與術語在 [ZFS 特色與術語](#ZFS 特色與術語) 中有詳述。</p>
<h3 id="什麼使-zfs-與眾不同">什麼使 ZFS 與眾不同<a hidden class="anchor" aria-hidden="true" href="#什麼使-zfs-與眾不同">#</a></h3>
<p>ZFS 與以往任何的檔案系統有顯著的不同，因為它不只是一個檔案系統，ZFS 的獨特優點來自結合了以往被分開的磁碟區管理程式 (Volume Manager) 及檔案系統兩個角色，讓檔案系統也能夠察覺磁碟底層結構的變動。傳統在一個磁碟上只能建立一個檔案系統，若有兩個磁碟則會需要建立兩個分開的檔案系統，在傳統要解決這個問題要使用硬體 RAID 來製作一個空間實際上由數顆實體磁碟所組成的單一的邏輯磁碟給作業系統，作業系統便可在這個邏輯磁碟上放置檔案系統，即使是在那些使用 GEOM 提供的軟體 RAID 解決方案也是一樣，把 UFS 檔案系統放在 RAID Transform 上面當做是一個單一的裝置。ZFS 結合了磁碟區管理程式 (Volume Manager) 與檔案系統來解決這個問題並讓建立多個檔案系統可以共用一個儲存池 (Pool)。ZFS 最大的優點是可以察覺實體磁碟配置的變動，當有額外的磁碟加入到儲存池時可以自動擴增現有的檔案系統，所有的檔案系統便可使用這個新的空間。ZFS 也有數個不同的屬性可以套用到各別檔案系統上，比起單一檔案系統，對建立數個不同檔案系統與資料集 (Dataset) 時有許多的好處。</p>
<h3 id="快速入門指南">快速入門指南<a hidden class="anchor" aria-hidden="true" href="#快速入門指南">#</a></h3>
<p>這裡有一個啟動機制，可讓 FreeBSD 在系統初始化時掛載 ZFS 儲存池。要開啟這個功能，可加入此行到 <strong>/etc/rc.conf</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zfs_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YES&#34;</span>
</code></pre></div><p>然後啟動服務：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># service zfs start</span>
</code></pre></div><p>本節的例子會假設有三個 SCSI 磁碟，名稱分別為 <strong>da0</strong>, <strong>da1</strong> 及 <strong>da2</strong>。SATA 硬體的使用者裝置名稱改為 <strong>ada</strong> 。</p>
<h4 id="單磁碟儲存池">單磁碟儲存池<a hidden class="anchor" aria-hidden="true" href="#單磁碟儲存池">#</a></h4>
<p>要使用一個磁碟裝置建立一個簡單、無備援的儲存池可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool create example /dev/da0</span>
</code></pre></div><p>要檢視這個新的儲存池，可查看 <code>df</code> 的輸出結果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># df</span>
Filesystem  1K-blocks    Used    Avail Capacity  Mounted on
...
example      <span style="color:#ae81ff">17547136</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547136</span>     0%    /example
</code></pre></div><p>這個輸出結果說明 <code>example</code> 儲存池已建立且被掛載，現在已經可以作為檔案系統存取，可以在上面建立檔案且使用者可以瀏覽：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cd /example</span>
<span style="color:#75715e"># ls</span>
<span style="color:#75715e"># touch testfile</span>
<span style="color:#75715e"># ls -al</span>
total <span style="color:#ae81ff">4</span>
drwxr-xr-x   <span style="color:#ae81ff">2</span> root  wheel    <span style="color:#ae81ff">3</span> Aug <span style="color:#ae81ff">29</span> 23:15 .
drwxr-xr-x  <span style="color:#ae81ff">21</span> root  wheel  <span style="color:#ae81ff">512</span> Aug <span style="color:#ae81ff">29</span> 23:12 ..
-rw-r--r--   <span style="color:#ae81ff">1</span> root  wheel    <span style="color:#ae81ff">0</span> Aug <span style="color:#ae81ff">29</span> 23:15 testfile
</code></pre></div><p>但是，這個儲存池並未運用到任何 ZFS 功能，若要在這個儲存池上建立一個有開啟壓縮功能的資料集：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs create example/compressed</span>
<span style="color:#75715e"># zfs set compression=gzip example/compressed</span>
</code></pre></div><p><code>example/compressed</code> 資料集現在是一個 ZFS 壓縮的檔案系統，可以試著複製較大的檔案到 <strong>/example/compressed</strong>。</p>
<p>壓縮功能也可以使用以下指令關閉：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set compression=off example/compressed</span>
</code></pre></div><p>要卸載檔案系統，使用 <code>zfs umount</code> 然後再使用 <code>df</code> 確認：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs umount example/compressed</span>
<span style="color:#75715e"># df</span>
Filesystem  1K-blocks    Used    Avail Capacity  Mounted on
...
example      <span style="color:#ae81ff">17547008</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547008</span>     0%    /example
</code></pre></div><p>要重新掛載檔案系統以便再次使用，使用 <code>zfs mount</code> 然後以 <code>df</code> 檢查：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs mount example/compressed</span>
<span style="color:#75715e"># df</span>
Filesystem         1K-blocks    Used    Avail Capacity  Mounted on
...
example             <span style="color:#ae81ff">17547008</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547008</span>     0%    /example
example/compressed  <span style="color:#ae81ff">17547008</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547008</span>     0%    /example/compressed
</code></pre></div><p>儲存池與檔案系統也可以從 <code>mount</code> 的結果查詢到：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mount</span>
/dev/ad0s1a on / <span style="color:#f92672">(</span>ufs, local<span style="color:#f92672">)</span>
devfs on /dev <span style="color:#f92672">(</span>devfs, local<span style="color:#f92672">)</span>
/dev/ad0s1d on /usr <span style="color:#f92672">(</span>ufs, local, soft-updates<span style="color:#f92672">)</span>
example on /example <span style="color:#f92672">(</span>zfs, local<span style="color:#f92672">)</span>
example/compressed on /example/compressed <span style="color:#f92672">(</span>zfs, local<span style="color:#f92672">)</span>
</code></pre></div><p>在建立之後，ZFS 的資料集可如同其他檔案系統一般使用，且有許多額外功能可在每個資料集上設定。例如，建立一個預計存放重要的資料的新檔案系統 <code>data</code>，要設定每個資料區塊 (Data block) 要保留兩份備份：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs create example/data</span>
<span style="color:#75715e"># zfs set copies=2 example/data</span>
</code></pre></div><p>現在，可以使用 <code>df</code> 指令來查看資料與空間的使用率：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># df</span>
Filesystem         1K-blocks    Used    Avail Capacity  Mounted on
...
example             <span style="color:#ae81ff">17547008</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547008</span>     0%    /example
example/compressed  <span style="color:#ae81ff">17547008</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547008</span>     0%    /example/compressed
example/data        <span style="color:#ae81ff">17547008</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">17547008</span>     0%    /example/data
</code></pre></div><p>注意，從這個可以發現每個在儲存池上的檔案系統都擁有相同的可用空間，這是為什麼要在這些範例使用 <code>df</code> 的原因，為了要顯示檔案系統只會用它們所需要使用到的空間，且均取自同一個儲存池。ZFS 淘汰了磁碟區 (Volume) 與分割區 (Partition) 的概念，且允許多個檔案系統共用相同的儲存池。</p>
<p>不需要使用時可摧毀檔案系統後再摧毀儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs destroy example/compressed</span>
<span style="color:#75715e"># zfs destroy example/data</span>
<span style="color:#75715e"># zpool destroy example</span>
</code></pre></div><h4 id="raid-z">RAID-Z<a hidden class="anchor" aria-hidden="true" href="#raid-z">#</a></h4>
<p>磁碟損壞時，要避免資料因磁碟故障造成遺失便是使用 RAID。ZFS 在它的儲存池設計中支援了這項功能。RAID-Z 儲存池需要使用三個或更多的磁碟，但可以提供比鏡像 (Mirror) 儲存池更多的可用空間。</p>
<p>這個例子會建立一個 RAID-Z 儲存池，並指定要加入這個儲存池的磁碟：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool create storage raidz da0 da1 da2</span>
</code></pre></div><blockquote>
<p>Sun™ 建議用在 RAID-Z 設定的裝置數在三到九個之間。若需要由 10 個或更多磁碟組成單一儲存池的環境，可考慮分成較小的 RAID-Z 群組。若只有兩個可用的磁碟且需要做備援 (Redundancy)，可考慮使用 ZFS 鏡像 (Mirror)。請參考 <a href="https://www.freebsd.org/cgi/man.cgi?query=zpool&amp;sektion=8&amp;format=html">zpool(8)</a> 取得更多詳細資訊。</p>
</blockquote>
<p>先前的例子已經建立了 <code>storage</code> 儲存池 (zpool)，現在這個例子會在該儲存池中建立一個新的檔案系統，名稱為 <code>home</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs create storage/home</span>
</code></pre></div><p>可以設定開啟壓縮及保留目錄及檔案額外備份的功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set copies=2 storage/home</span>
<span style="color:#75715e"># zfs set compression=gzip storage/home</span>
</code></pre></div><p>要讓這個空間作為使用者的新家目錄位置，需複製使用者資料到這個目錄並建立適合的符號連結 (Symbolic link)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp -rp /home/* /storage/home</span>
<span style="color:#75715e"># rm -rf /home /usr/home</span>
<span style="color:#75715e"># ln -s /storage/home /home</span>
<span style="color:#75715e"># ln -s /storage/home /usr/home</span>
</code></pre></div><p>現在使用者的資料會儲存在新建立的 <strong>/storage/home</strong>，可以加入新使用者並登入該使用者來測試。</p>
<p>試著建立檔案系統快照 (Snapshot)，稍後可用來還原 (Rollback)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs snapshot storage/home@08-30-08</span>
</code></pre></div><p>快照只可以使用整個檔案系統製作，無法使用各別目錄或檔案。</p>
<p><code>@</code> 字元用來區隔檔案系統名稱 (File system) 或磁碟區 (Volume) 名稱，若有重要的目錄意外被刪除，檔案系統可以備份然後還原到先前目錄還存在時的快照 (Snapshot)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs rollback storage/home@08-30-08</span>
</code></pre></div><p>要列出所有可用的快照，可在檔案系統的 <strong>.zfs/snapshot</strong> 目錄執行 <code>ls</code>，舉例來說，要查看先前已做的快照：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ls /storage/home/.zfs/snapshot</span>
</code></pre></div><p>也可以寫一個 Script 來對使用者資料做例行性的快照，但隨著時間快照可能消耗大量的磁碟空間。先前的快照可以使用指令移除：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs destroy storage/home@08-30-08</span>
</code></pre></div><p>在測試之後，便可讓 <strong>/storage/home</strong> 成為真正的 <strong>/home</strong> 使用此指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set mountpoint=/home storage/home</span>
</code></pre></div><p>執行 <code>df</code> 興 <code>mount</code> 來確認系統現在是否以把檔案系統做為真正的 <strong>/home</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mount</span>
...
storage on /storage <span style="color:#f92672">(</span>zfs, local<span style="color:#f92672">)</span>
storage/home on /home <span style="color:#f92672">(</span>zfs, local<span style="color:#f92672">)</span>
<span style="color:#75715e"># df</span>
Filesystem   1K-blocks    Used    Avail Capacity  Mounted on
...
storage       <span style="color:#ae81ff">26320512</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">26320512</span>     0%    /storage
storage/home  <span style="color:#ae81ff">26320512</span>       <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">26320512</span>     0%    /home
</code></pre></div><p>這個動作完成 RAID-Z 最後的設定，有關已建立的檔案系統每日狀態更新可以做為 <a href="https://www.freebsd.org/cgi/man.cgi?query=periodic&amp;sektion=8&amp;format=html">periodic(8)</a> 的一部份在每天晚上執行。加入此行到 <strong>/etc/periodic.conf</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">daily_status_zfs_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YES&#34;</span>
</code></pre></div><h4 id="復原-raid-z">復原 RAID-Z<a hidden class="anchor" aria-hidden="true" href="#復原-raid-z">#</a></h4>
<p>每個軟體 RAID 都有監控其狀態 (<code>state</code>) 的方式，而 RAID-Z 裝置的狀態可以使用這個指令來查看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status -x</span>
</code></pre></div><p>如果所有儲存池為上線 (Online) 且正常，則訊息會顯示：</p>
<pre tabindex="0"><code>all pools are healthy
</code></pre><p>如果有發生問題，可能磁碟會呈現離線 (Offline) 的狀態，此時儲存池的狀態會是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">  pool: storage
 state: DEGRADED
status: One or more devices has been taken offline by the administrator.
	Sufficient replicas exist <span style="color:#66d9ef">for</span> the pool to <span style="color:#66d9ef">continue</span> functioning in a
	degraded state.
action: Online the device using <span style="color:#e6db74">&#39;zpool online&#39;</span> or replace the device with
	<span style="color:#e6db74">&#39;zpool replace&#39;</span>.
 scrub: none requested
config:

	NAME        STATE     READ WRITE CKSUM
	storage     DEGRADED     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	  raidz1    DEGRADED     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da1     OFFLINE      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da2     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>這代表著裝置在之前被管理者使用此指令拿下線：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool offline storage da1</span>
</code></pre></div><p>現在系統可以關機然後更換 <strong>da1</strong>，當系統恢復上線，則可以替換掉儲存池中故障的磁碟：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool replace storage da1</span>
</code></pre></div><p>到這裡，可以再檢查狀態一次，這時不需使用 <code>-x</code> 參數來顯示所有的儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status storage</span>
 pool: storage
 state: ONLINE
 scrub: resilver completed with <span style="color:#ae81ff">0</span> errors on Sat Aug <span style="color:#ae81ff">30</span> 19:44:11 <span style="color:#ae81ff">2008</span>
config:

	NAME        STATE     READ WRITE CKSUM
	storage     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	  raidz1    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da2     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>在這個例子中，所有的磁碟均已正常運作。</p>
<h4 id="資料檢驗">資料檢驗<a hidden class="anchor" aria-hidden="true" href="#資料檢驗">#</a></h4>
<p>ZFS 使用校驗碼 (Checksum) 來檢驗資料的完整性 (Integrity)，會在建立檔案系統時便自動開啟。</p>
<blockquote>
<p>校驗碼 (Checksum) 可以關閉，但並<em>不</em>建議！校驗碼只會使用非常少的儲存空間來確保資料的完整性。若關閉校驗碼會使許多 ZFS 功能無法正常運作，且關閉校驗碼對並不會明顯的改善效能。</p>
</blockquote>
<p>檢驗校驗碼這個動作即所謂的<em>清潔 (Scrub)</em>，可以使用以下指令來檢驗 <code>storage</code> 儲存池的資料完整性：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool scrub storage</span>
</code></pre></div><p>清潔所需要的時間依儲存的資料量而定，較大的資料量相對會需要花費較長的時間來檢驗。清潔會對 I/O 有非常密集的操作且一次只能進行一個清潔動作。在清潔完成之後，可以使用 <code>status</code> 來查看狀態：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status storage</span>
 pool: storage
 state: ONLINE
 scrub: scrub completed with <span style="color:#ae81ff">0</span> errors on Sat Jan <span style="color:#ae81ff">26</span> 19:57:37 <span style="color:#ae81ff">2013</span>
config:

	NAME        STATE     READ WRITE CKSUM
	storage     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	  raidz1    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    da2     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>查詢結果會顯示上次完成清潔的時間來協助追蹤是否要再做清潔。定期清潔可以協助保護資料不會默默損壞且確保儲存池的完整性。</p>
<p>請參考 <a href="https://www.freebsd.org/cgi/man.cgi?query=zfs&amp;sektion=8&amp;format=html">zfs(8)</a> 及 <a href="https://www.freebsd.org/cgi/man.cgi?query=zpool&amp;sektion=8&amp;format=html">zpool(8)</a> 來取得其他 ZFS 選項。</p>
<h3 id="zpool-管理"><code>zpool</code> 管理<a hidden class="anchor" aria-hidden="true" href="#zpool-管理">#</a></h3>
<p>ZFS 管理分成兩個主要的工具。<code>zpool</code> 工具用來控制儲存池的運作並可處理磁碟的新增、移除、更換與管理。[<code>zfs</code>](#<code>zfs</code> 管理) 工具用來建立、摧毀與管理檔案系統 (File system) 與磁碟區 (Volume) 的資料集。</p>
<h4 id="建立與摧毀儲存池">建立與摧毀儲存池<a hidden class="anchor" aria-hidden="true" href="#建立與摧毀儲存池">#</a></h4>
<p>建立 ZFS 儲存池 (<em>zpool</em>) 要做幾個涉及長遠規劃的決定，因為建立儲存池之後便無法再更改儲存池的結構。最重要的決定是要使用那一種型態的 vdev 來將實體磁碟設為同一群組。請參考 vdev 型態 的清單來取得有關可用選項的詳細資訊。大部份的 vdev 型態不允許在建立儲存池之後再加入額外的磁碟，鏡像 (Mirror) 是可以允許加入額外的磁碟到 vdev 的其中一個例外，另一個則是串連 (Stripe)，可以加入額外的磁碟到 vdev 來升級為鏡像。雖然可以加入額外的 vdev 來擴充儲存池，但儲存池的配置在建立之後便無法更改，若要要更改，則必須先備份資料，把儲存池摧毀後再重新建立。</p>
<p>建立一個簡單的鏡像儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool create mypool mirror /dev/ada1 /dev/ada2</span>
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>可以一次建立數個 vdev，磁碟群組間使用 vdev 型態關鍵字來區隔，在這個例子使用 <code>mirror</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool create mypool mirror /dev/ada1 /dev/ada2 mirror /dev/ada3 /dev/ada4</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-1  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada3    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada4    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>儲存池也可以不使用整個磁碟而改使用分割區 (Partition) 來建立。把 ZFS 放到不同的分割區可讓同一個磁碟有其他的分割區可做其他用途，尤其是有 Bootcode 與檔案系統要用來開機的分割區，這讓磁碟可以用來開機也同樣可以做為儲存池的一部份。在 FreeBSD 用分割區來替代整個磁碟並不會對效能有影響。使用分割區也讓管理者可以對磁碟容量做 <em>少算的預備</em>，使用比完整容量少的容量，未來若要替換的磁碟號稱與原磁碟相同，但實際上卻比較小時，也可符合這個較小的分割區容量，以使用替換的磁碟。</p>
<p>使用分割區建立一個 RAID-Z2 儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool create mypool raidz2 /dev/ada0p3 /dev/ada1p3 /dev/ada2p3 /dev/ada3p3 /dev/ada4p3 /dev/ada5p3</span>
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          raidz2-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada3p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada4p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada5p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>不需使用的儲存池可以摧毀，來讓磁碟可以再次使用。摧毀一個儲存池要先卸載所有該儲存池的資料集。若資料集在使用中，卸載的操作會失敗且儲存池不會被摧毀。儲存池的摧毀可以使用 <code>-f</code> 來強制執行，但這可能造成那些有開啟這些資料集之中檔案的應用程式無法辨識的行為。</p>
<h4 id="加入與移除裝置">加入與移除裝置<a hidden class="anchor" aria-hidden="true" href="#加入與移除裝置">#</a></h4>
<p>加入磁碟到儲存池 (zpool) 會有兩種情形：使用 <code>zpool attach</code> 加入一個磁碟到既有的 vdev，或使用 <code>zpool add</code> 加入 vdev 到儲存池。只有部份 vdev 型態 允許在 vdev 建立之後加入磁碟。</p>
<p>由單一磁碟所建立的儲存池缺乏備援 (Redundancy) 功能，可以偵測到資料的損壞但無法修復，因為資料沒有其他備份可用。備份數 (Copies) 屬性可以讓您從較小的故障中復原，如磁碟壞軌 (Bad sector)，但無法提供與鏡像或 RAID-Z 同樣層級的保護。由單一磁碟所建立的儲存池可以使用 <code>zpool attach</code> 來加入額外的磁碟到 vdev，來建立鏡像。<code>zpool attach</code> 也可用來加入額外的磁碟到鏡像群組，來增加備援與讀取效率。若使用的磁碟已有分割區，可以複製該磁碟的分割區配置到另一個，使用 <code>gpart backup</code> 與 <code>gpart restore</code> 可讓這件事變的很簡單。</p>
<p>加入 <em>ada1p3</em> 來升級單一磁碟串連 (stripe) vdev <em>ada0p3</em> 採用鏡像型態 (mirror)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          ada0p3    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool attach mypool ada0p3 ada1p3</span>
Make sure to wait <span style="color:#66d9ef">until</span> resilver is <span style="color:#66d9ef">done</span> before rebooting.

If you boot from pool <span style="color:#e6db74">&#39;mypool&#39;</span>, you may need to update
boot code on newly attached disk <span style="color:#e6db74">&#39;ada1p3&#39;</span>.

Assuming you use GPT partitioning and <span style="color:#e6db74">&#39;da0&#39;</span> is your new boot disk
you may use the following command:

        gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i <span style="color:#ae81ff">1</span> da0
<span style="color:#75715e"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1</span>
bootcode written to ada1
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
status: One or more devices is currently being resilvered.  The pool will
        <span style="color:#66d9ef">continue</span> to <span style="color:#66d9ef">function</span>, possibly in a degraded state.
action: Wait <span style="color:#66d9ef">for</span> the resilver to complete.
  scan: resilver in progress since Fri May <span style="color:#ae81ff">30</span> 08:19:19 <span style="color:#ae81ff">2014</span>
        527M scanned out of 781M at 47.9M/s, 0h0m to go
        527M resilvered, 67.53% <span style="color:#66d9ef">done</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>resilvering<span style="color:#f92672">)</span>

errors: No known data errors
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with <span style="color:#ae81ff">0</span> errors on Fri May <span style="color:#ae81ff">30</span> 08:15:58 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>若不想選擇加入磁碟到既有的 vdev ，對 RAID-Z 來說，可選擇另一種方式，便是加入另一個 vdev 到儲存池。額外的 vdev 可以提供更高的效能，分散寫入資料到 vdev 之間，每個 vdev 會負責自己的備援。也可以混合使用不同的 vdev 型態，但並不建議，例如混合使用 <code>mirror</code> 與 <code>RAID-Z</code>，加入一個無備援的 vdev 到一個含有 mirror 或 RAID-Z vdev 的儲存池會讓資料損壞的風險擴大整個儲存池，由於會分散寫入資料，若在無備援的磁碟上發生故障的結果便是遺失大半寫到儲存池的資料區塊。</p>
<p>在每個 vdev 間的資料是串連的，例如，有兩個 mirror vdev，便跟 RAID 10 一樣在兩個 mirror 間分散寫入資料，且會做空間的分配，因此 vdev 會在同時達到全滿 100% 的用量。若 vdev 間的可用空間量不同則會影響到效能，因為資料量會不成比例的寫入到使用量較少的 vdev。</p>
<p>當連接額外的裝置到一個可以開機的儲存池，要記得更新 Bootcode。</p>
<p>連接第二個 mirror 群組 (<strong>ada2p3</strong> 及 <strong>ada3p3</strong>) 到既有的 mirror：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with <span style="color:#ae81ff">0</span> errors on Fri May <span style="color:#ae81ff">30</span> 08:19:35 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool add mypool mirror ada2p3 ada3p3</span>
<span style="color:#75715e"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2</span>
bootcode written to ada2
<span style="color:#75715e"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada3</span>
bootcode written to ada3
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub repaired <span style="color:#ae81ff">0</span> in 0h0m with <span style="color:#ae81ff">0</span> errors on Fri May <span style="color:#ae81ff">30</span> 08:29:51 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-1  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada3p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>現在已無法從儲存池上移除 vdev，且磁碟只能夠在有足夠備援空間的情況下從 mirror 移除，若在 mirror 群組中只剩下一個磁碟，便會取消 mirror 然後還原為 stripe，若剩下的那個磁碟故障，便會影響到整個儲存池。</p>
<p>從一個三方 mirror 群組移除一個磁碟：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub repaired <span style="color:#ae81ff">0</span> in 0h0m with <span style="color:#ae81ff">0</span> errors on Fri May <span style="color:#ae81ff">30</span> 08:29:51 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool detach mypool ada2p3</span>
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub repaired <span style="color:#ae81ff">0</span> in 0h0m with <span style="color:#ae81ff">0</span> errors on Fri May <span style="color:#ae81ff">30</span> 08:29:51 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><h4 id="檢查儲存池狀態">檢查儲存池狀態<a hidden class="anchor" aria-hidden="true" href="#檢查儲存池狀態">#</a></h4>
<p>儲存池的狀態很重要，若有磁碟機離線或偵測到讀取、寫入或校驗碼 (Checksum) 錯誤，對應的錯誤計數便會增加。<code>status</code> 會顯示儲存池中每一個磁碟機的設定與狀態及整個儲存池的狀態。需要處置的方式與有關最近清潔 (<a href="#%E6%B8%85%E6%BD%94%E5%84%B2%E5%AD%98%E6%B1%A0"><code>Scrub</code></a>) 的詳細資訊也會一併顯示。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub repaired <span style="color:#ae81ff">0</span> in 2h25m with <span style="color:#ae81ff">0</span> errors on Sat Sep <span style="color:#ae81ff">14</span> 04:25:50 <span style="color:#ae81ff">2013</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          raidz2-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada3p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada4p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada5p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><h4 id="清除錯誤">清除錯誤<a hidden class="anchor" aria-hidden="true" href="#清除錯誤">#</a></h4>
<p>當偵測到錯誤發生，讀取、寫入或校驗碼 (Checksum) 的計數便會增加。使用 <code>zpool clear mypool</code> 可以清除錯誤訊息及重置計數。清空錯誤狀態對當儲存池發生錯誤要使用自動化 Script 通知的管理者來說會很重要，因在舊的錯誤尚未清除前不會回報後續的錯誤。</p>
<h4 id="更換運作中的裝置">更換運作中的裝置<a hidden class="anchor" aria-hidden="true" href="#更換運作中的裝置">#</a></h4>
<p>可能有一些情況會需要更換磁碟為另一個磁碟，當要更換運作中的磁碟，此程序會維持舊有的磁碟在更換的過程為上線的狀態，儲存池不會進入降級 (Degraded) 的狀態，來減少資料遺失的風險。<code>zpool replace</code> 會複製所有舊磁碟的資料到新磁碟，操作完成之後舊磁碟便會與 vdev 中斷連線。若新磁碟容量較舊磁碟大，也可以會增加儲存池來使用新的空間，請參考 <a href="#%E6%93%B4%E5%A2%9E%E5%84%B2%E5%AD%98%E6%B1%A0">擴增儲存池</a>。</p>
<p>更換儲存池中正在運作的狀置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool replace mypool ada1p3 ada2p3</span>
Make sure to wait <span style="color:#66d9ef">until</span> resilver is <span style="color:#66d9ef">done</span> before rebooting.

If you boot from pool <span style="color:#e6db74">&#39;zroot&#39;</span>, you may need to update
boot code on newly attached disk <span style="color:#e6db74">&#39;ada2p3&#39;</span>.

Assuming you use GPT partitioning and <span style="color:#e6db74">&#39;da0&#39;</span> is your new boot disk
you may use the following command:

        gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i <span style="color:#ae81ff">1</span> da0
<span style="color:#75715e"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2</span>
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
status: One or more devices is currently being resilvered.  The pool will
        <span style="color:#66d9ef">continue</span> to <span style="color:#66d9ef">function</span>, possibly in a degraded state.
action: Wait <span style="color:#66d9ef">for</span> the resilver to complete.
  scan: resilver in progress since Mon Jun  <span style="color:#ae81ff">2</span> 14:21:35 <span style="color:#ae81ff">2014</span>
        604M scanned out of 781M at 46.5M/s, 0h0m to go
        604M resilvered, 77.39% <span style="color:#66d9ef">done</span>
config:

        NAME             STATE     READ WRITE CKSUM
        mypool           ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0       ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3       ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            replacing-1  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
              ada1p3     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
              ada2p3     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>resilvering<span style="color:#f92672">)</span>

errors: No known data errors
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with <span style="color:#ae81ff">0</span> errors on Mon Jun  <span style="color:#ae81ff">2</span> 14:21:52 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><h4 id="處理故障裝置">處理故障裝置<a hidden class="anchor" aria-hidden="true" href="#處理故障裝置">#</a></h4>
<p>當儲存池中的磁碟故障，該故障硬碟所屬的 vdev 便會進入降級 (Degraded) 狀態，所有的資料仍可使用，但效能可能會降低，因為遺失的資料必須從可用的備援資料計算才能取得。要將 vdev 恢復完整運作的狀態必須更換故障的實體裝置。然後 ZFS 便會開始修復 (Resilver，古代鏡子的修復稱 Resilver) 作業，會從可用的備援資料計算出故障磁碟中的資料並寫入到替換的裝置上。完成後 vdev 便會重新返回上線 (Online) 的狀態。</p>
<p>若 vdev 沒有任何備援資料或有多個裝置故障，沒有足夠的備援資料可以補償，儲存池便會進入故障 (Faulted) 的狀態。</p>
<p>更換故障的磁碟時，故障磁碟的名稱會更換為裝置的 GUID，若替換裝置要使用相同的裝置名稱，則在 <code>zpool replace</code> 不須加上新裝置名稱參數。</p>
<p>使用 <code>zpool replace</code> 更換故障的磁碟：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: DEGRADED
status: One or more devices could not be opened.  Sufficient replicas exist <span style="color:#66d9ef">for</span>
        the pool to <span style="color:#66d9ef">continue</span> functioning in a degraded state.
action: Attach the missing device and online it using <span style="color:#e6db74">&#39;zpool online&#39;</span>.
   see: http://illumos.org/msg/ZFS-8000-2Q
  scan: none requested
config:

        NAME                    STATE     READ WRITE CKSUM
        mypool                  DEGRADED     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0              DEGRADED     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3              ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            <span style="color:#ae81ff">316502962686821739</span>  UNAVAIL      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  was /dev/ada1p3

errors: No known data errors
<span style="color:#75715e"># zpool replace mypool 316502962686821739 ada2p3</span>
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: DEGRADED
status: One or more devices is currently being resilvered.  The pool will
        <span style="color:#66d9ef">continue</span> to <span style="color:#66d9ef">function</span>, possibly in a degraded state.
action: Wait <span style="color:#66d9ef">for</span> the resilver to complete.
  scan: resilver in progress since Mon Jun  <span style="color:#ae81ff">2</span> 14:52:21 <span style="color:#ae81ff">2014</span>
        641M scanned out of 781M at 49.3M/s, 0h0m to go
        640M resilvered, 82.04% <span style="color:#66d9ef">done</span>
config:

        NAME                        STATE     READ WRITE CKSUM
        mypool                      DEGRADED     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0                  DEGRADED     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3                  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            replacing-1             UNAVAIL      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
              <span style="color:#ae81ff">15732067398082357289</span>  UNAVAIL      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  was /dev/ada1p3/old
              ada2p3                ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>resilvering<span style="color:#f92672">)</span>

errors: No known data errors
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with <span style="color:#ae81ff">0</span> errors on Mon Jun  <span style="color:#ae81ff">2</span> 14:52:38 <span style="color:#ae81ff">2014</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><h4 id="清潔儲存池">清潔儲存池<a hidden class="anchor" aria-hidden="true" href="#清潔儲存池">#</a></h4>
<p>建議儲存池要定期清潔 (Scrub)，最好是每一個月清潔一次。 <code>scrub</code> 作業對磁碟操作非常的密集，在執行時會降低磁碟的效能。在排程 <code>scrub</code> 時避免在使用高峰的時期，或使用 <code>vfs.zfs.scrub_delay</code> 來調整 <code>scrub</code> 的相對優先權來避免影響其他的工作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool scrub mypool</span>
<span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub in progress since Wed Feb <span style="color:#ae81ff">19</span> 20:52:54 <span style="color:#ae81ff">2014</span>
        116G scanned out of 8.60T at 649M/s, 3h48m to go
        <span style="color:#ae81ff">0</span> repaired, 1.32% <span style="color:#66d9ef">done</span>
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          raidz2-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada0p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada1p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada2p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada3p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada4p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
            ada5p3  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>若發生需要取消清潔作業的事，可以下 <code>zpool scrub -s mypool</code>。</p>
<h4 id="自我修復">自我修復<a hidden class="anchor" aria-hidden="true" href="#自我修復">#</a></h4>
<p>校驗碼 (Checksum) 會隨資料區塊一併儲存，這使得檔案系統可以做到<em>自我修復</em>。這個功能可以在校驗碼與儲存池中的另一個裝置不同時自動修復資料。舉例來說，有兩個磁碟做鏡像 (Mirror)，其中一個磁碟機開始失常並無法正常儲存資料，甚至是資料放在長期封存的儲存裝置上，已經很久沒有被存取。傳統的檔案系統需要執行演算法來檢查並修復資料如 <a href="https://www.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a>，這些指令耗費時間，且在嚴重時需要管理者手動決定要做那一種修復操作。當 ZFS 偵測到資料區塊的校驗碼不對時，它除了把資料交給需要的應用程式外，也會修正在磁碟上錯誤的資料。這件事不需要與系統管理者作任何互動便會在一般的儲存池操作時完成。</p>
<p>接下來的例子會示範自我修復會如何運作。建立一個使用磁碟 <strong>/dev/ada0</strong> 及 <strong>/dev/ada1</strong> 做鏡像的儲存池。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool create healer mirror /dev/ada0 /dev/ada1</span>
<span style="color:#75715e"># zpool status healer</span>
  pool: healer
 state: ONLINE
  scan: none requested
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
      mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool list</span>
NAME     SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG   CAP  DEDUP  HEALTH  ALTROOT
healer   960M  92.5K   960M         -         -     0%    0%  1.00x  ONLINE  -
</code></pre></div><p>將部份需要使用自我修復功能來保護的重要資料複製到該儲存池，建立一個儲存池的校驗碼供稍後做比較時使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /some/important/data /healer</span>
<span style="color:#75715e"># zfs list</span>
NAME     SIZE  ALLOC   FREE    CAP  DEDUP  HEALTH  ALTROOT
healer   960M  67.7M   892M     7%  1.00x  ONLINE  -
<span style="color:#75715e"># sha1 /healer &gt; checksum.txt</span>
<span style="color:#75715e"># cat checksum.txt</span>
SHA1 <span style="color:#f92672">(</span>/healer<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 2753eff56d77d9a536ece6694bf0a82740344d1f
</code></pre></div><p>寫入隨機的資料到鏡像的第一個磁碟來模擬資料損毀的情況。要避免 ZFS 偵測到錯誤時馬上做修復，接著要將儲存池匯出，待模擬資料損毀之後再匯入。</p>
<blockquote>
<p>這是一個危險的操作，會破壞重要的資料。在這裡使用僅為了示範用，不應在儲存池正常運作時嘗試使用，也不應將這個故意損壞資料的例子用在任何其他的檔案系統上，所以請勿使用任何不屬於該儲存池的其他磁碟裝置名稱並確定在執行指令前已對儲存池做正確的備份！</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool export healer</span>
<span style="color:#75715e"># dd if=/dev/random of=/dev/ada1 bs=1m count=200</span>
200+0 records in
200+0 records out
<span style="color:#ae81ff">209715200</span> bytes transferred in 62.992162 secs <span style="color:#f92672">(</span><span style="color:#ae81ff">3329227</span> bytes/sec<span style="color:#f92672">)</span>
<span style="color:#75715e"># zpool import healer</span>
</code></pre></div><p>儲存池的狀態顯示有一個裝置發生了錯誤。注意，應用程式從儲存池讀取的資料中並沒有任何的錯誤資料，ZFS 會自 <strong>ada0</strong> 裝置提供有正確校驗碼的資料。結果裡面 <code>CKSUM</code> 欄位含有非零值便是有錯誤校驗碼的裝置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status healer</span>
    pool: healer
   state: ONLINE
  status: One or more devices has experienced an unrecoverable error.  An
          attempt was made to correct the error.  Applications are unaffected.
  action: Determine <span style="color:#66d9ef">if</span> the device needs to be replaced, and clear the errors
          using <span style="color:#e6db74">&#39;zpool clear&#39;</span> or replace the device with <span style="color:#e6db74">&#39;zpool replace&#39;</span>.
     see: http://illumos.org/msg/ZFS-8000-4J
    scan: none requested
  config:

      NAME        STATE     READ WRITE CKSUM
      healer      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
        mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
         ada0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
         ada1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">1</span>

errors: No known data errors
</code></pre></div><p>錯誤已經被偵測到並且由未被影響的 <strong>ada0</strong> 鏡像磁碟上的備援提供資料。可與原來的校驗碼做比較來看儲存池是否已修復為一致。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># sha1 /healer &gt;&gt; checksum.txt</span>
<span style="color:#75715e"># cat checksum.txt</span>
SHA1 <span style="color:#f92672">(</span>/healer<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 2753eff56d77d9a536ece6694bf0a82740344d1f
SHA1 <span style="color:#f92672">(</span>/healer<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 2753eff56d77d9a536ece6694bf0a82740344d1f
</code></pre></div><p>儲存池在故意竄改資料前與後的兩個校驗碼仍相符顯示了 ZFS 在校驗碼不同時偵測與自動修正錯誤的能力。注意，這只在當儲存池中有足夠的備援時才可做到，由單一裝置組成的儲存池並沒有自我修復的能力。這也是為什麼在 ZFS 中校驗碼如此重要，任何原因都不該關閉。不需要 <a href="https://www.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a> 或類似的檔案系統一致性檢查程式便能夠偵測與修正問題，且儲存儲存池在發生問題時仍可正常運作。接著需要做清潔作業來覆蓋在 <strong>ada1</strong> 上的錯誤資料。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool scrub healer</span>
<span style="color:#75715e"># zpool status healer</span>
  pool: healer
 state: ONLINE
status: One or more devices has experienced an unrecoverable error.  An
            attempt was made to correct the error.  Applications are unaffected.
action: Determine <span style="color:#66d9ef">if</span> the device needs to be replaced, and clear the errors
            using <span style="color:#e6db74">&#39;zpool clear&#39;</span> or replace the device with <span style="color:#e6db74">&#39;zpool replace&#39;</span>.
   see: http://illumos.org/msg/ZFS-8000-4J
  scan: scrub in progress since Mon Dec <span style="color:#ae81ff">10</span> 12:23:30 <span style="color:#ae81ff">2012</span>
        10.4M scanned out of 67.0M at 267K/s, 0h3m to go
        9.63M repaired, 15.56% <span style="color:#66d9ef">done</span>
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
      mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">627</span>  <span style="color:#f92672">(</span>repairing<span style="color:#f92672">)</span>

errors: No known data errors
</code></pre></div><p>清潔作業會從 <strong>ada0</strong> 讀取資料並重新寫入任何在 <strong>ada1</strong> 上有錯誤校驗碼的資料。這個操作可以由 <code>zpool status</code> 的輸出中呈現修復中 <code>(repairing)</code> 的項目來辨識。這個作業完成後，儲存池的狀態會更改為：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status healer</span>
  pool: healer
 state: ONLINE
status: One or more devices has experienced an unrecoverable error.  An
        attempt was made to correct the error.  Applications are unaffected.
action: Determine <span style="color:#66d9ef">if</span> the device needs to be replaced, and clear the errors
             using <span style="color:#e6db74">&#39;zpool clear&#39;</span> or replace the device with <span style="color:#e6db74">&#39;zpool replace&#39;</span>.
   see: http://illumos.org/msg/ZFS-8000-4J
  scan: scrub repaired 66.5M in 0h2m with <span style="color:#ae81ff">0</span> errors on Mon Dec <span style="color:#ae81ff">10</span> 12:26:25 <span style="color:#ae81ff">2012</span>
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
      mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> 2.72K

errors: No known data errors
</code></pre></div><p>清潔操作完成便同步了 <strong>ada0</strong> 到 <strong>ada1</strong> 間的所有資料。執行 <code>zpool clear</code> 可以清除 (<a href="#%E6%B8%85%E9%99%A4%E9%8C%AF%E8%AA%A4">Clear</a>) 儲存池狀態的錯誤訊息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool clear healer</span>
<span style="color:#75715e"># zpool status healer</span>
  pool: healer
 state: ONLINE
  scan: scrub repaired 66.5M in 0h2m with <span style="color:#ae81ff">0</span> errors on Mon Dec <span style="color:#ae81ff">10</span> 12:26:25 <span style="color:#ae81ff">2012</span>
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
      mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada0     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
       ada1     ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
</code></pre></div><p>儲存池現在恢復完整運作的狀態且清除所有的錯誤了。</p>
<h4 id="擴增儲存池">擴增儲存池<a hidden class="anchor" aria-hidden="true" href="#擴增儲存池">#</a></h4>
<p>可用的備援儲存池大小會受到每個 vdev 中容量最小的裝置限制。最小的裝置可以替換成較大的裝置，在更換 (Replace) 或修復 (Resilver) 作業後，儲存池可以成長到該新裝置的可用容量。例如，要做一個 1 TB 磁碟機與一個 2 TB 磁碟機的鏡像，可用的空間會是 1 TB，當 1 TB 磁碟機備更換成另一個 2 TB 的磁碟機時，修復程序會複製既有的資料到新的磁碟機，由於現在兩個裝置都有 2 TB 的容量，所以鏡像的可用空間便會成長到 2 TB。</p>
<p>可以在每個裝置用 <code>zpool online -e</code> 來觸發擴充的動作，在擴充完所有裝置後，儲存池便可使用額外的空間。</p>
<h4 id="匯入與匯出儲存池">匯入與匯出儲存池<a hidden class="anchor" aria-hidden="true" href="#匯入與匯出儲存池">#</a></h4>
<p>儲存池在移動到其他系統之前需要做匯出 (<em>Export</em>)，會卸載所有的資料集，然後標記每個裝置為已匯出，為了避免被其他磁碟子系統存取，因此仍會鎖定這些裝置。這個動作讓儲存池可以在支援 ZFS 的其他機器、其他作業系統做匯入 (<em>Import</em>)，甚至是不同的硬體架構 (有一些注意事項，請參考 <a href="https://www.freebsd.org/cgi/man.cgi?query=zpool&amp;sektion=8&amp;format=html">zpool(8)</a>)。當資料集有被開啟的檔案，可使用 <code>zpool export -f</code> 來強制匯出儲存池，使用這個指令需要小心，資料集是被強制卸載的，因此有可能造成在該資料集開啟檔案的應用程式發生無法預期的結果。</p>
<p>匯出未使用的儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool export mypool</span>
</code></pre></div><p>匯入儲存池會自動掛載資料集，若不想自動掛載，可以使用 <code>zpool import -N</code>。<code>zpool import -o</code> 可以設定在匯入時暫時使用的屬性。<code>zpool import altroot=</code> 允許匯入時指定基礎掛載點 (Base mount point) 來替換檔案系統根目錄。若儲存池先前用在不同的系統且不正常匯出，可能會需要使用 <code>zpool import -f</code> 來強制匯入。<code>zpool import -a</code> 會匯入所有沒有被其他系統使用的儲存池。</p>
<p>列出所有可以匯入的儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool import</span>
   pool: mypool
     id: <span style="color:#ae81ff">9930174748043525076</span>
  state: ONLINE
 action: The pool can be imported using its name or numeric identifier.
 config:

        mypool      ONLINE
          ada2p3    ONLINE
</code></pre></div><p>使用替代的根目錄匯入儲存池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool import -o altroot=/mnt mypool</span>
<span style="color:#75715e"># zfs list</span>
zfs list
NAME                 USED  AVAIL  REFER  MOUNTPOINT
mypool               110K  47.0G    31K  /mnt/mypool
</code></pre></div><h4 id="升級儲存儲存池">升級儲存儲存池<a hidden class="anchor" aria-hidden="true" href="#升級儲存儲存池">#</a></h4>
<p>在升級 FreeBSD 之後或儲存池是由其他使用舊版 ZFS 的系統匯入，儲存池可以手動升級到最新版本的 ZFS 來支援新的功能。在升級前請評估儲存池是否還要在舊的系統做匯入，由於升級是一個單向的程序，舊的儲存池可以升級，但有新功能的儲存池無法降級。</p>
<p>升級一個 v28 的儲存以支援功能旗標 (<code>Feature Flags</code>)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
status: The pool is formatted using a legacy on-disk format.  The pool can
        still be used, but some features are unavailable.
action: Upgrade the pool using <span style="color:#e6db74">&#39;zpool upgrade&#39;</span>.  Once this is <span style="color:#66d9ef">done</span>, the
        pool will no longer be accessible on software that does not support feat
        flags.
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    ada0    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    ada1    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool upgrade</span>
This system supports ZFS pool feature flags.

The following pools are formatted with legacy version numbers and can
be upgraded to use feature flags.  After being upgraded, these pools
will no longer be accessible by software that does not support feature
flags.

VER  POOL
---  ------------
<span style="color:#ae81ff">28</span>   mypool

Use <span style="color:#e6db74">&#39;zpool upgrade -v&#39;</span> <span style="color:#66d9ef">for</span> a list of available legacy versions.
Every feature flags pool has all supported features enabled.
<span style="color:#75715e"># zpool upgrade mypool</span>
This system supports ZFS pool feature flags.

Successfully upgraded <span style="color:#e6db74">&#39;mypool&#39;</span> from version <span style="color:#ae81ff">28</span> to feature flags.
Enabled the following features on <span style="color:#e6db74">&#39;mypool&#39;</span>:
  async_destroy
  empty_bpobj
  lz4_compress
  multi_vdev_crash_dump
</code></pre></div><p>ZFS 的新功能在 <code>zpool upgrade</code> 尚未完成之前無法使用。可以用 <code>zpool upgrade -v</code> 來查看升級後有那些新功能，也同時會列出已經支援那些功能。</p>
<p>升級儲存池支援新版的功能旗標 (Feature flags)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool status</span>
  pool: mypool
 state: ONLINE
status: Some supported features are not enabled on the pool. The pool can
        still be used, but some features are unavailable.
action: Enable all features using <span style="color:#e6db74">&#39;zpool upgrade&#39;</span>. Once this is <span style="color:#66d9ef">done</span>,
        the pool may no longer be accessible by software that does not support
        the features. See zpool-features<span style="color:#f92672">(</span>7<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> details.
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
          mirror-0  ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    ada0    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>
	    ada1    ONLINE       <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>

errors: No known data errors
<span style="color:#75715e"># zpool upgrade</span>
This system supports ZFS pool feature flags.

All pools are formatted using feature flags.

Some supported features are not enabled on the following pools. Once a
feature is enabled the pool may become incompatible with software
that does not support the feature. See zpool-features<span style="color:#f92672">(</span>7<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> details.

POOL  FEATURE
---------------
zstore
      multi_vdev_crash_dump
      spacemap_histogram
      enabled_txg
      hole_birth
      extensible_dataset
      bookmarks
      filesystem_limits
<span style="color:#75715e"># zpool upgrade mypool</span>
This system supports ZFS pool feature flags.

Enabled the following features on <span style="color:#e6db74">&#39;mypool&#39;</span>:
  spacemap_histogram
  enabled_txg
  hole_birth
  extensible_dataset
  bookmarks
  filesystem_limits
</code></pre></div><blockquote>
<p>在使用儲存池來開機的系統上的 Boot code 也必須一併更新來支援新的儲存池版本，可在含有 Boot code 的分割區使用 <code>gpart bootcode</code> 來更新。目前有兩種 Boot code 可使用，需視系統開機的方式使用：GPT (最常用的選項) 以及 EFI (較新的系統)。針對傳統使用 GPT 開機的系統，可以使用以下指令：<code># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1</code>針對使用 EFI 開機的系統可以執行以下指令：<code># gpart bootcode -p /boot/boot1.efifat -i 1 ada1</code>套用 Boot code 到所有儲存池中可開機的磁碟。請參考 <a href="https://www.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a> 以取得更多資訊。</p>
</blockquote>
<h4 id="顯示已記錄的儲存池歷史日誌">顯示已記錄的儲存池歷史日誌<a hidden class="anchor" aria-hidden="true" href="#顯示已記錄的儲存池歷史日誌">#</a></h4>
<p>修改儲存池的指令會被記錄下來，會記錄的動作包含資料集的建立，屬性更改或更換磁碟。這個歷史記錄用來查看儲存池是如何建立、由誰執行、什麼動作及何時。歷史記錄並非儲存在日誌檔 (Log file)，而是儲存在儲存池。查看這個歷史記錄的指令名稱為 <code>zpool history</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool history</span>
History <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;tank&#39;</span>:
2013-02-26.23:02:35 zpool create tank mirror /dev/ada0 /dev/ada1
2013-02-27.18:50:58 zfs set atime<span style="color:#f92672">=</span>off tank
2013-02-27.18:51:09 zfs set checksum<span style="color:#f92672">=</span>fletcher4 tank
2013-02-27.18:51:18 zfs create tank/backup
</code></pre></div><p>輸出結果顯示曾在該儲存池上執行的 <code>zpool</code> 與 <code>zfs</code> 指令以及時間戳記。只有會修改儲存池或類似的指令會被記錄下來，像是 <code>zfs list</code> 這種指令並不會被記錄。當不指定儲存池名稱時，會列出所有儲存池的歷史記錄。</p>
<p>在提供選項 <code>-i</code> 或 <code>-l</code> 時 <code>zpool history</code> 可以顯更多詳細資訊。<code>-i</code> 會顯示使用者觸發的事件外，也會顯示內部記錄的 ZFS 事件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool history -i</span>
History <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;tank&#39;</span>:
2013-02-26.23:02:35 <span style="color:#f92672">[</span>internal pool create txg:5<span style="color:#f92672">]</span> pool spa 28; zfs spa 28; zpl 5;uts  9.1-RELEASE <span style="color:#ae81ff">901000</span> amd64
2013-02-27.18:50:53 <span style="color:#f92672">[</span>internal property set txg:50<span style="color:#f92672">]</span> atime<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> dataset <span style="color:#f92672">=</span> <span style="color:#ae81ff">21</span>
2013-02-27.18:50:58 zfs set atime<span style="color:#f92672">=</span>off tank
2013-02-27.18:51:04 <span style="color:#f92672">[</span>internal property set txg:53<span style="color:#f92672">]</span> checksum<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> dataset <span style="color:#f92672">=</span> <span style="color:#ae81ff">21</span>
2013-02-27.18:51:09 zfs set checksum<span style="color:#f92672">=</span>fletcher4 tank
2013-02-27.18:51:13 <span style="color:#f92672">[</span>internal create txg:55<span style="color:#f92672">]</span> dataset <span style="color:#f92672">=</span> <span style="color:#ae81ff">39</span>
2013-02-27.18:51:18 zfs create tank/backup
</code></pre></div><p>更多詳細的資訊可加上 <code>-l</code> 來取得，歷史記錄會以較長的格式顯示，包含的資訊有執行指令的使用者名稱、主機名稱以及更改的項目。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool history -l</span>
History <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;tank&#39;</span>:
2013-02-26.23:02:35 zpool create tank mirror /dev/ada0 /dev/ada1 <span style="color:#f92672">[</span>user <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> on :global<span style="color:#f92672">]</span>
2013-02-27.18:50:58 zfs set atime<span style="color:#f92672">=</span>off tank <span style="color:#f92672">[</span>user <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> on myzfsbox:global<span style="color:#f92672">]</span>
2013-02-27.18:51:09 zfs set checksum<span style="color:#f92672">=</span>fletcher4 tank <span style="color:#f92672">[</span>user <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> on myzfsbox:global<span style="color:#f92672">]</span>
2013-02-27.18:51:18 zfs create tank/backup <span style="color:#f92672">[</span>user <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> on myzfsbox:global<span style="color:#f92672">]</span>
</code></pre></div><p>輸出結果顯示 <code>root</code> 使用者使用 <strong>/dev/ada0</strong> 及 <strong>/dev/ada1</strong> 建立鏡像的儲存池。主機名稱 <code>myzfsbox</code> 在建立完儲存池後也同樣會顯示。由於儲存池可以從一個系統匯出再匯入到另一個系統，因此主機名稱也很重要，這樣一來可以清楚的辦識在其他系統上執行的每一個指令的主機名稱。</p>
<p>兩個 <code>zpool history</code> 選項可以合併使用來取得最完整的儲存池詳細資訊。儲存池歷史記錄在追蹤執行什麼動作或要取得除錯所需的輸出結果提供了非常有用的資訊。</p>
<h4 id="監視效能">監視效能<a hidden class="anchor" aria-hidden="true" href="#監視效能">#</a></h4>
<p>內建的監視系統可以即時顯示儲存池的 I/O 統計資訊。它會顯示儲存池剩餘的空間與使用的空間，每秒執行了多少讀取與寫入的操作，有多少 I/O 頻寬被使用。預設會監視所有在系統中的儲存池都並顯示出來，可以提供儲存池名稱來只顯示該儲存池的監視資訊。舉一個簡單的例子：</p>
<pre tabindex="0"><code># zpool iostat
               capacity     operations    bandwidth
pool        alloc   free   read  write   read  write
----------  -----  -----  -----  -----  -----  -----
data         288G  1.53T      2     11  11.3K  57.1K
</code></pre><p>要持續監視 I/O 的活動可以在最後的參數指定一個數字，這個數字代表每次更新資訊所間隔的秒數。在每次經過間隔的時間後會列出新一行的統計資訊，按下 Ctrl+C 可以中止監視。或者在指令列的間隔時間之後再指定一個數字，代表總共要顯示的統計資訊筆數。</p>
<p>使用 <code>-v</code> 可以顯示更詳細的 I/O 統計資訊。每個在儲存池中的裝置會以一行統計資訊顯示。這可以幫助了解每一個裝置做了多少讀取與寫入的操作，並可協助確認是否有各別裝置拖慢了整個儲存池的速度。以下範例會顯示有兩個裝置的鏡像儲存池：</p>
<pre tabindex="0"><code># zpool iostat -v
                            capacity     operations    bandwidth
pool                     alloc   free   read  write   read  write
-----------------------  -----  -----  -----  -----  -----  -----
data                      288G  1.53T      2     12  9.23K  61.5K
  mirror                  288G  1.53T      2     12  9.23K  61.5K
    ada1                     -      -      0      4  5.61K  61.7K
    ada2                     -      -      1      4  5.04K  61.7K
-----------------------  -----  -----  -----  -----  -----  -----
</code></pre><h4 id="分割儲存儲存池">分割儲存儲存池<a hidden class="anchor" aria-hidden="true" href="#分割儲存儲存池">#</a></h4>
<p>由一個或多個鏡像 vdev 所組成的儲存池可以切分開成兩個儲存池。除非有另外指定，否則每個鏡像的最後一個成員會被分離，用來建立一個含有相同資料的新儲存池。在做這個操作的第一次應先使用 <code>-n</code>，會顯示預計會做的操作而不會真的執行，這可以協助確認操作是否與使用者所要的相同。</p>
<h3 id="zfs-管理"><code>zfs</code> 管理<a hidden class="anchor" aria-hidden="true" href="#zfs-管理">#</a></h3>
<p><code>zfs</code> 工具負責建立、摧毀與管理在一個儲存池中所有的 ZFS 資料集。儲存池使用 [<code>zpool</code>](#<code>zpool</code> 管理) 來管理。</p>
<h4 id="建立與摧毀資料集">建立與摧毀資料集<a hidden class="anchor" aria-hidden="true" href="#建立與摧毀資料集">#</a></h4>
<p>不同於傳統的磁碟與磁碟區管理程式 (Volume manager) ，在 ZFS 中的空間並<em>不</em>會預先分配。傳統的檔案系統在分割與分配空間完後，若沒有增加新的磁碟便無法再增加額外的檔案系統。在 ZFS，可以隨時建立新的檔案系統，每個資料集 (<em>Dataset</em>) 都有自己的屬性，包含壓縮 (Compression)、去重複 (Deduplication)、快取 (Caching) 與配額 (Quota) 功能以及其他有用的屬性如唯讀 (Readonly)、區分大小寫 (Case sensitivity)、網路檔案分享 (Network file sharing) 以及掛載點 (Mount point)。資料集可以存在於其他資料集中，且子資料集會繼承其父資料集的屬性。每個資料集都可以作為一個單位來管理、委託 (<a href="#%E5%A7%94%E8%A8%97%E7%AE%A1%E7%90%86">Delegate</a>)、備份 (<a href="#%E5%82%99%E4%BB%BD" title="Replication">Replicate</a>)、快照 (<a href="#%E7%AE%A1%E7%90%86%E5%BF%AB%E7%85%A7" title="Snapshot">Snapshot</a>)、監禁 ([Jail](#ZFS 與 Jail)) 與摧毀 (Destroy)，替每種不同類型或集合的檔案建立各別的資料集還有許多的好處。唯一的缺點是在當有非常大數量的資料集時，部份指令例如 <code>zfs list</code> 會變的較緩慢，且掛載上百個或其至上千個資料集可能會使 FreeBSD 的開機程序變慢。</p>
<p>建立一個新資料集並開啟 LZ4 壓縮：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list</span>
NAME                  USED  AVAIL  REFER  MOUNTPOINT
mypool                781M  93.2G   144K  none
mypool/ROOT           777M  93.2G   144K  none
mypool/ROOT/default   777M  93.2G   777M  /
mypool/tmp            176K  93.2G   176K  /tmp
mypool/usr            616K  93.2G   144K  /usr
mypool/usr/home       184K  93.2G   184K  /usr/home
mypool/usr/ports      144K  93.2G   144K  /usr/ports
mypool/usr/src        144K  93.2G   144K  /usr/src
mypool/var           1.20M  93.2G   608K  /var
mypool/var/crash      148K  93.2G   148K  /var/crash
mypool/var/log        178K  93.2G   178K  /var/log
mypool/var/mail       144K  93.2G   144K  /var/mail
mypool/var/tmp        152K  93.2G   152K  /var/tmp
<span style="color:#75715e"># zfs create -o compress=lz4 mypool/usr/mydataset</span>
<span style="color:#75715e"># zfs list</span>
NAME                   USED  AVAIL  REFER  MOUNTPOINT
mypool                 781M  93.2G   144K  none
mypool/ROOT            777M  93.2G   144K  none
mypool/ROOT/default    777M  93.2G   777M  /
mypool/tmp             176K  93.2G   176K  /tmp
mypool/usr             704K  93.2G   144K  /usr
mypool/usr/home        184K  93.2G   184K  /usr/home
mypool/usr/mydataset  87.5K  93.2G  87.5K  /usr/mydataset
mypool/usr/ports       144K  93.2G   144K  /usr/ports
mypool/usr/src         144K  93.2G   144K  /usr/src
mypool/var            1.20M  93.2G   610K  /var
mypool/var/crash       148K  93.2G   148K  /var/crash
mypool/var/log         178K  93.2G   178K  /var/log
mypool/var/mail        144K  93.2G   144K  /var/mail
mypool/var/tmp         152K  93.2G   152K  /var/tmp
</code></pre></div><p>摧毀資料集會比刪除所有在資料集上所殘留的檔案來的快，由於摧毀資料集並不會掃描所有檔案並更新所有相關的 Metadata。</p>
<p>摧毀先前建立的資料集：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list</span>
NAME                   USED  AVAIL  REFER  MOUNTPOINT
mypool                 880M  93.1G   144K  none
mypool/ROOT            777M  93.1G   144K  none
mypool/ROOT/default    777M  93.1G   777M  /
mypool/tmp             176K  93.1G   176K  /tmp
mypool/usr             101M  93.1G   144K  /usr
mypool/usr/home        184K  93.1G   184K  /usr/home
mypool/usr/mydataset   100M  93.1G   100M  /usr/mydataset
mypool/usr/ports       144K  93.1G   144K  /usr/ports
mypool/usr/src         144K  93.1G   144K  /usr/src
mypool/var            1.20M  93.1G   610K  /var
mypool/var/crash       148K  93.1G   148K  /var/crash
mypool/var/log         178K  93.1G   178K  /var/log
mypool/var/mail        144K  93.1G   144K  /var/mail
mypool/var/tmp         152K  93.1G   152K  /var/tmp
<span style="color:#75715e"># zfs destroy mypool/usr/mydataset</span>
<span style="color:#75715e"># zfs list</span>
NAME                  USED  AVAIL  REFER  MOUNTPOINT
mypool                781M  93.2G   144K  none
mypool/ROOT           777M  93.2G   144K  none
mypool/ROOT/default   777M  93.2G   777M  /
mypool/tmp            176K  93.2G   176K  /tmp
mypool/usr            616K  93.2G   144K  /usr
mypool/usr/home       184K  93.2G   184K  /usr/home
mypool/usr/ports      144K  93.2G   144K  /usr/ports
mypool/usr/src        144K  93.2G   144K  /usr/src
mypool/var           1.21M  93.2G   612K  /var
mypool/var/crash      148K  93.2G   148K  /var/crash
mypool/var/log        178K  93.2G   178K  /var/log
mypool/var/mail       144K  93.2G   144K  /var/mail
mypool/var/tmp        152K  93.2G   152K  /var/tmp
</code></pre></div><p>在最近版本的 ZFS，<code>zfs destroy</code> 是非同步的，且釋放出的空間會許要花費數分鐘才會出現在儲存池上，可使用 <code>zpool get freeing poolname</code> 來查看 <code>freeing</code> 屬性，這個屬性會指出資料集在背景已經釋放多少資料區塊了。若有子資料集，如快照 (Snapshot) 或其他資料集存在的話，則會無法摧毀父資料集。要摧毀一個資料集及其所有子資料集，可使用 <code>-r</code> 來做遞迴摧毀資料集及其所有子資料集，可用 <code>-n -v</code> 來列出會被這個操作所摧毀的資料集及快照，而不會真的摧毀，因摧毀快照所釋放出的空間也會同時顯示。</p>
<h4 id="建立與摧毀磁碟區">建立與摧毀磁碟區<a hidden class="anchor" aria-hidden="true" href="#建立與摧毀磁碟區">#</a></h4>
<p>磁碟區 (Volume) 是特殊類型的資料集，不會被掛載成一個檔案系統，而是會被當做儲存區塊裝置出現在 <strong>/dev/zvol/poolname/dataset</strong> 下。這讓磁碟區可供其他檔案系統使用、拿來備份虛擬機器的磁碟或是使用 iSCSI 或 HAST 通訊協定匯出。</p>
<p>磁碟區可以被格式化成任何檔案系統，或不使用檔案系統來儲存原始資料。對一般使用者，磁碟區就像是一般的磁碟，可以放置一般的檔案系統在這些 <em>zvols</em> 上，並提供一般磁碟或檔案系統一般所沒有的功能。例如，使用壓縮屬性在一個 250 MB 的磁碟區可建立一個壓縮的 FAT 檔案系統。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs create -V 250m -o compression=on tank/fat32</span>
<span style="color:#75715e"># zfs list tank</span>
NAME USED AVAIL REFER MOUNTPOINT
tank 258M  670M   31K /tank
<span style="color:#75715e"># newfs_msdos -F32 /dev/zvol/tank/fat32</span>
<span style="color:#75715e"># mount -t msdosfs /dev/zvol/tank/fat32 /mnt</span>
<span style="color:#75715e"># df -h /mnt | grep fat32</span>
Filesystem           Size Used Avail Capacity Mounted on
/dev/zvol/tank/fat32 249M  24k  249M     0%   /mnt
<span style="color:#75715e"># mount | grep fat32</span>
/dev/zvol/tank/fat32 on /mnt <span style="color:#f92672">(</span>msdosfs, local<span style="color:#f92672">)</span>
</code></pre></div><p>摧毀一個磁碟區與摧毀一個一般的檔案系統資料集差不多。操作上幾乎是即時的，但在背景會需要花費數分鐘來讓釋放空間再次可用。</p>
<h4 id="重新命名資料集">重新命名資料集<a hidden class="anchor" aria-hidden="true" href="#重新命名資料集">#</a></h4>
<p>資料集的名稱可以使用 <code>zfs rename</code> 更改。父資料集也同樣可以使用這個指令來更改名稱。重新命名一個資料集到另一個父資料集也會更改自父資料集繼承的屬性值。重新命名資料集後，會被卸載然後重新掛載到新的位置 (依繼承的新父資料集而定)，可使用 <code>-u</code> 來避免重新掛載。</p>
<p>重新命名一個資料集並移動該資料集到另一個父資料集：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list</span>
NAME                   USED  AVAIL  REFER  MOUNTPOINT
mypool                 780M  93.2G   144K  none
mypool/ROOT            777M  93.2G   144K  none
mypool/ROOT/default    777M  93.2G   777M  /
mypool/tmp             176K  93.2G   176K  /tmp
mypool/usr             704K  93.2G   144K  /usr
mypool/usr/home        184K  93.2G   184K  /usr/home
mypool/usr/mydataset  87.5K  93.2G  87.5K  /usr/mydataset
mypool/usr/ports       144K  93.2G   144K  /usr/ports
mypool/usr/src         144K  93.2G   144K  /usr/src
mypool/var            1.21M  93.2G   614K  /var
mypool/var/crash       148K  93.2G   148K  /var/crash
mypool/var/log         178K  93.2G   178K  /var/log
mypool/var/mail        144K  93.2G   144K  /var/mail
mypool/var/tmp         152K  93.2G   152K  /var/tmp
<span style="color:#75715e"># zfs rename mypool/usr/mydataset mypool/var/newname</span>
<span style="color:#75715e"># zfs list</span>
NAME                  USED  AVAIL  REFER  MOUNTPOINT
mypool                780M  93.2G   144K  none
mypool/ROOT           777M  93.2G   144K  none
mypool/ROOT/default   777M  93.2G   777M  /
mypool/tmp            176K  93.2G   176K  /tmp
mypool/usr            616K  93.2G   144K  /usr
mypool/usr/home       184K  93.2G   184K  /usr/home
mypool/usr/ports      144K  93.2G   144K  /usr/ports
mypool/usr/src        144K  93.2G   144K  /usr/src
mypool/var           1.29M  93.2G   614K  /var
mypool/var/crash      148K  93.2G   148K  /var/crash
mypool/var/log        178K  93.2G   178K  /var/log
mypool/var/mail       144K  93.2G   144K  /var/mail
mypool/var/newname   87.5K  93.2G  87.5K  /var/newname
mypool/var/tmp        152K  93.2G   152K  /var/tmp
</code></pre></div><p>快照也可以像這樣重新命名，由於快照的本質使其無法被重新命名到另一個父資料集。要遞迴重新命名快照可指定 <code>-r</code>，然後在子資料集中所有同名的快照也會一併被重新命名。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -t snapshot</span>
NAME                                USED  AVAIL  REFER  MOUNTPOINT
mypool/var/newname@first_snapshot      <span style="color:#ae81ff">0</span>      -  87.5K  -
<span style="color:#75715e"># zfs rename mypool/var/newname@first_snapshot new_snapshot_name</span>
<span style="color:#75715e"># zfs list -t snapshot</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/newname@new_snapshot_name      <span style="color:#ae81ff">0</span>      -  87.5K  -
</code></pre></div><h4 id="設定資料集屬性">設定資料集屬性<a hidden class="anchor" aria-hidden="true" href="#設定資料集屬性">#</a></h4>
<p>每個 ZFS 資料集有數個屬性可以用來控制其行為。大部份的屬性會自動繼承自其父資料集，但可以被自己覆蓋。設定資料集上的屬性可使用 <code>zfs set property=value dataset</code>。大部份屬性有限制可用的值，<code>zfs get</code> 會顯示每個可以使用的屬性及其可用的值。大部份可以使用 <code>zfs inherit</code> 還原成其繼承的值。</p>
<p>也可設定使用者自訂的屬性。這些屬性也會成為資料集設定的一部份，且可以被用來提供資料集或其內容的額外資訊。要分別自訂屬性與 ZFS 提供的屬性，會使用冒號 (<code>:</code>) 建立一個自訂命名空間供自訂屬性使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set custom:costcenter=1234 tank</span>
<span style="color:#75715e"># zfs get custom:costcenter tank</span>
NAME PROPERTY           VALUE SOURCE
tank custom:costcenter  <span style="color:#ae81ff">1234</span>  local
</code></pre></div><p>要移除自訂屬性，可用 <code>zfs inherit</code> 加上 <code>-r</code>。若父資料集未定義任何自訂屬性，將會將該屬性完全移除 (更改動作仍會記錄於儲存池的歷史記錄)。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs inherit -r custom:costcenter tank</span>
<span style="color:#75715e"># zfs get custom:costcenter tank</span>
NAME    PROPERTY           VALUE              SOURCE
tank    custom:costcenter  -                  -
<span style="color:#75715e"># zfs get all tank | grep custom:costcenter</span>
<span style="color:#75715e">#</span>
</code></pre></div><h5 id="取得與設定共享屬性">取得與設定共享屬性<a hidden class="anchor" aria-hidden="true" href="#取得與設定共享屬性">#</a></h5>
<p>两个常用和有用的数据集属性是NFS和SMB共享选项。设置这些参数可以定义是否以及如何在网络上共享ZFS数据集。目前，FreeBSD只支持通过NFS设置共享。输入以下命令获取当前共享状态:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs get sharenfs mypool/usr/home</span>
NAME             PROPERTY  VALUE    SOURCE
mypool/usr/home  sharenfs  on       local
<span style="color:#75715e"># zfs get sharesmb mypool/usr/home</span>
NAME             PROPERTY  VALUE    SOURCE
mypool/usr/home  sharesmb  off      local
</code></pre></div><p>如果需要共享数据集，请输入:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#  zfs set sharenfs=on mypool/usr/home</span>
</code></pre></div><p>还可以为通过NFS共享数据集设置额外的选项，例如<code>-alldirs</code>、<code>-maprot</code>和<code>-network</code>。如果要为NFS共享的数据集设置其他选项，请输入:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#  zfs set sharenfs=&#34;-alldirs,-maproot=root,-network=192.168.1.0/24&#34; mypool/usr/home</span>
</code></pre></div><h4 id="管理快照-snapshot">管理快照 (Snapshot)<a hidden class="anchor" aria-hidden="true" href="#管理快照-snapshot">#</a></h4>
<p>快照 (Snapshot) 是 ZFS 最強大的功能之一。快照提供了資料集唯讀、單一時間點 (Point-in-Time) 的複製功能，使用了寫入時複製 (Copy-On-Write, COW) 的技術，可以透過保存在磁碟上的舊版資料快速的建立快照。若沒有快照存在，在資料被覆蓋或刪除時，便回收空間供未來使用。由於只記錄前一個版本與目前資料集的差異，因此快照可節省磁碟空間。快照只允許在整個資料集上使用，無法在各別檔案或目錄。當建立了一個資料集的快照時，便備份了所有內含的資料，這包含了檔案系統屬性、檔案、目錄、權限等等。第一次建立快照時只會使用到更改參照到資料區塊的空間，不會用到其他額外的空間。使用 <code>-r</code> 可以對使用同名的資料集及其所有子資料集的建立一個遞迴快照，提供一致且即時 (Moment-in-time) 的完整檔案系統快照功能，這對於那些彼此有相關或相依檔案存放在不同資料集的應用程式非常重要。不使用快照所備份的資料其實是分散不同時間點的。</p>
<p>ZFS 中的快照提供了多種功能，即使是在其他缺乏快照功能的檔案系統上。一個使用快照的典型例子是在安裝軟體或執行系統升級這種有風險的動作時，能有一個快速的方式可以備份檔案系統目前的狀態，若動作失敗，可以使用快照還原 (Roll back) 到與快照建立時相同的系統狀態，若升級成功，便可刪除快照來釋放空間。若沒有快照功能，升級失敗通常會需要使用備份來恢復 (Restore) 系統，而這個動作非常繁瑣、耗時且可能會需要停機一段時間系統無法使用。使用快照可以快速的還原，即使系統正在執行一般的運作，只而要短暫或甚至不需停機。能夠節省大量在有數 TB 的儲存系統上從備份複製所需資料的時間。快照並非要用來取代儲存池的完整備份，但可以用在快速且簡單的保存某個特定時間點的資料集。</p>
<h5 id="建立快照">建立快照<a hidden class="anchor" aria-hidden="true" href="#建立快照">#</a></h5>
<p>快照可以使用 <code>zfs snapshot dataset@snapshotname</code> 來建立。加入 <code>-r</code> 可以遞迴對所有同名的子資料集建立快照。</p>
<p>建立一個整個儲存池的遞迴快照：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -t all</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool                                 780M  93.2G   144K  none
mypool/ROOT                            777M  93.2G   144K  none
mypool/ROOT/default                    777M  93.2G   777M  /
mypool/tmp                             176K  93.2G   176K  /tmp
mypool/usr                             616K  93.2G   144K  /usr
mypool/usr/home                        184K  93.2G   184K  /usr/home
mypool/usr/ports                       144K  93.2G   144K  /usr/ports
mypool/usr/src                         144K  93.2G   144K  /usr/src
mypool/var                            1.29M  93.2G   616K  /var
mypool/var/crash                       148K  93.2G   148K  /var/crash
mypool/var/log                         178K  93.2G   178K  /var/log
mypool/var/mail                        144K  93.2G   144K  /var/mail
mypool/var/newname                    87.5K  93.2G  87.5K  /var/newname
mypool/var/newname@new_snapshot_name      <span style="color:#ae81ff">0</span>      -  87.5K  -
mypool/var/tmp                         152K  93.2G   152K  /var/tmp
<span style="color:#75715e"># zfs snapshot -r mypool@my_recursive_snapshot</span>
<span style="color:#75715e"># zfs list -t snapshot</span>
NAME                                        USED  AVAIL  REFER  MOUNTPOINT
mypool@my_recursive_snapshot                   <span style="color:#ae81ff">0</span>      -   144K  -
mypool/ROOT@my_recursive_snapshot              <span style="color:#ae81ff">0</span>      -   144K  -
mypool/ROOT/default@my_recursive_snapshot      <span style="color:#ae81ff">0</span>      -   777M  -
mypool/tmp@my_recursive_snapshot               <span style="color:#ae81ff">0</span>      -   176K  -
mypool/usr@my_recursive_snapshot               <span style="color:#ae81ff">0</span>      -   144K  -
mypool/usr/home@my_recursive_snapshot          <span style="color:#ae81ff">0</span>      -   184K  -
mypool/usr/ports@my_recursive_snapshot         <span style="color:#ae81ff">0</span>      -   144K  -
mypool/usr/src@my_recursive_snapshot           <span style="color:#ae81ff">0</span>      -   144K  -
mypool/var@my_recursive_snapshot               <span style="color:#ae81ff">0</span>      -   616K  -
mypool/var/crash@my_recursive_snapshot         <span style="color:#ae81ff">0</span>      -   148K  -
mypool/var/log@my_recursive_snapshot           <span style="color:#ae81ff">0</span>      -   178K  -
mypool/var/mail@my_recursive_snapshot          <span style="color:#ae81ff">0</span>      -   144K  -
mypool/var/newname@new_snapshot_name           <span style="color:#ae81ff">0</span>      -  87.5K  -
mypool/var/newname@my_recursive_snapshot       <span style="color:#ae81ff">0</span>      -  87.5K  -
mypool/var/tmp@my_recursive_snapshot           <span style="color:#ae81ff">0</span>      -   152K  -
</code></pre></div><p>建立的快照不會顯示在一般的 <code>zfs list</code> 操作結果，要列出快照需在 <code>zfs list</code> 後加上 <code>-t snapshot</code>，使用 <code>-t all</code> 可以同時列出檔案系統的內容及快照。</p>
<p>快照並不會直接掛載，因此 <code>MOUNTPOINT</code> 欄位的路徑如此顯示。在 <code>AVAIL</code> 欄位不會有可用的磁碟空間，因為快照建立之後便無法再寫入。比較快照與其原來建立時的資料集：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -rt all mypool/usr/home</span>
NAME                                    USED  AVAIL  REFER  MOUNTPOINT
mypool/usr/home                         184K  93.2G   184K  /usr/home
mypool/usr/home@my_recursive_snapshot      <span style="color:#ae81ff">0</span>      -   184K  -
</code></pre></div><p>同時顯示資料集與快照可以了解快照如何使用 COW 技術來運作。快照只會保存有更動 (<em>差異</em>) 的資料，並非整個檔案系統的內容，這個意思是說，快照只會在有做更動時使用一小部份的空間，複製一個檔案到該資料集，可以讓空間使用量變的更明顯，然後再做第二個快照：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /etc/passwd /var/tmp</span>
<span style="color:#75715e"># zfs snapshot mypool/var/tmp@after_cp</span>
<span style="color:#75715e"># zfs list -rt all mypool/var/tmp</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp                         206K  93.2G   118K  /var/tmp
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp                   <span style="color:#ae81ff">0</span>      -   118K  -
</code></pre></div><p>第二快照只會包含了資料集做了複製動作後的更動，這樣的機制可以節省大量的空間。注意在複製之後快照 <em>mypool/var/tmp@my_recursive_snapshot</em> 於 <code>USED</code> 欄位中的大小也更改了，這說明了這個更動在前次快照與之後快照間的關係。</p>
<h5 id="比對快照">比對快照<a hidden class="anchor" aria-hidden="true" href="#比對快照">#</a></h5>
<p>ZFS 提供了內建指令可以用來比對兩個快照 (Snapshot) 之間的差異，在使用者想要查看一段時間之間檔案系統所的變更時非常有用。例如 <code>zfs diff</code> 可以讓使用者在最後一次快照中找到意外刪除的檔案。對前面一節所做的兩個快照使用這個指令會產生以下結果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -rt all mypool/var/tmp</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp                         206K  93.2G   118K  /var/tmp
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp                   <span style="color:#ae81ff">0</span>      -   118K  -
<span style="color:#75715e"># zfs diff mypool/var/tmp@my_recursive_snapshot</span>
M       /var/tmp/
+       /var/tmp/passwd
</code></pre></div><p>指令會列出指定快照 (在這個例子中為 <code>mypool/var/tmp@my_recursive_snapshot</code>) 與目前檔案系統間的更改。第一個欄位是更改的類型：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>+</td>
<td>加入了該路徑或檔案。</td>
</tr>
<tr>
<td>-</td>
<td>刪除了該路徑或檔案。</td>
</tr>
<tr>
<td>M</td>
<td>修改了該路徑或檔案。</td>
</tr>
<tr>
<td>R</td>
<td>重新命名了該路徑或檔案。</td>
</tr>
</tbody>
</table>
<p>對照這個表格來看輸出的結果，可以明顯的看到 <strong>passwd</strong> 是在快照 <code>mypool/var/tmp@my_recursive_snapshot</code> 建立之後才加入的，結果也同樣看的到掛載到 <code>/var/tmp</code> 的父目錄已經做過修改。</p>
<p>在使用 ZFS 備份功能來傳輸一個資料集到另一個主機備份時比對兩個快照也同樣很有用。</p>
<p>比對兩個快照需要提供兩個資料集的完整資料集名稱與快照名稱：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /var/tmp/passwd /var/tmp/passwd.copy</span>
<span style="color:#75715e"># zfs snapshot mypool/var/tmp@diff_snapshot</span>
<span style="color:#75715e"># zfs diff mypool/var/tmp@my_recursive_snapshot mypool/var/tmp@diff_snapshot</span>
M       /var/tmp/
+       /var/tmp/passwd
+       /var/tmp/passwd.copy
<span style="color:#75715e"># zfs diff mypool/var/tmp@my_recursive_snapshot mypool/var/tmp@after_cp</span>
M       /var/tmp/
+       /var/tmp/passwd
</code></pre></div><p>備份管理者可以比對兩個自傳送主機所接收到的兩個快照並查看實際在資料集中的變更。請參考 <a href="#%E5%82%99%E4%BB%BD" title="Replication">備份</a> 一節來取得更多資訊。</p>
<h5 id="使用快照還原">使用快照還原<a hidden class="anchor" aria-hidden="true" href="#使用快照還原">#</a></h5>
<p>只要至少有一個可用的快照便可以隨時還原。大多數在已不需要目前資料集，想要改用較舊版的資料的情況，例如，本地開發的測試發生錯誤、不良的系統更新破壞了系統的整體功能或需要還原意外刪除檔案或目錄 … 等，都是非常常見的情形。幸運的，要還原到某個快照只需要簡單輸入 <code>zfs rollback snapshotname</code>。會依快照所做的變更數量來決定處理的時間，還原的操作會在一段時間後完成。在這段時間中，資料集會一直保持一致的狀態，類似一個符合 ACID 原則的資料庫在做還原。還原可在資料集處於上線及可存取的情況下完成，不需要停機。還原到快照之後，資料集便回到當初執行快照時相同的狀態，所有沒有在快照中的其他資料便會被丟棄，因此往後若還有可能需要部份資料時，建議在還原到前一個快照之前先對目前的資料集做快照，這樣一來，使用者便可以在快照之間來回快換，而不會遺失重要的資料。</p>
<p>在第一個範例中，因為 <code>rm</code> 操作不小心移除了預期外的資料，要還原到快照。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -rt all mypool/var/tmp</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp                         262K  93.2G   120K  /var/tmp
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp               53.5K      -   118K  -
mypool/var/tmp@diff_snapshot              <span style="color:#ae81ff">0</span>      -   120K  -
<span style="color:#75715e"># ls /var/tmp</span>
passwd          passwd.copy     vi.recover
<span style="color:#75715e"># rm /var/tmp/passwd*</span>
<span style="color:#75715e"># ls /var/tmp</span>
vi.recover
</code></pre></div><p>在此時，使用者發現到刪除了太多檔案並希望能夠還原。ZFS 提供了簡單的方可以取回檔案，便是使用還原 (Rollback)，但這只在有定期對重要的資料使用快照時可用。要拿回檔案並從最後一次快照重新開始，可執行以下指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs rollback mypool/var/tmp@diff_snapshot</span>
<span style="color:#75715e"># ls /var/tmp</span>
passwd          passwd.copy     vi.recover
</code></pre></div><p>還原操作會將資料集還原為最後一次快照的狀態。這也可以還原到更早之前，有其他在其之後建立的快照。要這麼做時，ZFS 會發出這個警告：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -rt snapshot mypool/var/tmp</span>
AME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp               53.5K      -   118K  -
mypool/var/tmp@diff_snapshot              <span style="color:#ae81ff">0</span>      -   120K  -
<span style="color:#75715e"># zfs rollback mypool/var/tmp@my_recursive_snapshot</span>
cannot rollback to <span style="color:#e6db74">&#39;mypool/var/tmp@my_recursive_snapshot&#39;</span>: more recent snapshots exist
use <span style="color:#e6db74">&#39;-r&#39;</span> to force deletion of the following snapshots:
mypool/var/tmp@after_cp
mypool/var/tmp@diff_snapshot
</code></pre></div><p>這個警告是因在該快照與資料集的目前狀態之間有其他快照存在，然而使用者想要還原到該快照。要完成這樣的還原動作，必須刪除在這之間的快照，因為 ZFS 無法追蹤不同資料集狀態間的變更。在使用者未指定 <code>-r</code> 來確認這個動作前，ZFS 不會刪除受影響的快照。若確定要這麼做，那麼必須要知道會遺失所有在這之間的快照，然後可執行以下指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs rollback -r mypool/var/tmp@my_recursive_snapshot</span>
<span style="color:#75715e"># zfs list -rt snapshot mypool/var/tmp</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp@my_recursive_snapshot     8K      -   152K  -
<span style="color:#75715e"># ls /var/tmp</span>
vi.recover
</code></pre></div><p>可從 <code>zfs list -t snapshot</code> 的結果來確認 <code>zfs rollback -r</code> 會移除的快照。</p>
<h5 id="從快照還原個別檔案">從快照還原個別檔案<a hidden class="anchor" aria-hidden="true" href="#從快照還原個別檔案">#</a></h5>
<p>快照會掛載在父資料集下的隱藏目錄：<strong>.zfs/snapshots/snapshotname</strong>。預設不會顯示這些目錄，即使是用 <code>ls -a</code> 指令。雖然該目錄不會顯示，但該目錄實際存在，而且可以像一般的目錄一樣存取。一個名稱為 <code>snapdir</code> 的屬性可以控制是否在目錄清單中顯示這些隱藏目錄，設定該屬性為可見 (<code>visible</code>) 可以讓這些目錄出現在 <code>ls</code> 以及其他處理目錄內容的指令中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs get snapdir mypool/var/tmp</span>
NAME            PROPERTY  VALUE    SOURCE
mypool/var/tmp  snapdir   hidden   default
<span style="color:#75715e"># ls -a /var/tmp</span>
.               ..              passwd          vi.recover
<span style="color:#75715e"># zfs set snapdir=visible mypool/var/tmp</span>
<span style="color:#75715e"># ls -a /var/tmp</span>
.               ..              .zfs            passwd          vi.recover
</code></pre></div><p>要還原個別檔案到先前的狀態非常簡單，只要從快照中複製檔案到父資料集。在 <strong>.zfs/snapshot</strong> 目錄結構下有一個與先前所做的快照名稱相同的目錄，可以很容易的找到。在下個範例中，我們會示範從隱藏的 <strong>.zfs</strong> 目錄還原一個檔案，透過從含有該檔案的最新版快照複製：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># rm /var/tmp/passwd</span>
<span style="color:#75715e"># ls -a /var/tmp</span>
.               ..              .zfs            vi.recover
<span style="color:#75715e"># ls /var/tmp/.zfs/snapshot</span>
after_cp                my_recursive_snapshot
<span style="color:#75715e"># ls /var/tmp/.zfs/snapshot/after_cp</span>
passwd          vi.recover
<span style="color:#75715e"># cp /var/tmp/.zfs/snapshot/after_cp/passwd /var/tmp</span>
</code></pre></div><p>執行 <code>ls .zfs/snapshot</code> 時，雖然 <code>snapdir</code> 可能已經設為隱藏，但仍可能可以顯示該目錄中的內容，這取決於管理者是否要顯示這些目錄，可以只顯示特定的資料集，而其他的則不顯示。從這個隱藏的 <strong>.zfs/snapshot</strong> 複製檔案或目錄非常簡單，除此之外，嘗試其他的動作則會出現以下錯誤：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /etc/rc.conf /var/tmp/.zfs/snapshot/after_cp/</span>
cp: /var/tmp/.zfs/snapshot/after_cp/rc.conf: Read-only file system
</code></pre></div><p>這個錯誤用來提醒使用者快照是唯讀的，在建立之後不能更改。無法複製檔案進去或從該快照目錄中移除，因為這會變更該資料集所代表的狀態。</p>
<p>快照所消耗的空間是依據自快照之後父檔案系統做了多少變更來決定，快照的 <code>written</code> 屬性可以用來追蹤有多少空間被快照所使用。</p>
<p>使用 <code>zfs destroy dataset@snapshot</code> 可以摧毀快照並回收空間。加上 <code>-r</code> 可以遞迴移除所有在父資料集下使用同名的快照。加入 <code>-n -v</code> 來顯示將要移除的快照清單以及估計回收的空間，而不會實際執行摧毀的操作。</p>
<h4 id="管理複本-clone">管理複本 (Clone)<a hidden class="anchor" aria-hidden="true" href="#管理複本-clone">#</a></h4>
<p>複本 (Clone) 是快照的複製，但更像是一般的資料集，與快照不同的是，複本是非唯讀的 (可寫)，且可掛載，可以有自己的屬性。使用 <code>zfs clone</code> 建立複本之後，便無法再摧毀用來建立複本的快照。複本與快照的父/子關係可以使用 <code>zfs promote</code> 來對換。提升複本之後 ，快照便會成為複本的子資料集，而不是原來的父資料集，這個動作會改變空間計算的方式，但並不會實際改變空間的使用量。複本可以被掛載到 ZFS 檔案系統階層中的任何一點，並非只能位於原來快照的位置底下。</p>
<p>要示範複本功能會用到這個範例資料集：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs list -rt all camino/home/joe</span>
NAME                    USED  AVAIL  REFER  MOUNTPOINT
camino/home/joe         108K   1.3G    87K  /usr/home/joe
camino/home/joe@plans    21K      -  85.5K  -
camino/home/joe@backup    0K      -    87K  -
</code></pre></div><p>會使用到複本一般是要在可以保留快照以便出錯時可還原的情況下使用指定的資料集做實驗，由於快照並無法做更改，所以會建立一個可以讀/寫的快照複本。當在複本中做完想要執行的動作後，便可以提升複本成資料集，然後移除舊的檔案系統。嚴格來說這並非必要，因為複本與資料集可同時存在，不會有任何問題。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs clone camino/home/joe@backup camino/home/joenew</span>
<span style="color:#75715e"># ls /usr/home/joe*</span>
/usr/home/joe:
backup.txz     plans.txt

/usr/home/joenew:
backup.txz     plans.txt
<span style="color:#75715e"># df -h /usr/home</span>
Filesystem          Size    Used   Avail Capacity  Mounted on
usr/home/joe        1.3G     31k    1.3G     0%    /usr/home/joe
usr/home/joenew     1.3G     31k    1.3G     0%    /usr/home/joenew
</code></pre></div><p>建立完的複本便有與建立快照時狀態相同的資料集，現在複本可以獨立於原來的資料集來做更改。剩下唯一與資料集之間的關係便是快照，ZFS 會在屬性 <code>origin</code> 記錄這個關係，一旦在快照與複本之間的相依關係因為使用 <code>zfs promote</code> 提升而移除時，複本的 <code>origin</code> 也會因為成為一個完全獨立的資料集而移除。以下範例會示範這個動作：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs get origin camino/home/joenew</span>
NAME                  PROPERTY  VALUE                     SOURCE
camino/home/joenew    origin    camino/home/joe@backup    -
<span style="color:#75715e"># zfs promote camino/home/joenew</span>
<span style="color:#75715e"># zfs get origin camino/home/joenew</span>
NAME                  PROPERTY  VALUE   SOURCE
camino/home/joenew    origin    -       -
</code></pre></div><p>做為部份更改之後，例如複製 <strong>loader.conf</strong> 到提升後的複本，這個例子中的舊目錄便無須保留，取而代之的是提升後的複本，這個動作可以用兩個連續的指令來完成：在舊資料集上執行 <code>zfs destroy</code> 並在與舊資料相似名稱 (也可能用完全不同的名稱) 的複本上執行 <code>zfs rename</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cp /boot/defaults/loader.conf /usr/home/joenew</span>
<span style="color:#75715e"># zfs destroy -f camino/home/joe</span>
<span style="color:#75715e"># zfs rename camino/home/joenew camino/home/joe</span>
<span style="color:#75715e"># ls /usr/home/joe</span>
backup.txz     loader.conf     plans.txt
<span style="color:#75715e"># df -h /usr/home</span>
Filesystem          Size    Used   Avail Capacity  Mounted on
usr/home/joe        1.3G    128k    1.3G     0%    /usr/home/joe
</code></pre></div><p>快照的複本現在可以如同一般資料集一樣使用，它的內容包含了所有來自原始快照的資料以及後來加入的檔案，例如 <strong>loader.conf</strong>。複本可以在許多不同的情境下使用提供 ZFS 的使用者有用的功能，例如，Jail 可以透過含有已安裝了各種應用程式集的快照來提供，使用者可以複製這些快照然後加入自己想要嘗試的應用程式，一但更改可以滿足需求，便可提升複本為完整的資料集然後提供給終端使用者，讓終端使用者可以如同實際擁有資料集一般的使用，這個以節省提供這些 Jail 的時間與管理成本。</p>
<h4 id="備份-replication">備份 (Replication)<a hidden class="anchor" aria-hidden="true" href="#備份-replication">#</a></h4>
<p>將資料保存在單一地點的單一儲存池上會讓資料暴露在盜竊、自然或人為的風險之下，定期備份整個儲存池非常重要，ZFS 提供了內建的序列化 (Serialization) 功能可以將資料以串流傳送到標準輸出。使用這項技術，不僅可以將資料儲存到另一個已連結到本地系統的儲存池，也可以透過網路將資料傳送到另一個系統，這種備份方式以快照為基礎 (請參考章節 <a href="#%E7%AE%A1%E7%90%86%E5%BF%AB%E7%85%A7" title="Snapshot">ZFS 快照(Snapshot)</a>)。用來備份資料的指令為 <code>zfs send</code> 及 <code>zfs receive</code>。</p>
<p>以下例子將示範使用兩個儲存池來做 ZFS 備份：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG   CAP  DEDUP  HEALTH  ALTROOT
backup  960M    77K   896M         -         -     0%    0%  1.00x  ONLINE  -
mypool  984M  43.7M   940M         -         -     0%    4%  1.00x  ONLINE  -
</code></pre></div><p>名為 <em>mypool</em> 的儲存池為主要的儲存池，資料會定期寫入與讀取的位置。第二個儲存池 <em>backup</em> 用來待命 (Standby)，萬一主要儲存池無法使用時可替換。注意，ZFS 並不會自動做容錯移轉 (Fail-over)，必須要由系統管理者在需要的時候手動完成。快照會用來提供一個與檔系統一致的版本來做備份，<em>mypool</em> 的快照建立之後，便可以複製到 <em>backup</em> 儲存池，只有快照可以做備份，最近一次快照之後所做的變更不會含在內容裡面。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs snapshot mypool@backup1</span>
<span style="color:#75715e"># zfs list -t snapshot</span>
NAME                    USED  AVAIL  REFER  MOUNTPOINT
mypool@backup1             <span style="color:#ae81ff">0</span>      -  43.6M  -
</code></pre></div><p>快照存在以後，便可以使用 <code>zfs send</code> 來建立一個代表快照內容的串流，這個串流可以儲存成檔案或由其他儲存池接收。串流會寫入到標準輸出，但是必須要重新導向到一個檔案或轉接到其他地方，否則會錯誤：</p>
<pre tabindex="0"><code># zfs send mypool@backup1
Error: Stream can not be written to a terminal.
You must redirect standard output.
</code></pre><p>要使用 <code>zfs send</code> 備份一個資料集，可重新導向到一個位於在已掛載到備份儲存池上的檔案。確定該儲存池有足夠的空間容納要傳送的快照，這裡指的是該快照中內含的所有資料，並非只有上次快照到該快照間的變更。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs send mypool@backup1 &gt; /backup/backup1</span>
<span style="color:#75715e"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT
backup  960M  63.7M   896M         -         -     0%     6%  1.00x  ONLINE  -
mypool  984M  43.7M   940M         -         -     0%     4%  1.00x  ONLINE  -
</code></pre></div><p><code>zfs send</code> 會傳輸在快照 <em>backup1</em> 中所有的資料到儲存池 <em>backup</em>。可以使用 <a href="https://www.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a> 排程來自動完成建立與傳送快照的動作。</p>
<p>若不想將備份以封存檔案儲存，ZFS 可用實際的檔案系統來接收資料，讓備份的資料可以直接被存取。要取得實際包含在串流中的資料可以用 <code>zfs receive</code> 將串流轉換回檔案與目錄。以下例子會以管線符號連接 <code>zfs send</code> 及 <code>zfs receive</code>，將資料從一個儲存池複製到另一個，傳輸完成後可以直接使用接收儲存池上的資料。一個資料集只可以被複製到另一個空的資料集。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs snapshot mypool@replica1</span>
<span style="color:#75715e"># zfs send -v mypool@replica1 | zfs receive backup/mypool</span>
send from @ to mypool@replica1 estimated size is 50.1M
total estimated size is 50.1M
TIME        SENT   SNAPSHOT

<span style="color:#75715e"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT
backup  960M  63.7M   896M         -         -     0%     6%  1.00x  ONLINE  -
mypool  984M  43.7M   940M         -         -     0%     4%  1.00x  ONLINE  -
</code></pre></div><h5 id="漸進式備份">漸進式備份<a hidden class="anchor" aria-hidden="true" href="#漸進式備份">#</a></h5>
<p><code>zfs send</code> 也可以比較兩個快照之間的差異，並且只傳送兩者之間的差異，這麼做可以節省磁碟空間及傳輸時間。例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs snapshot mypool@replica2</span>
<span style="color:#75715e"># zfs list -t snapshot</span>
NAME                    USED  AVAIL  REFER  MOUNTPOINT
mypool@replica1         5.72M      -  43.6M  -
mypool@replica2             <span style="color:#ae81ff">0</span>      -  44.1M  -
<span style="color:#75715e"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG   CAP  DEDUP  HEALTH  ALTROOT
backup  960M  61.7M   898M         -         -     0%    6%  1.00x  ONLINE  -
mypool  960M  50.2M   910M         -         -     0%    5%  1.00x  ONLINE  -
</code></pre></div><p>會建立一個名為 <em>replica2</em> 的第二個快照，這個快照只中只會含有目前與前次快照 <em>replica1</em> 之間檔案系統所做的變更。使用 <code>zfs send -i</code> 並指定要用來產生漸進備份串流的快照，串流中只會含有做過更改的資料。這個動作只在接收端已經有初始快照時才可用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs send -v -i mypool@replica1 mypool@replica2 | zfs receive /backup/mypool</span>
send from @replica1 to mypool@replica2 estimated size is 5.02M
total estimated size is 5.02M
TIME        SENT   SNAPSHOT

<span style="color:#75715e"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG  CAP  DEDUP  HEALTH  ALTROOT
backup  960M  80.8M   879M         -         -     0%   8%  1.00x  ONLINE  -
mypool  960M  50.2M   910M         -         -     0%   5%  1.00x  ONLINE  -

<span style="color:#75715e"># zfs list</span>
NAME                         USED  AVAIL  REFER  MOUNTPOINT
backup                      55.4M   240G   152K  /backup
backup/mypool               55.3M   240G  55.2M  /backup/mypool
mypool                      55.6M  11.6G  55.0M  /mypool

<span style="color:#75715e"># zfs list -t snapshot</span>
NAME                                         USED  AVAIL  REFER  MOUNTPOINT
backup/mypool@replica1                       104K      -  50.2M  -
backup/mypool@replica2                          <span style="color:#ae81ff">0</span>      -  55.2M  -
mypool@replica1                             29.9K      -  50.0M  -
mypool@replica2                                 <span style="color:#ae81ff">0</span>      -  55.0M  -
</code></pre></div><p>如此一來，便成功傳輸漸進式的串流，只有做過更改的資料會被備份，不會傳送完整的 <em>replica1</em>。由於不會備份完整的儲存池，只傳送差異的部份，所以可以減少傳輸的時間並節省磁碟空間，特別是在網路緩慢或需要考量每位元傳輸成本時非常有用。</p>
<p>從儲存池 <em>mypool</em> 複製所有檔案與資料的新檔案系統 <em>backup/mypool</em> 便可以使用。若指定 <code>-P</code>，會一併複製資料集的屬性，這包含壓縮 (Compression) 設定，配額 (Quota) 及掛載點 (Mount point)。若指定 <code>-R</code>，會複製所有指定資料集的子資料集，及這些子資料集的所有屬性。可將傳送與接收自動化來定期使用第二個儲存池做備份。</p>
<h5 id="透過-ssh-傳送加密的備份">透過 SSH 傳送加密的備份<a hidden class="anchor" aria-hidden="true" href="#透過-ssh-傳送加密的備份">#</a></h5>
<p>透過網路來傳送串流是一個做遠端備份不錯的方式，但是也有一些缺點，透過網路連線傳送的資料沒有加密，這會讓任何人都可以在未告知傳送方的情況下攔截並轉換串流回資料，這是我們所不想見到的情況，特別是在使用網際網路傳送串流到遠端的主機時。SSH 可用來加密要透過網路連線傳送的資料，在 ZFS 只需要將串流重新導向到標準輸出，如此一來便可簡單的轉接到 SSH。若要讓檔案系統內容在傳送或在遠端系統中也維持在加密的狀態可考慮使用 <a href="https://wiki.freebsd.org/PEFS">PEFS</a>。</p>
<p>有一些設定以及安全性注意事項必須先完成，只有對 <code>zfs send</code> 操作必要的步驟才會在此說明，要取得更多有關 SSH 的資訊請參考 <a href="https://docs.freebsd.org/zh-tw/books/handbook/security/index.html#openssh">OpenSSH</a>。</p>
<p>必要的環境設定：</p>
<ul>
<li>
<p>使用 SSH 金鑰設定傳送端與接收端間無密碼的 SSH 存取</p>
</li>
<li>
<p>正常會需要 <code>root</code> 的權限來傳送與接收串流，這需要可以 <code>root</code> 登入到接收端系統。但是，預設因安全性考慮會關閉以 <code>root</code> 登入。ZFS 委託 (<a href="#%E5%A7%94%E8%A8%97%E7%AE%A1%E7%90%86">ZFS Delegation</a>) 系統可以用來允許一個非 <code>root</code> 使用者在每個系統上執行各自的發送與接收操作。</p>
</li>
<li>
<p>在傳送端系統上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs allow -u someuser send,snapshot mypool</span>
</code></pre></div></li>
<li>
<p>要掛載儲存池，無權限的使用者必須擁有該目錄且必須允許一般的使用者掛載檔案系統。在接收端系統上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># sysctl vfs.usermount=1</span>
vfs.usermount: <span style="color:#ae81ff">0</span> -&gt; <span style="color:#ae81ff">1</span>
<span style="color:#75715e"># sysrc -f /etc/sysctl.conf vfs.usermount=1</span>
<span style="color:#75715e"># zfs create recvpool/backup</span>
<span style="color:#75715e"># zfs allow -u someuser create,mount,receive recvpool/backup</span>
<span style="color:#75715e"># chown someuser /recvpool/backup</span>
</code></pre></div></li>
</ul>
<p>無權限的使用者現在有能力可以接收並掛載資料集，且 <em>home</em> 資料集可以被複製到遠端系統：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">% zfs snapshot -r mypool/home@monday
% zfs send -R mypool/home@monday | ssh someuser@backuphost zfs recv -dvu recvpool/backup
</code></pre></div><p>替儲存在儲存池 <em>mypool</em> 上的檔案系統資料集 <em>home</em> 製作一個遞迴快照 <em>monday</em>，然後使用 <code>zfs send -R</code> 來傳送包含該資料集及其所有子資料集、快照、複製與設定的串流。輸出會被導向到 SSH 連線的遠端主機 <em>backuphost</em> 上等候輸入的 <code>zfs receive</code>，在此建議使用完整網域名稱或 IP 位置。接收端的機器會寫入資料到 <em>recvpool</em> 儲存池上的 <em>backup</em> 資料集，在 <code>zfs recv</code> 加上 <code>-d</code> 可覆寫在接收端使用相同名稱的快照，加上 <code>-u</code> 可讓檔案系統在接收端不會被掛載，當使用 <code>-v</code>，會顯示更多有關傳輸的詳細資訊，包含已花費的時間及已傳輸的資料量。</p>
<h4 id="資料集使用者以及群組配額">資料集、使用者以及群組配額<a hidden class="anchor" aria-hidden="true" href="#資料集使用者以及群組配額">#</a></h4>
<p>資料集配額 (Dataset quota) 可用來限制特定資料集可以使用的的空間量。參考配額 (Reference Quota) 的功能也非常相似，差在參考配額只會計算資料集自己使用的空間，不含快照與子資料集。類似的，使用者 (User) 與群組 (Group) 配額可以用來避免使用者或群組用掉儲存池或資料集的所有空間。</p>
<p>要設定 <strong>storage/home/bob</strong> 的資料集配額為 10 GB：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set quota=10G storage/home/bob</span>
</code></pre></div><p>要設定 <strong>storage/home/bob</strong> 的參考配額為 10 GB：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set refquota=10G storage/home/bob</span>
</code></pre></div><p>要移除 <strong>storage/home/bob</strong> 的 10 GB 配額：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set quota=none storage/home/bob</span>
</code></pre></div><p>設定使用者配額的一般格式為 <code>userquota@user=size</code> 使用者的名稱必須使用以下格式：</p>
<ul>
<li>POSIX 相容的名稱，如 <em>joe</em>。</li>
<li>POSIX 數字 ID，如 <em>789</em>。</li>
<li>SID 名稱，如 <em><a href="mailto:joe.bloggs@example.com">joe.bloggs@example.com</a></em>。</li>
<li>SID 數字 ID，如 <em>S-1-123-456-789</em>。</li>
</ul>
<p>例如，要設定使用者名為 <em>joe</em> 的使用者配額為 50 GB：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set userquota@joe=50G</span>
</code></pre></div><p>要移除所有配額：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set userquota@joe=none</span>
</code></pre></div><blockquote>
<p>使用者配額的屬性不會顯示在 <code>zfs get all</code>。非 <code>root</code> 的使用者只可以看到自己的配額，除非它們有被授予 <code>userquota</code> 權限，擁有這個權限的使用者可以檢視與設定任何人的配額。</p>
</blockquote>
<p>要設定群組配額的一般格式為：<code>groupquota@group=size</code>。</p>
<p>要設定群組 <em>firstgroup</em> 的配額為 50 GB 可使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set groupquota@firstgroup=50G</span>
</code></pre></div><p>要移除群組 <em>firstgroup</em> 的配額，或確保該群組未設定配額可使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set groupquota@firstgroup=none</span>
</code></pre></div><p>如同使用者配額屬性，非 <code>root</code> 使用者只可以查看自己所屬群組的配額。而 <code>root</code> 或擁有 <code>groupquota</code> 權限的使用者，可以檢視並設定所有群組的任何配額。</p>
<p>要顯示在檔案系統或快照上每位使用者所使用的空間量及配額可使用 <code>zfs userspace</code>，要取得群組的資訊則可使用 <code>zfs groupspace</code>，要取得有關支援的選項資訊或如何只顯示特定選項的資訊請參考 <a href="https://www.freebsd.org/cgi/man.cgi?query=zfs&amp;sektion=1&amp;format=html">zfs(1)</a>。</p>
<p>有足夠權限的使用者及 <code>root</code> 可以使用以下指令列出 <strong>storage/home/bob</strong> 的配額：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs get quota storage/home/bob</span>
</code></pre></div><h4 id="保留空間">保留空間<a hidden class="anchor" aria-hidden="true" href="#保留空間">#</a></h4>
<p>保留空間 (Reservation) 可以確保資料集最少可用的空間量，其他任何資料集無法使用保留的空間，這個功能在要確保有足夠的可用空間來存放重要的資料集或日誌檔時特別有用。</p>
<p><code>reservation</code> 屬性的一般格式為 <code>reservation=size</code>，所以要在 <strong>storage/home/bob</strong> 設定保留 10 GB 的空間可以用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set reservation=10G storage/home/bob</span>
</code></pre></div><p>要清除任何保留空間：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set reservation=none storage/home/bob</span>
</code></pre></div><p>同樣的原則可以應用在 <code>refreservation</code> 屬性來設定參考保留空間 (Reference Reservation)，參考保留空間的一般格式為 <code>refreservation=size</code>。</p>
<p>這個指令會顯示任何已設定於 <strong>storage/home/bob</strong> 的 reservation 或 refreservation：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs get reservation storage/home/bob</span>
<span style="color:#75715e"># zfs get refreservation storage/home/bob</span>
</code></pre></div><h4 id="壓縮-compression">壓縮 (Compression)<a hidden class="anchor" aria-hidden="true" href="#壓縮-compression">#</a></h4>
<p>ZFS 提供直接的壓縮功能，在資料區塊層級壓縮資料不僅可以節省空間，也可以增加磁碟的效能。若資料壓縮了 25%，但壓縮的資料會使用了與未壓縮版本相同的速率寫入到磁碟，所以實際的寫入速度會是原來的 125%。壓縮功能也可來替代去重複 (Deduplication) 功能，因為壓縮並不需要使用額外的記憶體。</p>
<p>ZFS 提了多種不同的壓縮演算法，每一種都有不同的優缺點，隨著 ZFS v5000 引進了 LZ4 壓縮技術，可對整個儲存池開啟壓縮，而不像其他演算法需要消耗大量的效能來達成，最大的優點是 LZ4 擁有 <em>提早放棄</em> 的功能，若 LZ4 無法在資料一開始的部份達成至少 12.5% 的壓縮率，便會以不壓縮的方式來寫入資料區塊來避免 CPU 在那些已經壓縮過或無法壓縮的資料上浪費運算能力。要取得更多有關 ZFS 中可用的壓縮演算法詳細資訊，可參考術語章節中的壓縮 (Compression) 項目。</p>
<p>管理者可以使用資料集的屬性來監視壓縮的效果。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs get used,compressratio,compression,logicalused mypool/compressed_dataset</span>
NAME        PROPERTY          VALUE     SOURCE
mypool/compressed_dataset  used              449G      -
mypool/compressed_dataset  compressratio     1.11x     -
mypool/compressed_dataset  compression       lz4       local
mypool/compressed_dataset  logicalused       496G      -
</code></pre></div><p>資料集目前使用了 449 GB 的空間 (在 used 屬性)。在尚未壓縮前，該資料集應該會使用 496 GB 的空間 (於 <code>logicalused</code> 屬性)，這個結果顯示目前的壓縮比為 1.11:1。</p>
<p>壓縮功能在與使用者配額 (User Quota) 一併使用時可能會產生無法預期的副作用。使用者配額會限制一個使用者在一個資料集上可以使用多少空間，但衡量的依據是以 <em>壓縮後</em> 所使用的空間，因此，若一個使用者有 10 GB 的配額，寫入了 10 GB 可壓縮的資料，使用者將還會有空間儲存額外的資料。若使用者在之後更新了一個檔案，例如一個資料庫，可能有更多或較少的可壓縮資料，那麼剩餘可用的空間量也會因此而改變，這可能會造成奇怪的現象便是，一個使用者雖然沒有增加實際的資料量 (於 <code>logicalused</code> 屬性)，但因為更改影響了壓縮率，導致使用者達到配額的上限。</p>
<p>壓縮功能在與備份功能一起使用時也可能會有類似的問題，通常會使用配額功能來限制能夠儲存的資料量來確保有足夠的備份空間可用。但是由於配額功能並不會考量壓縮狀況，可能會有比未壓縮版本備份更多的資料量會被寫入到資料集。</p>
<h4 id="去重複-deduplication">去重複 (Deduplication)<a hidden class="anchor" aria-hidden="true" href="#去重複-deduplication">#</a></h4>
<p>當開啟，去重複 (Deduplication) 功能會使用每個資料區塊的校驗碼 (Checksum) 來偵測重複的資料區塊，當新的資料區塊與現有的資料區塊重複，ZFS 便會寫入連接到現有資料的參考來替代寫入重複的資料區塊，這在資料中有大量重複的檔案或資訊時可以節省大量的空間，要注意的是：去重複功能需要使用大量的記憶體且大部份可節省的空間可改開啟壓縮功能來達成，而壓縮功能不需要使用額外的記憶體。</p>
<p>要開啟去重複功能，需在目標儲存池設定 <code>dedup</code> 屬性：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zfs set dedup=on pool</span>
</code></pre></div><p>只有要被寫入到儲存池的新資料才會做去重複的動作，先前已被寫入到儲存池的資料不會因此啟動了這個選項而做去重複。查看已開啟去重複屬性的儲存池會如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool list</span>
NAME  SIZE ALLOC  FREE   CKPOINT  EXPANDSZ   FRAG   CAP   DEDUP   HEALTH   ALTROOT
pool 2.84G 2.19M 2.83G         -         -     0%    0%   1.00x   ONLINE   -
</code></pre></div><p><code>DEDUP</code> 欄位會顯示儲存池的實際去重複率，數值為 <code>1.00x</code> 代表資料尚未被去重複。在下一個例子會在前面所建立的去重複儲存池中複製三份 Port 樹到不同的目錄中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># for d in dir1 dir2 dir3; do</span>
&gt; mkdir $d <span style="color:#f92672">&amp;&amp;</span> cp -R /usr/ports $d &amp;
&gt; <span style="color:#66d9ef">done</span>
</code></pre></div><p>已經偵測到重複的資料並做去重複：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zpool list</span>
NAME SIZE  ALLOC  FREE   CKPOINT  EXPANDSZ   FRAG  CAP   DEDUP   HEALTH   ALTROOT
pool 2.84G 20.9M 2.82G         -         -     0%   0%   3.00x   ONLINE   -
</code></pre></div><p><code>DEDUP</code> 欄位顯示有 <code>3.00x</code> 的去重複率，這代表已偵測到多份複製的 Port 樹資料並做了去重複的動作，且只會使用第三份資料所佔的空間。去重複能節省空間的潛力可以非常巨大，但會需要消耗大量的記憶體來持續追蹤去重複的資料區塊。</p>
<p>去重複並非總是有效益的，特別是當儲存池中的資料本身並沒有重複時。ZFS 可以透過在現有儲存池上模擬開啟去重複功能來顯示可能節省的空間：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># zdb -S pool</span>
Simulated DDT histogram:

bucket              allocated                       referenced
______   ______________________________   ______________________________
refcnt   blocks   LSIZE   PSIZE   DSIZE   blocks   LSIZE   PSIZE   DSIZE
------   ------   -----   -----   -----   ------   -----   -----   -----
     <span style="color:#ae81ff">1</span>    2.58M    289G    264G    264G    2.58M    289G    264G    264G
     <span style="color:#ae81ff">2</span>     206K   12.6G   10.4G   10.4G     430K   26.4G   21.6G   21.6G
     <span style="color:#ae81ff">4</span>    37.6K    692M    276M    276M     170K   3.04G   1.26G   1.26G
     <span style="color:#ae81ff">8</span>    2.18K   45.2M   19.4M   19.4M    20.0K    425M    176M    176M
    <span style="color:#ae81ff">16</span>      <span style="color:#ae81ff">174</span>   2.83M   1.20M   1.20M    3.33K   48.4M   20.4M   20.4M
    <span style="color:#ae81ff">32</span>       <span style="color:#ae81ff">40</span>   2.17M    222K    222K    1.70K   97.2M   9.91M   9.91M
    <span style="color:#ae81ff">64</span>        <span style="color:#ae81ff">9</span>     56K   10.5K   10.5K      <span style="color:#ae81ff">865</span>   4.96M    948K    948K
   <span style="color:#ae81ff">128</span>        <span style="color:#ae81ff">2</span>   9.50K      2K      2K      <span style="color:#ae81ff">419</span>   2.11M    438K    438K
   <span style="color:#ae81ff">256</span>        <span style="color:#ae81ff">5</span>   61.5K     12K     12K    1.90K   23.0M   4.47M   4.47M
    1K        <span style="color:#ae81ff">2</span>      1K      1K      1K    2.98K   1.49M   1.49M   1.49M
 Total    2.82M    303G    275G    275G    3.20M    319G    287G    287G

dedup <span style="color:#f92672">=</span> 1.05, compress <span style="color:#f92672">=</span> 1.11, copies <span style="color:#f92672">=</span> 1.00, dedup * compress / copies <span style="color:#f92672">=</span> 1.16
</code></pre></div><p>在 <code>zdb -S</code> 分析完儲存池後會顯示在啟動去重複後可達到的空間減少比例。在本例中，<code>1.16</code> 是非常差的空間節省比例，因為這個比例使用壓縮功能便能達成。若在此儲存池上啟動去重複並不能明顯的節省空間使用量，那麼就不值得耗費大量的記憶體來開啟去重複功能。透過公式 <em>ratio = dedup * compress / copies</em>，系統管理者可以規劃儲存空間的配置，來判斷要處理的資料是否有足夠的重複資料區塊來平衡所需的記憶體。若資料是可壓縮的，那麼空間節少的效果可能會非常好，建議先開啟壓縮功能，且壓縮功能也可以大大提高效能。去重複功能只有在可以節省可觀的空間且有足夠的記憶體做 DDT 時才開啟。</p>
<h4 id="zfs-與-jail">ZFS 與 Jail<a hidden class="anchor" aria-hidden="true" href="#zfs-與-jail">#</a></h4>
<p><code>zfs jail</code> 以及相關的 <code>jailed</code> 屬性可以用來將一個 ZFS 資料集委託給一個 <a href="https://docs.freebsd.org/zh-tw/books/handbook/jails/index.html#jails">Jail</a> 管理。<code>zfs jail *jailid*</code> 可以將一個資料集連結到一個指定的 Jail，而 <code>zfs unjail</code> 則可解除連結。資料集要可以在 Jail 中控制需設定 <code>jailed</code> 屬性，一旦資料集被隔離便無法再掛載到主機，因為有掛載點可能會破壞主機的安全性。</p>
<h3 id="委託管理">委託管理<a hidden class="anchor" aria-hidden="true" href="#委託管理">#</a></h3>
<p>一個全面性的權限委託系統可能無權限的使用者執行 ZFS 的管理功能。例如，若每個使用者的家目錄均為一個資料集，便可以給予使用者權限建立與摧毀它們家目錄中的快照。可以給予備份使用者使用備份功能的權限。一個使用量統計的 Script 可以允許其在執行時能存取所有使用者的空間利用率資料。甚至可以將委託權限委託給其他人，每個子指令與大多數屬性都可使用權限委託。</p>
<h4 id="委託資料集建立">委託資料集建立<a hidden class="anchor" aria-hidden="true" href="#委託資料集建立">#</a></h4>
<p><code>zfs allow someuser create mydataset</code> 可以給予指定的使用者在指定的父資料集下建立子資料集的權限。這裡需要注意：建立新資料集會牽涉到掛載，因此需要設定 FreeBSD 的 <code>vfs.usermount</code> <a href="https://www.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> 為 <code>1</code> 來允許非 root 的使用者掛載一個檔案系統。這裡還有另一項限制可以避免濫用：非 <code>root</code> 使用者必須擁有掛載點在檔案系統中所在位置的權限才可掛載。</p>
<h4 id="委託權限委託">委託權限委託<a hidden class="anchor" aria-hidden="true" href="#委託權限委託">#</a></h4>
<p><code>zfs allow someuser allow mydataset</code> 可以給予指定的使用者有權限指派它們在目標資料集或其子資料集上擁有的任何權限給其他人。若該使用者擁有 <code>snapshot</code> 權限及 <code>allow</code> 權限，則該使用者可以授權 <code>snapshot</code> 權限給其他使用者。</p>
<h3 id="進階主題">進階主題<a hidden class="anchor" aria-hidden="true" href="#進階主題">#</a></h3>
<h4 id="調校">調校<a hidden class="anchor" aria-hidden="true" href="#調校">#</a></h4>
<p>這裡有數個可調校的項目可以調整，來讓 ZFS 在面對各種工作都能以最佳狀況運作。</p>
<p>&hellip;</p>
<h5 id="i386-上的-zfs">i386 上的 ZFS<a hidden class="anchor" aria-hidden="true" href="#i386-上的-zfs">#</a></h5>
<p>ZFS 所提供的部份功能需要使用大量記憶體，且可能需要對有限 RAM 的系統調校來取得最佳的效率。</p>
<h5 id="記憶體">記憶體<a hidden class="anchor" aria-hidden="true" href="#記憶體">#</a></h5>
<p>最低需求，總系統記憶體應至少有 1 GB，建議的 RAM 量需視儲存池的大小以及使用的 ZFS 功能而定。一般的經驗法則是每 1 TB 的儲存空間需要 1 GB 的 RAM，若有開啟去重複的功能，一般的經驗法則是每 1 TB 的要做去重複的儲存空間需要 5 GB 的 RAM。雖然有部份使用者成功使用較少的 RAM 來運作 ZFS，但系統在負載較重時有可能會因為記憶用耗而導致當機，對於要使用低於建議 RAM 需求量來運作的系統可能會需要更進一步的調校。</p>
<h5 id="核心設定">核心設定<a hidden class="anchor" aria-hidden="true" href="#核心設定">#</a></h5>
<p>由於在 i386™ 平台上位址空間的限制，在 i386™ 架構上的 ZFS 使用者必須加入這個選項到自訂核心設定檔，重新編譯核心並重新開啟：</p>
<pre tabindex="0"><code>options KVA_PAGES=512
</code></pre><p>這個選項會增加核心位址空間，允許調整 <code>vm.kvm_size</code> 超出目前的 1 GB 限制或在 PAE 的 2 GB 限制。要找到這個選項最合適的數值，可以將想要的位址空間換算成 MB 然後除以 4，在本例中，以 2 GB 計算後即為 <code>512</code>。</p>
<h5 id="載入程式可調參數">載入程式可調參數<a hidden class="anchor" aria-hidden="true" href="#載入程式可調參數">#</a></h5>
<p>在所有的 FreeBSD 架構上均可增加 <strong>kmem</strong> 位址空間，經測試在一個 1 GB 實體記憶體的測試系統上，加入以下選項到 <strong>/boot/loader.conf</strong>，重新開啟系統，可成功設定：</p>
<pre tabindex="0"><code>vm.kmem_size=&quot;330M&quot;
vm.kmem_size_max=&quot;330M&quot;
vfs.zfs.arc_max=&quot;40M&quot;
vfs.zfs.vdev.cache.size=&quot;5M&quot;
</code></pre><p>要取得更多詳細的 ZFS 相關調校的建議清單，請參考 <a href="https://wiki.freebsd.org/ZFSTuningGuide">https://wiki.freebsd.org/ZFSTuningGuide</a>。</p>
<h3 id="其他資源">其他資源<a hidden class="anchor" aria-hidden="true" href="#其他資源">#</a></h3>
<ul>
<li><a href="https://wiki.freebsd.org/ZFS">FreeBSD Wiki - ZFS</a></li>
<li><a href="https://wiki.freebsd.org/ZFSTuningGuide">FreeBSD Wiki - ZFS Tuning</a></li>
<li><a href="http://wiki.illumos.org/display/illumos/ZFS">Illumos Wiki - ZFS</a></li>
<li><a href="http://docs.oracle.com/cd/E19253-01/819-5461/index.html">Oracle Solaris ZFS Administration Guide</a></li>
<li><a href="https://calomel.org/zfs_raid_speed_capacity.html">Calomel Blog - ZFS Raidz Performance, Capacity and Integrity</a></li>
</ul>
<h3 id="特色與術語">特色與術語<a hidden class="anchor" aria-hidden="true" href="#特色與術語">#</a></h3>
<p>ZFS 是一個從本質上與眾不同的檔案系統，由於它並非只是一個檔案系統，ZFS 結合了檔案系統及磁碟區管理程式，讓額外的儲存裝置可以即時的加入到系統並可讓既有的檔案系統立即使用這些在儲存池中空間。透過結合傳統區分為二的兩個角色，ZFS 能夠克服以往 RAID 磁碟群組無法擴充的限制。每個在儲存池頂層的裝置稱作 <em>vdev</em>，其可以是一個簡單的磁碟或是一個 RAID 如鏡像或 RAID-Z 陣列。ZFS 的檔案系統 (稱作 <em>資料集 (Dataset)</em>) 每一個資料集均可存取整個存池所共通的可用空間，隨著使用儲存池來配置空間區塊，儲存池能給每個檔案系統使用的可用空間就會減少，這個方法可以避免擴大分割區會使的可用空間分散分割區之間的常見問題。</p>
<table>
<thead>
<tr>
<th>術語</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>儲存池 (Pool)</td>
<td><em>儲存池 (Pool)</em> 是建構 ZFS 最基礎的單位。一個儲存池可由一個或多個 vdev 所組成，是用來儲存資料的底層裝置。儲存池會被拿來建立一個或多個檔案系統 (資料集 Dataset) 或區塊裝置 (磁碟區 Volume)，這些資料集與磁碟區會共用儲存池的剩餘可用空間。每一個儲存池可由名稱與 GUID 來辨識。可用的功能會依儲存池上的 ZFS 版本而有不同。</td>
</tr>
<tr>
<td>vdev 型態 (vdev Types)</td>
<td>儲存池是由一個或多個 vdev 所組成，vdev 可以是一個磁碟或是 RAID Transform 的磁碟群組。當使用多個 vdev，ZFS 可以分散資料到各個 vdev 來增加效能與最大的可用空間。<em>磁碟 (Disk)</em> - 最基本的 vdev 型態便是一個標準的資料區塊裝置，這可以是一整個磁碟 (例如 <strong>/dev/ada0</strong> 或 <strong>/dev/da0</strong>) 或一個分割區 (<strong>/dev/ada0p3</strong>)。在 FreeBSD 上，使用分割區來替代整個磁碟不會影響效能，這可能與 Solaris 說明文件所建議的有所不同。<em>檔案 (File)</em> - 除了磁碟外，ZFS 儲存池可以使用一般檔案為基礎，這在測試與實驗時特別有用。在 <code>zpool create</code> 時使用檔案的完整路徑作為裝置路徑。所有 vdev 必須至少有 128 MB 的大小。<em>鏡像 (Mirror)</em> - 要建立鏡像，需使用 <code>mirror</code> 關鍵字，後面接著要做為該鏡像成員裝置的清單。一個鏡像需要由兩個或多個裝置來組成，所有的資料都會被寫入到所有的成員裝置。鏡像 vdev 可以對抗所有成員故障只剩其中一個而不損失任何資料。正常單一磁碟的 vdev 可以使用 <code>zpool attach</code> 隨時升級成為鏡像 vdev。<em>RAID-Z</em> - ZFS 實作了 RAID-Z，以標準的 RAID-5 修改而來，可提供奇偶校驗 (Parity) 更佳的分散性並去除了 &ldquo;RAID-5 write hole&rdquo; 導致在預期之外的重啟後資料與奇偶校驗資訊不一致的問題。ZFS 支援三個層級的 RAID-Z，可提供不同程度的備援來換取減少不同程度的可用空間，類型的名稱以陣列中奇偶校驗裝置的數量與儲存池可以容許磁碟故障的數量來命名，從 RAID-Z1 到 RAID-Z3 。在 RAID-Z1 配置 4 個磁碟，每個磁碟 1 TB，可用的儲存空間則為 3 TB，且若其中一個磁碟故障仍可以降級 (Degraded) 的模式運作，若在故障磁碟尚未更換並修復 (Resilver) 之前又有磁碟故障，所有在儲存池中的資料便會遺失。在 RAID-Z3 配置 8 個 1 TB 的磁碟，磁碟區將會可以提供 5 TB 的可用空間且在 3 個磁碟故障的情況下仍可運作。Sun™ 建議單一個 vdev 不要使用超過 9 個磁碟。若配置需要使用更多磁碟，建議分成兩個 vdev，這樣儲存池的資料便會分散到這兩個 vdev。使用兩個 RAID-Z2 各由 8 個磁碟組成的 vdev 的配置可以建立一個類似 RAID-60 的陣列。RAID-Z 群組的儲存空量會接近其中最小的磁碟乘上非奇偶校驗磁碟的數量。4 個 1 TB 磁碟在 RAID-Z1 會有接近 3 TB 的實際大小，且一個由 8 個 1 TB 磁碟組成的 RAID-Z3 陣列會有 5 TB 的可用空間。<em>備援 (Spare)</em> - ZFS 有特殊的虛擬 vdev 型態可用來持續追蹤可用的熱備援裝置 (Hot spare)。注意，安裝的熱備援裝置並不會自動佈署，熱備援裝置需要手動使用 <code>zfs replace</code> 設定替換故障的裝置。<em>日誌 (Log)</em> - ZFS 記錄裝置，也被稱作 ZFS 意圖日誌 (ZFS Intent Log, <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-zil">ZIL</a>) 會從正常的儲存池裝置移動意圖日誌到獨立的裝置上，通常是一個 SSD。有了獨立的日誌裝置，可以明顯的增進有大量同步寫入應用程式的效能，特別是資料庫。日誌裝置可以做成鏡像，但不支援 RAID-Z，若使用多個日誌裝置，寫入動作會被負載平衡分散到這些裝置。<em>快取 (Cache)</em> - 加入快取 vdev 到儲存池可以增加儲存空間的 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-l2arc">L2ARC</a> 快取。快取裝置無法做鏡像，因快取裝置只會儲存額外的現有資料的複本，並沒有資料遺失的風險。</td>
</tr>
<tr>
<td>交易群組 (Transaction Group, TXG)</td>
<td>交易群組是一種將更動的資料區塊包裝成一組的方式，最後再一次寫入到儲存池。交易群組是 ZFS 用來檢驗一致性的基本單位。每個交易群組會被分配一個獨一無二的 64-bit 連續代號。最多一次可以有三個活動中的交易群組，這三個交易群組的每一個都有這三種狀態：* <em>開放 (Open)</em> - 新的交易群組建立之後便處於開放的狀態，可以接受新的寫入動作。永遠會有開放狀態的交易群組，即始交易群組可能會因到達上限而拒絕新的寫入動作。一但開放的交易群組到達上限或到達 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-advanced-tuning-txg-timeout"><code>vfs.zfs.txg.timeout</code></a>，交易群組便會繼續進入下一個狀態。 * <em>靜置中 (Quiescing)</em> - 一個短暫的狀態，會等候任何未完成的操作完成，不會阻擋新開放的交易群組建立。一旦所有在群組中的交易完成，交易群組便會進入到最終狀態。 * <em>同步中 (Syncing)</em> - 所有在交易群組中的資料會被寫任到穩定的儲存空間，這個程序會依序修改其他也需同樣寫入到穩定儲存空間的資料，如 Metadata 與空間對應表。同步的程多會牽涉多個循環，首先是同步所有更改的資料區塊，也是最大的部份，接著是 Metadata，這可能會需要多個循環來完成。由於要配置空間供資料區塊使用會產生新的 Metadata，同步中狀態在到達循環完成而不再需要分配任何額外空間的狀態前無法結束。同步中狀態也是完成 <em>synctask</em> 的地方，Synctask 是指管理操作，如：建立或摧毀快照與資料集，會修改 uberblock，也會在此時完成。同步狀態完成後，其他處於狀態中狀態的交易群組便會進入同步中狀態。 所有管理功能如快照 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-snapshot"><code>Snapshot</code></a>) 會作為交易群組的一部份寫入。當 synctask 建立之後，便會加入到目前開放的交易群組中，然後該群組會盡快的進入同步中狀態來減少管理指令的延遲。</td>
</tr>
<tr>
<td>Adaptive Replacement Cache (ARC)</td>
<td>ZFS 使用了自適應替換快取 (Adaptive Replacement Cache, ARC)，而不是傳統的最近最少使用 (Least Recently Used, LRU) 快取，LRU 快取在快取中是一個簡單的項目清單，會依每個物件最近使用的時間來排序，新項會加入到清單的最上方，當快取額滿了便會去除清單最下方的項目來空出空間給較常使用的物件。ARC 結合了四種快取清單，最近最常使用 (Most Recently Used, MRU) 及最常使用 (Most Frequently Used, MFU) 物件加上兩個清單各自的幽靈清單 (Ghost list)，這些幽靈清單會追蹤最近被去除的物件來避免又被加回到快取，避免過去只有偶爾被使用的物件加入清單可以增加快取的命中率。同時使用 MRU 及 MFU 的另外一個優點是掃描一個完整檔案系統可以去除在 MRU 或 LRU 快取中的所有資料，有利於這些才剛存取的內容。使用 ZFS 也有 MFU 可只追蹤最常使用的物件並保留最常被存取的資料區塊快取。</td>
</tr>
<tr>
<td>L2ARC</td>
<td>L2ARC 是 ZFS 快取系統的第二層，主要的 ARC 會儲存在 RAM 當中，但因為 RAM 可用的空間量通常有限，因此 ZFS 也可以使用 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-vdev-cache">快取 vdev (Cache vdev)</a>。固態磁碟 (Solid State Disk, SSD) 常被拿來此處作為快取裝置，因為比起傳統旋轉碟片的磁碟，固態磁碟有較快的速度與較低的延遲。L2ARC 是選用的，但使用可以明顯增進那些已使用 SSD 快取的檔案讀取速度，無須從一般磁碟讀取。L2ARC 也同樣可以加速去重複 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-deduplication">Deduplication</a>)，因為 DDT 並不適合放在 RAM，但適合放在 L2ARC，比起要從磁碟讀取，可以加快不少速度。為了避免 SSD 因寫入次速過多而過早耗損，加入到快取裝置的資料速率會被限制，直到快取用盡 (去除第一個資料區塊來騰出空間) 之前，寫入到 L2ARC 的資料速率會限制在寫入限制 (Write limit) 與加速限制 (Boost limit) 的總合，之後則會限制為寫入限制，可以控制這兩個速度限制的 <a href="https://www.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> 數值分別為 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-advanced-tuning-l2arc_write_max"><code>vfs.zfs.l2arc_write_max</code></a> 控制每秒有多少數位元組可寫入到快取，而 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-advanced-tuning-l2arc_write_boost"><code>vfs.zfs.l2arc_write_boost</code></a> 可在 &ldquo;渦輪預熱階段&rdquo; (即寫入加速) 時增加寫入限制。</td>
</tr>
<tr>
<td>ZIL</td>
<td>ZIL 會使用比主要儲存池還更快的儲存裝置來加速同步寫入動作 (Synchronous transaction)，如 SSD。當應用程式請求做一個同步的寫入時 (保証資料會安全的儲存到磁碟，而不是先快取稍後再寫入)，資料會先寫入到速度較快的 ZIL 儲存空間，之後再一併寫入到一般的磁碟。這可大量的減少延遲並增進效能。ZIL 只會有利於使用像資料庫這類的同步工作，一般非同步的寫入像複製檔案，則完全不會用到 ZIL。</td>
</tr>
<tr>
<td>寫入時複製 (Copy-On-Write)</td>
<td>不像傳統的檔案系統，在 ZFS，當資料要被覆寫時，不會直接覆寫舊資料所在的位置，而是將新資料會寫入到另一個資料區塊，只在資料寫入完成後才會更新 Metadata 指向新的位置。因此，在發生寫入中斷 (在寫入檔案的過程中系統當機或電源中斷) 時，原來檔案的完整內容並不會遺失，只會放棄未寫入完成的新資料，這也意謂著 ZFS 在發生預期之外的關機後不需要做 <a href="https://www.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a>。</td>
</tr>
<tr>
<td>資料集 (Dataset)</td>
<td><em>資料集 (Dataset)</em> 是 ZFS 檔案系統、磁碟區、快照或複本的通用術語。每個資料集都有獨一無二的名稱使用 <em>poolname/path@snapshot</em> 格式。儲存池的根部技術上來說也算一個資料集，子資料集會採用像目錄一樣的層級來命名，例如 <em>mypool/home</em>，home 資料集是 <em>mypool</em> 的子資料集並且會繼承其屬性。這可以在往後繼續擴展成 <em>mypool/home/user</em>，這個孫資料集會繼承其父及祖父的屬性。在子資料集的屬性可以覆蓋預設繼承自父及祖父的屬性。資料集及其子資料級的管理權限可以委託 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-zfs-allow">Delegate</a>) 給他人。</td>
</tr>
<tr>
<td>檔案系統 (File system)</td>
<td>ZFS 資料集最常被當做檔案系統使用。如同大多數其他的檔案系統，ZFS 檔案系統會被掛載在系統目錄層級的某一處且內含各自擁有權限、旗標及 Metadata 的檔案與目錄。</td>
</tr>
<tr>
<td>磁碟區 (Volume)</td>
<td>除了一般的檔案系統資料集之外，ZFS 也可以建立磁碟區 (Volume)，磁碟區是資料區塊裝置。磁碟區有許多與資料集相似的功能，包含複製時寫入、快照、複本以及資料校驗。要在 ZFS 的頂層執行其他檔案系統格式時使用磁碟區非常有用，例如 UFS 虛擬化或匯出 iSCSI 延伸磁區 (Extent)。</td>
</tr>
<tr>
<td>快照 (Snapshot)</td>
<td>ZFS 的寫入時複製 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-cow">Copy-On-Write</a>, COW) 設計可以使用任意的名稱做到幾乎即時、一致的快照。在製做資料集的快照或父資料集遞迴快照 (會包含其所有子資料集) 之後，新的資料會寫入到資的資料區塊，但不會回收舊的資料區塊為可用空間，快照中會使用原版本的檔案系統，而快照之後所做的變更則會儲存在目前的檔案系統，因此不會重複使用額外的空間。當新的資料寫入到目前的檔案系統，便會配置新的資料區塊來儲存這些資料。快照表面大小 (Apparent size) 會隨著在目前檔案系統停止使用的資料區塊而成長，但僅限於快照。可以用唯讀的方式掛載這些快照來復原先前版本的檔案，也可以還原 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-zfs-snapshot">Rollback</a>) 目前的檔案系統到指定的快照，來還原任何在快照之後所做的變更。每個在儲存池中的資料區塊都會有一個參考記數器，可以用來持續追蹤有多少快照、複本、資料集或是磁碟區使用這個資料區塊，當刪除檔案與快照參照的計數變會滅少，直到沒有任何東西參考這個資料區塊才會被回收為可用空間。快照也可使用 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-zfs-snapshot">hold</a> 來標記，檔標記為 hold 時，任何嘗試要刪除該快照的動作便會回傳 <code>EBUSY</code> 的錯誤，每個快照可以標記多個不同唯一名稱的 hold，而 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-zfs-snapshot">release</a> 指令則可以移除 hold，這樣才可刪除快照。在磁碟區上快可以製作快照，但只能用來複製或還原，無法獨立掛載。</td>
</tr>
<tr>
<td>複本 (Clone)</td>
<td>快照也可以做複本，複本是可寫入版本的快照，讓檔案系統可分支成為新的資料集。如同快照，複本一開始不會消耗任何額外空間，隨著新資料寫入到複本會配置新的資料區塊，複本的表面大小 (Apparent size) 才會成長，當在複本檔案系統或磁碟區的資料區塊被覆寫時，在先前資料區塊的參考計數則會減少。建立複本所使用的快照無法被刪除，因為複本會相依該快照，快照為父，複本為子。複本可以被提升 (<em>promoted</em>)、反轉相依關係，來讓複本成為父，之前的父變為子，這個操作不需要額外的空間。由於反轉了父與子使用的空間量，所以可能會影響既有的配額 (Quota) 與保留空間 (Reservation)。</td>
</tr>
<tr>
<td>校驗碼 (Checksum)</td>
<td>配置每個資料區塊快的同時也會做資料校驗，資料校驗用的演算法是依資料集屬性而有所不同的，請參考 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-zfs-set"><code>set</code></a>。每個資料區塊會在讀取的過成便完成校驗，讓 ZFS 可以偵測到隱藏的損壞，若資料不符合預期的校驗碼，ZFS 會嘗試從任何可用的備援來還原資料，例如鏡像 (Mirror) 或 RAID-Z。要檢驗所有資料的校驗碼可以使用清潔 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-scrub"><code>Scrub</code></a>)，資料校驗的演算法有：* <code>fletcher2</code> * <code>fletcher4</code> * <code>sha256</code> <code>fletcher</code> 演算法最快，而 <code>sha256</code> 雖較消耗效能，但其有強大的密碼雜湊與較低的衝突率。也可關閉資料校驗，但並不建議。</td>
</tr>
<tr>
<td>壓縮 (Compression)</td>
<td>每個資料集都有壓縮 (Compression) 屬性，預設是關閉的，這個屬性可以設定使用以下幾個壓縮演算法的其中一個來壓縮寫入到資料集的新資料。壓縮除了減少空間使用量外，常也會增加讀取與寫入的吞吐量，因為會減少讀取與寫入的資料區塊。* <em>LZ4</em> - ZFS 儲存池版本 5000 (功能旗標) 後所增加，LZ4 現在是建議的壓縮演算法，在處理可壓縮的資料時 LZ4 壓縮比 LZJB 快將近 50%，在處理不可壓縮的資料時快將近三倍，LZ4 解壓縮也比 LZJB 將近 80%。在現代的 CPU 上，LZ4 經常平均可用 500 MB/s 的速度壓縮，而解壓縮可到達 1.5 GB/s (每個 CPU 核心)。* <em>LZJB</em> - 預設的壓縮演算法。由 Jeff Bonwick 所開發 (ZFS 的創始人之一)。LZJB 與 GZIP 相比，可以較低的 CPU 提供較佳的壓縮功能。在未來預設的壓縮演算法將會更換為 LZ4。* <em>GZIP</em> - 在 ZFS 可用的熱門串流壓縮演算法。使用 GZIP 主要的優點之一便是可設定壓縮層級。當設定 <code>compress</code> 屬性，管理者可以選擇壓縮層級範圍從最低的壓縮層級 <code>gzip1</code> 到最高的壓縮層級 <code>gzip9</code>。這讓管理者可以控制要使用多少 CPU 來節省磁碟空間。* <em>ZLE</em> - 零長度編號是一個特殊的壓縮演算法，它只會壓縮連續的零。這種壓縮演算法只在資料集中含有大量為零的資料區塊時有用。</td>
</tr>
<tr>
<td>備份數 (Copies)</td>
<td>當設定大於 1 的數值時，<code>copies</code> 屬性會指示 ZFS 備份每個在檔案系統 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-filesystem">File System</a>) 或磁碟區 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-volume">Volume</a>) 的資料區塊數份。在重要的資料集上設定這個屬性可以做額外的備援以在資料校驗碼不相符時可做復原。在沒有做備援的儲存池上，備份功能提供只是一種資料的備援方式，備份功能可以復原單一壞軌或其他情況的次要損壞，但無法復原儲存池中整個磁碟損壞所損失的資料。</td>
</tr>
<tr>
<td>去重複 (Deduplication)</td>
<td>校驗碼讓在寫入時可以偵測重複資料區塊，使用去重複，可以增加既有、完全相同的資料區塊參考數來節省儲存空間。要偵測重複的資料區塊需要在記憶體中儲存去重複資料表 (Deduplication table, DDT)，這個資料表中會有唯一的校驗碼清單、這些資料區塊的所在位置以及參考數。當寫入新資料時，便會計算校驗碼然後比對清單中是否有符合的既有資料區塊已在清單。去重複使用了 SHA256 校驗碼演算法來提供一個安全的加密雜湊，去重複功能是可以調校的，若 <code>dedup</code> 設為 <code>on</code> 只要符合校驗碼便會認為資料完全相同，若 <code>dedup</code> 設為 <code>verify</code> 則會一個一個位元檢查兩個資料區塊的資料來確保資料真的完全相同，若資料不同便會註記與雜湊衝突並會分別儲存兩個資料區塊。由於 DDT 須要儲存每個唯一資料區塊的雜湊，所以會消耗大量的記憶體，一般的經驗法則是每 1 TB 的去重複資料需要使用 5-6 GB 的記憶體。由於要有足夠的 RAM 來儲存整個 DDT 在實務上並不實際，導致在每個新資料區塊寫入前需要從磁碟來讀取 DDT 會對效能有很大的影響，去重複功能可以使用 L2ARC 儲存 DDT 以在快速的系統記憶體及較慢的磁碟之間取得一個平衡點。也可以考慮使用壓縮功能來取代此功能，因為壓縮也能節省相近的空間使用量而不需要大量額外的記憶體。</td>
</tr>
<tr>
<td>清潔 (Scrub)</td>
<td>ZFS 有 <code>scrub</code> 來替代 <a href="https://www.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a> 來做一致性的檢查。<code>scrub</code> 會讀取所有儲存在儲存池中的資料區塊並且根據儲存在 Metadata 中已知良好的校驗碼來檢驗這些資料區塊的校驗碼，定期檢查儲存池中儲存的所有資料可以確保實際使用這些資料前已將所有損壞的資料區塊復原。在不正常的關閉之後並不需要做清潔動作，但建議每三個月至少執行一次。在正常使用讀取時便會檢查每個資料區塊的校驗碼，但清潔動作可以確保那些不常用的資料也會被檢查以避免隱藏的損壞，如此便能增進資料的安全性，特別是對用來保存資料的儲存裝置。<code>scrub</code> 可以使用 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-advanced-tuning-scrub_delay"><code>vfs.zfs.scrub_delay</code></a> 調整相對優先權來避免清潔動作降低儲存池上其他工作的效率。</td>
</tr>
<tr>
<td>資料集配額 (Dataset Quota)</td>
<td>除了配額及空間保留外，ZFS 提供非常快速且準確的資料集、使用者及群組空間的計算功能，這可讓管理者調整空間配置的方式且可為重要的檔案系統保留空間。ZFS supports different types of quotas: the dataset quota, the <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-refquota">reference quota (refquota)</a>, the <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-userquota">user quota</a>, and the <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-groupquota">group quota</a>.配額會限制資料集及後裔包含資料集的快照、子資料集及子資料集的快照能使用的空間量。磁碟區上無法設定配額，因為 <code>volsize</code> 屬性已經被用來做內定的配額。</td>
</tr>
<tr>
<td>參考配額 (Reference Quota)</td>
<td>參考配額可以設定一個硬性限制 (Hard limit) 來限制資料集能使用的空間量，而這個硬性限制只包含了資料集參考的空間，並不含其後裔所使用的空間，如：檔案系統或快照。</td>
</tr>
<tr>
<td>使用者配額 (User Quota)</td>
<td>使用者配額在用來限制特定使用者能使用的空間量時非常有用。</td>
</tr>
<tr>
<td>群組配額 (Group Quota)</td>
<td>群組配額可以限制特定群組能使用的空間量。</td>
</tr>
<tr>
<td>資料集保留空間 (Dataset Reservation)</td>
<td><code>reservation</code> 屬性可以確保對特定資料集及其後裔最小可用的空間量，若在 <strong>storage/home/bob</strong> 設定 10 GB 的保留空間且其他資料集嘗試使用所有剩餘的空間時，會保留至少 10 GB 的空間供這個資料集使用。若要製作 <strong>storage/home/bob</strong> 的快照，該快照所使用的空間也會被列入保留空間計算。 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-refreservation"><code>refreservation</code></a> 屬性也以類似的方式運作，但是他 <em>不包含</em> 後裔，例如：快照。不管那一種保留空間在許多情境皆很有用，例如：要規劃與測試磁碟空間配置在新系統上的適應性，或是確保有足夠的空間供稽查日誌或系統還原程序及檔案使用。</td>
</tr>
<tr>
<td>參考保留空間 (Reference Reservation)</td>
<td><code>refreservation</code> 屬性可以確保對特定資料集 <em>不包含</em> 其後裔最小可用的空間，這代表若在 <strong>storage/home/bob</strong> 設定 10 GB 的保留空間且其他資料集嘗試使用所有剩餘的空間時，會保留至少 10 GB 的空間供這個資料集使用。於正常 <a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-reservation">reservation</a> 不同的是，由快照及後裔資料集所使用的空間並不會列入保留空間計算。例如，若要製作一個 <strong>storage/home/bob</strong> 的快照，在 <code>refreservation</code> 空間之外必須要有足夠的空間才能成功完成這項操作，主資料集的後裔並不會列入 <code>refreservation</code> 空間額計算，所以也不會佔用保留空間。</td>
</tr>
<tr>
<td>修復 (Resilver)</td>
<td>當有磁碟故障且被更換後，新的磁碟必須回存先前所遺失的資料，會使用分散在其他磁碟上的奇偶校驗資訊來計算並寫入遺失的資料到新的磁碟機的這個程序稱作 <em>修復 (Resilvering)</em>。</td>
</tr>
<tr>
<td>上線 (Online)</td>
<td>一個儲存池或 vdev 處於線上 (<code>Online</code>) 狀態時代表所有該裝置的成員均已連結且正常運作。個別裝置處於線上 (<code>Online</code>) 狀態時代表功能正常。</td>
</tr>
<tr>
<td>離線 (Offline)</td>
<td>若有足夠的備援可避免儲存池或 vdev 進入故障 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-faulted">Faulted</a>) 狀態，個別裝置若可由管理者設為離線 (<code>Offline</code>) 狀態，管理者可以選擇要設定那一個磁碟為離線來準備更換或是讓其更容易辨識。</td>
</tr>
<tr>
<td>降級 (Degraded)</td>
<td>一個儲存池或 vdev 處於降級 (<code>Degraded</code>) 狀態代表其有一個或多個磁碟已斷線或故障，此時儲存池仍可以使用，但只要再有其他的裝置故障，儲存池會無法復原。重新連線缺少的裝置或更換故障的磁碟，並在新裝置完成修復 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-resilver">Resilver</a>) 程序可讓儲存池返回線上 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-online">Online</a>) 狀態。</td>
</tr>
<tr>
<td>故障 (Faulted)</td>
<td>一個儲存池或 vdev 處於故障 (<code>Faulted</code>) 狀態代表無法運作，會無法存取在該裝置上的資料。當在 vdev 中缺少或故障的裝置數超過備援的層級，儲存池或 vdev 會進入故障 (<code>Faulted</code>) 狀態。若缺少的裝置可以重新連結上，儲存池便會返回線上 (<a href="https://docs.freebsd.org/zh-tw/books/handbook/zfs/#zfs-term-online">Online</a>) 狀態。若沒有足夠的備援可補償故障的磁碟數量便會遺失儲存池中的內容且只能從備份還原。</td>
</tr>
</tbody>
</table>
<h2 id="gentoo-on-zfshttpswikigentooorgwikiuserali3nxinstalling_gentoo_linux_efistub_on_zfs"><a href="https://wiki.gentoo.org/wiki/User:Ali3nx/Installing_Gentoo_Linux_EFISTUB_On_ZFS">Gentoo on ZFS</a><a hidden class="anchor" aria-hidden="true" href="#gentoo-on-zfshttpswikigentooorgwikiuserali3nxinstalling_gentoo_linux_efistub_on_zfs">#</a></h2>
<h3 id="备份httpswwwyafamoepostbackup-your-gentoo-system"><a href="https://www.yafa.moe/post/backup-your-gentoo-system/">备份</a><a hidden class="anchor" aria-hidden="true" href="#备份httpswwwyafamoepostbackup-your-gentoo-system">#</a></h3>
<h4 id="初始化硬盘">初始化硬盘<a hidden class="anchor" aria-hidden="true" href="#初始化硬盘">#</a></h4>
<p>这里的初始化硬盘是为了将原来的数据全部清除并且重新建立LUKS和文件系统。出于安全的考虑，备份不应该直接在硬盘上分区创建文件系统后备份在上面，应该做一层加密再去创建文件系统和备份。</p>
<p>将硬盘插入需要备份的电脑上</p>
<p>查看新增的设备</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fdisk -l
Disk /dev/sda: 232.9 GiB, <span style="color:#ae81ff">250055122432</span> bytes, <span style="color:#ae81ff">488388911</span> sectors
Disk model: 00AAJS-00B4A0
Units: sectors of <span style="color:#ae81ff">1</span> * 512 <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span> bytes
Sector size <span style="color:#f92672">(</span>logical/physical<span style="color:#f92672">)</span>: <span style="color:#ae81ff">512</span> bytes / <span style="color:#ae81ff">512</span> bytes
I/O size <span style="color:#f92672">(</span>minimum/optimal<span style="color:#f92672">)</span>: <span style="color:#ae81ff">512</span> bytes / <span style="color:#ae81ff">512</span> bytes
Disklabel type: dos
Disk identifier: 0x80f01a9c

Device     Boot Start       End   Sectors   Size Id Type
/dev/sda1        <span style="color:#ae81ff">2048</span> <span style="color:#ae81ff">488388910</span> <span style="color:#ae81ff">488386863</span> 232.9G <span style="color:#ae81ff">83</span> Linux
</code></pre></div><p>这里可以看到新添加的磁盘，上面是有以前的东西，这里为了安全起见用随机数据覆盖掉这个分区。 这里会清除可能存在的任何没有加密的旧数据，如果遭受攻击这会让攻击者更难确定数据位置，这一步会很慢（取决于你的接口速度和硬盘速率）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>/dev/urandom of<span style="color:#f92672">=</span>/dev/sda bs<span style="color:#f92672">=</span>1M status<span style="color:#f92672">=</span>progress <span style="color:#f92672">&amp;&amp;</span> sync
</code></pre></div><p>完成之后，我们需要重新对这个硬盘进行分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo fdisk /dev/sda

Welcome to fdisk <span style="color:#f92672">(</span>util-linux 2.35.2<span style="color:#f92672">)</span>.
Changes will remain in memory only, <span style="color:#66d9ef">until</span> you decide to write them.
Be careful before using the write command.


Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>: n
Partition type
   p   primary <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> primary, <span style="color:#ae81ff">0</span> extended, <span style="color:#ae81ff">4</span> free<span style="color:#f92672">)</span>
   e   extended <span style="color:#f92672">(</span>container <span style="color:#66d9ef">for</span> logical partitions<span style="color:#f92672">)</span>
Select <span style="color:#f92672">(</span>default p<span style="color:#f92672">)</span>:

Using default response p.
Partition number <span style="color:#f92672">(</span>1-4, default 1<span style="color:#f92672">)</span>:
First sector <span style="color:#f92672">(</span>2048-488388910, default 2048<span style="color:#f92672">)</span>:
Last sector, +/-sectors or +/-size<span style="color:#f92672">{</span>K,M,G,T,P<span style="color:#f92672">}</span> <span style="color:#f92672">(</span>2048-488388910, default 488388910<span style="color:#f92672">)</span>:

Created a new partition <span style="color:#ae81ff">1</span> of type <span style="color:#e6db74">&#39;Linux&#39;</span> and of size 232.9 GiB.

Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>: w
The partition table has been altered.
Calling ioctl<span style="color:#f92672">()</span> to re-read partition table.
Syncing disks.
</code></pre></div><p>这样就创建了一个分区，接下来我们要在这个分区上创建LUKS</p>
<h4 id="创建-luks">创建 LUKS<a hidden class="anchor" aria-hidden="true" href="#创建-luks">#</a></h4>
<p>我们这里可以使用<code>cryptsetup</code>这个命令来初始化我们的LUKS分区</p>
<p>如果你没有这个命令可以运行这条命令进行安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ emerge -av cryptsetup
</code></pre></div><p>然后初始化分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo cryptsetup luksFormat /dev/sda1
WARNING!
<span style="color:#f92672">========</span>
This will overwrite data on /dev/sda1 irrevocably.

Are you sure? <span style="color:#f92672">(</span>Type <span style="color:#e6db74">&#39;yes&#39;</span> in capital letters<span style="color:#f92672">)</span>: YES
Enter passphrase <span style="color:#66d9ef">for</span> /dev/sda1:
Verify passphrase:
</code></pre></div><p>这里会提示这个操作将会将这个分区里面的内容全部删掉，输入大写的YES确认，然后输入两次密码，注意密码是没有回显的。</p>
<h4 id="打开-luks-和创建文件系统">打开 LUKS 和创建文件系统<a hidden class="anchor" aria-hidden="true" href="#打开-luks-和创建文件系统">#</a></h4>
<p>现在是LUKS已经做好了，但是我们还需要在上面格式化分区才能够挂载使用，我们首先要打开LUKS分区：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo cryptsetup luksOpen /dev/sda1 backup
Password:
Enter passphrase <span style="color:#66d9ef">for</span> /dev/sda1:
</code></pre></div><p>我这里是想打开这个LUKS卷，为了区分和其他的我给这个名字叫做backup，然后会提示你输入LUKS的密码，正确输入之后就可以在<code>/dev/mappaer</code>下面看到一个<code>backup</code>的设备了</p>
<p>现在对这个分区进行格式化，这次用的是ext4的分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo mkfs.ext4 -v /dev/mapper/backup
</code></pre></div><h4 id="创建挂载点和挂载">创建挂载点和挂载<a hidden class="anchor" aria-hidden="true" href="#创建挂载点和挂载">#</a></h4>
<p>在完成了分区初始化之后我们还需要创建一个挂载点用于挂载这个备份的分区:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo mkdir -pv /backup
</code></pre></div><p>挂载分区:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo mount -v /dev/mapper/backup /backup
</code></pre></div><h4 id="备份系统">备份系统<a hidden class="anchor" aria-hidden="true" href="#备份系统">#</a></h4>
<p>下载就可以备份系统了，这次使用的是<code>rsync</code>工具来进行备份系统：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo rsync -aAXv --exclude<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;/dev/*&#34;</span>,<span style="color:#e6db74">&#34;/proc/*&#34;</span>,<span style="color:#e6db74">&#34;/sys/*&#34;</span>,<span style="color:#e6db74">&#34;/tmp/*&#34;</span>,<span style="color:#e6db74">&#34;/run/*&#34;</span>,<span style="color:#e6db74">&#34;/mnt/*&#34;</span>,<span style="color:#e6db74">&#34;/media/*&#34;</span>,<span style="color:#e6db74">&#34;/lost+found&#34;</span>,<span style="color:#e6db74">&#34;/backup/*&#34;</span>,<span style="color:#e6db74">&#34;/swapfile&#34;</span><span style="color:#f92672">}</span> / /backup
</code></pre></div><p>这里使用的<code>-aAXv</code>选项的意思是：文件将会以归档模式传输，保留符号设备，文件权限，修改时间，ACL和扩展属性，并且将备份的过程打印在屏幕上。</p>
<p><code>--exclude</code>就是排除特定的文件类似于<code>/dev</code>、<code>/proc</code>之类的，<code>/backup</code>是我们的备份分区不需要再去搞一份防止出现奇奇怪怪的后果。</p>
<p>这会耗费很多时间可以休息一下做其他的事情。</p>
<p>等待这个备份完成之后我们就可以卸载这块硬盘进行保存了。</p>
<p>卸载挂载点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ umount /backup
</code></pre></div><p>关闭LUKS分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cryptsetup luksClose backup
</code></pre></div><h3 id="迁移到-zfshttpswwwyafamoepostgentoo-on-zfs"><a href="https://www.yafa.moe/post/gentoo-on-zfs/">迁移到 ZFS</a><a hidden class="anchor" aria-hidden="true" href="#迁移到-zfshttpswwwyafamoepostgentoo-on-zfs">#</a></h3>
<h4 id="分区">分区<a hidden class="anchor" aria-hidden="true" href="#分区">#</a></h4>
<p>首先我需要把之前的分区全部干掉，然后创建如下表的分区：</p>
<table>
<thead>
<tr>
<th>分区</th>
<th>文件系统</th>
<th>大小</th>
</tr>
</thead>
<tbody>
<tr>
<td>/dev/nvme0n1p1</td>
<td>fat32</td>
<td>128M</td>
</tr>
<tr>
<td>/dev/nvme0n1p2</td>
<td>swap</td>
<td>64G</td>
</tr>
<tr>
<td>/dev/nvme0n1p3</td>
<td>ZFS</td>
<td>ALL</td>
</tr>
</tbody>
</table>
<p>直接在系统里面丢swapfile是不合理的，最好是有个单独的分区给swap。</p>
<h5 id="初始化分区">初始化分区<a hidden class="anchor" aria-hidden="true" href="#初始化分区">#</a></h5>
<p>创建完成分区之后我们还需要对分区进行初始化：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkfs.vfat -F32 /dev/nvme0n1p1
$ mkswap /dev/nvme0n1p2
</code></pre></div><h5 id="创建-pool">创建 pool<a hidden class="anchor" aria-hidden="true" href="#创建-pool">#</a></h5>
<p>这里需要注意一点是像是我们之前分区的<code>/dev/nvme0n</code>这种设备或者是<code>/dev/sda</code>这样的，如果插拔U盘之类的可能盘序会发生变化，但是ZFS池是不会意识到这个变化的，这样就会产生zfs池不可用的问题，我们需要一些方法来获取到磁盘的id并以此来创建我们的zfs池。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -l /dev/disk/by-id
lrwxrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">13</span> Feb <span style="color:#ae81ff">13</span> 12:29 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM -&gt; ../../nvme0n1
lrwxrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">15</span> Feb <span style="color:#ae81ff">13</span> 12:32 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part1 -&gt; ../../nvme0n1p1
lrwxrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">15</span> Feb <span style="color:#ae81ff">13</span> 12:29 nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part2 -&gt; ../../nvme0n1p2
KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part3 -&gt; ../../nvme0n1p3
...
</code></pre></div><p>这里的<code>KXG50PNV2T04_KIOXIA_Y9IS103FTHDM</code>就是我们的硬盘，<code>nvme-KXG50PNV2T04_KIOXIA_Y9IS103FTHDM-part1</code>就是我们创建作为未来的<code>/boot</code>分区。</p>
<p>当我们创建zfs池的时候尽可能选择用这种id的方式去创建。现在我们创建一个加密的zpool：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zpool create -f -o ashift<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span> -o cachefile<span style="color:#f92672">=</span>/etc/zfs/zpool.cache -O compression<span style="color:#f92672">=</span>lz4 -O xattr<span style="color:#f92672">=</span>sa -O relatime<span style="color:#f92672">=</span>on -O acltype<span style="color:#f92672">=</span>posixacl -O dedup<span style="color:#f92672">=</span>off -O encryption<span style="color:#f92672">=</span>on -O keyformat<span style="color:#f92672">=</span>passphrase -m none -R /mnt/gentoo rock /dev/disk/by-id/nvme-eui.000000000000001000080d0200600f01-part3
</code></pre></div><p><a href="https://openzfs.github.io/openzfs-docs/man/7/zpoolprops.7.html">zpoolprops</a></p>
<ul>
<li><code>ashift=ashift</code>: Pool sector size exponent, to the power of <strong>2</strong> (internally referred to as <strong>ashift</strong>). The typical case for setting this property is when performance is important and the underlying disks use 4KiB sectors but report 512B sectors to the OS (for compatibility reasons); in that case, set <strong>ashift</strong>=<strong>12</strong> (which is <strong>1&laquo;12</strong> = <strong>4096</strong>).</li>
<li><code>cachefile=path|none</code>: Controls the location of where the pool configuration is cached. Setting this property caches the pool configuration in a different location that can later be imported with <code>zpool import -c</code>.</li>
</ul>
<p>根据提示输入密码（注意密码不会有回显，并不是键盘坏了）。</p>
<p>这条命令创建了一个名为 <code>rock</code>的zfs池 使用的压缩算法为<code>lz4</code>。</p>
<p>如果说你想创建一个不带加密的zpool可以去掉<code>-O encryption=on -O keyformat=passphrase</code>这两个选项。</p>
<h5 id="创建-datasets">创建 datasets<a hidden class="anchor" aria-hidden="true" href="#创建-datasets">#</a></h5>
<p>接下来我们要创建自己的rootfs，并且在上面打开加密功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs create -o mountpoint<span style="color:#f92672">=</span>none -o canmount<span style="color:#f92672">=</span>off rock/os
$ zfs create -o mountpoint<span style="color:#f92672">=</span>/ rock/os/gentoo
</code></pre></div><h4 id="安装系统">安装系统<a hidden class="anchor" aria-hidden="true" href="#安装系统">#</a></h4>
<p>这次安装系统的话，是打算直接从硬盘恢复的，首先插上备份好的硬盘：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fdisk -l
........
Disk /dev/sdc: 232.88 GiB, <span style="color:#ae81ff">250055122432</span> bytes, <span style="color:#ae81ff">488388911</span> sectors
Disk model: 00AAJS-00B4A0
Units: sectors of <span style="color:#ae81ff">1</span> * 512 <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span> bytes
Sector size <span style="color:#f92672">(</span>logical/physical<span style="color:#f92672">)</span>: <span style="color:#ae81ff">512</span> bytes / <span style="color:#ae81ff">512</span> bytes
I/O size <span style="color:#f92672">(</span>minimum/optimal<span style="color:#f92672">)</span>: <span style="color:#ae81ff">4096</span> bytes / <span style="color:#ae81ff">33553920</span> bytes
Disklabel type: dos
Disk identifier: 0x80f01a9c

Device     Boot Start       End   Sectors   Size Id Type
/dev/sdc1        <span style="color:#ae81ff">2048</span> <span style="color:#ae81ff">488388910</span> <span style="color:#ae81ff">488386863</span> 232.9G <span style="color:#ae81ff">83</span> Linux
</code></pre></div><p>这里看到我们的备份硬盘。我们要创建一个目录用来挂载这个分区：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir -pv /backup
</code></pre></div><p>打开LUKS分区：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cryptsetup luksOpen /dev/sdc1 backup
Enter passphrase <span style="color:#66d9ef">for</span> /dev/sdc1:
</code></pre></div><p>输入之前设置的密码。挂载分区：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mount -v /dev/mapper/backup /backup
</code></pre></div><p>还有一个分区我们要注意一下就是<code>/boot</code>分区，创建boot分区的挂载点：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir -pv /mnt/gentoo/boot
</code></pre></div><p>挂载分区：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mount -v /dev/nvme0n1p1 /mnt/gentoo/boot
</code></pre></div><p>将所有文件同步到zfs的dataset里面：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ rsync -aAXv --exclude<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;/dev/*&#34;</span>,<span style="color:#e6db74">&#34;/proc/*&#34;</span>,<span style="color:#e6db74">&#34;/sys/*&#34;</span>,<span style="color:#e6db74">&#34;/tmp/*&#34;</span>,<span style="color:#e6db74">&#34;/run/*&#34;</span>,<span style="color:#e6db74">&#34;/mnt/*&#34;</span>,<span style="color:#e6db74">&#34;/media/*&#34;</span>,<span style="color:#e6db74">&#34;/lost+found&#34;</span>,<span style="color:#e6db74">&#34;/backup/*&#34;</span>,<span style="color:#e6db74">&#34;/swapfile&#34;</span><span style="color:#f92672">}</span> /backup/ /mnt/gentoo
</code></pre></div><p>这个复制需要一定的时间，耐心等待完成，期间不要断开硬盘或者是拔掉电源。</p>
<h4 id="chroot">chroot<a hidden class="anchor" aria-hidden="true" href="#chroot">#</a></h4>
<p>等到复制原来的系统完成之后我们就需要进入chroot环境，然后完成其他的必要配置了。</p>
<p>拷贝ZFS池缓存文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir -pv /mnt/gentoo/etc/zfs
$ cp -v  /etc/zfs/zpool.cache /mnt/gentoo/etc/zfs
</code></pre></div><p>拷贝网络的DNS：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cp --dereference /etc/resolv.conf /mnt/gentoo/etc/
</code></pre></div><p>挂载必要的文件系统：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mount --types proc /proc /mnt/gentoo/proc
$ mount --rbind /sys /mnt/gentoo/sys
$ mount --make-rslave /mnt/gentoo/sys
$ mount --rbind /dev /mnt/gentoo/dev
$ mount --make-rslave /mnt/gentoo/dev
</code></pre></div><p>我们不是在官方的Livecd下面还需要执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ test -L /dev/shm <span style="color:#f92672">&amp;&amp;</span> rm /dev/shm <span style="color:#f92672">&amp;&amp;</span> mkdir /dev/shm
$ mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm
$ chmod <span style="color:#ae81ff">1777</span> /dev/shm
</code></pre></div><p>进入chroot：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ chroot /mnt/gentoo /bin/bash
$ source /etc/profile
$ export PS1<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;(chroot) </span>$PS1<span style="color:#e6db74">&#34;</span>
</code></pre></div><h4 id="zfs-安装和配置">ZFS 安装和配置<a hidden class="anchor" aria-hidden="true" href="#zfs-安装和配置">#</a></h4>
<p>首先是要给原来的系统安装上ZFS的支持，确保内核打开了Zlib的支持：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">General Architecture Dependent Options ---&gt;
  GCC plug ins  ---&gt;  
    <span style="color:#f92672">[</span> <span style="color:#f92672">]</span>   Randomize layout of sensitive kernel structures 
Cryptographic API ---&gt;
  &lt;*&gt; Deflate compression algorithm
Security options  ---&gt; 
  <span style="color:#f92672">[</span> <span style="color:#f92672">]</span> Harden common str/mem functions against buffer overflows
</code></pre></div><p>我们还需要调整portage让ZFS包接收测试分支的包：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo <span style="color:#e6db74">&#34;sys-fs/zfs-kmod ~amd64&#34;</span> &gt;&gt; /etc/portage/package.accept_keywords/zfs-kmod
$ echo <span style="color:#e6db74">&#34;sys-fs/zfs ~amd64&#34;</span> &gt;&gt; /etc/portage/package.accept_keywords/zfs
</code></pre></div><p>如果你想要使用实时的包可以:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo <span style="color:#e6db74">&#34;=sys-fs/zfs-kmod-9999 **&#34;</span> &gt;&gt; /etc/portage/package.accept_keywords/zfs-kmod
$ echo <span style="color:#e6db74">&#34;=sys-fs/zfs-9999 **&#34;</span> &gt;&gt; /etc/portage/package.accept_keywords/zfs
</code></pre></div><p>但是不推荐用最新的，要到处找patch。</p>
<p>安装ZFS：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ emerge -av zfs
</code></pre></div><p>有一个很重要的点，每次更新内核或者是编译内核之后最好是重新构建一下模块，否则有可能遇到zpool无法正常初始化的问题：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ emerge -va @module-rebuild
</code></pre></div><p>将zfs加入到开机启动项和对应的启动级别：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ systemctl enable zfs.target
$ systemctl enable zfs-import-cache
$ systemctl enable zfs-mount
$ systemctl enable zfs-import.target
</code></pre></div><p>生成和验证<code>zfs hostid</code>文件，这个文件是用于<code>genkernel</code>生成<code>initramfs</code>和zfs导入池的时候验证完整性时候需要的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zgenhostid
$ file /etc/hostid
</code></pre></div><h4 id="bootload-fstab-and-initramfs">Bootload fstab and Initramfs<a hidden class="anchor" aria-hidden="true" href="#bootload-fstab-and-initramfs">#</a></h4>
<h5 id="grub">GRUB<a hidden class="anchor" aria-hidden="true" href="#grub">#</a></h5>
<p>修改grub的配置文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">GRUB_CMDLINE_LINUX<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dozfs root=ZFS=rock/os/gentoo&#34;</span>
</code></pre></div><p>安装<code>bootload</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ grub-install --target<span style="color:#f92672">=</span>x86_64-efi --efi-directory<span style="color:#f92672">=</span>/boot --bootloader-id<span style="color:#f92672">=</span>Gentoo
</code></pre></div><p>生成配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ grub-mkconfig -o /boot/grub/grub.cfg
</code></pre></div><h5 id="fstab">fstab<a hidden class="anchor" aria-hidden="true" href="#fstab">#</a></h5>
<p>挂载的工作这次交给zfs来去完成，我们这里还需要修改一下fstab</p>
<p>首先查看分区的id：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ blkid
/dev/nvme0n1p1: UUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;129F-3405&#34;</span> BLOCK_SIZE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;512&#34;</span> TYPE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;vfat&#34;</span> PARTUUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;537bd932-cc1f-5643-a297-feebaeb6a5ea&#34;</span>
/dev/nvme0n1p2: LABEL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rock&#34;</span> UUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;7999529021869478878&#34;</span> UUID_SUB<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;11607083434113154920&#34;</span> BLOCK_SIZE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;4096&#34;</span> TYPE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zfs_member&#34;</span> PARTUUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;d68d6b86-a407-4141-a1a7-1379cbe1e049&#34;</span>
</code></pre></div><p>可以看到我们的<code>/boot</code>分分区UUID是<code>129F-3405</code>，现在可以修改<code>/etc/fstab</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ nano -w /etc/fstab
</code></pre></div><p>内容如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># /dev/nvme0n1p1</span>
/dev/nvme0n1p1      	/boot     	vfat      	rw,relatime,fmask<span style="color:#f92672">=</span>0022,dmask<span style="color:#f92672">=</span>0022,codepage<span style="color:#f92672">=</span>437,iocharset<span style="color:#f92672">=</span>iso8859-1,shortname<span style="color:#f92672">=</span>mixed,errors<span style="color:#f92672">=</span>remount-ro	<span style="color:#ae81ff">0</span> <span style="color:#ae81ff">2</span>
</code></pre></div><h5 id="initramfs">initramfs<a hidden class="anchor" aria-hidden="true" href="#initramfs">#</a></h5>
<p>重新生成<code>initramfs</code>，之前的<code>initramfs</code>没有zfs的支持这次要加上，为了保证工作正常还需要将<code>genkrenel</code>切换到testing分支</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo <span style="color:#e6db74">&#34;=sys-kernel/genkernel-9999 **&#34;</span> &gt; /etc/portage/package.accept_keywords/genkernel
</code></pre></div><p>更新<code>genkernel</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ emerge -av genkernel
</code></pre></div><p>重新生成<code>initramfs</code>文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ genkernel initramfs --zfs --compress-initramfs
</code></pre></div><h4 id="重启">重启<a hidden class="anchor" aria-hidden="true" href="#重启">#</a></h4>
<p>在重启验证之前我们需要先做一些清理工作</p>
<p>首先退出chroot环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ exit
</code></pre></div><p>卸载备份分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ umount -R /backup
</code></pre></div><p>关闭<code>backup</code>卷</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cryptsetup luksClose backup
</code></pre></div><p>然后就可以重启啦</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ reboot
</code></pre></div><p>重启之后第一次可能还是没办法正常进入系统，需要进入到shell里面导入一下zpool</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zpool import -f rock
</code></pre></div><p>设置一下分区挂载点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs set mountpoint<span style="color:#f92672">=</span>/ rock/os/gentoo
</code></pre></div><p>然后再重启一下就可以正常进入系统了。</p>
<h3 id="使用zfs备份httpswwwyafamoepostuse-zfs-backup-system"><a href="https://www.yafa.moe/post/use-zfs-backup-system/">使用ZFS备份</a><a hidden class="anchor" aria-hidden="true" href="#使用zfs备份httpswwwyafamoepostuse-zfs-backup-system">#</a></h3>
<h4 id="创建备份zfs池">创建备份ZFS池<a hidden class="anchor" aria-hidden="true" href="#创建备份zfs池">#</a></h4>
<p>首先进入livecd，查看设备：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fdisk -l
Disk /dev/nvme0n1: 1.86 TiB, <span style="color:#ae81ff">2048408248320</span> bytes, <span style="color:#ae81ff">4000797360</span> sectors
...

Disk /dev/sda: 233.76 GiB, <span style="color:#ae81ff">251000193024</span> bytes, <span style="color:#ae81ff">490234752</span> sectors
...

Disk /dev/sdc: 57.81 GiB, <span style="color:#ae81ff">62075699200</span> bytes, <span style="color:#ae81ff">121241600</span> sectors
...
</code></pre></div><p>这里的设备分别为：</p>
<table>
<thead>
<tr>
<th>物理位置</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>/dev/nvme0n1</td>
<td>系统盘</td>
</tr>
<tr>
<td>/dev/sda</td>
<td>备份盘</td>
</tr>
<tr>
<td>/dev/sdc</td>
<td>启动盘</td>
</tr>
</tbody>
</table>
<p>首先在备份盘上创建一个分区（分配所有空间到这个分区上）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fdisk /dev/sda
Welcome to fdisk <span style="color:#f92672">(</span>util-linux 2.36<span style="color:#f92672">)</span>.
Changes will remain in memory only, <span style="color:#66d9ef">until</span> you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table.
Created a new DOS disklabel with disk identifier 0x108318f9.

Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>: n
Partition type
   p   primary <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> primary, <span style="color:#ae81ff">0</span> extended, <span style="color:#ae81ff">4</span> free<span style="color:#f92672">)</span>
   e   extended <span style="color:#f92672">(</span>container <span style="color:#66d9ef">for</span> logical partitions<span style="color:#f92672">)</span>
Select <span style="color:#f92672">(</span>default p<span style="color:#f92672">)</span>:

Using default response p.
Partition number <span style="color:#f92672">(</span>1-4, default 1<span style="color:#f92672">)</span>:
First sector <span style="color:#f92672">(</span>2048-490234751, default 2048<span style="color:#f92672">)</span>:
Last sector, +/-sectors or +/-size<span style="color:#f92672">{</span>K,M,G,T,P<span style="color:#f92672">}</span> <span style="color:#f92672">(</span>2048-490234751, default 490234751<span style="color:#f92672">)</span>:

Created a new partition <span style="color:#ae81ff">1</span> of type <span style="color:#e6db74">&#39;Linux&#39;</span> and of size 233.8 GiB.

Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>: w
The partition table has been altered.
Calling ioctl<span style="color:#f92672">()</span> to re-read partition table.
Syncing disks.
</code></pre></div><p>查看硬盘ID</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -l /dev/disk/by-id
...
lrwxrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">10</span> Feb <span style="color:#ae81ff">27</span> 14:53 usb-ACASIS_MAC3E_000000000001-0:0-part1 -&gt; ../../sda1
...
</code></pre></div><p><code>usb-ACASIS_MAC3E_000000000001-0:0-part1</code>这里就是我们所需要的硬盘ID，我们使用这个来创建备份池子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zpool create -f -o ashift<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span> -o cachefile<span style="color:#f92672">=</span>/etc/zfs/zpool.cache -O compression<span style="color:#f92672">=</span>lz4 -O xattr<span style="color:#f92672">=</span>sa -O relatime<span style="color:#f92672">=</span>on -O acltype<span style="color:#f92672">=</span>posixacl -O dedup<span style="color:#f92672">=</span>off -m none -R /mnt/backup backup /dev/disk/by-id/usb-ACASIS_MAC3E_000000000001-0:0-part1
</code></pre></div><p>备份池也可以加密。</p>
<h4 id="创建快照">创建快照<a hidden class="anchor" aria-hidden="true" href="#创建快照">#</a></h4>
<p>首先导入原来的<code>zpool</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zpool import -f rock
</code></pre></div><p>给之前的系统创建一个快照：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo zfs snapshot rock/os/gentoo@2021-02-27-0000-01-install
</code></pre></div><p>查看</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs list -r -t snapshot -o name,creation rock/os/gentoo
rock/os/gentoo@2021-02-27-0000-01-install  Sat Feb <span style="color:#ae81ff">27</span> 14:16 <span style="color:#ae81ff">2021</span>
</code></pre></div><h4 id="发送快照">发送快照<a hidden class="anchor" aria-hidden="true" href="#发送快照">#</a></h4>
<p>我们需要打开原来的<code>rock/os/gentoo</code>数据集</p>
<p>但是首先要设置一下挂载点：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs set mountpoint<span style="color:#f92672">=</span>/mnt/gentoo rock/os/gentoo
</code></pre></div><p>打开<code>rock/os/gentoo</code>数据集</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs mount -l -a
</code></pre></div><p>发送快照到<code>backup/os/gentoo</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs send rock/os/gentoo@2021-02-27-0000-01-install |  zfs recv backup/2021-02-27-0000-01-backup
</code></pre></div><p>这个会花很长的时间，取决于你使用的接口速度，可以通过这条命令查看io情况：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zpool iostat <span style="color:#ae81ff">2</span> 
</code></pre></div><p>这条命令是查看所有的<code>zpool</code>io情况，2秒刷新一次。</p>
<h4 id="备份boot分区">备份<code>/boot</code>分区<a hidden class="anchor" aria-hidden="true" href="#备份boot分区">#</a></h4>
<p>设置挂载点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs set mountpoint<span style="color:#f92672">=</span>/mnt/backup backup/2021-02-27-0000-01-backup
</code></pre></div><p>备份</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir -pv /mnt/boot
$ mount -v /dev/nvme0n1p1 /mnt/boot
$ cp -rv /mnt/boot/* /mnt/backup/boot/
</code></pre></div><h4 id="恢复快照">恢复快照<a hidden class="anchor" aria-hidden="true" href="#恢复快照">#</a></h4>
<p>卸除挂载：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs umount backup/2021-02-27-0000-01-backup
</code></pre></div><p>现在就可以恢复快照了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs send backup/2021-02-27-0000-01-backup | zfs recv -F  -x encryption rock/os/gentoo
</code></pre></div><h4 id="定期备份">定期备份<a hidden class="anchor" aria-hidden="true" href="#定期备份">#</a></h4>
<p>在Gentoo的Portage Tree中提供了一个<code>sys-fs/zfs-auto-snapshot</code>的包，这个包可以帮我们创建一个定时任务周期性的备份我们的ZFS</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge -av sys-fs/zfs-auto-snapshot
</code></pre></div><p>可以根据需要配置备份的周期：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo zfs set com.sun:auto-snapshot:daily<span style="color:#f92672">=</span>true rock/os/gentoo
$ sudo zfs set com.sun:auto-snapshot:weekly<span style="color:#f92672">=</span>true rock/os/gentoo
</code></pre></div><h3 id="问题排查">问题排查<a hidden class="anchor" aria-hidden="true" href="#问题排查">#</a></h3>
<h4 id="grub-救援">grub 救援<a hidden class="anchor" aria-hidden="true" href="#grub-救援">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">grub rescue&gt; set prefix<span style="color:#f92672">=(</span>hd0,1<span style="color:#f92672">)</span>/boot/grub
grub rescue&gt; set root<span style="color:#f92672">=(</span>hd0,1<span style="color:#f92672">)</span>
grub rescue&gt; insmod normal
grub rescue&gt; normal
grub rescue&gt; insmod linux
grub rescue&gt; linux /boot/vmlinuz-3.13.0-29-generic dozfs root<span style="color:#f92672">=</span>ZFS<span style="color:#f92672">=</span>rock/os/gentoo
grub rescue&gt; initrd /boot/initrd.img-3.13.0-29-generic
grub rescue&gt; boot
</code></pre></div><h4 id="通过-livecd-修复">通过 livecd 修复<a hidden class="anchor" aria-hidden="true" href="#通过-livecd-修复">#</a></h4>
<p><strong>导入 zpool</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zpool import -f rock
$ zfs set mountpoint<span style="color:#f92672">=</span>/mnt/gentoo rock/os/gentoo
</code></pre></div><p><strong>挂载 dataset</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs mount -la
</code></pre></div><p><strong>挂载 boot 分区</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mount /dev/nvme0n1p1 /mnt/gentoo/boot/
</code></pre></div><p><strong>挂载必要的文件系统</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mount --types proc /proc /mnt/gentoo/proc
$ mount --rbind /sys /mnt/gentoo/sys
$ mount --make-rslave /mnt/gentoo/sys
$ mount --rbind /dev /mnt/gentoo/dev
$ mount --make-rslave /mnt/gentoo/dev
<span style="color:#75715e"># 我们不是在官方的Livecd下面还需要执行：</span>
$ test -L /dev/shm <span style="color:#f92672">&amp;&amp;</span> rm /dev/shm <span style="color:#f92672">&amp;&amp;</span> mkdir /dev/shm
$ mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm
$ chmod <span style="color:#ae81ff">1777</span> /dev/shm
</code></pre></div><p><strong>进入 chroot</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ chroot /mnt/gentoo /bin/bash
$ source /etc/profile
$ export PS1<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;(chroot) </span>$PS1<span style="color:#e6db74">&#34;</span>
</code></pre></div><p><strong>退出 chroot</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ exit 
</code></pre></div><p><strong>卸除挂载</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ umount -R /mnt/gentoo
</code></pre></div><p><strong>改回 rootfs 挂载点</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zfs set mountpoint<span style="color:#f92672">=</span>/ rock/os/gentoo
</code></pre></div><p><strong>重启</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ reboot
</code></pre></div><h2 id="lukshttpslinuxcnarticle-9640-1html"><a href="https://linux.cn/article-9640-1.html">LUKS</a><a hidden class="anchor" aria-hidden="true" href="#lukshttpslinuxcnarticle-9640-1html">#</a></h2>
<p>数据的安全，保密性在现在的生活中显得越来越重要。随着数字化的时代的来临，越来越多的数据被数字化，特别是更多有关于我们隐私的数据在不断生成，甚至还有我们需要离线保存的密钥等。而且通常我们使用磁盘，USB 闪存，SD  卡等存储介质进行存储，即便我们已经离线存储，仍然不能保证该存储介质不会丢失，如果丢失那么对于我们来说有可能是灾难性的事件。因此对这些离线存储的重要数据，再次进行进行加密是非常有必要的，本文将告诉你如何加密你的移动存储介质。</p>
<p>在此之前先介绍一下 LUKS：</p>
<blockquote>
<p>LUKS （Linux Unified Key Setup）是 Linux 硬盘加密的标准。  通过提供标准的磁盘格式，它不仅可以促进发行版之间的兼容性，还可以提供对多个用户密码的安全管理。 与现有解决方案相比，LUKS  将所有必要的设置信息存储在分区信息首部中，使用户能够无缝传输或迁移其数据。</p>
</blockquote>
<h3 id="内核配置可选">内核配置（可选）<a hidden class="anchor" aria-hidden="true" href="#内核配置可选">#</a></h3>
<p>通常来说，大部分发行版的内核都已经配置了相关的加密部分，因此非 gentoo 用户可以跳过此部分。</p>
<p>配置 device mapper 和 crypt target：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Enable loadable module support
    Device Drivers ---&gt;
        <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Multiple devices driver support <span style="color:#f92672">(</span>RAID and LVM<span style="color:#f92672">)</span> ---&gt;
            &lt;*&gt; Device mapper support
            &lt;*&gt;   Crypt target support
</code></pre></div><p>配置加密 API：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Cryptographic API ---&gt;
        &lt;*&gt; XTS support
        &lt;*&gt; SHA224 and SHA256 digest algorithm
        &lt;*&gt; AES cipher algorithms
        &lt;*&gt; AES cipher algorithms <span style="color:#f92672">(</span>x86_64<span style="color:#f92672">)</span>
        &lt;*&gt; User-space interface <span style="color:#66d9ef">for</span> hash algorithms
        &lt;*&gt; User-space interface <span style="color:#66d9ef">for</span> symmetric key cipher algorithms
</code></pre></div><p>编译新内核并配置应用，然后重启：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># make -j9 &amp;&amp; make modules_install &amp;&amp; make install</span>
</code></pre></div><h3 id="安装软件-1">安装软件<a hidden class="anchor" aria-hidden="true" href="#安装软件-1">#</a></h3>
<p>通常的发行版已经预装了该软件包，可以直接使用，下面是 Gentoo 的安装方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-fs/cryptsetup</span>
</code></pre></div><h3 id="创建加密分区">创建加密分区<a hidden class="anchor" aria-hidden="true" href="#创建加密分区">#</a></h3>
<p>注意，该操作会清空你选择分区或设备上的所有数据，请谨慎操作，输入大写的 <code>YES</code> 确认</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cryptsetup -s 512 luksFormat /dev/sdd</span>

WARNING!
<span style="color:#f92672">========</span>
This will overwrite data on /dev/sdd irrevocably.

Are you sure? <span style="color:#f92672">(</span>Type uppercase yes<span style="color:#f92672">)</span>: YES
Enter passphrase: 
Verify passphrase:
</code></pre></div><h3 id="利用密钥文件加密分区">利用密钥文件加密分区<a hidden class="anchor" aria-hidden="true" href="#利用密钥文件加密分区">#</a></h3>
<p>除了密码之外，还可以选择使用密钥文件解密你的硬盘，也就是相当于一个密钥，当然可以也可以只使用密钥文件或者同时使用密码与密钥文件。</p>
<h4 id="生成随机密钥文件">生成随机密钥文件<a hidden class="anchor" aria-hidden="true" href="#生成随机密钥文件">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># dd if=/dev/urandom of=/root/enc.key bs=1 count=4096</span>
</code></pre></div><h4 id="添加密钥文件作为密码之一">添加密钥文件作为密码之一<a hidden class="anchor" aria-hidden="true" href="#添加密钥文件作为密码之一">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cryptsetup luksAddKey  /dev/sdd /root/enc.key</span>
Enter any existing passphrase:
</code></pre></div><h3 id="移除解密密码">移除解密密码<a hidden class="anchor" aria-hidden="true" href="#移除解密密码">#</a></h3>
<p>移除普通密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cryptsetup luksRemoveKey /dev/sdd</span>
Enter LUKS passphrase to be deleted: ...
</code></pre></div><p>移除 key file 密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cryptsetup luksRemoveKey -d /root/enc.key /dev/sdd</span>
</code></pre></div><p><strong>注意</strong>：千万不要将所有密码移除，至少需要留有一个密码访问设备，移除操作不可撤销</p>
<h3 id="解密与挂载">解密与挂载<a hidden class="anchor" aria-hidden="true" href="#解密与挂载">#</a></h3>
<h4 id="密码解密">密码解密<a hidden class="anchor" aria-hidden="true" href="#密码解密">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cryptsetup luksOpen /dev/sdd myusb</span>
Enter passphrase <span style="color:#66d9ef">for</span> /dev/sdd:
</code></pre></div><h4 id="key-file-解密">key file 解密<a hidden class="anchor" aria-hidden="true" href="#key-file-解密">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cryptsetup luksOpen -d /root/enc.key /dev/sdd myusb</span>
</code></pre></div><h4 id="创建文件系统-1">创建文件系统<a hidden class="anchor" aria-hidden="true" href="#创建文件系统-1">#</a></h4>
<p>在挂载使用之前，我们仍然需要对设备创建文件系统才可以使用，可以选择任何你喜欢的文件系统，例如 <code>btrfs</code>，<code>ext4</code>，<code>vfat</code>，<code>ntfs</code> 等</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkfs.ext4 /dev/mapper/myusb</span>
mke2fs 1.43.6 <span style="color:#f92672">(</span>29-Aug-2017<span style="color:#f92672">)</span>
Creating filesystem with <span style="color:#ae81ff">488448</span> 4k blocks and <span style="color:#ae81ff">122160</span> inodes
Filesystem UUID: 995e172a-2bc6-432c-a60f-2d4d7093e748
Superblock backups stored on blocks:
32768, 98304, 163840, 229376, <span style="color:#ae81ff">294912</span>
Allocating group tables: <span style="color:#66d9ef">done</span>
Writing inode tables: <span style="color:#66d9ef">done</span>
Creating journal <span style="color:#f92672">(</span><span style="color:#ae81ff">8192</span> blocks<span style="color:#f92672">)</span>: <span style="color:#66d9ef">done</span>
Writing superblocks and filesystem accounting information: <span style="color:#66d9ef">done</span>
</code></pre></div><h4 id="挂载">挂载<a hidden class="anchor" aria-hidden="true" href="#挂载">#</a></h4>
<p>现在可以像正常分区一样挂载我们的加密分区设备了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mount /dev/mapper/myusb /mnt/</span>
<span style="color:#75715e"># df -h</span>
/dev/mapper/myusb  1.9G  5.7M  1.7G   1% /mnt
</code></pre></div><h4 id="卸载挂载点并关闭加密分区">卸载挂载点并关闭加密分区<a hidden class="anchor" aria-hidden="true" href="#卸载挂载点并关闭加密分区">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># umount /mnt</span>
<span style="color:#75715e"># cryptsetup luksClose myusb</span>
</code></pre></div><h3 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h3>
<p>在完成整个步骤以后，您现在需要做的就是妥善保管您的加密存储，可采用同样的方式加密多个设备进行备份，因为谁也不能保证这移动设备会不会在什么时候丢掉。</p>
<h2 id="input-method-editor">Input Method Editor<a hidden class="anchor" aria-hidden="true" href="#input-method-editor">#</a></h2>
<h3 id="中文字体httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle4b8ade69687e5ad97e4bd93"><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93">中文字体</a><a hidden class="anchor" aria-hidden="true" href="#中文字体httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle4b8ade69687e5ad97e4bd93">#</a></h3>
<p>在应用之前，最好先安装好中文字体和 <a href="https://www.reddit.com/r/Gentoo/comments/i26kj3/some_emojis_are_not_displayed_on_my_chrome/">emojis</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge media-fonts/noto-cjk media-fonts/noto-emoji</span>
<span style="color:#75715e"># eselect fontconfig list</span>
<span style="color:#75715e"># eselect fontconfig enable 70-noto-cjk.conf</span>
</code></pre></div><p>也可以将字体文件复制到目录 <code>~/.local/share/fonts/</code> 下，然后执行 <code>fc-cache -f -v</code> 创建字体缓存。</p>
<h4 id="改善字体渲染效果httpszhuanlanzhihucomp343934880"><a href="https://zhuanlan.zhihu.com/p/343934880">改善字体渲染效果</a><a hidden class="anchor" aria-hidden="true" href="#改善字体渲染效果httpszhuanlanzhihucomp343934880">#</a></h4>
<ul>
<li>
<p>安装字体：下载<a href="https://github.com/be5invis/Sarasa-Gothic">更纱黑体</a></p>
<p>TUNA (CN): <a href="https://mirrors.tuna.tsinghua.edu.cn/github-release/be5invis/Sarasa-Gothic">https://mirrors.tuna.tsinghua.edu.cn/github-release/be5invis/Sarasa-Gothic</a></p>
<p>NJU (CN): <a href="https://mirror.nju.edu.cn/github-release/be5invis/Sarasa-Gothic">https://mirror.nju.edu.cn/github-release/be5invis/Sarasa-Gothic</a></p>
</li>
<li>
<p>调整系统字体：系统设置 -&gt; 字体</p>
<p>在系统字体设置那将那些默认的noto sans字体改为更纱黑体即可，前三个最好相应调大一个等级。等距字体可以使用等距更纱黑体，也可以使用你喜欢的等距字体。</p>
<p><img loading="lazy" src="/Distributions/v2-7bde73db7d1a88d0e9bf3123879d99ca_r.jpg" alt=""  />
</p>
</li>
<li>
<p>调整系统缩放：系统设置 -&gt; 显示和监控 -&gt; 显示配置 -&gt; 缩放显示</p>
<p>默认是100%，可以调整到110～120之间，具体数值根据自己效果设定</p>
</li>
<li>
<p>调整字体DPI：系统设置 -&gt; 字体 -&gt; 勾选“固定字体DPI”并调整DPI的值</p>
<p>默认是96，同样也可以调整到110~120之间，具体数值根据自己效果设定</p>
</li>
<li>
<p>调整字体展示优先级：将下述内容保存为 ~/.fonts.conf文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span style="color:#75715e">&lt;!DOCTYPE fontconfig SYSTEM &#34;fonts.dtd&#34;&gt;</span>
<span style="color:#f92672">&lt;fontconfig&gt;</span>
  <span style="color:#f92672">&lt;alias&gt;</span>
    <span style="color:#f92672">&lt;family&gt;</span>sans-serif<span style="color:#f92672">&lt;/family&gt;</span>
    <span style="color:#f92672">&lt;prefer&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Gothic SC<span style="color:#f92672">&lt;/family&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Gothic TC<span style="color:#f92672">&lt;/family&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Gothic J<span style="color:#f92672">&lt;/family&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Gothic K<span style="color:#f92672">&lt;/family&gt;</span>
    <span style="color:#f92672">&lt;/prefer&gt;</span>
  <span style="color:#f92672">&lt;/alias&gt;</span>
  <span style="color:#f92672">&lt;alias&gt;</span>
    <span style="color:#f92672">&lt;family&gt;</span>monospace<span style="color:#f92672">&lt;/family&gt;</span>
    <span style="color:#f92672">&lt;prefer&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Mono SC<span style="color:#f92672">&lt;/family&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Mono TC<span style="color:#f92672">&lt;/family&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Mono J<span style="color:#f92672">&lt;/family&gt;</span>
      <span style="color:#f92672">&lt;family&gt;</span>Sarasa Mono K<span style="color:#f92672">&lt;/family&gt;</span>
    <span style="color:#f92672">&lt;/prefer&gt;</span>
  <span style="color:#f92672">&lt;/alias&gt;</span>
<span style="color:#f92672">&lt;/fontconfig&gt;</span>
</code></pre></div></li>
</ul>
<p>调整完之后注销重新登入</p>
<h3 id="输入法httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle8be93e585a5e6b395"><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html#%E8%BE%93%E5%85%A5%E6%B3%95">输入法</a><a hidden class="anchor" aria-hidden="true" href="#输入法httpsbitbilinetgentoo-linux-installation-and-usage-tutorialhtmle8be93e585a5e6b395">#</a></h3>
<p>作为中文用户，肯定需要款输入法，我推荐使用 fcitx （还有一款叫 ibus）。目前稳定维护的 fcitx 版本是 5 ，但是官方仓库 <code>::gentoo</code> 目前只有 4 （也能用，就是不怎么维护了）。</p>
<h4 id="官方仓库-fcitx4">官方仓库 fcitx4<a hidden class="anchor" aria-hidden="true" href="#官方仓库-fcitx4">#</a></h4>
<p><strong>重要</strong>：先配置下 fcitx4 开启对 gtk2 的支持以避免有些程序无法使用（gtk3 默认开启了）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;app-i18n/fcitx gtk2&#39; &gt;&gt; /etc/portage/package.use/fcitx</span>
</code></pre></div><p>然后安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-i18n/fcitx:4 app-i18n/fcitx-configtool:4 app-i18n/fcitx-qt5:4 app-i18n/fcitx-libpinyin:4</span>
</code></pre></div><p>其中：</p>
<ul>
<li>app-i18n/fcitx 是 fcitx 的主程序</li>
<li>app-i18n/fcitx-configtool 是它的配置工具</li>
<li>app-i18n/fcitx-qt5 用于支持在 qt 程序上使用它</li>
<li>app-i18n/fcitx-libpinyin 是一个输入法</li>
</ul>
<h4 id="额外仓库-fcitx5">额外仓库 fcitx5<a hidden class="anchor" aria-hidden="true" href="#额外仓库-fcitx5">#</a></h4>
<p>为使用最新的 fcitx5，这里需要使用额外的仓库 ，因为官方仓库目前（2021-11-23）没有。提供 fcitx5 的 Gentoo 仓库（Overlay）推荐 <a href="https://github.com/gentoo-mirror/gentoo-zh">gentoo-zh</a> 。具体方法为：</p>
<ul>
<li>
<p>先安装添加额外的仓库必要的工具</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-eselect/eselect-repository</span>
</code></pre></div></li>
<li>
<p>然后启用仓库，启用过程中，可能会因为网络原因导致比较慢，请耐心等待</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect repository enable gentoo-zh</span>
</code></pre></div></li>
<li>
<p>更新以获取下仓库内容。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge dev-vcs/git</span>
<span style="color:#75715e"># emerge --sync gentoo-zh</span>
</code></pre></div><p>如果一直卡在这里，那说明当前网络访问 github.com 不流畅。这时候有一种方法是：访问 <a href="https://fastgit.org">https://fastgit.org</a> （我不对该网站做任何保证），　修改 <code>/etc/portage/repos.conf/eselect-repo.conf</code> 文件，替换对应链接的域名为上述网站内指定值，并再次同步。</p>
</li>
<li>
<p>添加 portage 配置用于安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># mkdir -p /etc/portage/package.mask/</span>
<span style="color:#75715e"># echo &#39;*/*::gentoo-zh&#39; &gt; /etc/portage/package.mask/gentoo-zh</span>

<span style="color:#75715e"># mkdir -p /etc/portage/package.unmask/</span>
<span style="color:#75715e"># echo &#39;app-i18n/fcitx5-meta::gentoo-zh&#39; &gt; /etc/portage/package.unmask/fcitx5</span>
<span style="color:#75715e"># echo &#39;app-i18n/fcitx5::gentoo-zh&#39; &gt;&gt; /etc/portage/package.unmask/fcitx5</span>
<span style="color:#75715e"># echo &#39;app-i18n/fcitx5-configtool::gentoo-zh&#39; &gt;&gt; /etc/portage/package.unmask/fcitx5</span>
<span style="color:#75715e"># echo &#39;app-i18n/fcitx5-chinese-addons::gentoo-zh&#39; &gt;&gt; /etc/portage/package.unmask/fcitx5</span>
<span style="color:#75715e"># echo &#39;app-i18n/fcitx5-gtk::gentoo-zh&#39; &gt;&gt; /etc/portage/package.unmask/fcitx5</span>
<span style="color:#75715e"># echo &#39;app-i18n/fcitx5-qt::gentoo-zh&#39; &gt;&gt; /etc/portage/package.unmask/fcitx5</span>
<span style="color:#75715e"># echo &#39;app-i18n/libime::gentoo-zh&#39; &gt;&gt; /etc/portage/package.unmask/fcitx5</span>
<span style="color:#75715e"># echo &#39;x11-libs/xcb-imdkit::gentoo-zh&#39; &gt;&gt; /etc/portage/package.unmask/fcitx5</span>

<span style="color:#75715e"># mkdir -p /etc/portage/package.accept_keywords</span>
<span style="color:#75715e"># echo &#39;app-i18n/fcitx5-meta ~amd64&#39; &gt;&gt; /etc/portage/package.accept_keywords/fcitx5</span>
<span style="color:#75715e"># echo &#39;app-i18n/fcitx5 ~amd64&#39; &gt;&gt; /etc/portage/package.accept_keywords/fcitx5</span>
<span style="color:#75715e"># echo &#39;app-i18n/fcitx5-configtool ~amd64&#39; &gt;&gt; /etc/portage/package.accept_keywords/fcitx5</span>
<span style="color:#75715e"># echo &#39;app-i18n/fcitx5-chinese-addons ~amd64&#39; &gt;&gt; /etc/portage/package.accept_keywords/fcitx5</span>
<span style="color:#75715e"># echo &#39;app-i18n/fcitx5-gtk ~amd64&#39; &gt;&gt; /etc/portage/package.accept_keywords/fcitx5</span>
<span style="color:#75715e"># echo &#39;app-i18n/fcitx5-qt ~amd64&#39; &gt;&gt; /etc/portage/package.accept_keywords/fcitx5</span>
<span style="color:#75715e"># echo &#39;app-i18n/libime ~amd64&#39; &gt;&gt; /etc/portage/package.accept_keywords/fcitx5</span>
<span style="color:#75715e"># echo &#39;x11-libs/xcb-imdkit ~amd64&#39; &gt;&gt; /etc/portage/package.accept_keywords/fcitx5</span>
</code></pre></div></li>
<li>
<p>之后安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-i18n/fcitx5-meta</span>
</code></pre></div><p>或者</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># EGIT_OVERRIDE_REPO_FCITX_LIBIME=https://hub.fastgit.org/fcitx/libime.git EGIT_OVERRIDE_REPO_KPU_KENLM=https://hub.fastgit.org/kpu/kenlm.git emerge app-i18n/fcitx5-meta</span>
</code></pre></div><p>这里安装了 fcitx 的元包，它会自动依赖安装 fcitx5 主体、 RIME 输入法、配置工具等，这个仓库也会默认安装上 fcitx5-chinese-addons ，里面包含有中文输入法。</p>
<p>如果安装的时候长时间停止在校验 manifest，尝试用 eclean 清除  distfiles 和 packages。可能原因是混合使用了 gentoo（官方） 和 gentoo-zh（overlay）。</p>
</li>
<li>
<p>最后安装<a href="https://github.com/felixonmars/fcitx5-pinyin-zhwiki">肥猫百万大词库</a>：</p>
<p>Download latest version of &ldquo;zhwiki.dict&rdquo; from <a href="https://github.com/felixonmars/fcitx5-pinyin-zhwiki/releases">https://github.com/felixonmars/fcitx5-pinyin-zhwiki/releases</a></p>
<p>Copy into <code>~/.local/share/fcitx5/pinyin/dictionaries/</code> (create the folder if it does not exist)</p>
</li>
</ul>
<p><strong>提示</strong>：</p>
<ul>
<li>
<p>当使用非官方的 Fcitx5 时，因为没有镜像收录，所以源码需从 Github 下载，这时可能遇到因网络问题导致无法下载的情况（可以从 <code>/var/log/emerge-fetch.log</code> 文件查看源码包下载情况），如果遇到这种情况那么请自行通过各种途径下载好对应的 <code>.tar.gz</code> 格式（或类似）软件包，然后移动到 <code>/var/cache/distfiles/</code> 目录下。</p>
</li>
<li>
<p>软件包需更名为对应的包名加完整的版本号（执行上述 <code>emerge &lt;包名&gt;</code> 命令后可以看到完整的版本号），比如当显示的包名为 <code>app-i18n/fcitx-gtk-5.0.8:5::gentoo-zh</code> 那么就更名下载的源码包为 <code>fcitx-gtk-5.0.8.tar.gz</code> （ <code>/</code> 符号后以及 <code>:</code> 符号前的内容），以此类推。</p>
</li>
<li>
<p>或者，在 emerge-fetch.log 可以看到下载链接和类似如下的行</p>
<pre tabindex="0"><code>Saving to: ‘/var/cache/distfiles/fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2.__download__’
</code></pre><p>通过下载链接下载文件后，改名为删除 <code>.__download__</code> 剩余部分，如 <code>fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2</code>，然后删除对应的 <code>/var/cache/distfiles/fcitx5-lm_sc.3gm.arpa-20140820.tar.bz2.__download__</code> 缓存文件，并把重命名的文件移动到 <code>/var/cache/distfiles/</code>。</p>
</li>
</ul>
<h5 id="拥抱fcitx5httpsblogcoelacanthusmoepoststechwelcome-to-fcitx5"><a href="https://blog.coelacanthus.moe/posts/tech/welcome-to-fcitx5/">拥抱Fcitx5</a><a hidden class="anchor" aria-hidden="true" href="#拥抱fcitx5httpsblogcoelacanthusmoepoststechwelcome-to-fcitx5">#</a></h5>
<p><strong>起因</strong></p>
<p>2015年12月，<del>计科杀手</del> csslayer 创建了<a href="https://github.com/fcitx/fcitx5">fcitx/fcitx5</a>代码库，独自开始了对 Fcitx5 的开发。</p>
<p>如今五年过去了，Fcitx5 也日渐成熟。（个人感觉算法上相当不错</p>
<p>今年年初，我从 <code>fcitx-rime</code> 换到 <code>fcitx5-rime</code> ，感觉并不明显 <del>（毕竟对于 Rime 用户来说从4到5最大的变化是界面</del></p>
<p>然后，<del>在 Arch Linux CN 众多群友的诱惑下,</del> 我决定尝试一下 Fcitx5 自带的拼音输入法。</p>
<p>首次使用的体验是相当的棒的，Fcitx5 在默认配置下表现良好，云拼音也有百度，Google，Google CN 三种可选<del>尽管我不怎么用云拼音</del>，整句输入也是相当的棒，还有输入预测功能。</p>
<p>但这并不是让我抛弃我在 Rime 积攒下的词库投靠<del>老K输入法</del>Fcitx5自带拼音的理由……真正的原因是最近发生的几件事……</p>
<ul>
<li>
<p>首先是非常好的反馈体验，开发者老K对待用户非常友好，而且生产力十足</p>
</li>
<li>
<p>然后是 Felix 爬了维基百科制作了<a href="https://github.com/felixonmars/fcitx5-pinyin-zhwiki">肥猫百万大词库</a>，随后大佬 outloudvi 制作了<a href="https://github.com/outloudvi/fcitx5-pinyin-moegirl">萌娘百科词库</a>，Fcitx5 的日用词库基本满足（AUR 上皆有打包，且在 Arch CN 源有打包</p>
</li>
<li>
<p>肥猫大词库中的<a href="https://github.com/felixonmars/fcitx5-pinyin-zhwiki/issues/6">一个讨论</a>促使Fcitx5引入了一项新功能——根据前缀生成候选项，效果如图：</p>
<p><img loading="lazy" src="/Distributions/fcitx5-prefix-input.webp" alt=""  />
 这个功能我觉得对于长词输入是很棒的</p>
</li>
<li>
<p>添加了类似搜狗U模式的拆字模式，效果如图：</p>
<p><img loading="lazy" src="/Distributions/fcitx5-chaizi.webp" alt=""  />
</p>
</li>
<li>
<p>还有一件事是 Fcitx5 可以使用 <code>fcitx</code>, <code>fcitx5</code>, <code>ibus</code> 的输入法模块（感觉黑科技</p>
</li>
<li>
<p>我从 rime 移植过来一份<a href="https://github.com/CoelacanthusHex/dotfiles/blob/master/fcitx5/.local/share/fcitx5/pinyin/symbolic.dict.txt">符号表</a>，这样输入就方便了很多</p>
</li>
</ul>
<p><strong>优势</strong></p>
<ul>
<li>上述几条个人认为皆为优势</li>
<li><code>fcitx5-rime</code> 支持加载动态库形式的 Rime 插件，在设置中填写插件名称即可使用，注意 octagram 插件名称与文件名并不一样（<code>fcitx-rime</code> 无此支持，<code>ibus-rime</code> 有此支持但是似乎配置文件有点问题（喜讯：Arch 官方仓库中的 <code>librime</code> 已经打包了 lua 和 octagram（即语料库）插件</li>
<li>自带一套 LaTeX 简易输入表（虽然只能输入一小部分特殊字符</li>
<li>笔画过滤: 参见 <a href="https://wiki.archlinux.org/index.php?title=Fcitx5_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E4%BD%BF%E7%94%A8%E7%AC%94%E7%94%BB%E8%BF%87%E6%BB%A4">Fcitx5_使用笔画过滤</a></li>
<li>以词定字</li>
<li>查看选中文字的 Unicode 编码：选中文字，然后使用快捷键 ctrl + alt + shift + u 可以查看选中文字的编码</li>
<li>更好的支持（Fcitx4 已经停止支持</li>
</ul>
<p><strong>关于设置</strong></p>
<p>推荐以下设置：</p>
<ul>
<li>预测看个人喜好</li>
<li>启用颜文字</li>
<li>云拼音根据需要来，但是不推荐 Google 后端，原因显然</li>
<li>preedit 也就是单行显示自己选择</li>
<li>安装肥猫百万大词库（墙裂推荐</li>
<li>Lua 插件！！！自带日期和时间，另外<a href="https://github.com/glaumar/fcitx5-lua-scripts">推荐几个</a>，内含进制转换、简易计算器和密码生成器</li>
</ul>
<p><strong>主题美化</strong></p>
<p>有以下几种选择：</p>
<ul>
<li>
<p><code>kimpanel</code>(KDE)/<code>gnome-shell-extension-kimpanel</code>(Gnome) （同时这也应该是目前 Wayland 下唯一的方案）</p>
</li>
<li>
<p><a href="https://github.com/hosxy/Fcitx5-Material-Color">Material Color 主题</a>，有多种颜色以及单行双行两种模式，Arch 官方源有打包</p>
<p><img loading="lazy" src="/Distributions/Fcitx5-Material-Color-No-Preedit.webp" alt=""  />
</p>
</li>
<li>
<p><a href="https://github.com/hosxy/fcitx5-dark-transparent">黑色透明主题</a></p>
<p><img loading="lazy" src="/Distributions/fcitx5-skin-dark-transparent.webp" alt=""  />
</p>
</li>
<li>
<p><a href="https://github.com/evansan/fcitx5-dark">黑色主题</a></p>
<p><img loading="lazy" src="/Distributions/fcitx5-skin-dark.webp" alt=""  />
</p>
</li>
<li>
<p><a href="https://github.com/hosxy/Fcitx5-Materia-EXP">Materia EXP 主题</a>，系统使用暗色主题的用户请谨慎使用</p>
<p><img loading="lazy" src="/Distributions/Fcitx5-Materia-EXP.webp" alt=""  />
</p>
</li>
<li>
<p><a href="https://github.com/weearc/fcitx5-skin-simple-blue">Simple Blue 主题</a></p>
<p><img loading="lazy" src="/Distributions/fcitx5-skin-simple-blue.webp" alt=""  />
</p>
</li>
<li>
<p><a href="https://github.com/escape0707/fcitx5-adwaita-dark">Adwaita-dark</a>，推荐 Gnome 用户使用</p>
<p><img loading="lazy" src="/Distributions/fcitx5-skin-adwaita-dark.webp" alt=""  />
</p>
</li>
<li>
<p>经典的<a href="https://github.com/hrko99/fcitx-skin-material">Material 主题</a>，这个主题同时支持4和5 <del>我都没注意这个主题更新了 fcitx5 支持</del>（fcitx5 版本有人<a href="https://aur.archlinux.org/packages/fcitx5-skin-material/">在 AUR 上打了包</a>，包名：<code>fcitx5-skin-material</code></p>
</li>
<li>
<p><a href="https://github.com/btstream/fcitx5-skin-base16-material-darker">base16 material darker 主题</a></p>
</li>
<li>
<p>自制主题 <del>（顺便写份主题文档吧</del></p>
</li>
</ul>
<p>以上主题在 AUR 皆有打包(似乎目前已有主题在 AUR 上都有打包了</p>
<h5 id="fcitx5皮肤制作httpsbbsdeepinorgphonezhpost223810"><a href="https://bbs.deepin.org/phone/zh/post/223810">fcitx5皮肤制作</a><a hidden class="anchor" aria-hidden="true" href="#fcitx5皮肤制作httpsbbsdeepinorgphonezhpost223810">#</a></h5>
<p>这次是 fcitx5 是用搜狗皮肤（无法实现动态）！</p>
<p><strong>下载仓库</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ git clone https://github.com/fkxxyz/ssfconv.git
$ cd ssfconv
</code></pre></div><p><strong>下载皮肤</strong></p>
<p>先从<a href="https://pinyin.sogou.com/skins/">搜狗输入法的皮肤官网</a>下载自己喜欢的皮肤，得到ssf格式的文件，例如 【雨欣】蒲公英的思念.ssf</p>
<p><strong>转换皮肤</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./ssfconv -t fcitx5 【雨欣】蒲公英的思念.ssf 【雨欣】蒲公英的思念
</code></pre></div><p><strong>复制到用户皮肤目录</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir -p ~/.local/share/fcitx5/themes/
$ cp -r 【雨欣】蒲公英的思念 ~/.local/share/fcitx5/themes/
</code></pre></div><p><strong>使用该皮肤</strong></p>
<p>用下面这条命令可以看到该皮肤的名称：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ grep Name ~/.local/share/fcitx5/themes/【雨欣】蒲公英的思念/theme.conf
</code></pre></div><p>直接修改配置文件 <code>~/.config/fcitx5/conf/classicui.conf</code>，将 Theme 的值改成这个皮肤的名称即可。</p>
<h5 id="fcitx5rime的畅快体验httpszhuanlanzhihucomp287774005"><a href="https://zhuanlan.zhihu.com/p/287774005">fcitx(5)+rime的畅快体验</a><a hidden class="anchor" aria-hidden="true" href="#fcitx5rime的畅快体验httpszhuanlanzhihucomp287774005">#</a></h5>
<ul>
<li>
<p>下载词库转换工具：<a href="https://github.com/studyzy/imewlconverter">imewlconverter</a></p>
</li>
<li>
<p>安装 dotnet-runtime</p>
</li>
<li>
<p>寻找词库文件</p>
<ul>
<li>比如从搜狗词库中寻找：<a href="https://pinyin.sogou.com/dict/">搜狗细胞词库词库下载词典_输入法字典</a></li>
<li>或者从qq词库中寻找：<a href="http://cdict.qq.pinyin.cn/v1/">QQ输入法-词库平台</a></li>
</ul>
</li>
<li>
<p>转换词库文件：以“网络工程词库.scel”为例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ dotnet ImeWlConverterCmd.dll -ct:pinyin -os:linux -i:scel ./网络工程词库.scel -o:rime ./network.txt
</code></pre></div><ul>
<li>-i:scel对应搜狗的词库文件后缀，如果你要转换qq的词库文件把这里改成qcel</li>
<li>-o:rime ./network.txt表示按照rime输入法词库文件格式转换，转换出的文件在当前目录下，且名字为network.txt</li>
</ul>
</li>
<li>
<p>转换完成之后将这个文件拷贝到你的用户资料目录下：</p>
<ul>
<li>fcitx4: ~/.config/fcitx/rime</li>
<li>fcitx5:~/.local/share/fcixt5/rime</li>
</ul>
<p>文件以luna_pinyin.xxx.dict.yaml的格式命名，如luna_pinyin.network.dict.yaml，之后重启fcitx(5)即可</p>
</li>
</ul>
<p><a href="https://www.jianguoyun.com/p/DbMBwGIQ1-KSCRiqiNoD">dict.7z </a>是我的词库文件，拿去解压到你的用户资料目录下即可使用。</p>
<h4 id="环境配置httpswikiarchlinuxorgtitlefcitxset_environment_variables_for_im_modules"><a href="https://wiki.archlinux.org/title/fcitx#Set_environment_variables_for_IM_modules">环境配置</a><a hidden class="anchor" aria-hidden="true" href="#环境配置httpswikiarchlinuxorgtitlefcitxset_environment_variables_for_im_modules">#</a></h4>
<p>无论选择哪个版本、哪个仓库，安装完成后，均执行此配置，这里另开一个终端，以普通用户编辑 <code>~/.pam_environment</code> 文件（这里为普通用户的家目录下，不存在则创建一个），然后添加以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">GTK_IM_MODULE DEFAULT<span style="color:#f92672">=</span>fcitx
QT_IM_MODULE  DEFAULT<span style="color:#f92672">=</span>fcitx
XMODIFIERS    DEFAULT<span style="color:#f92672">=</span><span style="color:#ae81ff">\@</span>im<span style="color:#f92672">=</span>fcitx
SDL_IM_MODULE DEFAULT<span style="color:#f92672">=</span>fcitx
</code></pre></div><p>之后，登出 KDE Plasma，后重新登陆，此时只需做最后的配置，以安装的为 <code>fcitx:5</code> 为例，</p>
<ol>
<li>右击托盘区输入法图标，选择 <code>Configure</code></li>
<li>点击右下角 <code>Add Input Method</code></li>
<li>search 框下输入 <code>Pinyin</code></li>
<li>选中 Pinyin 后点击右下角的 <code>Add</code></li>
<li><code>Apply</code> 后退出界面</li>
<li>右击托盘区输入法图标，选择 <code>Restart</code></li>
</ol>
<h4 id="rimehttpszhuanlanzhihucomp114296129"><a href="https://zhuanlan.zhihu.com/p/114296129">Rime</a><a hidden class="anchor" aria-hidden="true" href="#rimehttpszhuanlanzhihucomp114296129">#</a></h4>
<p>安装 rime 输入法引擎</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># fcitx4</span>
$ sudo emerge app-i18n/fcitx-rime
<span style="color:#75715e"># fcitx5</span>
$ sudo emerge app-i18n/fcitx5-rime
</code></pre></div><p>下载 <a href="https://github.com/fkxxyz/rime-cloverpinyin/wiki/linux">rime-cloverpinyin</a> 最新版本（如clover.schema-build-1.1.4.zip）输入方案（配置方案），解压到用户资料夹：</p>
<ul>
<li>fcitx：~/.config/fcitx/rime</li>
<li>fcitx5：~/.local/share/fcitx5/rime</li>
</ul>
<p>在用户资料夹下创建 default.custom.yaml ，内容为</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">patch:
  <span style="color:#e6db74">&#34;menu/page_size&#34;</span>: <span style="color:#ae81ff">8</span>
  schema_list:
    - schema: clover
</code></pre></div><p>其中 8 表示打字的时候输入面板的每一页的候选词数目，可以设置成 1~9 任意数字。</p>
<p>写好该文件之后，点击右下角托盘图标右键菜单，点“重新部署”，然后再点右键，在方案列表里面应该就有“ 🍀️四叶草拼音输入法”的选项了。</p>
<p>更多访问 <a href="https://rime.im/">Rime 官网</a>。</p>
<h2 id="settings">Settings<a hidden class="anchor" aria-hidden="true" href="#settings">#</a></h2>
<h3 id="system-settings">System Settings<a hidden class="anchor" aria-hidden="true" href="#system-settings">#</a></h3>
<p>Appearance</p>
<ul>
<li>Global Theme: Breeze</li>
</ul>
<p>Workspace Behavior</p>
<ul>
<li>General Behavior
<ul>
<li>Clicking files or folders: Selects them</li>
</ul>
</li>
<li>Screen Locking
<ul>
<li>Lock screen automatically: 10 minutes</li>
</ul>
</li>
</ul>
<p>Startup and Shutdown</p>
<ul>
<li>Login Screen
<ul>
<li>Breeze</li>
</ul>
</li>
</ul>
<p>Regional Settings</p>
<ul>
<li>Date &amp; Time
<ul>
<li>Set date and time automatically</li>
</ul>
</li>
</ul>
<p>Connections</p>
<ul>
<li>IPv4
<ul>
<li>Method: Automatic (Only addresses)</li>
<li>DNS Servers: 114.114.114.114</li>
</ul>
</li>
</ul>
<p>Settings</p>
<ul>
<li>Proxy
<ul>
<li>Use manually specified proxy configuration</li>
</ul>
</li>
</ul>
<p>Display Configuration</p>
<ul>
<li>
<p>Night Color</p>
<ul>
<li>
<p>Activate Night Color</p>
</li>
<li>
<p>Sunset to sunrise at manual location</p>
<p>Beijin: 39.90403 116.40753</p>
</li>
</ul>
</li>
</ul>
<h3 id="bluetoothhttpswikigentooorgwikibluetooth"><a href="https://wiki.gentoo.org/wiki/Bluetooth">Bluetooth</a><a hidden class="anchor" aria-hidden="true" href="#bluetoothhttpswikigentooorgwikibluetooth">#</a></h3>
<p>蓝牙默认是无法使用的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># systemctl enable bluetooth</span>
</code></pre></div><h3 id="首选编辑器">首选编辑器<a hidden class="anchor" aria-hidden="true" href="#首选编辑器">#</a></h3>
<p>Gentoo Linux 默认安装的编辑器为 <code>nano</code> ，这是一个初始设置下就很适合新手的编辑器，如果你有其它的要求，比如想使用 <code>vim</code> 或者 <code>emacs</code> ，可以先安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge -vj app-editors/vim</span>
<span style="color:#75715e"># emerge -vj app-editors/emacs</span>
</code></pre></div><p>列出当前存在的编辑器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect editor list</span>
</code></pre></div><p>根据所需要的编辑器对应的序号，设置默认</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect editor set 「序号」</span>
<span style="color:#75715e"># . /etc/profile</span>
</code></pre></div><h2 id="apps">Apps<a hidden class="anchor" aria-hidden="true" href="#apps">#</a></h2>
<h3 id="mutt">mutt<a hidden class="anchor" aria-hidden="true" href="#mutt">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge net-mail/fetchmail mail-filter/procmail mail-client/mutt mail-mta/msmtp</span>
</code></pre></div><h3 id="mpv">mpv<a hidden class="anchor" aria-hidden="true" href="#mpv">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge media-video/mpv</span>
</code></pre></div><h3 id="spotify">spotify<a hidden class="anchor" aria-hidden="true" href="#spotify">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge media-sound/spotify</span>
</code></pre></div><h3 id="youtube-dl">youtube-dl<a hidden class="anchor" aria-hidden="true" href="#youtube-dl">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge dev-python/pip</span>
...
</code></pre></div><h3 id="aria2">aria2<a hidden class="anchor" aria-hidden="true" href="#aria2">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;net-misc/aria2 bittorrent&#39; &gt; /etc/portage/package.use/aria2</span>
<span style="color:#75715e"># emerge net-misc/aria2</span>
</code></pre></div><h3 id="typora">Typora<a hidden class="anchor" aria-hidden="true" href="#typora">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;=app-editors/typora-0.11.18::gentoo-zh=&#39; &gt; /etc/portage/package.unmask/typora</span>
<span style="color:#75715e"># echo &#39;=app-editors/typora-0.11.18::gentoo-zh ~amd64&#39; &gt; /etc/portage/package.accept_keywords/typora</span>
<span style="color:#75715e"># cp -av /opt/typora/share/icons/hicolor/* /usr/share/icons/hicolor/</span>
</code></pre></div><h3 id="zsh">zsh<a hidden class="anchor" aria-hidden="true" href="#zsh">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-shells/zsh</span>
$ chsh
Password: 
Changing the login shell <span style="color:#66d9ef">for</span> kurome
Enter the new value, or press ENTER <span style="color:#66d9ef">for</span> the default
        Login Shell <span style="color:#f92672">[</span>/bin/bash<span style="color:#f92672">]</span>: /bin/zsh
</code></pre></div><h3 id="clash">Clash<a hidden class="anchor" aria-hidden="true" href="#clash">#</a></h3>
<p>clash 需要 root 执行，编写一个 service 就可以了。</p>
<p>cfw 无法设置 port，总是重置为 0。</p>
<h3 id="browsers">Browsers<a hidden class="anchor" aria-hidden="true" href="#browsers">#</a></h3>
<p>关于浏览器的选择有很多，比如</p>
<ul>
<li>www-client/google-chrome （chrome 的官方二进制包）</li>
<li>www-client/google-chrome-beta （chrome 的官方二进制包， beta 分支）</li>
<li>www-client/chromium （chromium 源码包，需编译，时间很久很久）</li>
<li>www-client/firefox-bin （火狐官方二进制包，国际版）</li>
<li>www-client/firefox （火狐源码包，需编译，时间很久）</li>
<li>www-client/microsoft-edge-beta （Edge 官方二进制包， beta 分支）</li>
<li>等</li>
</ul>
<p>可以自行选择安装。命令依旧是 <code>emerge &lt;包名&gt;</code> 。安装个别浏览器时，可能会因为许可问题导致无法安装，如何解决看下文的 <a href="#Licenses">软件的许可</a> 一节。</p>
<p>其它的应用自行发掘。这里有推荐应用列表：</p>
<ul>
<li><a href="https://wiki.gentoo.org/wiki/Recommended_applications">https://wiki.gentoo.org/wiki/Recommended_applications</a></li>
<li><a href="https://wiki.archlinux.org/title/List_of_applications">https://wiki.archlinux.org/title/List_of_applications</a></li>
</ul>
<p>至此，桌面配置告一段落。</p>
<h3 id="kio-extrashttpswikigentooorgwikimtp"><a href="https://wiki.gentoo.org/wiki/MTP">kio-extras</a><a hidden class="anchor" aria-hidden="true" href="#kio-extrashttpswikigentooorgwikimtp">#</a></h3>
<p>(only for kde)</p>
<p><strong>MTP</strong> (<strong>M</strong>edia <strong>T</strong>ransfer <strong>P</strong>rotocol) is a protocol to allow the transfer of files to external devices. It is provided by several programs, most of them depending on <a href="https://wiki.gentoo.org/wiki/FUSE">FUSE</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;kde-apps/kio-extras mtp&#39; &gt; /etc/portage/package.use/kio-extras</span>
<span style="color:#75715e"># emerge --ask kde-apps/kio-extras</span>
</code></pre></div><h4 id="gwenview">Gwenview<a hidden class="anchor" aria-hidden="true" href="#gwenview">#</a></h4>
<p>KDE app，看图。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge kde-apps/gwenview</span>
</code></pre></div><h4 id="okular">Okular<a hidden class="anchor" aria-hidden="true" href="#okular">#</a></h4>
<p>KDE app，PDF 阅读。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge kde-apps/okular</span>
</code></pre></div><h3 id="ktimer">KTimer<a hidden class="anchor" aria-hidden="true" href="#ktimer">#</a></h3>
<p>KDE app，类似于 cronie，只不过是GUI。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge kde-apps/ktimer</span>
</code></pre></div><h3 id="kclock">KClock<a hidden class="anchor" aria-hidden="true" href="#kclock">#</a></h3>
<p>KDE app，一个时钟。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># eselect repository enable guru</span>
<span style="color:#75715e"># emerge --sync guru</span>
<span style="color:#75715e"># echo &#39;*/*::guru&#39; &gt; /etc/portage/package.mask/guru</span>
<span style="color:#75715e"># echo &#39;=kde-apps/kclock-21.12::guru&#39; &gt; /etc/portage/package.unmask/kclock</span>
<span style="color:#75715e"># echo &#39;=kde-apps/kclock-21.12::guru ~amd64&#39; &gt; /etc/portage/package.accept_keywords/kclock</span>
<span style="color:#75715e"># echo &#39;=kde-frameworks/kirigami-addons-0.2::guru&#39; &gt;&gt; /etc/portage/package.unmask/kclock</span>
<span style="color:#75715e"># echo &#39;=kde-frameworks/kirigami-addons-0.2::guru ~amd64&#39; &gt;&gt; /etc/portage/package.accept_keywords/kcloc</span>
<span style="color:#75715e"># emerge kde-apps/kclock</span>
</code></pre></div><h3 id="rsibreakhttpsuserbasekdeorgrsibreakzh-cn"><a href="https://userbase.kde.org/RSIBreak/zh-cn">RSIBreak</a><a hidden class="anchor" aria-hidden="true" href="#rsibreakhttpsuserbasekdeorgrsibreakzh-cn">#</a></h3>
<p>番茄钟</p>
<h3 id="libreoffice">LibreOffice<a hidden class="anchor" aria-hidden="true" href="#libreoffice">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-office/libreoffice-bin</span>
</code></pre></div><h3 id="flameshot">Flameshot<a hidden class="anchor" aria-hidden="true" href="#flameshot">#</a></h3>
<p>很棒的截图软件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge media-gfx/flameshot
</code></pre></div><h4 id="spectacle">Spectacle<a hidden class="anchor" aria-hidden="true" href="#spectacle">#</a></h4>
<p>KDE app，用的不是很习惯。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge kde-apps/spectacle</span>
</code></pre></div><h3 id="keepassxchttpskeepassxcorg"><a href="https://keepassxc.org/">KeePassXC</a><a hidden class="anchor" aria-hidden="true" href="#keepassxchttpskeepassxcorg">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-admin/keepassxc</span>
</code></pre></div><h3 id="ppsspp">PPSSPP<a hidden class="anchor" aria-hidden="true" href="#ppsspp">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#34;games-emulation/ppsspp ~amd64&#34; &gt;&gt; /etc/portage/package.accept_keywords/ppsspp</span>
<span style="color:#75715e"># emerge games-emulation/ppsspp</span>
</code></pre></div><h3 id="papirus-icon-themehttpsgithubcompapirusdevelopmentteampapirus-icon-theme"><a href="https://github.com/PapirusDevelopmentTeam/papirus-icon-theme">papirus-icon-theme</a><a hidden class="anchor" aria-hidden="true" href="#papirus-icon-themehttpsgithubcompapirusdevelopmentteampapirus-icon-theme">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge -a papirus-icon-theme
</code></pre></div><h3 id="vulkanhttpswikigentooorgwikivulkan"><a href="https://wiki.gentoo.org/wiki/Vulkan">Vulkan</a><a hidden class="anchor" aria-hidden="true" href="#vulkanhttpswikigentooorgwikivulkan">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask media-libs/vulkan-loader</span>
</code></pre></div><h3 id="tree">tree<a hidden class="anchor" aria-hidden="true" href="#tree">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-text/tree</span>
</code></pre></div><h3 id="qemu">qemu<a hidden class="anchor" aria-hidden="true" href="#qemu">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo &#39;QEMU_SOFTMMU_TARGETS=&#34;x86_64&#34;&#39; &gt;&gt; /etc/portage/make.conf</span>
<span style="color:#75715e"># echo &#39;QEMU_USER_TARGETS=&#34;x86_64&#34;&#39; &gt;&gt; /etc/portage/make.conf</span>
<span style="color:#75715e"># emerge app-emulation/qemu net-fs/samba</span>
<span style="color:#75715e"># gpasswd -a kurome kvm</span>
</code></pre></div><p><a href="https://www.dedoimedo.com/computers/kvm-permission-denied.html">Could not access KVM kernel module: Permission denied</a></p>
<h3 id="dockerhttpswikigentooorgwikidocker"><a href="https://wiki.gentoo.org/wiki/Docker">Docker</a><a hidden class="anchor" aria-hidden="true" href="#dockerhttpswikigentooorgwikidocker">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask --verbose app-emulation/docker</span>
<span style="color:#75715e"># systemctl enable docker.service</span>
<span style="color:#75715e"># systemctl start docker.service</span>
<span style="color:#75715e"># usermod -aG docker &lt;username&gt;</span>
<span style="color:#75715e"># docker run --rm hello-world</span>
</code></pre></div><h3 id="lsusbhttpswikigentooorgwikiusbutils"><a href="https://wiki.gentoo.org/wiki/Usbutils">lsusb</a><a hidden class="anchor" aria-hidden="true" href="#lsusbhttpswikigentooorgwikiusbutils">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask sys-apps/usbutils</span>
</code></pre></div><h3 id="p7ziphttpswikigentooorgwikip7zip"><a href="https://wiki.gentoo.org/wiki/P7zip">p7zip</a><a hidden class="anchor" aria-hidden="true" href="#p7ziphttpswikigentooorgwikip7zip">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-arch/p7zip</span>
</code></pre></div><p><strong>Important</strong>: The 7-zip archive format does <strong>not</strong> store standard Unix file permissions such as owner/group or extended file attributes. Those who desire to use 7-zip as a long-term backup or archiving solution should wrap files in a tar archive before compressing with <strong>7z</strong>. Use the following command to archive directories of files, preserving Unix file permissions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ tar cf - &lt;directory&gt; | 7za a -si &lt;directory&gt;.tar.7z
</code></pre></div><p>To extract:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ 7za x -so &lt;directory&gt;.tar.7z | tar xf -
</code></pre></div><h4 id="ziphttpswwwtecmintcomunzip-extract-zip-files-to-specific-directory-in-linux"><a href="https://www.tecmint.com/unzip-extract-zip-files-to-specific-directory-in-linux/">zip</a><a hidden class="anchor" aria-hidden="true" href="#ziphttpswwwtecmintcomunzip-extract-zip-files-to-specific-directory-in-linux">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge app-arch/zip</span>
</code></pre></div><h4 id="arkhttpsappskdeorgark"><a href="https://apps.kde.org/ark/">Ark</a><a hidden class="anchor" aria-hidden="true" href="#arkhttpsappskdeorgark">#</a></h4>
<p>File archiver by KDE</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge kde-apps/ark</span>
</code></pre></div><h3 id="adb-and-fastboothttpswikigentooorgwikiandroidadb"><a href="https://wiki.gentoo.org/wiki/Android/adb">ADB and Fastboot</a><a hidden class="anchor" aria-hidden="true" href="#adb-and-fastboothttpswikigentooorgwikiandroidadb">#</a></h3>
<p>Fastboot is included with ADB inside the <a href="https://packages.gentoo.org/packages/dev-util/android-tools">dev-util/android-tools</a> package::</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge --ask dev-util/android-tools</span>
</code></pre></div><p>To run adb without root privileges then the unprivileged user account must be added to the plugdev group:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># groupmod -a plugdev -U kurome</span>
</code></pre></div><p><strong>no permissions (missing udev rules? user is in the plugdev group)</strong></p>
<p>需<a href="https://wiki.archlinux.org/title/Android_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E6%B7%BB%E5%8A%A0_udev_%E8%A7%84%E5%88%99">添加 udev 规则</a>：使用下面的模板，并用你的 [VENDOR ID] 和 [PRODUCT ID] 替换里面的值。 然后把这些规则复制到 <code>/etc/udev/rules.d/51-android.rules</code>：</p>
<pre tabindex="0"><code>SUBSYSTEM==&quot;usb&quot;, ATTR{idVendor}==&quot;[VENDOR ID]&quot;, MODE=&quot;0666&quot;, GROUP=&quot;adbusers&quot;
SUBSYSTEM==&quot;usb&quot;,ATTR{idVendor}==&quot;[VENDOR ID]&quot;,ATTR{idProduct}==&quot;[PRODUCT ID]&quot;,SYMLINK+=&quot;android_adb&quot;
SUBSYSTEM==&quot;usb&quot;,ATTR{idVendor}==&quot;[VENDOR ID]&quot;,ATTR{idProduct}==&quot;[PRODUCT ID]&quot;,SYMLINK+=&quot;android_fastboot&quot;
</code></pre><p>再加载刚定义的规则，运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># udevadm control --reload-rules</span>
</code></pre></div><p>确保你是 adbusers user group 的成员，以访问 adb 设备。</p>
<p><strong>adb: device unauthorized.</strong></p>
<p>请打开手机同意 USB 调试。</p>
<h4 id="file-transfer">File transfer<a hidden class="anchor" aria-hidden="true" href="#file-transfer">#</a></h4>
<p><strong>Push a file</strong></p>
<pre tabindex="0"><code>$ adb push mypicture.png /sdcard/on/device
</code></pre><p><strong>Push a folder</strong></p>
<pre tabindex="0"><code>$ adb push myfolder /sdcard/on/device
</code></pre><p><strong>Push all files in a folder</strong></p>
<pre tabindex="0"><code>$ adb push myfolder/ /sdcard/on/device
</code></pre><p><strong>Pull a file</strong></p>
<pre tabindex="0"><code>$ adb pull /sdcard/on/device/mypicture.png
</code></pre><p><strong>Pull a folder</strong></p>
<pre tabindex="0"><code>$ adb pull /sdcard/on/device /home/̩$(whoami)/android-folder/
</code></pre><h3 id="flatpak">Flatpak<a hidden class="anchor" aria-hidden="true" href="#flatpak">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cat &gt;&gt; /etc/portage/accept_keywords/flatpak</span>
sys-apps/flatpak ~amd64
acct-user/flatpak ~amd64
acct-group/flatpak ~amd64
dev-util/ostree ~amd64
<span style="color:#75715e"># emerge sys-apps/flatpak</span>
<span style="color:#75715e"># flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo</span>
<span style="color:#75715e"># flatpak remote-modify flathub --url=https://mirror.sjtu.edu.cn/flathub</span>
</code></pre></div><h3 id="neofetchhttpszhuanlanzhihucomp69777438"><a href="https://zhuanlan.zhihu.com/p/69777438">neofetch</a><a hidden class="anchor" aria-hidden="true" href="#neofetchhttpszhuanlanzhihucomp69777438">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge app-misc/neofetch
</code></pre></div><h4 id="使用自定义图像">使用自定义图像<a hidden class="anchor" aria-hidden="true" href="#使用自定义图像">#</a></h4>
<p>默认情况下，Neofetch 将显示你的操作系统 logo 以及系统信息。当然，你可以根据需要更改图像。</p>
<p>要显示图像，Linux 系统应该安装以下依赖项：</p>
<ol>
<li>w3m-img（用于显示图像。w3m-img 有时与 w3m 包捆绑在一起），</li>
<li>Imagemagick（用于创建缩略图），</li>
</ol>
<p>大多数 Linux 发行版的默认仓库中都提供了 w3m-img 和 ImageMagick 包。因此，你可以使用你的发行版的默认包管理器来安装它们。</p>
<p>现在，运行以下命令以使用自定义图像显示系统信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ neofetch --w3m /home/sk/Pictures/image.png
</code></pre></div><p>或者，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ neofetch --w3m --source /home/sk/Pictures/image.png
</code></pre></div><p>或者，你可以指向包含以下图像的目录。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ neofetch --w3m &lt;path-to-directory&gt;
</code></pre></div><h4 id="配置-neofetch">配置 Neofetch<a hidden class="anchor" aria-hidden="true" href="#配置-neofetch">#</a></h4>
<p>当我们第一次运行 Neofetch 时，它默认会为每个用户在 <code>$HOME/.config/neofetch/config.conf</code> 中创建一个配置文件。你可以调整此文件来告诉 neofetch 该显示、删除和/或修改哪些详细信息。</p>
<p>还可以在不同版本中保留此配置文件。这意味着你只需根据自己的喜好自定义一次，并在升级到更新版本后使用相同的设置。你甚至可以将此文件共享给你的朋友和同事，使他拥有与你相同的设置。</p>
<h3 id="cpuid2cpuflags">cpuid2cpuflags<a hidden class="anchor" aria-hidden="true" href="#cpuid2cpuflags">#</a></h3>
<p>检测cpu指令集</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge app-portage/cpuid2cpuflags
$ sudo cpuid2cpuflags 
</code></pre></div><p>安装完成之后使用该指令并将输出值作为CPU_FLAGS_X86的值输入到make.conf中</p>
<h3 id="flaggie">flaggie<a hidden class="anchor" aria-hidden="true" href="#flaggie">#</a></h3>
<p>安装flaggie来更加方便的管理单个包的USE变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge app-portage/flaggie
</code></pre></div><p>用法：比如添加a包的b特性</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># flaggie a +b</span>
</code></pre></div><p>去掉c包的d特性</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># flaggie c -d</span>
</code></pre></div><h2 id="others">Others<a hidden class="anchor" aria-hidden="true" href="#others">#</a></h2>
<h3 id="recommended-applicationshttpswikigentooorgwikirecommended_applications-gentoo"><a href="https://wiki.gentoo.org/wiki/Recommended_applications">Recommended applications</a>: Gentoo<a hidden class="anchor" aria-hidden="true" href="#recommended-applicationshttpswikigentooorgwikirecommended_applications-gentoo">#</a></h3>
<h3 id="list-of-applicationshttpswikiarchlinuxorgtitlelist_of_applications-arch"><a href="https://wiki.archlinux.org/title/List_of_applications">List of applications</a>: Arch<a hidden class="anchor" aria-hidden="true" href="#list-of-applicationshttpswikiarchlinuxorgtitlelist_of_applications-arch">#</a></h3>
<h2 id="tips-2">Tips<a hidden class="anchor" aria-hidden="true" href="#tips-2">#</a></h2>
<h3 id="为-portage-包管理器设置代理httpsbitbilinetset-proxy-for-gentoo-portagehtml"><a href="https://bitbili.net/set-proxy-for-gentoo-portage.html">为 Portage 包管理器设置代理</a><a hidden class="anchor" aria-hidden="true" href="#为-portage-包管理器设置代理httpsbitbilinetset-proxy-for-gentoo-portagehtml">#</a></h3>
<p>开门见山，本文介绍在 Gentoo Linux 下如何正确地对其包管理器 Portage 设置代理，即日常使用的 emerge 命令。这里介绍软件下载安装时需要的配置；对于同步 Portage 树，则是部分适用。</p>
<h4 id="gentoo-的默认设置">Gentoo 的默认设置<a hidden class="anchor" aria-hidden="true" href="#gentoo-的默认设置">#</a></h4>
<ul>
<li>代理： 无</li>
<li>工具： 默认使用 <code>wget</code> 作为下载工具，但对于绝大部分的 live 包，会有针对的 eclass 使用对应的版本控制工具从远程仓库抓取，这里仅以 <code>git</code> 为例。</li>
</ul>
<p>live 包：即版本号带 <code>9999*</code> 的这些包；用于匹配 live ebuild 文件名的正则表达式为 <code>9999*(-r[0-9]{1,3})?.ebuild$</code> ，可还是有一些包使用了这种版本命名规则却并非真正的 live 包，比如 <code>openjfx/openjfx-8.999.ebuild</code> ；这里不会通过版本号来判断是否需要配置 git 参数，所以并不影响，仅作介绍。</p>
<h4 id="持久性地修改代理">持久性地修改代理<a hidden class="anchor" aria-hidden="true" href="#持久性地修改代理">#</a></h4>
<h5 id="通用配置">通用配置<a hidden class="anchor" aria-hidden="true" href="#通用配置">#</a></h5>
<p><code>$ man make.conf</code> 可以看到里面有说明如何配置代理，但是过于简要，这边详细说明。</p>
<p>对于一般情况，在 <code>/etc/portage/make.conf</code> 文件下配置如下三个变量，就完全足够：</p>
<pre tabindex="0"><code>http_proxy=&quot;[protocol://][user[:password]@]proxyhost[:port]&quot;
https_proxy=&quot;[protocol://][user[:password]@]proxyhost[:port]&quot;
ftp_proxy=&quot;[protocol://][user[:password]@]proxyhost[:port]&quot;
</code></pre><p>这些变量会在 emerge 命令运行时，传递给预配置的 <code>FETCHCOMMAND</code> 即 <code>wget</code> 命令。但，该命令有一个问题是不支持 socks 协议；所以，对于不同的协议需要有不同的代理服务，这样子很麻烦。</p>
<p>修改以支持 socks 协议有一个应变的方法，即修改默认的获取命令为 <code>curl</code> ，同样是在 <code>/etc/portage/make.conf</code> 文件下配置变量，如下：</p>
<pre tabindex="0"><code>FETCHCOMMAND=&quot;curl --retry 3 --connect-timeout 60 --ftp-pasv -Lfo \&quot;\${DISTDIR}/\${FILE}\&quot; \&quot;\${URI}\&quot;&quot;
RESUMECOMMAND=&quot;curl -C - --retry 3 --connect-timeout 60 --ftp-pasv -Lfo \&quot;\${DISTDIR}/\${FILE}\&quot; \&quot;\${URI}\&quot;&quot;
</code></pre><p>其中 <code>RESUMECOMMAND</code> 是用于恢复意外中断的下载命令，保存后即完成修改，此时，就可以给不同协议配置同样的 socks 类协议的代理服务，均可生效。如：</p>
<pre tabindex="0"><code>https_proxy=&quot;socks5h://127.0.0.1:1080&quot;
</code></pre><h5 id="单独配置-git-抓取">单独配置 git 抓取<a hidden class="anchor" aria-hidden="true" href="#单独配置-git-抓取">#</a></h5>
<p>对于 live 包，它们目前大多数直接使用 <code>git</code> 命令从远程仓库抓取。其它版本控制工具（目前支持的大致有 bzr, cvs, darcs, mercurial, subversion）同理，请自行修改后套用；当然也有直接使用 <code>wget|curl</code> 下载 live 包的情况，那么这种情况如上「一」述。</p>
<p><code>git</code> 命令支持 socks 协议，并且除了能吃上述配置的环境变量外，</p>
<p>配置 <code>https_proxy</code> 时也配好 <code>http_proxy</code> ，否则可能出现 SSL_ERROR_SYSCALL 错误。</p>
<p>还能独立于其它包单独配置 git 自身的代理，方法有两种：</p>
<ol>
<li>
<p>git 能配置针对整个 Linux 系统的参数，运行：</p>
<pre tabindex="0"><code>git config --system http.proxy '[protocol://][user[:password]@]proxyhost[:port]'
</code></pre><p>此命令会将配置写入到 <code>/etc/gitconfig</code> 文件内，并生效于系统级别，会被用户/项目级别的配置覆盖。</p>
</li>
<li>
<p>通过 Portage 的全局 <a href="https://wiki.gentoo.org/wiki//etc/portage/bashrc">bashrc</a> 文件 <code>/etc/portage/bashrc</code> 来配置临时的 git 代理</p>
<p>这种方式会对系统配置造成最少的干扰，只略微繁琐一点，需要将下述脚本代码写入上述的 bashrc 文件内：</p>
<pre tabindex="0"><code>if [[ ${EBUILD_PHASE} == &quot;unpack&quot; &amp;&amp; ${INHERITED} =~ git\-r3 ]]; then
  git config --global http.proxy '[protocol://][user[:password]@]proxyhost[:port]'
fi
</code></pre><p>这个 bashrc 只被 Portage 引用，会在进入每一个安装阶段时被导入。目前，Portage 下抓取 git 项目是通过 <code>git-r3.eclass</code> 实现，该 eclass 定义了 git 项目是在 src_unpack 阶段被更新，所以这里只需要在此阶段时设置即可。且，因为该目录不是被抓取包的 git 目录，所以只能设置用户级别的配置以生效，配置文件会被存放于 Portage 安装过程中沙盒的家目录下，即对应 <em>安装软件临时目录</em> （这个目录是 Portage 在编译/安装软件过程中临时建立的，会在成功安装软件后被删除，所以不用担心会有文件残留。具体位置是可以自定义的，详情看 make.conf(5) 手册下 PORTAGE_TMPDIR 条目）下的 <code>homedir/</code> 目录。</p>
</li>
</ol>
<h4 id="临时添加代理">临时添加代理<a hidden class="anchor" aria-hidden="true" href="#临时添加代理">#</a></h4>
<p>对于需要临时添加代理以使用的情况，目前我知道两种方式：</p>
<h5 id="推荐proxychains">推荐：ProxyChains<a hidden class="anchor" aria-hidden="true" href="#推荐proxychains">#</a></h5>
<p><a href="https://github.com/haad/proxychains">ProxyChains</a> is a UNIX program, that hooks network-related libc functions in dynamically linked programs via a preloaded DLL and redirects the connections through SOCKS4a/5 or HTTP proxies.</p>
<p>使用 <a href="https://packages.gentoo.org/packages/net-misc/proxychains"><strong>net-misc/proxychains</strong></a> 软件适用所有下载方式。</p>
<p>配置文件可以放在 <code>~/.proxychains/proxychains.conf</code>，也可以放在 <code>/etc/proxychains.conf</code>，但是放在 etc 下更好，因为有时候要通过sudo安装软件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># emerge net-misc/proxychains</span>
<span style="color:#75715e"># vi /etc/proxychains.conf</span>
...
socks5 127.0.0.1 <span style="color:#ae81ff">7891</span>
</code></pre></div><p>配置好代理列表后，通过如下命令使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#proxychains -q emerge [&lt;args&gt;...]</span>
</code></pre></div><h5 id="临时指定环境变量">临时指定环境变量<a hidden class="anchor" aria-hidden="true" href="#临时指定环境变量">#</a></h5>
<p>{ftp,http,https}_proxy 的方式，适用性同持久性配置。</p>
<p>即如下命令：</p>
<pre tabindex="0"><code>export http_proxy=&quot;...&quot; https_...
emerge [&lt;args&gt;...]
</code></pre><p>或</p>
<pre tabindex="0"><code>http_proxy=&quot;...&quot; https_... emerge [&lt;args&gt;...]
</code></pre><h3 id="freeing-disk-spacehttpswikigentooorgwikiknowledge_basefreeing_disk_space"><a href="https://wiki.gentoo.org/wiki/Knowledge_Base:Freeing_disk_space">Freeing disk space</a><a hidden class="anchor" aria-hidden="true" href="#freeing-disk-spacehttpswikigentooorgwikiknowledge_basefreeing_disk_space">#</a></h3>
<h3 id="how-to-change--set-the-default-crontab-editorhttpswwwservernoobscomchange-set-the-default-crontab-editortextif20you20want20to20change20your20default20crontabin20general2c20you20use20this20command3a20export20editor3d2fusr2fbin2fnano"><a href="https://www.servernoobs.com/change-set-the-default-crontab-editor/#:~:text=If%20you%20want%20to%20change%20your%20default%20crontab,in%20general%2C%20you%20use%20this%20command%3A%20export%20EDITOR%3D%2Fusr%2Fbin%2Fnano.">How to Change &amp; Set the Default crontab Editor</a><a hidden class="anchor" aria-hidden="true" href="#how-to-change--set-the-default-crontab-editorhttpswwwservernoobscomchange-set-the-default-crontab-editortextif20you20want20to20change20your20default20crontabin20general2c20you20use20this20command3a20export20editor3d2fusr2fbin2fnano">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ EDITOR<span style="color:#f92672">=</span>nano crontab -e
</code></pre></div><h3 id="how-to-update-dolphin-file-manager-in-real-timehttpsaskubuntucomquestions311303how-to-update-dolphin-file-manager-in-real-time"><a href="https://askubuntu.com/questions/311303/how-to-update-dolphin-file-manager-in-real-time">How to update dolphin file manager in real time</a><a hidden class="anchor" aria-hidden="true" href="#how-to-update-dolphin-file-manager-in-real-timehttpsaskubuntucomquestions311303how-to-update-dolphin-file-manager-in-real-time">#</a></h3>
<p>The way in order to refresh Dolphin is to press F5. However, this would be manual.</p>
<p>In order to continuously refresh, an automatic solution, create a bash script that runs on boot. This bash script should press F5 every five seconds if Dolphin is open. Create a file named <code>dolphin-update</code> in <code>/usr/local/bin</code> with the following contents:</p>
<pre tabindex="0"><code>#!/bin/bash
while true; do
    PID=$(pgrep &quot;dolphin&quot;)
    if [ &quot;$?&quot; -ne &quot;0&quot; ]; then
        xdotool key 'F5'
    fi
    sleep 5
done
</code></pre><p>You may need to first create it as root and then change the owner to your user:</p>
<pre tabindex="0"><code>sudo chown username:username /usr/local/bin/dolphin-update 
</code></pre><p>Ensure that it has executable permissions:</p>
<pre tabindex="0"><code>chmod +x /usr/local/bin/dolphin-update
</code></pre><p>Now we need that to run on boot. To do that run <code>sudo crontab -e</code> and add the following line to the end of the file:</p>
<pre tabindex="0"><code>@reboot /usr/local/bin/dolphin-update
</code></pre><p>This script will run on boot.</p>
<p>You should now have a continuously refreshing Dolphin!</p>
<p>There are some caveats to this script.</p>
<ul>
<li>If you open Dolphin, go to another application where F5 triggers something, (eg Chromium refreshes the page), the script will still run and be a constant annoyance. <strong>Solution:</strong> Close Dolphin when not actively using it.</li>
<li>As a <code>cron</code> job is used, if your computer crashes, the script will not run on boot. However this is a problem with <code>cron</code> not the script.</li>
</ul>
<p>What the script means, line by line:</p>
<ul>
<li><code>#!/bin/bash</code> - shebang to run with bash</li>
<li><code>while true; do</code> - run continuously</li>
<li><code>PID=$(pgrep &quot;dolphin&quot;)</code> - find the process ID of a <code>dolphin</code> instance. This is purely there to check whether there is even a instance of Dolphin running.</li>
<li><code>if [ &quot;$?&quot; -ne &quot;0&quot; ]; then</code> - check the result of whether there is a Dolphin instance running. If there is, then &hellip;</li>
<li><code>xdotool key 'F5'</code> - press F5</li>
<li><code>fi</code> - end the <code>if</code> block</li>
<li><code>sleep 5</code> - wait 5 seconds before repeating the process</li>
<li><code>done</code> - end the while block</li>
</ul>
<h3 id="how-do-i-convert-a-png-into-a-icohttpssuperusercomquestions227736how-do-i-convert-a-png-into-a-ico1012535"><a href="https://superuser.com/questions/227736/how-do-i-convert-a-png-into-a-ico/1012535">How do I convert a .PNG into a .ICO?</a><a hidden class="anchor" aria-hidden="true" href="#how-do-i-convert-a-png-into-a-icohttpssuperusercomquestions227736how-do-i-convert-a-png-into-a-ico1012535">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ffmpeg -i img.png img.ico
$ ffmpeg -i img.png -vf scale<span style="color:#f92672">=</span>32:32 img.ico
</code></pre></div><h3 id="crop-a-photo-to-fit-a-circle-using-ffmpeghttpsstackoverflowcomquestions63997289can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg"><a href="https://stackoverflow.com/questions/63997289/can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg">Crop a photo to fit a circle using ffmpeg</a><a hidden class="anchor" aria-hidden="true" href="#crop-a-photo-to-fit-a-circle-using-ffmpeghttpsstackoverflowcomquestions63997289can-you-crop-a-photo-to-fit-a-circle-using-ffmpeg">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ffmpeg -i avatar.png -i mask.png -filter_complex <span style="color:#e6db74">&#34;[0]scale=400:400[ava];[1]alphaextract[alfa];[ava][alfa]alphamerge&#34;</span> output.png
</code></pre></div><p>scale=400:400 是 mask.png 的大小。</p>
<p>mask.png is just a circle, example:</p>
<p><img loading="lazy" src="/Distributions/EMKmn.png" alt=""  />
</p>
<h3 id="path-to-kde-picture-of-the-dayhttpsaskubuntucomquestions1197417where-is-bings-picture-of-the-day-stored-on-my-system"><a href="https://askubuntu.com/questions/1197417/where-is-bings-picture-of-the-day-stored-on-my-system">Path to KDE Picture of the Day</a><a hidden class="anchor" aria-hidden="true" href="#path-to-kde-picture-of-the-dayhttpsaskubuntucomquestions1197417where-is-bings-picture-of-the-day-stored-on-my-system">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd $HOME/.cache/plasma_engine_potd
$ file *
apod:             JPEG image data, JFIF standard 1.01, resolution <span style="color:#f92672">(</span>DPI<span style="color:#f92672">)</span>, density 96x96, segment length 16, comment: <span style="color:#e6db74">&#34;Description: Adobe ImageReady&#34;</span>, baseline, precision 8, 960x634, components <span style="color:#ae81ff">3</span>
bing:             JPEG image data, JFIF standard 1.01, resolution <span style="color:#f92672">(</span>DPI<span style="color:#f92672">)</span>, density 96x96, segment length 16, baseline, precision 8, 1920x1080, components <span style="color:#ae81ff">3</span>
unsplash:1065976: JPEG image data, JFIF standard 1.01, resolution <span style="color:#f92672">(</span>DPI<span style="color:#f92672">)</span>, density 72x72, segment length 16, baseline, precision 8, 3840x2160, components <span style="color:#ae81ff">3</span>
</code></pre></div><h3 id="baloohttpscommunitykdeorgbaloo"><a href="https://community.kde.org/Baloo">Baloo</a><a hidden class="anchor" aria-hidden="true" href="#baloohttpscommunitykdeorgbaloo">#</a></h3>
<p>Baloo is the file indexing and file search framework for KDE Plasma, with a focus on providing a very small memory footprint along with with extremely fast searching.</p>
<p><strong>Indexing limitations</strong></p>
<p>Baloo uses the file metadata extractors in <a href="https://invent.kde.org/frameworks/kfilemetadata">KFileMetadata</a> to get information about each file it indexes. This means for a file&rsquo;s content to be indexed</p>
<ul>
<li>the file must have a recognizable MIME type</li>
<li>KDE must have an extractor for that MIME type</li>
</ul>
<p>Other limitations:</p>
<ul>
<li>Baloo doesn&rsquo;t index text files (those whose MIME type is detected as &ldquo;text/<em>something</em>&quot;) over 10 MB (<a href="https://invent.kde.org/frameworks/baloo/-/blob/master/src/file/extractor/app.cpp#L143">source</a>).</li>
<li>The KFileMetadata extractor for text attempts to convert text to Unicode. If the file uses another encoding, such as iso-8859-1, any file contents after the first character that is invalid in Unicode will not be indexed. You may find the <code>-i</code> option to the <code>file</code> command-line utility useful; it tries to infer the character set of a file, e.g. file -i <em>path/to/myfile.txt</em>.</li>
</ul>
<p><strong>Using Baloo</strong></p>
<p>Baloo is not an application, but a daemon to index files. Applications can use the Baloo framework to provide file search results. For example, <a href="https://community.kde.org/Dolphin">Dolphin</a>&rsquo;s Content search can use Baloo.</p>
<p>KDE System Settings &gt; File Search provides an <a href="http://vhanda.in/blog/2014/04/desktop-search-configuration/">intentionally limited number of settings</a>. You can make additional adjustments in <a href="https://community.kde.org/Baloo/Configuration">Baloo&rsquo;s configuration file</a>.</p>
<p><strong>balooctl</strong></p>
<p><code>balooctl</code> is a CLI command to perform certain operations on Baloo. Enter <code>balooctl --help</code> in a terminal app such as <a href="http://userbase.kde.org/Konsole">userbase:Konsole</a> to list its available subcommands.</p>
<h4 id="baloo-file-extractor-crashes-on-every-boothttpsforumsgentooorgviewtopic-t-1096234-start-0html"><a href="https://forums.gentoo.org/viewtopic-t-1096234-start-0.html">Baloo File Extractor Crashes on every boot</a><a hidden class="anchor" aria-hidden="true" href="#baloo-file-extractor-crashes-on-every-boothttpsforumsgentooorgviewtopic-t-1096234-start-0html">#</a></h4>
<p>I find Baloo fragile and a nuisance. Sometimes it works OK on my amd64 and ~amd64 machines, other times not. If you are not interested in file indexing, you can disable it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ balooctl disable
</code></pre></div><p>这个不好用，菊苣（巨巨、大佬）们都推荐关闭。</p>
<h3 id="内核升级一般步骤httpsblogsoymilkfun20201117linuxgentoogentookernelupdate"><a href="https://blog.soymilk.fun/2020/11/17/Linux/Gentoo/GentooKernelUpdate/">内核升级一般步骤</a><a hidden class="anchor" aria-hidden="true" href="#内核升级一般步骤httpsblogsoymilkfun20201117linuxgentoogentookernelupdate">#</a></h3>
<h4 id="升级内核">升级内核<a hidden class="anchor" aria-hidden="true" href="#升级内核">#</a></h4>
<p>建议在<code>make.conf</code>中添加<code>USE='symlink'</code>，然后更新系统。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo emerge --ask --verbose --update --deep --newuse @world
</code></pre></div><h4 id="configuration-1">Configuration<a hidden class="anchor" aria-hidden="true" href="#configuration-1">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo make menuconfig
</code></pre></div><h4 id="build">Build<a hidden class="anchor" aria-hidden="true" href="#build">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo make -j4
</code></pre></div><h4 id="install">Install<a hidden class="anchor" aria-hidden="true" href="#install">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo make modules_install
$ sudo make install
</code></pre></div><h4 id="bootloader">BootLoader<a hidden class="anchor" aria-hidden="true" href="#bootloader">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo grub-mkconfig -o /boot/grub/grub.cfg
</code></pre></div><p>重启以应用新的内核。</p>
<h4 id="clean">Clean<a hidden class="anchor" aria-hidden="true" href="#clean">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo eclean-kernel -n <span style="color:#ae81ff">1</span>
</code></pre></div><p>仅保留当前内核。</p>
<h3 id="dwmhttpszhuanlanzhihucomp346719806"><a href="https://zhuanlan.zhihu.com/p/346719806">dwm</a><a hidden class="anchor" aria-hidden="true" href="#dwmhttpszhuanlanzhihucomp346719806">#</a></h3>
<p>长时间日常使用动态窗口管理器之后发现，相比与传统的DE型桌面，这种WM型窗口管理方式确实能很大程度上提高工作效率。</p>
<h4 id="de和wm的区别">DE和WM的区别<a hidden class="anchor" aria-hidden="true" href="#de和wm的区别">#</a></h4>
<p>首先说明一下我即将提到的东西是什么。</p>
<ul>
<li>DE：Desktop Environment</li>
<li>WM：Window Manager</li>
</ul>
<p>桌面环境是一个相对完整的概念，一般情况下DE包含WM，比如Gnome3的默认WM是Mutter，KDE5的默认WM是KWin。主流的桌面环境都提供了大量自带的桌面组件来构成其完整的桌面体验。</p>
<p>窗口管理器只是管理出现在你的桌面上的各种窗口的组件，具体的管理内容包含比如：窗口堆叠方式，窗口移动规则等。大多数人接触到的是堆叠式窗口管理器，一个窗口可以叠放在其他窗口之上，调整窗口的主要方式是鼠标。我即将介绍的dwm（Dynamic Window Manager）属于动态窗口管理器，可以自定义不同窗口的出现规则如平铺或者堆叠，主要的调整窗口的方式是键盘。</p>
<p>大多数窗口管理器只提供管理窗口的逻辑和人机交互的处理，并不自带其他组件如程序启动器、终端等软件，因此只运行一个窗口管理器理论上是要比运行一个完整的桌面环境更加节约资源，也有更好的可伸缩性。</p>
<p>实际上WM这个概念是应用了奥卡姆剃刀原理，把那些看似有点用但实际上多余的功能全部剔除，只留下你真正需要的和最常用的功能并加以强化，Less is More.</p>
<h4 id="dwm与其他wm的区别">dwm与其他wm的区别<a hidden class="anchor" aria-hidden="true" href="#dwm与其他wm的区别">#</a></h4>
<p>前面已经说明了dwm与堆叠式窗口管理器的区别，下面说明一下dwm与其他平铺&amp;动态窗口管理器的区别。</p>
<p>dwm使用C语言编写，使用修改源代码的方式来进行配置。说到源代码可能有些同学就有点害怕，其实修改源代码也很简单，因为有现成的例子可以复(bai)用(piao)嘛！通过直接修改源代码理论上可以确保你的dwm能满足你所有的需求，同时也没有多余的，你不需要的功能。</p>
<p>相比之下，另外一个相当流行的动态窗口管理器i3wm也是使用C语言编写，但是通过修改其配置文件来配置，这相当于i3wm向你暴露可以被配置的接口来满足你的需求，但是这样的配置方式缺点在于你不能向其添加你需要的需求，只能向上游提交issue来完成enhancement。</p>
<p>具有和dwm相似配置能力的窗口管理器是xmonad，它也是通过直接修改源代码的方式来调整配置，但是因为使用haskell编写的所以需要安装相当多的依赖，此外其运行效率也不及dwm。</p>
<h4 id="通用的wm配置">通用的wm配置<a hidden class="anchor" aria-hidden="true" href="#通用的wm配置">#</a></h4>
<p>因为一个可独立运行的窗口管理器默认不携带任何多余的软件，所以为了满足日常使用需要进行一定程度的自定义配置，下面给出一下通用的配置：</p>
<p><strong>常用软件的推荐</strong></p>
<p>用半角逗号分隔的同类别软件顺序表示推荐等级</p>
<ul>
<li>终端：<a href="https://sw.kovidgoyal.net/kitty/">kitty</a>, alacritty, termite（前两个有GPU加速）</li>
<li>护眼：redshift-gtk</li>
<li>程序启动器：dmenu, rofi</li>
<li>Shell：fish, zsh</li>
<li>壁纸设置器：feh, nitrogen</li>
<li>音乐播放器：<a href="https://zhuanlan.zhihu.com/p/351064855">mpd&amp;ncmpcpp</a>（基于终端）, deadbeaf-git</li>
<li>特效合成器：picom-jonaburg-git, picom</li>
<li>文件管理器：thunar, nemo</li>
<li>电源管理器：xfce4-power-manager</li>
<li>截图工具：flameshot, scrot</li>
<li>主题设置器：lxappearance&amp;qt5ct&amp;xsettingsd</li>
<li>输入法：fcitx5</li>
<li>科学上网工具：qv2ray</li>
<li>剪切板管理器：copyq</li>
<li>云同步工具：nutstore（坚果云）, dropbox</li>
<li>通知管理器：dunst</li>
<li>锁屏管理器：betterlockscreen, xautolock（用于自动锁屏）</li>
<li>pdf 阅读器：zathura（vim风格）, atril（没有gnome依赖的evince）</li>
<li>文本编辑器：nvim, doom emacs(可选)，(vs)code</li>
<li>屏幕亮度调节器：light</li>
</ul>
<p><strong>关于平铺还是浮动</strong></p>
<p>个人建议多数窗口平铺，以下窗口默认浮动：</p>
<p>virtualbox, lxappearance, qq, gpick, qalculator, slickpicker</p>
<p><strong>关于GTK主题和QT主题</strong></p>
<p>我建议让QT程序使用GTK主题，除上文提到的qt5ct再安装qt5-styleplugins</p>
<p>在qt5ct中设置风格为gtk2</p>
<h4 id="dwm安装">dwm安装<a hidden class="anchor" aria-hidden="true" href="#dwm安装">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ wget https://dl.suckless.org/dwm/dwm-6.2.tar.gz
$ tar xpvf dwm-6.2.tar.gz
$ mv dwm-6.2 ~/.dwm
</code></pre></div><h4 id="dwm配置httpszhuanlanzhihucomp183861786"><a href="https://zhuanlan.zhihu.com/p/183861786">dwm配置</a><a hidden class="anchor" aria-hidden="true" href="#dwm配置httpszhuanlanzhihucomp183861786">#</a></h4>
<p>配置dwm主要需要修改的文件是config.def.h，主要的配置方式是使用被人写好的patch加必要时候的手动修改。dwm的patch都在其<a href="https://dwm.suckless.org/patches/">官方网站</a></p>
<p>具体过程是这样的：</p>
<ol>
<li>找到你需要的patch并下载</li>
<li>将其移动到~/.dwm目录下</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ patch &lt; dwm*.diff
</code></pre></div><p>之后会输出这个patch过程的详细情况，一般情况不会出现问题</p>
<p>需要注意的是要一个一个来</p>
<p>出现问题之后需要对照如：config.def.h.rej, dwm.c.rej等后缀为rej的文件来手动修改对应的没有rej后缀的源文件</p>
<p>打开之后rej文件中行首标有+的行是需要添加的行，标有-的行是需要删除的行</p>
<p>所有更改都修改完毕之后重新编译安装，执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ rm -f ./config.h <span style="color:#f92672">&amp;&amp;</span> sudo make clean install
</code></pre></div><p>不要忘记添加dwm.desktop文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo vim /usr/share/xsessions/dwm.desktop

<span style="color:#f92672">[</span>Desktop Entry<span style="color:#f92672">]</span>
Encoding<span style="color:#f92672">=</span>UTF-8
Name<span style="color:#f92672">=</span>Dwm
Comment<span style="color:#f92672">=</span>Dynamic window manager
Exec<span style="color:#f92672">=</span>dwm
Icon<span style="color:#f92672">=</span>dwm
Type<span style="color:#f92672">=</span>XSession
</code></pre></div><p>下面是我自己打完patch之后的配置：</p>
<p><a href="https://github.com/ayamir/dwm-dotfiles">https://github.com/ayamir/dwm-dotfilesgithub.com/ayamir/dwm-dotfiles</a></p>
<p>新手可以直接使用我的配置，相对比较完整，使用说明我已经写好了，基本上实现了i3wm上提供的功能。</p>
<h2 id="questions-1">Questions<a hidden class="anchor" aria-hidden="true" href="#questions-1">#</a></h2>
<h3 id="problem-with-transparencies-and-windowing-ghosting-outhttpsforumgarudalinuxorgtproblem-with-transparencies-and-windowing-ghosting-out9568"><a href="https://forum.garudalinux.org/t/problem-with-transparencies-and-windowing-ghosting-out/9568">Problem with transparencies and windowing ghosting out</a><a hidden class="anchor" aria-hidden="true" href="#problem-with-transparencies-and-windowing-ghosting-outhttpsforumgarudalinuxorgtproblem-with-transparencies-and-windowing-ghosting-out9568">#</a></h3>
<p>Anyhow, I now applied the &ldquo;force smoothest animations&rdquo; in the KDE compositor settings and it seems to have done the trick!Telegram not launching from the browser xdg-open</p>
<h3 id="telegram-not-launching-from-the-browser-xdg-openhttpswwwredditcomrmanjarolinuxcommentsk76cphtelegram_not_launching_from_the_browser_xdgopen"><a href="https://www.reddit.com/r/ManjaroLinux/comments/k76cph/telegram_not_launching_from_the_browser_xdgopen/">Telegram not launching from the browser xdg-open</a><a hidden class="anchor" aria-hidden="true" href="#telegram-not-launching-from-the-browser-xdg-openhttpswwwredditcomrmanjarolinuxcommentsk76cphtelegram_not_launching_from_the_browser_xdgopen">#</a></h3>
<p>I am receiving the following message:</p>
<pre tabindex="0"><code>Unable to create io-slave. klauncher said: Unknown protocol 'tg'.
</code></pre><p>Hey!
So it’s easy to solve</p>
<ol>
<li>Open the folder <code>\~/.local/share/applications</code></li>
<li>find some files about telegram desktop, like an example, my is <code>userapp-Telegram Desktop-FXJ6T0.desktop</code></li>
<li>Add the line at the end of file <code>MimeType=application/x-xdg-protocol-tg;x-scheme-handler/tg;</code></li>
<li>Reload your browser (maybe do not need…)</li>
<li>Enjoy!</li>
</ol>
<p>我的该目录下有两个与telegram相关的desktop文件，都改了之后就行了。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://sakamotokurome.github.io/tags/unix/">Unix</a></li>
      <li><a href="https://sakamotokurome.github.io/tags/linux/">Linux</a></li>
      <li><a href="https://sakamotokurome.github.io/tags/gentoo/">Gentoo</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://sakamotokurome.github.io/posts/fedora/">
    <span class="title">« Prev Page</span>
    <br>
    <span>Fedora</span>
  </a>
  <a class="next" href="https://sakamotokurome.github.io/posts/ubuntutips/">
    <span class="title">Next Page »</span>
    <br>
    <span>Ubuntu Tips</span>
  </a>
</nav>

  </footer>
</article>

<div class="disqus-container">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    this.page.identifier = 'b5e90c';
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "sakamotokurome" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://sakamotokurome.github.io/">Sakamoto Kurome</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>
